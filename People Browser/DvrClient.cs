using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Data.OleDb;
using System.Drawing;
using System.Text;
using System.Windows.Forms;
using System.Threading;
using System.Xml;
using System.Reflection;
using System.Configuration;
using System.IO;
using System.IO.Ports;
using ADOX;
using MSXML2;
using System.Runtime.InteropServices;
using System.Diagnostics;
using System.Net;
using System.Net.NetworkInformation;
using Microsoft.VisualBasic;
using System.Drawing.Design;
using System.Data.SqlClient;
using System.Drawing.Drawing2D;
using System.ServiceModel;
using System.Xml.Serialization;
using System.Timers;
using Afcon.DvrClient.VendorPlugin.Loader;
using Afcon.DvrClient.VendorPlugin.VideoPlayer;
using Afcon.DvrClient.Common;
using Afcon.DvrClient.Engine;

namespace Afcon.DvrClient.Control
{
    [Serializable]
    [DisplayNameAttribute("DVR Client")]
    [ToolboxBitmap(typeof(DvrClient), "Resources.Atom.ico")]
    public partial class DvrClient : UserControl, IGuiHandler
    {
        #region Close Button Definitions

        const int MF_BYPOSITION = 0x400;

        [DllImport("User32")]
        private static extern int RemoveMenu(IntPtr hMenu, int nPosition, int wFlags);

        [DllImport("User32")]
        private static extern IntPtr GetSystemMenu(IntPtr hWnd, bool bRevert);

        [DllImport("User32")]
        private static extern int GetMenuItemCount(IntPtr hWnd);

        #endregion

        #region Find Atom stuff

        [DllImport("kernel32.dll", SetLastError = true, CharSet = CharSet.Auto)]
        static extern ushort GlobalAddAtom(string lpString);

        [DllImport("kernel32.dll", SetLastError = true, CharSet = CharSet.Auto)]
        static extern ushort GlobalFindAtom(string lpString);

        [DllImport("kernel32.dll", SetLastError = true, CharSet = CharSet.Auto)]
        static extern ushort GlobalDeleteAtom(ushort atom);

        #endregion

        #region Keystroke Intercepting

        private const int WH_KEYBOARD_LL = 13;
        private const int WM_KEYDOWN = 0x0100;
        private static LowLevelKeyboardProc _proc = HookCallback;
        private static IntPtr _hookID = IntPtr.Zero;

        private static IntPtr SetHook(LowLevelKeyboardProc proc)
        {
            using (Process curProcess = Process.GetCurrentProcess())
            using (ProcessModule curModule = curProcess.MainModule)
            {
                return SetWindowsHookEx(WH_KEYBOARD_LL, proc, GetModuleHandle(curModule.ModuleName), 0);
            }
        }

        private delegate IntPtr LowLevelKeyboardProc(int nCode, IntPtr wParam, IntPtr lParam);

        private static event EventHandler PtzEvent;

        private static IntPtr HookCallback(int nCode, IntPtr wParam, IntPtr lParam)
        {
            System.Windows.Forms.Keys pressedKey;

            if (nCode >= 0 && wParam == (IntPtr)WM_KEYDOWN)
            {
                int vkCode = Marshal.ReadInt32(lParam);

                pressedKey = (System.Windows.Forms.Keys)vkCode;
                switch (pressedKey)
                {
                    #region PTZ On Keypad

                    case System.Windows.Forms.Keys.NumPad8:
                        if (PtzEvent != null)
                        {
                            //PtzEvent(PComp_PTZMoveDirection.PTZMove_Up, EventArgs.Empty);
                        }
                        break;


                    case System.Windows.Forms.Keys.NumPad2:
                        if (PtzEvent != null)
                        {
                            //PtzEvent(PComp_PTZMoveDirection.PTZMove_Down, EventArgs.Empty);
                        }
                        break;


                    case System.Windows.Forms.Keys.NumPad4:
                        if (PtzEvent != null)
                        {
                            //PtzEvent(PComp_PTZMoveDirection.PTZMove_left, EventArgs.Empty);
                        }
                        break;


                    case System.Windows.Forms.Keys.NumPad6:
                        if (PtzEvent != null)
                        {
                            //PtzEvent(PComp_PTZMoveDirection.PTZMove_Right, EventArgs.Empty);
                        }
                        break;


                    case System.Windows.Forms.Keys.NumPad7:
                        if (PtzEvent != null)
                        {
                            //PtzEvent(PComp_PTZMoveDirection.PTZMove_LeftDown, EventArgs.Empty);
                        }
                        break;


                    case System.Windows.Forms.Keys.NumPad9:
                        if (PtzEvent != null)
                        {
                            //PtzEvent(PComp_PTZMoveDirection.PTZMove_LeftDown, EventArgs.Empty);
                        }
                        break;


                    case System.Windows.Forms.Keys.NumPad1:
                        if (PtzEvent != null)
                        {
                            //PtzEvent(PComp_PTZMoveDirection.PTZMove_RightUp, EventArgs.Empty);
                        }
                        break;


                    case System.Windows.Forms.Keys.NumPad3:
                        if (PtzEvent != null)
                        {
                            //PtzEvent(PComp_PTZMoveDirection.PTZMove_LeftUp, EventArgs.Empty);
                        }
                        break; 

                    #endregion

                    case System.Windows.Forms.Keys.M:
                        m_bUnhideMenu = true;
                        break;


                    case System.Windows.Forms.Keys.F6:
                        if (!m_bShowDisplayManagerViewer)
                        {
                            m_bShowDisplayManagerViewer = true;
                        }
                        break;


                    case System.Windows.Forms.Keys.F7:
                        if (!m_bShowDvrClientDataScope)
                        {
                            m_bShowDvrClientDataScope = true;
                        }
                        break;


                    case System.Windows.Forms.Keys.F8:
                        if (m_bHidePulseEventsTree)
                        {
                            m_bHidePulseEventsTree = false;
                        }
                        else 
                        {
                            m_bHidePulseEventsTree = true;
                        }
                        break;


                    case System.Windows.Forms.Keys.F9:
                        if (!m_bShowDvrsAndCamerasInformation)
                        {
                            m_bShowDvrsAndCamerasInformation = true;
                        }
                        break;


                    case System.Windows.Forms.Keys.F10:
                        if (!m_bShowDisplayTemplates)
                        {
                            m_bShowDisplayTemplates = true;
                        }
                        break;


                    case System.Windows.Forms.Keys.F11:
                        #region F11

                        if (m_bStopF11Activity)
                        {
                            return (IntPtr)0;
                        }

                        if (m_bNoActiveDisplays)
                        {
                            return (IntPtr)0;
                        }

                        m_bKeyPressed = true;
                        m_bStopF11Activity = true;

                        switch (triFullScreen)
                        {
                            case Trinar.True:
                                triFullScreen = Trinar.False;
                                break;

                            case Trinar.False:
                                triFullScreen = Trinar.True;
                                break;

                            default:
                                triFullScreen = Trinar.True;
                                break;
                        }

                        break;

                        #endregion


                    case System.Windows.Forms.Keys.F12:
                        if (!m_bShowSettings)
                        {
                            m_bShowSettings = true;
                        }
                        break;


                    default:                        
                        break;
                }
            }

            return CallNextHookEx(_hookID, nCode, wParam, lParam);
        }

        [DllImport("user32.dll", CharSet = CharSet.Auto, SetLastError = true)]
        private static extern IntPtr SetWindowsHookEx(int idHook, LowLevelKeyboardProc lpfn, IntPtr hMod, uint dwThreadId);

        [DllImport("user32.dll", CharSet = CharSet.Auto, SetLastError = true)]
        [return: MarshalAs(UnmanagedType.Bool)]
        private static extern bool UnhookWindowsHookEx(IntPtr hhk);

        [DllImport("user32.dll", CharSet = CharSet.Auto, SetLastError = true)]
        private static extern IntPtr CallNextHookEx(IntPtr hhk, int nCode, IntPtr wParam, IntPtr lParam);

        [DllImport("kernel32.dll", CharSet = CharSet.Auto, SetLastError = true)]
        private static extern IntPtr GetModuleHandle(string lpModuleName);

        #endregion

        #region Data Members

        private WorkMode m_WorkMode;

        private bool m_bUnlockFileExists;
        private bool m_bPulseIsConnected;
        private bool m_bNodeFound;
        private bool m_bStartCameraByClick;
        private bool m_bMonitorSuccess;
        private bool m_bStopMonitorSuccess;
        private bool m_bPtzSuccess;
        private bool m_bRangeError;
        private bool m_bMajorError;
        private bool m_bVod; 
        private bool m_bLanguageSwitched;
        private bool m_bSpecialLayoutsMode;
        private bool m_bNoAdaption = false;
        private bool m_bConnected;
        private bool m_bDvrClientDbConnected;
        private bool m_bPulseDbConnected;
        private bool m_bInHistory;
        private bool m_bCoreApiDllPresent;
        private bool m_bViconApiDllPresent;
        private bool m_bHdLimitReached;
        private bool m_bMultiSelect;
        private bool m_bTreeviewDvrCheckedFlag;
        private bool m_bClosing;
        private bool m_bFixedLayout;
        private bool m_bWaitForDvtelLoaderToFinish;
        private bool m_bDvtelLoaderSucceeded;

        private static Trinar triFullScreen;
        private static bool m_bStopF11Activity;
        private static bool m_bNoActiveDisplays;
        private static bool m_bUnhideMenu;
        private static bool m_bHidePulseEventsTree;
        private static bool m_bShowDvrClientDataScope;
        private static bool m_bShowDisplayManagerViewer;
        private static bool m_bShowSettings;
        private static bool m_bShowDisplayTemplates;
        private static bool m_bShowDvrsAndCamerasInformation;

        private bool m_bFullScreenMode = false;
        private bool m_bChangingBackToNormalScreenMode;
        private static bool m_bKeyPressed;
        private bool m_bDatabaseExists;
        private bool m_bCutMainViewInTheMiddle;
        private bool m_bCutPredefinedViewInTheMiddle;
        //private bool m_bDisplayFrameShown;

        private HiveStateStatus m_HiveStateStatus;

        private List<string> m_sLoggers;
        private string m_sRangeError;
        private string m_sMajorError;
        private string[] m_TreeNodeName;
        private string m_sDvrType;
        private string m_sDvr;
        private string m_sCameraNumber;
        private string m_sRemoteAddress;
        private string m_sRemotePort;
        private string m_sDrive;
        private string m_sPath;
        private string m_sProcessName;
        private List<string> m_ViconMacro;
        private string[] m_PreDefinedViews;
        private string m_sInitializationStep;
        private string m_sSerialPortBuffer;

        private int m_iOsdDefault;
        private int m_TreeViewContextMenuDisplayIndex;
        private int m_iExportCounter;
        private int m_iNumberOfDvrs;
        private int m_iStartX;
        //private int m_CurrentX1, m_CurrentY1, m_CurrentX2, m_CurrentY2;
        private int m_iVideoPlayersZoneLeft;
        private int m_iVideoPlayersZoneTop;
        private int m_iVideoPlayersZoneWidth;
        private int m_iVideoPlayersZoneHeight;
        private int m_iHdLimitReachedTimeInterval;
        private List<int> m_lPlayerEventsHashCode;

        private int m_iDvtelWatchdogCounter;
        private int m_iItemId;
        private List<TimerQItem> m_TimerQ;
        private List<TimerQItem> m_ActivationQ;

        private Engine.Engine m_TourEngine;

        private List<Patrol> m_Patrol;

        private MenuItem[] m_PresetsMenuItem;
        private TreeNode m_NodeFound;
        private TextWriter m_AuditFile;
        private TextWriter m_ErrorsFile;
        private TextWriter m_ProtocolDataFile;
        private AlarmEvents[] m_Alarms4Dvr;
        private ClientThreadData m_PulseClientThreadData;
        private ServerThreadData m_PulseListenerThreadData;
        private ServerThreadData m_DvrHiveServerThreadData;
        private AlarmsListenerThreadData m_AlarmsListenerMessagesHandlerThreadData;
        private AlarmsListenerThreadData[] m_AlarmsListenerThreadData;
        private LoggersKeepaliveThreadData m_LoggersKeepaliveThreadData;
        private List<DvrInformation2> m_DvrsAndCamerasInformation;
        private DvrProxySettings m_Settings;
        private ReadTypes m_ReadTypes;
        private DvrsOnTreeNodes[] m_DvrsOnTreeNodes;
        private PlaybackSearchParameters m_PlaybackSearchParameters;
        private SchedulerList m_SchedulerTasks;
        private List<LoggerConectivity> m_LoggerConectivity;
        private ExportThreadData m_ExportData;
        private PtzCameras m_PtzCameras;
        private MultiTimer m_MultiTimer;
        private List<DvrRecord> m_DvrRecord;
        private SoundFiles m_SoundFiles;
        private AdvancedQ m_PulseAlarmQ;

        private List<CameraInformation2> m_MultiSelectedCamera;
        private List<Dvr> m_DvrsAndCameras;
        private List<CameraInformation> m_CameraInformation;
        private List<DvrInformation> m_DvrInformation;

        private Dictionary<int, object> m_LoggedInSystemDictionary;

        private VendorPluginAlarmsListener m_AlarmsListener;

        private frmAudit m_Log;
        private frmProtocol m_Protocol;
        private frmAlarms m_PulseAlarmsTree;
        private frmSettings m_frmSettings;
        private frmDisplayManager m_DisplayManagerViewer;
        private frmDvrClientDataScope m_DvrClientDataScope;
        private frmDisplayTemplate m_DisplayTemplate;        
        private frmDvrsAndCamerasInformation m_frmDvrsAndCamerasInformation;
        private frmStartup m_StarupProgress;

        private ListDb m_ListDb;
        private List<WaveStoreDvrRecord> m_WaveStoreDvrRecord;
        private List<VendorDvrRecord> m_VendorDvrRecord;

        private DisplayManager m_DisplayManager;       

        private DatabaseProvider m_DatabaseProvider;
        private OleDbConnection m_cn;
        private OleDbConnection m_PulseDatabaseConnection;
        private List<PreDefinedView> m_PreDefinedView;
        private List<PreDefinedView> m_MainView;
        private List<PtzPreset> m_PtzPreset;
        private List<SavedDisplay> m_SavedDisplays;
        private List<PulseAlarm> m_PulseAlarm;
        private ImageList il;
        private ToolTip ttPlaybackTrackbar;
        private ToolTip ttPlaybackSmallTrackbar;
        private ToolTip ttTriggerEvent;
        private System.Drawing.Graphics m_FameGraphics;
        private List<DatabaseTable> m_DvrClientDatabase;
        private List<DatabaseTable> m_TemplateDvrClientDatabase;

        private PCimProxy m_PCimProxyThread;
        private PCimProxy m_DvrHiveProxyThread;
        private AlarmsListener[] m_AlarmsListenerThread;
        private AlarmsListener m_AlarmsListenerMessagesHandlerThread;
        private LoggersKeepalive m_LoggersKeepaliveThread;
        private Export m_ExportThread;

        private StopPlaybackEntryComparerByDate sortByDate;

        private SourceType m_SourceType = SourceType.SourceType_Recorder;   // the source type

        private DateTime mLatestStartTime = DateTime.MinValue;              // stores the latest start time input
        private DateTime mLatestEndTime = DateTime.MaxValue;                // stores the latest end time input

        private PictureBox[] m_VmdEventArrow;
        private PictureBox[] m_Picture;
        private PictureBox[] m_VideoLoss;
        private ctlTransparent[] m_Transparent;
        private DisplayInfo m_DisplayInfo;        

        private List<int> m_NotSelectedOpenDisplayIndex;

        private Thread m_PulseListenerThread;
        private Thread m_DvrHiveServerThread;
        private Thread[] m_NiceAlarmsListenerThread;
        private Thread m_NiceAlarmsListenerMessagesHandlerThread;
        private Thread m_NiceLoggersKeepaliveThread;
        private Thread m_VendorExportThread;
        private Thread m_ViconApiThread;
        private SoundThreadObject m_SoundThreadObject;
        private Thread m_SoundThread;

        private ContextMenu m_DvrTreeContextMenu;
        private ContextMenu m_NoVideoContextMenu;
        private ContextMenu m_VideoContextMenu;

        private SerialPort m_SerialPort;
        private SerialSettings m_SerialSettings;
        private History m_History;

        private System.Windows.Forms.Timer tmrPtzPresetAgetStarter;
        private System.Windows.Forms.Timer tmrPtzPresetAgetState;

        private Rectangle m_Rectangle;
        private DisplaySurroundingFrame m_SurroundingFrame;

        private VendorLoader m_Loader;

        private System.Timers.Timer m_tmrDvtelWatchdog;

        #endregion

        #region Properties
        
        #region Communication

        [Description("The Pulse IP Port"), Category("Communication")]
        public int ListenerPort
        {
            get { return m_Settings.ListenerPort; }
            set
            {
                m_Settings.ListenerPort = value;
            }
        }

        [Description("The Server IP Address Index"), Category("Communication")]
        public int ListenerAddressIndex
        {
            get { return m_Settings.ListenerAddressIndex; }
            set
            {
                m_Settings.ListenerAddressIndex = value;
            }
        }

        [Description("The Dvr Hive Listener IP Port"), Category("Communication")]
        public int DvrHiveListenerPort
        {
            get { return m_Settings.DvrHiveListenerPort; }
            set
            {
                m_Settings.DvrHiveListenerPort = value;
            }
        }

        [Description("Use Serial Port"), Category("Communication")]
        public HiveState HiveState
        {
            get { return m_Settings.HiveState; }
            set { m_Settings.HiveState = value; }
        }

        [Description("Keep Alive Interval"), Category("Communication")]
        public int KeepAliveInterval
        {
            get { return m_Settings.KeepaliveInterval; }
            set { m_Settings.KeepaliveInterval = value; }
        }

        [Description("Authenticated Mode"), Category("Communication")]
        public bool AuthenticatedMode
        {
            get { return m_Settings.AuthenticatedMode; }
            set { m_Settings.AuthenticatedMode = value; }
        }

        [Description("Promiscuous Mode On"), Category("Communication")]
        public bool PromiscuousModeOn
        {
            get { return m_Settings.PromiscuousModeOn; }
            set { m_Settings.PromiscuousModeOn = value; }
        }

        [Description("Use Serial Port"), Category("Communication")]
        public bool UseSerialPort
        {
            get { return m_Settings.UseSerialPort; }
            set { m_Settings.UseSerialPort = value; }
        }

        [Editor(typeof(SerialSettingsEditor), typeof(UITypeEditor))]
        [Description("Serial Port Settings"), Category("Communication")]
        public string SerialPortSettings
        {
            get { return m_Settings.SerialPortSettings; }
            set { m_Settings.SerialPortSettings = value; }
        }

        #endregion

        #region Audit

        [Description("Audit To Log Control"), Category("Audit")]
        public bool AuditOn
        {
            get { return m_Settings.Audit; }
            set { m_Settings.Audit = value; }
        }

        [Description("Create Errors File"), Category("Audit")]
        public bool CreateErrorsFile
        {
            get { return m_Settings.CreateErrorsFile; }
            set { m_Settings.CreateErrorsFile = value; }
        }

        [Description("Audit To Log File"), Category("Audit")]
        public bool AuditLog
        {
            get { return m_Settings.AuditLog; }
            set { m_Settings.AuditLog = value; }
        }

        [Description("Audit To Log File"), Category("Audit")]
        public AuditFileType AuditLogFileType
        {
            get { return m_Settings.AuditLogFileType; }
            set { m_Settings.AuditLogFileType = value; }
        }

        [Description("Audit To Debug"), Category("Audit")]
        public bool AuditToDebug
        {
            get { return m_Settings.AuditToDebug; }
            set { m_Settings.AuditToDebug = value; }
        }

        [Description("Audit Lines Limit"), Category("Audit")]
        public int AuditLinesLimit
        {
            get { return m_Settings.AuditLinesLimit; }
            set { m_Settings.AuditLinesLimit = value; }
        }

        [Description("Audit Alarm Events"), Category("Audit")]
        public bool AlarmsAudit
        {
            get { return m_Settings.AlarmsAudit; }
            set { m_Settings.AlarmsAudit = value; }
        }

        [Description("Audit Refresh Tree"), Category("Audit")]
        public bool RefreshTreeAudit
        {
            get { return m_Settings.ShowRefreshTree; }
            set { m_Settings.ShowRefreshTree = value; }
        }

        [Description("Show Keep Alive On Audit"), Category("Audit")]
        public bool ShowKeepAliveOnAudit
        {
            get { return m_Settings.ShowKeepaliveOnAudit; }
            set { m_Settings.ShowKeepaliveOnAudit = value; }
        }

        [Description("Show Refresh Tree On Audit"), Category("Audit")]
        public bool ShowRefreshTreeOnAudit
        {
            get { return m_Settings.ShowRefreshTree; }
            set { m_Settings.ShowRefreshTree = value; }
        }

        [Description("Show Audit Error On MessageBox"), Category("Audit")]
        public bool ShowAuditErrorOnMessageBox
        {
            get { return m_Settings.ShowAuditErrorOnMessageBox; }
            set { m_Settings.ShowAuditErrorOnMessageBox = value; }
        }

        [Description("Show Method On Audit"), Category("Audit")]
        public bool ShowMethodOnAudit
        {
            get { return m_Settings.ShowMethodOnAudit; }
            set { m_Settings.ShowMethodOnAudit = value; }
        }

        [Description("Allow Write To Event Log"), Category("Audit")]
        public bool AllowWriteToEventLog
        {
            get { return m_Settings.AllowWriteToEventLog; }
            set { m_Settings.AllowWriteToEventLog = value; }
        }

        [Description("HD Minimum Free Space"), Category("Audit")]
        public int HdMinimumFreeSpace
        {
            get { return m_Settings.HdMinimumFreeSpace; }
            set { m_Settings.HdMinimumFreeSpace = value; }
        }

        [Description("Show Ptz Preset Agent Form"), Category("Audit")]
        public bool ShowPtzPresetAgentForm
        {
            get { return m_Settings.ShowPtzPresetAgentForm; }
            set { m_Settings.ShowPtzPresetAgentForm = value; }
        }        

        #endregion

        #region Protocol Data

        [Description("Show Protocol Raw Data"), Category("Audit")]
        public bool ShowProtocolRawData
        {
            get { return m_Settings.ShowProtocolRawData; }
            set { m_Settings.ShowProtocolRawData = value; }
        }

        [Description("Show Protocol Data"), Category("Audit")]
        public bool ShowProtocolData
        {
            get { return m_Settings.ShowProtocolData; }
            set { m_Settings.ShowProtocolData = value; }
        }

        #endregion
        
        #region Startup

        [Description("Project Name"), Category("Startup")]
        public string ProjectName
        {
            get { return m_Settings.ProjectName; }
            set { m_Settings.ProjectName = value; }
        }

        [Description("Anchor Application Form"), Category("Startup")]
        public bool AnchorApplicationForm
        {
            get { return m_Settings.AncorMainForm; }
            set { m_Settings.AncorMainForm = value; }
        }

        [Description("Main Form Left"), Category("Startup")]
        public int MainFormLeft
        {
            get { return m_Settings.MainFormLeft; }
            set { m_Settings.MainFormLeft = value; }
        }

        [Description("Main Form Top"), Category("Startup")]
        public int MainFormTop
        {
            get { return m_Settings.MainFormTop; }
            set { m_Settings.MainFormTop = value; }
        }

        [Description("Enable On Top"), Category("Startup")]
        public bool EnableOnTop
        {
            get { return m_Settings.OnTop; }
            set { m_Settings.OnTop = value; }
        }

        [Description("On Top Time"), Category("Startup")]
        public int OnTopTime
        {
            get { return m_Settings.OnTopTime; }
            set { m_Settings.OnTopTime = value; }
        }

        [Description("Maximum Displays Number"), Category("Startup")]
        public int MaxDisplaysNumber
        {
            get { return m_Settings.MaxDisplaysNumber; }
            set { m_Settings.MaxDisplaysNumber = value; }
        }

        [Description("Fixed Layout"), Category("Startup")]
        public DisplayFormatState FixedLayout
        {
            get { return m_Settings.FixedLayout; }
            set { m_Settings.FixedLayout = value; }
        }

        [Description("Language"), Category("Startup")]
        public Language Language
        {
            get { return m_Settings.Language; }
            set { m_Settings.Language = value; }
        }

        [Description("Width"), Category("Startup")]
        public int ControlWidth
        {
            get { return m_Settings.Width; }
            set { m_Settings.Width = value; }
        }

        [Description("Heigth"), Category("Startup")]
        public int ControlHeight
        {
            get { return m_Settings.Height; }
            set { m_Settings.Height = value; }
        }

        [TypeConverter(typeof(PreDefinedViewPicker))]
        [Description("Pre Defined View"), Category("Startup")]
        public string PreDefinedView
        {
            get
            {
                if (this.DesignMode)
                {
                    m_PreDefinedViews = GetPreDefinedViews();
                }
                return m_Settings.ActivePreDefinedView;
            }
            set { m_Settings.ActivePreDefinedView = value; }
        }

        [Description("Video Format"), Category("Startup")]
        public string VideoFormat
        {
            get { return m_Settings.VideoFormat; }
            set { m_Settings.VideoFormat = value; }
        }

        [Editor(typeof(ConnectionTypeEditor), typeof(UITypeEditor))]
        [Description("Connection String"), Category("Startup")]
        public string ConnectionString
        {
            get { return m_Settings.ConnectionString; }
            set
            {
                m_Settings.ConnectionString = value;

                if (this.DesignMode)
                {
                    m_PreDefinedViews = GetPreDefinedViews();
                }
            }
        }        

        [Description("Import Project Name From Pulse"), Category("Startup")]
        public bool ImportProjectName
        {
            get { return m_Settings.ImportProjectName; }
            set { m_Settings.ImportProjectName = value; }
        }

        [Description("PTZ Pan Speed"), Category("Startup")]
        public int PtzPanSpeed
        {
            get { return m_Settings.PanSpeed; }
            set { m_Settings.PanSpeed = value; }
        }

        [Description("PTZ Tilt Speed"), Category("Startup")]
        public int PtzTiltSpeed
        {
            get { return m_Settings.TiltSpeed; }
            set { m_Settings.TiltSpeed = value; }
        }

        [Description("PTZ Zoom In Speed"), Category("Startup")]
        public int PtzZoomInSpeed
        {
            get { return m_Settings.ZoomInSpeed; }
            set { m_Settings.ZoomInSpeed = value; }
        }

        [Description("PTZ Zoom Out Speed"), Category("Startup")]
        public int PtzZoomOutSpeed
        {
            get { return m_Settings.ZoomOutSpeed; }
            set { m_Settings.ZoomOutSpeed = value; }
        }

        [Description("Refresh Tree Time Interval"), Category("Startup")]
        public int RefreshTreeTimeInterval
        {
            get { return m_Settings.RefreshTreeTimeInterval; }
            set { m_Settings.RefreshTreeTimeInterval = value; }
        }

        [Description("Start In Full Screen Mode"), Category("Startup")]
        public bool StartInFullScreenMode
        {
            get { return m_Settings.StartInFullScreenMode; }
            set { m_Settings.StartInFullScreenMode = value; }
        }

        [Description("Camera Post Time"), Category("Startup")]
        public int CameraPostTime
        {
            get { return m_Settings.CameraPostTime; }
            set { m_Settings.CameraPostTime = value; }
        }

        [Description("Enable Fallback"), Category("Startup")]
        public bool EnableFallback
        {
            get { return m_Settings.EnableFallback; }
            set { m_Settings.EnableFallback = value; }
        }

        [Description("Enable Back To Original View By Double Click"), Category("Startup")]
        public bool EnableBackToOriginalViewByDblClk
        {
            get { return m_Settings.EnableBackToOriginalViewByDblClk; }
            set { m_Settings.EnableBackToOriginalViewByDblClk = value; }
        }

        [Editor(typeof(NoVideoPictureFilePathEditor), typeof(UITypeEditor))]
        [Description("'No Video' Picture File Path"), Category("Startup")]
        public string NoVideoPictureFilePath
        {
            get { return m_Settings.NoVideoPictureFilePath; }
            set { m_Settings.NoVideoPictureFilePath = value; }
        }

        #endregion

        #region Show

        [Description("Show Tools Menu"), Category("Hide / Show")]
        public bool ShowTools
        {
            get { return m_Settings.ShowTools; }
            set { m_Settings.ShowTools = value; }
        }                

        [Description("Hide Main Menu"), Category("Hide / Show")]
        public bool HideMenu
        {
            get { return m_Settings.HideMenu; }
            set { m_Settings.HideMenu = value; }
        }

        [Description("Hide Status Bar"), Category("Hide / Show")]
        public bool HideStatusBar
        {
            get { return m_Settings.HideStatusBar; }
            set { m_Settings.HideStatusBar = value; }
        }

        [Description("Hide Cameras/DVRs Tree"), Category("Hide / Show")]
        public bool HideTree
        {
            get { return m_Settings.HideTree; }
            set { m_Settings.HideTree = value; }
        }

        [Description("Show Host IP Address"), Category("Hide / Show")]
        public bool ShowHostIPAddress
        {
            get { return m_Settings.ShowLocalHostIPAddress; }
            set { m_Settings.ShowLocalHostIPAddress = value; }
        }

        [Description("Show Exit"), Category("Hide / Show")]
        public bool ShowExit
        {
            get { return m_Settings.ShowExit; }
            set { m_Settings.ShowExit = value; }
        }

        [Description("Hide PTZ Buttons"), Category("Hide / Show")]
        public bool HidePTZButtons
        {
            get { return m_Settings.HidePtzButtons; }
            set { m_Settings.HidePtzButtons = value; }
        }

        [Description("Show Layouts Menu"), Category("Hide / Show")]
        public bool ShowLayoutsMenu
        {
            get { return m_Settings.ShowLayoutsMenu; }
            set { m_Settings.ShowLayoutsMenu = value; }
        }

        [Description("Show Number Of Active Displays"), Category("Hide / Show")]
        public bool ShowNumberOfActiveDisplays
        {
            get { return m_Settings.ShowNumberOfActiveDisplays; }
            set { m_Settings.ShowNumberOfActiveDisplays = value; }
        }

        [Description("On Missing Preset Open Camera"), Category("Hide / Show")]
        public bool OnMissingPresetOpenCamera
        {
            get { return m_Settings.OnMissingPresetOpenCamera; }
            set { m_Settings.OnMissingPresetOpenCamera = value; }
        }

        #endregion

        #region Snapshot

        [Description("Snapshot Filename Type"), Category("Snapshot")]
        public SnapShotFileNameType SnapshotFilenameType
        {
            get { return m_Settings.SnapshotFilenameType; }
            set { m_Settings.SnapshotFilenameType = value; }
        }

        [Description("Snapshot Default Filename"), Category("Snapshot")]
        public string SnapshotDefaultFilename
        {
            get { return m_Settings.SnapShotDefaultFileName; }
            set { m_Settings.SnapShotDefaultFileName = value; }
        }

        #endregion

        #region Playback

        [Description("Playback Last Minutes"), Category("Playback")]
        public int PlaybackLastMinutes
        {
            get { return m_Settings.PlaybackLastMinutes; }
            set { m_Settings.PlaybackLastMinutes = value; }
        }

        [Description("Playback Gap From Now"), Category("Playback")]
        public int PlaybackGapFromNow
        {
            get { return m_Settings.PlaybackGapFromNow; }
            set { m_Settings.PlaybackGapFromNow = value; }
        }

        #endregion

        #region Export

        [Editor(typeof(FolderPathEditor), typeof(UITypeEditor))]
        [Description("Export Folder"), Category("Startup")]
        public string ExportFolder
        {
            get { return m_Settings.ExportFolder; }
            set { m_Settings.ExportFolder = value; }
        }

        [Description("Show Open Export Directory Dialog"), Category("Export")]
        public bool ShowOpenExportDirectoryDialog
        {
            get { return m_Settings.ShowOpenExportDirectoryDialog; }
            set { m_Settings.ShowOpenExportDirectoryDialog = value; }
        }

        #endregion

        #region Version

        [Description("Dvr Client Version"), Category("Version")]
        public string DvrClientVersion
        {
            get { return m_Settings.Version; }
        }

        #endregion

        #region Pulse

        [Description("Pulse Port"), Category("Pulse")]
        public int PulsePort
        {
            get { return m_Settings.PulsePort; }
            set { m_Settings.PulsePort = value; }
        }

        [Description("Pulse Plc"), Category("Pulse")]
        public int PulsePlc
        {
            get { return m_Settings.PulsePlc; }
            set { m_Settings.PulsePlc = value; }
        }

        [Description("Pulse IP Address"), Category("Pulse")]
        public string PulseIpAddress
        {
            get { return m_Settings.PulseIpAddress; }
            set { m_Settings.PulseIpAddress = value; }
        }

        [Description("Pulse Ip Port"), Category("Pulse")]
        public int PulseIpPort
        {
            get { return m_Settings.PulseIpPort; }
            set { m_Settings.PulseIpPort = value; }
        }

        [Description("Pulse Vis Dvr Client State"), Category("Pulse")]
        public ViaPulseState DvrClientViaPulseState
        {
            get { return m_Settings.DvrClientViaPulseState; }
            set { m_Settings.DvrClientViaPulseState = value; }
        }

        [Description("Pulse Port"), Category("Pulse")]
        public int PcimPulsePort
        {
            get { return m_Settings.PcimPulsePort; }
            set { m_Settings.PcimPulsePort = value; }
        }

        [Description("Pulse Station ID"), Category("Pulse")]
        public int PcimPulseStationID
        {
            get { return m_Settings.PcimPulseStationID; }
            set { m_Settings.PcimPulseStationID = value; }
        }

        [Editor(typeof(PulseConnectionTypeEditor), typeof(UITypeEditor))]
        [Description("Pulse Database Connection String"), Category("Pulse Events")]
        public string PulseDatabaseConnectionString
        {
            get { return m_Settings.PulseDatabaseConnectionString; }
            set { m_Settings.PulseDatabaseConnectionString = value; }
        }

        [Description("Pulse Playback Pre Event Time"), Category("Pulse Events")]
        public int PlaybackPreEventTime
        {
            get { return m_Settings.PlaybackPreEventTime; }
            set { m_Settings.PlaybackPreEventTime = value; }
        }

        [Description("Pulse Playback Post Event Time"), Category("Pulse Events")]
        public int PlaybackPostEventTime
        {
            get { return m_Settings.PlaybackPostEventTime; }
            set { m_Settings.PlaybackPostEventTime = value; }
        }

        [Description("Close Manual Cameras On Event"), Category("Pulse Events")]
        public bool CloseManualCamerasOnEvent
        {
            get { return m_Settings.CloseManualCamerasOnEvent; }
            set { m_Settings.CloseManualCamerasOnEvent = value; }
        }

        [Description("Refresh Event Tree Time Interval"), Category("Pulse Events")]
        public int RefreshEventTreeTimeInterval
        {
            get { return m_Settings.RefreshEventTreeTimeInterval; }
            set { m_Settings.RefreshEventTreeTimeInterval = value; }
        }

        [Description("Show Events Tree On Startup"), Category("Pulse Events")]
        public bool ShowEventsTreeOnStartup
        {
            get { return m_Settings.ShowEventsTreeOnStartup; }
            set { m_Settings.ShowEventsTreeOnStartup = value; }
        }

        [Description("Number Of Event Records"), Category("Pulse Events")]
        public int NumberOfEventRecords
        {
            get { return m_Settings.NumberOfEventRecords; }
            set { m_Settings.NumberOfEventRecords = value; }
        }

        [Description("Oldest Event Record Date"), Category("Pulse Events")]
        public DateTime OldestEventRecordDate
        {
            get { return m_Settings.OldestEventRecordDate; }
            set { m_Settings.OldestEventRecordDate = value; }
        }

        [Description("Use Number Of Event Records"), Category("Pulse Events")]
        public bool UseNumberOfEventRecords
        {
            get { return m_Settings.UseNumberOfEventRecords; }
            set { m_Settings.UseNumberOfEventRecords = value; }
        }

        [Description("Use Oldest Event Record Date"), Category("Pulse Events")]
        public bool UseOldestEventRecordDate
        {
            get { return m_Settings.UseOldestEventRecordDate; }
            set { m_Settings.UseOldestEventRecordDate = value; }
        }

        [Description("Enable Pulse Events"), Category("Pulse Events")]
        public bool EnablePulseEvents
        {
            get { return m_Settings.EnablePulseEvents; }
            set { m_Settings.EnablePulseEvents = value; }
        }

        [Description("Server Sleep In Milliseconds"), Category("Pulse Events")]
        public int ServerSleepInMilliseconds
        {
            get { return m_Settings.ServerSleepInMilliseconds; }
            set { m_Settings.ServerSleepInMilliseconds = value; }
        }

        [Description("Use Alarms Queue"), Category("Pulse Events")]
        public bool UseAlarmsQueue
        {
            get { return m_Settings.UseAlarmsQueue; }
            set { m_Settings.UseAlarmsQueue = value; }
        }

        [Description("Alarms Queue Limit Size"), Category("Pulse Events")]
        public int AlarmsQLimitSize
        {
            get { return m_Settings.AlarmsQLimitSize; }
            set { m_Settings.AlarmsQLimitSize = value; }
        }

        [Description("Gap Between Alarms In Mili Seconds"), Category("Pulse Events")]
        public int GapBetweenAlarmsInMiliSeconds
        {
            get { return m_Settings.GapBetweenAlarmsInMiliSeconds; }
            set { m_Settings.GapBetweenAlarmsInMiliSeconds = value; }
        }                

        #endregion

        #region Nice Settings

        [Description("The Nice AMS IP Address"), Category("Nice Settings")]
        public string NiceAmsIP
        {
            get { return m_Settings.NiceAmsIp; }
            set { m_Settings.NiceAmsIp = value; }
        }

        [Description("The Nice User Name"), Category("Nice Settings")]
        public string NiceUser
        {
            get { return m_Settings.NiceUser; }
            set { m_Settings.NiceUser = value; }
        }

        [Description("The Nice Password"), Category("Nice Settings")]
        public string NicePassword
        {
            get { return m_Settings.NicePassword; }
            set { m_Settings.NicePassword = value; }
        }        

        [Description("NICE SDK Version"), Category("Nice Settings")]
        public string NiceSdkVersion
        {
            get { return Utils.GetNiceSdkVersion(); }
        }

        [Description("Show Nice Content Analysis Suspicious Objects"), Category("Nice Settings")]
        public bool ShowNiceContentAnalysisSuspiciousObjects
        {
            get { return m_Settings.ShowNiceContentAnalysisSuspiciousObjects; }
            set { m_Settings.ShowNiceContentAnalysisSuspiciousObjects = value; }
        }

        [Description("Show Nice Content Analysis Type"), Category("Nice Settings")]
        public bool ShowNiceContentAnalysisType
        {
            get { return m_Settings.ShowNiceContentAnalysisType; }
            set { m_Settings.ShowNiceContentAnalysisType = value; }
        }

        [Description("Show Nice Time"), Category("Nice Settings")]
        public bool ShowNiceTime
        {
            get { return m_Settings.ShowNiceTime; }
            set { m_Settings.ShowNiceTime = value; }
        }

        [Description("Show Nice Date"), Category("Nice Settings")]
        public bool ShowNiceDate
        {
            get { return m_Settings.ShowNiceDate; }
            set { m_Settings.ShowNiceDate = value; }
        }

        [Description("Show Nice Camera Name"), Category("Nice Settings")]
        public bool ShowNiceCameraName
        {
            get { return m_Settings.ShowNiceCameraName; }
            set { m_Settings.ShowNiceCameraName = value; }
        }

        [Description("Show Nice Operation Status"), Category("Nice Settings")]
        public bool ShowNiceOperationStatus
        {
            get { return m_Settings.ShowNiceOperationStatus; }
            set { m_Settings.ShowNiceOperationStatus = value; }
        }

        [Description("Nice CPU Performance Units"), Category("Nice Settings")]
        public int NicePerformanceUnits
        {
            get { return m_Settings.NicePerformanceUnits; }
            set { m_Settings.NicePerformanceUnits = value; }
        }

        [Description("Nice Font Color"), Category("Nice Settings")]
        public Color NiceFontColor
        {
            get { return m_Settings.NiceFontColor; }
            set { m_Settings.NiceFontColor = value; }
        }

        [Description("Nice Font"), Category("Nice Settings")]
        public Font NiceFont
        {
            get { return m_Settings.NiceFont; }
            set { m_Settings.NiceFont = value; }
        }

        [Description("Nice Core Api Timeout Seconds"), Category("Nice Settings")]
        public int CoreApiTimeoutSeconds
        {
            get { return m_Settings.CoreApiTimeoutSeconds; }
            set { m_Settings.CoreApiTimeoutSeconds = value; }
        }

        [Description("Nice Video Display Free Text X"), Category("Nice Settings")]
        public int NiceVideoDisplayFreeTextX
        {
            get { return m_Settings.NiceVideoDisplayFreeTextX; }
            set { m_Settings.NiceVideoDisplayFreeTextX = value; }
        }

        [Description("Nice Video Display Free Text Y"), Category("Nice Settings")]
        public int NiceVideoDisplayFreeTextY
        {
            get { return m_Settings.NiceVideoDisplayFreeTextY; }
            set { m_Settings.NiceVideoDisplayFreeTextY = value; }
        }

        [Description("PTZ & Preset Path"), Category("Nice Settings")]
        public PtzPresetActivation PtzPresetPath
        {
            get { return m_Settings.PtzPresetPath; }
            set { m_Settings.PtzPresetPath = value; }
        }

        [Editor(typeof(FolderPathEditor), typeof(UITypeEditor))]
        [Description("Nice Dlls Path"), Category("Nice Settings")]
        public string NiceDllsPath
        {
            get { return m_Settings.NiceDllsPath; }
            set { m_Settings.NiceDllsPath = value; }
        }        

        #endregion

        #region HikVision5200

        [Description("The HikVision 5200 Username"), Category("HikVision 5200 Settings")]
        public string HikVision5200Username
        {
            get { return m_Settings.HikVision5200Username; }
            set { m_Settings.HikVision5200Username = value; }
        }

        [Description("The HikVision 5200 Password"), Category("HikVision 5200 Settings")]
        public string HikVision5200Password
        {
            get { return m_Settings.HikVision5200Password; }
            set { m_Settings.HikVision5200Password = value; }
        }

        [Description("The HikVision 5200 Server IP Address"), Category("HikVision 5200 Settings")]
        public string HikVision5200ServerIp
        {
            get { return m_Settings.HikVision5200ServerIp; }
            set { m_Settings.HikVision5200ServerIp = value; }
        }

        [Description("The HikVision 5200 Server IP Port"), Category("HikVision 5200 Settings")]
        public string HikVision5200ServerPort
        {
            get { return m_Settings.HikVision5200ServerPort; }
            set { m_Settings.HikVision5200ServerPort = value; }
        }

        [Description("The HikVision 5200 CPM IP Address"), Category("HikVision 5200 Settings")]
        public string HikVision5200CpmIp
        {
            get { return m_Settings.HikVision5200CpmIp; }
            set { m_Settings.HikVision5200CpmIp = value; }
        }

        [Description("The HikVision 5200 CPM IP Port"), Category("HikVision 5200 Settings")]
        public string HikVision5200CpmPort
        {
            get { return m_Settings.HikVision5200CpmPort; }
            set { m_Settings.HikVision5200CpmPort = value; }
        }

        [Description("The HikVision 5200 Verification Code"), Category("HikVision 5200 Settings")]
        public string HikVision5200VerificationCode
        {
            get { return m_Settings.HikVision5200VerificationCode; }
            set { m_Settings.HikVision5200VerificationCode = value; }
        }

        #endregion

        #region Vicon Settings

        [Description("The Vicon User Name"), Category("Vicon Settings")]
        public string ViconUser
        {
            get { return m_Settings.ViconUser; }
            set { m_Settings.ViconUser = value; }
        }

        [Description("The Vicon Password"), Category("Vicon Settings")]
        public string ViconPassword
        {
            get { return m_Settings.ViconPassword; }
            set { m_Settings.ViconPassword = value; }
        }

        [Description("The Vicon Nucleus IP Address"), Category("Vicon Settings")]
        public string ViconNucleusIP
        {
            get { return m_Settings.ViconNucleusIp; }
            set { m_Settings.ViconNucleusIp = value; }
        }

        [Description("Enable Vicon Macros"), Category("Vicon Settings")]
        public bool EnableViconMacros
        {
            get { return m_Settings.EnableViconMacros; }
            set { m_Settings.EnableViconMacros = value; }
        }

        #endregion

        #region Sounds

        [Editor(typeof(FolderPathEditor), typeof(UITypeEditor))]
        [Description("Sound Files Folder Path"), Category("Sounds")]
        public string SoundFilesFolderPath
        {
            get { return m_Settings.SoundFilesFolderPath; }
            set { m_Settings.SoundFilesFolderPath = value; }
        }

        [Description("Sounds On"), Category("Sounds")]
        public bool SoundsOn
        {
            get { return m_Settings.SoundsOn; }
            set { m_Settings.SoundsOn = value; }
        }

        #endregion        

        public bool NicePlayerManagerConnected
        {
            get;
            set;
        }

        public string RemoteAddress
        { 
            get { return m_sRemoteAddress; }
            set { m_sRemoteAddress = value; }
        }

        public string RemotePort
        {
            get { return m_sRemotePort; }
            set { m_sRemotePort = value; }
        }

        public bool Connected
        {
            get { return m_bConnected; }
            set 
            {   
                m_bConnected = value;
                if (m_bConnected)
                {
                    lblConnected.Text = "Connected To Pulse";
                    ConnectedColor(Color.Green);
                }
                else
                {
                    lblConnected.Text = "Disconnected From Pulse";
                    ConnectedColor(Color.Red);
                }
            }
        }

        public bool DvrClientDbConnected
        {
            get { return m_bDvrClientDbConnected; }
            set { m_bDvrClientDbConnected = value; }
        }

        public bool PulseDbConnected
        {
            get { return m_bPulseDbConnected; }
            set { m_bPulseDbConnected = value; }
        }

        public string[] PreDefinedViews
        {
            get { return m_PreDefinedViews; }
            set { m_PreDefinedViews = value; }
        }

        private int VideoPlayersZoneLeft
        {
            get { return m_iVideoPlayersZoneLeft; }
            set { m_iVideoPlayersZoneLeft = value; }
        }

        private int VideoPlayersZoneTop
        {
            get { return m_iVideoPlayersZoneTop; }
            set { m_iVideoPlayersZoneTop = value; }
        }

        private int VideoPlayersZoneWidth
        {
            get { return m_iVideoPlayersZoneWidth; }
            set { m_iVideoPlayersZoneWidth = value; }
        }

        private int VideoPlayersZoneHeight
        {
            get { return m_iVideoPlayersZoneHeight; }
            set { m_iVideoPlayersZoneHeight = value; }
        }

        #endregion

        #region Events

        public event EventHandler BubbleClick;
        public event EventHandler FullScreenChanged;
        public event EventHandler BackToNormalScreen;
        public event EventHandler CameraSelected;
        public event EventHandler KillApplication;
        public event EventHandler RestartApplication;
        public event EventHandler SaveSettings;
        public event EventHandler OnTopEvent;
        public event EventHandler FunctionFinished;

        #endregion   

        #region System APIs

        [DllImport("user32.dll", EntryPoint = "FindWindow", SetLastError = true)]
        static extern IntPtr FindWindowByCaption(IntPtr ZeroOnly, string lpWindowName);

        [DllImport("user32.dll")]
        static extern int PostMessage(IntPtr hWnd, UInt32 msg, int wParam, int lParam);

        #endregion

        public DvrClient()
        {
            m_Settings = new DvrProxySettings();

            PtzEvent += new EventHandler(DvrClient_PtzEvent);

            _hookID = SetHook(_proc);

            SetStyle(ControlStyles.AllPaintingInWmPaint |
                     ControlStyles.DoubleBuffer |
                     ControlStyles.ResizeRedraw |
                     ControlStyles.SupportsTransparentBackColor,
                     true);

            InitializeComponent();
            PropertiesDefaultValues();
        }

        public void DvrClient_PtzEvent(object sender, EventArgs e)
        {
            //PComp_PTZMoveDirection ptzDirection = (PComp_PTZMoveDirection)(sender);

            //PtzAction(ptzDirection);
            PtzStop();
        }

        private void DvrClient_Load(object sender, EventArgs e)
        {
            string sParentForm;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (this.DesignMode)
                {
                    mnuExit.Visible = false;
                    return;
                }

                sParentForm = this.ParentForm.GetType().ToString();

                switch (sParentForm)
                {
                    case "Afcon.Pcim.Client.Designer.GraphicSurfaceRuntimeForm":
                    case "Dvr.Client.Tester.frmMain":
                        //  this means it's ok for Pulse or private tester form
                        mnuRestart.Visible = false;

                        m_Settings.Mode = ActivationMode.Control;
                        break;


                    case "Afcon.DvrClient.Activator.frmMain":

                        //  this means that is hosted by an Activertor
                        mnuAbout.Visible = true;
                        mnuRestart.Visible = false;
                        mnuExit.Visible = true;

                        m_Settings.Mode = ActivationMode.StandAlone;
                        break;


                    default:
                        //not authorized to connect
                        m_Settings.Mode = ActivationMode.Unknown;
                        return;
                }

                IntPtr hMenu = GetSystemMenu(this.Handle, false);
                int menuItemCount = GetMenuItemCount(hMenu);
                RemoveMenu(hMenu, menuItemCount - 1, MF_BYPOSITION);

                //string sDvrCommonDllPath = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) + "\\DVR.Common.dll";
                //if (!File.Exists(sDvrCommonDllPath))
                //{
                //    MessageBox.Show("The DLL 'DVR.Common.dll' Is Missing.\nPlease Install DLL Before Trying To Load Application.",
                //                    "DLL Missing",
                //                    MessageBoxButtons.OK,
                //                    MessageBoxIcon.Error);

                //    mnuExit_Click(null, null);

                //    return;
                //}
                //else
                //{
                    Initialize();
                //}

                #region Hide Menu

                //if (m_Settings.HideMenu)
                //{
                //    string sHideMenu;

                //    //m_SystemMenu = SystemMenu.FromForm(this);
                //    if (m_Settings.Language == Language.English)
                //    {
                //        sHideMenu = "Unhide Menu";
                //    }
                //    else
                //    {
                //        sHideMenu = " ";
                //    }
                //    //m_SystemMenu.InsertMenu(6, m_UnhideMenuID, sHideMenu);
                //} 

                #endregion
            }
            catch (Exception ex)
            {
                Utils.WriteToEventLog("DVR Client",
                                      "Main - " + sMethod,
                                      ex.Message,
                                      0,
                                      EventLogEntryType.Error);
                MessageBox.Show(ex.Message, "Load Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }        

        private void Initialize()
        {
            #region Data Members
            
            string sPath;
            string sFileName;            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            //string sErrorMessage;
            string sResult;
            string sError;
            string sMessage;
            string sDllFileName;
            int iProgressCounter;

            bool bPulseAlarmsTreeRefresh;
            bool bPulseAlarmsActive;
            bool bContinue;

            DbReturnCode dbRc;

            //Ping netMon;            

            DisplayFormatState dfsInitialLayout;

            #endregion
            
            #region Startup (0)

            m_StarupProgress = new frmStartup(49, m_Settings.Language);
            m_StarupProgress.Show();

            iProgressCounter = 0;

            #endregion

            try
            {
                Prologue();

                #region Initialize Strings

                iProgressCounter++;

                StartupProgress("Initialize Strings (" + iProgressCounter + ")");

                m_sMajorError = "";
                m_sLoggers = new List<string>();
                m_sRangeError = "";
                m_sRemoteAddress = "";
                m_sRemotePort = "";
                m_sSerialPortBuffer = "";

                m_sPath = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);
                m_sDrive = m_sPath.Substring(0, 1) + ":\\";
                m_sProcessName = Process.GetCurrentProcess().ProcessName;

                #endregion

                #region Check Important DLLs Presence

                //iProgressCounter++;

                //StartupProgress("Check Important DLLs Presence (" + iProgressCounter + ")");

                //sDllFileName = "AudioRender.dll";
                //if (!File.Exists(m_sPath + "\\" + sDllFileName))
                //{
                //    MessageBox.Show("File '" + sDllFileName + "' Does Not Exist In Execution Directory",
                //                    "Important DLL Missing",
                //                    MessageBoxButtons.OK,
                //                    MessageBoxIcon.Error);

                //    KillStatupProgress();
                //    return;
                //}

                //sDllFileName = "HCCore.dll";
                //if (!File.Exists(m_sPath + "\\" + sDllFileName))
                //{
                //    MessageBox.Show("File '" + sDllFileName + "' Does Not Exist In Execution Directory",
                //                    "Important DLL Missing",
                //                    MessageBoxButtons.OK,
                //                    MessageBoxIcon.Error);
                //    KillStatupProgress();
                //    return;
                //}

                //sDllFileName = "HCNetSDK.dll";
                //if (!File.Exists(m_sPath + "\\" + sDllFileName))
                //{
                //    MessageBox.Show("File '" + sDllFileName + "' Does Not Exist In Execution Directory",
                //                    "Important DLL Missing",
                //                    MessageBoxButtons.OK,
                //                    MessageBoxIcon.Error);
                //    KillStatupProgress();
                //    return;
                //}

                //sDllFileName = "PlayCtrl.dll";
                //if (!File.Exists(m_sPath + "\\" + sDllFileName))
                //{
                //    MessageBox.Show("File '" + sDllFileName + "' Does Not Exist In Execution Directory",
                //                    "Important DLL Missing",
                //                    MessageBoxButtons.OK,
                //                    MessageBoxIcon.Error);
                //    KillStatupProgress();
                //    return;
                //}

                //sDllFileName = "SuperRender.dll";
                //if (!File.Exists(m_sPath + "\\" + sDllFileName))
                //{
                //    MessageBox.Show("File '" + sDllFileName + "' Does Not Exist In Execution Directory",
                //                    "Important DLL Missing",
                //                    MessageBoxButtons.OK,
                //                    MessageBoxIcon.Error);
                //    KillStatupProgress();
                //    return;
                //}

                #endregion

                #region Initialize Flags

                iProgressCounter++;
                StartupProgress("Initialize flags (" + iProgressCounter + ")");

                m_bStartCameraByClick = false;
                m_bRangeError = false;
                m_bMajorError = false;
                m_bVod = false;
                m_bKeyPressed = false;
                m_bUnhideMenu = false;
                m_bDatabaseExists = false;
                SetSpecialLayoutsMode(false);
                m_bCutMainViewInTheMiddle = false;
                m_bCutPredefinedViewInTheMiddle = false;
                m_bShowDvrClientDataScope = false;
                m_bShowDvrsAndCamerasInformation = false;
                m_bShowDisplayManagerViewer = false;
                m_bShowSettings = false;
                m_bShowDisplayTemplates = false;
                m_bLanguageSwitched = false;
                m_bConnected = false;
                m_bDvrClientDbConnected = false;
                m_bPulseDbConnected = false; 
                m_bInHistory = false;
                m_bStopF11Activity = false;
                m_bViconApiDllPresent = false;
                m_bChangingBackToNormalScreenMode = false;
                m_bHdLimitReached = false;
                m_bMultiSelect = false;
                Utils.ShowErrorMessages = true;
                Utils.AllowWriteToEventLog = m_Settings.AllowWriteToEventLog;
                m_bTreeviewDvrCheckedFlag = true;
                m_bClosing = false;
                m_bFixedLayout = (m_Settings.FixedLayout == DisplayFormatState.Unknown) ? false : true;

                m_bPulseIsConnected = false;
                m_bUnlockFileExists = (File.Exists(m_sPath + "\\gots07e01"));

                #endregion

                #region Initialize Values

                iProgressCounter++;
                StartupProgress("Initialize Values (" + iProgressCounter + ")");

                m_Settings.PcimPulsePort = DvrClientConstants.NONE;
                m_Settings.PcimPulseStationID = DvrClientConstants.NONE;
                m_iHdLimitReachedTimeInterval = 0;

                sFileName = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) + "\\" + DvrClientConstants.OSD_DEFAULT_FILENAME;
                if (!File.Exists(sFileName))
                {
                    m_iOsdDefault = 0;
                }
                else
                {
                    m_iOsdDefault = Utils.ReadFromXmlFile<int>(sFileName);
                }

                #endregion

                #region Initialize Audit & Error Files

                if (m_Settings.AuditLog)
                {
                    string sAuditFileType = "";
                    bool bUseAuditFile = true;

                    switch (m_Settings.AuditLogFileType)
                    {
                        case AuditFileType.TextFile:
                            sAuditFileType = ".txt";
                            break;

                        case AuditFileType.Csv:
                            sAuditFileType = ".csv";
                            break;

                        default:
                            bUseAuditFile = false;
                            break;
                    }

                    iProgressCounter++;
                    StartupProgress("Initialize Audit & Error Files (" + iProgressCounter + ")");

                    if (bUseAuditFile)
                    {
                        sFileName = DvrClientConstants.APPLICATION_NAME + " " +
                                    Utils.Strech(DateTime.Now.Day.ToString()) + "-" +
                                    Utils.Strech(DateTime.Now.Month.ToString()) + "-" +
                                    DateTime.Now.Year.ToString() + " " +
                                    Utils.Strech(DateTime.Now.Hour.ToString()) + "-" +
                                    Utils.Strech(DateTime.Now.Minute.ToString()) + "-" +
                                    Utils.Strech(DateTime.Now.Second.ToString()) + " " +
                                    sAuditFileType;

                        m_AuditFile = new StreamWriter(m_sPath + "\\" + sFileName); 
                    }
                }

                if (m_Settings.CreateErrorsFile)
                {
                    sFileName = DvrClientConstants.APPLICATION_NAME + " Errors " +
                                Utils.Strech(DateTime.Now.Day.ToString()) + "-" +
                                Utils.Strech(DateTime.Now.Month.ToString()) + "-" +
                                DateTime.Now.Year.ToString() + " " +
                                Utils.Strech(DateTime.Now.Hour.ToString()) + "-" +
                                Utils.Strech(DateTime.Now.Minute.ToString()) + "-" +
                                Utils.Strech(DateTime.Now.Second.ToString()) + " " +
                                ".txt";

                    m_ErrorsFile = new StreamWriter(m_sPath + "\\" + sFileName); 
                }

                if (!m_Settings.AuditLog)
                {
                    mnuDeleteLogFiles.Enabled = false;
                }

                #endregion

                #region Prepare Audit Form

                iProgressCounter++;
                StartupProgress("Prepare Audit Form (" + iProgressCounter + ")");

                if (m_Settings.Audit)
                {
                    mnuAudit.Visible = true;
                    Audit("Show 'Audit' Menu", sMethod, AuditSeverity.Information);

                    if (m_Settings.AuditLinesLimit == 0)
                    {
                        m_Settings.AuditLinesLimit = DvrClientConstants.DEFAULT_AUDIT_LINES_LIMIT;
                    }

                    m_Log = new frmAudit(m_Settings.ShowMethodOnAudit,
                                         m_Settings.ShowAuditErrorOnMessageBox,
                                         m_Settings.AuditLinesLimit,
                                         AlarmListenerFilter);
                    m_Log.Show();
                }
                else
                {
                    mnuAudit.Visible = false;
                    Audit("Hide 'Audit' Menu", sMethod, AuditSeverity.Information);
                }

                Audit("Start Initialization", sMethod, AuditSeverity.Important);
                Audit("Activation Mode Is '" + m_Settings.Mode.ToString() + "'", 
                      sMethod, 
                      AuditSeverity.Information);

                #endregion

                #region Initialize List DB

                if (!GetVendorDvrRecords(out sResult))
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);

                    CreateNewVendorHostsFile();
                }

                Audit(m_VendorDvrRecord.Count + " " + Utils.GetVendorPluginName() + " Dvr Records Loaded", sMethod, AuditSeverity.Information);

                #endregion

                #region Prepare Protocol Form

                iProgressCounter++;
                StartupProgress("Prepare Protocol Form (" + iProgressCounter + ")");

                if (m_Settings.ShowProtocolRawData | m_Settings.ShowProtocolData)
                {
                    string sAuditProtocolFilePath;

                    m_Protocol = new frmProtocol();
                    m_Protocol.Show();
                   
                    sPath = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);
                    sAuditProtocolFilePath = sPath + 
                                             "\\" +
                                             DvrClientConstants.APPLICATION_NAME + "- Protocol Data - " +
                                             Utils.Strech(DateTime.Now.Day.ToString()) + "-" +
                                             Utils.Strech(DateTime.Now.Month.ToString()) + "-" +
                                             DateTime.Now.Year.ToString() + " " +
                                             Utils.Strech(DateTime.Now.Hour.ToString()) + "-" +
                                             Utils.Strech(DateTime.Now.Minute.ToString()) + "-" +
                                             Utils.Strech(DateTime.Now.Second.ToString()) + " " +
                                             ".txt";

                    m_ProtocolDataFile = new StreamWriter(sAuditProtocolFilePath);                    
                }

                #endregion

                #region Serial Port

                iProgressCounter++;
                StartupProgress("Serial Port (" + iProgressCounter + ")");

                if (m_Settings.UseSerialPort && (m_Settings.HiveState == HiveState.Off))
                {
                    m_SerialSettings = new SerialSettings();
                    try
                    {
                        m_SerialSettings.Nuke(m_Settings.SerialPortSettings);
                    }
                    catch (Exception)
                    {
                        m_Settings.SerialPortSettings = "COM1,9600,One,8,None,None";
                        m_SerialSettings.Nuke(m_Settings.SerialPortSettings);
                    }

                    m_SerialPort = new SerialPort(m_SerialSettings.COM,
                                                  (int)m_SerialSettings.BAUD_RATE,
                                                  m_SerialSettings.PARITY,
                                                  (int)m_SerialSettings.DATA_BITS,
                                                  m_SerialSettings.STOP_BITS);
                    m_SerialPort.Handshake = m_SerialSettings.HANDSHAKE;
                    m_SerialPort.DataReceived += new SerialDataReceivedEventHandler(m_SerialPort_DataReceived);
                    m_SerialPort.ErrorReceived += new SerialErrorReceivedEventHandler(m_SerialPort_ErrorReceived);

                    if (m_SerialPort.IsOpen)
                    {
                        m_SerialPort.Close();
                    }

                    try
                    {
                        m_SerialPort.Open();

                        if (m_SerialPort.IsOpen)
                        {
                            sMessage = "COM Port[" + m_SerialSettings.COM;
                            sMessage += "] Baud Rate[" + (int)(m_SerialSettings.BAUD_RATE);
                            sMessage += "] Stop Bits[" + m_SerialSettings.STOP_BITS;
                            sMessage += "] Data Bits[" + (int)(m_SerialSettings.DATA_BITS);
                            sMessage += "] Parity[" + m_SerialSettings.PARITY;
                            sMessage += "] Handshake[" + m_SerialSettings.HANDSHAKE + "]";

                            Audit("Serial Port Is Open. " + sMessage, sMethod, AuditSeverity.Information);
                        }
                        else
                        {
                            Audit("Could Not Open Serial Port", sMethod, AuditSeverity.Warning);
                        }
                    }
                    catch (Exception e)
                    {
                        Audit("Keyboard Joystick Disabled. " + e.Message, sMethod, AuditSeverity.Warning);
                    } 
                }
                else
                {
                    Audit("Serial Port Not Used", sMethod, AuditSeverity.Information);
                }

                #endregion

                #region Version

                iProgressCounter++;
                StartupProgress("Version (" + iProgressCounter + ")");

                Audit("DVR Client Version " + this.ProductVersion, sMethod, AuditSeverity.Important);
                m_Settings.Version = this.ProductVersion;

                //Audit("NICE SDK Version " + Utils.GetFileVersion("NVPlayerCompX.dll", m_sPath, false), 
                //      sMethod, 
                //      AuditSeverity.Important);

                #endregion

                #region Initialize GUI

                iProgressCounter++;
                StartupProgress("Initialize GUI (" + iProgressCounter + ")");

                if (m_Settings.Mode == ActivationMode.StandAlone)
                {
                    ParentForm.Text = "Afcon " + Utils.GetVendorPluginName() + " DVR Client - Pulse Port[" + m_Settings.PulsePort + "] Pulse Plc[" + m_Settings.PulsePlc + "]";
                }

                tv.BackColor = System.Drawing.Color.Black;
                tv.ForeColor = System.Drawing.Color.White;

                CloseButtonVisible(false);
                btnDigitalZoom.Visible = false;
                this.tv.AllowDrop = true;
                ttPlaybackTrackbar = new ToolTip();
                ttPlaybackSmallTrackbar = new ToolTip();
                ttTriggerEvent = new ToolTip();
                PtzGUI(false);

                gbPTZ.Width = 176;
                gbPlayback.Width = 190;
                gbSmallPlayback.Width = 300;
                gbPresets.Width = 394;

                trackBarPlayPosition.Width = 160;
                trackBarPlayPosition.RightToLeft = RightToLeft.No;
                trackSmallBarPlayPosition.RightToLeft = RightToLeft.No;
                pbEvent.Left = trackSmallBarPlayPosition.Left - (pbEvent.Width / 2);
                pbEvent.Top = trackSmallBarPlayPosition.Top + trackSmallBarPlayPosition.Height;
                pbEvent.Visible = false;

                GraphicsPath gp = new GraphicsPath();
                gp.AddPolygon(new Point[] { 
                              new Point(0, 0),
                              new Point(2, 0),
                              new Point(2, 40),
                              new Point(0, 40)});
                trackBarPlayPosition.ThumbCustomShape = gp;
                trackBarPlayPosition.ThumbSize = 2;
                trackBarPlayPosition.Height = 40;

                gp = new GraphicsPath();
                gp.AddPolygon(new Point[] { 
                              new Point(0, 0),
                              new Point(5, 0),
                              new Point(3, 20),
                              new Point(0, 0)}); 
                //gp.AddPolygon(new Point[] { 
                //              new Point(0, 0),
                //              new Point(2, 0),
                //              new Point(2, 20),
                //              new Point(0, 20)});
                trackSmallBarPlayPosition.ThumbCustomShape = gp;
                trackSmallBarPlayPosition.ThumbSize = 2;
                trackSmallBarPlayPosition.Height = 20;

                btnSmallStopPlayback.Visible = false;
                //btnSmallNextFrame.Visible = false;
                //btnSmallPrevFrame.Visible = false;
                //btnSmallBackward.Visible = false;
                //btnSmallFastBackward.Visible = false;

                DefaultPlaybackProgressGui();

                lblActiveDisplays.Visible = m_Settings.ShowNumberOfActiveDisplays;
                lblActiveDisplay.Visible = m_Settings.ShowNumberOfActiveDisplays;
                lblHandles.Visible = false;

                if (m_Settings.HiveState == HiveState.On)
                {
                    lblHiveState.Visible = true;
                    lblHiveState.Text = "Disconnected From Hive";
                    lblHiveState.BackColor = Color.Red;

                    m_HiveStateStatus = HiveStateStatus.Waiting;

                    UnhookWindowsHookEx(_hookID);

                    Audit("Hive State Is 'On'. The F Keys Are Disabled", sMethod, AuditSeverity.Important);
                }
                else
                {
                    lblHiveState.Visible = false;
                }

                btnUndo.Visible = false;
                btnRedo.Visible = false;

                btnUndo.Enabled = false;
                btnRedo.Enabled = false;

                btnDigitalZoom.Visible = false;
                btnTreeSelectionMode.Visible = false;

                btnAddPreset.Visible = true;
                btnUpdatePreset.Visible = false;
                btnRemovePreset.Visible = true;

                mnuAuditHide.Enabled = true;
                mnuAuditShow.Enabled = false;

                mnuHideErrorMessage.Enabled = true;
                mnuShowErrorMessage.Enabled = false;              
                
                m_WorkMode = WorkMode.Operation;
                mnuDisplayTemplates.Enabled = false;

                gbCurrentPreset.Visible = false;

                stMain.Visible = !m_Settings.HideStatusBar;

                m_SurroundingFrame = new DisplaySurroundingFrame();

                #endregion                

                #region Create Image List

                iProgressCounter++;
                StartupProgress("Create Image List (" + iProgressCounter + ")");

                il = new ImageList();

                #endregion               

                #region Build Display Controls

                iProgressCounter++;
                StartupProgress("Build Display Controls (" + iProgressCounter + ")");

                if (m_Settings.MaxDisplaysNumber == 0)
                {
                    MessageBox.Show("No Displays Defined. 'Maximum Displays Number' Property Must Be Other Than 0.", 
                                    "Error", 
                                    MessageBoxButtons.OK, 
                                    MessageBoxIcon.Error);

                    return;
                }

                DvrClientFormSize();
                
                m_DisplayInfo = new DisplayInfo(m_Settings.MaxDisplaysNumber,
                                                (m_Settings.HideTree & m_Settings.HidePtzButtons) ? 20 : 250,
                                                80,
                                                0,
                                                0,
                                                3,    //  Gap
                                                2,    //  Pen Width
                                                DisplayState.None);
                m_iStartX = m_DisplayInfo.StartX;

                if (BuildDisplayControls())
                {
                    Audit("Building " + m_Settings.MaxDisplaysNumber + " Display Controls.",
                          sMethod,
                          AuditSeverity.Information);
                }

                #endregion

                #region Initialize History

                StartupProgress("Initialize History (" + iProgressCounter + ")");

                m_History = new History();
                if (m_History.Pointer == 0)
                {
                    btnUndo.Enabled = false;
                }

                #endregion                

                #region Databases

                StartupProgress("Databases (" + iProgressCounter + ")");

                Audit("Dvr Client Database Connection String[" + m_Settings.ConnectionString + "]", 
                      sMethod, 
                      AuditSeverity.Information);
                dbRc = OpenConnection();
                Audit("Connecting Dvr Client Database ... " + Utils.GetEnumDescription(dbRc), sMethod, AuditSeverity.Important);

                if (dbRc == DbReturnCode.FinishedOK)
                {
                    DvrClientDbConnected = true;
                }
                else
                {
                    DvrClientDbConnected = false;

                    sMessage = "Failed Connecting To Dvr Client Database";
                    Audit(sMessage, sMethod, AuditSeverity.Warning);
                    Utils.Error(sMessage);
                }

                //Audit("Pulse Database Connection String[" + m_Settings.PulseDatabaseConnectionString + "]",
                //      sMethod,
                //      AuditSeverity.Information);
                //dbRc = OpenConnectionToPulseDatabase();
                //Audit("Connecting Pulse Database ... " + Utils.GetEnumDescription(dbRc), sMethod, AuditSeverity.Important);

                //if (dbRc == DbReturnCode.FinishedOK)
                //{
                //    PulseDbConnected = true;
                //}
                //else
                //{
                //    PulseDbConnected = false;

                //    sMessage = "Failed Connecting To Pulse Database";
                //    Audit(sMessage, sMethod, AuditSeverity.Warning);
                //    Utils.Error(sMessage);
                //}

                //BuildDvrClientDatabaseTemplate();
                //GetVersion(out sVersion, out sResult);
                //if (sVersion != Application.ProductVersion)
                //{
                //    Audit("Database Version Is '" + sVersion + 
                //          "'. Application Version Is '" + Application.ProductVersion + 
                //          "'. Migration Needed.", 
                //          sMethod, 
                //          AuditSeverity.Important);

                //    GetDatabaseStructure();
                //    CheckDvrClientTablesExistence();
                //}
                //else
                //{
                //    Audit("Database Version Is '" + sVersion + "'. No Need For Migration.", 
                //          sMethod, 
                //          AuditSeverity.Information);
                //}
                
                //if (m_Settings.EnablePulseEvents)
                //{
                //    if (!PulseDbConnected)
                //    {
                //        bPulseAlarmsActive = false;
                //    }
                //    else
                //    {
                //        if (!EventManagerAlarmTableExists(out sError))
                //        {
                //            bPulseAlarmsActive = false;

                //            sMessage = "Can't Reach 'EM_ALARM_CAMERAS' Table On Pulse Database";
                //            Audit(sMessage, sMethod, AuditSeverity.Error);
                //            Utils.Error(sMessage);
                //        }
                //        else
                //        {
                //            bPulseAlarmsActive = true;

                //            sMessage = "Reached 'EM_ALARM_CAMERAS' Table On Pulse Database";
                //            Audit(sMessage, sMethod, AuditSeverity.Information);

                //            PulseDbConnected = true;                            
                //        }
                //    }
                //}
                //else
                //{
                //    bPulseAlarmsActive = false;
                //}

                #endregion

                #region Read Pre Defined Views & Main Views

                StartupProgress("Read Pre Defined Views & Main Views (" + iProgressCounter + ")");

                m_PreDefinedView = new List<PreDefinedView>();
                m_MainView = new List<PreDefinedView>();

                try
                {
                    GetPreDefinedViews(out sResult, ViewType.PredefinedView);
                    Audit("Read Pre Defined Views: " + sResult, sMethod, AuditSeverity.Information);
                }
                catch (Exception ex)
                {
                    Audit("Failed Reading Pre Defined Views. " + ex.Message, sMethod, AuditSeverity.Error);
                }

                try
                {
                    GetPreDefinedViews(out sResult, ViewType.MainView);
                    Audit("Read Main Views: " + sResult, sMethod, AuditSeverity.Information);
                }
                catch (Exception ex)
                {
                    Audit("Failed Read Main Views. " + ex.Message, sMethod, AuditSeverity.Warning);
                }

                #endregion

                #region Form Position

                StartupProgress("Form Position (" + iProgressCounter + ")");

                Left = m_Settings.MainFormLeft;
                Top = m_Settings.MainFormTop;
                Audit("Control Position. Left[" + Left + "] Top[" + Top + "]", sMethod, AuditSeverity.Information);

                if (m_Settings.HideMenu)
                {
                    mnu.Visible = false;
                    Audit("Hide Main Menu", sMethod, AuditSeverity.Information);
                }
                else
                {
                    mnu.Visible = true;
                    Audit("Show Main Menu", sMethod, AuditSeverity.Information);
                }

                #endregion

                #region Main Menu 'Exit' Display

                StartupProgress("Main Menu 'Exit' Display (" + iProgressCounter + ")");

                if (m_Settings.Mode == ActivationMode.Control)
                {
                    mnuExit.Visible = false;
                    Audit("Hide 'Exit'", sMethod, AuditSeverity.Information);
                }
                else
                {
                    if (m_Settings.ShowExit)
                    {
                        mnuExit.Visible = true;
                        Audit("Show 'Exit'", sMethod, AuditSeverity.Information);
                    }
                    else
                    {
                        mnuExit.Visible = false;
                        Audit("Hide 'Exit'", sMethod, AuditSeverity.Information);
                    }
                }

                #endregion

                #region Main Menu 'Tools' Display

                StartupProgress("Main Menu 'Tools' Display (" + iProgressCounter + ")");

                if (m_Settings.ShowTools)
                {
                    mnuTools.Visible = true;
                    Audit("Show 'Tools'", sMethod, AuditSeverity.Information);
                }
                else
                {
                    mnuTools.Visible = false;
                    Audit("Hide 'Tools'", sMethod, AuditSeverity.Information);
                }

                #endregion

                #region Layouts Menu 'Fallback' Display

                iProgressCounter++;
                StartupProgress("Layouts Menu 'Fallback' Display (" + iProgressCounter + ")");

                if (m_Settings.EnableFallback)
                {
                    mnuFallback.Visible = true;
                    Audit("Show 'Fallback'", sMethod, AuditSeverity.Information);
                }
                else
                {
                    mnuFallback.Visible = false;
                    Audit("Hide 'Fallback'", sMethod, AuditSeverity.Information);
                }

                #endregion

                #region Layouts Menu Display

                iProgressCounter++;
                StartupProgress("Layouts Menu Display (" + iProgressCounter + ")");

                if (m_Settings.ShowLayoutsMenu)
                {
                    mnuLayouts.Visible = true;
                    Audit("Show 'Layouts'", sMethod, AuditSeverity.Information);
                }
                else
                {
                    mnuLayouts.Visible = false;
                    Audit("Hide 'Layouts'", sMethod, AuditSeverity.Information);
                }

                #endregion

                #region PTZ / PLAYBACK

                iProgressCounter++;
                StartupProgress("Initialize PTZ/Playback Panel Visibility (" + iProgressCounter + ")");

                gbPTZ.Visible = false;
                gbPlayback.Visible = false;
                gbSmallPlayback.Visible = false;
                gbPresets.Visible = false;
                gbCurrentPreset.Visible = false;

                if (m_Settings.HideTree)
                {
                    tv.Visible = false;
                }
                CamerasTreeHeight(m_DisplayInfo.D1_Hight);

                m_Settings.HidePtzButtons = true;
                if (m_Settings.HidePtzButtons)
                {
                    gbPTZ.Visible = false;
                    gbPlayback.Visible = false;
                }

                if (m_Settings.PanSpeed > 0)
                {
                    Audit("PTZ Pan Speed Is " + m_Settings.PanSpeed,
                          sMethod,
                          AuditSeverity.Information);
                }
                else
                {
                    m_Settings.PanSpeed = 3;
                    Audit("PTZ Pan Speed Property Is Set To 0. Value Was Changed To " + m_Settings.PanSpeed,
                          sMethod,
                          AuditSeverity.Warning);                    
                }

                if (m_Settings.TiltSpeed > 0)
                {
                    Audit("PTZ Tilt Speed Is " + m_Settings.TiltSpeed,
                          sMethod,
                          AuditSeverity.Information);
                }
                else
                {
                    m_Settings.TiltSpeed = 3;
                    Audit("PTZ Tilt Speed Property Is Set To 0. Value Was Changed To " + m_Settings.TiltSpeed,
                          sMethod,
                          AuditSeverity.Warning);
                }

                if (m_Settings.ZoomInSpeed > 0)
                {
                    Audit("PTZ Zoom In Speed Is " + m_Settings.ZoomInSpeed,
                          sMethod,
                          AuditSeverity.Information);
                }
                else
                {
                    m_Settings.ZoomInSpeed = 3;
                    Audit("PTZ Zoom In Speed Property Is Set To 0. Value Was Changed To " + m_Settings.ZoomInSpeed,
                          sMethod,
                          AuditSeverity.Warning);
                }

                if (m_Settings.ZoomOutSpeed > 0)
                {
                    Audit("PTZ Zoom Out Speed Is " + m_Settings.ZoomOutSpeed,
                          sMethod,
                          AuditSeverity.Information);
                }
                else
                {
                    m_Settings.ZoomOutSpeed = 3;
                    Audit("PTZ Zoom Out Speed Property Is Set To 0. Value Was Changed To " + m_Settings.ZoomOutSpeed,
                          sMethod,
                          AuditSeverity.Warning);
                }

                #endregion

                #region Keep Alive Interval

                StartupProgress("Keep Alive Interval (" + iProgressCounter + ")");

                if (m_Settings.KeepaliveInterval <= 0)
                {
                    Audit("Problematic Keep Alive Interval Value [" + 
                          m_Settings.KeepaliveInterval + 
                          "] Seconds. Value Changed To 5 Seconds.",
                          sMethod,
                          AuditSeverity.Information);
                    m_Settings.KeepaliveInterval = 5;
                }

                Audit("Keep Alive Interval Value [" + m_Settings.KeepaliveInterval + "] Seconds.", 
                      sMethod,
                      AuditSeverity.Important);
                Audit("Listener Server Sleep In Milliseconds Value [" + m_Settings.ServerSleepInMilliseconds + "].", 
                      sMethod, 
                      AuditSeverity.Important);

                #endregion

                #region Create Server Thread

                iProgressCounter++;
                StartupProgress("Create Server Thread (" + iProgressCounter + ")");

                m_PulseListenerThreadData = new ServerThreadData();
                Audit("Creating Server Thread", sMethod, AuditSeverity.Important);

                #endregion

                #region Initialize Vendor Plugin

                iProgressCounter++;
                StartupProgress("Initialize " + Utils.GetVendorPluginName() + " (" + iProgressCounter + ")");

                try
                {
                    tv.Nodes.Add("Waiting ...");

                    if ((m_VendorDvrRecord != null) && (m_VendorDvrRecord.Count > 0))
                    {
                        m_Loader = new VendorLoader();
                        m_Loader.LoginSucceeded += new EventHandler(Loader_LoginSucceeded);
                        m_Loader.LoginFailed += new EventHandler(Loader_LoginFailed);
                        m_Loader.LoaderMessage += new EventHandler(Loader_LoaderMessage);
                        m_Loader.LoaderError += new EventHandler(Loader_LoaderError);

                        Audit("Initialize " + Utils.GetVendorPluginName(), sMethod, AuditSeverity.Important);

                        List<LoginParameters> lLoginParameters = new List<LoginParameters>();

                        for (int i = 0; i < m_VendorDvrRecord.Count; i++)
                        {
                            LoginParameters loginParameters = new LoginParameters(m_VendorDvrRecord[i]);
                            lLoginParameters.Add(loginParameters);
                        }

                        m_Loader.Login(lLoginParameters);
                    }
                    else
                    {
                        Audit("No Dvr " + Utils.GetVendorPluginName() + " Records", sMethod, AuditSeverity.Warning);
                    }
                }
                catch (Exception e)
                {
                    Audit("Failed Initializing " + Utils.GetVendorPluginName() + ". " + e.Message, sMethod, AuditSeverity.Error); 
                }

                #endregion

                #region Initialize Display Manager

                iProgressCounter++;
                StartupProgress("Initialize Display Manager (" + iProgressCounter + ")");

                m_DisplayManager = new DisplayManager(m_Settings.MaxDisplaysNumber);
                DisplayManager_ResetDisplays(m_Settings.MaxDisplaysNumber);
                DisplayManager_SetMode(DisplayFormatState.OneView);
                DisplayManager_SetSelectedDisplayModeOn(false);
                DisplayManager_SetVeteran(DvrClientConstants.NONE);                

                if (m_bFixedLayout)
                {
                    int iNumberOfDisplaysInLayout = Utils.GetNumberOfDisplaysInLayout(m_Settings.FixedLayout);
                    if (iNumberOfDisplaysInLayout > m_Settings.MaxDisplaysNumber)
                    {
                        m_bFixedLayout = false;
                        Audit("Fixed Layout '" + Utils.GetEnumDescription(m_Settings.FixedLayout) + 
                              "' Does Not Fit Into Maximum Displays Number " + m_Settings.MaxDisplaysNumber + 
                              ". Fixed Layout Mode Canceled.", 
                              sMethod, 
                              AuditSeverity.Warning);
                        dfsInitialLayout = DisplayFormatState.OneView;
                    }
                    else
                    {
                        Audit("Fixed Layout Mode. Fixed Layout Is " + Utils.GetEnumDescription(m_Settings.FixedLayout),
                              sMethod,
                              AuditSeverity.Information);
                        dfsInitialLayout = m_Settings.FixedLayout;
                        DisplayManager_SetMode(dfsInitialLayout);
                        m_bSpecialLayoutsMode = true;
                    }
                }
                else
                {
                    Audit("No Fixed Layout", sMethod, AuditSeverity.Information);
                    dfsInitialLayout = DisplayFormatState.OneView;
                }
                ChangeDisplayMode(dfsInitialLayout);

                NoVideoPictureOnEmptyDisplays();
                Audit("Initialize Display Manager", sMethod, AuditSeverity.Information);

                #endregion

                #region Initialize Display Indexes

                iProgressCounter++;
                StartupProgress("Initialize Display Indexes (" + iProgressCounter + ")");

                DisplayManager_SetActiveDisplayIndex(DvrClientConstants.NONE);
                m_iExportCounter = 0;
                m_NotSelectedOpenDisplayIndex = new List<int>();

                #endregion

                #region Initialize Multi Timer

                StartupProgress("Initialize Multi Timer (" + iProgressCounter + ")");

                m_MultiTimer = new MultiTimer();
                tmrMultiTimer.Interval = DvrClientConstants.SECONDS;
                tmrMultiTimer.Enabled = true;

                #endregion                           

                #region Initialize Tour Engine

                StartupProgress("Initialize Tour Engine (" + iProgressCounter + ")");

                m_TourEngine = new Engine.Engine();
                m_TourEngine.FireCommand += m_TourEngine_FireCommand;

                #endregion 

                #region Language

                iProgressCounter++;
                StartupProgress("Language (" + iProgressCounter + ")");

                switch (m_Settings.Language)
                {
                    case Language.English:
                        English();
                        break;

                    case Language.Hebrew:
                        Hebrew();
                        break;

                    default:
                        break;
                }
                Audit("Language Is '" + m_Settings.Language.ToString() + "'", sMethod, AuditSeverity.Information);

                #endregion              

                #region Read Tree Nodes Names

                iProgressCounter++;
                StartupProgress("Read Tree Nodes Names (" + iProgressCounter + ")");

                GetTreeNodesNames(out sResult);
                Audit("Read Tree Nodes Names: " + sResult, sMethod, AuditSeverity.Information);

                #endregion

                #region Read DVRs On Nodes

                iProgressCounter++;
                StartupProgress("Read DVRs On Nodes (" + iProgressCounter + ")");

                GetDvrsOnTreeNodes(out sResult);
                Audit("Read DVRs On Nodes: " + sResult, sMethod, AuditSeverity.Information);

                #endregion

                #region Read DVR Records

                iProgressCounter++;
                StartupProgress("Read DVR Records (" + iProgressCounter + ")");

                m_DvrRecord = GetDvrRecords(out sResult);
                if (m_DvrRecord == null)
                {
                    Audit("Read DVR Records: " + sResult, sMethod, AuditSeverity.Warning);
                }
                else 
                {
                    Audit("Got " + m_DvrRecord.Count + " DVR Records", sMethod, AuditSeverity.Important);
                }

                #endregion

                #region Set List Of Dvrs And Cameras In Audit Form

                iProgressCounter++;
                StartupProgress("Set List Of Dvrs And Cameras In Audit Form (" + iProgressCounter + ")");

                if (m_Settings.Audit)
                {
                    if (m_Log != null)
                    {
                        m_Log.SetDvrsAndCamerasInfo(m_DvrsAndCameras);
                    }
                }

                #endregion

                #region Start Export Thread

                //iProgressCounter++;
                //StartupProgress("Start Export Thread (" + iProgressCounter + ")");

                //StartExportThread();

                #endregion

                #region Start Pre Defined Views

                iProgressCounter++;
                StartupProgress("Start Pre Defined Views (" + iProgressCounter + ")");

                if (m_Settings.ActivePreDefinedView != null)
                {
                    if (m_Settings.ActivePreDefinedView.Trim() != "")
                    {
                        Audit("Activating Pre Defined View[" + m_Settings.ActivePreDefinedView + "]", 
                              sMethod,
                              AuditSeverity.Information);
                        if (StartPreDefinedView(m_Settings.ActivePreDefinedView))
                        {
                            Audit("Succeeded Activating Pre Defined View[" + m_Settings.ActivePreDefinedView + "]", 
                                  sMethod,
                                  AuditSeverity.Information);
                        }
                    }

                    if (DisplayManager_ActiveDisplays() > 0)
                    {
                        DisplayManager_SetActiveDisplayIndex(0);
                    }
                }

                #endregion

                #region Read PTZ / Presets

                iProgressCounter++;
                StartupProgress("Read PTZ / Presets (" + iProgressCounter + ")");
             
                GetPtzPreset(out sResult);
                Audit("Read PTZ / Presets: " + sResult, sMethod, AuditSeverity.Information);                

                #endregion

                #region Start Scheduler Timer

                iProgressCounter++;
                StartupProgress("Start Scheduler Timer (" + iProgressCounter + ")");

                sortByDate = new StopPlaybackEntryComparerByDate();

                m_SchedulerTasks = new SchedulerList();
                m_SchedulerTasks.SchedulerEntry = new List<StopPlaybackEntry>();

                tmrScheduler.Interval = DvrClientConstants.SECONDS;
                tmrScheduler.Enabled = true;
                Audit("Start Scheduler Timer", sMethod, AuditSeverity.Information);

                #endregion

                #region Start Loggers Keepalive

                StartupProgress("Start Loggers Keepalive (" + iProgressCounter + ")");

                m_LoggerConectivity = new List<LoggerConectivity>();

                tmrLoggersConectivity.Interval = DvrClientConstants.SECONDS;
                tmrLoggersConectivity.Enabled = true;
                Audit("Start Loggers Keepalive Timer. " +
                      (tmrLoggersConectivity.Interval / DvrClientConstants.SECONDS) + " Seconds Frequency.", 
                      sMethod,
                      AuditSeverity.Information);

                #endregion

                #region Start Full Screen Timer

                StartupProgress("Start Full Screen Timer (" + iProgressCounter + ")");

                tmrFullScreen.Interval = DvrClientConstants.SECONDS / 2;
                tmrFullScreen.Enabled = true;

                if (m_Settings.StartInFullScreenMode == true)
                {
                    Audit("Starting In Full Screen Mode", sMethod, AuditSeverity.Information);

                    triFullScreen = Trinar.True;
                    m_bKeyPressed = true;
                    m_bStopF11Activity = true;
                }
                else
                {
                    Audit("Not Starting In Full Screen Mode", sMethod, AuditSeverity.Information);

                    triFullScreen = Trinar.Idle;
                }

                #endregion

                #region Pulse Alarms Tree

                iProgressCounter++;
                StartupProgress("Pulse Alarms Tree (" + iProgressCounter + ")");

                //if (m_Settings.EnablePulseEvents)
                //{
                //    if (bPulseAlarmsActive)
                //    {
                //        m_Settings.Log = m_Log;
                //        m_Settings.Main = this;
                //        m_PulseAlarmsTree = new frmAlarms(m_Settings.ProjectName, this, m_Settings.Language);
                //        m_PulseAlarmsTree.Show();

                //        if (m_PulseAlarmsTree != null)
                //        {
                //            if (m_Settings.ShowEventsTreeOnStartup)
                //            {
                //                m_bHidePulseEventsTree = false;
                //                m_PulseAlarmsTree.Visible = true;
                //            }
                //            else
                //            {
                //                m_bHidePulseEventsTree = true;
                //                m_PulseAlarmsTree.Visible = false;
                //            }
                //        }
                //    }
                //}
                //else 
                //{
                //    Audit("Pulse Database Events Disabled. Events Tree Is Not Displayed.", 
                //          sMethod, 
                //          AuditSeverity.Important);
                //}

                if (m_Settings.UseAlarmsQueue)
                {
                    if (m_Settings.GapBetweenAlarmsInMiliSeconds > 0)
                    {
                        tmrActivateAlarm.Interval = m_Settings.GapBetweenAlarmsInMiliSeconds;
                    }
                    tmrActivateAlarm.Enabled = false;

                    m_PulseAlarmQ = new AdvancedQ(m_Settings.AlarmsQLimitSize);
                    m_PulseAlarmQ.AlarmArrived += new EventHandler(PulseAlarmQ_AlarmArrived_Handler);
                    Audit("Pulse Alarms Queue Initialized With Limit=" + m_Settings.AlarmsQLimitSize +
                          "Gap Between Alarms " + m_Settings.GapBetweenAlarmsInMiliSeconds + " Mili Secondes",
                          sMethod,
                          AuditSeverity.Information); 
                }

                #endregion

                #region Read Pulse Database Alarm Commands

                //iProgressCounter++;
                //StartupProgress("Read Pulse Database Alarm Commands (" + iProgressCounter + ")");

                //if (m_Settings.EnablePulseEvents)
                //{
                //    if (bPulseAlarmsActive)
                //    {
                //        if (!GetAllPulseDatabaseAlarmCommands(out sError))
                //        {
                //            m_PulseAlarmsTree.Visible = false;
                //            m_bHidePulseEventsTree = true;
                //            m_PulseAlarmsTree.Dispose();

                //            Audit("Failed Getting Pulse Database Alarm Commands. " + sError + ". Pulse Events Tree Displosed.",
                //                  sMethod,
                //                  AuditSeverity.Error);
                //            Utils.Error("Can't Load Pulse Events Tree. Database Problem.");
                //        }
                //        else
                //        {
                //            Audit(m_PulseAlarm.Count + " Events Fetched From Pulse Database", sMethod, AuditSeverity.Information);
                //            try
                //            {
                //                m_PulseAlarmsTree.RefreshTree(m_PulseAlarm);
                //                bPulseAlarmsTreeRefresh = true;
                //            }
                //            catch (Exception ex)
                //            {
                //                m_PulseAlarmsTree.Visible = false;
                //                m_bHidePulseEventsTree = true;
                //                m_PulseAlarmsTree.Dispose();

                //                Audit(ex.Message + ". Pulse Events Tree Displosed.", sMethod, AuditSeverity.Information);
                //                Utils.Error("Can't Load Pulse Events Tree. Refresh Tree Problem.");

                //                bPulseAlarmsTreeRefresh = false;
                //            }

                //            if (bPulseAlarmsTreeRefresh)
                //            {
                //                if (m_Settings.RefreshEventTreeTimeInterval > 0)
                //                {
                //                    Audit("Event Tree Refresh Every " + m_Settings.RefreshEventTreeTimeInterval + " Seconds",
                //                          sMethod,
                //                          AuditSeverity.Information);
                //                }
                //                else
                //                {
                //                    Audit("No Event Tree Refresh Time Interval Was Set. Default Was Set To 600 Seconds",
                //                          sMethod,
                //                          AuditSeverity.Warning);

                //                    m_Settings.RefreshEventTreeTimeInterval = 600;
                //                }

                //                tmrEventTreeRefresh.Interval = m_Settings.RefreshEventTreeTimeInterval * DvrClientConstants.SECONDS;
                //                tmrEventTreeRefresh.Enabled = true;
                //            }
                //        }
                //    }
                //}
                //else
                //{
                //    Audit("Pulse Database Events Disabled. Pulse Database Events Not Fetched..",
                //          sMethod,
                //          AuditSeverity.Important);
                //}

                #endregion                

                #region Start Threads

                iProgressCounter++;
                StartupProgress("Start Threads (" + iProgressCounter + ")");

                //  start NICE loggers keepalive thread   
                if (StartLoggersKeepaliveThread())
                {
                    Audit("Start Loggers Keepalive Thread Succeeded", sMethod, AuditSeverity.Information);
                }
                else
                {
                    Audit("Start Loggers Keepalive Thread Failed", sMethod, AuditSeverity.Error);
                }

                if (StartDvrProxyServers())
                {
                    Audit("Start Pulse Listener Server And Dvr Hive Listener Server Threads Succeeded",
                          sMethod,
                          AuditSeverity.Important);

                    if (m_Settings.ShowLocalHostIPAddress)
                    {
                        if (m_Settings.Language == Language.English)
                        {
                            lblIP.Text = "Host IP  " + m_PCimProxyThread.GetLocalHostIPAddress();
                        }

                        if (m_Settings.Language == Language.Hebrew)
                        {
                            lblIP.Text = m_PCimProxyThread.GetLocalHostIPAddress() + "   ";
                        }

                        Audit("Show Host IP Address", sMethod, AuditSeverity.Information);
                    }
                }
                else
                {
                    Audit("Start Pulse Listener Server And Dvr Hive Listener Server Threads Failed",
                          sMethod,
                          AuditSeverity.Error);
                }

                //if (StartWaveStoreEventsListenerThread())
                //{
                //    Audit("Start WaveStore Events Listener Thread Succeeded", sMethod, AuditSeverity.Information);
                //}
                //else
                //{
                //    Audit("Start LWaveStore Events Listener Thread Failed", sMethod, AuditSeverity.Error);
                //}                

                #endregion

                #region Main Scheduler

                StartupProgress("Main Scheduler (" + iProgressCounter + ")");

                this.FunctionFinished += new EventHandler(ReceivedFunctionFinished);               

                m_iItemId = 0;

                m_TimerQ = new List<TimerQItem>();
                m_ActivationQ = new List<TimerQItem>();

                #endregion

                //tmrHandles.Interval = 60000;
                //tmrHandles.Enabled = true;

                m_StarupProgress.Close();
                m_StarupProgress = null;

                Audit("Initialization Finished", sMethod, AuditSeverity.Important);                

                this.ParentForm.FormClosed += new FormClosedEventHandler(ParentForm_FormClosed);
                this.ParentForm.SizeChanged += new EventHandler(ParentForm_SizeChanged);

                if (!m_bPulseIsConnected)
                {
                    HideGUI();
                }

                Epilogue();
            }
            catch (Exception e)
            {
                m_StarupProgress.Close();
                m_StarupProgress = null;

                sError = "Failed to Initialize.\n" + m_sInitializationStep + ".\n" + e.Message;

                Audit(sError, sMethod, AuditSeverity.Warning);
                MessageBox.Show(sError, "Initialization Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }        

        private void StartupProgress(string sStartupProgressStep)
        {
            m_sInitializationStep = sStartupProgressStep;

            Audit(sStartupProgressStep, "Initialize", AuditSeverity.Information);
            m_StarupProgress.IncrementProgressBar(sStartupProgressStep);
        }

        private void KillStatupProgress()
        {
            m_StarupProgress.Close();
        }

        #region Run Time Testings
        
        private void Prologue()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
            }
            catch (Exception e)
            {
                Audit("Error In Prologue. " + e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void Epilogue()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {

            }
            catch (Exception e)
            {
                Audit("Error In Epilogue. " + e.Message, sMethod, AuditSeverity.Error);
            }
        } 

        #endregion

        private void ParentForm_FormClosed(object sender, FormClosedEventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                Utils.WriteToDebugView(DvrClientModule.Main.ToString(), sMethod, "Do Disconnect DVTEL");
                m_bClosing = true;

                if (m_Loader != null)
                {
                    m_Loader.ShutDown();
                }
            }
            catch (Exception ex) 
            {
                Utils.WriteToDebugView(DvrClientModule.Main.ToString(), sMethod, "Failed Disconnecting DVTEL. " + ex.Message);
            }
        }

        private void ParentForm_SizeChanged(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (m_Settings.Mode == ActivationMode.Control)
            {
                ArrangeDvrClientForm(sMethod);                
            }
        }

        private bool BuildDisplayControls()
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult; 

            #endregion

            try
            {
                ComponentResourceManager resources = new ComponentResourceManager(typeof(DvrClient));
                this.vp = new ctlVendorVideoPlayer[m_DisplayInfo.Displays];
                
                m_Picture = new PictureBox[m_DisplayInfo.Displays];
                m_VideoLoss = new PictureBox[m_DisplayInfo.Displays];
                m_Transparent = new ctlTransparent[m_DisplayInfo.Displays];
                m_lPlayerEventsHashCode = new List<int>();

                for (int i = 0; i < m_DisplayInfo.Displays; i++)
                {
                    m_Transparent[i] = new ctlTransparent();
                    m_Transparent[i].Name = "Transparent" + i + 1;
                    m_Transparent[i].Tag = i + 1;
                    m_Transparent[i].TabIndex = i;
                    m_Transparent[i].AllowDrop = true;
                    m_Transparent[i].Size = new Size(0, 0);
                    m_Transparent[i].Location = new Point(0, 0);
                    m_Transparent[i].DragEnter += new DragEventHandler(m_Transparent_DragEnter);
                    m_Transparent[i].DragDrop += new DragEventHandler(m_Transparent_DragDrop);
                    m_Transparent[i].MouseDown += new MouseEventHandler(m_Transparent_MouseDown);
                    m_Transparent[i].MouseMove += new MouseEventHandler(m_Transparent_MouseMove);
                    m_Transparent[i].MouseUp += new MouseEventHandler(m_Transparent_MouseUp);
                    m_Transparent[i].MouseLeave += new EventHandler(m_Transparent_MouseLeave);
                    m_Transparent[i].MouseDoubleClick += new MouseEventHandler(m_Transparent_MouseDoubleClick);
                    m_Transparent[i].MouseEnter += new EventHandler(m_Transparent_MouseEnter);
                    m_Transparent[i].Paint += new PaintEventHandler(m_Transparent_Paint);
                    this.Controls.Add(this.m_Transparent[i]);

                    DoEvents();
                }

                for (int i = 0; i < m_DisplayInfo.Displays; i++)
                {
                    this.vp[i] = new ctlVendorVideoPlayer();
                    this.SuspendLayout();
                    // 
                    // vp
                    // 
                    this.vp[i].Enabled = true;
                    this.vp[i].Location = new System.Drawing.Point(0, 0);
                    this.vp[i].Name = "vp" + i.ToString();
                    this.vp[i].Size = new System.Drawing.Size(0, 0);
                    this.vp[i].TabIndex = i;
                    this.vp[i].SetProperties(VideoPlayerProperty.DisplayIndex, i, out sResult);
                    this.vp[i].SetProperties(VideoPlayerProperty.Osd, m_iOsdDefault, out sResult);
                    this.vp[i].PlaybackProgress += new EventHandler(vp_PlaybackProgress);
                    this.Controls.Add(this.vp[i]);
                    this.vp[i].Visible = false;

                    m_Picture[i] = new PictureBox();
                    m_Picture[i].Name = "Picture" + i + 1;
                    m_Picture[i].Tag = i + 1;
                    m_Picture[i].SizeMode = PictureBoxSizeMode.StretchImage;
                    m_Picture[i].Visible = false;
                    m_Picture[i].AllowDrop = true;
                    m_Picture[i].DragEnter += new DragEventHandler(m_Picture_DragEnter);
                    m_Picture[i].DragDrop += new DragEventHandler(m_Picture_DragDrop);
                    m_Picture[i].MouseDown += new MouseEventHandler(m_Picture_MouseDown);
                    m_Picture[i].MouseLeave += new EventHandler(m_Picture_MouseLeave);
                    this.Controls.Add(this.m_Picture[i]);

                    m_VideoLoss[i] = new PictureBox();
                    m_VideoLoss[i].Name = "VideoLossPicture" + i + 1;
                    m_VideoLoss[i].SizeMode = PictureBoxSizeMode.StretchImage;
                    m_VideoLoss[i].Visible = false;
                    m_VideoLoss[i].AllowDrop = false;
                    this.Controls.Add(this.m_VideoLoss[i]);                                        

                    DoEvents();
                }

                //PictureBox pbLive = new PictureBox();
                //pbLive.Parent = m_Picture[0];
                //pbLive.Image = Afcon.DvrClient.Control.Properties.Resources.Live;
                //pbLive.SizeMode = PictureBoxSizeMode.StretchImage;
                //pbLive.Size = new System.Drawing.Size(60, 60);
                //pbLive.Location = new Point(20, 20);
                //pbLive.BackColor = Color.Transparent;
                //pbLive.BringToFront();

                //PictureBox pbLive1 = new PictureBox();
                //pbLive1.Parent = m_Transparent[0];
                //pbLive1.Image = Afcon.DvrClient.Control.Properties.Resources.Live;
                //pbLive1.SizeMode = PictureBoxSizeMode.StretchImage;
                //pbLive1.Size = new System.Drawing.Size(60, 60);
                //pbLive1.Location = new Point(20, 20);
                //pbLive1.BackColor = Color.Transparent;
                //pbLive1.BringToFront();

                //PictureBox pbLive2 = new PictureBox();
                //pbLive2.Parent = m_VideoLoss[0];
                //pbLive2.Image = Afcon.DvrClient.Control.Properties.Resources.Live;
                //pbLive2.SizeMode = PictureBoxSizeMode.StretchImage;
                //pbLive2.Size = new System.Drawing.Size(60, 60);
                //pbLive2.Location = new Point(20, 20);
                //pbLive2.BackColor = Color.Transparent;
                //pbLive2.BringToFront();


                //PictureBox pbLive3 = new PictureBox();
                //pbLive3.Parent = vp[0];
                //pbLive3.Image = Afcon.DvrClient.Control.Properties.Resources.Live;
                //pbLive3.SizeMode = PictureBoxSizeMode.StretchImage;
                //pbLive3.Size = new System.Drawing.Size(60, 60);
                //pbLive3.Location = new Point(20, 20);
                //pbLive3.BackColor = Color.Transparent;
                //pbLive3.BringToFront();

                return true;
            }
            catch (Exception e)
            {
                Audit("Failed Building Display Controls." + e.Message, 
                      sMethod, 
                      AuditSeverity.Error);

                return false;
            }
        }

        public void DvrClientFormSize()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                Audit("Parent Form Width[" + this.ParentForm.Width +
                      "] Heigth[" + this.ParentForm.Height + "]",
                      sMethod,
                      AuditSeverity.Information);

                Audit("Control Initial Width[" + this.Width +
                      "] Heigth[" + this.Height + "]",
                      sMethod,
                      AuditSeverity.Information);

                Audit("Control Initial MaximumSize Width[" + this.MaximumSize.Width +
                      "] Heigth[" + this.MaximumSize.Height + "]",
                      sMethod,
                      AuditSeverity.Information);

                ParentForm.MaximumSize = new Size(Math.Max(Math.Max(ParentForm.Width, 
                                                                    ParentForm.MaximumSize.Width),
                                                           Screen.PrimaryScreen.Bounds.Width),
                                                  Math.Max(Math.Max(ParentForm.Height, 
                                                                    ParentForm.MaximumSize.Height),
                                                           Screen.PrimaryScreen.Bounds.Height));

                this.MaximumSize = ParentForm.MaximumSize;
                this.MinimumSize = new Size(0, 0);

                //if (this.MaximumSize.Width > ParentForm.MaximumSize.Width)
                //{
                //    this.MaximumSize = new Size(ParentForm.MaximumSize.Width, this.MaximumSize.Height);
                //}

                //if (this.MaximumSize.Height > ParentForm.MaximumSize.Height)
                //{
                //    this.MaximumSize = new Size(this.MaximumSize.Width, ParentForm.MaximumSize.Height);
                //}

                Audit("Control After Adaption MaximumSize Width[" + this.MaximumSize.Width +
                      "] Heigth[" + this.MaximumSize.Height + "]",
                      sMethod,
                      AuditSeverity.Information);

                if (ParentForm.Width < this.Width)
                {
                    this.Width = ParentForm.Width;
                }

                if (ParentForm.Height < this.Height)
                {
                    this.Height = ParentForm.Height;
                }

                Audit("Parent Form Width[" + this.ParentForm.Width +
                      "] Heigth[" + this.ParentForm.Height + "]",
                      sMethod,
                      AuditSeverity.Information);

                Audit("Control Width[" + Width + "] Heigh[" + Height + "]",
                      sMethod,
                      AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        public void ArrangeDvrClientForm(string sCalledFrom)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;

            int iWidthFromLeft = 20;
            int iWidthFromTreeToVideoZone = 20;

            int iRibbonHeight = toolStripMain.Height;
            int iStatusStripHeight = stMain.Height;

            int iHeightFromRibbon = 20;
            int iHeightFromTreeToPtzAndPlaybackGroups = 20; 

            #endregion

            try
            {
                Audit(m_Settings.Language.ToString(), sMethod, AuditSeverity.Information);

                if (m_bFullScreenMode)
                { 
                    VideoPlayersZoneHeight = Height;
                    VideoPlayersZoneWidth = Width;
                    VideoPlayersZoneLeft = 0;
                    VideoPlayersZoneTop = 0;
                }
                else
                {
                    switch (m_Settings.Language)
                    {
                        case Language.English:
                            #region English

                        Audit("Hide Tree[" + m_Settings.HideTree + "]", sMethod, AuditSeverity.Information);

                        if (!m_Settings.HideTree)
                        {
                            VideoPlayersZoneWidth = 3 * (this.Width - (2 * iWidthFromLeft)) / 4;
                            VideoPlayersZoneHeight = (this.Height -
                                                      (mnu.Height +
                                                      iRibbonHeight +
                                                      iHeightFromRibbon +
                                                      iStatusStripHeight +
                                                      iHeightFromTreeToPtzAndPlaybackGroups +
                                                      Math.Max(gbPresets.Height, gbSmallPlayback.Height) +
                                                      iWidthFromLeft));

                            VideoPlayersZoneLeft = iWidthFromLeft + VideoPlayersZoneWidth / 3;
                            VideoPlayersZoneTop = iRibbonHeight + iHeightFromRibbon + mnu.Height;

                            tv.Left = iWidthFromLeft;
                            tv.Top = VideoPlayersZoneTop;
                            CamerasTreeWidth(VideoPlayersZoneWidth / 3 - iWidthFromTreeToVideoZone);
                            CamerasTreeHeight(VideoPlayersZoneHeight);
                        }
                        else
                        {
                            VideoPlayersZoneLeft = iWidthFromLeft;
                            VideoPlayersZoneTop = iRibbonHeight + iHeightFromRibbon + mnu.Height;

                            VideoPlayersZoneWidth = (this.Width - (2 * iWidthFromLeft));
                            VideoPlayersZoneHeight = (this.Height -
                                                      (mnu.Height +
                                                      iRibbonHeight +
                                                      iStatusStripHeight +
                                                      iHeightFromRibbon +
                                                      iHeightFromTreeToPtzAndPlaybackGroups +
                                                      Math.Max(gbPresets.Height, gbSmallPlayback.Height) +
                                                      iWidthFromLeft));
                        }

                        gbPresets.Left = iWidthFromLeft;
                        gbPresets.Top = VideoPlayersZoneTop +
                                        VideoPlayersZoneHeight +
                                        iHeightFromTreeToPtzAndPlaybackGroups;                        

                        gbSmallPlayback.Left = iWidthFromLeft;
                        gbSmallPlayback.Top = VideoPlayersZoneTop +
                                              VideoPlayersZoneHeight +
                                              iHeightFromTreeToPtzAndPlaybackGroups; 

                        #endregion
                            break;

                        case Language.Hebrew:
                            #region Hebrew

                        Audit("Hide Tree[" + m_Settings.HideTree + "]", sMethod, AuditSeverity.Information);

                        if (!m_Settings.HideTree)
                        {
                            VideoPlayersZoneWidth = 3 * (this.Width - (2 * iWidthFromLeft)) / 4;
                            VideoPlayersZoneHeight = (this.Height -
                                                      (mnu.Height +
                                                      iRibbonHeight +
                                                      iStatusStripHeight +
                                                      iHeightFromRibbon +
                                                      iHeightFromTreeToPtzAndPlaybackGroups +
                                                      Math.Max(gbPresets.Height, gbSmallPlayback.Height) +
                                                      iWidthFromLeft));

                            VideoPlayersZoneLeft = iWidthFromLeft;
                            VideoPlayersZoneTop = mnu.Height + iRibbonHeight + iHeightFromRibbon;

                            tv.Left = iWidthFromLeft + VideoPlayersZoneWidth + iWidthFromTreeToVideoZone;
                            tv.Top = VideoPlayersZoneTop;
                            CamerasTreeWidth(VideoPlayersZoneWidth / 3 - iWidthFromTreeToVideoZone);
                            CamerasTreeHeight(VideoPlayersZoneHeight);
                        }
                        else
                        {
                            VideoPlayersZoneLeft = iWidthFromLeft;
                            VideoPlayersZoneTop = iRibbonHeight + iHeightFromRibbon + mnu.Height;

                            VideoPlayersZoneWidth = (this.Width - (2 * iWidthFromLeft));
                            VideoPlayersZoneHeight = (this.Height -
                                                      (mnu.Height +
                                                      iRibbonHeight +
                                                      iStatusStripHeight +
                                                      iHeightFromRibbon +
                                                      iHeightFromTreeToPtzAndPlaybackGroups +
                                                      Math.Max(gbPresets.Height, gbSmallPlayback.Height) +
                                                      iWidthFromLeft));
                        }

                        gbPresets.Left = Width - iWidthFromLeft - gbPresets.Width;
                        gbPresets.Top = VideoPlayersZoneTop + VideoPlayersZoneHeight + iHeightFromTreeToPtzAndPlaybackGroups;

                        gbSmallPlayback.Left = Width - iWidthFromLeft - gbSmallPlayback.Width;
                        gbSmallPlayback.Top = VideoPlayersZoneTop + VideoPlayersZoneHeight + iHeightFromTreeToPtzAndPlaybackGroups;

                        #endregion                                                
                            break;

                        default:
                            Audit("Wrong Language", sMethod, AuditSeverity.Warning);
                            return;
                    }
                }

                gbSmallPlayback.Width = tv.Width + iWidthFromTreeToVideoZone + VideoPlayersZoneWidth;
                trackSmallBarPlayPosition.Width = gbSmallPlayback.Width - (trackSmallBarPlayPosition.Left + iWidthFromLeft);

                stMain.Top = Height- stMain.Height;
                stMain.Width = Width;

                m_DisplayInfo.D1_Hight = VideoPlayersZoneHeight;
                m_DisplayInfo.D1_Width = VideoPlayersZoneWidth;

                m_DisplayInfo.InitialD1_Hight = VideoPlayersZoneHeight;
                m_DisplayInfo.InitialD1_Width = VideoPlayersZoneWidth;

                m_DisplayInfo.StartX = VideoPlayersZoneLeft;
                m_iStartX = VideoPlayersZoneLeft;
                m_DisplayInfo.StartY = VideoPlayersZoneTop;

                #region Report

                Audit("Called From[" + sCalledFrom + "]",
                      sMethod,
                      AuditSeverity.Information);
                Audit("Form And Video Zone Sizes And Locations",
                      sMethod,
                      AuditSeverity.Information);
                Audit("Form Size[Width:" + Width + " Height: " + Height + "]", 
                      sMethod, 
                      AuditSeverity.Information);
                Audit("VideoPlayersZone Size[Width:" + VideoPlayersZoneWidth + " Height: " + VideoPlayersZoneHeight + "]",
                      sMethod,
                      AuditSeverity.Information);
                Audit("VideoPlayersZone Location[Left:" + VideoPlayersZoneLeft + " Top: " + VideoPlayersZoneTop + "]",
                      sMethod,
                      AuditSeverity.Information);

                Audit("Cameras Tree Size[Width:" + tv.Width + " Height: " + tv.Height + "]",
                      sMethod,
                      AuditSeverity.Information);
                Audit("Cameras Tree Location[Left:" + tv.Left + " Top: " + tv.Top + "]",
                      sMethod,
                      AuditSeverity.Information);

                #endregion

                #region Display State

                switch (m_DisplayInfo.State)
                {
                    case DisplayState.One:
                        Switch2One();
                        break;

                    case DisplayState.Four:
                        Switch2Quad();
                        break;

                    case DisplayState.Nine:
                        Switch2Nine();
                        break;

                    case DisplayState.Sixteen:
                        Switch2Sixteen();
                        break;

                    case DisplayState.TwentyFive:
                        Switch2TwentyFive();
                        break;

                    case DisplayState.ThirtySix:
                        Switch2ThirtySix();
                        break;

                    case DisplayState.SixOneBig:
                        Switch2SixOneBig();
                        break;

                    case DisplayState.ThirteenSurround:
                        Switch2ThirteenSurround();
                        break;

                    case DisplayState.TenTwoQuads:
                        Switch2TenTwoQuads();
                        break;

                    case DisplayState.EightOneBig:
                        Switch2EightOneBig();
                        break;

                    case DisplayState.FiveFourUp:
                        Switch2FiveFourUp();
                        break;

                    case DisplayState.FiveFourDown:
                        Switch2FiveFourDown();
                        break;

                    case DisplayState.TwoHorizontal:
                        Switch2TwoHorizontal();
                        break;

                    case DisplayState.TwoVertical:
                        Switch2TwoVertical();
                        break;

                    case DisplayState.None:
                    default:
                        break;
                }

                NoVideoPictureOnEmptyDisplays();

                #endregion
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void ConnectedColor(Color cColor)
        {
            if (InvokeRequired)
            {
                BeginInvoke(new ConnectedColorDelegate(ConnectedColor), cColor);
            }
            else
            {
                lblConnected.ForeColor = cColor;
            }
        }

        #region Vendor Events

        private void Loader_LoginSucceeded(object sender, EventArgs e)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;
            string sNumberOfDvrs;

            object oTag;

            CameraInformation ci;

            List<int> lUserId;

            #endregion

            try
            {
                Cursor.Current = Cursors.Default;

                m_DvrInformation = m_Loader.GetTree(out sResult);

                AddPresetsToCameraInformation();

                m_LoggedInSystemDictionary = m_Loader.GetLoggedInSystemDictionary(out sResult);

                if (m_DvrInformation == null)
                {
                    sNumberOfDvrs = "No";
                }
                else
                {
                    sNumberOfDvrs = m_DvrInformation.Count.ToString();
                }

                AuditPerform("<< Loader Finished Logging In. Dvrs Tree And Dictionary Are Ready. There Are " + 
                             sNumberOfDvrs + 
                             " Dvrs >>", 
                             sMethod, 
                             AuditSeverity.Information);

                CreateTree();

                if (!FetchPatrolsAndInitializePatrolsGui(out sResult))
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);
                }

                if (m_DvrInformation == null)
                {
                    AuditPerform("No Information For The Dvrs", sMethod, AuditSeverity.Warning);

                    return;
                }

                if (m_DvrInformation.Count == 0)
                {
                    AuditPerform("No Information For The Dvrs. Zero Dvrs Fetched", sMethod, AuditSeverity.Warning);

                    return;
                }

                for (int i = 0; i < m_Settings.MaxDisplaysNumber; i++)
                {
                    if (!vp[i].Initialize(m_LoggedInSystemDictionary, out sResult))
                    {
                        AuditPerform(sResult, sMethod, AuditSeverity.Warning);
                    }
                }

                m_Alarms4Dvr = new AlarmEvents[m_DvrInformation.Count];
                for (int iDvrIndex = 0; iDvrIndex < m_DvrInformation.Count; iDvrIndex++)
                {
                    m_Alarms4Dvr[iDvrIndex] = new AlarmEvents();
                    m_Alarms4Dvr[iDvrIndex].DvrID = m_DvrInformation[iDvrIndex].DvrId;

                    if (m_DvrInformation[iDvrIndex].Camera != null)
                    {
                        m_Alarms4Dvr[iDvrIndex].CameraNumber = new int[m_DvrInformation[iDvrIndex].Camera.Count];
                        m_Alarms4Dvr[iDvrIndex].VL = new bool[m_DvrInformation[iDvrIndex].Camera.Count];
                        m_Alarms4Dvr[iDvrIndex].VMD = new bool[m_DvrInformation[iDvrIndex].Camera.Count];
                        for (int iCameraIndex = 0; iCameraIndex < m_DvrInformation[iDvrIndex].Camera.Count; iCameraIndex++)
                        {
                            m_Alarms4Dvr[iDvrIndex].CameraNumber[iCameraIndex] = m_DvrInformation[iDvrIndex].Camera[iCameraIndex].CameraNumber;
                            m_Alarms4Dvr[iDvrIndex].VL[iCameraIndex] = false;
                            m_Alarms4Dvr[iDvrIndex].VMD[iCameraIndex] = false;
                        }
                    }
                    else
	                {
                        AuditPerform("Dvr[" + m_DvrInformation[iDvrIndex].DvrId + "] Has No Cameras", sMethod, AuditSeverity.Warning);
	                }
                }

                m_AlarmsListener = new VendorPluginAlarmsListener();
                if (m_AlarmsListener.Initialize(m_LoggedInSystemDictionary, out sResult))
                {
                    m_AlarmsListener.DvrInformationList = m_DvrInformation;
                    m_AlarmsListener.AlarmsListenerEventArrived += m_AlarmsListener_AlarmsListenerEventArrived;
                    if (!m_AlarmsListener.StartStopEvent(true, out sResult))
                    {
                        AuditPerform(sResult, sMethod, AuditSeverity.Warning);
                    }
                }

                AuditPerform("Login Succeeded", sMethod, AuditSeverity.Information);

                StartExportThread();
            }
            catch (Exception ex)
            {
                AuditPerform(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void Loader_LoginFailed(object sender, EventArgs e)
        {
            #region Data Members
            
            string sError;
            string sResult;
            string sMessage;
            string sMethod = MethodBase.GetCurrentMethod().Name; 

            #endregion

            Cursor.Current = Cursors.Default;

            try
            {
                sError = (string)sender;
                sMessage = sError;

                AuditPerform(sMessage, sMethod, AuditSeverity.Warning);
                MessageBox.Show(sMessage,
                                Utils.GetVendorPluginName() + " Login Failure",
                                MessageBoxButtons.OK,
                                MessageBoxIcon.Error);
            }
            catch (Exception ex)
            {
                sMessage = "Faild To Login " + Utils.GetVendorPluginName() + " DVR IP[" + m_Settings.ViconNucleusIp +
                           "] With User[" + m_Settings.ViconUser + "]. " + ex.Message;
                AuditPerform(sMessage, sMethod, AuditSeverity.Error);
                MessageBox.Show(sMessage,
                                Utils.GetVendorPluginName() + " Login Failure",
                                MessageBoxButtons.OK,
                                MessageBoxIcon.Error);
            }
            finally
            {
                if (!FetchPatrolsAndInitializePatrolsGui(out sResult))
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);
                }
            }
        }

        private void Loader_LoaderMessage(object sender, EventArgs e)
        {
            #region Data Members

            string sMessage;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                sMessage = (string)sender;

                AuditPerform(sMessage, sMethod, AuditSeverity.Information);
            }
            catch (Exception ex)
            {
                AuditPerform(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void Loader_LoaderError(object sender, EventArgs e)
        {
            #region Data Members

            string sError;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                sError = (string)sender;

                AuditPerform(sError, sMethod, AuditSeverity.Warning);
            }
            catch (Exception ex)
            {
                AuditPerform(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void m_AlarmsListener_AlarmsListenerEventArrived(object sender, EventArgs e)
        {
            #region Data Members

            bool bSetFailed;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            ArrivedAlarmInformation aai;

            #endregion

            try
            {
                aai = (ArrivedAlarmInformation)e;
                bSetFailed = false;

                switch (aai.AlarmType)
                {
                    case DvrClientAlarmType.VideoLoss:
                        if (!SetVL(aai.DvrId, aai.CameraNumber, aai.BooleanStatus))
                        {
                            bSetFailed = true;
                        }
                        break;

                    case DvrClientAlarmType.VideoMotionDetection:
                        if (!SetVMD(aai.DvrId, aai.CameraNumber, aai.BooleanStatus))
                        {
                            bSetFailed = true;
                        }
                        break;

                    default:
                        bSetFailed = true;
                        break;
                }

                if (m_Settings.AlarmsAudit)
                {
                    if (bSetFailed)
                    {
                        AuditPerform("Failed Setting For Dvr[" + aai.DvrId +
                                     "] Camera[" + aai.CameraNumber +
                                     "] Alarm Type[" + Utils.GetEnumDescription(aai.AlarmType) +
                                     "] Value[" + aai.BooleanStatus + "]",
                                     sMethod,
                                     AuditSeverity.Warning);
                    }
                    else
                    {
                        AuditPerform("Set For Dvr[" + aai.DvrId +
                                     "] Camera[" + aai.CameraNumber +
                                     "] Alarm Type[" + Utils.GetEnumDescription(aai.AlarmType) +
                                     "] Value[" + aai.BooleanStatus + "]",
                                     sMethod,
                                     AuditSeverity.Information);
                    }
                }
            }
            catch (Exception ex)
            {
                AuditPerform(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        #endregion

        #region Vendor Stuff

        private CameraInformation GetCameraInformation(int iDvrId, int iCameraNumber, out string sResult)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            sResult = "";

            try
            {
                if (m_DvrInformation == null)
                {
                    sResult = "No Dvrs And Cameras Information";

                    return null;
                }

                for (int i = 0; i < m_DvrInformation.Count; i++)
                {
                    if (m_DvrInformation[i].DvrId == iDvrId)
                    {
                        if (m_DvrInformation[i].Camera != null)
                        {
                            for (int j = 0; j < m_DvrInformation[i].Camera.Count; j++)
                            {
                                if (m_DvrInformation[i].Camera[j].CameraNumber == iCameraNumber)
                                {
                                    return m_DvrInformation[i].Camera[j];
                                }
                            }
                        }
                    }
                }

                sResult = "No Information Found For Camera[" + iCameraNumber + "] On Dvr[" + iDvrId + "]";

                return null;
            }
            catch (Exception e)
            {
                sResult = "No Information Found For Camera[" + iCameraNumber + "] On Dvr[" + iDvrId + "]. " + e.Message;

                return null;
            }
        }

        private bool VendorGetCameraChannelIdByCameraNumber(int iCameraNumber, 
                                                            out int iCameraChannelId, 
                                                            out string sError)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            sError = "";
            iCameraChannelId = DvrClientConstants.NONE;

            try
            {
                if (m_CameraInformation == null)
                {
                    sError = "Camera Information Vector Is Null";

                    return false;
                }

                for (int i = 0; i < m_CameraInformation.Count; i++)
                {
                    CameraInformation ci = (CameraInformation)(m_CameraInformation[i]);
                    if (ci.CameraNumber == iCameraNumber)
                    {
                        iCameraChannelId = ci.Channel;

                        return true;
                    }
                }

                sError = "Video Player Index For Camera Number(" + iCameraNumber + ") Was Not Found.";

                return false;
            }
            catch (Exception e)
            {
                sError = "Failed Finding Video Player Index For Camera Number(" + iCameraNumber + "). " + e.Message;

                return false;
            }
        }        

        private string GetVideoMotionDetectionState(int iDvrId, int iCameraNumber, out string sResult)
        {
            sResult = "";

            try
            {
                return GetVMD(iDvrId, iCameraNumber).ToString();
            }
            catch (Exception e)
            {
                sResult = "Couldn't Get Video Motion Detection State For Camera[" + iCameraNumber + "]. " + e.Message;

                return "N/A";
            }
        }

        private string GetVideoLossState(int iDvrId, int iCameraNumber, out string sResult)
        {
            sResult = "";

            try
            {
                return GetVL(iDvrId, iCameraNumber).ToString();
            }
            catch (Exception e)
            {
                sResult = "Couldn't Get Video Loss State For Camera[" + iCameraNumber + "]. " + e.Message;

                return "N/A";
            }
        }

        private bool ResetVideoMotionDetection(int iDvrId, int iCameraNumber, out string sResult)
        {
            sResult = "";

            try
            {
                SetVMD(iDvrId, iCameraNumber, false);
                
                return true;
            }
            catch (Exception e)
            {
                sResult = "Couldn't Get Reset Video Motion Detection State For Camera[" + iCameraNumber + "]. " + e.Message;

                return false;
            }
        }

        private void CreateNewVendorHostsFile()
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;
            string sFileName;

            #endregion

            try
            {
                sFileName = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) + "\\" + DvrClientConstants.HOSTS_FILENAME;

                if (File.Exists(sFileName))
                {
                    File.Delete(sFileName);
                }

                m_VendorDvrRecord = new List<VendorDvrRecord>();

                if (!SaveVendorDvrRecords(out sResult))
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);
                }
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Warning);
            }
        }

        public bool SaveVendorDvrRecords(out string sResult)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sFileName;

            #endregion

            sResult = "";

            try
            {
                if (m_VendorDvrRecord == null)
                {
                    sResult = Utils.GetVendorPluginName() + " Dvrs Records List Is Null";

                    return false;
                }

                sFileName = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) + "\\" + DvrClientConstants.HOSTS_FILENAME;
                if (!Utils.WriteToXmlFile(sFileName, m_VendorDvrRecord))
                {
                    sResult = "Failed To Write " + DvrClientConstants.HOSTS_FILENAME + " Hosts To XML File";
                    Audit(sResult, sMethod, AuditSeverity.Warning);

                    return false;
                }

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message + ". " + sResult, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool GetVendorDvrRecords(out string sResult)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sFileName;

            #endregion

            sResult = "";

            try
            {
                sFileName = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) + "\\" + DvrClientConstants.HOSTS_FILENAME;
                if (File.Exists(sFileName))
                {
                    m_VendorDvrRecord = Utils.ReadFromXmlFile<List<VendorDvrRecord>>(sFileName);
                    if (m_VendorDvrRecord == null)
                    {
                        sResult = "List Of Dvr Records Is Null";

                        return false;
                    }
                }
                else
                {
                    sResult = "'" + sFileName + "' Does Not Exist";

                    return false;
                }

                return true;
            }
            catch (Exception ex)
            {
                Audit(ex.Message + ". " + sResult, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool AddVendorDvrRecord(int iDvrNumber,
                                       string sIpAddress,
                                       string sUsername,
                                       string sPassword,
                                       out string sResult)
        {
            #region Data Members

            int iIndex;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            sResult = "";

            try
            {
                if (m_VendorDvrRecord == null)
                {
                    sResult = "Dvrs Records List Is Null";

                    return false;
                }

                bool bRc = VendorDvrRecordExists(iDvrNumber, sIpAddress, sUsername, out sResult);
                if (bRc)
                {
                    Audit("Can't Insert Dvr Number[" + iDvrNumber +
                          "] IP[" + sIpAddress +
                          "] Username[" + sUsername +
                          "]. " + sResult,
                          sMethod,
                          AuditSeverity.Warning);

                    return false;
                }

                if (m_VendorDvrRecord.Count == 0)
                {
                    iIndex = 1;
                }
                else
                {
                    iIndex = GetVendorDvrIndex();
                }

                m_VendorDvrRecord.Add(new VendorDvrRecord(iIndex, iDvrNumber, sIpAddress, 8000, sUsername, sPassword));

                if (!SaveVendorDvrRecords(out sResult))
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);

                    return false;
                }

                return true;
            }
            catch (Exception e)
            {
                sResult = e.Message;

                return false;
            }
        }

        public bool UpdateVendorDvrRecord(int iIndex,
                                          int iDvrNumber,
                                          string sIpAddress,
                                          string sUsername,
                                          string sPassword,
                                          out string sResult)
        {
            #region Data Members
            
            int iRow;

            string sMethod = MethodBase.GetCurrentMethod().Name; 

            #endregion
            
            sResult = "";

            try
            {
                bool bRc = VendorDvrRecordExistsByDvrNumberExceptIndex(iIndex, iDvrNumber, out sResult);
                if (bRc)
                {
                    Audit("Can't Update Dvr Number[" + iDvrNumber +
                          "] IP[" + sIpAddress +
                          "] Username[" + sUsername +
                          "]. " + sResult,
                          sMethod,
                          AuditSeverity.Warning);

                    return false;
                }

                iRow = FindVendorDvrRecordRow(iIndex, out sResult);
                if (iRow != DvrClientConstants.NONE)
                {
                    m_VendorDvrRecord[iRow].DvrNumber = iDvrNumber;
                    m_VendorDvrRecord[iRow].Username = sUsername;
                    m_VendorDvrRecord[iRow].Password = sPassword;
                    m_VendorDvrRecord[iRow].IpAddress = sIpAddress;

                    if (!SaveVendorDvrRecords(out sResult))
                    {
                        Audit(sResult, sMethod, AuditSeverity.Warning);

                        return false;
                    }

                    return true;
                }
                else
                {
                    Audit("Row With Index[" + iIndex + "] Does Not Exist. " + sResult, sMethod, AuditSeverity.Warning);

                    return false;
                }
            }
            catch (Exception e)
            {
                sResult = e.Message;
                
                return false;
            }
        }

        public bool DeleteVendorDvrRecord(int iIndex, out string sResult)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            sResult = "";

            try
            {
                for (int i = 0; i < m_WaveStoreDvrRecord.Count; i++)
                {
                    if (m_WaveStoreDvrRecord[i].Index == iIndex)
                    {
                        m_WaveStoreDvrRecord.RemoveAt(i);

                        if (!SaveVendorDvrRecords(out sResult))
                        {
                            Audit(sResult, sMethod, AuditSeverity.Warning);

                            return false;
                        }

                        return true;
                    }
                }

                sResult = "Couldn't Find Record With Index[" + iIndex + "]";
                Audit(sResult, sMethod, AuditSeverity.Error);

                return false;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool DeleteAllVendorDvrRecord(out string sResult)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            sResult = "";

            try
            {
                m_VendorDvrRecord.Clear();

                if (!SaveVendorDvrRecords(out sResult))
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);

                    return false;
                }

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private int FindVendorDvrRecordRow(int iIndex, out string sResult)
        {
            sResult = "";

            try
            {
                if (m_VendorDvrRecord == null)
                {
                    sResult = "Dvrs List Is Null";

                    return DvrClientConstants.NONE;
                }

                for (int i = 0; i < m_VendorDvrRecord.Count; i++)
                {
                    if (m_VendorDvrRecord[i].Index == iIndex)
                    {
                        return i;
                    }
                }

                sResult = "Dvrs List Is Empty";

                return DvrClientConstants.NONE;
            }
            catch (Exception e)
            {
                sResult = e.Message;

                return DvrClientConstants.NONE;
            }
        }

        public bool VendorDvrRecordExists(int iDvrNumber, string sIpAddress, string sUsername, out string sResult)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            sResult = "";

            try
            {
                if (m_VendorDvrRecord == null)
                {
                    sResult = Utils.GetVendorPluginName() + " Dvrs List Is Empty";

                    return false;
                }

                for (int i = 0; i < m_VendorDvrRecord.Count; i++)
                {
                    if ((m_VendorDvrRecord[i].IpAddress == sIpAddress) && (m_VendorDvrRecord[i].Username == sUsername))
                    {
                        return true;
                    }

                    if (m_VendorDvrRecord[i].DvrNumber == iDvrNumber)
                    {
                        sResult = "Recored With Same DVR Number Exists. IP[" + m_VendorDvrRecord[i].IpAddress +
                                  "] Username[" + m_VendorDvrRecord[i].Username + "]";

                        return true;
                    }
                }

                sResult = Utils.GetVendorPluginName() + " Dvr With IP[ " + sIpAddress + "] And Username[" + sUsername + "] Was Not Found";

                return false;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool VendorDvrRecordExistsByDvrNumber(int iDvrNumber, out string sResult)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            sResult = "";

            try
            {
                if (m_VendorDvrRecord == null)
                {
                    sResult = Utils.GetVendorPluginName() + " Dvrs List Is Empty";

                    return false;
                }

                for (int i = 0; i < m_VendorDvrRecord.Count; i++)
                {
                    if (m_VendorDvrRecord[i].DvrNumber == iDvrNumber)
                    {
                        return true;
                    }
                }

                sResult = Utils.GetVendorPluginName() + " Dvr Number " + iDvrNumber + " Was Not Found";

                return false;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool VendorDvrRecordExistsByDvrNumberExceptIndex(int iIndex, int iDvrNumber, out string sResult)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            sResult = "";

            try
            {
                if (m_VendorDvrRecord == null)
                {
                    sResult = Utils.GetVendorPluginName() + " Dvrs List Is Empty";

                    return false;
                }

                for (int i = 0; i < m_VendorDvrRecord.Count; i++)
                {
                    if (m_VendorDvrRecord[i].DvrNumber == iDvrNumber)
                    {
                        if (m_VendorDvrRecord[i].Index != iIndex)
                        {
                            return true;
                        }
                    }
                }

                sResult = Utils.GetVendorPluginName() + " Dvr With ID " + iDvrNumber + " Was Not Found";

                return false;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool Wipe(int iDvrId, int iCameraNumber, bool bValue)
        {
            #region Data Members
            
            string sResult;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            sResult = "";

            try
            {
                LiveVideoParameters liveVideoParameters = new LiveVideoParameters();
                liveVideoParameters.Camera.Channel = GetChannelID(iDvrId, iCameraNumber);
                liveVideoParameters.Camera.DvrId = iDvrId;

                // find display
                //if (!vp[0].Wiper(liveVideoParameters, bValue, out sResult))
                //{
                //    Audit(sResult, sMethod, AuditSeverity.Warning);

                //    return false;
                //}

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        #endregion

        #region Display Manager

        public DisplayManager DisplayManager_GetDisplayManager()
        {
            return m_DisplayManager;
        }

        #region Display Get

        private bool DisplayManager_DisplayIsPlaying(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).IsPlaying;
            }

            return false;
        }

        private CameraInformation DisplayManager_GetCamera(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).Camera;
            }

            return null;
        }

        private Vendor DisplayManager_DisplayVendorName(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).Camera.Vendor;
            }

            return Vendor.Unknown;
        }

        private string DisplayManager_DisplaySiteName(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).Camera.SiteName;
            }

            return "";
        }

        private int DisplayManager_DisplayDvrGroupId(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).Camera.DvrGroupId;
            }

            return DvrClientConstants.NONE;
        }

        private int DisplayManager_DisplayDvrId(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return (m_DisplayManager.Display(iIndex).Camera == null) ? DvrClientConstants.NONE : m_DisplayManager.Display(iIndex).Camera.DvrId;
            }

            return DvrClientConstants.NONE;
        }

        private string DisplayManager_DisplayPreset(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).Preset;
            }

            return "";
        }

        private string DisplayManager_DisplayCameraName(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                if (m_DisplayManager.Display(iIndex).Camera != null)
                {
                    return m_DisplayManager.Display(iIndex).Camera.Name;
                }
            }

            return "";
        }

        private int DisplayManager_DisplayCameraNumber(int iIndex)
        {
            CameraInformation ciCameraInformation;

            if (iIndex != DvrClientConstants.NONE)
            {
                ciCameraInformation = DisplayManager_GetCamera(iIndex);

                return ((ciCameraInformation == null) ? DvrClientConstants.NONE : ciCameraInformation.CameraNumber);
            }

            return DvrClientConstants.NONE;
        }

        private int DisplayManager_DisplayChannelID(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).Camera.Channel;
            }

            return DvrClientConstants.NONE;
        }

        private int DisplayManager_DisplayColorNumber(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).ColorNumber;
            }

            return DvrClientConstants.NONE;
        }

        private int DisplayManager_DisplayNumber(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).DisplayNumber;
            }

            return DvrClientConstants.NONE;
        }

        private bool DisplayManager_DisplayIsFree(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).IsFree;
            }

            return false;
        }

        private bool DisplayManager_DisplayIsPtz(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                if (m_DisplayManager.Display(iIndex).Camera != null)
                {
                    return m_DisplayManager.Display(iIndex).Camera.IsPtz;
                }
            }

            return false;
        }

        private bool DisplayManager_DisplayDigitalZoomMode(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).InDigitalZoomMode;
            }

            return false;
        }

        private bool DisplayManager_DisplayOpenedWithIndex(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).OpenedWithIndex;
            }

            return false;
        }

        private DateTime DisplayManager_DisplayStartDateTime(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).StartDateTime;
            }

            return new DateTime(2000, 1, 1, 0, 0 ,0);
        }

        private DateTime DisplayManager_DisplayPlaybackStart(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).PlaybackStart;
            }

            return new DateTime(2000, 1, 1, 0, 0, 0);
        }

        private DateTime DisplayManager_DisplayTriggerCreationTime(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).TriggerCreation;
            }

            return new DateTime(2000, 1, 1, 0, 0, 0);
        }

        private string DisplayManager_DisplayTriggerSource(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).TriggerSource;
            }

            return "";
        }

        private int DisplayManager_DisplayPlaybackDuration(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).PlaybackDuration;
            }

            return DvrClientConstants.NONE;
        }

        private int DisplayManager_DisplayInitiatingAlarm(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).InitiatingAlarm;
            }

            return DvrClientConstants.NONE;
        }

        private int DisplayManager_DisplayFreeTextHandle(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).FreeTextHandle;
            }

            return DvrClientConstants.NONE;
        }

        private ActivationType DisplayManager_DisplayActivation(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).Activation;
            }

            return ActivationType.NotActive;
        }

        private string DisplayManager_DisplayEventString(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).EventString;
            }

            return "";
        }

        private CameraOpenType DisplayManager_DisplayOpenType(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).OpenType;
            }

            return CameraOpenType.Unknown;
        }

        private DvrAction DisplayManager_GetDvrAction(int iIndex)
        {
            if (iIndex != DvrClientConstants.NONE)
            {
                return m_DisplayManager.Display(iIndex).DvrAction;
            }

            return DvrAction.Unknown;
        }

        #endregion

        #region Display Set

        private void DisplayManager_SetCamera(int index, CameraInformation ciCameraInformation)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetCamera(index, ciCameraInformation);
            }
        }

        private void DisplayManager_SetPreset(int index, string sPreset)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetPreset(index, sPreset);
            }
        }

        public void DisplayManager_SetStartDateTime(int index, DateTime dtStartDateTime)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetStartDateTime(index, dtStartDateTime);
            }
        }

        public void DisplayManager_SetInitiatingAlarm(int index, int iInitiatingAlarm)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetInitiatingAlarm(index, iInitiatingAlarm);
            }
        }

        public void DisplayManager_SetCameraOpenType(int index, CameraOpenType cotCameraOpenType)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetCameraOpenType(index, cotCameraOpenType);
            }
        }

        public void DisplayManager_SetEventString(int index, string sEventString)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetEventString(index, sEventString);
            }
        }

        public void DisplayManager_SetOpenedWithIndex(int index, bool bOpenedWithIndex)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetOpenedWithIndex(index, bOpenedWithIndex);
            }
        }

        public void DisplayManager_SetIsPtzCamera(int index, bool bIsPtzCamera)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetIsPtzCamera(index, bIsPtzCamera);
            }
        }

        public void DisplayManager_SetDigitalZoomMode(int index, bool bInDigitalZoomMode)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetDigitalZoomMode(index, bInDigitalZoomMode);
            }
        }

        private void DisplayManager_SetDisplayPlaybackFinised(int index, bool bValue)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetDisplayPlaybackFinised(index, bValue);
            }
        }

        private void DisplayManager_SetDisplayPlaybackStart(int index, DateTime dPlaybackStart)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetDisplayPlaybackStart(index, dPlaybackStart);
            }
        }

        private void DisplayManager_SetDisplayPlaybackDuration(int index, int lDuration)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetDisplayPlaybackDuration(index, lDuration);
            }
        }

        private void DisplayManager_SetDisplayFreeTextHandle(int index, int iFreeTextHandle)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetDisplayFreeTextHandle(index, iFreeTextHandle);
            }
        }

        private void DisplayManager_SetDisplayTriggerCreationTime(int iIndex, DateTime dtTriggerCreationTime)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetTriggerCreationTime(iIndex, dtTriggerCreationTime);
            }
        }

        private void DisplayManager_SetDisplayTriggerSource(int iIndex, string sTriggerSource)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetTriggerSource(iIndex, sTriggerSource);
            }
        }

        private void DisplayManager_SetDvrAction(int iIndex, DvrAction dvrAction)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetDvrAction(iIndex, dvrAction);
            }
        }

        #endregion

        #region Veteran

        private void DisplayManager_SetVeteran(int iIndex)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.Veteran = iIndex;
            }
        }

        private void DisplayManager_SetVeteran()
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetVeteran();
            }
        }

        public int DisplayManager_GetVeteran()
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.Veteran;
            }

            return DvrClientConstants.NONE;
        }

        #endregion

        #region Selected Display

        private void DisplayManager_SetSelectedDisplayIndex(int iSelectedDisplayIndex)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SelectedDisplayIndex = iSelectedDisplayIndex;
            }
        }

        public bool DisplayManager_GetSelectedDisplayModeOn()
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.SelectedDisplayModeOn;
            }

            return false;
        }

        public int DisplayManager_GetSelectedDisplayIndex()
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.SelectedDisplayIndex;
            }

            return DvrClientConstants.NONE;
        }

        private Point DisplayManager_GetSelectedDisplayLocation()
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.SelectedDisplayLocation;
            }

            return new Point(0, 0);
        }

        private Size DisplayManager_GetSelectedDisplaySize()
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.SelectedDisplaySize;
            }

            return new Size(0, 0);
        }

        private void DisplayManager_SetSelectedDisplayLocation(Point pointSelectedDisplayLocation)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SelectedDisplayLocation = pointSelectedDisplayLocation;
            }
        }

        private void DisplayManager_SetSelectedDisplaySize(Size sizeSelectedDisplaySize)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SelectedDisplaySize = sizeSelectedDisplaySize;
            }
        }

        #endregion

        #region Find Display

        public int DisplayManager_FindIndex(string sSiteName,
                                            int iCameraNumber,
                                            ActivationType atActivationType)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.FindIndex(sSiteName,
                                                  iCameraNumber,
                                                  atActivationType);
            }

            return DvrClientConstants.NONE;
        }

        public int DisplayManager_FindIndex(int iDvrId,
                                            int iCameraNumber,
                                            ActivationType atActivationType)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.FindIndex(iDvrId,
                                                  iCameraNumber,
                                                  atActivationType);
            }

            return DvrClientConstants.NONE;
        }

        public int DisplayManager_FindIndex(int iCameraNumber,
                                            ActivationType atActivationType)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.FindIndex(iCameraNumber,
                                                  atActivationType);
            }

            return DvrClientConstants.NONE;
        }

        public int DisplayManager_FindIndexByDisplay(string sSiteName,
                                                     int iCameraNumber,
                                                     int iDisplay,
                                                     ActivationType atActivationType)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.FindIndexByDisplay(sSiteName, iCameraNumber, iDisplay, atActivationType);
            }

            return DvrClientConstants.NONE;
        }

        public int DisplayManager_FindIndexByDisplay(int iDvrId,
                                                     int iCameraNumber,
                                                     int iDisplay,
                                                     ActivationType atActivationType)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.FindIndexByDisplay(iDvrId, iCameraNumber, iDisplay, atActivationType);
            }

            return DvrClientConstants.NONE;
        }

        public int DisplayManager_FindIndexByDisplay(int iCameraNumber,
                                                     int iDisplay,
                                                     ActivationType atActivationType)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.FindIndexByDisplay(iCameraNumber, iDisplay, atActivationType);
            }

            return DvrClientConstants.NONE;
        }

        public int DisplayManager_FindDisplayByCameraNumber(string sSiteName, int iCameraNumber)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.FindDisplayByCameraNumber(sSiteName, iCameraNumber);
            }

            return DvrClientConstants.NONE;
        }

        public int DisplayManager_FindDisplayByCamera(int iDvrId, int iDvrGroupId, int iCameraNumber)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.FindDisplayByCamera(iDvrId, iDvrGroupId, iCameraNumber);
            }

            return DvrClientConstants.NONE;
        }

        public int DisplayManager_FindDisplayByCamera(int iDvrId, int iCameraNumber)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.FindDisplayByCamera(iDvrId, iCameraNumber);
            }

            return DvrClientConstants.NONE;
        }

        private int DisplayManager_FindFreeDisplay(int iLowestIndex, int iHighestIndex)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.FindFreeDisplay(iLowestIndex, iHighestIndex);
            }

            return DvrClientConstants.NONE;
        }

        private int DisplayManager_FindFreeDisplay()
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.FindFreeDisplay();
            }

            return DvrClientConstants.NONE;
        }

        private int DisplayManager_FindFreeDisplay(int iHighestIndex)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.FindFreeDisplay(iHighestIndex);
            }

            return DvrClientConstants.NONE;
        }

        private int DisplayManager_FindHighestDisplayNumber()
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.FindHighestDisplayNumber();
            }

            return DvrClientConstants.NONE;
        }

        #endregion

        #region Active Displays

        private int DisplayManager_ActiveDisplays()
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.ActiveDisplays;
            }

            return DvrClientConstants.NONE;
        }

        private string DisplayManager_IncrementActiveDisplaysCounter()
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.IncrementActiveDisplaysCounter();
            }

            return "";
        }

        private string DisplayManager_DecrementActiveDisplaysCounter()
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.DecrementActiveDisplaysCounter();
            }

            return "";
        }

        public int DisplayManager_GetActiveDisplayIndex()
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.ActiveDisplayIndex;
            }

            return DvrClientConstants.NONE;
        }

        public void DisplayManager_SetActiveDisplayIndex(int iActiveDisplayIndex)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.ActiveDisplayIndex = iActiveDisplayIndex;
                lblActiveDisplay.Text = "Active Display " + (m_DisplayManager.ActiveDisplayIndex + 1).ToString();
            }
        }

        #endregion

        private void DisplayManager_SetMode(DisplayFormatState dfs)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetMode(dfs);
            }
        }

        public DisplayFormatState DisplayManager_GetMode()
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.Mode;
            }

            return DisplayFormatState.Unknown;
        }

        public bool DisplayManager_GetLayoutMode(string sLayout, out DisplayFormatState dfsLayout)
        {
            try
            {
                dfsLayout = m_DisplayManager.GetLayoutMode(sLayout);

                return true;
            }
            catch (Exception)
            {
                dfsLayout = DisplayFormatState.Unknown;

                return false; ;
            }
        }    

        private void DisplayManager_ResetDisplays(int iNumberOfDisplays)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.ResetDisplays(iNumberOfDisplays);
            }
        }

        private void DisplayManager_SetSelectedDisplayModeOn(bool bSelectedDisplayModeOn)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SelectedDisplayModeOn = bSelectedDisplayModeOn;
            }
        }

        private int DisplayManager_Displays()
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.Displays();
            }

            return DvrClientConstants.NONE;
        }

        private bool DisplayManager_IsCameraOpen(int iCameraNumber,
                                                 out int iDisplay,
                                                 out bool bOpenedWithIndex)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.IsCameraOpen(iCameraNumber,
                                                     out iDisplay,
                                                     out bOpenedWithIndex);
            }

            iDisplay = DvrClientConstants.NONE;
            bOpenedWithIndex = false;

            return false;
        }

        private bool DisplayManager_IsCameraOpen(int iDvrId,
                                                 int iCameraNumber,
                                                 out int iDisplay,
                                                 out bool bOpenedWithIndex)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.IsCameraOpen(iDvrId,
                                                     iCameraNumber,
                                                     out iDisplay,
                                                     out bOpenedWithIndex);
            }

            iDisplay = DvrClientConstants.NONE;
            bOpenedWithIndex = false;

            return false;
        }

        private bool DisplayManager_IsCameraOpen(int iDvrGroupId,
                                                 int iDvrId,
                                                 int iCameraNumber,
                                                 out int iDisplay,
                                                 out bool bOpenedWithIndex)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.IsCameraOpen(iDvrGroupId,
                                                     iDvrId,
                                                     iCameraNumber,
                                                     out iDisplay,
                                                     out bOpenedWithIndex);
            }

            iDisplay = DvrClientConstants.NONE;
            bOpenedWithIndex = false;

            return false;
        }

        private bool DisplayManager_IsCameraOpen(CameraInformation ciCameraInformation,
                                                 out int iDisplay,
                                                 out bool bOpenedWithIndex)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.IsCameraOpen(ciCameraInformation,
                                                     out iDisplay,
                                                     out bOpenedWithIndex);
            }

            iDisplay = DvrClientConstants.NONE;
            bOpenedWithIndex = false;

            return false;
        }

        private void DisplayManager_SetSingleDisplay(int index,
                                                     Vendor vVendorName,
                                                     string sSiteName,
                                                     string sCameraName,
                                                     int iCameraNumber,
                                                     int iChannelID,
                                                     int iColorNumber,
                                                     int iDisplayNumber,
                                                     bool bIsFree,
                                                     bool bIsPtz,
                                                     bool bOpenedWithIndex,
                                                     DateTime dStartDateTime,                                                     
                                                     ActivationType atActivation,
                                                     string sEventString)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetSingleDisplay(index,
                                                  vVendorName,
                                                  sSiteName,
                                                  sCameraName,
                                                  iCameraNumber,
                                                  iChannelID,
                                                  iColorNumber,
                                                  iDisplayNumber,
                                                  bIsFree,
                                                  bIsPtz,
                                                  bOpenedWithIndex,
                                                  dStartDateTime,                                                  
                                                  atActivation,
                                                  sEventString);
            }
        }

        private void DisplayManager_SetSingleDisplay(int index,
                                                     Vendor vVendorName,
                                                     int iDvrId,
                                                     int iCameraNumber,
                                                     string sCameraName,
                                                     int iColorNumber,
                                                     int iDisplayNumber,
                                                     bool bIsFree,
                                                     bool bIsPtz,
                                                     bool bOpenedWithIndex,
                                                     DateTime dStartDateTime,
                                                     ActivationType atActivation,
                                                     string sEventString)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetSingleDisplay(index,
                                                  vVendorName,
                                                  iDvrId,
                                                  iCameraNumber,
                                                  sCameraName,
                                                  iColorNumber,
                                                  iDisplayNumber,
                                                  bIsFree,
                                                  bIsPtz,
                                                  bOpenedWithIndex,
                                                  dStartDateTime,
                                                  atActivation,
                                                  sEventString);
            }
        }

        private void DisplayManager_SetSingleDisplay(int index,
                                                     CameraInformation ciCameraInformation,
                                                     int iColorNumber,
                                                     int iDisplayNumber,
                                                     bool bIsFree,
                                                     bool bOpenedWithIndex,
                                                     DateTime dStartDateTime,
                                                     ActivationType atActivation,
                                                     string sEventString)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetSingleDisplay(index,
                                                  ciCameraInformation,
                                                  iColorNumber,
                                                  iDisplayNumber,
                                                  bIsFree,
                                                  bOpenedWithIndex,
                                                  dStartDateTime,
                                                  atActivation,
                                                  sEventString);
            }
        }

        private void DisplayManager_SetDisplayDvrGroupId(int index, int iDvrGroupId)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.SetDisplayDvrGroupId(index, iDvrGroupId);
            }
        }

        private void DisplayManager_ResetSingleDisplay(int index)
        {
            if (m_DisplayManager != null)
            {
                m_DisplayManager.ResetSingleDisplay(index);
            }
        }

        private DisplayWindow DisplayManager_Display(int iDisplay)
        {
            return m_DisplayManager.Display(iDisplay);           
        }

        private bool DisplayManager_IsFreeDisplayInCurrentMode()
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.IsFreeDisplayInCurrentMode();
            }

            return false;
        }

        private DisplayFormatState DisplayManager_BestFitLayoutMode(int iRealDisplay)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.BestFitLayoutMode(iRealDisplay);
            }

            return DisplayFormatState.Unknown;
        }

        private int DisplayManager_RealDisplayNumber(int iDisplayIndex)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.RealDisplayNumber(iDisplayIndex);
            }

            return DvrClientConstants.NONE;
        }

        private DisplayFormatState DisplayManager_FindOptimalNormalLayout(int iNumberOfActiveDisplays)
        {
            if (m_DisplayManager != null)
            {
                return m_DisplayManager.FindOptimalNormalLayout(iNumberOfActiveDisplays);
            }

            return DisplayFormatState.Unknown;
        }

        public bool GetDisplayAndTransparentCoverSizeAndLocation(int iDisplayIndex, 
                                                                 out Point trnsLocation,
                                                                 out Size trnsSize,
                                                                 out Point vpLocation,
                                                                 out Size vpSize)
        {
            try
            {
                trnsLocation = m_Transparent[iDisplayIndex].Location;
                vpLocation = vp[iDisplayIndex].Location;

                trnsSize = m_Transparent[iDisplayIndex].Size;
                vpSize = vp[iDisplayIndex].Size;

                return true;
            }
            catch (Exception)
            {
                trnsLocation = new Point(0, 0);
                vpLocation = new Point(0, 0);

                trnsSize = new Size(0, 0);
                vpSize = new Size(0, 0);

                return false;
            }
        }

        #endregion

        #region Video Player Size & Location

        private void VendorVideoPlayerSize(int iIndex, int iWidth, int iHeight)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                vp[iIndex].Size = new System.Drawing.Size(iWidth, iHeight);
                m_Transparent[iIndex].Size = new System.Drawing.Size(iWidth, iHeight);
            }
            catch (Exception e)
            {
                Audit("Failed For Index[" + iIndex + "] Width[" + iWidth + "] Height[" + iHeight + "]. " + 
                      e.Message, 
                      sMethod, 
                      AuditSeverity.Error);
            }
        }

        private void VendorVideoPlayerLocation(int iIndex, int iX, int iY)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                vp[iIndex].Location = new System.Drawing.Point(iX, iY);
                m_Transparent[iIndex].Location = new System.Drawing.Point(iX, iY);
            }
            catch (Exception e)
            {
                Audit("Failed For Index[" + iIndex + "] X[" + iX + "] Y[" + iY + "]. " +
                      e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        private Size VendorVideoPlayerSize(int iIndex)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                return vp[iIndex].Size;
            }
            catch (Exception e)
            {
                Audit("Failed For Index[" + iIndex + "]. " +
                      e.Message,
                      sMethod,
                      AuditSeverity.Error);

                return new System.Drawing.Size(0, 0);
            }
        }

        private Point VendorVideoPlayerLocation(int iIndex)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                return vp[iIndex].Location;
            }
            catch (Exception e)
            {
                Audit("Failed For Index[" + iIndex + "]. " +
                      e.Message,
                      sMethod,
                      AuditSeverity.Error);

                return new Point(0, 0);
            }
        }

        #endregion

        #region Threads

        private bool StartDvrProxyServers()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {                
                #region Pulse Listener

                switch (m_Settings.DvrClientViaPulseState)
                { 
                    case ViaPulseState.Server:
                        m_PulseListenerThreadData.Main = this;
                        m_PulseListenerThreadData.ListenerAddressIndex = m_Settings.ListenerAddressIndex;
                        m_PulseListenerThreadData.ListenerPort = m_Settings.ListenerPort;
                        m_PulseListenerThreadData.KeepaliveInterval = m_Settings.KeepaliveInterval;
                        m_PulseListenerThreadData.ImportProjectName = m_Settings.ImportProjectName;
                        m_PulseListenerThreadData.ServerSleepInMilliseconds = m_Settings.ServerSleepInMilliseconds;
                        m_PulseListenerThreadData.Type = ListenerType.PulseListener; 
                        break;

                    case ViaPulseState.Client:
                        m_PulseClientThreadData = new ClientThreadData();

                        m_PulseClientThreadData.Main = this;
                        m_PulseClientThreadData.PulsePort = m_Settings.PulsePort;
                        m_PulseClientThreadData.PulsePlc = m_Settings.PulsePlc;
                        m_PulseClientThreadData.PulseTcpAddress = m_Settings.PulseIpAddress;
                        m_PulseClientThreadData.PulseTcpPort = m_Settings.PulseIpPort;
                        m_PulseClientThreadData.KeepaliveInterval = m_Settings.KeepaliveInterval;
                        m_PulseClientThreadData.PulseTcpPort = m_Settings.PulseIpPort;
                        break;

                    default:
                        break;
                }

                m_PCimProxyThread = new PCimProxy(this);
                m_PCimProxyThread.ConnectedToPulse += m_PCimProxyThread_ConnectedToPulse;
                m_PCimProxyThread.DisconnectedFromPulse += m_PCimProxyThread_DisconnectedFromPulse;
                m_PCimProxyThread.Message += m_PCimProxyThread_Message;

                switch (m_Settings.DvrClientViaPulseState)
                {
                    case ViaPulseState.Client:
                        m_PulseListenerThread = new Thread(m_PCimProxyThread.tTcpClient);
                        m_PulseListenerThread.IsBackground = true;
                        m_PulseListenerThread.Name = "Pulse Dvr Client";
                        m_PulseListenerThread.Start(m_PulseClientThreadData);
                        break;

                    case ViaPulseState.Server:
                        m_PulseListenerThread = new Thread(m_PCimProxyThread.tTcpServer);
                        m_PulseListenerThread.IsBackground = true;
                        m_PulseListenerThread.Name = "Pulse Listener";
                        m_PulseListenerThread.Start(m_PulseListenerThreadData);
                        break;
                    
                    default:
                        Audit("Via Pulse State Is Unknown", sMethod, AuditSeverity.Warning);
                        return false;
                }
                
                Audit("Pulse Listener Thread Started", sMethod, AuditSeverity.Information); 

                #endregion

                #region Dvr Hive Listener

                if (m_Settings.HiveState == HiveState.On)
                {
                    m_DvrHiveServerThreadData.ListenerPort = m_Settings.DvrHiveListenerPort;
                    m_DvrHiveServerThreadData.Main = this;

                    m_DvrHiveServerThreadData.KeepaliveInterval = m_Settings.KeepaliveInterval;
                    m_DvrHiveServerThreadData.ImportProjectName = m_Settings.ImportProjectName;
                    m_DvrHiveServerThreadData.ServerSleepInMilliseconds = m_Settings.ServerSleepInMilliseconds;
                    m_DvrHiveServerThreadData.Type = ListenerType.DvrHiveListener;

                    m_DvrHiveProxyThread = new PCimProxy(this);
                    m_DvrHiveServerThread = new Thread(m_DvrHiveProxyThread.tTcpServer);
                    m_DvrHiveServerThread.IsBackground = true;
                    m_DvrHiveServerThread.Name = "DVR Hive Listener";
                    m_DvrHiveServerThread.Start(m_DvrHiveServerThreadData);

                    Audit("DVR Hive Listener Thread Started", sMethod, AuditSeverity.Information); 
                }

                #endregion

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private void m_PCimProxyThread_Message(object sender, EventArgs e)
        {
            string sMessage = (string)sender;

            MessageBox.Show(sMessage, "Pulse Connection Error");

            mnuSettings_Click(null, null);
        }

        private void m_PCimProxyThread_ConnectedToPulse(object sender, EventArgs e)
        {
            UnhideGUI();
        }

        private void m_PCimProxyThread_DisconnectedFromPulse(object sender, EventArgs e)
        {
            HideGUI();
        }

        private bool StartLoggersKeepaliveThread()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                m_LoggersKeepaliveThreadData = new LoggersKeepaliveThreadData();

                m_LoggersKeepaliveThreadData.Loggers = m_sLoggers;
                m_LoggersKeepaliveThreadData.Main = this;
                m_LoggersKeepaliveThreadData.TimeoutInSeconds = 1;

                m_LoggersKeepaliveThread = new LoggersKeepalive(this);
                m_NiceLoggersKeepaliveThread = new Thread(m_LoggersKeepaliveThread.tStart);
                m_NiceLoggersKeepaliveThread.IsBackground = true;
                m_NiceLoggersKeepaliveThread.Name = "Loggers Keepalive";
                m_NiceLoggersKeepaliveThread.Start(m_LoggersKeepaliveThreadData);

                Audit("Loggers Keepalive Thread Started", sMethod, AuditSeverity.Information);

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false; ;
            }
        }

        private void EndThreadsAndTimers()
        {
            #region Data Members

            int i = 0;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sMessage;

            bool bFinishedOK = true;

            AuditSeverity aSeverity; 

            #endregion

            Utils.WriteToDebugView(DvrClientModule.Main.ToString(), 
                                   sMethod, 
                                   "Ending Threads And Timers ...", 
                                   AuditSeverity.Important.ToString()); 

            KillAllTimers();

            #region Close Sound Thread

            if (m_Settings.SoundsOn)
            {
                Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       "Closing The Sounds Thread ...",
                                       AuditSeverity.Important.ToString());

                if (m_SoundThreadObject != null)
                {
                    m_SoundThreadObject.StopThread = true;
                }
            }

            #endregion

            #region Close Alarms Listener Threads

            try
            {
                Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       "Closing The Alarms Listener Threads",
                                       AuditSeverity.Important.ToString());

                if (m_AlarmsListenerThread != null)
                {
                    for (i = 0; i < m_AlarmsListenerThread.Length; i++)
                    {
                        if (m_AlarmsListenerThread[i] != null)
                        {
                            m_AlarmsListenerThread[i].StopAlarmsListener();
                            m_AlarmsListenerThread[i] = null;

                            sMessage = "Alarms Listener Thread " + (i + 1) + " Closed";
                            Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                                   sMethod,
                                                   sMessage,
                                                   AuditSeverity.Important.ToString());
                            Utils.WriteToEventLog("DVR Client",
                                                  "Main - " + sMethod,
                                                  sMessage,
                                                  0,
                                                  EventLogEntryType.Information);
                        }
                    } 
                }
            }
            catch (Exception e)
            {
                bFinishedOK = false;
                sMessage = "Problem Closing Alarms Listener Thread " + (i + 1) + ". " + e.Message;

                Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       sMessage,
                                       AuditSeverity.Error.ToString());
                Utils.WriteToEventLog("DVR Client",
                                      "Main - " + sMethod,
                                      sMessage,
                                      0,
                                      EventLogEntryType.Error);
            } 

            #endregion

            #region Close Pulse Listener Thread

            try
            {
                Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       "Closing The Pulse Listener Thread",
                                       AuditSeverity.Important.ToString());
                if (m_PCimProxyThread != null)
                {
                    Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       "Stop Pulse Listener Server ...",
                                       AuditSeverity.Important.ToString());
                    m_PCimProxyThread.StopServer(true, sMethod);

                    Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       "Kill Pulse Listener Server Thread",
                                       AuditSeverity.Important.ToString());
                    m_PCimProxyThread.Kill();

                    Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       "Set Null To Pulse Listener Server Thread Object",
                                       AuditSeverity.Important.ToString());
                    m_PCimProxyThread = null;

                    sMessage = "Pulse Proxy Thread Closed";
                    Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                           sMethod,
                                           sMessage,
                                           AuditSeverity.Important.ToString());
                    Utils.WriteToEventLog("DVR Client",
                                          "Main - " + sMethod,
                                          sMessage,
                                          0,
                                          EventLogEntryType.Information);
                }
                else
                {
                    Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       "Pulse Listener Server Object Is Null",
                                       AuditSeverity.Important.ToString());
                }
            }
            catch (Exception e)
            {
                bFinishedOK = false;

                sMessage = "Problem Closing The Communication Thread. " + e.Message;
                Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       sMessage,
                                       AuditSeverity.Error.ToString());
                Utils.WriteToEventLog("DVR Client",
                                      "Main - " + sMethod,
                                      sMessage,
                                      0,
                                      EventLogEntryType.Error);
            } 

            #endregion

            #region Close Dvr Hive Listener Thread

            try
            {
                Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       "Closing The Dvr Hive Listener Thread",
                                       AuditSeverity.Important.ToString());
                if (m_DvrHiveProxyThread != null)
                {
                    Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       "Stop Dvr Hive Listener Server ...",
                                       AuditSeverity.Important.ToString());
                    m_DvrHiveProxyThread.StopServer(true, sMethod);

                    Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       "Kill Dvr Hive Listener Thread",
                                       AuditSeverity.Important.ToString());
                    m_DvrHiveProxyThread.Kill();

                    Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       "Set Null To Dvr Hive Listener Thread Object",
                                       AuditSeverity.Important.ToString());
                    m_DvrHiveProxyThread = null;

                    sMessage = "Dvr Hive Listener Thread Closed";
                    Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                           sMethod,
                                           sMessage,
                                           AuditSeverity.Important.ToString());
                    Utils.WriteToEventLog("DVR Client",
                                          "Main - " + sMethod,
                                          sMessage,
                                          0,
                                          EventLogEntryType.Information);
                }
                else
                {
                    Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       "Dvr Hive Listener Server Object Is Null",
                                       AuditSeverity.Important.ToString());
                }
            }
            catch (Exception e)
            {
                bFinishedOK = false;

                sMessage = "Problem Closing The Dvr Hive Listener Thread. " + e.Message;
                Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       sMessage,
                                       AuditSeverity.Error.ToString());
                Utils.WriteToEventLog("DVR Client",
                                      "Main - " + sMethod,
                                      sMessage,
                                      0,
                                      EventLogEntryType.Error);
            }

            #endregion

            #region Close Export Thread

            try
            {
                Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       "Closing The Export Thread",
                                       AuditSeverity.Important.ToString());
                if (m_ExportThread != null)
                {
                    m_ExportThread.Stop();
                    m_ExportThread = null;

                    sMessage = "Export Thread Closed";
                    Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                           sMethod,
                                           sMessage,
                                           AuditSeverity.Important.ToString());
                    Utils.WriteToEventLog("DVR Client",
                                          "Main - " + sMethod,
                                          sMessage,
                                          0,
                                          EventLogEntryType.Information);
                }
            }
            catch (Exception e)
            {
                bFinishedOK = false;

                sMessage = "Problem Closing The Export Thread. " + e.Message;
                Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       sMessage,
                                       AuditSeverity.Error.ToString());
                Utils.WriteToEventLog("DVR Client",
                                      "Main - " + sMethod,
                                      sMessage,
                                      0,
                                      EventLogEntryType.Information);
            }

            #endregion

            #region Close Loggers Keepalive Thread

            try
            {
                Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       "Closing The Loggers Keepalive Thread",
                                       AuditSeverity.Important.ToString());
                if (m_LoggersKeepaliveThread != null)
                {
                    m_LoggersKeepaliveThread.Stop();
                    m_LoggersKeepaliveThread = null;

                    sMessage = "Loggers Keepalive Thread Closed";
                    Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                           sMethod,
                                           sMessage,
                                           AuditSeverity.Important.ToString());
                    Utils.WriteToEventLog("DVR Client",
                                          "Main - " + sMethod,
                                          sMessage,
                                          0,
                                          EventLogEntryType.Information);
                }
            }
            catch (Exception e)
            {
                bFinishedOK = false;

                sMessage = "Problem Closing The Loggers Keepalive Thread. " + e.Message;
                Utils.WriteToDebugView(DvrClientModule.Main.ToString(),
                                       sMethod,
                                       sMessage,
                                       AuditSeverity.Error.ToString());
                Utils.WriteToEventLog("DVR Client",
                                      "Main - " + sMethod,
                                      sMessage,
                                      0,
                                      EventLogEntryType.Error);
            }

            #endregion

            if (bFinishedOK)
            {
                sMessage = "Ending Threads And Timers. Finished OK";
                aSeverity = AuditSeverity.Important;
            }
            else
            {
                sMessage = "Ending Threads And Timers. Finished With Problems";
                aSeverity = AuditSeverity.Error;
            }

            Utils.WriteToDebugView(DvrClientModule.Main, 
                                   sMethod, 
                                   sMessage, 
                                   aSeverity);
        }

        private void bwBackgroundWorker_DoWork(object sender, DoWorkEventArgs e)
        {
            FillDvrsAndCamerasInformation();
        }

        private void StartExportThread()
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            ExportThreadParameters etp; 

            #endregion

            try
            {
                AuditPerform("Starting Export Thread ...", sMethod, AuditSeverity.Information);

                m_ExportThread = new Export(this);
                m_VendorExportThread = new Thread(m_ExportThread.Start);
                m_VendorExportThread.IsBackground = true;
                m_VendorExportThread.SetApartmentState(ApartmentState.STA);
                m_VendorExportThread.Name = "Export";

                if (m_Loader == null)
                {
                    AuditPerform("Export Thread Failed To Start. Loader Object Is Null.", sMethod, AuditSeverity.Warning);

                    return;
                }

                etp = new ExportThreadParameters(m_LoggedInSystemDictionary, m_Settings.ShowOpenExportDirectoryDialog);

                if (m_Loader != null)
                {
                    if (m_LoggedInSystemDictionary != null)
                    {
                        m_ExportThread.LoggedInSystem = m_LoggedInSystemDictionary;
                    }
                }

                m_VendorExportThread.Start(etp);

                AuditPerform("Export Thread Started", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                AuditPerform("Export Thread Failed To Start. " + e.Message, sMethod, AuditSeverity.Error);
            }
        }

        #endregion

        #region Tour Stuff

        private bool FetchPatrolsAndInitializePatrolsGui(out string sResult)
        {
            #region Data Member

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                if (!GetPatrols(out sResult))
                {
                    return false;
                }
                else
                {
                    if (m_Patrol != null)
                    {
                        AuditPerform("Retrieved" + m_Patrol.Count + "Patrols", sMethod, AuditSeverity.Information);
                        for (int i = 0; i < m_Patrol.Count; i++)
                        {
                            AuditPerform("Patrol " + (i + 1) + " " + m_Patrol[i].PatrolName, sMethod, AuditSeverity.Information);
                        }

                        AuditPerform("Add Patrols To Tree", sMethod, AuditSeverity.Information);
                        AddToursToTree();

                        AuditPerform("Add Patrols To Main Menu", sMethod, AuditSeverity.Information);
                        AddToursToMainMenu();

                        return true;
                    }

                    sResult = "Patrols List Is Null";

                    return false;
                }
            }
            catch (Exception e)
            {
                sResult = e.Message;
                Audit(sResult, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private void m_TourEngine_FireCommand(object sender, EventArgs e)
        {
            #region Data Member

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sCommand = (string)sender;
            string sDvr;
            string sPulseCommand;

            int iDvrId;
            int iCameraNumber = DvrClientConstants.NONE;
            int iDisplayNumber = DvrClientConstants.NONE;
            int iColor = DvrClientConstants.NONE;

            NukeCommandReplay ncr;

            CameraInformation ciCameraInformation;

            #endregion

            try
            {
                sCommand = Utils.GetNthSubString(sCommand, ":", 3);
                sDvr = Utils.GetNthSubString(sCommand, "_", 1);
                iDvrId = int.Parse(sDvr.Substring(3));

                sPulseCommand = Utils.GetNthSubString(sCommand, "_", 2);

                ncr = Utils.NukeCommand(sPulseCommand, DvrClientConstants.MONITOR_STRING, ref iCameraNumber, ref iDisplayNumber, ref iColor);

                if (!DisplayManager_DisplayIsFree(iDisplayNumber - 1))
                {
                    ciCameraInformation = DisplayManager_GetCamera(iDisplayNumber - 1);
                    ParseSyntax(ciCameraInformation.DvrId, "DVR" + ciCameraInformation.DvrId + "_MD" + iDisplayNumber.ToString() + ciCameraInformation.CameraNumber, "0.0", ActionType.Write, sMethod);
                }

                ParseSyntax(iDvrId, sPulseCommand, "1.0", ActionType.Write, sMethod);
            }
            catch (Exception ex)
            {
                AuditPerform(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        public bool AddPatrol(string sPatrolName, string sPatrolLayout, bool bIsCyclic)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            #endregion

            try
            {
                DbReturnCode dbRc = InsertPatrol(sPatrolName, sPatrolLayout, bIsCyclic);
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    Audit("Faild Inserting Patrol Record Name[" + sPatrolName +
                      "] Patrol Layout[" + sPatrolLayout +
                      "] Is Cyclic[" + bIsCyclic +
                      "]. " + Utils.GetEnumDescription(dbRc),
                      sMethod,
                      AuditSeverity.Warning);

                    return false;
                }

                if (!GetPatrols(out sResult))
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);

                    return false;
                }

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool UpdatePatrol(int iPatrolIndex, string sPatrolName, string sPatrolLayout, bool bIsCyclic)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            #endregion

            try
            {
                DbReturnCode dbRc = UpdatePatrolRecord(iPatrolIndex, sPatrolName, sPatrolLayout, bIsCyclic);
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    Audit("Faild Updateing Patrol Record Name[" + sPatrolName +
                      "] Patrol Layout[" + sPatrolLayout +
                      "] Is Cyclic[" + bIsCyclic +
                      "]. " + Utils.GetEnumDescription(dbRc),
                      sMethod,
                      AuditSeverity.Warning);

                    return false;
                }

                if (!GetPatrols(out sResult))
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);

                    return false;
                }

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool DeletePatrol(int iPatrolIndex, string sPatrolName, out string sResult)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            sResult = "";

            try
            {
                DbReturnCode dbRc = DeletePatrolRecord(iPatrolIndex);
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    sResult = "Faild Delteing Patrol Name[" + sPatrolName +
                              "]. " + Utils.GetEnumDescription(dbRc);
                    Audit(sResult,
                          sMethod,
                          AuditSeverity.Warning);

                    return false;
                }

                dbRc = DeletePatrolItemByPatrolId(iPatrolIndex);
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    sResult = "Faild Delteing Patrol Items For Patrol Name[" + sPatrolName +
                              "]. " + Utils.GetEnumDescription(dbRc);
                    Audit(sResult,
                          sMethod,
                          AuditSeverity.Warning);

                    return false;
                }

                if (!GetPatrols(out sResult))
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);

                    return false;
                }

                return true;
            }
            catch (Exception e)
            {
                sResult = e.Message;
                Audit(sResult, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public List<Patrol> GetAllPatrolsFromDatabease()
        {
            string sResult;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (!GetPatrols(out sResult))
            {
                Audit(sResult, sMethod, AuditSeverity.Warning);

                return null;
            }

            return GetAllPatrols();
        }

        public List<Patrol> GetAllPatrols()
        {
            string sResult = "";
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                return m_Patrol;
            }
            catch (Exception e)
            {
                Audit(sResult + ". " + e.Message, sMethod, AuditSeverity.Warning);

                return null;
            }
        }

        public bool AddPatrolItem(int iPatrolId,
                                  string sDvr,
                                  int iCameraNumber,
                                  int iDisplayNumber,
                                  string sPreset,
                                  int iDuration,
                                  int iSpeed)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            #endregion

            try
            {
                DbReturnCode dbRc = InsertPatrolItem(iPatrolId,
                                                     sDvr,
                                                     iCameraNumber,
                                                     iDisplayNumber,
                                                     sPreset,
                                                     iDuration,
                                                     iSpeed);
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    Audit("Faild Inserting Patrol Item Record Dvr[" + sDvr +
                      "] Camra[" + iCameraNumber +
                      "]. " + Utils.GetEnumDescription(dbRc),
                      sMethod,
                      AuditSeverity.Warning);

                    return false;
                }

                if (!GetPatrols(out sResult))
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);

                    return false;
                }

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool UpdatePatrolItem(int iPatrolItemId,
                                     int iPatrolId,
                                     string sDvr,
                                     int iCameraNumber,
                                     int iDisplayNumber,
                                     string sPreset,
                                     int iDuration,
                                     int iSpeed)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            #endregion

            try
            {
                DbReturnCode dbRc = UpdatePatrolItemRecord(iPatrolItemId,
                                                           iPatrolId,
                                                           sDvr,
                                                           iCameraNumber,
                                                           iDisplayNumber,
                                                           sPreset,
                                                           iDuration,
                                                           iSpeed);
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    Audit("Faild Inserting Patrol Item Record Dvr[" + sDvr +
                      "] Camra[" + iCameraNumber +
                      "]. " + Utils.GetEnumDescription(dbRc),
                      sMethod,
                      AuditSeverity.Warning);

                    return false;
                }

                if (!GetPatrols(out sResult))
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);

                    return false;
                }

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private void AddToursToTree()
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            TreeNode parent;

            #endregion

            try
            {
                if (InvokeRequired)
                {
                    BeginInvoke(new EmptyDelegate(AddToursToTree));
                }
                else
                {

                    #region Add root Node

                    parent = tv.Nodes.Add("Tours");
                    parent.Tag = "[Tours]";
                    parent.ImageIndex = (int)IconIndex.Ams;
                    parent.SelectedImageIndex = (int)IconIndex.Ams;

                    #endregion

                    if (m_Patrol == null)
                    {
                        Audit("No Patrols", sMethod, AuditSeverity.Warning);

                        return;
                    }

                    for (int i = 0; i < m_Patrol.Count; i++)
                    {
                        Patrol p = (Patrol)m_Patrol[i];

                        parent.Nodes.Add(p.PatrolName);

                        parent.Nodes[i].Tag = m_Patrol[i];
                        parent.Nodes[i].ImageIndex = (int)IconIndex.Logger;
                        parent.Nodes[i].SelectedImageIndex = (int)IconIndex.Logger;

                        if (p.PatrolItem != null)
                        {
                            for (int j = 0; j < p.PatrolItem.Count; j++)
                            {
                                PatrolItem pi = (PatrolItem)(p.PatrolItem[j]);
                                parent.Nodes[i].Nodes.Add("Camera - " + pi.CameraNumber + " On " + pi.SiteName);

                                parent.Nodes[i].Nodes[j].Tag = pi;
                                parent.Nodes[i].Nodes[j].ImageIndex = (int)IconIndex.Camera;
                                parent.Nodes[i].Nodes[j].SelectedImageIndex = (int)IconIndex.Camera;
                            }
                        }

                        parent.ExpandAll();
                    }
                }
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void AddToursToMainMenu()
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                if (InvokeRequired)
                {
                    BeginInvoke(new EmptyDelegate(AddToursToMainMenu));
                }
                else
                {
                    if (m_Patrol == null)
                    {
                        Audit("No Patrols", sMethod, AuditSeverity.Warning);

                        return;
                    }

                    ToolStripMenuItem[] tsmi = new ToolStripMenuItem[m_Patrol.Count + 1];
                    for (int i = 0; i < m_Patrol.Count; i++)
                    {
                        Patrol p = (Patrol)m_Patrol[i];

                        tsmi[i] = new ToolStripMenuItem();
                        tsmi[i].Text = p.PatrolName;
                        tsmi[i].Tag = p;
                        tsmi[i].Click += mnuStartPatrolFromMainMenu_Click;
                    }

                    tsmi[m_Patrol.Count] = new ToolStripMenuItem();
                    tsmi[m_Patrol.Count].Text = "Stop Patrol";
                    tsmi[m_Patrol.Count].Tag = null;
                    tsmi[m_Patrol.Count].Click += mnuStopPatrolFromMainMenu_Click;

                    mnuTours.DropDownItems.AddRange(tsmi);
                }
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private bool LoadPatrolItems(Patrol pPatrol)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            #endregion

            try
            {
                if (pPatrol == null)
                {
                    Audit("Patrol Is Null", sMethod, AuditSeverity.Warning);

                    return false;
                }

                if (pPatrol.PatrolItem == null)
                {
                    Audit("Patrol Has No Patrol Items Is Null", sMethod, AuditSeverity.Warning);

                    return false;
                }

                if (pPatrol.PatrolItem.Count == 0)
                {
                    Audit("Patrol Has No Patrol Items Is Null", sMethod, AuditSeverity.Warning);

                    return false;
                }

                m_TourEngine.Unlock();
                if (m_TourEngine.Clear(out sResult))
                {
                    for (int i = 0; i < pPatrol.PatrolItem.Count; i++)
                    {
                        int iDvrId;

                        iDvrId = GetLoggerId(pPatrol.PatrolItem[i].SiteName);
                        if (iDvrId != DvrClientConstants.NONE)
                        {
                            if (!m_TourEngine.AddTourItem(pPatrol.PatrolItem[i].Delay,
                                                            "1:1:DVR" + iDvrId +
                                                            "_M" + pPatrol.PatrolItem[i].CameraNumber +
                                                            "D" + pPatrol.PatrolItem[i].Display,
                                                            out sResult))
                            {
                                Audit("Failed To Add Tour Item. " + sResult, sMethod, AuditSeverity.Warning);
                            }
                        }
                        else
                        {
                            Audit("Could Not Find Dvr Id For Dvr IP[" + pPatrol.PatrolItem[i].SiteName + "]", sMethod, AuditSeverity.Warning);
                        }
                    }
                }
                m_TourEngine.EngineState = Engine.Engine.State.Serial;
                m_TourEngine.Lock();

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private void mnuStartPatrol_Click(object sender, EventArgs e)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            Patrol p;

            #endregion

            try
            {
                if (tv.SelectedNode == null)
                {
                    return;
                }

                p = (Patrol)(tv.SelectedNode.Tag);

                Audit("Tour[" + p.PatrolName + "]", sMethod, AuditSeverity.Information);

                lblPatrol.Text = "Patrol '" + p.PatrolName + "' RUNNING";

                LoadPatrolItems(p);
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void mnuStopPatrol_Click(object sender, EventArgs e)
        {
            mnuStopPatrolFromMainMenu_Click(null, null);
        }

        private void mnuStartPatrolFromMainMenu_Click(object sender, EventArgs e)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            Patrol p;

            #endregion

            try
            {
                p = (Patrol)(((ToolStripMenuItem)sender).Tag);

                Audit("Tour[" + p.PatrolName + "]", sMethod, AuditSeverity.Information);

                lblPatrol.Text = "Patrol '" + p.PatrolName + "' RUNNING";

                LoadPatrolItems(p);
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void mnuStopPatrolFromMainMenu_Click(object sender, EventArgs e)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            #endregion

            try
            {
                if (m_TourEngine == null)
                {
                    Audit("Tour Engine Is Null", sMethod, AuditSeverity.Warning);

                    return;
                }

                m_TourEngine.Unlock();

                if (!m_TourEngine.Clear(out sResult))
                {
                    Audit("Failed Stopping Patrol. " + sResult, sMethod, AuditSeverity.Warning);
                }
                else
                {
                    Audit("Stopped Patrol", sMethod, AuditSeverity.Information);
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
            finally
            {
                m_TourEngine.Lock();

                lblPatrol.Text = "";
            }
        }

        #endregion

        #region Display

        private void PtzGUI(bool bEnable)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            cboDvrPresets.Enabled = bEnable;

            if (m_Settings.HidePtzButtons)
            {
                bEnable = false;
                GroupBoxVisibility(gbPTZ, false);
                GroupBoxVisibility(gbPlayback, false);
            }

            ButtonVisibility(btnUp, bEnable);
            ButtonVisibility(btnDown, bEnable);
            ButtonVisibility(btnLeft, bEnable);
            ButtonVisibility(btnRight, bEnable);
            ButtonVisibility(btnZoomIn, bEnable);
            ButtonVisibility(btnZoomOut, bEnable);
            ButtonVisibility(btnUpLeft, bEnable);
            ButtonVisibility(btnUpRight, bEnable);
            ButtonVisibility(btnDownLeft, bEnable);
            ButtonVisibility(btnDownRight, bEnable);

            ButtonVisibility(btnStop, false);
        }

        private void CleanDisplay(DisplayFormatState dfs, bool bSelective)
        {
            int i;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            Audit("Cleaning The " + Utils.GetEnumDescription(dfs) + " Panel", sMethod, AuditSeverity.Information);

            if (bSelective)
            {
                switch (dfs)
                {
                    case DisplayFormatState.OneView:
                        if (DisplayManager_DisplayIsPlaying(0))
                        {
                            DoStopCamera(0);
                        }
                        break;


                    case DisplayFormatState.QuadView:
                        for (i = 1; i < 5; i++)
                        {
                            if (DisplayManager_DisplayIsPlaying(i))
                            {
                                DoStopCamera(i);
                            }
                        }
                        break;


                    case DisplayFormatState.NineView:
                        for (i = 5; i < 14; i++)
                        {
                            if (DisplayManager_DisplayIsPlaying(i))
                            {
                                DoStopCamera(i);
                            }
                        }
                        break;


                    default:
                        return;
                }
            }
            else
            {
                switch (dfs)
                {
                    case DisplayFormatState.OneView:
                        DoStopCamera(0);
                        break;


                    case DisplayFormatState.QuadView:
                        for (i = 1; i < 5; i++)
                        {
                            DoStopCamera(i);
                        }
                        break;


                    case DisplayFormatState.NineView:
                        for (i = 5; i < 14; i++)
                        {
                            DoStopCamera(i);
                        }
                        break;


                    default:
                        break;

                }
            }
        }

        private void SwapDisplays(int iDisplayIndexA, int iDisplayIndexB)
        {
            #region Data Members

            int iCameraNumberADvrGroupId;
            int iCameraNumberBDvrGroupId;
            int iCameraNumberADvrId;
            int iCameraNumberBDvrId;
            int iCameraNumberA;
            int iCameraNumberB;
            int iDurationA = 0;
            int iDurationB = 0;

            CameraInformation ciCameraInformationA;
            CameraInformation ciCameraInformationB;

            DateTime dtStartPlaybackA = new DateTime(1900, 1, 1, 0, 0, 0);
            DateTime dtStartPlaybackB = new DateTime(1900, 1, 1, 0, 0, 0);
            DateTime dtTriggerCreationTimeA = new DateTime(1900, 1, 1, 0, 0, 0);
            DateTime dtTriggerCreationTimeB = new DateTime(1900, 1, 1, 0, 0, 0);

            ActivationType atActivationTypeA;
            ActivationType atActivationTypeB;

            string sTriggerSourceA = "";
            string sTriggerSourceB = "";
            string sSiteNameA;
            string sSiteNameB;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                atActivationTypeA = DisplayManager_DisplayActivation(iDisplayIndexA);
                atActivationTypeB = DisplayManager_DisplayActivation(iDisplayIndexB);

                Audit("Swap Streams Between Display[" + (iDisplayIndexA + 1) +
                      "] Activation Type[" + Utils.GetEnumDescription(atActivationTypeA) +
                      "] And Display[" + (iDisplayIndexB + 1) +
                      "] Activation Type[" + Utils.GetEnumDescription(atActivationTypeB) + "]",
                      sMethod,
                      AuditSeverity.Information);

                iCameraNumberADvrGroupId = DisplayManager_DisplayDvrGroupId(iDisplayIndexA);
                iCameraNumberBDvrGroupId = DisplayManager_DisplayDvrGroupId(iDisplayIndexB);
                iCameraNumberADvrId = DisplayManager_DisplayDvrId(iDisplayIndexA);
                iCameraNumberBDvrId = DisplayManager_DisplayDvrId(iDisplayIndexB);
                iCameraNumberA = DisplayManager_DisplayCameraNumber(iDisplayIndexA);
                iCameraNumberB = DisplayManager_DisplayCameraNumber(iDisplayIndexB);

                ciCameraInformationA = DisplayManager_GetCamera(iDisplayIndexA);
                ciCameraInformationB = DisplayManager_GetCamera(iDisplayIndexB);


                if (atActivationTypeA == ActivationType.VideoOnDemand)
                {
                    dtStartPlaybackA = DisplayManager_DisplayPlaybackStart(iDisplayIndexA);
                    dtTriggerCreationTimeA = DisplayManager_DisplayTriggerCreationTime(iDisplayIndexA);
                    sTriggerSourceA = DisplayManager_DisplayTriggerSource(iDisplayIndexA);
                    iDurationA = DisplayManager_DisplayPlaybackDuration(iDisplayIndexA);
                }

                if (atActivationTypeB == ActivationType.VideoOnDemand)
                {
                    dtStartPlaybackB = DisplayManager_DisplayPlaybackStart(iDisplayIndexB);
                    dtTriggerCreationTimeB = DisplayManager_DisplayTriggerCreationTime(iDisplayIndexB);
                    sTriggerSourceB = DisplayManager_DisplayTriggerSource(iDisplayIndexB);
                    iDurationB = DisplayManager_DisplayPlaybackDuration(iDisplayIndexB);
                }

                DoStopCamera(iDisplayIndexA);
                DoStopCamera(iDisplayIndexB);

                switch (atActivationTypeA)
                {
                    case ActivationType.LiveVideo:
                        StartCamera_X_on_Display_Y(ciCameraInformationA,
                                                   iDisplayIndexB + 1,
                                                   DvrClientConstants.NONE,
                                                   "",
                                                   true);
                        break;


                    case ActivationType.VideoOnDemand:
                        //StartPlayback_on_Display_Y(guidCameraA,
                        //                           DvrClientConstants.NONE,
                        //                           dtStartPlaybackA,
                        //                           iDisplayIndexB + 1,
                        //                           iDurationA,
                        //                           0,
                        //                           0,
                        //                           "",
                        //                           true,
                        //                           dtTriggerCreationTimeA,
                        //                           sTriggerSourceA);
                        break;


                    default:
                        break;
                }

                switch (atActivationTypeB)
                {
                    case ActivationType.LiveVideo:
                        StartCamera_X_on_Display_Y(ciCameraInformationB,
                                                   iDisplayIndexA + 1,
                                                   DvrClientConstants.NONE,
                                                   "",
                                                   true);
                        break;


                    case ActivationType.VideoOnDemand:
                        //StartPlayback_on_Display_Y(guidCameraB,
                        //                           DvrClientConstants.NONE,
                        //                           dtStartPlaybackB,
                        //                           iDisplayIndexA + 1,
                        //                           iDurationB,
                        //                           0,
                        //                           0,
                        //                           "",
                        //                           true,
                        //                           dtTriggerCreationTimeB,
                        //                           sTriggerSourceB);
                        break;


                    default:
                        break;
                }
            }
            catch (Exception e)
            {
                Audit("Failed Swapping Streams Between Display[" + (iDisplayIndexA + 1) +
                      "] And Display[" + (iDisplayIndexB + 1) + "]. " + e.Message,
                      sMethod,
                      AuditSeverity.Warning);
            }
        }

        private void MoveDisplay(int iNewDisplayIndex, int iOldDisplayIndex)
        {
            DisplayWindow dw = DisplayManager_Display(iOldDisplayIndex);

            DoStopCamera(iOldDisplayIndex);
            StartCamera_X_on_Display_Y(dw.Camera,
                                       iNewDisplayIndex + 1,
                                       dw.ColorNumber,
                                       dw.EventString,
                                       true);
            DisplayManager_SetCameraOpenType(iNewDisplayIndex, dw.OpenType);
            DisplayManager_SetInitiatingAlarm(iNewDisplayIndex, dw.InitiatingAlarm);
            DisplayManager_SetOpenedWithIndex(iNewDisplayIndex, false);
            DisplayManager_SetPreset(iNewDisplayIndex, dw.Preset);
        }

        private void DvrClient_LocationChanged(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (m_Settings.AncorMainForm)
            {
                Left = m_Settings.MainFormLeft;
                Top = m_Settings.MainFormTop;
            }
        }        

        private bool IsHighestMode()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            DisplayFormatState dfs = DisplayManager_GetMode();

            if ((int)(dfs) < 7)
            {
                int iHighestMode = (int)Math.Sqrt((double)m_DisplayInfo.Displays);
                int iCurrentMode = (int)DisplayManager_GetMode();

                if (iHighestMode == iCurrentMode)
                {
                    return true;
                }

                return false; 
            }
            
            return true;            
        }

        private void ElevateDisplayMode()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            this.Cursor = Cursors.Default;

            switch (DisplayManager_GetMode())
            {
                case DisplayFormatState.OneView:
                    Switch2Quad();
                    DisplayManager_SetMode(DisplayFormatState.QuadView);
                    break;


                case DisplayFormatState.QuadView:
                    Switch2Nine();
                    DisplayManager_SetMode(DisplayFormatState.NineView);
                    break;


                case DisplayFormatState.NineView:
                    Switch2Sixteen();
                    DisplayManager_SetMode(DisplayFormatState.SixteenView);
                    break;


                case DisplayFormatState.SixteenView:
                    Switch2TwentyFive();
                    DisplayManager_SetMode(DisplayFormatState.TwentyFiveView);
                    break;


                case DisplayFormatState.TwentyFiveView:
                    Switch2ThirtySix();
                    DisplayManager_SetMode(DisplayFormatState.ThirtySixView);
                    break;


                default:
                    break;
            };
        }

        private void FallBackDisplays()
        {
            #region Data Members
            
            int iHighestDisplayNumber;
            int iDisplay;

            string sMethod = MethodBase.GetCurrentMethod().Name; 

            #endregion

            try
            {
                if (!m_Settings.EnableFallback)
                {
                    Audit("Fallback Disabled", sMethod, AuditSeverity.Information);

                    return;
                }

                iHighestDisplayNumber = DisplayManager_FindHighestDisplayNumber();

                if (iHighestDisplayNumber == DvrClientConstants.NONE)
                {
                    Audit("Can't Find Highest Display Number. No Active Displays", sMethod, AuditSeverity.Warning);

                    SetSpecialLayoutsMode(false);
                    CustomizeDisplays(sMethod);
                    NoVideoPictureOnEmptyDisplays();

                    return;
                }

                for (int i = 0; i < iHighestDisplayNumber + 1; i++)
                {
                    if (DisplayManager_DisplayIsFree(i) == false)
                    {
                        DisplayManager_SetOpenedWithIndex(i, false);
                    }

                    Application.DoEvents();
                }

                while (DisplayManager_FindFreeDisplay(0, iHighestDisplayNumber) != DvrClientConstants.NONE)
                {
                    iDisplay = DisplayManager_FindFreeDisplay(iHighestDisplayNumber);
                    if (iDisplay != DvrClientConstants.NONE)
                    {
                        MoveDisplay(iDisplay, iHighestDisplayNumber);

                        Audit("Moving Display[" + iHighestDisplayNumber + "] To Display[" + iDisplay + "]", 
                              sMethod,
                              AuditSeverity.Information);
                    }

                    iHighestDisplayNumber = DisplayManager_FindHighestDisplayNumber();

                    Application.DoEvents();
                }

                SetSpecialLayoutsMode(false);
                CustomizeDisplays(sMethod);
            }
            catch (Exception e)
            {
                Audit("Failed Performing Fallback. " + e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void ChangeDisplayMode(DisplayFormatState dfs)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            
            Audit("Changing Display Mode To [" + dfs.ToString() + "]", sMethod, AuditSeverity.Information);

            this.Cursor = Cursors.Default;

            switch (dfs)
            {
                case DisplayFormatState.OneView:
                    Switch2One();
                    break;


                case DisplayFormatState.QuadView:
                    Switch2Quad();
                    break;


                case DisplayFormatState.NineView:
                    Switch2Nine();
                    break;


                case DisplayFormatState.SixteenView:
                    Switch2Sixteen();
                    break;


                case DisplayFormatState.TwentyFiveView:
                    Switch2TwentyFive();
                    break;


                case DisplayFormatState.ThirtySixView:
                    Switch2ThirtySix();
                    break;


                default:
                    return;
            };
           
            DisplayManager_SetMode(dfs);
        }

        private void ShowDVRsTreeOnly()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            this.MinimumSize = new System.Drawing.Size(tv.Width, tv.Height);
            this.MaximumSize = new System.Drawing.Size(tv.Width, tv.Height);

            this.Height = tv.Height;
            this.Width = tv.Width;

            tv.Top = 0;
            tv.Left = 0;

            mnu.Visible = false;
            lblIP.Visible = false;
        }

        private void CustomizeDisplays(string sCalledFrom)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            DisplayFormatState dfs;
            bool bLanguageSwitched = m_bLanguageSwitched; 

            #endregion

            try
            {
                m_bLanguageSwitched = false;

                Audit("Called From: " + sCalledFrom, sMethod, AuditSeverity.Information);                

                if (GetSpecialLayoutsMode())
                {
                    #region Special Layouts Handling

                    dfs = DisplayManager_GetMode();

                    Audit("Special Layouts Mode. Mode[" + dfs.ToString() + "]",
                          sMethod,
                          AuditSeverity.Information);

                    if (bLanguageSwitched)
                    {
                        switch (dfs)
                        {
                            case DisplayFormatState.OneView:
                                Switch2One();
                                DisplayManager_SetMode(DisplayFormatState.OneView);
                                NoVideoPictureOnEmptyDisplays();
                                
                                break;

                            case DisplayFormatState.QuadView:
                                Switch2Quad();
                                DisplayManager_SetMode(DisplayFormatState.QuadView);
                                NoVideoPictureOnEmptyDisplays();
                                
                                break;

                            case DisplayFormatState.NineView:
                                Switch2Nine();
                                DisplayManager_SetMode(DisplayFormatState.NineView);
                                NoVideoPictureOnEmptyDisplays();
                                
                                break;

                            case DisplayFormatState.SixteenView:
                                Switch2Sixteen();
                                DisplayManager_SetMode(DisplayFormatState.SixteenView);
                                NoVideoPictureOnEmptyDisplays();
                                
                                break;

                            case DisplayFormatState.TwentyFiveView:
                                Switch2TwentyFive();
                                DisplayManager_SetMode(DisplayFormatState.TwentyFiveView);
                                NoVideoPictureOnEmptyDisplays();
                                
                                break;

                            case DisplayFormatState.ThirtySixView:
                                Switch2ThirtySix();
                                DisplayManager_SetMode(DisplayFormatState.ThirtySixView);
                                NoVideoPictureOnEmptyDisplays();
                                
                                break;

                            case DisplayFormatState.SixOneBig:
                                Switch2SixOneBig();
                                DisplayManager_SetMode(DisplayFormatState.SixOneBig);
                                NoVideoPictureOnEmptyDisplays();
                                
                                break;

                            case DisplayFormatState.EightOneBig:
                                Switch2EightOneBig();
                                DisplayManager_SetMode(DisplayFormatState.EightOneBig);
                                NoVideoPictureOnEmptyDisplays();
                                
                                break;

                            case DisplayFormatState.FiveFourUp:
                                Switch2FiveFourUp();
                                DisplayManager_SetMode(DisplayFormatState.FiveFourUp);
                                NoVideoPictureOnEmptyDisplays();
                                
                                break;

                            case DisplayFormatState.FiveFourDown:
                                Switch2FiveFourDown();
                                DisplayManager_SetMode(DisplayFormatState.FiveFourDown);
                                NoVideoPictureOnEmptyDisplays();
                                
                                break;

                            case DisplayFormatState.ThirteenSurround:
                                Switch2ThirteenSurround();
                                DisplayManager_SetMode(DisplayFormatState.ThirteenSurround);
                                NoVideoPictureOnEmptyDisplays();
                                
                                break;

                            case DisplayFormatState.TenTwoQuads:
                                Switch2TenTwoQuads();
                                DisplayManager_SetMode(DisplayFormatState.TenTwoQuads);
                                NoVideoPictureOnEmptyDisplays();
                                
                                break;

                            case DisplayFormatState.TwoHorizontal:
                                Switch2TwoHorizontal();
                                DisplayManager_SetMode(DisplayFormatState.TwoHorizontal);
                                NoVideoPictureOnEmptyDisplays();
                                
                                break;

                            case DisplayFormatState.TwoVertical:
                                Switch2TwoVertical();
                                DisplayManager_SetMode(DisplayFormatState.TwoVertical);
                                NoVideoPictureOnEmptyDisplays();
                                
                                break;

                            default:
                                break;
                        }
                    }

                    #endregion

                    return;
                }

                if (m_DisplayManager == null)
                {
                    return;
                }

                int iHighestDisplayNumber = DisplayManager_FindHighestDisplayNumber();

                if (iHighestDisplayNumber == DvrClientConstants.NONE)
                {
                    if ((DisplayManager_GetMode() != DisplayFormatState.OneView) || bLanguageSwitched)
                    {
                        Switch2One();
                        DisplayManager_SetMode(DisplayFormatState.OneView);
                    }
                    NoVideoPictureOnEmptyDisplays();

                    return;
                }

                if (iHighestDisplayNumber == 0)
                {
                    if ((DisplayManager_GetMode() != DisplayFormatState.OneView) || bLanguageSwitched)
                    {
                        Switch2One();
                        DisplayManager_SetMode(DisplayFormatState.OneView);
                    }

                    return;
                }

                #region Displays 0-3

                if ((iHighestDisplayNumber > 0) && (iHighestDisplayNumber < 4))
                {
                    if ((DisplayManager_GetMode() != DisplayFormatState.QuadView) || bLanguageSwitched)
                    {
                        Switch2Quad();
                        DisplayManager_SetMode(DisplayFormatState.QuadView);
                    }

                    return;
                }

                #endregion

                #region Displays 0-8

                if ((iHighestDisplayNumber > 3) && (iHighestDisplayNumber < 9))
                {
                    if ((DisplayManager_GetMode() != DisplayFormatState.NineView) || bLanguageSwitched)
                    {
                        Switch2Nine();
                        DisplayManager_SetMode(DisplayFormatState.NineView);
                    }
                    

                    return;
                }

                #endregion

                #region Displays 10-16

                if ((iHighestDisplayNumber >= 9) && (iHighestDisplayNumber < 16))
                {
                    if ((DisplayManager_GetMode() != DisplayFormatState.SixteenView) || bLanguageSwitched)
                    {
                        Switch2Sixteen();
                        DisplayManager_SetMode(DisplayFormatState.SixteenView);
                    }

                    return;
                }

                #endregion

                #region Displays 17-25

                if ((iHighestDisplayNumber >= 16) && (iHighestDisplayNumber < 25))
                {
                    if ((DisplayManager_GetMode() != DisplayFormatState.TwentyFiveView) || bLanguageSwitched)
                    {
                        Switch2TwentyFive();
                        DisplayManager_SetMode(DisplayFormatState.TwentyFiveView);
                    }

                    return;
                }

                #endregion

                #region Displays 26-36

                if ((iHighestDisplayNumber >= 25) && (iHighestDisplayNumber < 37))
                {
                    if ((DisplayManager_GetMode() != DisplayFormatState.ThirtySixView) || bLanguageSwitched)
                    {
                        Switch2ThirtySix();
                        DisplayManager_SetMode(DisplayFormatState.ThirtySixView);
                    }
                    

                    return;
                }

                #endregion
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private DisplayFormatState OptimalMode()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            int iActiveDisplays = DisplayManager_ActiveDisplays();

            if (iActiveDisplays <= 1)
            {
                return DisplayFormatState.OneView;
            }

            if ((iActiveDisplays > 1) && (iActiveDisplays < 5))
            {
                return DisplayFormatState.QuadView;
            }

            if ((iActiveDisplays > 4) && (iActiveDisplays < 10))
            {
                return DisplayFormatState.NineView;
            }

            if ((iActiveDisplays > 9) && (iActiveDisplays < 17))
            {
                return DisplayFormatState.SixteenView;
            }

            if ((iActiveDisplays > 16) && (iActiveDisplays < 26))
            {
                return DisplayFormatState.TwentyFiveView;
            }

            if ((iActiveDisplays > 25) && (iActiveDisplays < 37))
            {
                return DisplayFormatState.ThirtySixView;
            }

            return DisplayFormatState.Unknown;
        }

        public int GetPresetIdByName(string sPresetName, int iDisplay)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            int iDvrGroupId;
            int iDvrId;
            int iCameraNumber;
            int iPresetNumber;

            #endregion

            try
            {
                if (iDisplay == DvrClientConstants.NONE)
                {
                    Audit("Display Number Is Unknown", sMethod, AuditSeverity.Warning);

                    return DvrClientConstants.NONE;
                }

                //iDvrGroupId = DisplayManager_DisplayDvrGroupId(iDisplay);
                iDvrId = DisplayManager_DisplayDvrId(iDisplay);
                iCameraNumber = DisplayManager_DisplayCameraNumber(iDisplay);

                if (!GetCameraPresetNumber(iDvrId, iCameraNumber, sPresetName, out iPresetNumber, out sResult))
                {
                    Audit("Could Not Find In Presets List A Preset With The Name [" + sPresetName + "]. " + sResult,
                          sMethod,
                          AuditSeverity.Warning);

                    return DvrClientConstants.NONE;
                }

                return iPresetNumber;
            }
            catch (Exception e)
            {
                Audit("Failed Getting PresetId By Name[" + sPresetName + "]. " + e.Message, sMethod, AuditSeverity.Error);

                return DvrClientConstants.NONE; ;
            }
        }

        public void ActivateDvrPreset(int iDisplay, string sPresetName, string sEventMessage)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            int iDvrId;
            int iCameraNumber;
            int iPresetNumber;

            CameraInformation ciCameraInformation;

            PtzParameters ptzParameters;

            #endregion

            try
            {
                iPresetNumber = GetPresetIdByName(sPresetName, iDisplay);
                if (iPresetNumber != DvrClientConstants.NONE)
                {
                    iDvrId = DisplayManager_DisplayDvrId(iDisplay);
                    iCameraNumber = DisplayManager_DisplayCameraNumber(iDisplay);

                    ciCameraInformation = DisplayManager_GetCamera(iDisplay);

                    ptzParameters = new PtzParameters();
                    ptzParameters.PresetId = iPresetNumber;
                    ptzParameters.Camera = ciCameraInformation;

                    if (vp[iDisplay].PtzPreset(ptzParameters,
                                           PresetAction.Call,
                                           out sResult))
                    {
                        DisplayManager_SetPreset(iDisplay, sPresetName);

                        Audit("Preset[" + sPresetName +
                              "] Activated For Display[" + iDisplay +
                              "] Camera[" + DisplayManager_DisplayCameraName(iDisplay) +
                              "] On DVR[" + DisplayManager_DisplaySiteName(iDisplay) + "]",
                              sMethod,
                              AuditSeverity.Information);
                    }
                    else
                    {
                        Audit("Preset[" + sPresetName +
                              "] Failed For Display[" + iDisplay +
                              "] Camera[" + DisplayManager_DisplayCameraName(iDisplay) +
                              "] On DVR[" + DisplayManager_DisplaySiteName(iDisplay) + "]. " + sResult,
                              sMethod,
                              AuditSeverity.Information);
                    }
                }
                else
                {
                    string sError = "Could Not Get Preset ID For Preset[" + sPresetName +
                                    "] From Display[" + iDisplay + "]";

                    Audit(sError, sMethod, AuditSeverity.Error);
                    Utils.Error(sError);
                }
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private bool FitsInLayoutMode(int iRealDisplay)
        {
            int iNumberOfDisplaysInLayout;
            DisplayState dsLayout = m_DisplayInfo.State;

            switch (dsLayout)
            {
                case DisplayState.One:
                    iNumberOfDisplaysInLayout = 1;
                    break;

                case DisplayState.Four:
                    iNumberOfDisplaysInLayout = 4;
                    break;

                case DisplayState.Nine:
                    iNumberOfDisplaysInLayout = 9;
                    break;

                case DisplayState.Sixteen:
                    iNumberOfDisplaysInLayout = 16;
                    break;

                case DisplayState.TwentyFive:
                    iNumberOfDisplaysInLayout = 25;
                    break;

                case DisplayState.ThirtySix:
                    iNumberOfDisplaysInLayout = 36;
                    break;

                case DisplayState.SixOneBig:
                    iNumberOfDisplaysInLayout = 6;
                    break;

                case DisplayState.EightOneBig:
                    iNumberOfDisplaysInLayout = 8;
                    break;

                case DisplayState.FiveFourUp:
                case DisplayState.FiveFourDown:
                    iNumberOfDisplaysInLayout = 5;
                    break;

                case DisplayState.ThirteenSurround:
                    iNumberOfDisplaysInLayout = 13;
                    break;

                case DisplayState.TenTwoQuads:
                    iNumberOfDisplaysInLayout = 10;
                    break;

                case DisplayState.TwoHorizontal:
                case DisplayState.TwoVertical:
                    iNumberOfDisplaysInLayout = 2;
                    break;

                default:
                    return false;
            }

            if (iRealDisplay > iNumberOfDisplaysInLayout)
            {
                return false;
            }

            return true;
        }

        private void SelectedDisplayOff()
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;

            int iNumberOfDisplays;
            int iSelectedDisplayIndex; 

            #endregion

            try
            {
                iSelectedDisplayIndex = DisplayManager_GetSelectedDisplayIndex();
                if (iSelectedDisplayIndex == DvrClientConstants.NONE)
                {
                    Audit("No Selected Display Index", sMethod, AuditSeverity.Warning);

                    return;
                }

                VendorVideoPlayerLocation(iSelectedDisplayIndex,
                                        DisplayManager_GetSelectedDisplayLocation().X,
                                        DisplayManager_GetSelectedDisplayLocation().Y);
                VendorVideoPlayerSize(iSelectedDisplayIndex,
                                    DisplayManager_GetSelectedDisplaySize().Width,
                                    DisplayManager_GetSelectedDisplaySize().Height);

                for (int i = 0; i < m_NotSelectedOpenDisplayIndex.Count; i++)
                {
                    vp[m_NotSelectedOpenDisplayIndex[i]].Visible = true;
                }
                m_NotSelectedOpenDisplayIndex = new List<int>();

                switch (m_DisplayInfo.State)
                {
                    case DisplayState.FiveFourDown:
                    case DisplayState.FiveFourUp:
                        iNumberOfDisplays = 5;
                        break;

                    default:
                        iNumberOfDisplays = (int)(m_DisplayInfo.State);
                        break;
                }

                for (int i = 0; i < iNumberOfDisplays; i++)
                {
                    if (vp[i].Visible)
                    {
                        continue;
                    }

                    PictureVisible(i, true);
                }

                HideSurroundingFrame(iSelectedDisplayIndex, sMethod);
                NoVideoPictureOnEmptyDisplays();

                DisplayManager_SetSelectedDisplayModeOn(false);

                Audit("Selected Display Mode Off.", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }            
        }

        private void RePaintBackground()
        {
            //BackgroundImage = Afcon.DvrClient.Control.Properties.Resources.Background1;
        }

        private void MinmizeMaximizeDisplay()
        {
            #region Data Members

            bool bSelectedDisplayModeOn = DisplayManager_GetSelectedDisplayModeOn();

            int iNumberOfDisplays;
            int iDisplayIndex = DisplayManager_GetActiveDisplayIndex();
 
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sVendor;

            CameraInformation ciCameraInformation;

            #endregion

            try
            {
                if (iDisplayIndex == DvrClientConstants.NONE)
                {
                    Audit("Trying To Select Display For Selected Display Mode Without Focus On A Display.",
                          sMethod,
                          AuditSeverity.Warning);
                    SendReplyMessage(false, "");

                    return;
                }
                else
                {
                    if (DisplayManager_DisplayIsFree(iDisplayIndex))
                    {
                        Audit("Display[" + (iDisplayIndex + 1) + "] Is Free.",
                              sMethod,
                              AuditSeverity.Warning);
                        SendReplyMessage(false, "");

                        return;
                    }

                    sVendor = DisplayManager_DisplayVendorName(iDisplayIndex).ToString();
                }

                if (bSelectedDisplayModeOn)
                {
                    Audit("Restore Selected Display[" + (iDisplayIndex + 1) + "]",
                          sMethod,
                          AuditSeverity.Information);
                }
                else
                {
                    Audit("Maximize Selected Display[" + (iDisplayIndex + 1) + "]",
                          sMethod,
                          AuditSeverity.Information);
                }

                if (DisplayManager_GetMode() == DisplayFormatState.OneView)
                {
                    Audit("Selected Display Is In One-View Already.",
                          sMethod,
                          AuditSeverity.Warning);
                    SendReplyMessage(false, "");

                    return;
                }

                if (bSelectedDisplayModeOn)
                {
                    #region Restore

                    Audit("Restoring Selected Display[" + (iDisplayIndex + 1) +
                          "] Width[" + DisplayManager_GetSelectedDisplaySize().Width +
                          "] Height[" + DisplayManager_GetSelectedDisplaySize().Height +
                          "] Location(" + DisplayManager_GetSelectedDisplayLocation().X +
                          "," + DisplayManager_GetSelectedDisplayLocation().Y + ")",
                          sMethod,
                          AuditSeverity.Information);

                    VendorVideoPlayerLocation(iDisplayIndex,
                                            DisplayManager_GetSelectedDisplayLocation().X,
                                            DisplayManager_GetSelectedDisplayLocation().Y);
                    VendorVideoPlayerSize(iDisplayIndex,
                                        DisplayManager_GetSelectedDisplaySize().Width,
                                        DisplayManager_GetSelectedDisplaySize().Height);

                    for (int i = 0; i < m_NotSelectedOpenDisplayIndex.Count; i++)
                    {
                        vp[m_NotSelectedOpenDisplayIndex[i]].Visible = true;
                    }
                    m_NotSelectedOpenDisplayIndex = new List<int>();

                    switch (m_DisplayInfo.State)
                    {
                        case DisplayState.FiveFourDown:
                        case DisplayState.FiveFourUp:
                            iNumberOfDisplays = 5;
                            break;

                        default:
                            iNumberOfDisplays = (int)(m_DisplayInfo.State);
                            break;
                    }

                    for (int i = 0; i < iNumberOfDisplays; i++)
                    {
                        if (vp[i].Visible)
                        {
                            m_Transparent[i].Size = vp[i].Size;

                            continue;
                        }

                        PictureVisible(i, true);
                    }

                    HideSurroundingFrame(iDisplayIndex, sMethod);

                    DisplayManager_SetSelectedDisplayModeOn(false);

                    Audit("Selected Display[" + (iDisplayIndex + 1) +
                          "] Mode Off. Restore Former Displays.",
                          sMethod,
                          AuditSeverity.Information);

                    SendReplyMessage(true, "Restored");

                    #endregion
                }
                else
                {
                    #region Maximize

                    if (m_Settings.EnableBackToOriginalViewByDblClk)
                    {
                        //  keep selected display's index, size and location
                        DisplayManager_SetSelectedDisplayLocation(VendorVideoPlayerLocation(iDisplayIndex));
                        DisplayManager_SetSelectedDisplaySize(VendorVideoPlayerSize(iDisplayIndex));
                        DisplayManager_SetSelectedDisplayIndex(iDisplayIndex);
                        Audit("Storing Selected Display[" + (iDisplayIndex + 1) +
                              "] Width[" + DisplayManager_GetSelectedDisplaySize().Width +
                              "] Height[" + DisplayManager_GetSelectedDisplaySize().Height +
                              "] Location(" + DisplayManager_GetSelectedDisplayLocation().X +
                              "," + DisplayManager_GetSelectedDisplayLocation().Y + ")",
                              sMethod,
                              AuditSeverity.Information);

                        VendorVideoPlayerLocation(DisplayManager_GetActiveDisplayIndex(), START_X, START_Y);
                        VendorVideoPlayerSize(DisplayManager_GetActiveDisplayIndex(), D1_WIDTH, D1_HIGHT);

                        for (int i = 0; i < m_DisplayInfo.Displays; i++)
                        {
                            if (i == iDisplayIndex)
                            {
                                continue;
                            }

                            if (vp[i].Visible)
                            {
                                m_NotSelectedOpenDisplayIndex.Add(i);
                                vp[i].Visible = false;

                                m_Transparent[i].Size = new Size(0, 0);
                            }

                            PictureVisible(i, false);
                        }

                        HideSurroundingFrame(iDisplayIndex, sMethod);

                        DisplayManager_SetSelectedDisplayModeOn(true);

                        Audit("Selected Display[" + (iDisplayIndex + 1) +
                              "] Mode On. Current Displays Stored.",
                              sMethod,
                              AuditSeverity.Information);
                    }
                    else
                    {
                        //int iDvrGroupId = DisplayManager_DisplayDvrGroupId(iDisplayIndex);
                        //int iDvrID = DisplayManager_DisplayDvrId(iDisplayIndex);
                        //int iCameraNumber = DisplayManager_DisplayCameraNumber(iDisplayIndex);

                        ciCameraInformation = DisplayManager_GetCamera(iDisplayIndex);

                        CloseAllCameras();
                        StartCamera(ciCameraInformation, DvrClientConstants.NONE, "", true);
                    }

                    SendReplyMessage(true, "Maximized");

                    #endregion
                }
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
                SendReplyMessage(false, "");                 
            }
        }

        #endregion

        #region GUI

        #region Main Menu

        private void mnuExit_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            KillAllTimers();

            //  Closing the communication thread
            //if (m_PCimProxyThread != null)
            //{
            //    m_PCimProxyThread.StopServer();
            //    m_PCimProxyThread.Kill();
            //    m_PCimProxyThread = null;
            //}

            ////  Closing the Alarms Listener
            //if (m_AlarmsListenerThread != null)
            //{
            //    m_AlarmsListenerThread.StopAlarmsListener();
            //    m_AlarmsListenerThread = null;
            //}

            ////  Closing the Loggers keepalive thread
            //if (m_LoggersKeepaliveThread != null)
            //{
            //    m_LoggersKeepaliveThread.Stop();
            //    m_LoggersKeepaliveThread = null;
            //}

            ////  Closing the Export thread
            //if (m_ExportThread != null)
            //{
            //    m_ExportThread = null;
            //}

            ////  Closing Audit
            //if (m_AuditFile != null)
            //{
            //    m_AuditFile.Close();
            //}

            //if (m_PlayerInfo != null)
            //{
            //    for (int i = 0; i < m_DisplayInfo.Displays; i++)
            //    {
            //        if (m_PlayerInfo[i] != null)
            //        {
            //            ((IStreamSource)m_PlayerInfo[i]).ClearStreamSource();
            //        }
            //    }
            //}

            //if (m_PlayerManager != null)
            //{
            //    m_PlayerManager.Disconnect();
            //}

            //Environment.Exit(0);

            OnKillApplication();
        }

        private void mnuDisplayTemplates_Click(object sender, EventArgs e)
        {
            m_Settings.Log = m_Log;
            m_Settings.Main = this;

            m_DisplayTemplate = new frmDisplayTemplate(m_Settings);

            m_DisplayTemplate.Show();
        } 

        private void mnuCloseAllDisplays_Click(object sender, EventArgs e)
        {
            if (DisplayManager_ActiveDisplays() > 0)
            {
                CloseAllCameras();
            }
        }

        private void mnuAbout_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            frmAbout f = new frmAbout();

            f.Show();
        }

        private void mnuSettings_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            m_Settings.Log = m_Log;
            m_Settings.Main = this;
            m_frmSettings = new frmSettings(m_Settings);

            m_frmSettings.Show();
        }

        #region Audit

        private void mnuAuditHide_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            m_Log.Visible = false;
            mnuAuditHide.Enabled = false;
            mnuAuditShow.Enabled = true;
        }

        private void mnuAuditShow_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (m_Settings.Audit)
            {
                m_Log.Visible = true;
                mnuAuditHide.Enabled = true;
                mnuAuditShow.Enabled = false;
            }
        } 

        #endregion

        #region Error Messages

        private void mnuHideErrorMessage_Click(object sender, EventArgs e)
        {
            Utils.ShowErrorMessages = false;
            mnuHideErrorMessage.Enabled = false;
            mnuShowErrorMessage.Enabled = true;
        }

        private void mnuShowErrorMessage_Click(object sender, EventArgs e)
        {
            Utils.ShowErrorMessages = true;
            mnuHideErrorMessage.Enabled = true;
            mnuShowErrorMessage.Enabled = false;
        } 

        #endregion        

        #region Save / Restore Displays

        private void mnuSaveDisplays_Click(object sender, EventArgs e)
        {
            if (DisplayManager_ActiveDisplays() > 0)
            {
                SaveDisplaysToDataBase();
            }
        }

        private void mnuRestoreDisplays_Click(object sender, EventArgs e)
        {
            RestoreDisplaysFromDataBase();
        } 

        #endregion
        
        #region Tools

        private void mnuDisplayManagerView_Click(object sender, EventArgs e)
        {
            m_DisplayManagerViewer = new frmDisplayManager(this);
            m_DisplayManagerViewer.Show();
        }        

        private void mnuAlarmListenerFilter_Click(object sender, EventArgs e)
        {
            #region Data Mambers
            
            int iDvr;
            int iCameraNumber;
            int iEventType;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sDvr;
            string sCameraNumber;
            string sEventType;
            string sMessage;
            string sAlarmFilter = Microsoft.VisualBasic.Interaction.InputBox("Enter DVR Number, Camera Number, Event Type Number",
                                                                             "Alarms Listener Filter",
                                                                             "",
                                                                             0,
                                                                             0); 

            #endregion

            try
            {
                sDvr = Utils.GetNthSubString(sAlarmFilter, ",", 1);
                sCameraNumber = Utils.GetNthSubString(sAlarmFilter, ",", 2);
                sEventType = Utils.GetNthSubString(sAlarmFilter, ",", 3);

                sMessage = "";

                try
                {
                    iDvr = int.Parse(sDvr);
                    sMessage += "DVR[" + iDvr + "] ";
                }
                catch (Exception)
                {
                    iDvr = DvrClientConstants.NONE;
                }

                try
                {
                    iCameraNumber = int.Parse(sCameraNumber);
                    sMessage += "Camera[" + iCameraNumber + "] ";
                }
                catch (Exception)
                {
                    iCameraNumber = DvrClientConstants.NONE;
                }

                try
                {
                    iEventType = int.Parse(sEventType);
                    sMessage += "Event Type[" + iEventType + "] ";
                }
                catch (Exception)
                {
                    iEventType = DvrClientConstants.NONE;
                }

                if (sMessage != "")
                {
                    Audit("Alarms Listener Filter: " + sMessage, sMethod, AuditSeverity.Information);
                    AlarmListenerFilter(iDvr, iCameraNumber, iEventType);
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void mnuCheckNiceAlarmCounters_Click(object sender, EventArgs e)
        {
            //int iAlarmListenerMessageCouner;
            //int iAlarmListenerHandlerMessageCounter;

            //string sMessage = "";

            //for (int i = 0; i < m_AlarmsListenerThread.Length; i++)
            //{
            //    iAlarmListenerMessageCouner = m_AlarmsListenerThread[i].GetAlarmListenerMessageCounter();
            //    iAlarmListenerHandlerMessageCounter = m_AlarmsListenerMessagesHandlerThread[i].GetAlarmListenerHandlerMessageCounter();

            //    sMessage += "Alarm Listener Message Couner: " + iAlarmListenerMessageCouner + "\n" +
            //                "Alarm Listener Handler Message Counter: " + iAlarmListenerHandlerMessageCounter + "\n";
            //}

            //MessageBox.Show(sMessage,
            //                "Alatm Listener Counters",
            //                MessageBoxButtons.OK,
            //                MessageBoxIcon.Information);
        }

        private void mnuNvfVideoPlayer_Click(object sender, EventArgs e)
        {
            //m_NvfPlayer = new frmNvfPlayer();
            //m_NvfPlayer.Show();
        }

        private void mnuDataScope_Click(object sender, EventArgs e)
        {
            m_Settings.Log = m_Log;
            m_Settings.Main = this;

            m_DvrClientDataScope = new frmDvrClientDataScope(this, m_Settings);
            m_DvrClientDataScope.Show();
        }

        private void mnuDvrsAndCamerasInformation_Click(object sender, EventArgs e)
        {
            m_frmDvrsAndCamerasInformation = new frmDvrsAndCamerasInformation(this, m_DvrsAndCamerasInformation);
            m_frmDvrsAndCamerasInformation.Show();
        }

        private void mnuDvrsCamerasAndPresetsStructureToFile_Click(object sender, EventArgs e)
        {
            if (DvrsCamerasAndPresetsStructure(m_DvrsAndCameras))
	        {
                string windir = Environment.GetEnvironmentVariable("WINDIR");
                Process prc = new System.Diagnostics.Process();
                prc.StartInfo.FileName = windir + @"\explorer.exe";
                prc.StartInfo.Arguments = m_sPath;
                prc.Start();
	        }
            else
            {
                MessageBox.Show("Failed Creating Dvrs, Cameras And Presets Structure File",
                                "File Creating Error",
                                MessageBoxButtons.OK,
                                MessageBoxIcon.Error);
            }
        }

        private void mnuExportPropertiesToFile_Click(object sender, EventArgs e)
        {
            ExportProperties();
        }

        private void mnuComparePropertyFiles_Click(object sender, EventArgs e)
        {
            ComparePropertiesFiles();
        }   

        #endregion

        #region Log Files

        private void mnuDeleteLogFiles_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            DialogResult dr = MessageBox.Show("Delete Log Files?",
                                              "",
                                              MessageBoxButtons.YesNo,
                                              MessageBoxIcon.Question);

            if (dr == DialogResult.Yes)
            {
                CleanLogFiles();
            }
        }

        private void mnuStampLogFile_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            AttentionStampToLog(sMethod);
        }

        private void mnuCopyLogsToDesktop_Click(object sender, EventArgs e)
        {
            #region Data Members

		    string sMethod = MethodBase.GetCurrentMethod().Name;
            string sSourcePath = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location); ;
            string sDestinationPath = Environment.GetFolderPath(Environment.SpecialFolder.Desktop);

            DirectoryInfo diSource = new DirectoryInfo(sSourcePath);
            DirectoryInfo diDestination;

            FileInfo[] txtFiles;
            FileInfo[] csvFiles; 

	        #endregion

            try
            {
                sDestinationPath = System.IO.Path.Combine(sDestinationPath, "Logs");
                if (!System.IO.Directory.Exists(sDestinationPath))
                {
                    System.IO.Directory.CreateDirectory(sDestinationPath);
                }
                diDestination = new DirectoryInfo(sDestinationPath);

                txtFiles = diSource.GetFiles(DvrClientConstants.APPLICATION_NAME + "*.txt");
                csvFiles = diSource.GetFiles(DvrClientConstants.APPLICATION_NAME + "*.csv");

                foreach (FileInfo txtFile in txtFiles)
                {
                    txtFile.CopyTo(diDestination.FullName + @"\" + txtFile.Name, true);
                }

                foreach (FileInfo csvFile in csvFiles)
                {
                    csvFile.CopyTo(diDestination.FullName + @"\" + csvFile.Name, true);
                }

                frmMessage msg = new frmMessage(txtFiles.Length + " Text Files And " + 
                                                csvFiles.Length + " CSV Files Copied To '" + 
                                                sDestinationPath + "'", 5, Color.Aqua);
                msg.Show();
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Warning);
            }
        } 

        #endregion

        #region Language

        private void mnuEnglish_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (m_Settings.Language == Language.English)
            {
                return;
            }

            m_Settings.Language = Language.English;
            English();
            ArrangeDvrClientForm(sMethod);
            m_bLanguageSwitched = true;
            CustomizeDisplays(sMethod);
            NoVideoPictureOnEmptyDisplays();

            PrepareDvrTreeContextMenu();
        }

        private void mnuHebrew_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (m_Settings.Language == Language.Hebrew)
            {
                return;
            }

            m_Settings.Language = Language.Hebrew;
            Hebrew();
            ArrangeDvrClientForm(sMethod);
            m_bLanguageSwitched = true;
            CustomizeDisplays(sMethod);
            NoVideoPictureOnEmptyDisplays();

            PrepareDvrTreeContextMenu();
        }
        
        #endregion
        
        private void mnuConnect_Click(object sender, EventArgs e)
        {

        }

        public void UnhideMenu()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            mnu.Visible = true;
        }

        #region Layouts

        private void mnuOneView_Click(object sender, EventArgs e)
        {
            Switch2One();
            NoVideoPictureOnEmptyDisplays();
            SetSpecialLayoutsMode(true);
        }

        private void mnuFourView_Click(object sender, EventArgs e)
        {
            Switch2Quad();
            NoVideoPictureOnEmptyDisplays();
            SetSpecialLayoutsMode(true);
        }

        private void mnuNineView_Click(object sender, EventArgs e)
        {
            Switch2Nine();
            NoVideoPictureOnEmptyDisplays();
            SetSpecialLayoutsMode(true);
        }

        private void mnuSixteenView_Click(object sender, EventArgs e)
        {
            Switch2Sixteen();
            NoVideoPictureOnEmptyDisplays();
            SetSpecialLayoutsMode(true);
        }

        private void mnuTwentyFiveView_Click(object sender, EventArgs e)
        {
            Switch2TwentyFive();
            NoVideoPictureOnEmptyDisplays();
            SetSpecialLayoutsMode(true);
        }

        private void mnuThirtySixView_Click(object sender, EventArgs e)
        {
            Switch2ThirtySix();
            NoVideoPictureOnEmptyDisplays();
            SetSpecialLayoutsMode(true);
        }

        private void mnuLayout1_Click(object sender, EventArgs e)
        {
            Switch2SixOneBig();
            NoVideoPictureOnEmptyDisplays();
            SetSpecialLayoutsMode(true);
        }

        private void mnuLayout2_Click(object sender, EventArgs e)
        {
            Switch2EightOneBig();
            NoVideoPictureOnEmptyDisplays();
            SetSpecialLayoutsMode(true);
        }

        private void mnuLayout3_Click(object sender, EventArgs e)
        {
            Switch2FiveFourUp();
            NoVideoPictureOnEmptyDisplays();
            SetSpecialLayoutsMode(true);
        }

        private void mnuLayout4_Click(object sender, EventArgs e)
        {
            Switch2FiveFourDown();
            NoVideoPictureOnEmptyDisplays();
            SetSpecialLayoutsMode(true);
        }

        private void mnuLayout5_Click(object sender, EventArgs e)
        {
            Switch2ThirteenSurround();
            NoVideoPictureOnEmptyDisplays();
            SetSpecialLayoutsMode(true);
        }

        private void mnuLayout6_Click(object sender, EventArgs e)
        {
            Switch2TenTwoQuads();
            NoVideoPictureOnEmptyDisplays();
            SetSpecialLayoutsMode(true);
        }

        private void mnuLayout7_Click(object sender, EventArgs e)
        {
            Switch2TwoHorizontal();
            NoVideoPictureOnEmptyDisplays();
            SetSpecialLayoutsMode(true);
        }

        private void mnuLayout8_Click(object sender, EventArgs e)
        {
            Switch2TwoVertical();
            NoVideoPictureOnEmptyDisplays();
            SetSpecialLayoutsMode(true);
        }

        private void mnuNormal_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            SetSpecialLayoutsMode(false);
            CustomizeDisplays(sMethod);
            NoVideoPictureOnEmptyDisplays();
        }

        private void mnuFallback_Click(object sender, EventArgs e)
        {
            if (m_Settings.EnableFallback)
            {
                FallBackDisplays();
            }
        }  

        private void SetSpecialLayoutsMode(bool bInSpecialLayoutsMode)
        {
            m_bSpecialLayoutsMode = bInSpecialLayoutsMode;
        }

        private bool GetSpecialLayoutsMode()
        {
            return m_bSpecialLayoutsMode;
        }

        #endregion

        #endregion

        #region Cameras Tree

        private void CamerasTreeWidth(int iWidth)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (tv != null)
            {
                tv.Width = iWidth;
                Audit("Cameras Tree Width: " + iWidth, sMethod, AuditSeverity.Information);
            }
        }

        private void CamerasTreeHeight(int iHeight)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (tv != null)
            {
                tv.Height = iHeight;
                Audit("Cameras Tree Height: " + iHeight, sMethod, AuditSeverity.Information);
            }
        }

        #endregion

        #region Popup Menu

        private void mnuOpenCamera_Click(object sender, EventArgs e)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            CameraInformation ci;

            DvrInformation di;

            #endregion

            try
            {
                if (m_bMultiSelect)
                {
                    if (m_MultiSelectedCamera == null)
                    {
                        Audit("Multi Selected Cameras List Is Null", sMethod, AuditSeverity.Warning);

                        return;
                    }

                    if (m_MultiSelectedCamera.Count == 0)
                    {
                        Audit("Multi Selected Cameras List Is Empty", sMethod, AuditSeverity.Warning);

                        return;
                    }

                    for (int i = 0; i < m_MultiSelectedCamera.Count; i++)
                    {
                        //StartCamera(m_MultiSelectedCamera[i].SiteName,
                        //            m_MultiSelectedCamera[i].CameraNumber,
                        //            DvrClientConstants.NONE,
                        //            "",
                        //            true);

                        DoEvents();
                    }
                }
                else
                {
                    if (tv.SelectedNode == null)
                    {
                        return;
                    }

                    di = (DvrInformation)(tv.SelectedNode.Parent.Tag);
                    ci = (CameraInformation)tv.SelectedNode.Tag;

                    StartCamera(ci, DvrClientConstants.NONE, "", true);
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void mnuCamera2Display_Click(object sender, EventArgs e)
        {
            #region Data Members
            
            int iCameraNumber;

            string sTag;
            string sSiteName;
            Vendor vVendor;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            CameraInformation ci;

            DvrInformation di;

            frmDisplay f; 

            #endregion

            if (tv.SelectedNode == null)
            {
                return;
            }

            di = (DvrInformation)(tv.SelectedNode.Parent.Tag);
            ci = (CameraInformation)tv.SelectedNode.Tag;

            f = new frmDisplay(this, ci, m_DisplayInfo.Displays);

            f.Show();            
        }

        private void mnuCameraClose_Click(object sender, EventArgs e)
        {
            #region Data Members
                              
            string sMethod = MethodBase.GetCurrentMethod().Name;

            CameraInformation ci;

            DvrInformation di;
            
            #endregion

            if (tv.SelectedNode == null)
            {
                return;
            }

            if ((tv.SelectedNode.Parent.Tag).GetType() == typeof(string))
            {
                return;
            }

            di = (DvrInformation)(tv.SelectedNode.Parent.Tag);
            ci = (CameraInformation)tv.SelectedNode.Tag;

            DisplayManager_SetActiveDisplayIndex(DisplayManager_FindDisplayByCamera(di.DvrId, ci.CameraNumber));
            if (DisplayManager_GetActiveDisplayIndex() == DvrClientConstants.NONE)
            {
                return;
            }

            btnClose_Click(null, null);
        }
        
        private void mnuCloseAllCameras_Click(object sender, EventArgs e)
        {
            #region Data Members
            
            int i;

            string sKey;
            string sSiteName;
            string sSiteAddress;
            string sSiteVersion;
            Vendor vSiteVendor;
            string sSiteID;
            string sMethod = MethodBase.GetCurrentMethod().Name; 

            #endregion

            try
            {
                if (tv.SelectedNode == null)
                {
                    Audit("Selected Node Is Null",
                          sMethod,
                          AuditSeverity.Information);

                    return;
                }

                Audit("Closing All Active Displays",
                      sMethod,
                      AuditSeverity.Information);

                //  find all cameras and close
                for (i = (m_DisplayInfo.Displays - 1); i >= 0; i--)
                {
                    if (!DisplayManager_DisplayIsFree(i))
                    {
                        DoStopCamera(i);
                    }
                }

                NoVideoPictureOnEmptyDisplays();
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void mnuPlayback_Click(object sender, EventArgs e)
        {
            #region Data Members

            CameraInformation ciCameraInformation;

            DvrInformation diDvrInformation;
          
            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                if (tv.SelectedNode == null)
                {
                    return;
                }

                diDvrInformation = (DvrInformation)((tv.SelectedNode).Parent.Tag);
                ciCameraInformation = (CameraInformation)(tv.SelectedNode.Tag);

                m_PlaybackSearchParameters = new PlaybackSearchParameters();

                m_PlaybackSearchParameters.Camera = ciCameraInformation;
                m_PlaybackSearchParameters.Main = this;
                m_PlaybackSearchParameters.Language = m_Settings.Language;
                m_PlaybackSearchParameters.MaxDisplaysNumber = m_Settings.MaxDisplaysNumber;
                m_PlaybackSearchParameters.Display = DvrClientConstants.NONE;

                frmPlayback f = new frmPlayback(this, m_PlaybackSearchParameters);
                f.OkPressed += new EventHandler(PressedOkOnPlaybackForm_Handler);

                f.Show();
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void mnuFastPlayback_Click(object sender, EventArgs e)
        {
            #region Data Members

            Vendor vVendor = Vendor.Nice;

            CameraInformation ciCameraInformation;

            DvrInformation diDvrInformation;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                if (tv.SelectedNode == null)
                {
                    return;
                }

                diDvrInformation = (DvrInformation)((tv.SelectedNode).Parent.Tag);
                ciCameraInformation = (CameraInformation)(tv.SelectedNode.Tag);

                switch (vVendor)
                {
                    case Vendor.Nice:
                        DateTime dtStartDateTime;
                        DateTime dtNow = DateTime.Now;

                        dtStartDateTime = dtNow.AddMinutes(-1 * m_Settings.PlaybackLastMinutes);

                        StartPlayback(ciCameraInformation,                                          
                                      DvrClientConstants.NONE,
                                      dtStartDateTime,
                                      m_Settings.PlaybackLastMinutes * 60,
                                      0,
                                      0,
                                      "",
                                      true,
                                      Utils.InitialDefaultTime(),
                                      "");                         
                        break;

                    default:
                        break;
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }        

        private void mnuExport_Click(object sender, EventArgs e)
        {
            #region Data Members

            CameraInformation ciCameraInformation;

            DvrInformation diDvrInformation;
          
            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                if (tv.SelectedNode == null)
                {
                    return;
                }

                diDvrInformation = (DvrInformation)((tv.SelectedNode).Parent.Tag);
                ciCameraInformation = (CameraInformation)(tv.SelectedNode.Tag);

                m_ExportData = new ExportThreadData();

                m_ExportData.Main = this;
                m_ExportData.Camera = ciCameraInformation;
                m_ExportData.DvrName = diDvrInformation.Name;
                m_ExportData.ServerGroupId = diDvrInformation.ServerGroupId;
                m_ExportData.DvrId = ciCameraInformation.DvrId;
                m_ExportData.CameraNumber = ciCameraInformation.CameraNumber;
                m_ExportData.Channel = ciCameraInformation.Channel;
                m_ExportData.VideoFormat = m_Settings.VideoFormat;
                m_ExportData.CameraName = "Camera - " + ciCameraInformation.CameraNumber;
                m_ExportData.InitialDirectory = (string.IsNullOrEmpty(m_Settings.ExportFolder)) ? Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) : m_Settings.ExportFolder;
                m_ExportData.UseTimeInterval = false;
                m_ExportData.MultiSelect = m_bMultiSelect;

                frmExport f = new frmExport(this, m_ExportData);

                f.Show();
            }
            catch(Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        } 

        private void mnuDvrInfo_Click(object sender, EventArgs e)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;

            DvrInformation diDvrInformation;

            #endregion

            if (tv.SelectedNode == null)
            {
                return;
            }

            try
            {
                diDvrInformation = (DvrInformation)(tv.SelectedNode.Tag);

                frmDvrInfo showInfo = new frmDvrInfo(diDvrInformation.Vendor,
                                                     diDvrInformation.Name,
                                                     diDvrInformation.IpAddress,
                                                     diDvrInformation.DvrId.ToString(),
                                                     diDvrInformation.Version,
                                                     m_Settings.Language,
                                                     (diDvrInformation.Camera == null) ? 0 : diDvrInformation.Camera.Count);
                showInfo.Show();
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void mnuCameraInfo_Click(object sender, EventArgs e)
        {
            #region Data Members            
            
            string sMethod = MethodBase.GetCurrentMethod().Name;

            CameraInformation ciCameraInformation;

            #endregion

            if (tv.SelectedNode == null)
            {
                return;
            }

            ciCameraInformation = (CameraInformation)(tv.SelectedNode.Tag);

            frmCameraInfo showInfo = new frmCameraInfo(ciCameraInformation.Vendor,
                                                       ciCameraInformation.SiteName,
                                                       ciCameraInformation.Name,
                                                       ciCameraInformation.CameraNumber,
                                                       ciCameraInformation.Channel,
                                                       "Unknown",
                                                       "Unknown",
                                                       DvrClientConstants.NONE,
                                                       DvrClientConstants.NONE,
                                                       DvrClientConstants.NONE,
                                                       DvrClientConstants.NONE,
                                                       DvrClientConstants.NONE,
                                                       "Unknown",
                                                       m_Settings.Language);
            showInfo.Show();
        }

        private void mnuVmdTriggers_Click(object sender, EventArgs e)
        {
            #region Data Members

            int iCameraNumber;

            string sTag;
            string sSiteName;
            string sSiteAddress;
            string sCameraName;
            Vendor vVendor;
            string sParentTag;
            string sSiteID;
            string sSiteVersion;
            Vendor vSiteVendor;
            string sMethod = MethodBase.GetCurrentMethod().Name; 

            #endregion

            try
            {
                sTag = tv.SelectedNode.Tag.ToString();
                sParentTag = tv.SelectedNode.Parent.Tag.ToString();
            }
            catch (Exception ee)
            {
                string s = ee.Message;
                return;
            }

            if (sTag.Length < 6)
            {
                return;
            }

            if (sTag.Substring(0, 8) == "[VENDOR]")
            {
                Utils.NukeTag(sTag, 
                              out sSiteName, 
                              out sCameraName, 
                              out iCameraNumber, 
                              out vVendor);
                Utils.NukeTag(sParentTag, 
                              out sSiteName, 
                              out sSiteAddress, 
                              out sSiteID, 
                              out sSiteVersion, 
                              out vSiteVendor);
            }
            else
            {
                return;
            }            

            frmVmdTriggers f = new frmVmdTriggers(this,                                                  
                                                  m_Settings.MaxDisplaysNumber,
                                                  m_Settings.NiceAmsIp,
                                                  sSiteName,
                                                  sSiteAddress,
                                                  iCameraNumber,                                                  
                                                  sCameraName,
                                                  m_Settings.VideoFormat,
                                                  (string.IsNullOrEmpty(m_Settings.ExportFolder)) ? Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) : m_Settings.ExportFolder);
            f.Show();
        }

        private void mnuAddFreeText_Click(object sender, EventArgs e)
        {
            #region Data Members

            int iCameraNumber;            
            int iDisplayIndex;

            string sTag;
            string sSiteName = "";
            string sCameraName = "";
            string sMessage;            
            string sMethod = MethodBase.GetCurrentMethod().Name;

            Vendor vVendor = Vendor.Unknown;

            #endregion

            if (tv.SelectedNode == null)
            {
                return;
            }

            sTag = tv.SelectedNode.Tag.ToString();

            if (sTag.Length < 6)
            {
                return;
            }

            if (sTag.Substring(0, 8) == "[VENDOR]")
            {
                Utils.NukeTag(sTag, out sSiteName, out sCameraName, out iCameraNumber, out vVendor);
            }
            else
            {
                return;
            }

            iDisplayIndex = DisplayManager_FindDisplayByCameraNumber(sSiteName, iCameraNumber);

            if (DisplayManager_DisplayActivation(iDisplayIndex) == ActivationType.NotActive)
            {
                sMessage = (Language == Language.English) ? "Display Not Active" : "  ";
                MessageBox.Show(sMessage, 
                                "Nice Display Free Text", 
                                MessageBoxButtons.OK,
                                MessageBoxIcon.Exclamation);
            }
            else
            {
                sMessage = Microsoft.VisualBasic.Interaction.InputBox("Text",
                                                                      "Add Nice Display Free Text",
                                                                      "",
                                                                      Cursor.Position.X,
                                                                      Cursor.Position.Y);

                NiceVideoDisplayFreeText(iDisplayIndex, sMessage);                              
            }
        }

        private void mnuCleaAllCheckboxes_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_MultiSelectedCamera == null)
                {
                    Audit("Multi Selected Cameras List Is Null", sMethod, AuditSeverity.Warning);

                    return;
                }

                m_MultiSelectedCamera.Clear();

                if (tv.Nodes == null)
                {
                    Audit("No Nodes In Tree", sMethod, AuditSeverity.Warning);

                    return;
                }

                if (tv.Nodes[0].Nodes == null)
                {
                    Audit("No Dvrs In Tree", sMethod, AuditSeverity.Warning);

                    return;
                }

                if (tv.Nodes[0].Nodes.Count == 0)
                {
                    Audit("0 Dvrs In Tree", sMethod, AuditSeverity.Warning);

                    return;
                }

                for (int i = 0; i < tv.Nodes[0].Nodes.Count; i++)
                {
                    if (tv.Nodes[0].Nodes[i].Nodes == null)
                    {
                        Audit("No Cameras For Dvr ", sMethod, AuditSeverity.Warning);

                        continue;
                    }

                    if (tv.Nodes[0].Nodes[i].Nodes.Count == 0)
                    {
                        Audit("0 Cameras For Dvr ", sMethod, AuditSeverity.Warning);

                        continue;
                    }

                    for (int j = 0; j < tv.Nodes[0].Nodes[i].Nodes.Count; j++)
                    {
                        if (tv.Nodes[0].Nodes[i].Nodes[j].Checked)
                        {
                            tv.Nodes[0].Nodes[i].Nodes[j].Checked = false;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        //private void mnuStartPatrol_Click(object sender, EventArgs e)
        //{
        //    #region Data Members

        //    string sMethod = MethodBase.GetCurrentMethod().Name;

        //    Types.Patrol p; 

        //    #endregion

        //    try
        //    {
        //        if (tv.SelectedNode == null)
        //        {
        //            return;
        //        }

        //        p = (Types.Patrol)(tv.SelectedNode.Tag);
                
        //        Audit("Tour[" + p.PatrolName + "]", sMethod, AuditSeverity.Information);

        //        LoadPatrolItems(p);
        //    }
        //    catch (Exception ex)
        //    {
        //        Audit(ex.Message, sMethod, AuditSeverity.Error);
        //    }    
        //}

        //private void mnuStartPatrolFromMainMenu_Click(object sender, EventArgs e)
        //{
        //    #region Data Members

        //    string sMethod = MethodBase.GetCurrentMethod().Name;

        //    Types.Patrol p;

        //    #endregion

        //    try
        //    {
        //        p = (Types.Patrol)(((ToolStripMenuItem)sender).Tag);

        //        Audit("Tour[" + p.PatrolName + "]", sMethod, AuditSeverity.Information);
        //    }
        //    catch (Exception ex)
        //    {
        //        Audit(ex.Message, sMethod, AuditSeverity.Error);
        //    }
        //}        

        #endregion        

        #region Preset / PTZ GUI

        private void btnAddPreset_Click(object sender, EventArgs e)
        {
            OnAddPreset(null, null);
        }

        private void btnUpdatePreset_Click(object sender, EventArgs e)
        {
            OnUpdatePreset(null, null);
        }

        private void btnRemovePreset_Click(object sender, EventArgs e)
        {
            OnDeletePreset(null, null);
        }     

        #endregion

        private void DvrClient_SizeChanged(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (m_Settings.Mode == ActivationMode.StandAlone)
            {
                if (m_bChangingBackToNormalScreenMode)
                {
                    m_bChangingBackToNormalScreenMode = false;
                    Audit("Finished Changing Back To Normal Screen Mode",
                          sMethod,
                          AuditSeverity.Information);

                    DvrClientFormSize();
                    ArrangeDvrClientForm(sMethod);
                } 
            }
        }
        
        private void btnClose_Click(object sender, EventArgs e)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            int iDisplayIndex = DisplayManager_GetActiveDisplayIndex(); 

            #endregion

            try
            {
                if (iDisplayIndex == DvrClientConstants.NONE)
                {
                    return;
                }

                switch (DisplayManager_DisplayActivation(iDisplayIndex))
                {
                    case ActivationType.LiveVideo:
                        Audit("Closing LIVE VIDEO on Display[" + iDisplayIndex + "]",
                              sMethod,
                              AuditSeverity.Information);
                        DoStopCamera(iDisplayIndex);
                        break;


                    case ActivationType.VideoOnDemand:
                        Audit("Closing PLAYBACK on Display[" + iDisplayIndex + "]",
                              sMethod,
                              AuditSeverity.Information);
                        DoStopCamera(iDisplayIndex);
                        break;


                    default:
                        return;
                }

                HideSurroundingFrame(iDisplayIndex, sMethod);
                CloseButtonVisible(false);
                btnDigitalZoom.Visible = false;
                DisplayDescription("");
                EventMessage("");
                gbPTZ.Visible = false;
                gbPlayback.Visible = false;
                gbSmallPlayback.Visible = false;
                gbPresets.Visible = false;
                CamerasTreeHeight(m_DisplayInfo.D1_Hight);

                if (DisplayManager_GetSelectedDisplayModeOn())
                {
                    DisplayManager_SetSelectedDisplayModeOn(false);
                }

                //FallBackDisplays();
                CustomizeDisplays(sMethod);
                NoVideoPictureOnEmptyDisplays();
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void btnMain_Click(object sender, EventArgs e)
        {
            string sMainView = "";
            string sError = "";
            string sMethod = MethodBase.GetCurrentMethod().Name;

            sMainView = GetCurrentMainView(out sError);

            if (sError == "")
            {
                //PopupMessage("Loading Main View '" + sMainView + "'", 2, Color.Cyan);
                StartMainView(sMainView);
            }
            else 
            {
                Audit(sError ,sMethod, AuditSeverity.Error);
            }
        }

        private void btnUndo_Click(object sender, EventArgs e)
        {
            HistoryUndo();
        }

        private void btnRedo_Click(object sender, EventArgs e)
        {
            HistoryRedo();
        }        

        private void btnWorkingMode_Click(object sender, EventArgs e)
        {
            if (m_WorkMode == WorkMode.Operation)
            {
                m_WorkMode = WorkMode.Drag;
                btnWorkingMode.Image = Afcon.DvrClient.Control.Properties.Resources.Design;
                btnWorkingMode.ToolTipText = (m_Settings.Language == Language.Hebrew) ? "\n" : "Drag\nMode";
                btnWorkingMode.Text = (m_Settings.Language == Language.Hebrew) ? "" : "Drag";
            }
            else
            {
                m_WorkMode = WorkMode.Operation;
                btnWorkingMode.Image = Afcon.DvrClient.Control.Properties.Resources.Operation;
                btnWorkingMode.ToolTipText = (m_Settings.Language == Language.Hebrew) ? "\n" : "Operation\nMode";
                btnWorkingMode.Text = (m_Settings.Language == Language.Hebrew) ? "" : "Operation";
            }
        }

        private void btnTreeSelectionMode_Click(object sender, EventArgs e)
        {
            if (!m_bMultiSelect)
            {
                m_bMultiSelect = true;
                tv.CheckBoxes = true;

                btnTreeSelectionMode.Image = Afcon.DvrClient.Control.Properties.Resources.Single;
                btnTreeSelectionMode.ToolTipText = (m_Settings.Language == Language.Hebrew) ? " " : "Single Select";
                btnTreeSelectionMode.Text = (m_Settings.Language == Language.Hebrew) ? " " : "Single Select";
            }
            else
            {
                m_bMultiSelect = false;
                tv.CheckBoxes = false;

                btnTreeSelectionMode.Image = Afcon.DvrClient.Control.Properties.Resources.Multi;
                btnTreeSelectionMode.ToolTipText = (m_Settings.Language == Language.Hebrew) ? " " : "Multi Select";
                btnTreeSelectionMode.Text = (m_Settings.Language == Language.Hebrew) ? " " : "Multi Select";
            }

            tv.ExpandAll();
        }

        private void btnDigitalZoom_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            //int iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();

            //if (iActiveDisplayIndex == DvrClientConstants.NONE)
            //{
            //    return;
            //}

            //if (DisplayManager_DisplayDigitalZoomMode(iActiveDisplayIndex))
            //{
            //    DisplayManager_SetDigitalZoomMode(iActiveDisplayIndex, false);

            //    tagRECT rect = new tagRECT();
            //    rect.top = 0;
            //    rect.left = 0;
            //    rect.bottom = 0;
            //    rect.right = 0;

            //    m_PlayerDisplay[iActiveDisplayIndex].ZoomToRect(rect);

            //    btnDigitalZoom.Image = Afcon.DvrClient.Control.Properties.Resources.Digital_Zoom;
            //    btnDigitalZoom.Text = (m_Settings.Language == Language.Hebrew) ? " " : "Digital Zoom";
            //    btnDigitalZoom.ToolTipText = (m_Settings.Language == Language.Hebrew) ? " " : "Digital Zoom";
            //}
            //else
            //{ 
            //    DisplayManager_SetDigitalZoomMode(iActiveDisplayIndex, true);
            //}
            
        }

        private void HideGUI()
        {
            if (m_bUnlockFileExists)
            {
                return;
            }

            if (InvokeRequired)
            {
                this.BeginInvoke(new EmptyDelegate(UnhideGUI));
            }
            else
            {
                this.Enabled = false;

                DoEvents();

                MessageBox.Show("Dvr Client Unable To Connect To Pulse Server." + Environment.NewLine +
                                "Resons Can Be:" + Environment.NewLine +
                                "1 - Communication Settings." + Environment.NewLine +
                                "2 - License For The Video Module",
                                "Video Module Load Problem",
                                MessageBoxButtons.OK,
                                MessageBoxIcon.Exclamation);

                if (!m_bPulseIsConnected)
                {
                    mnuExit_Click(null, null);
                }
            }
        }

        private void UnhideGUI()
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            if (m_bUnlockFileExists)
            {
                return;
            }

            if (InvokeRequired)
            {
                this.BeginInvoke(new EmptyDelegate(UnhideGUI));
            }
            else
            {
                CloseMessageBox("Video Module Load Problem");
                m_bPulseIsConnected = true;
                this.Enabled = true;
            }
        }

        private void CloseMessageBox(string sCaption)
        {
            IntPtr hWnd = FindWindowByCaption(IntPtr.Zero, sCaption);
            if (hWnd != IntPtr.Zero)
            {
                PostMessage(hWnd, DvrClientConstants.WM_CLOSE, 0, 0);
            }
        }

        private void GroupBoxVisibility(GroupBox gb, bool bVisible)
        {
            if (InvokeRequired)
            {
                BeginInvoke(new TwoParamDelegate<GroupBox, bool>((GroupBoxVisibility)), gb, bVisible);
            }
            else
            {
                gb.Visible = bVisible;
            }
        }

        private void ButtonVisibility(Button btn, bool bVisible)
        {
            if (InvokeRequired)
            {
                BeginInvoke(new TwoParamDelegate<Button, bool>((ButtonVisibility)), btn, bVisible);
            }
            else
            {
                btn.Visible = bVisible;
            }
        }

        private void TreeNodeText(TreeNode tn, string sText)
        {
            if (InvokeRequired)
            {
                BeginInvoke(new TwoParamDelegate<TreeNode, string>((TreeNodeText)), tn, sText);
            }
            else
            {
                tn.Text = sText;
            }
        }

        private void CloseButtonVisible(bool bVisible)
        {
            btnClose.Visible = bVisible;
        }

        #endregion

        #region Treeview Stuff

        #region Treeview Events

        private void tv_Click(object sender, EventArgs e)
        {
            CloseButtonVisible(false);
            btnDigitalZoom.Visible = false;
            gbPlayback.Visible = false;
            gbSmallPlayback.Visible = false;
            gbPresets.Visible = false;
        }

        private void tv_DoubleClick(object sender, EventArgs e)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            CameraInformation ciCameraInformation;

            DvrInformation diDvrInformation;

            #endregion

            try
            {
                if (tv.SelectedNode == null)
                {
                    return;
                }

                if (tv.SelectedNode.Tag.GetType() == typeof(string))
                {
                    return;
                }

                if (tv.SelectedNode.Tag.GetType() == typeof(DvrInformation))
                {
                    return;
                }

                diDvrInformation = (DvrInformation)((tv.SelectedNode).Parent.Tag);
                ciCameraInformation = (CameraInformation)(tv.SelectedNode.Tag);

                StartCamera(ciCameraInformation, 
                            DvrClientConstants.NONE, 
                            "", 
                            true);
            }
            catch (Exception ex)
            {
                Audit("Failed On Tree Double Click." + ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void tv_MouseDown(object sender, MouseEventArgs mea)
        {
            #region Data Members
            
            string sKey;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            bool bNodeIsRoot = false;

            TreeRootType trt;

            Type nodeType;

            #endregion

            try
            {
                if (mea.Button == MouseButtons.Right)
                {
                    if (tv.SelectedNode == null)
                    {
                        return;
                    }

                    #region Multi Select
                    //if (m_bMultiSelect)
                    //{
                    //    if (m_MultiSelectedCamera == null)
                    //    {
                    //        m_MultiSelectedCamera = new List<Types.CameraInformation>();
                    //    }

                    //    for (int i = 0; i < tv.Nodes[0].Nodes.Count; i++)
                    //    {
                    //        if (tv.Nodes[0].Nodes[i].Nodes != null)
                    //        {
                    //            if (tv.Nodes[0].Nodes[i].Nodes.Count > 0)
                    //            {
                    //                for (int j = 0; j < tv.Nodes[0].Nodes[i].Nodes.Count; j++)
                    //                {
                    //                    if (tv.Nodes[0].Nodes[i].Nodes[j].Checked)
                    //                    {
                    //                        string sDvr;
                    //                        string sCameraName;
                    //                        int iCameraNumber;
                    //                        Vendor vVendor;

                    //                        Utils.NukeTag(tv.Nodes[0].Nodes[i].Nodes[j].Tag.ToString(),
                    //                                      out sDvr,
                    //                                      out sCameraName,
                    //                                      out iCameraNumber,
                    //                                      out vVendor);

                    //                        if (!CameraExistsInMultiSelectList(sDvr, iCameraNumber))
                    //                        {
                    //                            Types.CameraInformation ci = new Types.CameraInformation(vVendor,
                    //                                                                                     sDvr,
                    //                                                                                     sCameraName,
                    //                                                                                     iCameraNumber,
                    //                                                                                     DvrClientConstants.NONE,
                    //                                                                                     "",
                    //                                                                                     "",
                    //                                                                                     DvrClientConstants.NONE,
                    //                                                                                     DvrClientConstants.NONE,
                    //                                                                                     DvrClientConstants.NONE,
                    //                                                                                     DvrClientConstants.NONE,
                    //                                                                                     DvrClientConstants.NONE,
                    //                                                                                     "");
                    //                            m_MultiSelectedCamera.Add(ci);
                    //                        }
                    //                    }
                    //                }
                    //            }
                    //        }
                    //    }

                    //    if (m_MultiSelectedCamera.Count > 0)
                    //    {
                    //        mnuOpenCamera.Visible = true;
                    //        mnuCameraClose.Visible = false;
                    //        mnuPlayback.Visible = true;
                    //        mnuExport.Visible = true;
                    //        mnuCamera2Display.Visible = false;
                    //        mnuCameraInfo.Visible = false;
                    //        mnuVmdTriggers.Visible = false;
                    //        mnuAddFreeText.Visible = false;
                    //        mnuFastPlayback.Visible = true;

                    //        mnuCleaAllCheckboxes.Visible = true;
                    //        mnuCloseAllCameras.Visible = false;
                    //        mnuDvrInfo.Visible = false;
                    //    }

                    //    return;
                    //} 
                    #endregion

                    nodeType = (tv.SelectedNode).Tag.GetType();

                    if (nodeType == typeof(string))
                    {
                        sKey = (string)(tv.SelectedNode).Tag;
                        bNodeIsRoot = true;

                        switch (sKey)
                        {
                            case "[ROOT]":
                            case "[Tours]":
                                mnuStartPatrol.Visible = false;
                                mnuStopPatrol.Visible = false;

                                mnuOpenCamera.Visible = false;
                                mnuCameraClose.Visible = false;
                                mnuPlayback.Visible = false;
                                mnuExport.Visible = false;
                                mnuCamera2Display.Visible = false;
                                mnuCameraInfo.Visible = false;
                                mnuVmdTriggers.Visible = false;
                                mnuAddFreeText.Visible = false;
                                mnuFastPlayback.Visible = false;

                                mnuCleaAllCheckboxes.Visible = false;
                                mnuCloseAllCameras.Visible = false;
                                mnuDvrInfo.Visible = false;
                                return;

                            default:
                                break;
                        }

                        return;
                    }

                    if (nodeType == typeof(CameraInformation))
                    {
                        mnuOpenCamera.Visible = true;
                        mnuCameraClose.Visible = true;
                        mnuPlayback.Visible = true;
                        mnuExport.Visible = true;
                        mnuCamera2Display.Visible = true;
                        mnuCameraInfo.Visible = true;
                        mnuVmdTriggers.Visible = false;
                        mnuAddFreeText.Visible = false;
                        mnuFastPlayback.Visible = true;

                        mnuCleaAllCheckboxes.Visible = false;
                        mnuCloseAllCameras.Visible = false;
                        mnuDvrInfo.Visible = false;

                        mnuStartPatrol.Visible = false;
                        mnuStopPatrol.Visible = false;

                        return;
                    }

                    if (nodeType == typeof(DvrInformation))
                    {
                        mnuOpenCamera.Visible = false;
                        mnuCameraClose.Visible = false;
                        mnuPlayback.Visible = false;
                        mnuExport.Visible = false;
                        mnuCamera2Display.Visible = false;
                        mnuCameraInfo.Visible = false;
                        mnuVmdTriggers.Visible = false;
                        mnuAddFreeText.Visible = false;
                        mnuFastPlayback.Visible = false;

                        mnuCleaAllCheckboxes.Visible = false;
                        mnuCloseAllCameras.Visible = true;
                        mnuDvrInfo.Visible = true;
                        mnuStartPatrol.Visible = false;
                        mnuStopPatrol.Visible = false;

                        return;
                    }

                    if (nodeType == typeof(Patrol))
                    {
                        mnuStartPatrol.Visible = true;
                        mnuStopPatrol.Visible = true;

                        mnuOpenCamera.Visible = false;
                        mnuCameraClose.Visible = false;
                        mnuPlayback.Visible = false;
                        mnuExport.Visible = false;
                        mnuCamera2Display.Visible = false;
                        mnuCameraInfo.Visible = false;
                        mnuVmdTriggers.Visible = false;
                        mnuAddFreeText.Visible = false;
                        mnuFastPlayback.Visible = false;

                        mnuCleaAllCheckboxes.Visible = false;
                        mnuCloseAllCameras.Visible = false;
                        mnuDvrInfo.Visible = false;

                        return;
                    }

                    if (nodeType == typeof(PatrolItem))
                    {
                        mnuStartPatrol.Visible = false;
                        mnuStopPatrol.Visible = false;

                        mnuOpenCamera.Visible = false;
                        mnuCameraClose.Visible = false;
                        mnuPlayback.Visible = false;
                        mnuExport.Visible = false;
                        mnuCamera2Display.Visible = false;
                        mnuCameraInfo.Visible = false;
                        mnuVmdTriggers.Visible = false;
                        mnuAddFreeText.Visible = false;
                        mnuFastPlayback.Visible = false;

                        mnuCleaAllCheckboxes.Visible = false;
                        mnuCloseAllCameras.Visible = false;
                        mnuDvrInfo.Visible = false;

                        return;
                    }

                    #region Old
                    //if ((tv.SelectedNode).Tag is string)
                    //{
                    //    sKey = (string)(tv.SelectedNode).Tag;
                    //    bNodeIsRoot = true;

                    //    switch (sKey)
                    //    {
                    //        case "[ROOT]":
                    //            break;

                    //        case "[Tours]":
                    //            mnuStartPatrol.Visible = false;

                    //            mnuOpenCamera.Visible = false;
                    //            mnuCameraClose.Visible = false;
                    //            mnuPlayback.Visible = false;
                    //            mnuExport.Visible = false;
                    //            mnuCamera2Display.Visible = false;
                    //            mnuCameraInfo.Visible = false;
                    //            mnuVmdTriggers.Visible = false;
                    //            mnuAddFreeText.Visible = false;
                    //            mnuFastPlayback.Visible = false;

                    //            mnuCleaAllCheckboxes.Visible = false;
                    //            mnuCloseAllCameras.Visible = false;
                    //            mnuDvrInfo.Visible = false;
                    //            return;

                    //        default:
                    //            break;
                    //    }
                    //}
                    //else
                    //{
                    //    bNodeIsRoot = false;
                    //}                                                        

                    //if (bNodeIsRoot)
                    //{
                    //    mnuOpenCamera.Visible = false;
                    //    mnuCameraClose.Visible = false;
                    //    mnuPlayback.Visible = false;
                    //    mnuExport.Visible = false;
                    //    mnuCamera2Display.Visible = false;
                    //    mnuCameraInfo.Visible = false;
                    //    mnuVmdTriggers.Visible = false;
                    //    mnuAddFreeText.Visible = false;
                    //    mnuFastPlayback.Visible = false;

                    //    mnuCleaAllCheckboxes.Visible = false;
                    //    mnuCloseAllCameras.Visible = true;
                    //    mnuDvrInfo.Visible = false;
                    //    mnuStartPatrol.Visible = false;

                    //    return;
                    //}
                    //else
                    //{
                    //    if ((tv.SelectedNode).Tag is Patrol)
                    //    {
                    //        mnuStartPatrol.Visible = true;

                    //        mnuOpenCamera.Visible = false;
                    //        mnuCameraClose.Visible = false;
                    //        mnuPlayback.Visible = false;
                    //        mnuExport.Visible = false;
                    //        mnuCamera2Display.Visible = false;
                    //        mnuCameraInfo.Visible = false;
                    //        mnuVmdTriggers.Visible = false;
                    //        mnuAddFreeText.Visible = false;
                    //        mnuFastPlayback.Visible = false;

                    //        mnuCleaAllCheckboxes.Visible = false;
                    //        mnuCloseAllCameras.Visible = false;
                    //        mnuDvrInfo.Visible = false;
                    //    }
                    //    else
                    //    {
                    //        if ((tv.SelectedNode).Tag is PatrolItem)
                    //        {
                    //            mnuStartPatrol.Visible = false;

                    //            mnuOpenCamera.Visible = false;
                    //            mnuCameraClose.Visible = false;
                    //            mnuPlayback.Visible = false;
                    //            mnuExport.Visible = false;
                    //            mnuCamera2Display.Visible = false;
                    //            mnuCameraInfo.Visible = false;
                    //            mnuVmdTriggers.Visible = false;
                    //            mnuAddFreeText.Visible = false;
                    //            mnuFastPlayback.Visible = false;

                    //            mnuCleaAllCheckboxes.Visible = false;
                    //            mnuCloseAllCameras.Visible = false;
                    //            mnuDvrInfo.Visible = false;
                    //        }
                    //        else
                    //        {
                    //            mnuOpenCamera.Visible = true;
                    //            mnuCameraClose.Visible = true;
                    //            mnuPlayback.Visible = true;
                    //            mnuExport.Visible = true;
                    //            mnuCamera2Display.Visible = true;
                    //            mnuCameraInfo.Visible = false;
                    //            mnuVmdTriggers.Visible = false;
                    //            mnuAddFreeText.Visible = false;
                    //            mnuFastPlayback.Visible = true;

                    //            mnuCleaAllCheckboxes.Visible = false;
                    //            mnuCloseAllCameras.Visible = false;
                    //            mnuDvrInfo.Visible = false;

                    //            mnuStartPatrol.Visible = false;
                    //        }
                    //    }

                    //    return;
                    //} 
                    #endregion
                }
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Warning);
            }
        }

        private void tv_ItemDrag(object sender, ItemDragEventArgs e)
        {
            #region Data Members

            TreeView tree;
            TreeNode node;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            CameraInformation ciCameraInformation;

            DvrInformation diDvrInformation;

            Vendor vVendor;

            #endregion

            try
            {
                // Get the tree.
                tree = (TreeView)sender;

                // Get the node underneath the mouse.
                node = tv.SelectedNode;

                if (node == null)
                {
                    return;
                }

                if (node.Tag.GetType() == typeof(string))
                {
                    return;
                }

                if (node.Tag.GetType() == typeof(DvrInformation))
                {
                    return;
                }

                diDvrInformation = (DvrInformation)((tv.SelectedNode).Parent.Tag);
                ciCameraInformation = (CameraInformation)(tv.SelectedNode.Tag);

                // Start the drag-and-drop operation with a cloned copy of the node.
                if (node != null)
                {
                    Audit("Grabbed Camera[Camera  - " + ciCameraInformation.CameraNumber + 
                          "] Of Dvr[" + diDvrInformation.Name +
                          "] Vendor[" + Vendor.HikVision +
                          "] Source[" + Utils.GetEnumDescription(DragedItemSource.CamerasTree) + "]",
                          sMethod,
                          AuditSeverity.Information);

                    tree.DoDragDrop(new VideoPlayerDragData(DragedItemSource.CamerasTree,
                                                            ciCameraInformation,
                                                            DvrClientConstants.NONE,
                                                            ActivationType.LiveVideo),
                                    DragDropEffects.Copy);
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Warning);
            }
        }

        private void tv_DragOver(object sender, DragEventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                // Get the tree.
                TreeView tree = (TreeView)sender;

                // Drag and drop denied by default.
                e.Effect = DragDropEffects.None;

                // Is it a valid format?
                if (e.Data.GetData(typeof(TreeNode)) != null)
                {
                    // Get the screen point.
                    Point pt = new Point(e.X, e.Y);

                    // Convert to a point in the TreeView's coordinate system.
                    pt = tree.PointToClient(pt);

                    // Is the mouse over a valid node?
                    TreeNode node = tree.GetNodeAt(pt);
                    if (node != null)
                    {
                        e.Effect = DragDropEffects.Copy;
                        tree.SelectedNode = node;
                    }
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Warning);
            }
        }

        private void tv_AfterCheck(object sender, TreeViewEventArgs e)
        {
            TreeNode tn = e.Node;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (tn == null)
                {
                    return;
                }

                if (tn.Tag == null)
                {
                    return;
                }

                switch (IdentifyDeviceType(tn.Tag.ToString()))
                {
                    case DeviceType.Camera:
                        if (tn.Checked == false)
                        {
                            m_bTreeviewDvrCheckedFlag = false;
                            TreeNode tnn = tn.Parent;
                            tnn.Checked = false;
                        }
                        break;

                    case DeviceType.Dvr:
                        if (m_bTreeviewDvrCheckedFlag == false)
                        {
                            m_bTreeviewDvrCheckedFlag = true;
                            return;
                        }

                        foreach (TreeNode tnn in tn.Nodes)
                        {
                            tnn.Checked = tn.Checked;
                        }
                        break;

                    default:
                        return;
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        } 

        #endregion

        public TreeView GetTree()
        {
            return tv;
        }

        private void CreateTree()
        {
            #region Data Members
            
            TreeNode parent;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult; 

            #endregion

            try
            {
                if (InvokeRequired)
                {
                    BeginInvoke(new EmptyDelegate(CreateTree));
                }
                else
                {
                    tv.Nodes.Clear();

                    #region images list for the tree view

                    il.Images.Add(Afcon.DvrClient.Control.Properties.Resources.Project_16x16);
                    il.Images.Add(Afcon.DvrClient.Control.Properties.Resources.NVR_16X16);
                    il.Images.Add(Afcon.DvrClient.Control.Properties.Resources.CAMERA_green_16X16);
                    il.Images.Add(Afcon.DvrClient.Control.Properties.Resources.TreeNode);
                    il.Images.Add(Afcon.DvrClient.Control.Properties.Resources.CAMERA_red_16x16);
                    il.Images.Add(Afcon.DvrClient.Control.Properties.Resources.CAMERA_grey_16x16);
                    il.Images.Add(Afcon.DvrClient.Control.Properties.Resources.PTZ_green_16x16);
                    il.Images.Add(Afcon.DvrClient.Control.Properties.Resources.PTZ_red_16x16);
                    il.Images.Add(Afcon.DvrClient.Control.Properties.Resources.PTZ_grey_16x16);
                    tv.ImageList = il;

                    #endregion

                    #region Add root Node

                    parent = tv.Nodes.Add("Afcon " + Utils.GetVendorPluginName());
                    parent.Tag = "[ROOT]";
                    parent.ImageIndex = (int)IconIndex.Ams;
                    parent.SelectedImageIndex = (int)IconIndex.Ams;

                    #endregion

                    if (m_DvrInformation == null)
                    {
                        Audit("No Devices", sMethod, AuditSeverity.Warning);

                        return;
                    }

                    for (int i = 0; i < m_DvrInformation.Count; i++)
                    {
                        DvrInformation di = (DvrInformation)m_DvrInformation[i];

                        parent.Nodes.Add("[" + di.IpAddress + "] - " + di.Name);

                        parent.Nodes[i].Tag = m_DvrInformation[i];
                        parent.Nodes[i].ImageIndex = (int)IconIndex.Logger;
                        parent.Nodes[i].SelectedImageIndex = (int)IconIndex.Logger;

                        if (di.Camera != null)
                        {
                            for (int j = 0; j < di.Camera.Count; j++)
                            {
                                CameraInformation ci = (CameraInformation)(di.Camera[j]);
                                parent.Nodes[i].Nodes.Add("(" + ci.CameraNumber + ") " + ci.Name);

                                parent.Nodes[i].Nodes[j].Tag = ci;

                                int iIconIndex = (ci.IsPtz) ? (int)IconIndex.PtzCamera : (int)IconIndex.Camera;

                                parent.Nodes[i].Nodes[j].ImageIndex = iIconIndex;
                                parent.Nodes[i].Nodes[j].SelectedImageIndex = iIconIndex;
                            }
                        }
                    }

                    tv.ExpandAll();

                    PrepareDvrTreeContextMenu();
                    //gbActions.Enabled = true;
                }
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void RefreshTree()
        {
            #region Data Members

            //int i;
            //int j;

            //string sNodeName;
            //string sDvrParentNodeName;
            //string sMethod = MethodBase.GetCurrentMethod().Name;

            //TreeNode parent;
            //TreeNode currentNode;
            //TreeNode selectedNode;
            //TreeNode parentServer;
            //TreeNode currentCameraNode;
            //Types.NiceSourceInfo tmpSource; 

            #endregion

//            try
//            {
//                if (m_Settings.ShowRefreshTree)
//                {
//                    Audit("Refreshing DVRs / Cameras Tree", sMethod, AuditSeverity.Information);
//                }

//                if (m_Source.Logger == null)
//                {
//                    Audit("No Dvrs Fetched From Database", sMethod, AuditSeverity.Warning);

//                    return;
//                }

//                GetPtzCameras();

//                //  clear tree
//                tv.Nodes.Clear();

//                #region show tree?

//                if (m_bFullScreenMode)
//                #region yes

//                {
//                    tv.Visible = false;
//                } 

//                #endregion
//                else
//                #region no

//                {
//                    if (!m_Settings.HideTree)
//                    {
//                        tv.Visible = true;
//                    }
//                } 

//                #endregion

//                #endregion

//                #region images list for the tree view

//                il.Images.Add(Afcon.DvrClient.Control.Properties.Resources.Ams);
//                il.Images.Add(Afcon.DvrClient.Control.Properties.Resources.Comp);
//                il.Images.Add(Afcon.DvrClient.Control.Properties.Resources.Camera_Green1);
//                il.Images.Add(Afcon.DvrClient.Control.Properties.Resources.TreeNode);
//                il.Images.Add(Afcon.DvrClient.Control.Properties.Resources.Camera_Red1);
//                il.Images.Add(Afcon.DvrClient.Control.Properties.Resources.Camera_Black);
//                il.Images.Add(Afcon.DvrClient.Control.Properties.Resources.Camera_Purple);
//                tv.ImageList = il;

//                #endregion

//                #region Add root Node

//                parent = tv.Nodes.Add(m_Settings.ProjectName);
//                parent.Tag = "[ROOT]";
//                parent.ImageIndex = (int)IconIndex.Ams;
//                parent.SelectedImageIndex = (int)IconIndex.Ams;

//                #endregion

//                //  Expand root node so we can see what's under it
//                parent.Expand();

//                #region Prepare pre defined nodes

//                if (m_TreeNodeName != null)
//                {
//                    for (i = 0; i < m_TreeNodeName.Length; i++)
//                    {
//                        sNodeName = m_TreeNodeName[i];
//                        currentNode = parent.Nodes.Add(sNodeName);
//                        currentNode.Tag = "[HOME]" + sNodeName;
//                        currentNode.ImageIndex = (int)IconIndex.Home;
//                        currentNode.SelectedImageIndex = (int)IconIndex.Home;
//                    }
//                }

//                #endregion

//                #region Nice Dvrs

//                //tmpSource.Channels = new Types.Channels[tmpSource.Logger.Length];
//                for (i = 0; i < m_Source.Logger.Length; i++)
//                {
//                    string sThisLogger;

//                    if (!m_Settings.PromiscuousModeOn)
//                    {
//                        if (!TestConnection2Dvr(m_Source.Logger[i].Name))
//                        {
//                            Audit("Dvr[" + m_Source.Logger[i].Name +
//                                  "] Id[" + m_Source.Logger[i].ID +
//                                  "] Address[" + m_Source.Logger[i].Address + "] Unreachable",
//                                  sMethod,
//                                  AuditSeverity.Warning);

//                            continue;
//                        }
//                        else
//                        {                            
//                            Audit("Dvr[" + m_Source.Logger[i].Name +
//                                    "] Id[" + m_Source.Logger[i].ID +
//                                    "] Address[" + m_Source.Logger[i].Address + "] Reachable",
//                                    sMethod,
//                                    AuditSeverity.Important);                            
//                        }
//                    }                    

//                    sThisLogger = "<" +
//                                  m_Source.Logger[i].Name +
//                                  ">" +
//                                  "[" +
//                                  m_Source.Logger[i].ID +
//                                  "]" +
//                                  m_Source.Logger[i].Address;
//                    m_sLoggers.Add(sThisLogger);

//                    sDvrParentNodeName = GetTreeNodeNameByIpAddress(m_Source.Logger[i].Address.ToString());
//                    if (sDvrParentNodeName == "")
//                    {
//                        selectedNode = parent;
//                    }
//                    else
//                    {
//                        selectedNode = null;
//                        FindNodeInHierarchy(tv.Nodes, sDvrParentNodeName);
//                        if (m_bNodeFound)
//                        {
//                            selectedNode = m_NodeFound;
//                        }
//                        else
//                        {
//                            selectedNode = parent;
//                        }
//                    }

//                    currentNode = selectedNode.Nodes.Add(m_Source.Logger[i].Name);
//                    currentNode.Tag = "[DVR]" + m_Source.Logger[i].Name +
//                                      "[IP]" + m_Source.Logger[i].Address.ToString() +
//                                      "[ID]" + m_Source.Logger[i].ID.ToString() +
//                                      "[VERSION]" + m_Source.Logger[i].Version + 
//                                      "[VENDOR]NICE";
//                    currentNode.ImageIndex = (int)IconIndex.Logger;
//                    currentNode.SelectedImageIndex = (int)IconIndex.Logger;

//                    //tmpSource.Channels[i].Channel = NiceChannel.FetchChannels(m_Database, tmpSource.Logger[i].ID);

//                    parentServer = currentNode;

//                    for (j = 0; j < m_Source.Channels[i].Channel.Length; j++)
//                    {
//                        bool bRc;

//                        if (m_Settings.PromiscuousModeOn)
//                        {
//                            bRc = true;
//                        }
//                        else
//                        {
//                            bRc = GetChannelActiveStatus(m_Source.Logger[i].Name,
//                                                         m_Source.Channels[i].Channel[j].ServerChannelNO);
//                        }

//                        //Audit("Camera[" + tmpSource.Channels[i].Channel[j].ServerChannelNO +
//                        //      "] Channel ID[" + tmpSource.Channels[i].Channel[j].ChannelID +
//                        //      "] On DVR[" + tmpSource.Logger[i].Name + 
//                        //      "] Is Active - " + bRc, 
//                        //      sMethod, 
//                        //      AuditSeverity.Information);
                        
//                        if (bRc)
//                        {
//                            string sChannelNodeText = "(" +
//                                                      m_Source.Channels[i].Channel[j].ServerChannelNO.ToString() +
//                                                      ") " +
//                                                      m_Source.Channels[i].Channel[j].ChannelName;

//                            int iThisDisplay = DisplayManager_FindDisplayByCameraNumber(m_Source.Logger[i].Name,
//                                                                                        m_Source.Channels[i].Channel[j].ServerChannelNO);

//                            if (iThisDisplay != DvrClientConstants.NONE)
//                            {
//                                sChannelNodeText = "[" + (iThisDisplay + 1) + "] " + sChannelNodeText;
//                            }

//                            currentCameraNode = parentServer.Nodes.Add(sChannelNodeText);
//                            currentCameraNode.Tag = "[VENDOR]NICE" +
//                                                    "[NAME]" + m_Source.Channels[i].Channel[j].ChannelName.ToString() +
//                                                    "[DVR]" + m_Source.Logger[i].Name +
//                                                    "[NUMBER]" + m_Source.Channels[i].Channel[j].ServerChannelNO.ToString();
//                            if (IsPtzCamera(m_Source.Logger[i].Name, m_Source.Channels[i].Channel[j].ServerChannelNO))
//                            {
//                                currentCameraNode.ImageIndex = (int)IconIndex.PtzCamera;
//                                currentCameraNode.SelectedImageIndex = (int)IconIndex.PtzCamera;
//                            }
//                            else
//                            {
//                                currentCameraNode.ImageIndex = (int)IconIndex.Camera;
//                                currentCameraNode.SelectedImageIndex = (int)IconIndex.Camera;
//                            }
//                        }

//                        DoEvents();
//                    }

//                    DoEvents();
//                }

//                #endregion

//                #region Vicon Dvrs
//#if Vicon
//                if (bm.IsValidIpAddress(m_Settings.ViconNucleusIp))
//                {
//                    Ping netMon = new Ping();
//                    PingReply pingReply = netMon.Send(m_Settings.ViconNucleusIp);

//                    if (pingReply.Status != IPStatus.Success)
//                    {
//                        Audit("Can't Reach Vicon Nucleus at IP " + m_Settings.ViconNucleusIp,
//                              sMethod);
//                    }
//                    else
//                    {
//                        int[] Byte;
//                        bool bRc = Utils.GetIpAddressBytes(m_Settings.ViconNucleusIp, out Byte);
//                        if (bRc)
//                        {
//                            if (ViconInitializeNucleus(vpRoot, Byte[0], Byte[1], Byte[2], Byte[3]))
//                            {

//                                if (ViconStartListenToEvents(vpRoot))
//                                {
//                                    if (ViconLogin(vpRoot, m_Settings.ViconUser, m_Settings.ViconPassword))
//                                    {
//                                        object oDvr;
//                                        object oCamera;
//                                        string[] sDvrs;
//                                        int[] iCameras;

//                                        oDvr = vpRoot.GetSitesByKind(SiteKind.KIND_TX);
//                                        sDvrs = (string[])oDvr;

//                                        selectedNode = parent;

//                                        for (i = 0; i < sDvrs.Length; i++)
//                                        {
//                                            currentNode = selectedNode.Nodes.Add(sDvrs[i]);
//                                            currentNode.Tag = "[DVR]" + sDvrs[i] +
//                                                              "[IP]" + //tmpSource.Logger[i].Address.ToString() +
//                                                              "[ID]" + //tmpSource.Logger[i].ID.ToString() +
//                                                              "[VERSION]" + vpRoot.ProductVersion + //+ tmpSource.Logger[i].Version;
//                                                              "[VENDOR]VICON";
//                                            currentNode.ImageIndex = (int)IconIndex.Logger;
//                                            currentNode.SelectedImageIndex = (int)IconIndex.Logger;

//                                            oCamera = vpRoot.GetSiteCameras(sDvrs[i]);
//                                            iCameras = (int[])oCamera;

//                                            for (j = 0; j < iCameras.Length; j++)
//                                            {
//                                                vpRoot.SiteName = sDvrs[i];
//                                                vpRoot.CameraNumber = iCameras[j];

//                                                currentCameraNode = currentNode.Nodes.Add("(" + iCameras[j].ToString() + ") " + vpRoot.CameraName);
//                                                currentCameraNode.Tag = "[VENDOR]VICON" +
//                                                                        "[NAME]" + vpRoot.CameraName +
//                                                                        "[DVR]" + sDvrs[i] +
//                                                                        "[NUMBER]" + vpRoot.CameraNumber;
//                                                currentCameraNode.ImageIndex = (int)IconIndex.Camera;
//                                                currentCameraNode.SelectedImageIndex = (int)IconIndex.Camera;
//                                            }
//                                        }
//                                    }
//                                }
//                            }
//                        }
//                    }
//                }
//                else 
//                {
//                    Audit("No Vicon Nucleus IP Address Declared OR An Invalid Address[" + m_Settings.ViconNucleusIp + "]", 
//                          sMethod);
//                }
//#endif
//                #endregion

//                //m_Source.Copy(tmpSource);

//                Audit("Filling Dvrs And Cameras Information", sMethod, AuditSeverity.Information);
//                //if (!FillDvrsAndCamerasInformation())
//                //{
//                //    Audit("Problem In Filling Dvrs And Cameras Information", sMethod, AuditSeverity.Warning);
//                //}
//                bwBackgroundWorker.RunWorkerAsync(null);

//                //  Expand root node so we can see what's under it
//                parent.ExpandAll();

//                //  select the top node
//                tv.SelectedNode = tv.Nodes[0];
//            }
//            catch (Exception e)
//            {
//                Audit("Failed Refreshing Tree." + e.Message, sMethod, AuditSeverity.Warning);
//            }
        }

        public List<DvrInformation> GetDvrInformation()
        {
            return m_DvrInformation;
        }

        private bool CameraExistsInMultiSelectList(string sDvr, int iCameraNumber)
        {
            if (m_MultiSelectedCamera == null)
            {
                return false;
            }
            else
            {
                for (int i = 0; i < m_MultiSelectedCamera.Count; i++)
                {
                    if ((m_MultiSelectedCamera[i].SiteName == sDvr) &&
                        (m_MultiSelectedCamera[i].CameraNumber == iCameraNumber))
                    {
                        return true;
                    }
                }                
            }

            return false;
        }        

        private DeviceType IdentifyDeviceType(string sTag)
        {
            if (sTag.IndexOf("[DVR]") == 0)
            {
                return DeviceType.Dvr;
            }

            if (sTag.IndexOf("[VENDOR]") == 0)
            {
                return DeviceType.Camera;
            }

            return DeviceType.Unknown;
        }        

        private bool FillDvrsAndCamerasInformation()
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            //string sResult;

            //int i;
            //int j; 
            //int iIndex;
            //int iCameraIndex;

            #endregion

            //if (m_Source.Logger == null)
            //{
            //    AuditPerform("Loggers Array Is Null", sMethod, AuditSeverity.Warning);

            //    return false;
            //}

            //if (m_Source.Logger.Length == 0)
            //{
            //    AuditPerform("No Loggers", sMethod, AuditSeverity.Warning);

            //    return false;
            //}

            try
            {
                //m_DvrsAndCamerasInformation = new List<Types.DvrInformation>();

                //AuditPerform(m_Source.Logger.Length + " Loggers", sMethod, AuditSeverity.Information);

                //for (i = 0; i < m_Source.Logger.Length; i++)
                //{
                //    Types.DvrInformation di = new Types.DvrInformation(Vendor.Nice,
                //                                                       m_Source.Logger[i].Name,
                //                                                       m_Source.Logger[i].Address.ToString(),
                //                                                       m_Source.Logger[i].ID.ToString(),
                //                                                       m_Source.Logger[i].Version,
                //                                                       false);

                //    if (!TestConnection2Dvr(m_Source.Logger[i].Name))
                //    {
                //        AuditPerform("Dvr[" + m_Source.Logger[i].Name +
                //                     "] Id[" + m_Source.Logger[i].ID +
                //                     "] Address[" + m_Source.Logger[i].Address + "] Unreachable",
                //                     sMethod,
                //                     AuditSeverity.Warning);

                //        continue;
                //    }
                //    else
                //    {
                //        if (!m_Settings.PromiscuousModeOn)
                //        {
                //            AuditPerform("Dvr[" + m_Source.Logger[i].Name +
                //                         "] Id[" + m_Source.Logger[i].ID +
                //                         "] Address[" + m_Source.Logger[i].Address + "] Reachable",
                //                         sMethod,
                //                         AuditSeverity.Important);
                //        }
                //    }

                //    m_DvrsAndCamerasInformation.Add(di);
                //    iIndex = m_DvrsAndCamerasInformation.Count - 1;

                //    if (m_Source.Channels == null)
                //    {
                //        AuditPerform("Channels Array Is Null For DVR[" + m_Source.Logger[i].Name + "]", 
                //                     sMethod, 
                //                     AuditSeverity.Warning);

                //        continue;
                //    }

                //    if (m_Source.Channels[i].Channel == null)
                //    {
                //        AuditPerform("Channels Array Is Null For DVR[" + m_Source.Logger[i].Name + "]", 
                //                     sMethod, 
                //                     AuditSeverity.Warning);

                //        continue;
                //    }

                //    if (m_Source.Channels.Length == 0)
                //    {
                //        AuditPerform("No Channels For DVR[" + m_Source.Logger[i].Name + "]", 
                //                     sMethod, 
                //                     AuditSeverity.Warning);

                //        continue;
                //    }

                //    if (m_Source.Channels[i].Channel.Length == 0)
                //    {
                //        AuditPerform("No Channels For DVR[" + m_Source.Logger[i].Name + "]", 
                //                     sMethod, 
                //                     AuditSeverity.Warning);

                //        continue;
                //    }

                //    AuditPerform(m_Source.Channels[i].Channel.Length + " Channels For DVR[" + m_Source.Logger[i].Name + "]", 
                //                 sMethod, 
                //                 AuditSeverity.Information);

                //    for (j = 0; j < m_Source.Channels[i].Channel.Length; j++)
                //    {
                //        if (m_Source.Channels[i].Channel[j].ServerID == m_Source.Logger[i].ID)
                //        {
                //            Types.CameraInformation ci = new Types.CameraInformation(Vendor.Nice,
                //                                                                     m_Source.Logger[i].Name,
                //                                                                     m_Source.Channels[i].Channel[j].ChannelName,
                //                                                                     m_Source.Channels[i].Channel[j].ServerChannelNO,
                //                                                                     m_Source.Channels[i].Channel[j].ChannelID,
                //                                                                     GetRecordingStatus(m_Source.Logger[i].Name,
                //                                                                                        m_Source.Channels[i].Channel[j].ServerChannelNO),
                //                                                                     GetAnalyzingStatus(m_Source.Logger[i].Name,
                //                                                                                        m_Source.Channels[i].Channel[j].ServerChannelNO),
                //                                                                     GetMotionBitRate(m_Source.Logger[i].Name,
                //                                                                                      m_Source.Channels[i].Channel[j].ServerChannelNO),
                //                                                                     GetNonMotionBitRate(m_Source.Logger[i].Name,
                //                                                                                         m_Source.Channels[i].Channel[j].ServerChannelNO),
                //                                                                     GetFrameRate(m_Source.Logger[i].Name,
                //                                                                                  m_Source.Channels[i].Channel[j].ServerChannelNO),
                //                                                                     GetNonMotionFrameRate(m_Source.Logger[i].Name,
                //                                                                                           m_Source.Channels[i].Channel[j].ServerChannelNO),
                //                                                                     GetCompression(m_Source.Logger[i].Name,
                //                                                                                    m_Source.Channels[i].Channel[j].ServerChannelNO),
                //                                                                     GetChannelVmdCaState(m_Source.Logger[i].Name,
                //                                                                                          m_Source.Channels[i].Channel[j].ServerChannelNO)
                //                                                                     );
                            
                //            m_DvrsAndCamerasInformation[iIndex].AddCameraInformation(ci, 
                //                                                                     out iCameraIndex, 
                //                                                                     out sResult);

                //        }

                //        DoEvents();
                //    }

                //    DoEvents();
                //}

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private void FindNodeInHierarchy(TreeNodeCollection nodes, string strSearchValue)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            for (int iCount = 0; iCount < nodes.Count; iCount++)
            {
                if (nodes[iCount].Text.ToUpper().Contains(strSearchValue.ToUpper()))
                {
                    tv.SelectedNode = nodes[iCount];
                    tv.Select();
                    m_bNodeFound = true;
                    m_NodeFound = tv.SelectedNode;
                    return;
                }
                else
                {
                    m_bNodeFound = false;
                }
                //expand the nodes
                nodes[iCount].Expand();
                //Recursively search the text in the child nodes
                FindNodeInHierarchy(nodes[iCount].Nodes, strSearchValue);
                if (m_bNodeFound)
                {
                    return;
                }
                //collapses the nodes
                nodes[iCount].Collapse();
                //return;
            }
        }

        private void CameraNodeDisplay(int iDvrId,
                                       int iCameraNumber,
                                       int iIconIndex)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (tv.Nodes[0].Nodes == null)
                {
                    return;
                }

                for (int i = 0; i < tv.Nodes[0].Nodes.Count; i++)
                {
                    DvrInformation diDvrInformation = (DvrInformation)(tv.Nodes[0].Nodes[i].Tag);

                    if (diDvrInformation.DvrId == iDvrId)
                    {
                        if (tv.Nodes[0].Nodes[i].Nodes == null)
                        {
                            return;
                        }

                        for (int j = 0; j < tv.Nodes[0].Nodes[i].Nodes.Count; j++)
                        {
                            CameraInformation ciCameraInformation = (CameraInformation)(tv.Nodes[0].Nodes[i].Nodes[j].Tag);

                            if (ciCameraInformation.CameraNumber == iCameraNumber)
                            {
                                tv.Nodes[0].Nodes[i].Nodes[j].ImageIndex = iIconIndex;
                                tv.Nodes[0].Nodes[i].Nodes[j].SelectedImageIndex = iIconIndex;

                                return;
                            }
                        }
                    }
                }   
            }
            catch (Exception e)
            {
                Audit("Dvr[" + iDvrId +
                      "] Camera[" + iCameraNumber +
                      "] Icon Index[" + iIconIndex + 
                      "]. " + 
                      e.Message,
                      sMethod,
                      AuditSeverity.Warning);
            }
        }

        private void CameraNodeDisplay(string sSiteName, 
                                       int iCameraNumber,
                                       ActionToDo action,
                                       object oValue,
                                       string sCalledFrom)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_bClosing)
                {
                    Utils.WriteToDebugView(DvrClientModule.Main, 
                                           sMethod, 
                                           "Closing. Quitting Method. Called From[" + sCalledFrom + "]");

                    return;
                }

                TreeNodeCollection nodes = tv.Nodes;

                foreach (TreeNode n in nodes)
                {
                    FindRecursive(n, sSiteName, iCameraNumber, action, oValue);
                }
            }
            catch (Exception e)
            {
                Audit("Dvr[" + sSiteName + 
                      "] Camera[" + iCameraNumber + 
                      "] Action[" + action.ToString() + 
                      "] Value[" + (int)oValue + "]. " + e.Message, 
                      sMethod, 
                      AuditSeverity.Warning);
            }
        }

        private void FindRecursive(TreeNode treeNode, 
                                   string sSiteName, 
                                   int iCameraNumber,
                                   ActionToDo action,
                                   object oValue)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sCamera = "[DVR]" + sSiteName + "[NUMBER]" + iCameraNumber;

            try
            {
                foreach (TreeNode tn in treeNode.Nodes)
                {
                    string sTag = tn.Tag.ToString();
                    int iPosition = sTag.IndexOf("[DVR]");
                    int iDisplay;
                    int iIconIndex;

                    if (iPosition != DvrClientConstants.NONE)
                    {
                        string sNodeCameraTag = sTag.Substring(iPosition);

                        if (sNodeCameraTag == sCamera)
                        {
                            switch (action)
                            {
                                case ActionToDo.Add:
                                    iDisplay = (int)oValue; 
                                    tn.Text = "[" + iDisplay + "] " + tn.Text;
                                    break;

                                case ActionToDo.Remove:
                                    iPosition = tn.Text.IndexOf("] ");
                                    tn.Text = tn.Text.Substring(iPosition + 2);
                                    break;

                                case ActionToDo.ChangeIcon:
                                    iIconIndex = (int)oValue;
                                    SetTreeNodeIcon(tn, iIconIndex);
                                    break;

                                default:
                                    break;
                            }
                        }

                        FindRecursive(tn, sSiteName, iCameraNumber, action, oValue);
                    }
                }
            }
            catch (Exception e)
            {
                Audit("Dvr[" + sSiteName +
                      "] Camera[" + iCameraNumber +
                      "] Action[" + action.ToString() +
                      "] Value[" + (int)oValue + "]. " + e.Message,
                      sMethod,
                      AuditSeverity.Warning);
            }
        }

        private void m_tmrDvtelWatchdog_Elapsed(object sender, ElapsedEventArgs e)
        {
            m_iDvtelWatchdogCounter--;

            if (m_iDvtelWatchdogCounter == 0)
            {
                m_bWaitForDvtelLoaderToFinish = false;
                m_tmrDvtelWatchdog.Stop();
            }
        }

        public List<Dvr> GetDvrsAndCamerasInfo(string sIpAddress)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sFileName;

            List<Dvr> lDvr;
            
            List<DvrInformation> lDvrsAndCameras;

            #endregion

            lDvr = null;
            sFileName = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) + "\\Afcon.DvrClient.DvrsAndCameras.xml";
            lDvrsAndCameras = Utils.ReadFromXmlFile<List<DvrInformation>>(sFileName);

            if (lDvrsAndCameras != null)
            {
                lDvr = new List<Dvr>();
                for (int iDvrIndex = 0; iDvrIndex < lDvrsAndCameras.Count; iDvrIndex++)
                {
                    Dvr newDvr = new Dvr(Utils.GetVendorPluginName(),
                                         Utils.GetVendorPluginName() + (iDvrIndex + 1),
                                         lDvrsAndCameras[iDvrIndex].Name,
                                         lDvrsAndCameras[iDvrIndex].DvrId);

                    if (lDvrsAndCameras[iDvrIndex].Camera != null)
                    {
                        for (int iCameraIndex = 0; iCameraIndex < lDvrsAndCameras[iDvrIndex].Camera.Count; iCameraIndex++)
                        {
                            newDvr.AddCamera(lDvrsAndCameras[iDvrIndex].Camera[iCameraIndex].Name,
                                             lDvrsAndCameras[iDvrIndex].Camera[iCameraIndex].CameraNumber);
                        }
                    }

                    lDvr.Add(newDvr);
                }
            }

            return lDvr;
        }

        private void SetTreeNodeIcon(TreeNode tn, int iIconIndex)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {                
                if (this.InvokeRequired)
                {
                    this.BeginInvoke(new TwoParamDelegate<TreeNode, int>((SetTreeNodeIcon)),
                                     tn, iIconIndex);                   
                }
                else
                {
                    if (iIconIndex == (int)IconIndex.Camera)
                    {
                        if (IsTreeNodePtzCamera(tn))
                        {
                            tn.ImageIndex = (int)IconIndex.PtzCamera;
                            tn.SelectedImageIndex = (int)IconIndex.PtzCamera;

                            return;
                        }
                    }
                    
                    tn.ImageIndex = iIconIndex;
                    tn.SelectedImageIndex = iIconIndex;                    
                }
            }
            catch (Exception e)
            {
                AuditPerform(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private bool IsTreeNodePtzCamera(TreeNode tn)
        {
            #region Data Members
		    
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sTag;
            string sDvr;
            string sCameraName;

            int iCameraNumber;

            Vendor vVendor; 
	
            #endregion

            if (tn == null)
            {
                return false;
            }

            try
            {
                sTag = tn.Tag.ToString();
                if (Utils.NukeTag(sTag,
                                  out sDvr,
                                  out sCameraName,
                                  out iCameraNumber,
                                  out vVendor))
                {
                    return IsPtzCamera(sDvr, iCameraNumber);
                }

                return false;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
                
                return false;
            }
        }

        private bool DvrsCamerasAndPresetsStructure(List<Dvr> lDvr)
        {
            #region Data Members
            
            StreamWriter swDvrsCamerasAndPresetsStructureFile;

            string sFileName;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sPath = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);

            #endregion

            try
            {
                sFileName = "Dvrs Cameras And Presets Structure " +
                            Utils.Strech(DateTime.Now.Day.ToString()) + "-" +
                            Utils.Strech(DateTime.Now.Month.ToString()) + "-" +
                            DateTime.Now.Year.ToString() + " " +
                            Utils.Strech(DateTime.Now.Hour.ToString()) + "-" +
                            Utils.Strech(DateTime.Now.Minute.ToString()) + "-" +
                            Utils.Strech(DateTime.Now.Second.ToString()) + "." +
                            AuditFileType.Csv;

                swDvrsCamerasAndPresetsStructureFile = new StreamWriter(sPath + 
                                                                        "\\" + 
                                                                        sFileName, true, Encoding.UTF8);

                if (lDvr == null)
                {
                    swDvrsCamerasAndPresetsStructureFile.WriteLine("Dvrs, Cameras And Presets Structure Is Null");
                    swDvrsCamerasAndPresetsStructureFile.Flush();

                    return false;
                }

                swDvrsCamerasAndPresetsStructureFile.WriteLine("Dvr,Camera,Preset,Has Presets");

                for (int iDvrIndex = 0; iDvrIndex < lDvr.Count; iDvrIndex++)
                {
                    swDvrsCamerasAndPresetsStructureFile.WriteLine("DVR ID[" +
                                                                   lDvr[iDvrIndex].Number + "] IP Address[" +
                                                                   lDvr[iDvrIndex].IP + "] DVR Description[" +
                                                                   lDvr[iDvrIndex].Description + "],,,");

                    if (lDvr[iDvrIndex].Cameras != null)
                    {
                        for (int iCameraIndex = 0; iCameraIndex < lDvr[iDvrIndex].Cameras.Count; iCameraIndex++)
                        {
                            swDvrsCamerasAndPresetsStructureFile.WriteLine(",(" +
                                                                           lDvr[iDvrIndex].Cameras[iCameraIndex].Number + ") " +
                                                                           lDvr[iDvrIndex].Cameras[iCameraIndex].Description +
                                                                           ",," + 
                                                                           lDvr[iDvrIndex].Cameras[iCameraIndex].HasPresets);

                            if (lDvr[iDvrIndex].Cameras[iCameraIndex].Preset != null)
                            {
                                for (int iPresetIndex = 0; iPresetIndex < lDvr[iDvrIndex].Cameras[iCameraIndex].Preset.Count; iPresetIndex++)
                                {
                                    swDvrsCamerasAndPresetsStructureFile.WriteLine(",," +
                                                                                    lDvr[iDvrIndex].Cameras[iCameraIndex].Preset[iPresetIndex] + 
                                                                                    ",");
                                }
                            }                            
                        }
                    }
                }

                swDvrsCamerasAndPresetsStructureFile.Flush();

                return true;
            }
            catch (Exception e)
            {
                Utils.WriteToDebugView(DvrClientModule.Main.ToString(), sMethod, e.Message, AuditSeverity.Error.ToString());

                return false;
            }
        }

        private bool DisplayNumberToCameraInTree(ActionToDo aAction, 
                                                 int iDvrId, 
                                                 int iCameraNumber, 
                                                 int iDisplayNumber, 
                                                 out string sResult)
        {
            #region Data Members
            
            TreeNode parent;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            int iPosition;

            #endregion

            sResult = "";

            try
            {
                parent = tv.Nodes[0];

                if (parent.Nodes != null)
                {
                    for (int i = 0; i < parent.Nodes.Count; i++)
                    {
                        DvrInformation di = (DvrInformation)(parent.Nodes[i].Tag);
                        if (di.DvrId == iDvrId)
                        {
                            if (parent.Nodes[i].Nodes != null)
                            {
                                for (int j = 0; j < parent.Nodes[i].Nodes.Count; j++)
                                {
                                    CameraInformation ci = (CameraInformation)(parent.Nodes[i].Nodes[j].Tag);
                                    if (ci.CameraNumber == iCameraNumber)
                                    {
                                        string sCameraTreeNodeText;

                                        sCameraTreeNodeText = "(" + ci.CameraNumber + ") " + ci.Name;

                                        switch (aAction)
                                        {
                                            case ActionToDo.Add:
                                                //parent.Nodes[i].Nodes[j].Text = "[" + (iDisplayNumber + 1) + "] " + sCameraTreeNodeText;
                                                TreeNodeText(parent.Nodes[i].Nodes[j], "[" + (iDisplayNumber + 1) + "] " + sCameraTreeNodeText);
                                                return true;

                                            case ActionToDo.Remove:
                                                iPosition = parent.Nodes[i].Nodes[j].Text.IndexOf("] ");
                                                //parent.Nodes[i].Nodes[j].Text = sCameraTreeNodeText;
                                                TreeNodeText(parent.Nodes[i].Nodes[j], sCameraTreeNodeText);
                                                return true;

                                            default:
                                                sResult = "Wrong Action[" + aAction + "]";
                                                return false;
                                        }
                                    }
                                }
                            }
                            else
                            {
                                sResult = "No Cameras For Dvr[" + di.IpAddress + "]";

                                return false;
                            }
                        }
                    }

                    sResult = "Dvr With ID[" + iDvrId + "] Not Found In Tree.";

                    return false;
                }
                else
                {
                    sResult = "No Dvrs In Tree";

                    return false;
                }
            }
            catch (Exception e)
            {
                sResult = e.Message;
                AuditPerform(sResult, sMethod, AuditSeverity.Error);

                return false;
            } 
        }

        #endregion
        
        #region Context Menu Click Methods

        private void PrepareDvrTreeContextMenu()
        {
            #region Data Members

            int iActiveDisplayIndex;
            int iNumberOfThisCameraPresets;
            int iThisCameraHasPresets;
            int iNumberOfMainMenus;
            int iNumberOfCameras;
            int i;
            int j;
            int k;
            int l;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            if (InvokeRequired)
            {
                BeginInvoke(new EmptyDelegate(PrepareDvrTreeContextMenu));
            }
            else
            {
                try
                {
                    if (m_DvrInformation == null)
                    {
                        Audit("Could Not Get Dvrs And Cameras Information. List Is Null", sMethod, AuditSeverity.Warning);

                        return;
                    }

                    //  How many DVRs exist in the system?
                    m_iNumberOfDvrs = m_DvrInformation.Count;
                    iNumberOfMainMenus = DvrClientConstants.NUMBER_CONTEXT_MENU_ACTIONS + 1; 

                    //  Now create main context menu with main manu actions + DVRs
                    MenuItem[] menuItem;
                    menuItem = new MenuItem[iNumberOfMainMenus];
                    for (i = 0; i < iNumberOfMainMenus; i++)
                    {
                        menuItem[i] = new MenuItem();
                    }

                    menuItem[DvrClientConstants.CONTEXT_MENU_DVRS_AND_CAMERAS].Text = "Dvrs";
                    menuItem[DvrClientConstants.CONTEXT_MENU_DVRS_AND_CAMERAS].Tag = null;
                    menuItem[DvrClientConstants.CONTEXT_MENU_DVRS_AND_CAMERAS].MenuItems.AddRange(CreateDvrsAndCamerasSubMenu());

                    //  Now create main context menu - the DVRs part
                    m_DvrTreeContextMenu = new ContextMenu();
                    m_DvrTreeContextMenu.MenuItems.AddRange(menuItem);


                    //  Main context menu items for open stream. When NO Video they are invisible. 
                    #region Context Menu Event Handlers Settings

                    menuItem[DvrClientConstants.CONTEXT_MENU_CLOSE].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Close";
                    menuItem[DvrClientConstants.CONTEXT_MENU_CLOSE].Click += new EventHandler(ContextMenuCloseCamera_Click);

                    menuItem[DvrClientConstants.CONTEXT_MENU_SWITCH].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Switch To ";
                    menuItem[DvrClientConstants.CONTEXT_MENU_SWITCH].Click += new EventHandler(ContextMenuSwitch_Click);

                    menuItem[DvrClientConstants.CONTEXT_MENU_EXPORT].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Export";
                    menuItem[DvrClientConstants.CONTEXT_MENU_EXPORT].Click += new EventHandler(ExportCamera_Click);

                    menuItem[DvrClientConstants.CONTEXT_MENU_SNAPSHOT].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Snap Shot";
                    menuItem[DvrClientConstants.CONTEXT_MENU_SNAPSHOT].Click += new EventHandler(SnapShot_Click);

                    menuItem[DvrClientConstants.CONTEXT_MENU_VMD_TRIGGERS].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "VMD Triggers";
                    menuItem[DvrClientConstants.CONTEXT_MENU_VMD_TRIGGERS].Click += new EventHandler(VmdTriggers_Click);

                    menuItem[DvrClientConstants.CONTEXT_MENU_CAMERA_INFO].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Camera Information";
                    menuItem[DvrClientConstants.CONTEXT_MENU_CAMERA_INFO].Click += new EventHandler(ContextMenuCameraInformation_Click);

                    menuItem[DvrClientConstants.CONTEXT_MENU_CLOSE_ALL_CAMERAS].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Close All Cameras";
                    menuItem[DvrClientConstants.CONTEXT_MENU_CLOSE_ALL_CAMERAS].Click += new EventHandler(ContextMenuCloseAllCameras_Click);

                    menuItem[DvrClientConstants.CONTEXT_MENU_PRE_DEFINED_VIEWS].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Predefined Views";

                    menuItem[DvrClientConstants.CONTEXT_MENU_INSTANT_PLAYBACK].Text = (m_Settings.Language == Language.Hebrew) ? "  " + m_Settings.PlaybackLastMinutes + "  " : "Playback Last " + m_Settings.PlaybackLastMinutes + " Minutes";
                    menuItem[DvrClientConstants.CONTEXT_MENU_INSTANT_PLAYBACK].Click += new EventHandler(ContextMenuInstantPlayback_Click);

                    menuItem[DvrClientConstants.CONTEXT_MENU_ADD_FREE_TEXT].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Add Free Text";
                    menuItem[DvrClientConstants.CONTEXT_MENU_ADD_FREE_TEXT].Click += new EventHandler(ContextMenuAddFreeText_Click);

                    if (DisplayManager_GetSelectedDisplayModeOn())
                    {
                        menuItem[DvrClientConstants.CONTEXT_MENU_MIN_MAX].Text = (m_Settings.Language == Language.Hebrew) ? "" : "Restore";
                    }
                    else
                    {
                        menuItem[DvrClientConstants.CONTEXT_MENU_MIN_MAX].Text = (m_Settings.Language == Language.Hebrew) ? "" : "Maximize";
                    }
                    menuItem[DvrClientConstants.CONTEXT_MENU_MIN_MAX].Click += new EventHandler(ContextMenuMinMax_Click);

                    switch (triFullScreen)
                    {
                        case Trinar.False:
                            menuItem[DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Full Screen";
                            break;

                        case Trinar.True:
                            menuItem[DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Normal Screen";
                            break;

                        default:
                            menuItem[DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Full Screen";
                            break;
                    }
                    menuItem[DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Click += new EventHandler(ContextMenuFullNormalScreen_Click);

                    menuItem[DvrClientConstants.CONTEXT_MENU_PRESETS].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Presets";

                    iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();
                    if (DisplayManager_DisplayDigitalZoomMode(iActiveDisplayIndex))
                    {
                        menuItem[DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Digital Zoom Off";
                    }
                    else
                    {
                        menuItem[DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Digital Zoom On";
                    }
                    menuItem[DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Click += new EventHandler(ContextMenuDigitalZoomOnOff_Click);

                    #endregion

                    //  The Predefined views in main context menu
                    #region Pre Defined Views In Context Menu

                    menuItem[DvrClientConstants.CONTEXT_MENU_PRE_DEFINED_VIEWS].MenuItems.AddRange(CreatePreDefinedViewsSubMenu());

                    #endregion

                    //for (i = 0; i < m_DisplayInfo.Displays; i++)
                    //{
                    //    m_Picture[i].ContextMenu = m_DvrTreeContextMenu;
                    //}
                }
                catch (Exception e)
                {
                    Audit(e.Message, sMethod, AuditSeverity.Warning);
                }
            }
        }

        //private void PrepareDvrTreeContextMenu()
        //{
        //    #region Data Members

        //    int iActiveDisplayIndex;
        //    int iNumberOfThisCameraPresets;
        //    int iThisCameraHasPresets;
        //    int iNumberOfMainMenus;
        //    int iNumberOfCameras;
        //    int i;
        //    int j;
        //    int k;
        //    int l;

        //    string sMethod = MethodBase.GetCurrentMethod().Name;

        //    #endregion

        //    if (InvokeRequired)
        //    {
        //        BeginInvoke(new EmptyDelegate(PrepareDvrTreeContextMenu));
        //    }
        //    else
        //    {
        //        try
        //        {
        //            if (m_DvrInformation == null)
        //            {
        //                Audit("Could Not Get Dvrs And Cameras Information. List Is Null", sMethod, AuditSeverity.Warning);

        //                return;
        //            }

        //            //  How many DVRs exist in the system?
        //            m_iNumberOfDvrs = m_DvrInformation.Count;
        //            iNumberOfMainMenus = DvrClientConstants.NUMBER_CONTEXT_MENU_ACTIONS + 1;

        //            //  Now create main context menu with main manu actions + DVRs
        //            MenuItem[] menuItem;
        //            menuItem = new MenuItem[iNumberOfMainMenus];
        //            for (i = 0; i < iNumberOfMainMenus; i++)
        //            {
        //                menuItem[i] = new MenuItem();
        //            }

        //            MenuItem[] dvrMenuItem;
        //            dvrMenuItem = new MenuItem[m_iNumberOfDvrs];
        //            for (i = 0; i < m_iNumberOfDvrs; i++)
        //            {
        //                dvrMenuItem[i] = new MenuItem();
        //            }

        //            menuItem[0].Index = 0;
        //            menuItem[0].Text = "Dvrs";
        //            menuItem[0].Tag = null;
        //            menuItem[0].MenuItems.AddRange(dvrMenuItem);

        //            //  Now create main context menu - the DVRs part
        //            m_DvrTreeContextMenu = new ContextMenu();
        //            m_DvrTreeContextMenu.MenuItems.AddRange(menuItem);

        //            //  Itterate all DVRs
        //            for (i = m_iNumberOfDvrs; i > 0; i--)
        //            {
        //                dvrMenuItem[i - 1].Index = 0;
        //                dvrMenuItem[i - 1].Text = m_DvrInformation[i - 1].IpAddress + " - " + m_DvrInformation[i - 1].Name;
        //                dvrMenuItem[i - 1].Tag = m_DvrInformation[i - 1];

        //                #region Cameras Context Menu

        //                MenuItem[] subMenuItem;
        //                iNumberOfCameras = m_DvrInformation[i - 1].Camera.Count;
        //                subMenuItem = new MenuItem[iNumberOfCameras + DvrClientConstants.NUMBER_CONTEXT_CAMRAS_MENU_ACTIONS];
        //                for (j = 0; j < iNumberOfCameras + DvrClientConstants.NUMBER_CONTEXT_CAMRAS_MENU_ACTIONS; j++)
        //                {
        //                    subMenuItem[j] = new MenuItem();
        //                }

        //                dvrMenuItem[i - 1].MenuItems.AddRange(subMenuItem);
        //                for (j = iNumberOfCameras; j > 0; j--)
        //                {
        //                    CameraInformation ci = (CameraInformation)(m_DvrInformation[i - 1].Camera[j - 1]);

        //                    subMenuItem[j - 1].Index = 0;
        //                    subMenuItem[j - 1].Text = "(" + ci.CameraNumber + ") " + ci.Name;
        //                    subMenuItem[j - 1].Tag = ci;
        //                    subMenuItem[j - 1].Click += new EventHandler(subMenuItem_Click);

        //                    #region Action Menu For A Single Camera

        //                    MenuItem[] actionMenuItem;
        //                    iThisCameraHasPresets = (m_DvrInformation[i - 1].Camera[j - 1].HasPresets) ? 1 : 0;
        //                    actionMenuItem = new MenuItem[DvrClientConstants.NUMBER_CONTEXT_SUB_MENU_ACTIONS + iThisCameraHasPresets];
        //                    for (k = 0; k < DvrClientConstants.NUMBER_CONTEXT_SUB_MENU_ACTIONS + iThisCameraHasPresets; k++)
        //                    {
        //                        actionMenuItem[k] = new MenuItem();
        //                    }

        //                    for (k = DvrClientConstants.NUMBER_CONTEXT_SUB_MENU_ACTIONS + iThisCameraHasPresets; k > 0; k--)
        //                    {
        //                        string sMenuItemText;

        //                        bool bHasPresets = false;
        //                        bool bVisible = true;

        //                        MenuItem[] presetsMenuItem;


        //                        switch ((CameraTreeContextMenuAction)k)
        //                        {
        //                            case CameraTreeContextMenuAction.Open:
        //                                sMenuItemText = (m_Settings.Language == Language.Hebrew) ? "" : "Open";
        //                                break;

        //                            case CameraTreeContextMenuAction.Playback:
        //                                sMenuItemText = (m_Settings.Language == Language.Hebrew) ? "" : "Playback";
        //                                break;

        //                            case CameraTreeContextMenuAction.InstantPlayback:
        //                                sMenuItemText = (m_Settings.Language == Language.Hebrew) ? " " : "Instant Playback";
        //                                break;

        //                            case CameraTreeContextMenuAction.OpenOnNewDisplay:
        //                                sMenuItemText = (m_Settings.Language == Language.Hebrew) ? "  " : "Open On New Display";
        //                                break;

        //                            case CameraTreeContextMenuAction.VmdTriggers:
        //                                sMenuItemText = (m_Settings.Language == Language.Hebrew) ? "  " : "VMD Triggers";
        //                                bVisible = false;
        //                                break;

        //                            case CameraTreeContextMenuAction.AddFreeText:
        //                                sMenuItemText = (m_Settings.Language == Language.Hebrew) ? "  " : "Add Free Text";
        //                                bVisible = false;
        //                                break;

        //                            case CameraTreeContextMenuAction.Presets:
        //                                sMenuItemText = (m_Settings.Language == Language.Hebrew) ? " " : "Presets";
        //                                bHasPresets = true;
        //                                break;

        //                            default:
        //                                sMenuItemText = "Unknown";
        //                                break;
        //                        }

        //                        actionMenuItem[k - 1].Index = k;
        //                        actionMenuItem[k - 1].Text = sMenuItemText;
        //                        actionMenuItem[k - 1].Tag = (i - 1) + ":" + (j - 1);
        //                        actionMenuItem[k - 1].Visible = bVisible;

        //                        if (bHasPresets)
        //                        {
        //                            iNumberOfThisCameraPresets = m_DvrInformation[i - 1].Camera[j - 1].Preset.Count;
        //                            presetsMenuItem = new MenuItem[iNumberOfThisCameraPresets];

        //                            for (l = 0; l < iNumberOfThisCameraPresets; l++)
        //                            {
        //                                presetsMenuItem[l] = new MenuItem();
        //                            }

        //                            for (l = iNumberOfThisCameraPresets; l > 0; l--)
        //                            {
        //                                presetsMenuItem[l - 1].Index = l;
        //                                presetsMenuItem[l - 1].Text = "(" + l + ") " + m_DvrInformation[i - 1].Camera[j - 1].Preset[l - 1];
        //                                presetsMenuItem[l - 1].Tag = m_DvrInformation[i - 1].IpAddress + ":" +
        //                                                             m_DvrInformation[i - 1].Camera[j - 1].CameraNumber + ":" +
        //                                                             m_DvrInformation[i - 1].Camera[j - 1].Preset[l - 1];
        //                                presetsMenuItem[l - 1].Click += new EventHandler(presetsMenuItem_Click);
        //                            }

        //                            actionMenuItem[k - 1].MenuItems.AddRange(presetsMenuItem);
        //                        }
        //                        else
        //                        {
        //                            actionMenuItem[k - 1].Click += new EventHandler(actionMenuItem_Click);
        //                        }
        //                    }

        //                    subMenuItem[j - 1].MenuItems.AddRange(actionMenuItem);

        //                    #endregion
        //                }

        //                #endregion

        //                //  Close All Cameras For Dvr
        //                subMenuItem[iNumberOfCameras].Tag = m_DvrInformation[i - 1];
        //                if (m_Settings.Language == Language.Hebrew)
        //                {
        //                    subMenuItem[iNumberOfCameras].Text = "'" + m_DvrInformation[i - 1].IpAddress + "   ";
        //                }
        //                else
        //                {
        //                    subMenuItem[iNumberOfCameras].Text = "Close All DVR '" + m_DvrInformation[i - 1].IpAddress + " - " + m_DvrInformation[i - 1].Name + "' Cameras";
        //                }
        //                subMenuItem[iNumberOfCameras].Click += new EventHandler(ContextMenuCloseAllDvrCameras_Click);

        //                //  Dvr Information
        //                subMenuItem[iNumberOfCameras + 1].Tag = m_DvrInformation[i - 1];
        //                if (m_Settings.Language == Language.Hebrew)
        //                {
        //                    subMenuItem[iNumberOfCameras + 1].Text = "'" + m_DvrInformation[i - 1].IpAddress + "'  ";
        //                }
        //                else
        //                {
        //                    subMenuItem[iNumberOfCameras + 1].Text = "DVR '" + m_DvrInformation[i - 1].IpAddress + "' Information";
        //                }
        //                subMenuItem[iNumberOfCameras + 1].Click += new EventHandler(ContextMenuDvrInfo_Click);
        //            }

        //            //  Main context menu items for open stream. When NO Video they are invisible. 
        //            #region Context Menu Event Handlers Settings

        //            menuItem[m_iNumberOfDvrs].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Close";
        //            menuItem[m_iNumberOfDvrs].Click += new EventHandler(ContextMenuCloseCamera_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_SWITCH].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Switch To ";
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_SWITCH].Click += new EventHandler(ContextMenuSwitch_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_EXPORT].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Export";
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_EXPORT].Click += new EventHandler(ExportCamera_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_SNAPSHOT].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Snap Shot";
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_SNAPSHOT].Click += new EventHandler(SnapShot_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_VMD_TRIGGERS].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "VMD Triggers";
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_VMD_TRIGGERS].Click += new EventHandler(VmdTriggers_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_CAMERA_INFO].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Camera Information";
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_CAMERA_INFO].Click += new EventHandler(ContextMenuCameraInformation_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_CLOSE_ALL_CAMERAS].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Close All Cameras";
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_CLOSE_ALL_CAMERAS].Click += new EventHandler(ContextMenuCloseAllCameras_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_PRE_DEFINED_VIEWS].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Predefined Views";

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_INSTANT_PLAYBACK].Text = (m_Settings.Language == Language.Hebrew) ? "  " + m_Settings.PlaybackLastMinutes + "  " : "Playback Last " + m_Settings.PlaybackLastMinutes + " Minutes";
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_INSTANT_PLAYBACK].Click += new EventHandler(ContextMenuInstantPlayback_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_ADD_FREE_TEXT].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Add Free Text";
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_ADD_FREE_TEXT].Click += new EventHandler(ContextMenuAddFreeText_Click);

        //            if (DisplayManager_GetSelectedDisplayModeOn())
        //            {
        //                menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_MIN_MAX].Text = (m_Settings.Language == Language.Hebrew) ? "" : "Restore";
        //            }
        //            else
        //            {
        //                menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_MIN_MAX].Text = (m_Settings.Language == Language.Hebrew) ? "" : "Maximize";
        //            }
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_MIN_MAX].Click += new EventHandler(ContextMenuMinMax_Click);

        //            switch (triFullScreen)
        //            {
        //                case Trinar.False:
        //                    menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Full Screen";
        //                    break;

        //                case Trinar.True:
        //                    menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Normal Screen";
        //                    break;

        //                default:
        //                    menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Full Screen";
        //                    break;
        //            }
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Click += new EventHandler(ContextMenuFullNormalScreen_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_PRESETS].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Presets";

        //            iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();
        //            if (DisplayManager_DisplayDigitalZoomMode(iActiveDisplayIndex))
        //            {
        //                menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Digital Zoom Off";
        //            }
        //            else
        //            {
        //                menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Digital Zoom On";
        //            }
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Click += new EventHandler(ContextMenuDigitalZoomOnOff_Click);

        //            #endregion

        //            //  The Predefined views in main context menu
        //            #region Pre Defined Views In Context Menu

        //            MenuItem[] preDefinedView;
        //            int iNumberOfPreDefinedViews = m_PreDefinedView.Count;
        //            preDefinedView = new MenuItem[iNumberOfPreDefinedViews + 1];

        //            for (k = 0; k <= iNumberOfPreDefinedViews; k++)
        //            {
        //                preDefinedView[k] = new MenuItem();
        //            }

        //            for (k = iNumberOfPreDefinedViews; k > 0; k--)
        //            {
        //                preDefinedView[k - 1].Index = k;
        //                preDefinedView[k - 1].Text = m_PreDefinedView[k - 1].Name;
        //                preDefinedView[k - 1].Tag = m_PreDefinedView[k - 1].Name;
        //                preDefinedView[k - 1].Click += new EventHandler(ContextMenuPredefinedViews_Click);
        //            }

        //            preDefinedView[iNumberOfPreDefinedViews].Index = k + 1;
        //            preDefinedView[iNumberOfPreDefinedViews].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Add Predefined View"; ;
        //            preDefinedView[iNumberOfPreDefinedViews].Tag = "Add Pre Defined View";
        //            preDefinedView[iNumberOfPreDefinedViews].Click += new EventHandler(ContextMenuAddPredefinedView_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_PRE_DEFINED_VIEWS].MenuItems.AddRange(preDefinedView);

        //            #endregion

        //            for (i = 0; i < m_DisplayInfo.Displays; i++)
        //            {
        //                m_Picture[i].ContextMenu = m_DvrTreeContextMenu;
        //            }
        //        }
        //        catch (Exception e)
        //        {
        //            Audit(e.Message, sMethod, AuditSeverity.Warning);
        //        }
        //    }
        //}

        private void ArrangeContextMenuForNoVideo()
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                if (m_DvrTreeContextMenu == null)
                {
                    return;
                }

                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_CLOSE].Visible = false;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_SWITCH].Visible = false;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_INSTANT_PLAYBACK].Visible = false;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_EXPORT].Visible = false;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_SNAPSHOT].Visible = false;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_VMD_TRIGGERS].Visible = false;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_CLOSE_ALL_CAMERAS].Visible = false;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_CAMERA_INFO].Visible = false;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_MIN_MAX].Visible = false;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_ADD_FREE_TEXT].Visible = false;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Visible = false;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_CAMERA_INFO].Visible = false;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_PRESETS].Visible = false;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Visible = false;

                //m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_PRESETS].Visible = true;
                //m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_DVRS_AND_CAMERAS].Visible = true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void ArrangeContextMenuForVideo()
        {
        }

        private void PrepareNoVideoConextMenu()
        {
            #region Data Members

            int iActiveDisplayIndex;
            int iNumberOfThisCameraPresets;
            int iThisCameraHasPresets;
            int iNumberOfMainMenus;
            int iNumberOfCameras;
            int i;
            int j;
            int k;
            int l;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion


            if (InvokeRequired)
            {
                BeginInvoke(new EmptyDelegate(PrepareNoVideoConextMenu));
            }
            else
            {
                try
                {
                    if (m_DvrInformation == null)
                    {
                        Audit("Could Not Get Dvrs And Cameras Information. List Is Null", sMethod, AuditSeverity.Warning);

                        return;
                    }
                }
                catch (Exception e)
                {
                }
            }
        }

        private void PrepareVideoConextMenu()
        {
            #region Data Members

            int iActiveDisplayIndex;
            int iNumberOfThisCameraPresets;
            int iThisCameraHasPresets;
            int iNumberOfMainMenus;
            int iNumberOfCameras;
            int i;
            int j;
            int k;
            int l;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            if (InvokeRequired)
            {
                BeginInvoke(new EmptyDelegate(PrepareVideoConextMenu));
            }
            else
            {
                try
                {
                    if (m_DvrInformation == null)
                    {
                        Audit("Could Not Get Dvrs And Cameras Information. List Is Null", sMethod, AuditSeverity.Warning);

                        return;
                    }
                }
                catch (Exception e)
                {
                }
            }
        }

        private MenuItem[] CreateDvrsAndCamerasSubMenu()
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sMenuItemText;

            MenuItem[] dvrsMenuItem;
            MenuItem[] camerasMenuItem;
            MenuItem[] actionMenuItem;
            MenuItem[] presetsMenuItem;

            int iNumberOfDvrs;
            int iNumberOfCameras;
            int iThisCameraHasPresets;
            int iNumberOfCameraActions;
            int iNumberOfThisCameraPresets;

            bool bVisible;
            bool bHasPresets;

            #endregion

            try
            {
                if (m_DvrInformation == null)
                {
                    Audit("Could Not Get Dvrs And Cameras Information. List Is Null", sMethod, AuditSeverity.Warning);

                    return null;
                }

                //  How many DVRs exist in the system?
                iNumberOfDvrs = m_DvrInformation.Count;

                dvrsMenuItem = new MenuItem[m_iNumberOfDvrs];
                for (int i = 0; i < m_iNumberOfDvrs; i++)
                {
                    dvrsMenuItem[i] = new MenuItem();

                    dvrsMenuItem[i].Text = m_DvrInformation[i].IpAddress + " - " + m_DvrInformation[i].Name;
                    dvrsMenuItem[i].Tag = m_DvrInformation[i];

                    #region Cameras

                    if (m_DvrInformation[i].Camera != null)
                    {
                        iNumberOfCameras = m_DvrInformation[i].Camera.Count;

                        camerasMenuItem = new MenuItem[iNumberOfCameras];
                        for (int j = 0; j < m_DvrInformation[i].Camera.Count; j++)
                        {
                            CameraInformation ciCameraInformation = (CameraInformation)(m_DvrInformation[i].Camera[j]);

                            camerasMenuItem[j] = new MenuItem();

                            camerasMenuItem[j].Text = "(" + ciCameraInformation.CameraNumber + ") " + ciCameraInformation.Name;
                            camerasMenuItem[j].Tag = ciCameraInformation;
                            camerasMenuItem[j].Click += new EventHandler(subMenuItem_Click);

                            #region Action Menu For A Single Camera

                            iThisCameraHasPresets = (m_DvrInformation[i].Camera[j].HasPresets) ? 1 : 0;
                            iNumberOfCameraActions = DvrClientConstants.NUMBER_CONTEXT_SUB_MENU_ACTIONS + iThisCameraHasPresets;
                            actionMenuItem = new MenuItem[iNumberOfCameraActions];
                            for (int k = 1; k <= iNumberOfCameraActions; k++)
                            {
                                actionMenuItem[k - 1] = new MenuItem();

                                bVisible = true;
                                bHasPresets = false;

                                switch ((CameraTreeContextMenuAction)k)
                                {
                                    case CameraTreeContextMenuAction.Open:
                                        sMenuItemText = (m_Settings.Language == Language.Hebrew) ? "" : "Open";
                                        break;

                                    case CameraTreeContextMenuAction.Playback:
                                        sMenuItemText = (m_Settings.Language == Language.Hebrew) ? "" : "Playback";
                                        break;

                                    case CameraTreeContextMenuAction.InstantPlayback:
                                        sMenuItemText = (m_Settings.Language == Language.Hebrew) ? " " : "Instant Playback";
                                        break;

                                    case CameraTreeContextMenuAction.OpenOnNewDisplay:
                                        sMenuItemText = (m_Settings.Language == Language.Hebrew) ? "  " : "Open On New Display";
                                        break;

                                    case CameraTreeContextMenuAction.VmdTriggers:
                                        sMenuItemText = (m_Settings.Language == Language.Hebrew) ? "  " : "VMD Triggers";
                                        bVisible = false;
                                        break;

                                    case CameraTreeContextMenuAction.AddFreeText:
                                        sMenuItemText = (m_Settings.Language == Language.Hebrew) ? "  " : "Add Free Text";
                                        bVisible = false;
                                        break;

                                    case CameraTreeContextMenuAction.Presets:
                                        sMenuItemText = (m_Settings.Language == Language.Hebrew) ? " " : "Presets";
                                        bHasPresets = true;
                                        break;

                                    default:
                                        sMenuItemText = "Unknown";
                                        bVisible = false;
                                        break;
                                }

                                actionMenuItem[k - 1].Text = sMenuItemText;
                                actionMenuItem[k - 1].Tag = i + ":" + j;
                                actionMenuItem[k - 1].Visible = bVisible;

                                #region Presets

                                if (bHasPresets)
                                {
                                    if (m_DvrInformation[i].Camera[j].Preset != null)
                                    {
                                        iNumberOfThisCameraPresets = m_DvrInformation[i].Camera[j].Preset.Count;
                                        presetsMenuItem = new MenuItem[iNumberOfThisCameraPresets];

                                        for (int l = 0; l < iNumberOfThisCameraPresets; l++)
                                        {
                                            presetsMenuItem[l] = new MenuItem();

                                            presetsMenuItem[l].Text = "(" + (l + 1) + ") " + m_DvrInformation[i].Camera[j].Preset[l];
                                            presetsMenuItem[l].Tag = m_DvrInformation[i].Camera[j].Preset[l];
                                            presetsMenuItem[l].Click += new EventHandler(presetsMenuItem_Click);
                                        }

                                        actionMenuItem[k - 1].MenuItems.AddRange(presetsMenuItem);
                                    }
                                }
                                else
                                {
                                    actionMenuItem[k - 1].Click += new EventHandler(actionMenuItem_Click);
                                }

                                #endregion

                            }

                            camerasMenuItem[j].MenuItems.AddRange(actionMenuItem);
                            
                            #endregion

                        }

                        dvrsMenuItem[i].MenuItems.AddRange(camerasMenuItem);
                    }

                    #endregion
                }

                return dvrsMenuItem;
            }
            catch (Exception e)
            {
                return null;
            }
        }

        private MenuItem[] CreatePreDefinedViewsSubMenu()
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            MenuItem[] pdvMenuItem;

            int iNumberOfPreDefinedViews;

            #endregion

            try
            {
                iNumberOfPreDefinedViews = (m_PreDefinedView == null) ? 0 : m_PreDefinedView.Count;
                pdvMenuItem = new MenuItem[iNumberOfPreDefinedViews + 1];

                for (int k = 0; k <= iNumberOfPreDefinedViews; k++)
                {
                    pdvMenuItem[k] = new MenuItem();

                    if (k == iNumberOfPreDefinedViews)
                    {
                        pdvMenuItem[iNumberOfPreDefinedViews].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Add Predefined View"; ;
                        pdvMenuItem[iNumberOfPreDefinedViews].Click += new EventHandler(ContextMenuAddPredefinedView_Click);
                    }
                    else
                    {
                        pdvMenuItem[k].Text = m_PreDefinedView[k].Name;
                        pdvMenuItem[k].Tag = m_PreDefinedView[k].Name;
                        pdvMenuItem[k].Click += new EventHandler(ContextMenuPredefinedViews_Click);
                    }
                }

                return pdvMenuItem;
            }
            catch (Exception e)
            {
                return null;
            }
        }

        //private void PrepareDvrTreeContextMenu()
        //{
        //    #region Data Members

        //    int iActiveDisplayIndex;
        //    int iNumberOfThisCameraPresets;
        //    int iThisCameraHasPresets;
        //    int iNumberOfMainMenus;
        //    int iNumberOfCameras;
        //    int i;
        //    int j;
        //    int k;
        //    int l;

        //    string sMethod = MethodBase.GetCurrentMethod().Name; 

        //    #endregion

        //    if (InvokeRequired)
        //    {
        //        BeginInvoke(new EmptyDelegate(CreateTree));
        //    }
        //    else
        //    {
        //        try
        //        {
        //            if (m_DvrInformation == null)
        //            {
        //                Audit("Could Not Get Dvrs And Cameras Information. List Is Null", sMethod, AuditSeverity.Warning);

        //                return;
        //            }

        //            //  How many DVRs exist in the system?
        //            m_iNumberOfDvrs = m_DvrInformation.Count;
        //            iNumberOfMainMenus = m_iNumberOfDvrs + DvrClientConstants.NUMBER_CONTEXT_MENU_ACTIONS;

        //            //  Now create main context menu with main manu actions + DVRs
        //            MenuItem[] menuItem;
        //            menuItem = new MenuItem[iNumberOfMainMenus];
        //            for (i = 0; i < iNumberOfMainMenus; i++)
        //            {
        //                menuItem[i] = new MenuItem();
        //            }

        //            //  Now create main context menu - the DVRs part
        //            m_DvrTreeContextMenu = new ContextMenu();
        //            m_DvrTreeContextMenu.MenuItems.AddRange(menuItem);

        //            //  Itterate all DVRs
        //            for (i = (iNumberOfMainMenus - DvrClientConstants.NUMBER_CONTEXT_MENU_ACTIONS); i > 0; i--)
        //            {
        //                menuItem[i - 1].Index = 0;
        //                menuItem[i - 1].Text = m_DvrInformation[i - 1].IpAddress + " - " + m_DvrInformation[i - 1].Name;
        //                menuItem[i - 1].Tag = m_DvrInformation[i - 1];

        //                #region Cameras Context Menu

        //                MenuItem[] subMenuItem;
        //                iNumberOfCameras = m_DvrInformation[i - 1].Camera.Count;
        //                subMenuItem = new MenuItem[iNumberOfCameras + DvrClientConstants.NUMBER_CONTEXT_CAMRAS_MENU_ACTIONS];
        //                for (j = 0; j < iNumberOfCameras + DvrClientConstants.NUMBER_CONTEXT_CAMRAS_MENU_ACTIONS; j++)
        //                {
        //                    subMenuItem[j] = new MenuItem();
        //                }

        //                menuItem[i - 1].MenuItems.AddRange(subMenuItem);
        //                for (j = iNumberOfCameras; j > 0; j--)
        //                {
        //                    CameraInformation ci = (CameraInformation)(m_DvrInformation[i - 1].Camera[j - 1]);

        //                    subMenuItem[j - 1].Index = 0;
        //                    subMenuItem[j - 1].Text = "(" + ci.CameraNumber + ") " + ci.Name;
        //                    subMenuItem[j - 1].Tag = ci;
        //                    subMenuItem[j - 1].Click += new EventHandler(subMenuItem_Click);

        //                    #region Action Menu For A Single Camera

        //                    MenuItem[] actionMenuItem;
        //                    iThisCameraHasPresets = (m_DvrInformation[i - 1].Camera[j - 1].HasPresets) ? 1 : 0;
        //                    actionMenuItem = new MenuItem[DvrClientConstants.NUMBER_CONTEXT_SUB_MENU_ACTIONS + iThisCameraHasPresets];
        //                    for (k = 0; k < DvrClientConstants.NUMBER_CONTEXT_SUB_MENU_ACTIONS + iThisCameraHasPresets; k++)
        //                    {
        //                        actionMenuItem[k] = new MenuItem();
        //                    }

        //                    for (k = DvrClientConstants.NUMBER_CONTEXT_SUB_MENU_ACTIONS + iThisCameraHasPresets; k > 0; k--)
        //                    {
        //                        string sMenuItemText;

        //                        bool bHasPresets = false;
        //                        bool bVisible = true;

        //                        MenuItem[] presetsMenuItem;


        //                        switch ((CameraTreeContextMenuAction)k)
        //                        {
        //                            case CameraTreeContextMenuAction.Open:
        //                                sMenuItemText = (m_Settings.Language == Language.Hebrew) ? "" : "Open";
        //                                break;

        //                            case CameraTreeContextMenuAction.Playback:
        //                                sMenuItemText = (m_Settings.Language == Language.Hebrew) ? "" : "Playback";
        //                                break;

        //                            case CameraTreeContextMenuAction.InstantPlayback:
        //                                sMenuItemText = (m_Settings.Language == Language.Hebrew) ? " " : "Instant Playback";
        //                                break;

        //                            case CameraTreeContextMenuAction.OpenOnNewDisplay:
        //                                sMenuItemText = (m_Settings.Language == Language.Hebrew) ? "  " : "Open On New Display";
        //                                break;

        //                            case CameraTreeContextMenuAction.VmdTriggers:
        //                                sMenuItemText = (m_Settings.Language == Language.Hebrew) ? "  " : "VMD Triggers";
        //                                bVisible = false;
        //                                break;

        //                            case CameraTreeContextMenuAction.AddFreeText:
        //                                sMenuItemText = (m_Settings.Language == Language.Hebrew) ? "  " : "Add Free Text";
        //                                bVisible = false;
        //                                break;

        //                            case CameraTreeContextMenuAction.Presets:
        //                                sMenuItemText = (m_Settings.Language == Language.Hebrew) ? " " : "Presets";
        //                                bHasPresets = true;
        //                                break;

        //                            default:
        //                                sMenuItemText = "Unknown";
        //                                break;
        //                        }

        //                        actionMenuItem[k - 1].Index = k;
        //                        actionMenuItem[k - 1].Text = sMenuItemText;
        //                        actionMenuItem[k - 1].Tag = (i - 1) + ":" + (j - 1);
        //                        actionMenuItem[k - 1].Visible = bVisible;                                

        //                        if (bHasPresets)
        //                        {
        //                            iNumberOfThisCameraPresets = m_DvrInformation[i - 1].Camera[j - 1].Preset.Count;
        //                            presetsMenuItem = new MenuItem[iNumberOfThisCameraPresets];

        //                            for (l = 0; l < iNumberOfThisCameraPresets; l++)
        //                            {
        //                                presetsMenuItem[l] = new MenuItem();
        //                            }

        //                            for (l = iNumberOfThisCameraPresets; l > 0; l--)
        //                            {
        //                                presetsMenuItem[l - 1].Index = l;
        //                                presetsMenuItem[l - 1].Text = "(" + l + ") " + m_DvrInformation[i - 1].Camera[j - 1].Preset[l - 1];
        //                                presetsMenuItem[l - 1].Tag = m_DvrInformation[i - 1].IpAddress + ":" +
        //                                                             m_DvrInformation[i - 1].Camera[j - 1].CameraNumber + ":" +
        //                                                             m_DvrInformation[i - 1].Camera[j - 1].Preset[l - 1];
        //                                presetsMenuItem[l - 1].Click += new EventHandler(presetsMenuItem_Click);
        //                            }

        //                            actionMenuItem[k - 1].MenuItems.AddRange(presetsMenuItem);
        //                        }
        //                        else
        //                        {
        //                            actionMenuItem[k - 1].Click += new EventHandler(actionMenuItem_Click);
        //                        }
        //                    }

        //                    subMenuItem[j - 1].MenuItems.AddRange(actionMenuItem);

        //                    #endregion
        //                }

        //                #endregion

        //                //  Close All Cameras For Dvr
        //                subMenuItem[iNumberOfCameras].Tag = m_DvrInformation[i - 1];
        //                if (m_Settings.Language == Language.Hebrew)
        //                {
        //                    subMenuItem[iNumberOfCameras].Text = "'" + m_DvrInformation[i - 1].IpAddress + "   ";
        //                }
        //                else
        //                {
        //                    subMenuItem[iNumberOfCameras].Text = "Close All DVR '" + m_DvrInformation[i - 1].IpAddress + " - " + m_DvrInformation[i - 1].Name + "' Cameras";
        //                }
        //                subMenuItem[iNumberOfCameras].Click += new EventHandler(ContextMenuCloseAllDvrCameras_Click);

        //                //  Dvr Information
        //                subMenuItem[iNumberOfCameras + 1].Tag = m_DvrInformation[i - 1];
        //                if (m_Settings.Language == Language.Hebrew)
        //                {
        //                    subMenuItem[iNumberOfCameras + 1].Text = "'" + m_DvrInformation[i - 1].IpAddress + "'  ";
        //                }
        //                else
        //                {
        //                    subMenuItem[iNumberOfCameras + 1].Text = "DVR '" + m_DvrInformation[i - 1].IpAddress + "' Information";
        //                }
        //                subMenuItem[iNumberOfCameras + 1].Click += new EventHandler(ContextMenuDvrInfo_Click);
        //            }

        //            //  Main context menu items for open stream. When NO Video they are invisible. 
        //            #region Context Menu Event Handlers Settings

        //            menuItem[m_iNumberOfDvrs].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Close";
        //            menuItem[m_iNumberOfDvrs].Click += new EventHandler(ContextMenuCloseCamera_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_SWITCH].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Switch To ";
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_SWITCH].Click += new EventHandler(ContextMenuSwitch_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_EXPORT].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Export";
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_EXPORT].Click += new EventHandler(ExportCamera_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_SNAPSHOT].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Snap Shot";
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_SNAPSHOT].Click += new EventHandler(SnapShot_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_VMD_TRIGGERS].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "VMD Triggers";
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_VMD_TRIGGERS].Click += new EventHandler(VmdTriggers_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_CAMERA_INFO].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Camera Information";
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_CAMERA_INFO].Click += new EventHandler(ContextMenuCameraInformation_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_CLOSE_ALL_CAMERAS].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Close All Cameras";
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_CLOSE_ALL_CAMERAS].Click += new EventHandler(ContextMenuCloseAllCameras_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_PRE_DEFINED_VIEWS].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Predefined Views";

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_INSTANT_PLAYBACK].Text = (m_Settings.Language == Language.Hebrew) ? "  " + m_Settings.PlaybackLastMinutes + "  " : "Playback Last " + m_Settings.PlaybackLastMinutes + " Minutes";
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_INSTANT_PLAYBACK].Click += new EventHandler(ContextMenuInstantPlayback_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_ADD_FREE_TEXT].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Add Free Text";
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_ADD_FREE_TEXT].Click += new EventHandler(ContextMenuAddFreeText_Click);

        //            if (DisplayManager_GetSelectedDisplayModeOn())
        //            {
        //                menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_MIN_MAX].Text = (m_Settings.Language == Language.Hebrew) ? "" : "Restore";
        //            }
        //            else
        //            {
        //                menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_MIN_MAX].Text = (m_Settings.Language == Language.Hebrew) ? "" : "Maximize";
        //            }
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_MIN_MAX].Click += new EventHandler(ContextMenuMinMax_Click);

        //            switch (triFullScreen)
        //            {
        //                case Trinar.False:
        //                    menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Full Screen";
        //                    break;

        //                case Trinar.True:
        //                    menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Normal Screen";
        //                    break;

        //                default:
        //                    menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Full Screen";
        //                    break;
        //            }
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Click += new EventHandler(ContextMenuFullNormalScreen_Click);

        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_PRESETS].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Presets";

        //            iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();
        //            if (DisplayManager_DisplayDigitalZoomMode(iActiveDisplayIndex))
        //            {
        //                menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Digital Zoom Off";
        //            }
        //            else
        //            {
        //                menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Digital Zoom On";
        //            }
        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Click += new EventHandler(ContextMenuDigitalZoomOnOff_Click);

        //            #endregion

        //            //  The Predefined views in main context menu
        //            #region Pre Defined Views In Context Menu

        //            MenuItem[] preDefinedView;
        //            int iNumberOfPreDefinedViews = m_PreDefinedView.Count;
        //            preDefinedView = new MenuItem[iNumberOfPreDefinedViews + 1];

        //            for (k = 0; k <= iNumberOfPreDefinedViews; k++)
        //            {
        //                preDefinedView[k] = new MenuItem();
        //            }

        //            for (k = iNumberOfPreDefinedViews; k > 0; k--)
        //            {
        //                preDefinedView[k - 1].Index = k;
        //                preDefinedView[k - 1].Text = m_PreDefinedView[k - 1].Name;
        //                preDefinedView[k - 1].Tag = m_PreDefinedView[k - 1].Name;
        //                preDefinedView[k - 1].Click += new EventHandler(ContextMenuPredefinedViews_Click);
        //            }

        //            preDefinedView[iNumberOfPreDefinedViews].Index = k + 1;
        //            preDefinedView[iNumberOfPreDefinedViews].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Add Predefined View"; ;
        //            preDefinedView[iNumberOfPreDefinedViews].Tag = "Add Pre Defined View";
        //            preDefinedView[iNumberOfPreDefinedViews].Click += new EventHandler(ContextMenuAddPredefinedView_Click);


        //            menuItem[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_PRE_DEFINED_VIEWS].MenuItems.AddRange(preDefinedView);

        //            #endregion

        //            for (i = 0; i < m_DisplayInfo.Displays; i++)
        //            {
        //                m_Picture[i].ContextMenu = m_DvrTreeContextMenu;
        //            }
        //        }
        //        catch (Exception e)
        //        {
        //            Audit(e.Message, sMethod, AuditSeverity.Warning);
        //        }
        //    }
        //}                        

        private void subMenuItem_Click(object sender, EventArgs e)
        {
            #region Data Members
            
            int iCameraNumber;
            int iDvrGroupId;
            int iDvrId;

            string sDvr;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sMessage;
            string sTag;

            DvrInformation di;

            CameraInformation ci = (CameraInformation)sender; 

            #endregion

            iDvrGroupId = 0;
            iDvrId = 0;//di.DvrId;
            iCameraNumber = ci.CameraNumber;

            sMessage = "Camera Number: " + iCameraNumber;
            sMessage = "Opening From Display Context Menu " + sMessage;
            Audit(sMessage, sMethod, AuditSeverity.Information);
            StartCamera_X_on_Display_Y(ci,
                                       m_TreeViewContextMenuDisplayIndex,
                                       DvrClientConstants.NONE,
                                       "",
                                       true);                    
        }

        private void presetsMenuItem_Click(object sender, EventArgs e)
        {
            #region Data Members

            int iCameraNumber;

            string sDvr;
            string sMessage;
            string sPresetName;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sTag;
            string sPreset;

            MenuItem mi = (MenuItem)sender;

            #endregion

            try
            {
                Type tType = mi.Tag.GetType();

                if (tType == typeof(string))
                {
                    sPreset = mi.Tag.ToString();
                    if (sPreset == "<NONE>")
                    {
                        return;
                    }

                    if (ActivatePreset(sPreset))
                    {
                        cboDvrPresets.Text = cboDvrPresets.Items[0].ToString();
                    }
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void actionMenuItem_Click(object sender, EventArgs e)
        {
            #region Data Members

            int iDvrGroupId;
            int iDvrId;
            int iCameraNumber;
            int iDisplayIndex;
            int iDvrIndex;
            int iCameraIndex;

            string sDvr;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sMessage;
            string sTag;
            string sCameraName;
            string sSiteAddress;

            CameraTreeContextMenuAction ctcma;

            MenuItem mi;

            object ot;

            CameraInformation ciCameraInformation;

            DvrInformation diDvrInformation;

            #endregion

            mi = (MenuItem)sender;
            sTag = mi.Tag.ToString();

            iDvrIndex = int.Parse(Utils.GetNthSubString(sTag, ":", 1));
            iCameraIndex = int.Parse(Utils.GetNthSubString(sTag, ":", 2));

            diDvrInformation = m_DvrInformation[iDvrIndex];
            ciCameraInformation = m_DvrInformation[iDvrIndex].Camera[iCameraIndex];

            iDvrGroupId = diDvrInformation.ServerGroupId;
            iDvrId = diDvrInformation.DvrId;
            iCameraNumber = ciCameraInformation.CameraNumber;
            sCameraName = ciCameraInformation.Name;

            ctcma = (CameraTreeContextMenuAction)(mi.Index + 1);

            switch (ctcma)
            {
                case CameraTreeContextMenuAction.Open:
                    #region Open Camera

                    sMessage = "Camera: (" + iCameraNumber + ") " + sCameraName;
                    sMessage += " Opening In Display[" + (m_TreeViewContextMenuDisplayIndex + 1) + "] From Display Context Menu " + sMessage;
                    Audit(sMessage, sMethod, AuditSeverity.Information);
                    StartCamera_X_on_Display_Y(ciCameraInformation,
                                               m_TreeViewContextMenuDisplayIndex,
                                               DvrClientConstants.NONE,
                                               "",
                                               true); 

                    #endregion
                    break;


                case CameraTreeContextMenuAction.OpenOnNewDisplay:
                    #region Open Camera On New Display
                    
                    sMessage = "Camera: (" + iCameraNumber + ") " + sCameraName;
                    sMessage += " Opening From Display Context Menu " + sMessage;
                    Audit(sMessage, sMethod, AuditSeverity.Information);
                    StartCamera(ciCameraInformation, DvrClientConstants.NONE, "", true); 

                    #endregion
                    break;


                case CameraTreeContextMenuAction.Playback:
                    #region Playback

                    sMessage = "Camera: " + iCameraNumber +
                              "  Display: " + m_TreeViewContextMenuDisplayIndex;
                    sMessage = "Playback From Display Context Menu " + sMessage;
                    Audit(sMessage, sMethod, AuditSeverity.Information);
                    
                    m_PlaybackSearchParameters = new PlaybackSearchParameters();

                    m_PlaybackSearchParameters.Camera = ciCameraInformation;
                    m_PlaybackSearchParameters.Main = this;
                    m_PlaybackSearchParameters.Language = m_Settings.Language;
                    m_PlaybackSearchParameters.MaxDisplaysNumber = m_Settings.MaxDisplaysNumber;
                    m_PlaybackSearchParameters.Display = DvrClientConstants.NONE;

                    frmPlayback f = new frmPlayback(this, m_PlaybackSearchParameters);
                    f.OkPressed += new EventHandler(PressedOkOnPlaybackForm_Handler);

                    f.Show(); 

                    #endregion
                    break;


                case CameraTreeContextMenuAction.InstantPlayback:
                    #region Instant Playback

                    sMessage = "Camera: " + iCameraNumber +
                              "  Display: " + m_TreeViewContextMenuDisplayIndex;
                    sMessage += "Instant Playback From Display Context Menu " + sMessage;
                    Audit(sMessage, sMethod, AuditSeverity.Information);

                    DateTime dtStartDateTime;
                    DateTime dtNow = DateTime.Now;

                    dtStartDateTime = dtNow.AddMinutes(-1 * m_Settings.PlaybackLastMinutes);

                    StartPlayback(ciCameraInformation,
                                  DvrClientConstants.NONE,
                                  dtStartDateTime,
                                  m_Settings.PlaybackLastMinutes * 60,
                                  0,
                                  0,
                                  "",
                                  true,
                                  Utils.InitialDefaultTime(),
                                  "");

                    #endregion
                    break;


                case CameraTreeContextMenuAction.VmdTriggers:
                    #region VMD Triggers
                    
                    sTag = mi.Tag.ToString();

                    iCameraNumber = int.Parse(Utils.GetNthSubString(sTag, ":", 2));
                    sDvr = Utils.GetNthSubString(sTag, ":", 1);
                    sSiteAddress = GetLoggerIP(sDvr);
                    sCameraName = GetCameraNameByCameraNumber(sDvr, iCameraNumber);

                    sMessage = "DVR: " + sDvr +
                              "  Camera: " + iCameraNumber;
                    sMessage = "Show VMD Triggers For " + sMessage;
                    Audit(sMessage, sMethod, AuditSeverity.Information);

                    frmVmdTriggers fVt = new frmVmdTriggers(this,
                                                            m_Settings.MaxDisplaysNumber,
                                                            m_Settings.NiceAmsIp,
                                                            sDvr,
                                                            sSiteAddress,
                                                            iCameraNumber,
                                                            sCameraName,
                                                            m_Settings.VideoFormat,
                                                            (string.IsNullOrEmpty(m_Settings.ExportFolder)) ? Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) : m_Settings.ExportFolder);
                    fVt.Show(); 

                    #endregion
                    break;


                case CameraTreeContextMenuAction.AddFreeText:
                    #region Add Free Text

                    sTag = mi.Tag.ToString();

                    iCameraNumber = int.Parse(Utils.GetNthSubString(sTag, ":", 2));
                    sDvr = Utils.GetNthSubString(sTag, ":", 1);

                    iDisplayIndex = DisplayManager_FindDisplayByCameraNumber(sDvr, iCameraNumber);

                    if (DisplayManager_DisplayActivation(iDisplayIndex) == ActivationType.NotActive)
                    {
                        sMessage = (Language == Language.English) ? "Display Not Active" : "  ";
                        MessageBox.Show(sMessage,
                                        "Nice Display Free Text",
                                        MessageBoxButtons.OK,
                                        MessageBoxIcon.Exclamation);
                    }
                    else
                    {
                        sMessage = Microsoft.VisualBasic.Interaction.InputBox("Text",
                                                                              "Add Nice Display Free Text",
                                                                              "",
                                                                              Cursor.Position.X,
                                                                              Cursor.Position.Y);

                        NiceVideoDisplayFreeText(iDisplayIndex, sMessage);
                    }

                    #endregion
                    break;


                default:
                    break;
            }
        }

        private void ContextMenuDvrInfo_Click(object sender, EventArgs e)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sDvr;
            string sKey;
            string sSiteName;
            string sSiteAddress;
            string sSiteVersion;
            string sSiteID;

            Vendor vSiteVendor;

            DvrInformation diDvrInformation;

            #endregion            

            try
            {
                MenuItem mi = (MenuItem)sender;
                diDvrInformation = (DvrInformation)(mi.Tag);

                if (diDvrInformation != null)
                {
                    Audit("Dvr '" + diDvrInformation.IpAddress + " - " + diDvrInformation.Name + "' Information", sMethod, AuditSeverity.Information);

                    frmDvrInfo showInfo = new frmDvrInfo(diDvrInformation.Vendor, 
                                                         diDvrInformation.Name, 
                                                         diDvrInformation.IpAddress, 
                                                         diDvrInformation.DvrId.ToString(), 
                                                         diDvrInformation.Version, 
                                                         m_Settings.Language,
                                                         (diDvrInformation.Camera == null) ? 0 : diDvrInformation.Camera.Count);
                    showInfo.Show();
                }
                else
                {
                    MessageBox.Show("Dvr Information Does Not Exist", "", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Warning);
            }
        }        

        private void ContextMenuCloseAllDvrCameras_Click(object sender, EventArgs e)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;

            MenuItem mi = (MenuItem)sender;

            DvrInformation diDvrInformation;

            #endregion

            try
            {
                diDvrInformation = (DvrInformation)(mi.Tag);

                Audit("Close All Cameras On Dvr '" + diDvrInformation.Name + "'", sMethod, AuditSeverity.Information);
                CloseAllCameras(diDvrInformation.Name);
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void ContextMenuCloseAllCameras_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            Audit("Closing All Cameras", sMethod, AuditSeverity.Information);
            CloseAllCameras();
        }

        private void ContextMenuPredefinedViews_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sPreDefinedViewName;

            MenuItem mi = (MenuItem)sender;
            sPreDefinedViewName = mi.Tag.ToString();

            Audit("Activating Predefined View '" + sPreDefinedViewName + "'", sMethod, AuditSeverity.Information);            
            StartPreDefinedView(sPreDefinedViewName);
        }

        private void ContextMenuPresets_Click(object sender, EventArgs e)
        {

        }
        
        private void ContextMenuCloseCamera_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            Audit("Close Camera On Display " + m_TreeViewContextMenuDisplayIndex, sMethod, AuditSeverity.Information);
            btnClose_Click(null, null);
        }

        private void ContextMenuCameraInformation_Click(object sender, EventArgs e)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sRecordingStatus = "";
            string sAnalyzingStatus = "";
            string sSiteName;
            string sCameraName;
            string sVmdCa = "";
            Vendor vCameraVendor;

            int iChannelID;
            int iIndex;
            int iCameraNumber;
            int iFrameRate;
            int iNonMotionFrameRate;
            int iMotionBitRate;
            int iNonMotionBitRate;
            int iCompression; 

            #endregion

            try
            {
                iIndex = m_TreeViewContextMenuDisplayIndex - 1;

                if (DisplayManager_DisplayIsFree(iIndex))
                {
                    return;
                }

                sSiteName = DisplayManager_DisplaySiteName(iIndex);
                vCameraVendor = DisplayManager_DisplayVendorName(iIndex);
                iChannelID = DisplayManager_DisplayChannelID(iIndex);
                sCameraName = DisplayManager_DisplayCameraName(iIndex);
                iCameraNumber = DisplayManager_DisplayCameraNumber(iIndex);

                Audit("Information For Camera " + iIndex + " on DVR " + sSiteName,
                      sMethod,
                      AuditSeverity.Information);

                sRecordingStatus = "";// GetRecordingStatus(sSiteName, iCameraNumber);
                sAnalyzingStatus = "";// GetAnalyzingStatus(sSiteName, iCameraNumber);
                sVmdCa = "";// GetChannelVmdCaState(sSiteName, iCameraNumber);

                iFrameRate = 0; //GetFrameRate(sSiteName, iCameraNumber);
                iNonMotionFrameRate = 0; // GetNonMotionFrameRate(sSiteName, iCameraNumber);
                iMotionBitRate = 0; // GetMotionBitRate(sSiteName, iCameraNumber);
                iNonMotionBitRate = 0; // GetNonMotionBitRate(sSiteName, iCameraNumber);
                iCompression = 0;// GetCompression(sSiteName, iCameraNumber);

                frmCameraInfo showInfo = new frmCameraInfo(vCameraVendor,
                                                           sSiteName,
                                                           sCameraName,
                                                           iCameraNumber,
                                                           iChannelID,
                                                           sRecordingStatus,
                                                           sAnalyzingStatus,
                                                           iMotionBitRate,
                                                           iNonMotionBitRate,
                                                           iFrameRate,
                                                           iNonMotionFrameRate,
                                                           iCompression,
                                                           sVmdCa,
                                                           m_Settings.Language);
                showInfo.Show();
            }
            catch (Exception ex)
            {
                Audit("Failed on ContextMenuCameraInformation. " + ex.Message, sMethod, AuditSeverity.Information);
            }
        }

        private void ContextMenuMinMax_Click(object sender, EventArgs e)
        {
            #region Data Members
            
            bool bSelectedDisplayModeOn = DisplayManager_GetSelectedDisplayModeOn();

            int iNumberOfDisplays;
            int iDisplayIndex = DisplayManager_GetActiveDisplayIndex();
            int iCameraNumber;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sVendor;
            string sDvr; 

            #endregion

            if (iDisplayIndex == DvrClientConstants.NONE)
            {
                Audit("Trying To Select Display For Selected Display Mode Without Focus On A Display.",
                      sMethod,
                      AuditSeverity.Warning);

                return;
            }
            else
            {
                sVendor = DisplayManager_DisplayVendorName(iDisplayIndex).ToString();
            }

            if (bSelectedDisplayModeOn)
            {
                Audit("Restore Selected Display[" + (iDisplayIndex + 1) + "]", 
                      sMethod, 
                      AuditSeverity.Information);
            }
            else
            {
                Audit("Maximize Selected Display[" + (iDisplayIndex + 1) + "]", 
                      sMethod, 
                      AuditSeverity.Information);
            }

            if (DisplayManager_GetMode() == DisplayFormatState.OneView)
            {
                Audit("Selected Display Is In One-View Already.",
                      sMethod,
                      AuditSeverity.Warning);

                return;
            }            

            if (bSelectedDisplayModeOn)
            {
                #region Restore

                Audit("Restoring Selected Display[" + (iDisplayIndex + 1) +
                      "] Width[" + DisplayManager_GetSelectedDisplaySize().Width +
                      "] Height[" + DisplayManager_GetSelectedDisplaySize().Height +
                      "] Location(" + DisplayManager_GetSelectedDisplayLocation().X +
                      "," + DisplayManager_GetSelectedDisplayLocation().Y + ")",
                      sMethod,
                      AuditSeverity.Information);

                VendorVideoPlayerLocation(iDisplayIndex,
                                        DisplayManager_GetSelectedDisplayLocation().X,
                                        DisplayManager_GetSelectedDisplayLocation().Y);
                VendorVideoPlayerSize(iDisplayIndex,
                                    DisplayManager_GetSelectedDisplaySize().Width,
                                    DisplayManager_GetSelectedDisplaySize().Height);

                for (int i = 0; i < m_NotSelectedOpenDisplayIndex.Count; i++)
                {
                    vp[m_NotSelectedOpenDisplayIndex[i]].Visible = true;
                }
                m_NotSelectedOpenDisplayIndex = new List<int>();

                switch (m_DisplayInfo.State)
                {
                    case DisplayState.FiveFourDown:
                    case DisplayState.FiveFourUp:
                        iNumberOfDisplays = 5;
                        break;

                    default:
                        iNumberOfDisplays = (int)(m_DisplayInfo.State);
                        break;
                }

                for (int i = 0; i < iNumberOfDisplays; i++)
                {
                    if (vp[i].Visible)
                    {
                        m_Transparent[i].Size = vp[i].Size;

                        continue;
                    }

                    if (m_VideoLoss[i].Visible)
                    {
                        m_VideoLoss[i].Size = vp[i].Size;
                    }

                    PictureVisible(i, true);
                }

                HideSurroundingFrame(iDisplayIndex, sMethod);

                DisplayManager_SetSelectedDisplayModeOn(false);

                Audit("Selected Display[" + (iDisplayIndex + 1) +
                      "] Mode Off. Restore Former Displays.",
                      sMethod,
                      AuditSeverity.Information); 

                #endregion
            }
            else
            {
                #region Maximize

                if (m_Settings.EnableBackToOriginalViewByDblClk)
                {
                    //  keep selected display's index, size and location
                    DisplayManager_SetSelectedDisplayLocation(VendorVideoPlayerLocation(iDisplayIndex));
                    DisplayManager_SetSelectedDisplaySize(VendorVideoPlayerSize(iDisplayIndex));
                    DisplayManager_SetSelectedDisplayIndex(iDisplayIndex);
                    Audit("Storing Selected Display[" + (iDisplayIndex + 1) +
                          "] Width[" + DisplayManager_GetSelectedDisplaySize().Width +
                          "] Height[" + DisplayManager_GetSelectedDisplaySize().Height +
                          "] Location(" + DisplayManager_GetSelectedDisplayLocation().X +
                          "," + DisplayManager_GetSelectedDisplayLocation().Y + ")",
                          sMethod,
                          AuditSeverity.Information);

                    VendorVideoPlayerLocation(DisplayManager_GetActiveDisplayIndex(), START_X, START_Y);
                    VendorVideoPlayerSize(DisplayManager_GetActiveDisplayIndex(), D1_WIDTH, D1_HIGHT);

                    for (int i = 0; i < m_DisplayInfo.Displays; i++)
                    {
                        if (i == iDisplayIndex)
                        {
                            continue;
                        }

                        if (vp[i].Visible)
                        {
                            m_NotSelectedOpenDisplayIndex.Add(i);
                            vp[i].Visible = false;

                            m_Transparent[i].Size = new Size(0, 0);
                        }

                        if (m_VideoLoss[i].Visible)
                        {
                            m_VideoLoss[i].Size = new Size(0, 0);
                        }

                        PictureVisible(i, false);
                    }

                    HideSurroundingFrame(iDisplayIndex, sMethod);

                    DisplayManager_SetSelectedDisplayModeOn(true);

                    Audit("Selected Display[" + (iDisplayIndex + 1) +
                          "] Mode On. Current Displays Stored.",
                          sMethod,
                          AuditSeverity.Information);
                }
                else
                {
                    sDvr = DisplayManager_DisplaySiteName(iDisplayIndex);
                    iCameraNumber = DisplayManager_DisplayCameraNumber(iDisplayIndex);
                    CloseAllCameras();
                    //StartCamera(sDvr, iCameraNumber, DvrClientConstants.NONE, "", true);
                } 

                #endregion
            }
        }

        private void ContextMenuDigitalZoomOnOff_Click(object sender, EventArgs e)
        {
            btnDigitalZoom_Click(sender, e);
        }

        private void ContextMenuFullNormalScreen_Click(object sender, EventArgs e)
        {
            #region Data Members
            
            bool bSelectedDisplayModeOn = DisplayManager_GetSelectedDisplayModeOn();

            //int iNumberOfDisplays;
            int iDisplayIndex = DisplayManager_GetActiveDisplayIndex();
            //int iCameraNumber;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            //string sVendor;
            //string sDvr; 

            #endregion

            switch (triFullScreen)
            {
                case Trinar.Idle:
                case Trinar.False:
                    FullScreen();
                    if (m_Settings.Mode == ActivationMode.StandAlone)
                    {
                        OnFullScreenChanged();
                    }
                    triFullScreen = Trinar.True;
                    break;

                case Trinar.True:
                    NormalScreen();
                    if (m_Settings.Mode == ActivationMode.StandAlone)
                    {
                        OnBackToNormalScreen();
                    }
                    stMain.Focus();
                    triFullScreen = Trinar.False;
                    break;

                default:
                    break;
            }
        }        

        private void ContextMenuSwitch_Click(object sender, EventArgs e)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sSiteName;
            string sCameraName;
            string sMessge;

            int iChannelID;
            int iIndex;
            int iCameraNumber;
            int iDvrId;
            int iDvrGroupId;

            CameraInformation ciCameraInformation;

            #endregion

            try
            {
                iIndex = m_TreeViewContextMenuDisplayIndex - 1;
                if (iIndex == DvrClientConstants.NONE)
                {
                    Audit("Trying To Activate From Context Menu Without Focus On A Display", 
                          sMethod, 
                          AuditSeverity.Warning);

                    return;
                }

                if (DisplayManager_DisplayIsFree(iIndex))
                {
                    Audit("Trying To Activate From Context Menu From A Free Display", 
                          sMethod,
                          AuditSeverity.Warning);

                    return;
                }

                iDvrGroupId = DisplayManager_DisplayDvrGroupId(iIndex);
                iDvrId = DisplayManager_DisplayDvrId(iIndex);
                //iChannelID = DisplayManager_DisplayChannelID(iIndex);
                sCameraName = DisplayManager_DisplayCameraName(iIndex);
                iCameraNumber = DisplayManager_DisplayCameraNumber(iIndex);

                ciCameraInformation = DisplayManager_GetCamera(iIndex);

                switch (DisplayManager_DisplayActivation(iIndex))
                { 
                    case ActivationType.LiveVideo:
                        #region Live Video

                        //Audit("Close Camera on Display " + m_TreeViewContextMenuDisplayIndex, sMethod);
                        btnClose_Click(null, null);

                        sMessge = "Camera Number: " + iCameraNumber +
                                  "  Display: " + m_TreeViewContextMenuDisplayIndex;
                        sMessge = "Playback From Display Context Menu " + sMessge;
                        Audit(sMessge, sMethod, AuditSeverity.Information);

                        m_PlaybackSearchParameters = new PlaybackSearchParameters();

                        m_PlaybackSearchParameters.Camera = ciCameraInformation;
                        m_PlaybackSearchParameters.Main = this;
                        m_PlaybackSearchParameters.Language = m_Settings.Language;
                        m_PlaybackSearchParameters.MaxDisplaysNumber = m_Settings.MaxDisplaysNumber;
                        m_PlaybackSearchParameters.Display = iIndex + 1;

                        //CameraNodeDisplay(sSiteName, iCameraNumber, Action.Remove, DvrClientConstants.NONE, sMethod);

                        frmPlayback f = new frmPlayback(this, m_PlaybackSearchParameters);
                        f.OkPressed += new EventHandler(PressedOkOnPlaybackForm_Handler);

                        f.Show(); 

                        #endregion

                        break;

                    case ActivationType.VideoOnDemand:
                        #region Video On Demand

                        Audit("Close Camera on Display " + m_TreeViewContextMenuDisplayIndex, 
                              sMethod, 
                              AuditSeverity.Information);
                        btnClose_Click(null, null);

                        sMessge = "Camera Number: " + iCameraNumber +
                                  "  Display: " + m_TreeViewContextMenuDisplayIndex;
                        sMessge = "Opening From Display Context Menu " + sMessge;
                        Audit(sMessge, sMethod, AuditSeverity.Information);
                        StartCamera_X_on_Display_Y(ciCameraInformation,
                                                   m_TreeViewContextMenuDisplayIndex,
                                                   DvrClientConstants.NONE,
                                                   "",
                                                   true); 
	                    #endregion

                        break;

                    default:
                        Audit("Wrong Activation Type", sMethod, AuditSeverity.Error);
                        return;                        
                }
            }
            catch (Exception)
            {
                Audit("Failed on Switching", sMethod, AuditSeverity.Error);
            }
        }

        private void ContextMenuAddPredefinedView_Click(object sender, EventArgs e)
        {
            #region Data Members

            bool bRc;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sPreDefinedName;
            string sLayout;
            string sError;
            string sResult;

            int iGotoCounter;
            int i;
            int iPreDefinedViewId;

            #endregion

            try
            {
                sPreDefinedName = Interaction.InputBox("Enter A Name For The New Pre Defined View.", 
                                                       "Add Pre Defined View", 
                                                       "", 
                                                       -1, 
                                                       -1);
                if (string.IsNullOrEmpty(sPreDefinedName))
                {
                    MessageBox.Show("Pre Defined View Name Can Not Be Empty",
                                    "Pre Defined View Save Failure",
                                    MessageBoxButtons.OK,
                                    MessageBoxIcon.Error);
                    return;
                }

                sLayout = DisplayManager_GetMode().ToString();

                iGotoCounter = 0;

                ReAddPreDefinedView:
                iGotoCounter++;
                if (!AddPreDefinedView(sPreDefinedName, sLayout, out sResult))
                {
                    Audit("Failed Adding '" + sPreDefinedName + "'. " + sResult, 
                          sMethod, 
                          AuditSeverity.Warning);

                    DialogResult drRc = MessageBox.Show("Pre Defined View[" + sPreDefinedName + "] Already Exist. Save Current Layout And Cameras?",
                                                        "Save Pre Defined View Conflict",
                                                        MessageBoxButtons.YesNo,
                                                        MessageBoxIcon.Question);
                    if (drRc == DialogResult.Yes)
                    {
                        bRc = DeletePreDefinedView(sPreDefinedName, out sResult);
                        if (!bRc)
                        {
                            Audit(sResult, sMethod, AuditSeverity.Warning);

                            return;
                        }
                        else
                        {
                            if (iGotoCounter > 1)
                            {
                                return;
                            }

                            goto ReAddPreDefinedView;
                        }
                    }
                    else
                    {
                        return;
                    }                    
                }

                iPreDefinedViewId = GetViewIndex(sPreDefinedName, ViewType.PredefinedView, out sResult);

                for (i = 0; i < DisplayManager_Displays() ; i++)
                {
                    if (DisplayManager_DisplayIsFree(i) == false)
                    {
                        if(!AddCamera2PreDefinedView(sPreDefinedName,
                                                     //DisplayManager_DisplaySiteName(i),
                                                     DisplayManager_DisplayDvrId(i).ToString(),
                                                     DisplayManager_DisplayCameraNumber(i),
                                                     DisplayManager_DisplayNumber(i) + 1,
                                                     DisplayManager_DisplayPreset(i),
                                                     out sError))
                        {
                            Audit("Failed Adding Pre Defined View '" + sPreDefinedName + "' " +
                                  "DVR[" + DisplayManager_DisplaySiteName(i) + "] " +
                                  "Camera[" + DisplayManager_DisplayCameraNumber(i) + "] " +
                                  "Display[" + (DisplayManager_DisplayNumber(i) + 1).ToString() + "]. " +
                                  sError, 
                                  sMethod,
                                  AuditSeverity.Warning);
                        }                       
                    }
                }                     
            }
            catch (Exception)
            {
                Audit("Failed Adding A Pre Defined View", sMethod, AuditSeverity.Error);
            }
        }

        private void SnapShot_Click(object sender, EventArgs e)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            int iIndex;
            

            DvrInformation diDvrInformation;
            CameraInformation ciCameraInformation;

            #endregion

            try
            {
                iIndex = DisplayManager_GetActiveDisplayIndex();

                ciCameraInformation = DisplayManager_GetCamera(iIndex);
                diDvrInformation = m_DvrInformation[GetDvrIndex(ciCameraInformation.DvrId)];
                
                SnapShot(ciCameraInformation, "[]", DisplayManager_DisplayActivation(DisplayManager_GetActiveDisplayIndex()));

                Audit("Snap Shot From Camera[" + ciCameraInformation.CameraNumber + " - " + ciCameraInformation.Name + 
                      "] On Dvr[" + diDvrInformation.IpAddress + " - " + diDvrInformation.Name + "]",
                      sMethod,
                      AuditSeverity.Information);                
            }
            catch (Exception ex)
            {
                Audit("Failed On Snap Shot. " + ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void VmdTriggers_Click(object sender, EventArgs e)
        {
            #region Data Members

            bool bUsePlaybackTimeInterval = false;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sSiteName;
            string sSiteAddress;
            string sMessage;
            string sCameraName;

            int iCameraNumber;
            int iPlaybackDuration;
            int iIndex;

            DateTime dtPlaybackStart = DateTime.Now;
            DateTime dtPlaybackEnd = DateTime.Now;

            ActivationType atActivation;

            frmVmdTriggers fVt;

            #endregion

            try
            {
                iIndex = m_TreeViewContextMenuDisplayIndex - 1;

                iCameraNumber = DisplayManager_DisplayCameraNumber(iIndex);
                sSiteName = DisplayManager_DisplaySiteName(iIndex);
                sSiteAddress = GetLoggerIP(sSiteName);
                sCameraName = GetCameraNameByCameraNumber(sSiteName, iCameraNumber);

                atActivation = DisplayManager_DisplayActivation(iIndex);

                if (atActivation == ActivationType.VideoOnDemand)
                {
                    dtPlaybackStart = DisplayManager_DisplayPlaybackStart(iIndex);
                    iPlaybackDuration = DisplayManager_DisplayPlaybackDuration(iIndex);
                    dtPlaybackEnd = Utils.DateAdd(Microsoft.VisualBasic.DateInterval.Second,
                                                  iPlaybackDuration,
                                                  dtPlaybackStart);

                    bUsePlaybackTimeInterval = true;
                }
                else
                {
                    bUsePlaybackTimeInterval = false;
                }

                sMessage = "DVR: " + sSiteName +
                           "  Camera: " + iCameraNumber;
                sMessage = "Show VMD Triggers For " + sMessage;
                Audit(sMessage, sMethod, AuditSeverity.Information);

                if (bUsePlaybackTimeInterval)
                {
                    fVt = new frmVmdTriggers(this,
                                             m_Settings.MaxDisplaysNumber,
                                             m_Settings.NiceAmsIp,
                                             sSiteName,
                                             sSiteAddress,
                                             iCameraNumber,
                                             sCameraName,
                                             m_Settings.VideoFormat,
                                             dtPlaybackStart,
                                             dtPlaybackEnd,
                                             (string.IsNullOrEmpty(m_Settings.ExportFolder)) ? Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) : m_Settings.ExportFolder);                    
                }
                else
                {
                    fVt = new frmVmdTriggers(this,
                                             m_Settings.MaxDisplaysNumber,
                                             m_Settings.NiceAmsIp,
                                             sSiteName,
                                             sSiteAddress,
                                             iCameraNumber,
                                             sCameraName,
                                             m_Settings.VideoFormat,                                                                
                                             (string.IsNullOrEmpty(m_Settings.ExportFolder)) ? Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) : m_Settings.ExportFolder);
                }

                fVt.Show();                 
            }
            catch (Exception ex)
            {
                Audit("Failed On Vmd Triggers. " + ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void ContextMenuInstantPlayback_Click(object sender, EventArgs e)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sSiteName;
            string sSiteAddress;
            string sMessage;
            string sCameraName;

            int iActiveDisplayIndex;
            int iCameraNumber;
            int iIndex;

            CameraInformation ciCameraInformation;

            #endregion

            try
            {
                iIndex = m_TreeViewContextMenuDisplayIndex - 1;

                ciCameraInformation = DisplayManager_GetCamera(iIndex);

                iCameraNumber = DisplayManager_DisplayCameraNumber(iIndex);

                sMessage = "DVR ID[" + ciCameraInformation.DvrId +
                           "  Camera: " + ciCameraInformation.CameraNumber +
                           "  Display: " + m_TreeViewContextMenuDisplayIndex;
                sMessage = "Instant Playback From Display Context Menu " + sMessage;
                Audit(sMessage, sMethod, AuditSeverity.Information);

                DateTime dtStartDateTime;
                DateTime dtNow = DateTime.Now;

                dtStartDateTime = dtNow.AddMinutes(-1 * m_Settings.PlaybackLastMinutes);

                iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();

                if (iActiveDisplayIndex == DvrClientConstants.NONE)
                {
                    StartPlayback(ciCameraInformation,
                                  DvrClientConstants.NONE,
                                  dtStartDateTime,
                                  m_Settings.PlaybackLastMinutes * 60,
                                  0,
                                  0,
                                  "",
                                  true,
                                  Utils.InitialDefaultTime(),
                                  "");
                }
                else
                {
                    StartPlayback_on_Display_Y(ciCameraInformation,
                                               DvrClientConstants.NONE,
                                               dtStartDateTime,
                                               iActiveDisplayIndex + 1,
                                               m_Settings.PlaybackLastMinutes * 60,
                                               0,
                                               0,
                                               "",
                                               true,
                                               Utils.InitialDefaultTime(),
                                               "");
                    HideSurroundingFrame(sMethod);
                    ShowSurroundingFrame(iActiveDisplayIndex, Color.GreenYellow, sMethod);
                }
            }
            catch (Exception ex)
            {
                Audit("Failed On Instant Playback. " + ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void ContextMenuAddFreeText_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sSiteName;
            string sMessage;

            int iCameraNumber;
            int iIndex;
            int iDisplayIndex;

            try
            {
                iIndex = m_TreeViewContextMenuDisplayIndex - 1;

                iCameraNumber = DisplayManager_DisplayCameraNumber(iIndex);
                sSiteName = DisplayManager_DisplaySiteName(iIndex);

                iDisplayIndex = DisplayManager_FindDisplayByCameraNumber(sSiteName, iCameraNumber);

                if (DisplayManager_DisplayActivation(iDisplayIndex) == ActivationType.NotActive)
                {
                    sMessage = (Language == Language.English) ? "Display Not Active" : "  ";
                    MessageBox.Show(sMessage,
                                    "Nice Display Free Text",
                                    MessageBoxButtons.OK,
                                    MessageBoxIcon.Exclamation);
                }
                else
                {
                    sMessage = Microsoft.VisualBasic.Interaction.InputBox("Text",
                                                                          "Add Nice Display Free Text",
                                                                          "",
                                                                          Cursor.Position.X,
                                                                          Cursor.Position.Y);

                    NiceVideoDisplayFreeText(iDisplayIndex, sMessage);
                }
                
            }
            catch (Exception ex)
            {
                Audit("Failed On Add Free Text. " + ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void ExportCamera_Click(object sender, EventArgs e)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sSiteName;
            string sSiteAddress;

            int iCameraNumber;
            int iIndex;
            int iPlaybackDuration;

            DateTime dtPlaybackStart;
            DateTime dtPlaybackEnd;

            ActivationType atActivation;

            CameraInformation ciCameraInformation;

            #endregion

            try
            {
                iIndex = m_TreeViewContextMenuDisplayIndex - 1;

                if (iIndex >= 0)
                {
                    ciCameraInformation = DisplayManager_GetCamera(iIndex);
                    iCameraNumber = DisplayManager_DisplayCameraNumber(iIndex);
                    sSiteName = DisplayManager_DisplaySiteName(iIndex);
                    sSiteAddress = GetLoggerIP(sSiteName);

                    atActivation = DisplayManager_DisplayActivation(iIndex);

                    m_ExportData = new ExportThreadData();

                    if (atActivation == ActivationType.VideoOnDemand)
                    {
                        dtPlaybackStart = DisplayManager_DisplayPlaybackStart(iIndex);
                        iPlaybackDuration = DisplayManager_DisplayPlaybackDuration(iIndex);
                        dtPlaybackEnd = Utils.DateAdd(Microsoft.VisualBasic.DateInterval.Second,
                                                      iPlaybackDuration,
                                                      dtPlaybackStart);

                        m_ExportData.Start = dtPlaybackStart;
                        m_ExportData.End = dtPlaybackEnd;
                        m_ExportData.UseTimeInterval = true;
                    }
                    else
                    {
                        m_ExportData.UseTimeInterval = false;
                    }

                    Audit("Export From Camera[" + DisplayManager_DisplayCameraName(iIndex) +
                          "] Number[" + iCameraNumber +
                          "] On DVR " + sSiteName,
                          sMethod, 
                          AuditSeverity.Information);

                    m_ExportData.Main = this;
                    m_ExportData.AmsIP = m_Settings.NiceAmsIp;
                    m_ExportData.Camera = ciCameraInformation;
                    m_ExportData.CameraNumber = iCameraNumber;
                    m_ExportData.DvrIP = sSiteAddress;
                    m_ExportData.VideoFormat = m_Settings.VideoFormat;
                    m_ExportData.DvrName = sSiteName;
                    m_ExportData.CameraName = GetCameraNameByCameraNumber(sSiteName, iCameraNumber);
                    m_ExportData.InitialDirectory = (string.IsNullOrEmpty(m_Settings.ExportFolder)) ? Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) : m_Settings.ExportFolder;

                    frmExport f = new frmExport(this, m_ExportData);

                    f.Show();
                }
                else
                {
                    Audit("Can't Access Index[" + iIndex + "]", sMethod, AuditSeverity.Warning);
                }
            }
            catch (Exception)
            {
                Audit("Failed On Export Camera", sMethod, AuditSeverity.Error);
            }
        } 

        #endregion        

        #region Language

        private void English()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            Audit("Language Is English", sMethod, AuditSeverity.Important);

            m_bLanguageSwitched = true;
            RePaintBackground();

            #region Left to right

            mnu.RightToLeft = RightToLeft.No;
            toolStripMain.RightToLeft = RightToLeft.No;
            tv.RightToLeft = RightToLeft.No;
            tv.RightToLeftLayout = false;
            if (tv.Nodes.Count > 0)
            {
                tv.ExpandAll();
                tv.SelectedNode = tv.Nodes[0];
            }
            gbCurrentPreset.RightToLeft = RightToLeft.No;
            gbPresets.RightToLeft = RightToLeft.No;

            stMain.RightToLeft = RightToLeft.No;

            #endregion

            #region Labels

            mnuConnect.Text = "Connect";

            mnuOptions.Text = "Options";
            mnuAudit.Text = "Audit";
            mnuAuditHide.Text = "Hide";
            mnuAuditShow.Text = "Show";
            mnuSettings.Text = "Settings";
            mnuRestart.Text = "Restart NICE";
            mnuDeleteLogFiles.Text = "Delete Log Files";
            mnuStampLogFile.Text = "Stamp Log File";

            mnuErrorMessages.Text = "Error Messages";
            mnuHideErrorMessage.Text = "Hide";
            mnuShowErrorMessage.Text = "Show";

            mnuLanguage.Text = "Language";

            mnuExit.Text = "Exit";
            mnuTools.Text = "Tools";
            mnuDisplayManagerView.Text = "Display Manager View";
            mnuDataScope.Text = "Data Scope";

            mnuAbout.Text = "About";

            mnuLayouts.Text = "Layouts";
            mnuOneView.Text = "1 View";
            mnuFourView.Text = "4 View";
            mnuNineView.Text = "9 View";
            mnuSixteenView.Text = "16 View";
            mnuTwentyFiveView.Text = "25 View";
            mnuThirtySixView.Text = "36 View";
            mnuLayout1.Text = "Layout 1";
            mnuLayout2.Text = "Layout 2";
            mnuLayout3.Text = "Layout 3";
            mnuLayout4.Text = "Layout 4";
            mnuLayout5.Text = "Layout 5";
            mnuLayout6.Text = "Layout 6";
            mnuNormal.Text = "Normal";
            mnuFallback.Text = "Fallback";

            mnuDisplays.Text = "Displays";
            mnuCloseAllDisplays.Text = "Close All Displays";
            mnuSaveDisplays.Text = "Save Displays";
            mnuRestoreDisplays.Text = "Restore Displays";

            btnMain.Text = "Main";
            btnMain.ToolTipText = "Main";
            btnUndo.Text = "Undo";
            btnUndo.ToolTipText = "Undo";
            btnUndo.Text = "Redo";
            btnUndo.ToolTipText = "Redo";
            btnClose.Text = "Close\nCamera";
            btnClose.ToolTipText = "Close\nCamera";
            if (m_WorkMode == WorkMode.Operation)
            {
                btnWorkingMode.Text = "Operation";
                btnWorkingMode.ToolTipText = "Operation\nMode";
            }
            else
            {
                btnWorkingMode.Text = "Drag";
                btnWorkingMode.ToolTipText = "Drag\nMode";
            }

            if (m_bMultiSelect)
            {
                btnTreeSelectionMode.Image = Afcon.DvrClient.Control.Properties.Resources.Single;
                btnTreeSelectionMode.Text = "Single Select";
                btnTreeSelectionMode.ToolTipText = "Single Select";                
            }
            else
            {
                btnTreeSelectionMode.Image = Afcon.DvrClient.Control.Properties.Resources.Multi;
                btnTreeSelectionMode.Text = "Multi Select";
                btnTreeSelectionMode.ToolTipText = "Multi Select";
            }

            gbPTZ.Text = "PTZ";

            mnuPlayback.Text = "Playback";
            mnuFastPlayback.Text = "Playback Last " + m_Settings.PlaybackLastMinutes + " Minutes";
            mnuExport.Text = "Export To File";
            mnuOpenCamera.Text = "Open Camera";
            mnuCameraClose.Text = "Close Camera";
            mnuCloseAllCameras.Text = "Close All Cameras";
            mnuDvrInfo.Text = "DVR Information";
            mnuCameraInfo.Text = "Camera Information";
            mnuCamera2Display.Text = "Camera To Display";
            mnuVmdTriggers.Text = "VMD Triggers";
            mnuAddFreeText.Text = "Add Free Text";
            mnuCleaAllCheckboxes.Text = "Clear All Checkboxes";
            mnuStartPatrol.Text = "Start Patrol";
            mnuStopPatrol.Text = "Stop Patrol";

            lblActiveDisplay.Text = "Active Displays";

            if (m_PCimProxyThread != null)
            {
                if (m_Settings.ShowLocalHostIPAddress)
                {
                    lblIP.Text = "Host IP  " + m_PCimProxyThread.GetLocalHostIPAddress();
                }
            }

            #region Tool Tips

            toolTip.SetToolTip(btnAddPreset, "Add");
            toolTip.SetToolTip(btnUpdatePreset, "Rename");
            toolTip.SetToolTip(btnRemovePreset, "Delete");
            toolTip.SetToolTip(btnSmallZoomOut, "Zoom Out");
            toolTip.SetToolTip(btnSmallZoomIn, "Zoom In");

            toolTip.SetToolTip(btnSmallPlay, "Slow Forward");
            toolTip.SetToolTip(btnSmallStopPlayback, "Stop");
            toolTip.SetToolTip(btnSmallPause, "Pause");
            toolTip.SetToolTip(btnSmallBackward, "Backward");
            toolTip.SetToolTip(btnSmallFastForward, "Fast Forward");
            toolTip.SetToolTip(btnSmallFastBackward, "Fast Backward");
            toolTip.SetToolTip(btnSmallNextFrame, "Next Frame");
            toolTip.SetToolTip(btnSmallPrevFrame, "Previous Frame");

            #endregion

            gbPresets.Text = "Presets";
            gbCurrentPreset.Text = "Current Preset";

            #endregion

            #region Coordinates

            cboDvrPresets.Left = 10;
            btnPlayPreset.Left = cboDvrPresets.Left + cboDvrPresets.Width + 5;

            System.ComponentModel.ComponentResourceManager resources = new System.ComponentModel.ComponentResourceManager(typeof(DvrClient));
            btnPlayPreset.Image = ((System.Drawing.Image)(resources.GetObject("btnPlayPreset.Image")));

            if (lblCamera.Text != "")
            {
                DisplayDescription(lblCamera.Text);
            }

            ArrangeDvrClientForm(sMethod);

            CustomizeDisplays(sMethod);
            NoVideoPictureOnEmptyDisplays();

            #endregion
        }

        private void Hebrew()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            Audit("Language Is Hebrew", sMethod, AuditSeverity.Important);

            m_bLanguageSwitched = true;
            RePaintBackground();

            #region Right to left

            mnu.RightToLeft = RightToLeft.Yes;
            toolStripMain.RightToLeft = RightToLeft.Yes;
            tv.RightToLeft = RightToLeft.Yes;
            tv.RightToLeftLayout = true;
            if (tv.Nodes.Count > 0)
            {
                tv.ExpandAll();
                tv.SelectedNode = tv.Nodes[0];
            }
            gbCurrentPreset.RightToLeft = RightToLeft.Yes;
            gbPresets.RightToLeft = RightToLeft.Yes;

            stMain.RightToLeft = RightToLeft.Yes;

            #endregion

            #region Labels

            mnuConnect.Text = "";

            mnuOptions.Text = "";
            mnuAudit.Text = "";
            mnuAuditHide.Text = "";
            mnuAuditShow.Text = "";
            mnuSettings.Text = "";
            mnuRestart.Text = " NICE";
            mnuDeleteLogFiles.Text = "  ";
            mnuStampLogFile.Text = "  ";

            mnuErrorMessages.Text = " ";
            mnuHideErrorMessage.Text = "";
            mnuShowErrorMessage.Text = "";

            mnuLanguage.Text = "";

            mnuExit.Text = "";
            mnuTools.Text = "";
            mnuDisplayManagerView.Text = " ";
            mnuDataScope.Text = " ";

            mnuAbout.Text = "";

            mnuLayouts.Text = "";
            mnuOneView.Text = "  1";
            mnuFourView.Text = "  4";
            mnuNineView.Text = "  9";
            mnuSixteenView.Text = "  16";
            mnuTwentyFiveView.Text = "  25";
            mnuThirtySixView.Text = "  36";
            mnuLayout1.Text = "  1";
            mnuLayout2.Text = "  2";
            mnuLayout3.Text = "  3";
            mnuLayout4.Text = "  4";
            mnuLayout5.Text = "  5";
            mnuLayout6.Text = "  6";
            mnuNormal.Text = " ";
            mnuFallback.Text = " ";

            mnuDisplays.Text = "";
            mnuCloseAllDisplays.Text = "  ";
            mnuSaveDisplays.Text = " ";
            mnuRestoreDisplays.Text = " ";

            btnMain.Text = "";
            btnMain.ToolTipText = "";
            btnUndo.Text = "\n";
            btnUndo.ToolTipText = "\n";
            btnRedo.Text = "\n";
            btnRedo.ToolTipText = "\n";
            btnClose.Text = "\n";
            btnClose.ToolTipText = "\n";
            if (m_WorkMode == WorkMode.Operation)
            {
                btnWorkingMode.Text = "";
                btnWorkingMode.ToolTipText = "\n";
            }
            else
            {
                btnWorkingMode.Text = "";
                btnWorkingMode.ToolTipText = "\n";
            }

            if (m_bMultiSelect)
            {
                btnTreeSelectionMode.Image = Afcon.DvrClient.Control.Properties.Resources.Single;
                btnTreeSelectionMode.Text = " ";
                btnTreeSelectionMode.ToolTipText = " ";                
            }
            else
            {
                btnTreeSelectionMode.Image = Afcon.DvrClient.Control.Properties.Resources.Multi;
                btnTreeSelectionMode.Text = " ";
                btnTreeSelectionMode.ToolTipText = " ";
            }

            gbPTZ.Text = "PTZ";

            mnuPlayback.Text = "";
            mnuFastPlayback.Text = "  " + m_Settings.PlaybackLastMinutes + "  ";
            mnuExport.Text = " ";
            mnuOpenCamera.Text = " ";
            mnuCameraClose.Text = " ";
            mnuCloseAllCameras.Text = "  ";
            mnuDvrInfo.Text = " DVR";
            mnuCameraInfo.Text = " ";
            mnuCamera2Display.Text = " ";
            mnuVmdTriggers.Text = "  ";
            mnuAddFreeText.Text = "  ";
            mnuCleaAllCheckboxes.Text = "   ";
            mnuStartPatrol.Text = " ";
            mnuStopPatrol.Text = " ";

            lblActiveDisplay.Text = " ";

            if (m_PCimProxyThread != null)
            {
                if (m_Settings.ShowLocalHostIPAddress)
                {
                    lblIP.Text = m_PCimProxyThread.GetLocalHostIPAddress() + "   ";
                }
            }

            #region Tool Tips

            toolTip.SetToolTip(btnAddPreset, "");
            toolTip.SetToolTip(btnUpdatePreset, " ");
            toolTip.SetToolTip(btnRemovePreset, "");
            toolTip.SetToolTip(btnSmallZoomOut, "");
            toolTip.SetToolTip(btnSmallZoomIn, "");

            toolTip.SetToolTip(btnSmallPlay, "");
            toolTip.SetToolTip(btnSmallStopPlayback, "");
            toolTip.SetToolTip(btnSmallPause, "");
            toolTip.SetToolTip(btnSmallBackward, " ");
            toolTip.SetToolTip(btnSmallFastForward, " ");
            toolTip.SetToolTip(btnSmallFastBackward, "  ");
            toolTip.SetToolTip(btnSmallNextFrame, " ");
            toolTip.SetToolTip(btnSmallPrevFrame, " ");

            #endregion

            gbPresets.Text = " ";
            gbCurrentPreset.Text = " ";

            #endregion

            #region Coordinates

            if (lblCamera.Text != "")
            {
                DisplayDescription(lblCamera.Text);
            }

            btnPlayPreset.Left = 10;
            cboDvrPresets.Left = btnPlayPreset.Left + btnPlayPreset.Width + 5;

            System.ComponentModel.ComponentResourceManager resources = new System.ComponentModel.ComponentResourceManager(typeof(DvrClient));
            btnPlayPreset.Image = ((System.Drawing.Image)(resources.GetObject("btnSmallBackward.Image")));

            ArrangeDvrClientForm(sMethod);

            CustomizeDisplays(sMethod);
            NoVideoPictureOnEmptyDisplays();

            #endregion
        }

        #endregion

        #region Read Type Get() Functions

        public int GetReadTypesLengthInBytes()
        {
            return m_ReadTypes.LengthInBytes;
        }

        public int GetReadTypesNumberOfReplies()
        {
            return m_ReadTypes.NumberOfReplies;
        }

        public int GetReadTypesNumberOfRequests()
        {
            return m_ReadTypes.NumberOfRequests;
        }

        public int GetReadTypesNumberOfElements(int iEvent)
        {
            return m_ReadTypes.TheReadTypes[iEvent].NumberOfElements;
        }

        public bool GetReadTypesInUse(int iEvent, int iElement)
        {
            return m_ReadTypes.TheReadTypes[iEvent].Element[iElement].InUse;
        }

        public ItemErrorCode GetReadTypesErrorCode(int iEvent, int iElement)
        {
            return m_ReadTypes.TheReadTypes[iEvent].Element[iElement].ErrorCode;
        }

        public string GetReadTypesReturnedValue(int iEvent, int iElement)
        {
            return m_ReadTypes.TheReadTypes[iEvent].Element[iElement].ReturnedValue;
        }

        public string GetReadTypesName(int iEvent, int iElement)
        {
            return m_ReadTypes.TheReadTypes[iEvent].Element[iElement].Name;
        }

        public int GetReadTypesChannel(int iEvent, int iElement)
        {
            return m_ReadTypes.TheReadTypes[iEvent].Element[iElement].Channel;
        }

        public int GetReadTypesDvr(int iEvent, int iElement)
        {
            return m_ReadTypes.TheReadTypes[iEvent].Element[iElement].recorderID;
        }

        public int GetReadTypesFarIndex(int iEvent, int iElement)
        {
            return m_ReadTypes.TheReadTypes[iEvent].Element[iElement].FarIndex;
        }

        public int GetCameraPostTime()
        {
            return m_Settings.CameraPostTime;
        }

        private string GetTreeNodeTag(string sDvr)
        {
            string sReply = "";

            if ((tv == null) || (tv.Nodes == null))
            {
                MessageBox.Show("Tree Does Not Exist Or Is Empty", 
                                "DVR Infprmation Error", 
                                MessageBoxButtons.OK, 
                                MessageBoxIcon.Information);
                return "";
            }

            if (tv.Nodes[0].Nodes == null)
            {
                MessageBox.Show("No DVRs Exist In The Tree",
                                "DVR Infprmation Error",
                                MessageBoxButtons.OK,
                                MessageBoxIcon.Information);
                return "";
            }

            foreach (TreeNode node in tv.Nodes[0].Nodes)
            {
                if (node.Text == sDvr)
                {
                    return node.Tag.ToString();
                }
            }

            MessageBox.Show("DVR '" + sDvr + "' Not Found In The Tree. No Information.",
                            "DVR Infprmation Error",
                            MessageBoxButtons.OK,
                            MessageBoxIcon.Information);

            return sReply;
        }        

        public void GetPrePostPlaybackEventTime(out int iPre, out int iPost)
        {
            iPre = m_Settings.PlaybackPreEventTime;
            iPost = m_Settings.PlaybackPostEventTime;
        }

        public DvrProxySettings GetSettings()
        {
            return m_Settings;
        }                          

        #endregion

        #region Read Type Set() Functions

        public void SetReadTypesLengthInBytes(int iLengthInBytes)
        {
            m_ReadTypes.LengthInBytes = iLengthInBytes;
        }

        public void SetReadTypesNumberOfReplies(int iNumberOfReplies)
        {
            m_ReadTypes.NumberOfReplies = iNumberOfReplies;
        }

        public void SetReadTypesNumberOfRequests(int iNumberOfRequests)
        {
            m_ReadTypes.NumberOfRequests = iNumberOfRequests;
        }

        public void SetReadTypesHasValue(int iEvent, int iElement, bool bHasValue)
        {
            m_ReadTypes.TheReadTypes[iEvent].Element[iElement].HasValue = bHasValue;
        }

        public void SetReadTypesReturnedValue(int iEvent, int iElement, string sReturnedValue)
        {
            m_ReadTypes.TheReadTypes[iEvent].Element[iElement].ReturnedValue = sReturnedValue;
        }

        public bool SetVmd(int iDvr, int iCameraNumber, string sValue, string sEventMessage)
        {
            #region Data Members
            
            bool bActivate;

            float fValue;

            string sResult;
            string sMethod = MethodBase.GetCurrentMethod().Name; 

            #endregion

            try
            {
                fValue = float.Parse(sValue);

                if (fValue == 0)
                {
                    bActivate = false;
                }
                else
                {
                    bActivate = true;
                }

                if (bActivate)
                {
                    //  do nothing
                }
                else
                {
                    ResetVideoMotionDetection(iDvr, iCameraNumber, out sResult);

                    if (!string.IsNullOrEmpty(sResult))
                    {
                        Audit("On Camera[" + iCameraNumber + "]. " + sResult, sMethod, AuditSeverity.Warning);
                    }
                }

                return true;
            }
            catch (Exception e)
            {
                Audit("On Camera[" + iCameraNumber + "]. " + e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool SetInput(int iDvr, int iCameraNumber, string sValue, string sEventMessage)
        {
            #region Data Members

            bool bActivate;

            string sResult;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                

                return true;
            }
            catch (Exception e)
            {
                Audit("On Camera[" + iCameraNumber + "]. " + e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool SetIntrusionDetection(int iDvr, int iCameraNumber, string sValue, string sEventMessage)
        {
            #region Data Members

            bool bActivate;

            float fValue;

            string sResult = "";
            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                fValue = float.Parse(sValue);

                if (fValue == 0)
                {
                    bActivate = false;
                }
                else
                {
                    bActivate = true;
                }

                if (bActivate)
                {
                    //  do nothing
                }
                else
                {
                    //DvtelResetIntrusionDetection(iCameraNumber, out sResult);

                    if (!string.IsNullOrEmpty(sResult))
                    {
                        Audit("On Camera[" + iCameraNumber + "]. " + sResult, sMethod, AuditSeverity.Warning);
                    }
                }

                return true;

            }
            catch (Exception e)
            {
                Audit("On Camera[" + iCameraNumber + "]. " + e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool SetApiTrigger(int iDvr, int iTrigger, string sValue, string sEventMessage)
        {
            bool bActivate;
            float fValue;

            fValue = float.Parse(sValue);

            if (fValue == 0)
            {
                bActivate = false;
            }
            else
            {
                bActivate = true;
            }


            int iAlarmsListenerThreadIndex = DvrClientConstants.NONE;
            for (int i = 0; i < m_AlarmsListenerThreadData.Length; i++)
            {
                if (m_AlarmsListenerThreadData[i].DvrId == iDvr)
                {
                    iAlarmsListenerThreadIndex = i;

                    break;
                }
            }

            if (iAlarmsListenerThreadIndex == DvrClientConstants.NONE)
            {
                return false;
            }

            return m_AlarmsListenerThread[iAlarmsListenerThreadIndex].SetApiTrigger(iDvr, iTrigger, bActivate, sEventMessage);
        }

        public bool SetOutDryContact(int iDvr, int iTrigger, string sValue, string sEventMessage)
        {
            //bool bActivate;

            //if (sValue.Substring(0, 3) == "0.0")
            //{
            //    bActivate = false;
            //}
            //else
            //{
            //    bActivate = true;
            //}

            //return m_AlarmsListenerThread.SetApiTrigger(iDvr, iTrigger, bActivate, sEventMessage);

            return true;
        }

        public bool SetGuiDisplayNumber(CameraInformation ciCameraInformation, int iDisplay)
        {
            m_bStartCameraByClick = true;

            StartCamera_X_on_Display_Y(ciCameraInformation,
                                        iDisplay,
                                        DvrClientConstants.NONE,
                                        "",
                                        true);


            return true;
        }

        private void SetProjectName(string sProjectName)
        {
            tv.Nodes[0].Text = sProjectName;
        }

        private void SetLayout(string sLayout)
        {
            string sNormalizedLayout;

            sNormalizedLayout = Utils.NormalizeLayout(sLayout);
            if (string.IsNullOrEmpty(sNormalizedLayout))
            {
                sNormalizedLayout = Utils.NormalizeLayout(sLayout.ToUpper());
            }
            sNormalizedLayout = sNormalizedLayout.ToUpper();

            switch (sNormalizedLayout)
            {
                case DvrClientConstants.ONE_VIEW_LAYOUT_STRING:
                    Switch2One();
                    break;

                case DvrClientConstants.FOUR_VIEW_LAYOUT_STRING:
                    Switch2Quad();
                    break;

                case DvrClientConstants.NINE_VIEW_LAYOUT_STRING:
                    Switch2Nine();
                    break;

                case DvrClientConstants.SIXTEEN_VIEW_LAYOUT_STRING:
                    Switch2Sixteen();
                    break;

                case DvrClientConstants.TWENTYFIVE_VIEW_LAYOUT_STRING:
                    Switch2TwentyFive();
                    break;

                case DvrClientConstants.THIRTYSIX_VIEW_LAYOUT_STRING:
                    Switch2ThirtySix();
                    break;

                case DvrClientConstants.SIX_ONE_BIG_LAYOUT_STRING:
                    Switch2SixOneBig();
                    break;

                case DvrClientConstants.EIGHT_ONE_BIG_LAYOUT_STRING:
                    Switch2EightOneBig();
                    break;

                case DvrClientConstants.FIVE_FOUR_UP_LAYOUT_STRING:
                    Switch2FiveFourUp();
                    break;

                case DvrClientConstants.FIVE_FOUR_DOWN_LAYOUT_STRING:
                    Switch2FiveFourDown();
                    break;

                case DvrClientConstants.THIRTEEN_SURROUND_LAYOUT_STRING:
                    Switch2ThirteenSurround();
                    break;

                case DvrClientConstants.TEN_TWO_QUADS_LAYOUT_STRING:
                    Switch2TenTwoQuads();
                    break;

                default:
                    break;
            }

            NoVideoPictureOnEmptyDisplays();
        }

        private void SetAsActiveDvrClient(string sValue)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sMessage;

            bool bValue; 

            #endregion

            try
            {
                if (m_Settings.HiveState != HiveState.On)
                {
                    sMessage = "Hive State Is Off";

                    Audit(sMessage, sMethod, AuditSeverity.Warning);
                    SendReplyMessage(false, sMessage);

                    return;
                }

                if (sValue.ToUpper() == "START")
                {
                    lblHiveState.Text = "Disconnected From Hive";
                    lblHiveState.BackColor = Color.Red;

                    return;
                }

                bValue = bool.Parse(sValue);
                if (bValue)
                {
                    lblHiveState.Text = "Active Via Hive";
                    lblHiveState.BackColor = Color.Green;

                    m_HiveStateStatus = HiveStateStatus.Active;

                    PEN_WIDTH = 2;
                    GAP = 6;                    
                }
                else
                {
                    lblHiveState.Text = "Waiting For Hive";
                    lblHiveState.BackColor = Color.Orange;

                    m_HiveStateStatus = HiveStateStatus.Waiting;

                    PEN_WIDTH = 2;
                    GAP = 3;
                }

                ArrangeDvrClientForm(sMethod);

                if (bValue)
                {
                    int iDisplayIndex = DisplayManager_GetActiveDisplayIndex();
                    if (iDisplayIndex == DvrClientConstants.NONE)
                    {
                        iDisplayIndex = 0;
                    }

                    HideSurroundingFrame(iDisplayIndex, sMethod);
                    ShowSurroundingFrame(iDisplayIndex, Color.Blue, sMethod);
                }

                SendReplyMessage(true, m_HiveStateStatus.ToString());
            }
            catch (Exception e)
            {
                sMessage = "Value[" + sValue + "]. " + e.Message;

                Audit(sMessage, sMethod, AuditSeverity.Error);
                SendReplyMessage(false, sMessage);
            }
        }

        private void SetActiveDisplay(string sValue, string sCalledFrom)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            int iDisplayIndex;

            try
            {
                iDisplayIndex = int.Parse(sValue);

                if (DisplayManager_DisplayIsFree(iDisplayIndex))
                {
                    Audit("Trying To Set As Active Display An Empty Display. Display[" +
                          iDisplayIndex +
                          "] Is Free.",
                          sMethod,
                          AuditSeverity.Information);

                    return;
                }

                DisplayManager_SetActiveDisplayIndex(iDisplayIndex);
                SetVideoPlayerFocus(iDisplayIndex);

                if (DisplayManager_GetActiveDisplayIndex() == DvrClientConstants.NONE)
                {
                    Audit("No Display In Focus", sMethod, AuditSeverity.Warning);

                    return;
                }

                Audit("Called From [" + sCalledFrom + "]. Setting Display[" + (iDisplayIndex + 1) + "] As Active.", 
                      sMethod, 
                      AuditSeverity.Information);

                HideSurroundingFrame(iDisplayIndex, sMethod);
                ShowSurroundingFrame(iDisplayIndex, Color.Blue, sMethod);
            }
            catch (Exception e)
            {
                Audit("Called From [" + sCalledFrom + "] Value[" + sValue + "]. " + e.Message, 
                      sMethod, 
                      AuditSeverity.Error);
            }
        }

        private void SetFullScreen(string sFullScreen)
        {
            bool bFullScreen = bool.Parse(sFullScreen);

            if (bFullScreen)
            {
                triFullScreen = Trinar.True;
            }
            else
            {
                triFullScreen = Trinar.False;
            }
            m_bKeyPressed = true;
        }

        public void SetPcimPulsePort(int iPcimPulsePort)        
        {
            m_Settings.PcimPulsePort = iPcimPulsePort;
        }

        public void SetPcimPulseStationID(int iPcimPulseStationID)
        {
            m_Settings.PcimPulseStationID = iPcimPulseStationID;
        }

        public void SetPulseDatabaseConnectioString(string sPulseDatabaseConnectioString)
        {
            if (string.IsNullOrEmpty(m_Settings.PulseDatabaseConnectionString))
            {
                m_Settings.PulseDatabaseConnectionString = sPulseDatabaseConnectioString;
            }
        }

        public void SetShowDisplayManagerViewer(bool bValue)
        {
            m_bShowDisplayManagerViewer = bValue;
        }

        public void SetShowDvrClientDataScope(bool bValue)
        {
            m_bShowDvrClientDataScope = bValue;
        }

        public void SetShowDvrsAndCamerasInformation(bool bValue)
        {
            m_bShowDvrsAndCamerasInformation = bValue;
        }

        public void SetShowSettings(bool bValue)
        {
            m_bShowSettings = bValue;
        }

        public void SetShowDisplayTemplate(bool bValue)
        {
            m_bShowDisplayTemplates = bValue;
        }

        #endregion

        #region Main View, Pre Defined View And PTZ Preset Stuff

        #region Pre Defined Views

        public List<PreDefinedView> GetAllPreDefinedViews()
        {
            try
            {
                return m_PreDefinedView;
            }
            catch (Exception)
            {
                return null;
            }
        }
        
        public List<PreDefinedViewCamera> GetThisPreDefinedViewCameras(string sPreDefinedView)
        {
            int i;
            int iSize = m_PreDefinedView.Count;

            for (i = 0; i < iSize; i++)
            {
                if (m_PreDefinedView[i].Name == sPreDefinedView)
                {
                    return m_PreDefinedView[i].Camera;
                }
            }

            return null;
        }

        public string GetThisPreDefinedViewLayout(string sPreDefinedView)
        {
            int i;
            int iSize = m_PreDefinedView.Count;

            for (i = 0; i < iSize; i++)
            {
                if (m_PreDefinedView[i].Name == sPreDefinedView)
                {
                    return m_PreDefinedView[i].Layout;
                }
            }

            return "";
        }

        public bool AddPreDefinedView(string sPreDefinedView, string sLayout, out string sResult)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            sResult = "";

            for (int i = 0; i < m_PreDefinedView.Count; i++)
            {
                if (m_PreDefinedView[i].Name.ToUpper() == sPreDefinedView.ToUpper())
                {
                    sResult = "Predefined View With The Name '" + sPreDefinedView + "' Already Exists";

                    return false;
                }
            }

            DbReturnCode dbRc = InsertPreDefinedView(sPreDefinedView, sLayout);
            if (dbRc == DbReturnCode.FinishedOK)
            {
                int iPreDefinedIndex = GetViewIndex(sPreDefinedView, ViewType.PredefinedView, out sResult);

                if (iPreDefinedIndex != DvrClientConstants.NONE)
                {
                    m_PreDefinedView.Add(new PreDefinedView(iPreDefinedIndex,
                                                            sPreDefinedView,
                                                            sLayout,
                                                            true,
                                                            "00:00",
                                                            "00:00"));
                    PrepareDvrTreeContextMenu();

                    return true;
                }
                else
                {
                    return false;
                }
            }
            else
            {
                sResult = "Failed Inserting Into Database. " + dbRc.ToString();

                return false;
            }
        }

        public bool UpdatePreDefinedView(string sPreDefinedView, string sLayout)
        {
            for (int i = 0; i < m_PreDefinedView.Count; i++)
            {
                if (m_PreDefinedView[i].Name == sPreDefinedView)
                {
                    PreDefinedView p = new PreDefinedView();

                    p = m_PreDefinedView[i];
                    p.Layout = sLayout;
                    m_PreDefinedView[i] = p;

                    return true;
                }
            }

            return false;
        }

        public bool AddCamera2PreDefinedView(string sPreDefinedView,
                                             string sSiteName,
                                             int iCameraNumber,
                                             int iDisplay,
                                             string sPresetToActivate,
                                             out string sError)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            int iMaxNumberOfDisplaysInLayout;
            int iPreDefinedViewId;

            #endregion

            for (int i = 0; i < m_PreDefinedView.Count; i++)
            {
                if (m_PreDefinedView[i].Name == sPreDefinedView)
                {
                    iMaxNumberOfDisplaysInLayout = Utils.GetNumberOfDisplaysInLayout(m_PreDefinedView[i].Layout);

                    if (iMaxNumberOfDisplaysInLayout != DvrClientConstants.NONE)
                    {
                        if (iMaxNumberOfDisplaysInLayout < iDisplay)
                        {
                            sError = "Layout '" + m_PreDefinedView[i].Layout +
                                     "' Has " + iMaxNumberOfDisplaysInLayout +
                                     " Displays In It. Display[" + iDisplay + "] Will Not Fit In Layout";

                            return false;
                        }
                    }

                    for (int j = 0; j < m_PreDefinedView[i].Camera.Count; j++)
                    {
                        if ((m_PreDefinedView[i].Camera[j].SiteName == sSiteName) &&
                            (m_PreDefinedView[i].Camera[j].CameraNumber == iCameraNumber)
                           )
                        {
                            sError = "Camera '" + iCameraNumber + "' Is Already In Use In This Pre Defined View";

                            return false;
                        }

                        if (m_PreDefinedView[i].Camera[j].Display == iDisplay)
                        {
                            sError = "Display '" + iDisplay + "' Is Already In Use In This Pre Defined View";

                            return false;
                        }
                    }

                    m_PreDefinedView[i].Camera.Add(new PreDefinedViewCamera(m_PreDefinedView[i].Id,
                                                                            sSiteName,
                                                                            iCameraNumber,
                                                                            iDisplay,
                                                                            sPresetToActivate));
                    sError = "";
                }
            }

            iPreDefinedViewId = GetViewIndex(sPreDefinedView, ViewType.PredefinedView, out sError);
            if (iPreDefinedViewId == DvrClientConstants.NONE)
            {
                return false;
            }

            if (InsertPreDefinedViewCamera(iPreDefinedViewId,
                                           sSiteName,
                                           iCameraNumber,
                                           iDisplay,
                                           sPresetToActivate) != DbReturnCode.FinishedOK)
            {
                sError = "Failed Inserting Into Pre Defined View '" + sPreDefinedView + "' " +
                         "DVR[" + sSiteName + "] " +
                         "Camera[" + iCameraNumber + "] " +
                         "Display[" + (iDisplay + 1) + "] " +
                         "Into 'PreDefinedViewsCameras' Table.";
            }
            else
            {
                return true;
            }

            sError = "Pre Defined View '" + sPreDefinedView + "' Does Not Exist";

            return false;
        }
        
        public bool DeleteCameraFromPreDefinedView(string sPreDefinedView,
                                           string sSiteName,
                                           int iCameraNumber,
                                           out string sError)
        {
            int iPreDefinedViewCameraId;

            for (int i = 0; i < m_PreDefinedView.Count; i++)
            {
                if (m_PreDefinedView[i].Name == sPreDefinedView)
                {
                    for (int j = 0; j < m_PreDefinedView[i].Camera.Count; j++)
                    {
                        if ((m_PreDefinedView[i].Camera[j].SiteName == sSiteName) &&
                            (m_PreDefinedView[i].Camera[j].CameraNumber == iCameraNumber)
                           )
                        {
                            iPreDefinedViewCameraId = m_PreDefinedView[i].Camera[j].Id;

                            m_PreDefinedView[i].Camera.RemoveAt(j);
                            sError = "";

                            if (DeletePreDefinedViewsCamera(iPreDefinedViewCameraId) == DbReturnCode.FinishedOK)
                            {
                                return true;
                            }
                            else
                            {
                                return false;
                            }
                        }
                    }
                }
            }

            sError = "Camera '" + iCameraNumber +
                     "' Of DVR '" + sSiteName +
                     "' For This Pre Defined View '" + sPreDefinedView + "' Does Not Exist";

            return false;
        }
        
        public int GetPreDefinedViewIndex(string sPreDefinedViewName, out string sError)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            sError = "";

            if (string.IsNullOrEmpty(sPreDefinedViewName))
            {
                sError = "Pre Defined View Name Is Null Or Empty";
                Audit(sError, sMethod, AuditSeverity.Warning);

                return DvrClientConstants.NONE;
            }

            if (m_MainView == null)
            {
                sError = "Pre Defined View List Null";
                Audit(sError, sMethod, AuditSeverity.Warning);

                return DvrClientConstants.NONE;
            }

            if (m_PreDefinedView.Count == 0)
            {
                sError = "Pre Defined View List Empty";
                Audit(sError, sMethod, AuditSeverity.Warning);

                return DvrClientConstants.NONE;
            }

            for (int i = 0; i < m_PreDefinedView.Count; i++)
            {
                if (m_PreDefinedView[i].Name == sPreDefinedViewName)
                {
                    return i;
                }
            }

            sError = "Could Not Find Pre Defined View '" + sPreDefinedViewName + "' In Pre Defined View List";
            Audit(sError, sMethod, AuditSeverity.Warning);

            return DvrClientConstants.NONE;
        }

        private bool StartPreDefinedView(string sPreDefinedView)
        {
            #region Data Members

            int iPreDefinedViewIndex;
            int iNumberOfCameras;
            int i;

            List<int> lOpenCamera = new List<int>();

            CameraInformation ciCameraInformation;

            string sResult;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                m_bCutMainViewInTheMiddle = true;
                iPreDefinedViewIndex = FindPreDefinedView(sPreDefinedView);

                if (iPreDefinedViewIndex == DvrClientConstants.NONE)
                {
                    Audit("Pre Defined View[" + sPreDefinedView + "] Does Not Exist", sMethod, AuditSeverity.Warning);

                    m_bCutMainViewInTheMiddle = false;
                    return false;
                }
                else
                {
                    Audit("Starting Pre Defined View[" + sPreDefinedView + "]", sMethod, AuditSeverity.Information);

                    iNumberOfCameras = m_PreDefinedView[iPreDefinedViewIndex].Camera.Count;

                    #region Check For Open Cameras

                    for (int iCamera = 0; iCamera < iNumberOfCameras; iCamera++)
                    {
                        string sSiteName = m_PreDefinedView[iPreDefinedViewIndex].Camera[iCamera].SiteName;
                        int iDvrId = (int.TryParse(sSiteName, out iDvrId) ? iDvrId : DvrClientConstants.NONE);
                        int iCameraNumber = m_PreDefinedView[iPreDefinedViewIndex].Camera[iCamera].CameraNumber;
                        bool bOpenedWithIndex;
                        int iDisplayIndex;
                        bool bOpen = DisplayManager_IsCameraOpen(iDvrId,
                                                                 iCameraNumber,
                                                                 out iDisplayIndex,
                                                                 out bOpenedWithIndex);
                        if (bOpen)
                        {
                            lOpenCamera.Add(iDisplayIndex);
                        }

                        DoEvents();
                    }

                    #endregion

                    if (iNumberOfCameras > 0)
                    {
                        //  First close all current displays
                        CloseAllCameras(lOpenCamera);

                        #region Activate Layout

                        if (m_PreDefinedView[iPreDefinedViewIndex].Layout != "")
                        {
                            switch (m_PreDefinedView[iPreDefinedViewIndex].Layout)
                            {
                                case "1 View":
                                case "OneView":
                                    Switch2One();
                                    break;

                                case "4 View":
                                case "QuadView":
                                    Switch2Quad();
                                    break;

                                case "9 View":
                                case "NineView":
                                    Switch2Nine();
                                    break;

                                case "16 View":
                                case "SixteenView":
                                    Switch2Sixteen();
                                    break;

                                case "25 View":
                                case "TwentyFiveView":
                                    Switch2TwentyFive();
                                    break;

                                case "36 View":
                                case "ThirtySixView":
                                    Switch2ThirtySix();
                                    break;

                                case "Six - One Big":
                                case "SixOneBig":
                                    Switch2SixOneBig();
                                    break;

                                case "Eight - One Big":
                                case "EightOneBig":
                                    Switch2EightOneBig();
                                    break;

                                case "Five - Four Up":
                                case "FiveFourUp":
                                    Switch2FiveFourUp();
                                    break;

                                case "Five - Four Down":
                                case "FiveFourDown":
                                    Switch2FiveFourDown();
                                    break;

                                case "Thirteen Surround":
                                case "ThirteenSurround":
                                    Switch2ThirteenSurround();
                                    break;

                                case "Ten - Two Quads":
                                case "TenTwoQuads":
                                    Switch2TenTwoQuads();
                                    break;

                                case "Two - Horizontal":
                                case "TwoHorizontal":
                                    Switch2TwoHorizontal();
                                    break;

                                case "Two - Vertical":
                                case "TwoVertical":
                                    Switch2TwoVertical();
                                    break;

                                default:
                                    break;
                            }

                            SetSpecialLayoutsMode(true);
                        }

                        #endregion
                    }
                    else
                    {
                        Audit("No Cameras To Open", sMethod, AuditSeverity.Information);

                        m_bCutMainViewInTheMiddle = false;

                        return false;
                    }

                    LoadingPictureOnEmptyDisplays();

                    iNumberOfCameras = Math.Min(iNumberOfCameras,
                                                Utils.GetNumberOfDisplaysInLayout(m_PreDefinedView[iPreDefinedViewIndex].Layout));
                    for (i = 0; i < iNumberOfCameras; i++)
                    {
                        m_bStartCameraByClick = true;
                        bool bOpenedWithIndex = false;
                        bool bOpenCamera = false;
                        int iDisplayIndex = DvrClientConstants.NONE;

                        if (m_bCutPredefinedViewInTheMiddle)
                        {
                            m_bCutPredefinedViewInTheMiddle = false;

                            Audit("Pre Defined View '" + sPreDefinedView + "' Stopped By Incomming Event",
                                  sMethod,
                                  AuditSeverity.Important);

                            m_bCutMainViewInTheMiddle = false;
                            return true;
                        }

                        string sSiteName = m_PreDefinedView[iPreDefinedViewIndex].Camera[i].SiteName;
                        int iDvrGroupId = -1;//(int.TryParse(Utils.GetNthSubString(sSiteName, ":", 1), out iDvrGroupId) ? iDvrGroupId : DvrClientConstants.NONE);
                        int iDvrId = int.Parse(sSiteName);//(int.TryParse(Utils.GetNthSubString(sSiteName, ":", 2), out iDvrId) ? iDvrId : DvrClientConstants.NONE);
                        int iCameraNumber = m_PreDefinedView[iPreDefinedViewIndex].Camera[i].CameraNumber;

                        ciCameraInformation = GetCameraInformation(iDvrId, iCameraNumber, out sResult);
                        if (ciCameraInformation == null)
                        {
                            Audit(sResult, sMethod, AuditSeverity.Warning);

                            return false;
                        }

                        if (DisplayManager_IsCameraOpen(ciCameraInformation,
                                                        out iDisplayIndex,
                                                        out bOpenedWithIndex))
                        {
                            if (m_PreDefinedView[iPreDefinedViewIndex].Camera[i].Display != (iDisplayIndex + 1))
                            {
                                bOpenCamera = true;
                            }
                            else
                            {
                                bOpenCamera = false;
                            }
                        }
                        else
                        {
                            bOpenCamera = true;
                        }

                        if (bOpenCamera)
                        {
                            StartCamera_X_on_Display_Y(ciCameraInformation,
                                                       m_PreDefinedView[iPreDefinedViewIndex].Camera[i].Display,
                                                       DvrClientConstants.NONE,
                                                       "",
                                                       false);
                        }


                        if ((IsPtzCamera(iDvrId, iCameraNumber)) &&
                            !string.IsNullOrEmpty(m_PreDefinedView[iPreDefinedViewIndex].Camera[i].PresetToActivate))
                        {
                            if (ActivatePreset(iDvrGroupId,
                                               iDvrId,
                                               iCameraNumber,
                                               m_PreDefinedView[iPreDefinedViewIndex].Camera[i].Display - 1,
                                               m_PreDefinedView[iPreDefinedViewIndex].Camera[i].PresetToActivate))
                            {
                                Audit("Pre Defined View[" + sPreDefinedView +
                                      "] Activated. Openning On Display[" + m_PreDefinedView[iPreDefinedViewIndex].Camera[i].Display +
                                      "] Camera[" + m_PreDefinedView[iPreDefinedViewIndex].Camera[i].CameraNumber +
                                      "] On DVR[" + m_PreDefinedView[iPreDefinedViewIndex].Camera[i].SiteName +
                                      "]. Preset[" + m_PreDefinedView[iPreDefinedViewIndex].Camera[i].PresetToActivate + "] Activated.",
                                      sMethod,
                                      AuditSeverity.Information);
                            }
                            else
                            {
                                Audit("Faild To Activate Pre Defined View[" + sPreDefinedView +
                                      "]. Can't Open On Display[" + m_PreDefinedView[iPreDefinedViewIndex].Camera[i].Display +
                                      "] Camera[" + m_PreDefinedView[iPreDefinedViewIndex].Camera[i].CameraNumber +
                                      "] On DVR[" + m_PreDefinedView[iPreDefinedViewIndex].Camera[i].SiteName +
                                      "] With Preset[" + m_PreDefinedView[iPreDefinedViewIndex].Camera[i].PresetToActivate +
                                      "].",
                                      sMethod,
                                      AuditSeverity.Warning);
                            }
                        }
                        else
                        {
                            if (bOpenCamera)
                            {
                                Audit("Pre Defined View[" + sPreDefinedView +
                                      "] Activated. Openning On Display[" + m_PreDefinedView[iPreDefinedViewIndex].Camera[i].Display +
                                      "] Camera[" + m_PreDefinedView[iPreDefinedViewIndex].Camera[i].CameraNumber +
                                      "] On DVR[" + m_PreDefinedView[iPreDefinedViewIndex].Camera[i].SiteName +
                                      "]",
                                      sMethod, 
                                      AuditSeverity.Information);
                            }
                            else
                            {
                                Audit("Pre Defined View[" + sPreDefinedView +
                                      "] Activated. On Display[" + m_PreDefinedView[iPreDefinedViewIndex].Camera[i].Display +
                                      "] Camera[" + m_PreDefinedView[iPreDefinedViewIndex].Camera[i].CameraNumber +
                                      "] On DVR[" + m_PreDefinedView[iPreDefinedViewIndex].Camera[i].SiteName +
                                      "] Is Already Open.",
                                      sMethod,
                                      AuditSeverity.Information);
                            }
                        }

                        DoEvents();
                    }

                    CustomizeDisplays(sMethod);
                    NoVideoPictureOnEmptyDisplays();
                }

                m_bCutMainViewInTheMiddle = false;
                return true;
            }
            catch (Exception e)
            {
                Audit("Problem Loading Pre Defined View[" + sPreDefinedView + "]." + e.Message, sMethod, AuditSeverity.Error);

                m_bCutMainViewInTheMiddle = false;

                return false;
            }
        }

        public bool DeletePreDefinedView(string sPreDefinedView, out string sError)
        {
            #region Data Members

            int iPreDefinedViewIndex;
            int iPreDefinedViewId;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iPreDefinedViewIndex = FindPreDefinedView(sPreDefinedView);
                if (iPreDefinedViewIndex == DvrClientConstants.NONE)
                {
                    sError = "The Pre Defined View Does Not Exist In The Array";
                    return false;
                }

                iPreDefinedViewId = m_PreDefinedView[iPreDefinedViewIndex].Id;
                m_PreDefinedView.RemoveRange(iPreDefinedViewIndex, 1);

                if (DeletePreDefinedViewsCameras(iPreDefinedViewId) != DbReturnCode.FinishedOK)
                {
                    sError = "Failed Deleting Pre Defined View Cameras For ID '" + iPreDefinedViewId + "'";
                    return false;
                }

                if (DeletePreDefinedView(iPreDefinedViewId) != DbReturnCode.FinishedOK)
                {
                    sError = "Failed Deleting Pre Defined View ID '" + iPreDefinedViewId + "'";
                    return false;
                }

                PrepareDvrTreeContextMenu();

                sError = "";
                return true;
            }

            catch (Exception e)
            {
                sError = "Can't Remove Pre Defined View[" + sPreDefinedView + "]." + e.Message;
                Audit(sError, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool UpdatePreDefinedView(string sPreDefinedView, string sNewPreDefinedView, out string sError)
        {
            int iPreDefinedViewIndex;
            int iNewPreDefinedViewIndex;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                iPreDefinedViewIndex = FindPreDefinedView(sPreDefinedView);
                if (iPreDefinedViewIndex == DvrClientConstants.NONE)
                {
                    sError = "The Pre Defined View Does Not Exist In The Array";

                    return false;
                }

                iNewPreDefinedViewIndex = FindPreDefinedView(sNewPreDefinedView);
                if (iNewPreDefinedViewIndex != DvrClientConstants.NONE)
                {
                    sError = "The New Pre Defined View Name Already Exist In The Array";

                    return false;
                }

                PreDefinedView pdv = m_PreDefinedView[iPreDefinedViewIndex];
                pdv.ChangeName(sNewPreDefinedView);
                m_PreDefinedView[iPreDefinedViewIndex] = pdv;

                PrepareDvrTreeContextMenu();

                sError = "";
                return true;
            }

            catch (Exception e)
            {
                sError = "Can't Remove Pre Defined View[" + sPreDefinedView + "]." + e.Message;
                Audit(sError, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool UpdatePreDefinedView(int iPreDefinedViewId,
                                         string sPreDefinedView,
                                         string sLayout,
                                         out string sResult)
        {
            int iPreDefinedViewIndex;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                iPreDefinedViewIndex = FindPreDefinedView(iPreDefinedViewId);
                if (iPreDefinedViewIndex == DvrClientConstants.NONE)
                {
                    sResult = "The Pre Defined View Does Not Exist In The Array";

                    return false;
                }

                PreDefinedView pdv = m_PreDefinedView[iPreDefinedViewIndex];

                pdv.ChangeName(sPreDefinedView);
                pdv.ChangeLayout(sLayout);

                m_PreDefinedView[iPreDefinedViewIndex] = pdv;

                DbReturnCode dbRc = UpdatePreDefinedViewRecord(iPreDefinedViewId, sPreDefinedView, sLayout);
                if (dbRc == DbReturnCode.FinishedOK)
                {
                    PrepareDvrTreeContextMenu();

                    sResult = "";
                    return true;
                }
                else
                {
                    sResult = "Failed Updating Pre Defined View Record.\n" + Utils.GetEnumDescription(dbRc);

                    return false;
                }
            }

            catch (Exception e)
            {
                sResult = "Can't Update Pre Defined View ID[" + iPreDefinedViewId + "]." + e.Message;
                Audit(sResult, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private void AddPreDefinedViewCamera(int iPreDefinedViewIndex,
                                             string sSiteName,
                                             int iCameraNumber,
                                             int iDisplay,
                                             string sPreDefinedViewToActivate)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                m_PreDefinedView[iPreDefinedViewIndex].Camera.Add(new PreDefinedViewCamera(DvrClientConstants.NONE,
                                                                                           sSiteName,
                                                                                           iCameraNumber,
                                                                                           iDisplay,
                                                                                           sPreDefinedViewToActivate));
            }
            catch (Exception e)
            {
                Audit("Can't Add Camera[" +
                      iCameraNumber.ToString() +
                      "] From Site[" +
                      sSiteName +
                      "] To Pre Defined View[" +
                      m_PreDefinedView[iPreDefinedViewIndex].Name +
                      "]." +
                      e.Message,
                      sMethod, 
                      AuditSeverity.Error);
            }
        }

        private bool FindPreDefinedViewCamrea(int iPreDefinedViewIndex, string sSiteName, int iCameraNumber)
        {
            int i;
            int iNumberOfCameras;

            //if (m_PreDefinedView[iPresetIndex].Camera == null)
            //{
            //    return false;
            //}

            iNumberOfCameras = m_PreDefinedView[iPreDefinedViewIndex].Camera.Count;
            for (i = 0; i < iNumberOfCameras; i++)
            {
                if ((m_PreDefinedView[iPreDefinedViewIndex].Camera[i].SiteName == sSiteName) &&
                    (m_PreDefinedView[iPreDefinedViewIndex].Camera[i].CameraNumber == iCameraNumber))
                {
                    return true;
                }
            }

            return false;
        }

        private int FindPreDefinedView(int iPreDefinedViewId)
        {
            int iSize;
            int i;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                iSize = m_PreDefinedView.Count;

                for (i = 0; i < iSize; i++)
                {
                    if (m_PreDefinedView[i].Id == iPreDefinedViewId)
                    {
                        return i;
                    }
                }

                return DvrClientConstants.NONE;
            }

            catch (Exception e)
            {
                Audit("Couldn't Find Pre Defined View Id[" + iPreDefinedViewId + "]." + e.Message,
                      sMethod, 
                      AuditSeverity.Error);

                return DvrClientConstants.NONE;
            }
        }

        private int FindPreDefinedView(string sPreDefinedView)
        {
            int iSize;
            int i;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                iSize = m_PreDefinedView.Count;

                for (i = 0; i < iSize; i++)
                {
                    if (m_PreDefinedView[i].Name.ToUpper() == sPreDefinedView.ToUpper())
                    {
                        return i;
                    }
                }

                return DvrClientConstants.NONE;
            }

            catch (Exception e)
            {
                Audit("Couldn't Find Pre Defined View[" + sPreDefinedView + "]." + e.Message,
                      sMethod, 
                      AuditSeverity.Error);

                return DvrClientConstants.NONE;
            }
        }

        public bool PreDefinedViewExists(string sPredefinedView)
        {
            int iPreDefinedViewIndex = FindPreDefinedView(sPredefinedView);

            if (iPreDefinedViewIndex != DvrClientConstants.NONE)
            {
                return true;
            }

            return false;
        }

        #endregion

        #region Main Views

        public List<PreDefinedView> GetAllMainViews()
        {
            try
            {
                return m_MainView;
            }
            catch (Exception)
            {
                return null;
            }
        }

        public List<PreDefinedViewCamera> GetThisMainViewCameras(string sMainView)
        {
            int i;
            int iSize = m_MainView.Count;

            for (i = 0; i < iSize; i++)
            {
                if (m_MainView[i].Name == sMainView)
                {
                    return m_MainView[i].Camera;
                }
            }

            return null;
        }

        public bool AddMainView(string sMainView,
                                string sLayout,
                                string sStartTime,
                                string sEndTime,
                                out string sError)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;

            sError = ""; 

            #endregion

            try
            {
                if (m_MainView == null)
                {
                    sError = "Main View Is Null";

                    return false;
                }

                for (int i = 0; i < m_MainView.Count; i++)
                {
                    if (m_MainView[i].Name == sMainView)
                    {
                        sError = "Main View With The Name '" + sMainView + "' Already Exists";

                        return false;
                    }
                }

                DbReturnCode dbRc = InsertMainView(sMainView, sLayout, sStartTime, sEndTime);
                if (dbRc == DbReturnCode.FinishedOK)
                {
                    int iMainViewId = GetViewIndex(sMainView, ViewType.MainView, out sError);

                    if (iMainViewId != DvrClientConstants.NONE)
                    {
                        m_MainView.Add(new PreDefinedView(iMainViewId,
                                                          sMainView,
                                                          sLayout,
                                                          false,
                                                          sStartTime,
                                                          sEndTime));
                    }
                    else
                    {
                        return false;
                    }

                    return true;
                }
                else
                {
                    sError = "Failed Inserting Into Database. " + dbRc.ToString();

                    return false;
                }
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool DuplicatePreDefinedViewCameraRecordToMainViewCameraRecord(string sPredefinedView)
        {
            #region Data Members
            
            string sError;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sMessage;

            bool bRc; 

            #endregion

            try
            {
                if (m_PreDefinedView == null)
                {
                    Audit("Pre Defined Views List Is Null", sMethod, AuditSeverity.Warning);

                    return false;
                }

                for (int i = 0; i < m_PreDefinedView.Count; i++)
                {
                    if (m_PreDefinedView[i].Name == sPredefinedView)
                    {
                        Audit("Duplicating Predefined View[" + sPredefinedView +
                              "] Cameras To Main View[" + sPredefinedView + " MV]",
                              sMethod,
                              AuditSeverity.Information);

                        for (int j = 0; j < m_PreDefinedView[i].Camera.Count; j++)
                        {
                            sMessage = "Main View Name[" + sPredefinedView + " MV] " +
                                       "Site Name[" + m_PreDefinedView[i].Camera[j].SiteName + "] " +
                                       "Camera Number[" + m_PreDefinedView[i].Camera[j].CameraNumber + "] " +
                                       "Display Number[" + m_PreDefinedView[i].Camera[j].Display + "] " +
                                       "Preset To Activate[" + m_PreDefinedView[i].Camera[j].PresetToActivate + "] ";

                            bRc = AddCamera2MainView(sPredefinedView + " MV",
                                                     m_PreDefinedView[i].Camera[j].SiteName,
                                                     m_PreDefinedView[i].Camera[j].CameraNumber,
                                                     m_PreDefinedView[i].Camera[j].Display,
                                                     m_PreDefinedView[i].Camera[j].PresetToActivate,
                                                     out sError);
                            if (!bRc)
                            {
                                Audit(sMessage + ". " + sError, sMethod, AuditSeverity.Warning);
                            }
                            else
                            {
                                Audit("Added To Main View[" + sPredefinedView + " MV" + "]" +
                                      " Camera[" + m_PreDefinedView[i].Camera[j].CameraNumber +
                                      "] On Dvr[" + m_PreDefinedView[i].Camera[j].SiteName + "]" +
                                      " To Display[" + m_PreDefinedView[i].Camera[j].Display + "]",
                                      sMethod,
                                      AuditSeverity.Information);
                            }
                        }
                    }
                }

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool TransformPreDefinedViewToMainView(string sMainView,
                                                      string sLayout,
                                                      string sStartTime,
                                                      string sEndTime,
                                                      out string sError)
        {
            int i;

            try
            {
                sError = "";

                if (m_MainView == null)
                {
                    sError = "Main View Is Null";

                    return false;
                }

                for (i = 0; i < m_MainView.Count; i++)
                {
                    if (m_MainView[i].Name == sMainView)
                    {
                        sError = "Main View With The Name '" + sMainView + "' Already Exists";

                        return false;
                    }
                }

                m_MainView.Add(new PreDefinedView(DvrClientConstants.NONE,
                                                  sMainView,
                                                  sLayout,
                                                  false,
                                                  sStartTime,
                                                  sEndTime));
                DbReturnCode dbRc = ChangePreDefinedViewRecordToMainViewRecord(sMainView,
                                                                               sStartTime,
                                                                               sEndTime);
                if (dbRc == DbReturnCode.FinishedOK)
                {
                    int iPreDefinedViewCount = m_PreDefinedView.Count;
                    for (i = 0; i < iPreDefinedViewCount; i++)
                    {
                        if (m_PreDefinedView[i].Name == sMainView)
                        {
                            m_PreDefinedView.RemoveAt(i);
                            i = iPreDefinedViewCount;
                        }
                    }

                    return true;
                }
                else
                {
                    sError = "Failed Inserting Into Database. " + dbRc.ToString();

                    return false;
                }
            }
            catch (Exception e)
            {
                sError = e.Message;

                return false;
            }
        }

        public bool AddCamera2MainView(string sMainView,
                               string sSiteName,
                               int iCameraNumber,
                               int iDisplay,
                               string sPresetToActivate,
                               out string sError)
        {
            int iMaxNumberOfDisplaysInLayout;

            for (int i = 0; i < m_MainView.Count; i++)
            {
                if (m_MainView[i].Name == sMainView)
                {
                    iMaxNumberOfDisplaysInLayout = Utils.GetNumberOfDisplaysInLayout(m_MainView[i].Layout);

                    if (iMaxNumberOfDisplaysInLayout != DvrClientConstants.NONE)
                    {
                        if (iMaxNumberOfDisplaysInLayout < iDisplay)
                        {
                            sError = "Layout '" + m_MainView[i].Layout +
                                     "' Has " + iMaxNumberOfDisplaysInLayout +
                                     " Displays In It. Display[" + iDisplay + "] Will Not Fit In Layout";

                            return false;
                        }
                    }

                    for (int j = 0; j < m_MainView[i].Camera.Count; j++)
                    {
                        if ((m_MainView[i].Camera[j].SiteName == sSiteName) &&
                            (m_MainView[i].Camera[j].CameraNumber == iCameraNumber)
                           )
                        {
                            sError = "Camera '" + iCameraNumber + "' Is Already In Use In This Main View";

                            return false;
                        }

                        if (m_MainView[i].Camera[j].Display == iDisplay)
                        {
                            sError = "Display '" + iDisplay + "' Is Already In Use In This Main View";

                            return false;
                        }
                    }

                    m_MainView[i].Camera.Add(new PreDefinedViewCamera(m_MainView[i].Id,
                                                                      sSiteName,
                                                                      iCameraNumber,
                                                                      iDisplay,
                                                                      sPresetToActivate));
                    DbReturnCode dbRc = InsertPreDefinedViewCamera(m_MainView[i].Id,
                                                                   sSiteName,
                                                                   iCameraNumber,
                                                                   iDisplay,
                                                                   sPresetToActivate);

                    sError = "";
                    if (dbRc == DbReturnCode.FinishedOK)
                    {
                        return true;
                    }
                    else
                    {
                        sError = "Failed Inserting Main View Camera";

                        return false;
                    }
                }
            }

            sError = "Main View '" + sMainView + "' Does Not Exist";

            return false;
        }

        public bool UpdateCamera2MainView(string sMainView,
                                          string sSiteName,
                                          int iCameraNumber,
                                          int iDisplay,
                                          int iViewCameraIndex,
                                          string sPreset,
                                          out string sError)
        {
            int iCameraInUse = DvrClientConstants.NONE;
            int iDisplayInUse = DvrClientConstants.NONE;
            int iCameraIndex = DvrClientConstants.NONE;

            for (int i = 0; i < m_MainView.Count; i++)
            {
                if (m_MainView[i].Name == sMainView)
                {
                    for (int j = 0; j < m_MainView[i].Camera.Count; j++)
                    {
                        if (m_MainView[i].Camera[j].Display == iDisplay)
                        {
                            iDisplayInUse = j;
                        }

                        if ((m_MainView[i].Camera[j].SiteName == sSiteName) &&
                            (m_MainView[i].Camera[j].CameraNumber == iCameraNumber))
                        {
                            iCameraInUse = j;
                        }

                        if (m_MainView[i].Camera[j].Id == iViewCameraIndex)
                        {
                            iCameraIndex = j;                            
                        }
                    }

                    //  index not found. no record to update.
                    if (iCameraIndex == DvrClientConstants.NONE)
                    {
                        sError = "Main View Camera Record With ID[" + iViewCameraIndex + "] Does Not Exist";

                        return false; 
                    }

                    //  trying to update the record with same data as it contains.
                    if ((iCameraInUse == iCameraIndex) &&
                        (iDisplayInUse == iCameraIndex))
                    {
                        sError = "No Update Needed. No Parameter Was Changed.";

                        return false;
                    }

                    if (iDisplayInUse != DvrClientConstants.NONE)
                    {
                        if ((iCameraInUse == iCameraIndex) &&
                                        (iDisplayInUse != iCameraIndex))
                        {
                            sError = "Display[" + iDisplay + "] Already In Use.";

                            return false;
                        } 
                    }

                    if (iCameraInUse != DvrClientConstants.NONE)
                    {
                        if ((iCameraInUse != iCameraIndex) &&
                            (iDisplayInUse == iCameraIndex))
                        {
                            sError = "Camera[" + iCameraNumber + "] On Dvr[" + sSiteName + "] Already In Use.";

                            return false;
                        }
                    }

                    PreDefinedViewCamera pdvc = new PreDefinedViewCamera();

                    pdvc = m_MainView[i].Camera[iCameraIndex];

                    pdvc.SiteName = sSiteName;
                    pdvc.CameraNumber = iCameraNumber;
                    pdvc.PresetToActivate = sPreset;
                    pdvc.Display = iDisplay;

                    m_MainView[i].Camera[iCameraIndex] = pdvc;

                    DbReturnCode dbRc = UpdatePreDefinedViewCameraRecord(iViewCameraIndex,
                                                                         sSiteName,
                                                                         iCameraNumber,
                                                                         iDisplay,
                                                                         sPreset);

                    sError = "";
                    if (dbRc == DbReturnCode.FinishedOK)
                    {
                        return true;
                    }
                    else
                    {
                        sError = "Failed Updating Main View Camera ID[" + iViewCameraIndex +
                                 "] Dvr[" + sSiteName +
                                 "] Camera[" + iCameraNumber +
                                 "] Display[" + iDisplay +
                                 "] Preset[" + sPreset + "]";

                        return false;
                    }
                }
            }

            sError = "Main View '" + sMainView + "' Does Not Exist";

            return false;
        }

        public bool DeleteCameraFromMainView(string sMainView,
                                     string sSiteName,
                                     int iCameraNumber,
                                     out string sError)
        {
            for (int i = 0; i < m_MainView.Count; i++)
            {
                if (m_MainView[i].Name == sMainView)
                {
                    for (int j = 0; j < m_MainView[i].Camera.Count; j++)
                    {
                        if ((m_MainView[i].Camera[j].SiteName == sSiteName) &&
                            (m_MainView[i].Camera[j].CameraNumber == iCameraNumber)
                           )
                        {
                            m_MainView[i].Camera.RemoveAt(j);
                            sError = "";



                            return true;
                        }
                    }
                }
            }

            sError = "Camera '" + iCameraNumber +
                     "' Of DVR '" + sSiteName +
                     "' For This Main View '" + sMainView + "' Does Not Exist";

            return false;
        }

        public int GetMainViewIndex(string sMainViewName, out string sError)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            sError = "";

            if (string.IsNullOrEmpty(sMainViewName))
            {
                sError = "Main View Name Is Null Or Empty";
                Audit(sError, sMethod, AuditSeverity.Warning);

                return DvrClientConstants.NONE;
            }

            if (m_MainView == null)
            {
                sError = "Main View List Null";
                Audit(sError, sMethod, AuditSeverity.Warning);

                return DvrClientConstants.NONE;
            }

            if (m_MainView.Count == 0)
            {
                sError = "Main View List Empty";
                Audit(sError, sMethod, AuditSeverity.Warning);

                return DvrClientConstants.NONE;
            }

            for (int i = 0; i < m_MainView.Count; i++)
            {
                if (m_MainView[i].Name == sMainViewName)
                {
                    return i;
                }
            }

            sError = "Could Not Find Main View '" + sMainViewName + "' In Main View List";
            Audit(sError, sMethod, AuditSeverity.Warning);

            return DvrClientConstants.NONE;
        }

        private int FindMainView(int iMainViewId)
        {
            int iSize;
            int i;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                iSize = m_MainView.Count;

                for (i = 0; i < iSize; i++)
                {
                    if (m_MainView[i].Id == iMainViewId)
                    {
                        return i;
                    }
                }

                return DvrClientConstants.NONE;
            }

            catch (Exception e)
            {
                Audit("Couldn't Find Main View Id[" + iMainViewId + "]." + e.Message, sMethod, AuditSeverity.Error);

                return DvrClientConstants.NONE;
            }
        }

        private int FindMainView(string sMainView)
        {
            int iSize;
            int i;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                iSize = m_MainView.Count;

                for (i = 0; i < iSize; i++)
                {
                    if (m_MainView[i].Name.ToUpper() == sMainView.ToUpper())
                    {
                        return i;
                    }
                }

                return DvrClientConstants.NONE;
            }

            catch (Exception e)
            {
                Audit("Couldn't Find Main View[" + sMainView + "]." + e.Message, sMethod, AuditSeverity.Error);

                return DvrClientConstants.NONE;
            }
        }

        public bool DeleteMainView(string sMainView, out string sError)
        {
            #region Data Members

            int iMainViewId;
            int iMainViewIndex;

            DbReturnCode dbRc;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iMainViewIndex = FindMainView(sMainView);
                if (iMainViewIndex == DvrClientConstants.NONE)
                {
                    sError = "The Main View Does Not Exist In The Array";
                    return false;
                }

                iMainViewId = m_MainView[iMainViewIndex].Id;

                m_MainView.RemoveRange(iMainViewIndex, 1);

                dbRc = DeleteMainView(sMainView);
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    Audit("Failed Deleting Main View '" + sMainView + "'. " + dbRc.ToString(), 
                          sMethod, 
                          AuditSeverity.Warning);
                }
                else
                {
                    Audit("Deleted Main View '" + sMainView + "'.", sMethod, AuditSeverity.Information);
                }

                dbRc = DeletePreDefinedViewsCameras(iMainViewId);
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    Audit("Failed Deleting Main View '" + sMainView + "' Cameras. " + dbRc.ToString(),
                          sMethod, 
                          AuditSeverity.Warning);
                }
                else
                {
                    Audit("Deleted Main View '" + sMainView + "' Cameras.", sMethod, AuditSeverity.Information);
                }

                sError = "";
                return true;
            }

            catch (Exception e)
            {
                sError = "Can't Remove Main View[" + sMainView + "]." + e.Message;
                Audit(sError, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool UpdateMainView(int iMainViewId,
                                   string sMainView,
                                   string sLayout,
                                   string sStartTime,
                                   string sEndTime,
                                   out string sError)
        {
            #region Data Members

            int iMainViewIndex;

            DbReturnCode dbRc;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iMainViewIndex = FindMainView(iMainViewId);
                if (iMainViewIndex == DvrClientConstants.NONE)
                {
                    sError = "The Main View Does Not Exist In The Array";

                    return false;
                }

                PreDefinedView mv = m_MainView[iMainViewIndex];

                mv.ChangeName(sMainView);
                mv.ChangeLayout(sLayout);
                mv.ChangeStartTime(sStartTime);
                mv.ChangeEndTime(sEndTime);

                m_MainView[iMainViewIndex] = mv;

                dbRc = UpdateMainViewRecord(iMainViewId,
                                            sMainView,
                                            sLayout,
                                            sStartTime,
                                            sEndTime);
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    Audit("Failed Updating Main View '" + sMainView + "'. " + dbRc.ToString(), 
                          sMethod, 
                          AuditSeverity.Warning);
                }
                else
                {
                    Audit("Updated Main View '" + sMainView + "'.", sMethod, AuditSeverity.Information);
                }

                sError = "";

                return true;
            }

            catch (Exception e)
            {
                sError = "Can't Remove Main View[" + sMainView + "]." + e.Message;
                Audit(sError, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool DeleteAllMainViews(out string sError)
        {
            #region Data Members

            int iMainViewIndex;
            int iMainViewId;
            int i;

            DbReturnCode dbRc;

            string sMainView = "";
            string sMethod = MethodBase.GetCurrentMethod().Name;

            List<string> lMainViewName = new List<string>();
            List<int> lMainViewId = new List<int>();

            #endregion

            try
            {
                for (i = 0; i < m_MainView.Count; i++)
                {
                    lMainViewName.Add(m_MainView[i].Name);
                    lMainViewId.Add(m_MainView[i].Id);
                }

                for (i = 0; i < lMainViewName.Count; i++)
                {
                    iMainViewIndex = i;
                    if (iMainViewIndex == DvrClientConstants.NONE)
                    {
                        sError = "The Main View Does Not Exist In The Array";

                        return false;
                    }

                    iMainViewId = lMainViewId[i];
                    sMainView = lMainViewName[i];
                    m_MainView.RemoveAt(0);

                    dbRc = DeleteMainView(sMainView);
                    if (dbRc != DbReturnCode.FinishedOK)
                    {
                        Audit("Failed Deleting Main View '" + sMainView + "'. " + dbRc.ToString(), 
                              sMethod,
                              AuditSeverity.Warning);
                    }
                    else
                    {
                        Audit("Deleted Main View '" + sMainView + "'.", sMethod, AuditSeverity.Information);
                    }

                    dbRc = DeletePreDefinedViewsCameras(iMainViewId);
                    if (dbRc != DbReturnCode.FinishedOK)
                    {
                        Audit("Failed Deleting Main View '" + sMainView + "' Cameras. " + dbRc.ToString(), 
                              sMethod, 
                              AuditSeverity.Warning);
                    }
                    else
                    {
                        Audit("Deleted Main View '" + sMainView + "' Cameras.", sMethod, AuditSeverity.Information);
                    }
                }

                sError = "";
                return true;
            }

            catch (Exception e)
            {
                sError = "Can't Remove Main View[" + sMainView + "]." + e.Message;
                Audit(sError, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private void StartMainView(string sMainView)
        {
            #region Data Members

            bool bOpenedWithIndex;
            bool bOpenCamera;

            int iMainViewIndex;
            int iNumberOfCameras;
            int i;
            int iDisplayIndex;
            int iDvrGroupId;
            int iDvrId;
            int iCameraNumber;

            List<int> lOpenCamera = new List<int>();
            CameraInformation ciCameraInformation;

            string sResult;
            string sSiteName;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                m_bCutPredefinedViewInTheMiddle = true;
                iMainViewIndex = FindMainView(sMainView);

                if (iMainViewIndex == DvrClientConstants.NONE)
                {
                    Audit("Main View[" + sMainView + "] Does Not Exist", sMethod, AuditSeverity.Warning);
                }
                else
                {
                    Audit("Starting Main View[" + sMainView + "]", sMethod, AuditSeverity.Information);

                    iNumberOfCameras = m_MainView[iMainViewIndex].Camera.Count;

                    for (int iCamera = 0; iCamera < iNumberOfCameras; iCamera++)
                    {
                        sSiteName = m_MainView[iMainViewIndex].Camera[iCamera].SiteName;
                        iDvrGroupId = -1;// int.Parse(Utils.GetNthSubString(sSiteName, ":", 1));
                        iDvrId = int.Parse(sSiteName);//int.Parse(Utils.GetNthSubString(sSiteName, ":", 2));
                        iCameraNumber = m_MainView[iMainViewIndex].Camera[iCamera].CameraNumber;

                        ciCameraInformation = GetCameraInformation(iDvrId, iCameraNumber, out sResult);
                        if (ciCameraInformation == null)
                        {
                            Audit(sResult, sMethod, AuditSeverity.Warning);

                            return;
                        }

                        bool bOpen = DisplayManager_IsCameraOpen(ciCameraInformation,
                                                                 out iDisplayIndex,
                                                                 out bOpenedWithIndex);
                        if (bOpen)
                        {
                            lOpenCamera.Add(iDisplayIndex);
                        }
                    }

                    if (iNumberOfCameras > 0)
                    {
                        //  First close all current displays
                        CloseAllCameras(lOpenCamera);

                        #region Activate Layout

                        if (m_MainView[iMainViewIndex].Layout != "")
                        {
                            switch (m_MainView[iMainViewIndex].Layout)
                            {
                                case "1 View":
                                case "OneView":
                                    Switch2One();
                                    break;

                                case "4 View":
                                case "QuadView":
                                    Switch2Quad();
                                    break;

                                case "9 View":
                                case "NineView":
                                    Switch2Nine();
                                    break;

                                case "16 View":
                                case "SixteenView":
                                    Switch2Sixteen();
                                    break;

                                case "25 View":
                                case "TwentyFiveView":
                                    Switch2TwentyFive();
                                    break;

                                case "36 View":
                                case "ThirtySixView":
                                    Switch2ThirtySix();
                                    break;

                                case "Six - One Big":
                                case "SixOneBig":
                                    Switch2SixOneBig();
                                    break;

                                case "Eight - One Big":
                                case "EightOneBig":
                                    Switch2EightOneBig();
                                    break;

                                case "Five - Four Up":
                                case "FiveFourUp":
                                    Switch2FiveFourUp();
                                    break;

                                case "Five - Four Down":
                                case "FiveFourDown":
                                    Switch2FiveFourDown();
                                    break;

                                case "Thirteen Surround":
                                case "ThirteenSurround":
                                    Switch2ThirteenSurround();
                                    break;

                                case "Ten - Two Quads":
                                case "TenTwoQuads":
                                    Switch2TenTwoQuads();
                                    break;

                                case "Two - Horizontal":
                                case "TwoHorizontal":
                                    Switch2TwoHorizontal();
                                    break;

                                case "Two - Vertical":
                                case "TwoVertical":
                                    Switch2TwoVertical();
                                    break;

                                default:
                                    break;
                            }

                            SetSpecialLayoutsMode(true);
                        }

                        #endregion
                    }
                    else
                    {
                        Audit("No Cameras To Open", sMethod, AuditSeverity.Information);

                        m_bCutPredefinedViewInTheMiddle = false;
                        return;
                    }

                    LoadingPictureOnEmptyDisplays();

                    iNumberOfCameras = Math.Min(iNumberOfCameras,
                                                Utils.GetNumberOfDisplaysInLayout(m_MainView[iMainViewIndex].Layout));
                    for (i = 0; i < iNumberOfCameras; i++)
                    {
                        m_bStartCameraByClick = true;
                        bOpenedWithIndex = false;
                        bOpenCamera = false;
                        iDisplayIndex = DvrClientConstants.NONE;

                        sSiteName = m_MainView[iMainViewIndex].Camera[i].SiteName;
                        iDvrGroupId = -1;//int.Parse(Utils.GetNthSubString(sSiteName, ":", 1));
                        iDvrId = int.Parse(sSiteName);//int.Parse(Utils.GetNthSubString(sSiteName, ":", 2));
                        iCameraNumber = m_MainView[iMainViewIndex].Camera[i].CameraNumber;

                        ciCameraInformation = GetCameraInformation(iDvrId, iCameraNumber, out sResult);
                        if (ciCameraInformation == null)
                        {
                            Audit(sResult, sMethod, AuditSeverity.Warning);

                            return;
                        }

                        bool bOpen = DisplayManager_IsCameraOpen(ciCameraInformation,
                                                                 out iDisplayIndex,
                                                                 out bOpenedWithIndex);


                        if (m_bCutMainViewInTheMiddle)
                        {
                            m_bCutMainViewInTheMiddle = false;

                            Audit("Main View '" + sMainView + "' Stopped By Incomming Event",
                                  sMethod, 
                                  AuditSeverity.Information);

                            m_bCutPredefinedViewInTheMiddle = false;
                            return;
                        }

                        if (DisplayManager_IsCameraOpen(ciCameraInformation,
                                                        out iDisplayIndex,
                                                        out bOpenedWithIndex))
                        {
                            if (m_MainView[iMainViewIndex].Camera[i].Display != (iDisplayIndex + 1))
                            {
                                bOpenCamera = true;
                            }
                            else
                            {
                                bOpenCamera = false;
                            }
                        }
                        else
                        {
                            bOpenCamera = true;
                        }

                        if (bOpenCamera)
                        {
                            StartCamera_X_on_Display_Y(ciCameraInformation,
                                                       m_MainView[iMainViewIndex].Camera[i].Display,
                                                       DvrClientConstants.NONE,
                                                       "",
                                                       false);
                        }


                        if ((IsPtzCamera(iDvrId, iCameraNumber)) &&
                            !string.IsNullOrEmpty(m_MainView[iMainViewIndex].Camera[i].PresetToActivate))
                        {
                            if (ActivatePreset(iDvrGroupId,
                                               iDvrId,
                                               iCameraNumber,
                                               m_MainView[iMainViewIndex].Camera[i].Display - 1,
                                               m_MainView[iMainViewIndex].Camera[i].PresetToActivate))
                            {
                                Audit("Main View[" + sMainView +
                                      "] Activated. Openning On Display[" + m_MainView[iMainViewIndex].Camera[i].Display +
                                      "] Camera[" + m_MainView[iMainViewIndex].Camera[i].CameraNumber +
                                      "] On DVR[" + m_MainView[iMainViewIndex].Camera[i].SiteName +
                                      "]. Preset[" + m_MainView[iMainViewIndex].Camera[i].PresetToActivate + "] Activated.",
                                      sMethod,
                                      AuditSeverity.Information);
                            }
                            else
                            {
                                Audit("Faild To Activate Main View[" + sMainView +
                                      "]. Can't Open On Display[" + m_MainView[iMainViewIndex].Camera[i].Display +
                                      "] Camera[" + m_MainView[iMainViewIndex].Camera[i].CameraNumber +
                                      "] On DVR[" + m_MainView[iMainViewIndex].Camera[i].SiteName +
                                      "] With Preset[" + m_MainView[iMainViewIndex].Camera[i].PresetToActivate +
                                      "].",
                                      sMethod,
                                      AuditSeverity.Warning);
                            }
                        }
                        else
                        {
                            if (bOpenCamera)
                            {
                                Audit("Main View View[" + sMainView +
                                      "] Activated. Openning On Display[" + m_MainView[iMainViewIndex].Camera[i].Display +
                                      "] Camera[" + m_MainView[iMainViewIndex].Camera[i].CameraNumber +
                                      "] On DVR[" + m_MainView[iMainViewIndex].Camera[i].SiteName +
                                      "]",
                                      sMethod,
                                      AuditSeverity.Information);
                            }
                            else
                            {
                                Audit("Main View View[" + sMainView +
                                      "] Activated. On Display[" + m_MainView[iMainViewIndex].Camera[i].Display +
                                      "] Camera[" + m_MainView[iMainViewIndex].Camera[i].CameraNumber +
                                      "] On DVR[" + m_MainView[iMainViewIndex].Camera[i].SiteName +
                                      "] Is Already Open.",
                                      sMethod,
                                      AuditSeverity.Information);
                            }
                        }
                    }

                    CustomizeDisplays(sMethod);
                    NoVideoPictureOnEmptyDisplays();
                }

                m_bCutPredefinedViewInTheMiddle = false;
            }
            catch (Exception e)
            {
                Audit("Problem Loading Main View[" + sMainView + "]." + e.Message, sMethod, AuditSeverity.Error);

                m_bCutPredefinedViewInTheMiddle = false;
            }
        }

        private string GetCurrentMainView(out string sError)
        {
            sError = "";

            if (m_MainView == null)
            {
                sError = "List Of Main Views Does Not Exist";

                return "";
            }

            if (m_MainView.Count == 0)
            {
                sError = "List Of Main Views Is Empty";

                return "";
            }


            for (int i = 0; i < m_MainView.Count; i++)
            {
                if (IsInMainViewTimeInterval(i, out sError))
                {
                    return m_MainView[i].Name;
                }

                if (sError != "")
                {
                    return "";
                }
            }


            sError = "No Matching Main View Was Found. Current Time Does Not Elapse With Any Main View Interval.";

            return "";
        }

        private bool IsInMainViewTimeInterval(int i, out string sError)
        {
            DateTime dtNow = DateTime.Now;
            DateTime dtStart;
            DateTime dtEnd;

            try
            {
                string sStart;
                string sEnd;

                sError = "";

                sStart = m_MainView[i].StartTime;
                sEnd = m_MainView[i].EndTime;

                dtStart = DateTime.ParseExact(sStart.Trim(),
                                              "HH:mm",
                                              System.Globalization.CultureInfo.InvariantCulture);
                dtEnd = DateTime.ParseExact(sEnd.Trim(),
                                            "HH:mm",
                                            System.Globalization.CultureInfo.InvariantCulture);

                if (dtEnd < dtStart)
                {
                    dtEnd = dtEnd.AddDays(1);
                }

                if ((dtNow >= dtStart) && (dtNow <= dtEnd))
                {
                    return true;
                }

                return false;
            }
            catch (Exception e)
            {
                sError = "Failed Searching For Time Interval. " + e.Message;

                return false;
            }
        }

        #endregion

        #region Ptz Presets

        public List<PtzPreset> GetAllPtzPreset(bool bNew)
        {
            string sResult;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (bNew)
            {
                GetPtzPreset(out sResult);
                Audit(sResult, sMethod, AuditSeverity.Warning);
            }

            return m_PtzPreset;
        }

        public int GetPtzPresetIndex(string sDvr, int iCameraNumber, out string sError)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            sError = "";

            if (string.IsNullOrEmpty(sDvr))
            {
                sError = "Dvr Name Is Null Or Empty";
                Audit(sError, sMethod, AuditSeverity.Warning);

                return DvrClientConstants.NONE;
            }

            if (m_PtzPreset == null)
            {
                sError = "PTZ Preset List Null";
                Audit(sError, sMethod, AuditSeverity.Warning);

                return DvrClientConstants.NONE;
            }

            if (m_PtzPreset.Count == 0)
            {
                sError = "PTZ Preset List Empty";
                Audit(sError, sMethod, AuditSeverity.Warning);

                return DvrClientConstants.NONE;
            }

            for (int i = 0; i < m_PtzPreset.Count; i++)
            {
                if ((m_PtzPreset[i].Dvr == sDvr) &&
                    (m_PtzPreset[i].CameraNumber) == iCameraNumber)
                {
                    return i;
                }
            }

            sError = "Could Not Find PTZ Preset Dvr[" + sDvr + "] Camera[" + iCameraNumber + "] In PTZ Preset List";
            Audit(sError, sMethod, AuditSeverity.Warning);

            return DvrClientConstants.NONE;
        }

        public string GetPtzPresetPreset(int iIndex, out string sError)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            sError = "";

            if (iIndex == DvrClientConstants.NONE)
            {
                sError = "Index Is Bad [" + iIndex + "]";
                Audit(sError, sMethod, AuditSeverity.Warning);

                return "";
            }

            if (m_PtzPreset == null)
            {
                sError = "PTZ Preset List Null";
                Audit(sError, sMethod, AuditSeverity.Warning);

                return "";
            }

            if (m_PtzPreset.Count == 0)
            {
                sError = "PTZ Preset List Empty";
                Audit(sError, sMethod, AuditSeverity.Warning);

                return "";
            }

            return m_PtzPreset[iIndex].Preset;
        }

        #endregion            

        #endregion

        #region DVRs / Cameras Info

        private void ReadNiceLoggersInformation()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            //string sResult;

            try
            {

            }
            catch (Exception e)
            {
                Audit("Failed Reading Nice Loggers Information. " + e.Message, sMethod, AuditSeverity.Warning);
            }
        }

        public int GetChannelID(int iServerID, int iChannelNumber)
        {
            int i;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DvrInformation == null)
                {
                    return DvrClientConstants.NONE;
                }

                for (i = 0; i < m_DvrInformation.Count; i++)
                {
                    if (m_DvrInformation[i].Camera == null)
                    {
                        continue;
                    }

                    for (int j = 0; j < m_DvrInformation[i].Camera.Count; j++)
                    {
                        if (m_DvrInformation[i].DvrId == iServerID)
                        {
                            if (m_DvrInformation[i].Camera[j].CameraNumber == iChannelNumber)
                            {
                                return m_DvrInformation[i].Camera[j].CameraNumber;
                            }
                        }
                    }
                }

                return DvrClientConstants.NONE;
            }

            catch (Exception e)
            {
                Audit("Problem Getting Channel Number For Camera[" +
                      iChannelNumber.ToString() +
                      "]." + e.Message,
                      sMethod, 
                      AuditSeverity.Error);

                return DvrClientConstants.NONE;
            }
        }
        
        public int GetChannelID(string sServerName, int iServerChannelNO)
        {
            //int i;
            //int j;

            //  Get all Recorders (Loggers)
            //Recorder[] thisServer = Recorder.FetchServers(m_Database, NiceVision.Common.ServerType.Logger);

            //if (m_Source.Logger == null)
            //{
            //    return DvrClientConstants.NONE;
            //}

            //for (i = 0; i < m_Source.Logger.Length; i++)
            //{
            //    //NiceChannel[] thisChannel = NiceChannel.FetchChannels(m_Database, thisServer[i].ID);

            //    if (m_Source.Channels == null)
            //    {
            //        return DvrClientConstants.NONE;
            //    }

            //    for (j = 0; j < m_Source.Channels[i].Channel.Length; j++)
            //    {
            //        if ((m_Source.Channels[i].Channel[j].ServerChannelNO == iServerChannelNO) &&
            //            (m_Source.Logger[i].Name == sServerName))
            //        {
            //            return m_Source.Channels[i].Channel[j].ChannelID;
            //        }
            //    }
            //}

            return DvrClientConstants.NONE;
        }        

        public string GetCameraName(string sServerName, int iChannelID)
        {
            //int i;
            //int j;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                //for (i = 0; i < m_Source.Logger.Length; i++)
                //{
                //    for (j = 0; j < m_Source.Channels[i].Channel.Length; j++)
                //    {
                //        if ((m_Source.Channels[i].Channel[j].ChannelID == iChannelID) &&
                //            (m_Source.Logger[i].Name == sServerName))
                //        {
                //            return m_Source.Channels[i].Channel[j].ChannelName;
                //        }
                //    }
                //}

                return "";
            }
            catch (Exception e)
            {
                Audit("Problem Getting Camera Name For Channel ID[" + iChannelID +
                      "] Logger[" + sServerName + "]." + e.Message, 
                      sMethod,
                      AuditSeverity.Error);

                return "";
            }
        }

        public string GetCameraNameByCameraNumber(string sServerName, int iCameraNumber)
        {
            //int i;
            //int j;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                //for (i = 0; i < m_Source.Logger.Length; i++)
                //{
                //    if (m_Source.Channels[i].Channel != null)
                //    {
                //        for (j = 0; j < m_Source.Channels[i].Channel.Length; j++)
                //        {
                //            if ((m_Source.Channels[i].Channel[j].ServerChannelNO == iCameraNumber) &&
                //                (m_Source.Logger[i].Name == sServerName))
                //            {
                //                return m_Source.Channels[i].Channel[j].ChannelName;
                //            }
                //        } 
                //    }
                //}

                return "";
            }
            catch (Exception e)
            {
                AuditPerform("Problem Getting Camera Name For Camera Number[" + iCameraNumber +
                             "] Logger[" + sServerName + "]." + e.Message,
                             sMethod);

                return "";
            }
        }

        public int GetCameraNumber(string sServerName, int iChannelID)
        {
            //int i;
            //int j;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                //for (i = 0; i < m_Source.Logger.Length; i++)
                //{
                //    for (j = 0; j < m_Source.Channels[i].Channel.Length; j++)
                //    {
                //        if ((m_Source.Channels[i].Channel[j].ChannelID == iChannelID) &&
                //            (m_Source.Logger[i].Name == sServerName))
                //        {
                //            return m_Source.Channels[i].Channel[j].ServerChannelNO;
                //        }
                //    }
                //}

                return DvrClientConstants.NONE;
            }
            catch (Exception e)
            {
                Audit("Problem Getting Camera Number For Channel ID[" + iChannelID +
                      "] Logger[" + sServerName + "]." + e.Message,
                      sMethod, 
                      AuditSeverity.Error);

                return DvrClientConstants.NONE;
            }
        }

        public int GetCameraNumber(int iDvrId, int iChannelID)
        {
            #region Data Members

            int i;
            int j;

            string sMethod = MethodBase.GetCurrentMethod().Name; 

            #endregion

            try
            {
                for (i = 0; i < m_DvrInformation.Count; i++)
                {
                    for (j = 0; j < m_DvrInformation[i].Camera.Count; j++)
                    {
                        if (m_DvrInformation[i].Camera[j].Channel == iChannelID)
                        {
                            return m_DvrInformation[i].Camera[j].CameraNumber;
                        }
                    }
                }

                return DvrClientConstants.NONE;
            }
            catch (Exception e)
            {
                Audit("Problem Getting Camera Number For Dvr ID[" + iDvrId + "] Channel[" + iChannelID +
                      "]." + e.Message,
                      sMethod,
                      AuditSeverity.Error);

                return DvrClientConstants.NONE;
            }
        }

        private CameraInformation GetCameraInformation(int iDvrId, int iCameraNumber)
        {
            #region Data Members

            int i;
            int j;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            CameraInformation ciCameraInformation = null;

            #endregion

            try
            {
                for (i = 0; i < m_DvrInformation.Count; i++)
                {
                    for (j = 0; j < m_DvrInformation[i].Camera.Count; j++)
                    {
                        if (m_DvrInformation[i].Camera[j].CameraNumber == iCameraNumber)
                        {
                            return m_DvrInformation[i].Camera[j];
                        }
                    }
                }

                return ciCameraInformation;
            }
            catch (Exception e)
            {
                Audit("Problem Getting Camera Number For Dvr ID[" + iDvrId + "] Channel[" + iCameraNumber +
                      "]." + e.Message,
                      sMethod,
                      AuditSeverity.Error);

                return null;
            }
        }

        public string GetDvrName(int iDvrID)
        {
            //int i;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                //for (i = 0; i < m_Source.Logger.Length; i++)
                //{
                //    if (m_Source.Logger[i].ID == iDvrID)
                //    {
                //        return m_Source.Logger[i].Name;
                //    }
                //}

                return "";
            }
            catch (Exception e)
            {
                Audit("Problem Getting Dvr\\Logger\\Server Name For Server ID[" + iDvrID + 
                      "]." + e.Message,
                      sMethod, 
                      AuditSeverity.Error);

                return "";
            }
        }

        public int GetDvrIndex(int iDvrID)
        {
            #region Data Members

            int i;

            string sMethod = MethodBase.GetCurrentMethod().Name; 

            #endregion

            try
            {
                if (m_DvrInformation == null)
                {
                    return DvrClientConstants.NONE;
                }

                for (i = 0; i < m_DvrInformation.Count; i++)
                {
                    if (m_DvrInformation[i].DvrId == iDvrID)
                    {
                        return i;
                    }
                }

                return DvrClientConstants.NONE;
            }
            catch (Exception e)
            {
                Audit("Problem Getting Dvr\\Logger\\Server Index For Dvr ID[" + iDvrID +
                      "]." + e.Message,
                      sMethod,
                      AuditSeverity.Error);

                return DvrClientConstants.NONE;
            }
        }

        public int GetCameraIndex(int iDvrID, int iCameraNumber)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                if (m_DvrInformation == null)
                {
                    return DvrClientConstants.NONE;
                }

                for (int i = 0; i < m_DvrInformation.Count; i++)
                {
                    if (m_DvrInformation[i].DvrId == iDvrID)
                    {
                        if (m_DvrInformation[i].Camera == null)
                        {
                            return DvrClientConstants.NONE;
                        }

                        for (int j = 0; j < m_DvrInformation[i].Camera.Count; j++)
			            {
                            if (m_DvrInformation[i].Camera[j].CameraNumber == iCameraNumber)
                            {
                                return j;
                            }
			            }
                    }
                }

                return DvrClientConstants.NONE;
            }
            catch (Exception e)
            {
                Audit("Problem Getting Camera Index For Camera[" + iCameraNumber +"] On Dvr ID[" + iDvrID +
                      "]." + e.Message,
                      sMethod,
                      AuditSeverity.Error);

                return DvrClientConstants.NONE;
            }
        }

        public string GetLoggerIP(string sLoggerName)
        {
            //int i;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                //if (m_Source.Logger == null)
                //{
                //    return "";
                //}

                //for (i = 0; i < m_Source.Logger.Length; i++)
                //{
                //    if (m_Source.Logger[i].Name == sLoggerName)
                //    {
                //        return m_Source.Logger[i].Address.ToString();
                //    }
                //}

                return "";
            }
            catch (Exception e)
            {

                Audit("Problem Getting Dvr\\Logger\\Server IP For Server Name[" + sLoggerName +
                      "]." + e.Message,
                      sMethod,
                      AuditSeverity.Error);

                return "";
            }
        }

        public int GetLoggerId(string sLoggerName)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DvrInformation == null)
                {
                    return DvrClientConstants.NONE;
                }

                for (int i = 0; i < m_DvrInformation.Count; i++)
                {
                    if (m_DvrInformation[i].IpAddress == sLoggerName)
                    {
                        return m_DvrInformation[i].DvrId;
                    }
                }

                return DvrClientConstants.NONE;
            }
            catch (Exception e)
            {
                Audit("Problem Getting Dvr\\Logger\\Server Id For Server Name[" + sLoggerName +
                      "]." + e.Message,
                      sMethod, 
                      AuditSeverity.Error);

                return DvrClientConstants.NONE;
            }
        }

        public int GetServerGroupId(int iDvrId)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DvrInformation == null)
                {
                    return DvrClientConstants.NONE;
                }

                for (int i = 0; i < m_DvrInformation.Count; i++)
                {
                    if (m_DvrInformation[i].DvrId == iDvrId)
                    {
                        return m_DvrInformation[i].ServerGroupId;
                    }
                }

                return DvrClientConstants.NONE;
            }
            catch (Exception e)
            {
                Audit("Problem Getting Dvr\\Logger\\Server Group Id For Dvr Id[" + iDvrId +
                      "]." + e.Message,
                      sMethod,
                      AuditSeverity.Error);

                return DvrClientConstants.NONE;
            }
        }

        public string GetLoggerIP(int iDvrId)
        {
            #region Data Members

            int i;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                if (m_DvrInformation == null)
                {
                    return "";
                }

                for (i = 0; i < m_DvrInformation.Count; i++)
                {
                    if (m_DvrInformation[i].DvrId == iDvrId)
                    {
                        return m_DvrInformation[i].IpAddress;
                    }
                }

                return "";
            }
            catch (Exception e)
            {
                Audit("Problem Getting Dvr\\Logger\\Server IP Address For Dvr ID[" + iDvrId +
                      "]." + e.Message,
                      sMethod,
                      AuditSeverity.Error);

                return "";
            }
        }

        public bool IsPtzCamera(string sDvr, int iCameraNumber)
        {
            if (m_PtzCameras == null)
            {
                return false;
            }

            return m_PtzCameras.IsPtz(sDvr, iCameraNumber);
        }

        public bool IsPtzCamera(int iDvrId, int iCameraNumber)
        {
            if (m_DvrInformation == null)
            {
                return false;
            }

            for (int i = 0; i < m_DvrInformation.Count; i++)
            {
                if (m_DvrInformation[i].DvrId == iDvrId)
                {
                    if (m_DvrInformation[i].Camera.Count != null)
                    {
                        for (int j = 0; j < m_DvrInformation[i].Camera.Count; j++)
                        {
                            if (m_DvrInformation[i].Camera[j].CameraNumber == iCameraNumber)
                            {
                                return m_DvrInformation[i].Camera[j].IsPtz;
                            }
                        }
                    }
                }
            }

            return false;
        }

        public int GetDvrTriggerIdDelta(int iDvrID)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DvrRecord != null)
                {
                    for (int i = 0; i < m_DvrRecord.Count; i++)
                    {
                        if (m_DvrRecord[i].DvrId == iDvrID)
                        {
                            return m_DvrRecord[i].TriggerIdDelta;
                        }
                    }
                }

                return DvrClientConstants.NONE;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Warning);

                return DvrClientConstants.NONE;
            }
        }

        public bool GetPtzCameras()
        {
            #region Data Members
            
            //int iRc;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            //string xml;  

            #endregion                      

            try
            {
                //NiceDatabase.Connect(m_Settings.NiceAmsIp);
                //xml = NiceDatabase.PTZ.GetAllPTZChannels(out iRc);
                //if (string.IsNullOrEmpty(xml))
                //{
                //    Audit("GetAllPTZChannels Returned Empty. Return Code[" + iRc + "]", 
                //          sMethod, 
                //          AuditSeverity.Warning);

                //    return false;
                //}

                //m_PtzCameras = new Types.PtzCameras();

                //XmlNodeList xmlNodes = ExtractNodeList(xml, "C_PTZ_CHANNEL");

                //foreach (XmlNode xmlNode in xmlNodes)
                //{
                //    XmlNode node = ExtractNodeValue(xmlNode.OuterXml, "C_PTZ_CHANNEL");

                //    int iLoggerID = Int32.Parse(node["ServerID"].InnerText);
                //    string sDvrName = GetDvrName(iLoggerID);
                //    int iChannelID = Int32.Parse(node["ChannelID"].InnerText);
                //    int iCameraNumber = Int32.Parse(node["ServerChannelNO"].InnerText);

                //    m_PtzCameras.Add(new Types.PtzCamera(sDvrName, iLoggerID, iCameraNumber, iChannelID));

                //    DoEvents();
                //}

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public List<string> GetPtzCameraPresets(int iDvrId, int iCameraNumber)
        {
            #region Data Members
            
            string sResult;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            List<string> lPtzCameraPreset = null; 

            #endregion

            try
            {
                if (!GetCameraPresets(iDvrId, iCameraNumber, out lPtzCameraPreset, out sResult))
                {
                    AuditPerform("Failed To Fetch PTZ Camera Presets For Camera[" +
                                 iCameraNumber +
                                 "] On DVR [" + iDvrId + "]. " + sResult,
                                 sMethod,
                                 AuditSeverity.Warning);
                }

                return lPtzCameraPreset;
            }
            catch (Exception e)
            {
                string sError = e.Message;

                AuditPerform("Failed To Fetch PTZ Camera Presets For Camera[" +
                             iCameraNumber +
                             "] On DVR [" + iDvrId + "]. " + e.Message,
                             sMethod,
                             AuditSeverity.Error);

                return null;
            }
        }

        public List<string> GetPtzCameraPresets(string sDvrName, int iCameraNumber)
        {
            //int iRc;
            //int iCameraChannelID;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            //string xml;
            List<string> lPtzCameraPreset = null;


            try
            {
                //NiceDatabase.Connect(m_Settings.NiceAmsIp);
                //xml = NiceDatabase.Preset.GetAllPresets(out iRc);
                //if (string.IsNullOrEmpty(xml))
                //{
                //    return null;
                //}

                //lPtzCameraPreset = new List<string>();
                //iCameraChannelID = GetChannelID(sDvrName, iCameraNumber);

                //XmlNodeList xmlNodes = ExtractNodeList(xml, "V_PRESET");

                //foreach (XmlNode xmlNode in xmlNodes)
                //{
                //    XmlNode node = ExtractNodeValue(xmlNode.OuterXml, "V_PRESET");

                //    string sPresetName = node["PresetName"].InnerText;
                //    int iChannelID = Int32.Parse(node["ChannelID"].InnerText);

                //    if (iCameraChannelID == iChannelID)
                //    {
                //        lPtzCameraPreset.Add(sPresetName);
                //    }
                //}

                return lPtzCameraPreset;
            }
            catch (Exception e)
            {
                string sError = e.Message;

                Utils.WriteToEventLog("DVR Client",
                                      "Main - " + sMethod,
                                      "Fetch PTZ Camera Presets For Camera[" +
                                      iCameraNumber +
                                      "] On DVR '" + sDvrName + "' On AMS[" + m_Settings.NiceAmsIp + 
                                      "]." + e.Message,
                                      0,
                                      EventLogEntryType.Information);

                return null;
            }
        }

        public List<string> GetPtzCameraPresets(string sNiceAmsIp, string sDvrName, int iCameraNumber)
        {
            //int iRc;
            //int iCameraChannelID;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            //string xml;
            List<string> lPtzCameraPreset = null;

            try
            {
                //NiceDatabase.Connect(sNiceAmsIp);
                //xml = NiceDatabase.Preset.GetAllPresets(out iRc);
                //if (string.IsNullOrEmpty(xml))
                //{
                //    return null;
                //}

                //lPtzCameraPreset = new List<string>();
                //iCameraChannelID = GetChannelID(NiceDatabase, sDvrName, iCameraNumber);

                //XmlNodeList xmlNodes = ExtractNodeList(xml, "V_PRESET");

                //foreach (XmlNode xmlNode in xmlNodes)
                //{
                //    XmlNode node = ExtractNodeValue(xmlNode.OuterXml, "V_PRESET");

                //    string sPresetName = node["PresetName"].InnerText;
                //    int iChannelID = Int32.Parse(node["ChannelID"].InnerText);

                //    if (iCameraChannelID == iChannelID)
                //    {
                //        lPtzCameraPreset.Add(sPresetName);
                //    }
                //}

                return lPtzCameraPreset;
            }
            catch (Exception e)
            {
                string sError = e.Message;

                Utils.WriteToEventLog("DVR Client",
                                      "Main - " + sMethod,
                                      "Fetch PTZ Camera Presets For Camera[" + 
                                      iCameraNumber + 
                                      "] On DVR '" + sDvrName + "' On AMS[" + sNiceAmsIp + "]." + e.Message,
                                      0,
                                      EventLogEntryType.Information);

                return null;
            }
        }

        public int GetPtzCameraPresetID(string sDvrName, int iCameraNumber, string sPreset)
        {
            //int iRc;
            //int iCameraChannelID;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            //string xml;
            //int iPtzCameraPresetID = DvrClientConstants.NONE;


            //NiceDatabase.Connect(m_Settings.NiceAmsIp);
            //xml = NiceDatabase.Preset.GetAllPresets(out iRc);
            //if (string.IsNullOrEmpty(xml))
            //{
            //    return DvrClientConstants.NONE;
            //}

            //iCameraChannelID = GetChannelID(sDvrName, iCameraNumber);

            //XmlNodeList xmlNodes = ExtractNodeList(xml, "V_PRESET");

            //foreach (XmlNode xmlNode in xmlNodes)
            //{
            //    XmlNode node = ExtractNodeValue(xmlNode.OuterXml, "V_PRESET");

            //    string sPresetName = node["PresetName"].InnerText;
            //    int iChannelID = Int32.Parse(node["ChannelID"].InnerText);
            //    iPtzCameraPresetID = Int32.Parse(node["PresetID"].InnerText);

            //    if ((iCameraChannelID == iChannelID) && (sPresetName == sPreset))
            //    {
            //        return iPtzCameraPresetID;
            //    }
            //}

            return DvrClientConstants.NONE; 
        }

        #region Nice Static Utilities

        public int FetchUserID(string siteIP, string username)
        {
            //int rc = 0; // Return code

            //// Connect the database
            //if (NiceDatabase.Connect(siteIP) == 0)
            //{
            //    MessageBox.Show("Error connecting database at " + siteIP);
            //    return -1;
            //}

            //if (username.Length > 0)
            //{
            //    // Filter by the given user name
            //    NiceDatabase.User.AddLoginNameCriterion(NiceVision.Common.Condition.Equals, 
            //                                        new string[] { username }, 
            //                                        out rc);
            //    if (rc != 0)
            //        throw new Exception("Error calling AddLoginNameCriterion: " + rc);
            //}

            //// Get the users XML string
            //string xml = NiceDatabase.User.GetAllUsers(out rc);
            //if (rc != 0)
            //{
            //    MessageBox.Show("GetAllUsers failed with return code: " + rc);
            //    return -1;
            //}
            //else if (string.IsNullOrEmpty(xml))
            //{
            //    MessageBox.Show("No users found");
                return -1;
            //}

            //return ParseUserID(xml);
        }

        private static int ParseUserID(string sNodesXml)
        {
            if (string.IsNullOrEmpty(sNodesXml))
                return -1;

            XmlNodeList xmlNodes = ExtractNodeList(sNodesXml, "V_USER");

            foreach (XmlNode xmlNode in xmlNodes)
            {
                XmlNode node = ExtractNodeValue(xmlNode.OuterXml, "V_USER");
                if (node != null)
                    return Int32.Parse(node["UserID"].InnerText);
            }

            return -1;
        }

        private static XmlNode ExtractNodeValue(string xml, string tag)
        {
            if (string.IsNullOrEmpty(xml))
                return null;

            XmlDocument doc = new XmlDocument();
            doc.LoadXml(xml);
            return doc.GetElementsByTagName(tag)[0];
        }

        private static XmlNodeList ExtractNodeList(string xml, string tag)
        {
            if (string.IsNullOrEmpty(xml))
                return null;

            XmlDocument doc = new XmlDocument();
            doc.LoadXml(xml);
            return doc.GetElementsByTagName(tag);
        }

        #endregion

        private string GetLoggerTime(int iDvrId)
        {
            DateTime dtResult = new DateTime(1900, 1, 1, 0, 0, 0, 0);
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_LoggersKeepaliveThread == null)
                {
                    Audit(Utils.GetEnumDescription(DvrClientModule.LoggersKeepalive) + " Thread Not Active", 
                          sMethod, 
                          AuditSeverity.Error);

                    return dtResult.ToString();
                }

                if (m_LoggerConectivity == null)
                {
                    Audit("Loggers Connectivity Vector Is Null",
                          sMethod,
                          AuditSeverity.Error);

                    return dtResult.ToString();
                }

                if (m_LoggerConectivity.Count < 1)
                {
                    Audit("No Loggers In Connectivity Vector",
                          sMethod,
                          AuditSeverity.Warning);

                    return dtResult.ToString();
                }

                for (int i = 0; i < m_LoggerConectivity.Count; i++)
                {
                    if (m_LoggerConectivity[i].ID == iDvrId)
                    {
                        return m_LoggerConectivity[i].Time.ToString();
                    }
                }

                return dtResult.ToString();
            }
            catch (Exception e)
            {
                Audit(e.Message,
                      sMethod,
                      AuditSeverity.Error);

                return dtResult.ToString();
            }
        }

        private bool GetDiskIoFailureState(int iDvrId)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DvrsAndCamerasInformation != null)
                {
                    for (int i = 0; i < m_DvrsAndCamerasInformation.Count; i++)
                    {
                        if (m_DvrsAndCamerasInformation[i].SiteID == iDvrId.ToString())
                        {
                            return m_DvrsAndCamerasInformation[i].DiskIOFailure;
                        }
                    }

                    Audit("No Dvr WIth ID[" + iDvrId + "] Found In Dvrs And Cameras Information List",
                          sMethod,
                          AuditSeverity.Warning);

                    return false;
                }
                else
                {
                    Audit("Dvrs And Cameras Information List Empty",   
                          sMethod,
                          AuditSeverity.Warning);

                    return false;
                }
            }
            catch (Exception e)
            {
                Audit(e.Message,
                      sMethod,
                      AuditSeverity.Error);

                return false;
            }           
        }

        public List<LoggerConectivity> GetLoggersConectivity()
        {
            return m_LoggerConectivity;
        }

        #endregion

        #region CA Alarms

        public void SetKeepAlive(int iDvr, bool bValue)
        {
            #region Data Members
            
            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name; 

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    m_Alarms4Dvr[iRealDvrID].KeepAlive = bValue;
                }
            }
            catch (Exception e)
            {
                Audit("Dvr ID Index[" + iDvr +
                      "] Dvr ID[" + iRealDvrID +
                      "] Value[" + bValue +
                      "]. " + e.Message, 
                      sMethod, 
                      AuditSeverity.Error);
            }
        }

        public bool SetVL(int iDvrId, int iCameraNumber, bool bValue)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            bool bIsPtz;

            #endregion

            try
            {
                if (m_Alarms4Dvr == null)
                {
                    return false;
                }

                for (int i = 0; i < m_Alarms4Dvr.Length; i++)
                {
                    if (m_Alarms4Dvr[i].DvrID == iDvrId)
                    {
                        if ((m_Alarms4Dvr[i].CameraNumber != null) && (m_Alarms4Dvr[i].VL != null))
                        {
                            for (int j = 0; j < m_Alarms4Dvr[i].CameraNumber.Length; j++)
                            {
                                if (m_Alarms4Dvr[i].CameraNumber[j] == iCameraNumber)
                                {
                                    m_Alarms4Dvr[i].VL[j] = bValue;

                                    CameraInformation ciCameraInformation = GetCameraInformation(iDvrId, iCameraNumber);
                                    if (ciCameraInformation != null)
                                    {
                                        bIsPtz = ciCameraInformation.IsPtz;
                                    }
                                    else
                                    {
                                        bIsPtz = false;
                                    }

                                    CameraNodeDisplay(iDvrId,
                                                      iCameraNumber,
                                                      (bValue) ? ((bIsPtz) ? (int)IconIndex.PtzCameraVideoLoss : (int)IconIndex.CameraVideoLoss) : ((bIsPtz) ? (int)IconIndex.PtzCamera : (int)IconIndex.Camera));

                                    return true;
                                }
                            }
                        }
                    }
                }

                return false;
            }
            catch (Exception e)
            {
                Audit("Dvr ID [" + iDvrId + 
                      "] Camera[" + iCameraNumber + 
                      "] Value[" + bValue + 
                      "]. Error on VL." + e.Message, 
                      sMethod,
                      AuditSeverity.Error);

                return false;
            }
        }

        private void HideVideoLossPictureBox(int iDisplayIndex)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (this.InvokeRequired)
                {
                    this.BeginInvoke(new OneParamDelegate<int>((HideVideoLossPictureBox)),
                                     iDisplayIndex);
                }
                else
                {
                    m_VideoLoss[iDisplayIndex].Visible = false;
                    m_VideoLoss[iDisplayIndex].Size = new Size();
                    m_VideoLoss[iDisplayIndex].Location = new Point();

                    m_Transparent[iDisplayIndex].Visible = true;
                    vp[iDisplayIndex].Visible = true;
                }
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void TextToVideoLossPictureBox(int iDisplayIndex)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (this.InvokeRequired)
                {
                    this.BeginInvoke(new OneParamDelegate<int>((TextToVideoLossPictureBox)),
                                     iDisplayIndex);
                }
                else
                {
                    PictureBox pb = m_VideoLoss[iDisplayIndex];
                    string sMessage = "Video Loss\nOn Dvr [" + DisplayManager_DisplaySiteName(iDisplayIndex) + 
                                      "]\nCamera [" + DisplayManager_DisplayCameraNumber(iDisplayIndex) +
                                      " - " + DisplayManager_DisplayCameraName(iDisplayIndex) + "]";

                    m_VideoLoss[iDisplayIndex].Visible = true;
                    m_VideoLoss[iDisplayIndex].Size = m_Transparent[iDisplayIndex].Size;
                    m_VideoLoss[iDisplayIndex].Location = m_Transparent[iDisplayIndex].Location;
                    m_VideoLoss[iDisplayIndex].BackColor = Color.Aqua;

                    m_Transparent[iDisplayIndex].Visible = false;
                    vp[iDisplayIndex].Visible = false;

                    Bitmap b = new Bitmap(pb.ClientRectangle.Width, pb.ClientRectangle.Height);
                    Graphics g = Graphics.FromImage(b);
                    Font myfont = new Font("Courier", 12);
                    g.DrawString(sMessage, myfont, Brushes.Black, new Point(20, 20));
                    pb.Image = b;
                }
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        public void SetInput(int iDvr, int iChannel, string sInformation)
        {
            #region Data Members

            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    m_Alarms4Dvr[iRealDvrID].Information[iChannel - 1] = sInformation;

                    //string sSitename = GetDvrName(iDvr);
                    //CameraNodeDisplay(sSitename, 
                    //                  iChannel, 
                    //                  Action.ChangeIcon,
                    //                  (bValue) ? IconIndex.CameraVmd : IconIndex.Camera, sMethod);
                }
            }
            catch (Exception e)
            {
                Audit("Dvr ID Index[" + iDvr +
                      "] Dvr ID[" + iRealDvrID +
                      "] Channel[" + iChannel +
                      "] Value[" + sInformation +
                      "]. Error on Input." + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        public bool SetVMD(int iDvrId, int iCameraNumber, bool bValue)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            bool bIsPtz;

            #endregion

            try
            {
                if (m_Alarms4Dvr == null)
                {
                    return false;
                }

                for (int i = 0; i < m_Alarms4Dvr.Length; i++)
                {
                    if (m_Alarms4Dvr[i].DvrID == iDvrId)
                    {
                        if ((m_Alarms4Dvr[i].CameraNumber != null) && (m_Alarms4Dvr[i].VMD != null))
                        {
                            for (int j = 0; j < m_Alarms4Dvr[i].CameraNumber.Length; j++)
                            {
                                if (m_Alarms4Dvr[i].CameraNumber[j] == iCameraNumber)
                                {
                                    m_Alarms4Dvr[i].VMD[j] = bValue;

                                    CameraInformation ciCameraInformation = GetCameraInformation(iDvrId, iCameraNumber);
                                    if (ciCameraInformation != null)
                                    {
                                        bIsPtz = ciCameraInformation.IsPtz;
                                    }
                                    else
                                    {
                                        bIsPtz = false;
                                    }

                                    CameraNodeDisplay(iDvrId,
                                                      iCameraNumber,
                                                      (bValue) ? ((bIsPtz) ? (int)IconIndex.PtzCameraVmd : (int)IconIndex.CameraVmd) : ((bIsPtz) ? (int)IconIndex.PtzCamera : (int)IconIndex.Camera));

                                    return true;
                                }
                            }
                        }
                    }
                }

                return false;
            }
            catch (Exception e)
            {
                Audit("Dvr ID [" + iDvrId +
                      "] Camera[" + iCameraNumber +
                      "] Value[" + bValue +
                      "]. Error on VMD." + e.Message,
                      sMethod,
                      AuditSeverity.Error);

                return false;
            }
        }

        public void SetAlarmIn(int iDvr, int iChannel, bool bValue)
        {
            #region Data Members

            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    m_Alarms4Dvr[iRealDvrID].AlarmIn[iChannel - 1] = bValue;

                    //string sSitename = GetDvrName(iDvr);
                    //CameraNodeDisplay(sSitename, 
                    //                  iChannel, 
                    //                  Action.ChangeIcon,
                    //                  (bValue) ? IconIndex.CameraVmd : IconIndex.Camera, sMethod);
                }
            }
            catch (Exception e)
            {
                Audit("Dvr ID Index[" + iDvr +
                      "] Dvr ID[" + iRealDvrID +
                      "] Channel[" + iChannel +
                      "] Value[" + bValue +
                      "]. Error on VMD." + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        public void SetAudioSquelch(int iDvr, int iChannel, bool bValue)
        {
            #region Data Members

            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    m_Alarms4Dvr[iRealDvrID].AudioSquelch[iChannel - 1] = bValue;

                    string sSitename = GetDvrName(iDvr);
                    CameraNodeDisplay(sSitename,
                                      iChannel,
                                      ActionToDo.ChangeIcon,
                                      (bValue) ? IconIndex.CameraVmd : IconIndex.Camera, sMethod);
                }
            }
            catch (Exception e)
            {
                Audit("Dvr ID Index[" + iDvr +
                      "] Dvr ID[" + iRealDvrID +
                      "] Channel[" + iChannel +
                      "] Value[" + bValue +
                      "]. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        public void SetUnattendedBaggage(int iDvr, int iChannel, bool bValue)
        {
            #region Data Members

            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    m_Alarms4Dvr[iRealDvrID].UnattendedBaggage[iChannel - 1] = bValue;

                    string sSitename = GetDvrName(iDvr);
                    CameraNodeDisplay(sSitename,
                                      iChannel,
                                      ActionToDo.ChangeIcon,
                                      (bValue) ? IconIndex.CameraVmd : IconIndex.Camera, sMethod);
                }
            }
            catch (Exception e)
            {
                Audit("Dvr ID Index[" + iDvr +
                      "] Dvr ID[" + iRealDvrID +
                      "] Channel[" + iChannel +
                      "] Value[" + bValue +
                      "]. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        public void SetUnauthorizedCar(int iDvr, int iChannel, bool bValue)
        {
            #region Data Members

            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    m_Alarms4Dvr[iRealDvrID].UnauthorizedCar[iChannel - 1] = bValue;

                    string sSitename = GetDvrName(iDvr);
                    CameraNodeDisplay(sSitename,
                                      iChannel,
                                      ActionToDo.ChangeIcon,
                                      (bValue) ? IconIndex.CameraVmd : IconIndex.Camera, sMethod);
                }
            }
            catch (Exception e)
            {
                Audit("Dvr ID Index[" + iDvr +
                      "] Dvr ID[" + iRealDvrID +
                      "] Channel[" + iChannel +
                      "] Value[" + bValue +
                      "]. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        public void SetCrowdControl(int iDvr, int iChannel, bool bValue)
        {
            #region Data Members

            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    m_Alarms4Dvr[iRealDvrID].CrowdControl[iChannel - 1] = bValue;

                    string sSitename = GetDvrName(iDvr);
                    CameraNodeDisplay(sSitename,
                                      iChannel,
                                      ActionToDo.ChangeIcon,
                                      (bValue) ? IconIndex.CameraVmd : IconIndex.Camera,
                                      sMethod);
                }
            }
            catch (Exception e)
            {
                Audit("Dvr ID Index[" + iDvr +
                      "] Dvr ID[" + iRealDvrID +
                      "] Channel[" + iChannel +
                      "] Value[" + bValue +
                      "]. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        public void SetTailGating(int iDvr, int iChannel, bool bValue)
        {
            #region Data Members

            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    m_Alarms4Dvr[iRealDvrID].TailGating[iChannel - 1] = bValue;

                    string sSitename = GetDvrName(iDvr);
                    CameraNodeDisplay(sSitename,
                                      iChannel,
                                      ActionToDo.ChangeIcon,
                                      (bValue) ? IconIndex.CameraVmd : IconIndex.Camera, sMethod);
                }
            }
            catch (Exception e)
            {
                Audit("Dvr ID Index[" + iDvr +
                      "] Dvr ID[" + iRealDvrID +
                      "] Channel[" + iChannel +
                      "] Value[" + bValue +
                      "]. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        public void SetIntruderDetection(int iDvr, int iChannel, bool bValue)
        {
            #region Data Members

            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    m_Alarms4Dvr[iRealDvrID].IntruderDetection[iChannel - 1] = bValue;

                    string sSitename = GetDvrName(iDvr);
                    CameraNodeDisplay(sSitename,
                                      iChannel,
                                      ActionToDo.ChangeIcon,
                                      (bValue) ? IconIndex.CameraVmd : IconIndex.Camera, sMethod);
                }
            }
            catch (Exception e)
            {
                Audit("Dvr ID Index[" + iDvr +
                      "] Dvr ID[" + iRealDvrID +
                      "] Channel[" + iChannel +
                      "] Value[" + bValue +
                      "]. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        public void SetTailGatingAPI(int iDvr, int iChannel, bool bValue)
        {
            #region Data Members

            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    m_Alarms4Dvr[iRealDvrID].TailGatingAPI[iChannel - 1] = bValue;

                    string sSitename = GetDvrName(iDvr);
                    CameraNodeDisplay(sSitename,
                                      iChannel,
                                      ActionToDo.ChangeIcon,
                                      (bValue) ? IconIndex.CameraVmd : IconIndex.Camera, sMethod);
                }
            }
            catch (Exception e)
            {
                Audit("Dvr ID Index[" + iDvr +
                      "] Dvr ID[" + iRealDvrID +
                      "] Channel[" + iChannel +
                      "] Value[" + bValue +
                      "]. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        public void SetWrongDirection(int iDvr, int iChannel, bool bValue)
        {
            #region Data Members

            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    m_Alarms4Dvr[iRealDvrID].WrongDirection[iChannel - 1] = bValue;

                    string sSitename = GetDvrName(iDvr);
                    CameraNodeDisplay(sSitename,
                                      iChannel,
                                      ActionToDo.ChangeIcon,
                                      (bValue) ? IconIndex.CameraVmd : IconIndex.Camera,
                                      sMethod);
                }
            }
            catch (Exception e)
            {
                Audit("Dvr ID Index[" + iDvr +
                      "] Dvr ID[" + iRealDvrID +
                      "] Channel[" + iChannel +
                      "] Value[" + bValue +
                      "]. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        public void SetGenericCA(int iDvr, int iChannel, bool bValue)
        {
            #region Data Members

            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    m_Alarms4Dvr[iRealDvrID].GenericCA[iChannel - 1] = bValue;

                    string sSitename = GetDvrName(iDvr);
                    CameraNodeDisplay(sSitename,
                                      iChannel,
                                      ActionToDo.ChangeIcon,
                                      (bValue) ? IconIndex.CameraVmd : IconIndex.Camera, sMethod);
                }
            }
            catch (Exception e)
            {
                Audit("Dvr ID Index[" + iDvr +
                      "] Dvr ID[" + iRealDvrID +
                      "] Channel[" + iChannel +
                      "] Value[" + bValue +
                      "]. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        public void SetOverCrowding(int iDvr, int iChannel, bool bValue)
        {
            #region Data Members

            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    m_Alarms4Dvr[iRealDvrID].OverCrowding[iChannel - 1] = bValue;

                    string sSitename = GetDvrName(iDvr);
                    CameraNodeDisplay(sSitename,
                                      iChannel,
                                      ActionToDo.ChangeIcon,
                                      (bValue) ? IconIndex.CameraVmd : IconIndex.Camera, sMethod);
                }
            }
            catch (Exception e)
            {
                Audit("Dvr ID Index[" + iDvr +
                      "] Dvr ID[" + iRealDvrID +
                      "] Channel[" + iChannel +
                      "] Value[" + bValue +
                      "]. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        public void SetDRY_CONTACT(int iDvr, int iSensor, bool bValue)
        {
            #region Data Members

            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    m_Alarms4Dvr[iRealDvrID].DRY_CONTACT[iSensor - 1] = bValue;
                }
            }
            catch (Exception e)
            {
                Audit("Dvr ID Index[" + iDvr +
                      "] Dvr ID[" + iRealDvrID +
                      "] Sensor[" + iSensor +
                      "] Value[" + bValue +
                      "]. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        public void SetDiskIOFailure(int iDvr)
        {
            #region Data Members

            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sDvrName;
            string sDvrIp;
            string sMessage;

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    if (m_DvrsAndCamerasInformation != null)
                    {
                        for (int i = 0; i < m_DvrsAndCamerasInformation.Count; i++)
                        {
                            if (m_DvrsAndCamerasInformation[i].SiteID == iDvr.ToString())
                            {
                                m_DvrsAndCamerasInformation[i].DiskIOFailure = true;
                            }
                        } 
                    }

                    sDvrIp = GetLoggerIP(iDvr);
                    sDvrName = GetDvrName(iDvr);
                    sMessage = "Disk IO Failure on Dvr ID[" + iDvr + 
                               "] Name[" + sDvrName + 
                               "] IP Address[" + sDvrIp + "]";
                    Audit(sMessage,
                          sMethod,
                          AuditSeverity.Error);
                    frmMessage fMessage = new frmMessage(sMessage, 10, Color.Red);
                    fMessage.Show();
                }
            }
            catch (Exception e)
            {
                Audit("Dvr ID Index[" + iDvr +
                      "] Dvr ID[" + iRealDvrID +
                      "]. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        public void SetTypeSession(int iDvr, int iChannel, bool bValue)
        {
            #region Data Members

            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    m_Alarms4Dvr[iRealDvrID].TypeSession[iChannel - 1] = bValue;
                }
            }
            catch (Exception e)
            {
                AuditPerform("Dvr ID Index[" + iDvr +
                             "] Dvr ID[" + iRealDvrID +
                             "] Channel[" + iChannel +
                             "] Value[" + bValue +
                             "]. " + e.Message,
                             sMethod,
                             AuditSeverity.Error);
            }
        }

        public void SetUserTrigger(int iDvr, int iChannel, bool bValue)
        {
            #region Data Members

            int iRealDvrID = DvrClientConstants.NONE;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                iRealDvrID = GetRealDvrIndex(iDvr);
                if (iRealDvrID != DvrClientConstants.NONE)
                {
                    m_Alarms4Dvr[iRealDvrID].UserTrigger[iChannel - 1] = bValue;

                    string sSitename = GetDvrName(iDvr);
                    CameraNodeDisplay(sSitename,
                                      iChannel,
                                      ActionToDo.ChangeIcon,
                                      (bValue) ? IconIndex.CameraVmd : IconIndex.Camera, 
                                      sMethod);
                }
            }
            catch (Exception e)
            {
                Audit("Dvr ID Index[" + iDvr +
                      "] Dvr ID[" + iRealDvrID +
                      "] Channel[" + iChannel +
                      "] Value[" + bValue +
                      "]. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        public bool GetKeepAlive(int iDvr)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].KeepAlive;
        }

        public bool GetVL(int iDvr, int iChannel)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].VL[iChannel - 1];
        }

        public bool GetVMD(int iDvr, int iChannel)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].VMD[iChannel - 1];
        }

        public bool GetAudioSquelch(int iDvr, int iChannel)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].AudioSquelch[iChannel - 1];
        }

        public bool GetUnattendedBaggage(int iDvr, int iChannel, bool bValue)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].UnattendedBaggage[iChannel - 1];
        }

        public bool GetUnauthorizedCar(int iDvr, int iChannel, bool bValue)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].UnauthorizedCar[iChannel - 1];
        }

        public bool GetCrowdControl(int iDvr, int iChannel, bool bValue)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].CrowdControl[iChannel - 1];
        }

        public bool GetTailGating(int iDvr, int iChannel, bool bValue)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].TailGating[iChannel - 1];
        }

        public bool GetIntruderDetection(int iDvr, int iChannel, bool bValue)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].IntruderDetection[iChannel - 1];
        }

        public bool GetTailGatingAPI(int iDvr, int iChannel, bool bValue)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].TailGatingAPI[iChannel - 1];
        }

        public bool GetWrongDirection(int iDvr, int iChannel, bool bValue)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].WrongDirection[iChannel - 1];
        }

        public bool GetGenericCA(int iDvr, int iChannel, bool bValue)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].GenericCA[iChannel - 1];
        }

        public bool GetOverCrowding(int iDvr, int iChannel, bool bValue)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].OverCrowding[iChannel - 1];
        }

        public bool GetKeepAlive(int iDvr, bool bValue)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].KeepAlive;
        }

        public bool GetTypeSession(int iDvr, int iChannel, bool bValue)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].TypeSession[iChannel - 1];
        }

        public bool GetUserTrigger(int iDvr, int iChannel, bool bValue)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].UserTrigger[iChannel - 1];
        }

        public bool GetDRY_CONTACT(int iDvr, int iSensor)
        {
            int iRealDvrID;

            iRealDvrID = GetRealDvrIndex(iDvr);

            return m_Alarms4Dvr[iRealDvrID].DRY_CONTACT[iSensor];
        }

        private int GetRealDvrIndex(int iDvr)
        {
            #region Data Members
            
            int i;
            int iNumberOfDvrs;

            string sMethod = MethodBase.GetCurrentMethod().Name; 

            #endregion

            try
            {
                if (m_Alarms4Dvr == null)
                {
                    return DvrClientConstants.NONE;
                }

                iNumberOfDvrs = m_Alarms4Dvr.Length;
                for (i = 0; i < iNumberOfDvrs; i++)
                {
                    if (m_Alarms4Dvr[i].DvrID == iDvr)
                    {
                        return i;
                    }
                }

                return DvrClientConstants.NONE;
            }
            catch (Exception e)
            {
                Audit("Couldn't Find Dvr ID With Dvr Index[" + iDvr + "]. " + e.Message, 
                      sMethod, 
                      AuditSeverity.Error);

                return DvrClientConstants.NONE;
            }
        }

        public bool GetChannelAlarmStatus(int iDvr, READ_TYPE readType, int iChannel)
        {
            #region Data Members

            bool bReply;

            string sMethod = MethodBase.GetCurrentMethod().Name; 
            string sAlarmState;
            string sResult;

            #endregion

            try
            {
                switch (readType)
                {
                    case READ_TYPE.VL:
                        sAlarmState = GetVideoLossState(iDvr, iChannel, out sResult);
                        if (!string.IsNullOrEmpty(sResult))
                        {
                            Audit("Read Type[" + Utils.GetEnumDescription(readType) + "] On Camera[" + iChannel + "]. " + sResult, sMethod, AuditSeverity.Warning);
                        }
                        break;


                    case READ_TYPE.VMD:
                        sAlarmState = GetVideoMotionDetectionState(iDvr, iChannel, out sResult);
                        if (!string.IsNullOrEmpty(sResult))
                        {
                            Audit("Read Type[" + Utils.GetEnumDescription(readType) + "] On Camera[" + iChannel + "]. " + sResult, sMethod, AuditSeverity.Warning);
                        }
                        break;

                    #region Not In Use
                    //case READ_TYPE.DRY_CONTACT:
                    //    bReply = m_Alarms4Dvr[iRealDvrID].DRY_CONTACT[iChannel];
                    //    break;


                    //case READ_TYPE.IntruderDetection:
                    //    bReply = m_Alarms4Dvr[iRealDvrID].IntruderDetection[iChannel];
                    //    break;


                    //case READ_TYPE.UnattendedBaggage:
                    //    bReply = m_Alarms4Dvr[iRealDvrID].UnattendedBaggage[iChannel];
                    //    break;


                    //case READ_TYPE.UnauthorizedCar:
                    //    bReply = m_Alarms4Dvr[iRealDvrID].UnauthorizedCar[iChannel];
                    //    break;


                    //case READ_TYPE.CrowdControl:
                    //    bReply = m_Alarms4Dvr[iRealDvrID].CrowdControl[iChannel];
                    //    break;


                    //case READ_TYPE.TailGating:
                    //    bReply = m_Alarms4Dvr[iRealDvrID].TailGating[iChannel];
                    //    break;


                    //case READ_TYPE.TailGatingAPI:
                    //    bReply = m_Alarms4Dvr[iRealDvrID].TailGatingAPI[iChannel];
                    //    break;


                    //case READ_TYPE.WrongDirection:
                    //    bReply = m_Alarms4Dvr[iRealDvrID].WrongDirection[iChannel];
                    //    break;


                    //case READ_TYPE.GenericCA:
                    //    bReply = m_Alarms4Dvr[iRealDvrID].GenericCA[iChannel];
                    //    break;


                    //case READ_TYPE.OverCrowding:
                    //    bReply = m_Alarms4Dvr[iRealDvrID].OverCrowding[iChannel];
                    //    break;
                    #endregion

                    default:
                        AuditPerform("Wrong Alarm Type[" + readType.ToString() + "] For Camera[" + iChannel + "]", sMethod, AuditSeverity.Error);
                        return false;
                }

                switch (sAlarmState.ToUpper())
                {
                    case "TRUE":
                        bReply = true;
                        break;

                    case "FALSE":
                        bReply = false;
                        break;

                    default:
                        AuditPerform("Wrong State[" + sAlarmState + "] For Alarm Type[" + readType.ToString() + "] For Camera[" + iChannel + "]",
                                     sMethod,
                                     AuditSeverity.Error);
                        bReply = false;
                        break;
                }

                return bReply;
            }
            catch (Exception e)
            {
                AuditPerform("Error For Alarm Type[" + readType.ToString() + "] For Camera[" + iChannel + "]. " + e.Message,
                             sMethod,
                             AuditSeverity.Error);

                return false;
            }
        }

        public void AddNiceMessage(NiceMessage nmNiceMessage)
        {
            if (m_AlarmsListenerMessagesHandlerThread != null)
            {
                m_AlarmsListenerMessagesHandlerThread.AddNiceMessage(nmNiceMessage);
            }
        }

        #endregion

        #region PTZ

        private void PtzAction(Common.Direction ptzDirection)
        {
            #region Data Members

            int iDisplay;
            int iSpeed;

            string sAction = "Undefined";
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            #endregion

            try
            {
                iDisplay = DisplayManager_GetActiveDisplayIndex();

                if (iDisplay == DvrClientConstants.NONE)
                {
                    Audit("No Active Display", sMethod, AuditSeverity.Warning);

                    return;
                }

                sAction = GetCameraDirectionString(ptzDirection);

                switch (ptzDirection)
                {
                    case Common.Direction.Up:
                    case Common.Direction.Down:
                        iSpeed = PtzTiltSpeed;
                        break;

                    case Common.Direction.Left:
                    case Common.Direction.Right:
                        iSpeed = PtzPanSpeed;
                        break;

                    case Common.Direction.UpLeft:
                    case Common.Direction.UpRight:
                    case Common.Direction.DownLeft:
                    case Common.Direction.DownRight:
                        iSpeed = Math.Max(PtzTiltSpeed, PtzPanSpeed);
                        break;

                    default:
                        Audit("Unknown PTZ Direction[" + ptzDirection + "]", sMethod, AuditSeverity.Warning);
                        return;
                }

                #region PTZ Speed

                iSpeed = Math.Max(m_Settings.PanSpeed, m_Settings.TiltSpeed);

                #endregion

                Audit("PTZ Action(" + ptzDirection.ToString() +
                      "  Speed: " + iSpeed + ")" +
                      " On Display[" + iDisplay +
                      "]",
                      sMethod,
                      AuditSeverity.Information);

                PtzParameters ptzParameters = new PtzParameters();
                ptzParameters.Camera = DisplayManager_GetCamera(DisplayManager_GetActiveDisplayIndex());
                ptzParameters.PtzDirection = ptzDirection;
                ptzParameters.Speed = iSpeed;
                ptzParameters.StartStop = true;

                vp[iDisplay].Ptz(ptzParameters, out sResult);               

                DisplayManager_SetPreset(iDisplay, "");
                lblCurrentPreset.Text = "";                
            }
            catch (Exception e)
            {
                Audit("PTZ Action " +
                      sAction +
                      " On Display[" + DisplayManager_GetActiveDisplayIndex() + "] Failed. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        private void ZoomAction(Common.Direction zoomDirection)
        {
            #region Data Members

            int iDisplay;
            int iSpeed;

            string sAction = "Undefined";
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            #endregion

            try
            {
                iDisplay = DisplayManager_GetActiveDisplayIndex();
                if (iDisplay == DvrClientConstants.NONE)
                {
                    Audit("No Active Display", sMethod, AuditSeverity.Warning);

                    return;
                }

                sAction = GetCameraZoomString(zoomDirection);

                #region Speed

                //switch (zoomDirection)
                //{
                //    case Common.Direction.ZoomIn:
                //        iSpeed = PtzZoomInSpeed;
                //        break;

                //    case Common.Direction.ZoomOut:
                //        iSpeed = PtzZoomOutSpeed;
                //        break;

                //    default:
                //        Audit("Unknown Zoom Direction[" + zoomDirection + "]", sMethod, AuditSeverity.Warning);
                //        return;
                //}                

                iSpeed = Math.Max(m_Settings.ZoomInSpeed, m_Settings.ZoomOutSpeed);

                #endregion                                      

                Audit("PTZ Action(" + sAction +
                      "  Speed: " + iSpeed + ")" +
                      " On Display[" + iDisplay +
                      "]",
                      sMethod,
                      AuditSeverity.Information);

                PtzParameters ptzParameters = new PtzParameters();
                ptzParameters.PtzDirection = zoomDirection;
                ptzParameters.Speed = iSpeed;
                ptzParameters.Camera = DisplayManager_GetCamera(iDisplay);
                ptzParameters.StartStop = true;

                vp[iDisplay].Ptz(ptzParameters, out sResult);

                DisplayManager_SetPreset(iDisplay, "");
                lblCurrentPreset.Text = "";                
            }
            catch (Exception e)
            {
                Audit("PTZ Action " +
                      sAction +
                      " On Display[" + DisplayManager_GetActiveDisplayIndex() + "] Failed. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        private void PtzStop()
        {
            #region Data members

            int iDisplay;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            #endregion

            try
            {
                iDisplay = DisplayManager_GetActiveDisplayIndex();
                if (DisplayManager_GetActiveDisplayIndex() == DvrClientConstants.NONE)
                {
                    Audit("Active Display Was Not Set", sMethod, AuditSeverity.Information);

                    return;
                }                
                
                Audit("PTZ Action STOP On Display[" + iDisplay + "]", sMethod, AuditSeverity.Information);

                PtzParameters ptzParameters = new PtzParameters();
                ptzParameters.Camera = DisplayManager_GetCamera(DisplayManager_GetActiveDisplayIndex());
                ptzParameters.PtzDirection = Common.Direction.Stop;
                ptzParameters.Speed = 0;
                ptzParameters.StartStop = false;

                vp[iDisplay].Ptz(ptzParameters, out sResult);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private string GetCameraDirectionString(Common.Direction ptzDirection)
        {
            switch (ptzDirection)
            {
                case Common.Direction.Down:
                    return "DOWN";

                case Common.Direction.Left:
                    return "LEFT";

                case Common.Direction.Right:
                    return "RIGHT";

                case Common.Direction.Up:
                    return "UP";

                default:
                    return "UNKNOWN";
            }
        }

        private string GetCameraZoomString(Common.Direction zoomDirection)
        {
            switch (zoomDirection)
            {
                case Common.Direction.ZoomIn:
                    return "ZOOM IN";


                case Common.Direction.ZoomOut:
                    return "ZOOM OUT";


                default:
                    return "UNKNOWN";
            }
        }

        #region GUI

        private void btnUpLeft_Click(object sender, EventArgs e)
        {
            PtzAction(Common.Direction.UpLeft);
        }

        private void btnUp_Click(object sender, EventArgs e)
        {
            PtzAction(Common.Direction.Up);
        }

        private void btnUpRight_Click(object sender, EventArgs e)
        {
            PtzAction(Direction.UpRight);
        }

        private void btnLeft_Click(object sender, EventArgs e)
        {
            PtzAction(Common.Direction.Left);
        }

        private void btnRight_Click(object sender, EventArgs e)
        {
            PtzAction(Common.Direction.Right);
        }

        private void btnDownLeft_Click(object sender, EventArgs e)
        {
            PtzAction(Direction.DownLeft);
        }

        private void btnDown_Click(object sender, EventArgs e)
        {
            PtzAction(Common.Direction.Down);
        }

        private void btnDownRight_Click(object sender, EventArgs e)
        {
            PtzAction(Direction.DownRight);
        }

        private void btnStop_Click(object sender, EventArgs e)
        {
            PtzStop();
        }

        private void btnZoomIn_Click(object sender, EventArgs e)
        {
            ZoomAction(Common.Direction.ZoomIn);
        }

        private void btnZoomOut_Click(object sender, EventArgs e)
        {
            ZoomAction(Common.Direction.ZoomOut);
        }

        private void btnPlayPreset_Click(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sPresetName = "";

            try
            {
                if ((cboDvrPresets.SelectedItem == null) || (DisplayManager_GetActiveDisplayIndex() == DvrClientConstants.NONE))
                {
                    return;
                }

                sPresetName = cboDvrPresets.SelectedItem.ToString();
                if (sPresetName == "<NONE>")
                {
                    return;
                }

                if (ActivatePreset())
                {
                    cboDvrPresets.Text = cboDvrPresets.Items[0].ToString();
                }

                DisplayManager_SetPreset(DisplayManager_GetActiveDisplayIndex(), sPresetName);

                Audit("Preset[" + sPresetName + "] Activated For Display[" +
                      DisplayManager_GetActiveDisplayIndex() +
                      "] Camera[" +
                      DisplayManager_DisplayCameraNumber(DisplayManager_GetActiveDisplayIndex()) +
                      "] On DVR[" + DisplayManager_DisplayDvrId(DisplayManager_GetActiveDisplayIndex()) + "]",
                      sMethod,
                      AuditSeverity.Information);
            }
            catch (Exception ex)
            {
                Audit("Faild To Activate Preset[" + sPresetName +
                      "] For Display[ " + DisplayManager_GetActiveDisplayIndex() +
                      "] Camera[" + DisplayManager_DisplayCameraName(DisplayManager_GetActiveDisplayIndex()) +
                      "] On DVR[" + DisplayManager_DisplaySiteName(DisplayManager_GetActiveDisplayIndex()) +
                      "]. " + ex.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        private void btnLeft_MouseUp(object sender, MouseEventArgs e)
        {
            PtzStop();
        }

        private void btnRight_MouseUp(object sender, MouseEventArgs e)
        {
            PtzStop();
        }

        private void btnUpLeft_MouseUp(object sender, MouseEventArgs e)
        {
            PtzStop();
        }

        private void btnUpRight_MouseUp(object sender, MouseEventArgs e)
        {
            PtzStop();
        }

        private void btnZoomIn_MouseUp(object sender, MouseEventArgs e)
        {
            PtzStop();
        }

        private void btnZoomOut_MouseUp(object sender, MouseEventArgs e)
        {
            PtzStop();
        }

        private void btnUp_MouseUp(object sender, MouseEventArgs e)
        {
            PtzStop();
        }

        private void btnDown_MouseUp(object sender, MouseEventArgs e)
        {
            PtzStop();
        }

        private void btnDownLeft_MouseUp(object sender, MouseEventArgs e)
        {
            PtzStop();
        }

        private void btnDownRight_MouseUp(object sender, MouseEventArgs e)
        {
            PtzStop();
        } 

        #endregion

        #endregion

        #region Preset Stuff

        //private PCompStatus GetAllPresets(int iDisplay, out Array aPreset)
        //{
        //    #region Data Members

        //    PCompStatus pcsStatus = PCompStatus.PCompStatus_Fail;
        //    string sMethod = MethodBase.GetCurrentMethod().Name;

        //    #endregion
            
        //    aPreset = null;

        //    try
        //    {
        //        switch (m_Settings.PtzPresetPath)
        //        {
        //            case PtzPresetActivation.Direct:                                  
        //                pcsStatus = m_PlayerPTZ[iDisplay].PTZ_GetAllPresets(out aPreset);
        //                break;                    

        //            default:                                                
        //                break;
        //        }

        //        return pcsStatus;
        //    }
        //    catch (Exception e)
        //    {
        //        Audit(e.Message, sMethod, AuditSeverity.Error);                

        //        return PCompStatus.PCompStatus_Fail;                
        //    }
        //}

        private void OnAddPreset(object sender, MouseEventArgs e)
        {
            #region Data Members

            int iDisplay;
            int iPresetNumber;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;
            string sPresetName;

            PtzParameters ptzParameters;

            CameraInformation ciCameraInformation;

            #endregion

            try
            {
                iDisplay = DisplayManager_GetActiveDisplayIndex();
                if (iDisplay == DvrClientConstants.NONE)
                {
                    Audit("No Active Display", sMethod, AuditSeverity.Error);

                    return;
                }

                if (!DisplayManager_DisplayIsPtz(iDisplay))
                {
                    return;
                }

                sPresetName = Interaction.InputBox("Enter A Name For The New PTZ Preset.", 
                                                   "Add Preset", 
                                                   "", 
                                                   DvrClientConstants.NONE, 
                                                   DvrClientConstants.NONE);

                if (string.IsNullOrEmpty(sPresetName))
                {
                    MessageBox.Show("Preset Name Is Null Or Empty", "Bad Preset Name");

                    return;
                }

                ciCameraInformation = DisplayManager_GetCamera(iDisplay);

                if (!PresetNameFree(sPresetName.ToLower(), ciCameraInformation.DvrId, ciCameraInformation.CameraNumber, out sResult))
                {
                    MessageBox.Show(sResult, "Bad Preset Name");

                    return;
                }

                iPresetNumber = GetVendorPresetNumber(ciCameraInformation.DvrId, ciCameraInformation.CameraNumber);
                if (iPresetNumber != DvrClientConstants.NONE)
                {
                    DbReturnCode dbRc = InsertPresetRecord(ciCameraInformation.DvrId,
                                                           ciCameraInformation.CameraNumber, 
                                                           iPresetNumber, 
                                                           sPresetName.ToLower());
                    if (dbRc != DbReturnCode.FinishedOK)
                    {
                        MessageBox.Show("Failed Inserting Preset Name '" + sPresetName + "'. " + dbRc, 
                                        "Bad Preset Name");

                        return;
                    }
                }

                

                ptzParameters = new PtzParameters();
                ptzParameters.PresetId = iPresetNumber;
                ptzParameters.Camera = ciCameraInformation;
                if (!vp[iDisplay].PtzPreset(ptzParameters, 
                                            PresetAction.Add, 
                                            out sResult))
                {
                    MessageBox.Show("Failed Saving Preset'" + sPresetName + "'. " + sResult,
                                    "Bad Preset Name");
                }

                PopulatePresetsList();
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void OnUpdatePreset(object sender, MouseEventArgs e)
        {
            #region Data Members
            
            int iDisplay;
            int iDvrId;
            int iCameraNumber;
            int iPresetNumber;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sPresetName;
            string sOldPresetName;
            string sResult;

            DbReturnCode dbRc;

            #endregion

            try
            {
                iDisplay = DisplayManager_GetActiveDisplayIndex();
                if (iDisplay == DvrClientConstants.NONE)
                {
                    Audit("No Active Display", sMethod, AuditSeverity.Error);

                    return;
                }

                if (cboDvrPresets.SelectedItem == null)
                {
                    MessageBox.Show("No Preset Is Selected",
                                    "Update Preset",
                                    MessageBoxButtons.OK,
                                    MessageBoxIcon.Exclamation);
                    Audit("No Preset Is Selected", sMethod, AuditSeverity.Information);

                    return;
                }

                sOldPresetName = (string)(cboDvrPresets.SelectedItem);
                
                sPresetName = Interaction.InputBox("Enter A New Name For The Current PTZ Preset.",
                                                    "Update Preset",
                                                    sOldPresetName,
                                                    DvrClientConstants.NONE,
                                                    DvrClientConstants.NONE);
                

                if (string.IsNullOrEmpty(sPresetName))
                {
                    return;
                }

                if (sPresetName == sOldPresetName)
                {
                    MessageBox.Show("Preset Name Already Exists.",
                                    "Update Preset",
                                    MessageBoxButtons.OK,
                                    MessageBoxIcon.Exclamation);

                    return;
                }


                iDvrId = DisplayManager_DisplayDvrId(iDisplay);
                iCameraNumber = DisplayManager_DisplayCameraNumber(iDisplay);
                iPresetNumber = DvrClientConstants.NONE;

                if (PresetNameExists(iDvrId, iCameraNumber, sPresetName, out iPresetNumber))
                {
                    MessageBox.Show("Preset Name Already Exists.",
                                    "Update Preset",
                                    MessageBoxButtons.OK,
                                    MessageBoxIcon.Exclamation);

                    return;
                }
                else
                {
                    if (!GetCameraPresetNumber(iDvrId, iCameraNumber, sOldPresetName, out iPresetNumber, out sResult))
                    {
                        MessageBox.Show("Can't Get Preset '" + sOldPresetName + "' Number. " + sResult,
                                        "Update Preset",
                                        MessageBoxButtons.OK,
                                        MessageBoxIcon.Exclamation);

                        return;
                    }
                }

                DialogResult drResult = MessageBox.Show("Replacing Preset Name '" + sOldPresetName + 
                                                        "' With '" + sPresetName + "'. Continue?", 
                                                        "Update Preset",
                                                        MessageBoxButtons.YesNo,
                                                        MessageBoxIcon.Exclamation);
                if (drResult != DialogResult.Yes)
                {
                    return;
                }

                dbRc = UpdatePresetRecord(iDvrId, iCameraNumber, iPresetNumber, sPresetName);
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    MessageBox.Show("Failed Updateing Preset From '" + sOldPresetName + "' To '" + sPresetName + "'",
                                    "Update Preset",
                                    MessageBoxButtons.OK,
                                    MessageBoxIcon.Exclamation);
                    return;
                }

                PopulatePresetsList();

                Audit("Updated Preset Name From '" + sOldPresetName + " To '" + sPresetName + "' ",
                      sMethod, 
                      AuditSeverity.Information);
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void OnDeletePreset(object sender, MouseEventArgs e)
        {
            #region Data Members

            int iDisplay;
            int iPresetNumber;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sInput;
            string sResult;
            string sPresetName;

            DbReturnCode dbRc;

            PtzParameters ptzParameters;

            CameraInformation ciCameraInformation;

            #endregion

            try
            {
                iDisplay = DisplayManager_GetActiveDisplayIndex();
                if (iDisplay == DvrClientConstants.NONE)
                {
                    Audit("No Active Display", sMethod, AuditSeverity.Error);

                    return;
                }

                if (cboDvrPresets.SelectedItem == null)
                {
                    MessageBox.Show("No Preset Is Selected",
                                    "Delete Preset",
                                    MessageBoxButtons.OK,
                                    MessageBoxIcon.Exclamation);
                    Audit("No Preset Is Selected", sMethod, AuditSeverity.Information);

                    return;
                }

                ciCameraInformation = DisplayManager_GetCamera(iDisplay);

                sPresetName = (string)(cboDvrPresets.SelectedItem);
                if (!GetCameraPresetNumber(ciCameraInformation.DvrId, ciCameraInformation.CameraNumber, sPresetName, out iPresetNumber, out sResult))
                {
                    MessageBox.Show("Can't Get Preset '" + sPresetName + "' Number. " + sResult,
                                    "Delete Preset",
                                    MessageBoxButtons.OK,
                                    MessageBoxIcon.Exclamation);

                    return;
                }

                DialogResult drResult = MessageBox.Show("Deleting Preset Name '" + sPresetName + "'. Continue?",
                                                        "Delete Preset",
                                                        MessageBoxButtons.YesNo,
                                                        MessageBoxIcon.Exclamation);
                if (drResult != DialogResult.Yes)
                {
                    return;
                }

                ptzParameters = new PtzParameters();
                ptzParameters.PresetId = iPresetNumber;
                if (!vp[iDisplay].PtzPreset( ptzParameters,
                                            PresetAction.Clear,
                                            out sResult))
                {
                    MessageBox.Show("Can't Get Delete Preset '" + sPresetName + 
                                    "' Number[" + iPresetNumber + "]. " + sResult,
                                    "Delete Preset",
                                    MessageBoxButtons.OK,
                                    MessageBoxIcon.Exclamation);

                    return;
                }

                dbRc = DeletePreset(ciCameraInformation.DvrId, ciCameraInformation.CameraNumber, iPresetNumber);
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    MessageBox.Show("Can't Get Delete Preset '" + sPresetName +
                                    "' Number[" + iPresetNumber + "] For Camera[" + ciCameraInformation.CameraNumber + "]",
                                    "Delete Preset",
                                    MessageBoxButtons.OK,
                                    MessageBoxIcon.Exclamation);
                }

                PopulatePresetsList();

                Audit("Deleted Preset '" + sPresetName + "' ", sMethod, AuditSeverity.Information);
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void PopulatePresetsList()
        {
            #region Data Members

            string sResult;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            List<string> lsPreset;

            int iDvrId;
            int iCameraNumber;
            int iDisplay;

            #endregion

            try
            {
                iDisplay = DisplayManager_GetActiveDisplayIndex();
                if (iDisplay == DvrClientConstants.NONE)
                {
                    Audit("No Active Display", sMethod, AuditSeverity.Error);

                    return;
                }

                iDvrId = DisplayManager_DisplayDvrId(iDisplay);
                iCameraNumber = DisplayManager_DisplayCameraNumber(iDisplay);

                cboDvrPresets.Items.Clear();

                if (!GetCameraPresets(iDvrId, iCameraNumber, out lsPreset, out sResult))
                {
                    return;
                }

                if (lsPreset == null)
                {
                    return;
                }

                if (lsPreset.Count == 0)
                {
                    return;
                }

                cboDvrPresets.Items.Add("<NONE>");
                for (int i = 0; i < lsPreset.Count; i++)
                {
                    cboDvrPresets.Items.Add(lsPreset[i]);
                }
                cboDvrPresets.Text = cboDvrPresets.Items[0].ToString();
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void PopulatePresetsList(out List<string> lsPreset)
        {
            #region Data Members

            string sResult;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            
            int iDvrId;
            int iCameraNumber;
            int iDisplay;

            #endregion

            lsPreset = null;

            try
            {
                iDisplay = DisplayManager_GetActiveDisplayIndex();
                if (iDisplay == DvrClientConstants.NONE)
                {
                    Audit("No Active Display", sMethod, AuditSeverity.Error);

                    return;
                }

                iDvrId = DisplayManager_DisplayDvrId(iDisplay);
                iCameraNumber = DisplayManager_DisplayCameraNumber(iDisplay);

                cboDvrPresets.Items.Clear();

                if (!GetCameraPresets(iDvrId, iCameraNumber, out lsPreset, out sResult))
                {
                    return;
                }

                if (lsPreset == null)
                {
                    return;
                }

                if (lsPreset.Count == 0)
                {
                    return;
                }

                cboDvrPresets.Items.Add("<NONE>");
                for (int i = 0; i < lsPreset.Count; i++)
                {
                    cboDvrPresets.Items.Add(lsPreset[i]);
                }
                cboDvrPresets.Text = cboDvrPresets.Items[0].ToString();
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private bool PresetNameExists(string sPresetName, int iDisplay)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            //Array presets;

            try
            {
                //PCompStatus status = GetAllPresets(iDisplay, out presets);
                //if (status != PCompStatus.PCompStatus_Ok)
                //{
                //    Audit("Get All Presets Failed. Error: " + Utils.StatusString(status.ToString()), 
                //          sMethod,
                //          AuditSeverity.Warning);

                //    return false;
                //}

                //if (presets == null)
                //{
                //    return false; // no available presets
                //}

                //foreach (PComp_PresetInfo preset in presets)
                //{
                //    if (sPresetName == preset.PresetName)
                //    {
                //        return true;    // found the preset name in the existing presets
                //    }
                //}

                return false;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private bool PresetNameExists(string sPresetName, string sDvr, int iCameraNumber, out string sResult)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                sResult = "";

                if (m_DvrsAndCameras == null)
                {
                    sResult = "Dvrs And Cameras List Is Empty";

                    return false;
                }                                  
                
                for (int iDvrIndex = 0; iDvrIndex < m_DvrsAndCameras.Count; iDvrIndex++)
                {
                    if (m_DvrsAndCameras[iDvrIndex].Description == sDvr)
                    {
                        if (m_DvrsAndCameras[iDvrIndex].Cameras != null)
                        {
                            for (int iCameraIndex = 0; iCameraIndex < m_DvrsAndCameras[iDvrIndex].Cameras.Count; iCameraIndex++)
                            {
                                if (m_DvrsAndCameras[iDvrIndex].Cameras[iCameraIndex].Number == iCameraNumber)
                                {
                                    if ((m_DvrsAndCameras[iDvrIndex].Cameras[iCameraIndex].HasPresets) &&
                                        (m_DvrsAndCameras[iDvrIndex].Cameras[iCameraIndex].Preset != null))
                                    {
                                        for (int iPresetIndex = 0; iPresetIndex < m_DvrsAndCameras[iDvrIndex].Cameras[iCameraIndex].Preset.Count; iPresetIndex++)
                                        {
                                            if (m_DvrsAndCameras[iDvrIndex].Cameras[iCameraIndex].Preset[iPresetIndex] == sPresetName)
                                            {
                                                return true;
                                            }
                                            else
                                            {
                                                sResult = "Preset[" + sPresetName + "] For Camera[" + iCameraNumber + "] On Dvr[" + sDvr + "] Not Found";
                                            }
                                        }
                                    }
                                    else
                                    {
                                        sResult = "Camera[" + iCameraNumber + "] On Dvr[" + sDvr + "] Has No Preset Or Presets Array Is Null";
                                    }

                                    return false;
                                }
                                else
                                {
                                    sResult = "Camera[" + iCameraNumber + "] On Dvr[" + sDvr + "] Not Found";
                                }
                            }
                        }
                    }
                    else
                    {
                        sResult = "Dvr[" + sDvr + "] Not Found";
                    }
                }
               
                return false;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
                sResult = e.Message;

                return false;
            }
        }

        private bool PresetNameFree(string sPresetName, int iDvrId, int iCameraNumber, out string sResult)
        {            
            #region Data Members

            OleDbCommand cmd;

            int iNumberOfRecords;

            DbReturnCode rc;

            #endregion

            sResult = "";

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                sResult = "Can't Open Connection";

                return false;
            }

            cmd = new OleDbCommand("SELECT COUNT(*) FROM Presets WHERE DvrId=" + iDvrId +
                                   " AND CameraNumber=" + iCameraNumber + 
                                   " AND PresetName='" + sPresetName +"'",
                                   m_cn);
            try
            {
                iNumberOfRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                sResult = e.ToString();

                return false;
            }

            if (iNumberOfRecords == 0)
            {
                return true;
            }

            return false;
        }

        private bool ActivatePreset()
        {
            #region Data Member
                
            string sResult;
            string sPresetName;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            int iActiveDisplayIndex;
            int iDvrId;
            int iDvrGroupId;
            int iCameraNumber;
            int iPresetNumber;

            PtzParameters ptzParameters;

            CameraInformation ciCamerainformation;

            #endregion

            try
            {
                iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();

                iDvrGroupId = DisplayManager_DisplayDvrGroupId(iActiveDisplayIndex);
                iDvrId = DisplayManager_DisplayDvrId(iActiveDisplayIndex);
                iCameraNumber = DisplayManager_DisplayCameraNumber(iActiveDisplayIndex);

                ciCamerainformation = DisplayManager_GetCamera(iActiveDisplayIndex);
                
                sPresetName = (string)(cboDvrPresets.SelectedItem);

                if (!GetCameraPresetNumber(iDvrId, iCameraNumber, sPresetName, out iPresetNumber, out sResult))
                {
                    return false;
                }

                ptzParameters = new PtzParameters();
                ptzParameters.PresetId = iPresetNumber;
                ptzParameters.Camera = ciCamerainformation;

                vp[iActiveDisplayIndex].PtzPreset(ptzParameters,
                                                  PresetAction.Call,
                                                  out sResult);

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private bool ActivatePreset(string sPresetName)
        {
            #region Data Member

            string sResult;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            int iActiveDisplayIndex;
            int iDvrId;
            int iDvrGroupId;
            int iCameraNumber;
            int iPresetNumber;

            PtzParameters ptzParameters;

            CameraInformation ciCamerainformation;

            #endregion

            try
            {
                

                iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();

                //iDvrGroupId = DisplayManager_DisplayDvrGroupId(iActiveDisplayIndex);
                iDvrId = DisplayManager_DisplayDvrId(iActiveDisplayIndex);
                iCameraNumber = DisplayManager_DisplayCameraNumber(iActiveDisplayIndex);

                if (!GetCameraPresetNumber(iDvrId, iCameraNumber, sPresetName, out iPresetNumber, out sResult))
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);

                    return false;
                }

                ciCamerainformation = GetCameraInformation(iDvrId, iCameraNumber, out sResult);
                if (ciCamerainformation == null)
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);

                    return false;
                }

                ptzParameters = new PtzParameters();
                ptzParameters.PresetId = iPresetNumber;
                ptzParameters.Camera = ciCamerainformation;

                vp[iActiveDisplayIndex].PtzPreset(ptzParameters,
                                                  PresetAction.Call,
                                                  out sResult);

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private bool ActivatePreset(int iDvrGroupId, int iDvrId, int iCameraNumber, int iDisplayIndex, string sPresetName)
        {
            #region Data Member

            string sResult;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            int iPresetNumber;

            PtzParameters ptzParameters;

            CameraInformation ciCamerainformation;

            #endregion

            try
            {
                if (!GetCameraPresetNumber(iDvrId, iCameraNumber, sPresetName, out iPresetNumber, out sResult))
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);

                    return false;
                }

                ciCamerainformation = GetCameraInformation(iDvrId, iCameraNumber, out sResult);
                if (ciCamerainformation == null)
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);

                    return false;
                }

                ptzParameters = new PtzParameters();
                ptzParameters.PresetId = iPresetNumber;
                ptzParameters.Camera = ciCamerainformation;

                vp[iDisplayIndex].PtzPreset(ptzParameters,
                                            PresetAction.Call,
                                            out sResult);

                return true;
            }
            catch (Exception e)
            {
                return false;
            }
        }

        //private PCompStatus ActivatePreset(int iDisplay, int iPresetId, string sPresetName)
        //{
        //    string sMethod = MethodBase.GetCurrentMethod().Name;
        //    PCompStatus pcsStatus;

        //    try
        //    {
        //        switch (m_Settings.PtzPresetPath)
        //        {
        //            case PtzPresetActivation.Direct:
        //                pcsStatus = m_PlayerPTZ[iDisplay].PTZ_GoToPreset(iPresetId);
        //                break;

        //            default:
        //                pcsStatus = PCompStatus.PCompStatus_Fail;
        //                break;
        //        }

        //        for (int i = 0; i < m_PtzPreset.Count; i++)
        //        {
        //            if ((m_PtzPreset[i].Dvr == DisplayManager_DisplaySiteName(iDisplay)) &&
        //                (m_PtzPreset[i].CameraNumber == DisplayManager_DisplayCameraNumber(iDisplay)))
        //            {
        //                bool bRc;

        //                int iFromHour;
        //                int iFromMinute;
        //                int iToHour;
        //                int iToMinute;

        //                string sError;

        //                Types.MultiTimerItem myItem;

        //                if (sPresetName == m_PtzPreset[i].Preset)
        //                {
        //                    continue;
        //                }

        //                bRc = Utils.HourMinuteStringToTimeInterval(m_PtzPreset[i].From,
        //                                                            m_PtzPreset[i].To,
        //                                                            out iFromHour,
        //                                                            out iFromMinute,
        //                                                            out iToHour,
        //                                                            out iToMinute,
        //                                                            out sError);

        //                if (bRc)
        //                {
        //                    Types.TimeInterval ti = new Types.TimeInterval(iFromHour,
        //                                                                                   iFromMinute,
        //                                                                                   iToHour,
        //                                                                                   iToMinute);
        //                    if (ti.IsInInterval(DateTime.Now.Hour, DateTime.Now.Minute))
        //                    {
        //                        Audit("Preset[" + m_PtzPreset[i].Preset +
        //                              "] Will Be Activated In " + m_PtzPreset[i].Delay +
        //                              " Seconds",
        //                              sMethod,
        //                              AuditSeverity.Information);

        //                        myItem = new Types.MultiTimerItem(m_PtzPreset[i].Dvr,
        //                                                          m_PtzPreset[i].CameraNumber,
        //                                                          m_PtzPreset[i].Preset,
        //                                                          m_PtzPreset[i].Delay);
        //                        m_MultiTimer.Add(myItem);
        //                    }
        //                }
        //                else
        //                {
        //                    Audit(sError, sMethod, AuditSeverity.Warning);
        //                }
        //            }
        //        }

        //        return pcsStatus;
        //    }
        //    catch (Exception e)
        //    {
        //        Audit("Failed Activating Preset Name[" + sPresetName +
        //              "] ID[" + iPresetId +
        //              "] On Display[" + iDisplay +
        //              "]" + e.Message,
        //              sMethod,
        //              AuditSeverity.Error);

        //        return PCompStatus.PCompStatus_Fail;
        //    }
        //}

        private bool KillDvrClientPtzPresetAgentProcess()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                Process[] processDvrClientPtzPresetAgentProcess = Process.GetProcessesByName(DvrClientConstants.AGENT_APPLICATION_NAME);
                if (processDvrClientPtzPresetAgentProcess != null)
                {
                    if (processDvrClientPtzPresetAgentProcess.Length > 0)
                    {
                        processDvrClientPtzPresetAgentProcess[0].Kill();
                    }
                }

                return true;
            }
            catch (Exception e)
            {
                string sError = e.Message;

                Utils.WriteToDebugView(DvrClientModule.Main.ToString(), sMethod, sError);

                return false;
            }
        }

        private bool StartDvrClientPtzPresetAgentProcess(out int iProcessDvrClientPtzPresetAgentProcessId)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            Process processDvrClientPtzPresetAgentProcess = new Process();
            ProcessStartInfo psi = new ProcessStartInfo();
            psi.WorkingDirectory = m_Settings.NiceDllsPath;
            psi.FileName = DvrClientConstants.AGENT_APPLICATION_NAME + ".exe";
            psi.UseShellExecute = true;
            try
            {
                processDvrClientPtzPresetAgentProcess = Process.Start(psi);
                iProcessDvrClientPtzPresetAgentProcessId = processDvrClientPtzPresetAgentProcess.Id;

                return true;
            }
            catch (Exception ex)
            {
                iProcessDvrClientPtzPresetAgentProcessId = DvrClientConstants.NONE;
                Audit("Failed Starting '" + DvrClientConstants.AGENT_APPLICATION_NAME + ".exe'. " + ex.Message,
                      sMethod,
                      AuditSeverity.Error);
                
                return false;
            }
        }

        private bool AddPresetsToCameraInformation()
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;
            string sFileName = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) + "\\Afcon.DvrClient.DvrsAndCameras.xml";

            List<string> lsPreset;

            #endregion

            try
            {
                if (m_DvrInformation == null)
                {
                    Audit("Dvrs List Is Null", sMethod, AuditSeverity.Warning);

                    return false;
                }

                for (int i = 0; i < m_DvrInformation.Count; i++)
                {
                    if (m_DvrInformation[i].Camera == null)
                    {
                        continue;
                    }

                    for (int j = 0; j < m_DvrInformation[i].Camera.Count; j++)
                    {
                        if (GetCameraPresets(m_DvrInformation[i].DvrId, m_DvrInformation[i].Camera[j].CameraNumber, out lsPreset, out sResult))
                        {
                            m_DvrInformation[i].Camera[j].Preset = lsPreset;
                            if (lsPreset != null)
                            {
                                if (lsPreset.Count > 0)
                                {
                                    m_DvrInformation[i].Camera[j].HasPresets = true;
                                }
                            }
                        }
                    }
                }

                sFileName = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) + "\\Afcon.DvrClient.DvrsAndCameras.xml";
                if (!Utils.WriteToXmlFile(sFileName, m_DvrInformation))
                {
                    sResult = "Failed To Write Dvrs And Cameras To XML File";
                }

                return true;
            }
            catch (Exception e)
            {
                return false;
            }
        }

        #endregion

        #region Audit

        private void Audit(string sLine, string sMethod, AuditSeverity sSeverity)
        {
            Audit(sLine, DvrClientModule.Main, sMethod, sSeverity);
        }

        private void Audit(string sLine, string sMethod, Color backColor)
        {
            Audit(sLine, DvrClientModule.Main, sMethod, backColor);
        }

        private void Audit(string sLine, DvrClientModule mModule, string sMethod)
        {
            string sDateTime = DateTime.Now.ToString("dd-MM-yyyy HH:mm:ss.fff"); 

            if (!m_bHdLimitReached)
            {
                if (m_Settings.AuditLog)
                {
                    if (m_AuditFile != null)
                    {
                        switch (m_Settings.AuditLogFileType)
                        {
                            case AuditFileType.TextFile:
                                m_AuditFile.WriteLine(sDateTime +
                                                      " <" + Utils.GetEnumDescription(mModule) + "> " +
                                                      " <" + sMethod + "> " + sLine);
                                break;

                            case AuditFileType.Csv:
                                m_AuditFile.WriteLine(sDateTime + "," +
                                                      "," +
                                                      Utils.GetEnumDescription(mModule) + "," +
                                                      sMethod + "," +
                                                      sLine);
                                break;

                            default:
                                return;
                        }

                        m_AuditFile.Flush();
                    }

                    if (m_bDatabaseExists)
                    {
                        InsertLogRecord(mModule, sMethod, sLine);
                    }
                } 
            }

            if (m_Settings.Audit)
            {
                if (m_Log != null)
                {
                    m_Log.Audit(sLine, sMethod, mModule);
                }
            }

            if (m_Settings.AuditToDebug)
            {
                Utils.WriteToDebugView(mModule, sMethod, sLine);
            }
        }

        public void Audit(string sLine, DvrClientModule mModule, string sMethod, AuditSeverity aSeverity)
        {
            string sDateTime = DateTime.Now.ToString("dd-MM-yyyy HH:mm:ss.fff");

            if (!m_bHdLimitReached)
            {
                if (m_Settings.AuditLog)
                {
                    if (m_AuditFile != null)
                    {
                        switch (m_Settings.AuditLogFileType)
                        {
                            case AuditFileType.TextFile:
                                m_AuditFile.WriteLine(sDateTime +
                                                      " <" + aSeverity.ToString() + "> " +
                                                      " <" + Utils.GetEnumDescription(mModule) + "> " +
                                                      " <" + sMethod + "> " + sLine);
                                break;

                            case AuditFileType.Csv:
                                m_AuditFile.WriteLine(sDateTime + "," +
                                                      aSeverity.ToString() + "," +
                                                      Utils.GetEnumDescription(mModule) + "," +
                                                      sMethod + "," +
                                                      sLine);
                                break;

                            default:
                                return;
                        }

                        m_AuditFile.Flush();
                    }
                }

                if (m_bDatabaseExists)
                {
                    InsertLogRecord(mModule, sMethod, sLine);
                }


                if (m_Settings.CreateErrorsFile)
                {
                    if ((aSeverity == AuditSeverity.Warning) || (aSeverity == AuditSeverity.Error))
                    {
                        m_ErrorsFile.WriteLine(sDateTime +
                                               " <" + aSeverity.ToString() + "> " +
                                               " <" + Utils.GetEnumDescription(mModule) + "> " +
                                               " <" + sMethod + "> " + sLine);
                        m_ErrorsFile.Flush();
                    }
                }
            }

            if (m_Settings.Audit)
            {
                if (m_Log != null)
                {
                    m_Log.Audit(sLine, sMethod, mModule, aSeverity);
                }
            }

            if (m_Settings.AuditToDebug)
            {
                Utils.WriteToDebugView(mModule, sMethod, sLine, aSeverity);
            }
        }

        private void Audit(string sLine, DvrClientModule mModule, string sMethod, Color backColor)
        {
            string sDateTime = DateTime.Now.ToString("dd-MM-yyyy HH:mm:ss.fff");

            if (!m_bHdLimitReached)
            {
                if (m_Settings.AuditLog)
                {
                    if (m_AuditFile != null)
                    {
                        switch (m_Settings.AuditLogFileType)
                        {
                            case AuditFileType.TextFile:
                                m_AuditFile.WriteLine(sDateTime +
                                                      " <" + Utils.GetEnumDescription(mModule) + "> " +
                                                      " <" + sMethod + "> " + sLine);
                                break;

                            case AuditFileType.Csv:
                                m_AuditFile.WriteLine(sDateTime + "," +
                                                      "," +
                                                      Utils.GetEnumDescription(mModule) + "," +                                                      
                                                      sMethod + "," +
                                                      sLine);
                                break;

                            default:
                                return;
                        }

                        m_AuditFile.WriteLine(sDateTime + 
                                              " <" + Utils.GetEnumDescription(mModule) + "> " + 
                                              " <" + sMethod + "> " + sLine);
                        m_AuditFile.Flush();
                    }
                }

                if (m_bDatabaseExists)
                {
                    InsertLogRecord(mModule, sMethod, sLine);
                }
            }

            if (m_Settings.Audit)
            {
                m_Log.Audit(sLine, sMethod, mModule, backColor);
            }

            if (m_Settings.AuditToDebug)
            {
                Utils.WriteToDebugView(mModule, sMethod, sLine);
            }
        }

        private void AttentionStampToLog(string sMethod)
        {
            Audit("<<< Attention!!! >>>", sMethod, AuditSeverity.Important);
        }

        private void AuditPerform(string sLine, string sMethod)
        {
            Perform(MainFormFunction.Audit, sLine, sMethod, DvrClientModule.Main);
        }

        private void AuditPerform(string sLine, string sMethod, AuditSeverity aSeverity)
        {
            sLine = "{" + aSeverity.ToString() + "}" + sLine;
            Perform(MainFormFunction.Audit, sLine, sMethod, DvrClientModule.Main);
        }

        private void EndAudit()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                //  Closing the Audit 
                if (m_Log != null && !m_Log.IsDisposed && !m_Log.Disposing)
                {
                    m_Log.Close();
                    m_Log = null;

                    Utils.WriteToDebugView(DvrClientModule.Main, 
                                           sMethod, 
                                           "Audit Form Closed", 
                                           AuditSeverity.Important);
                }
            }
            catch (Exception e)
            {
                Utils.WriteToDebugView(DvrClientModule.Main,
                                       sMethod,
                                       "Failed To End Audit Form. " + e.Message,
                                       AuditSeverity.Error);
            }
        }        

        private void EndProtocolData()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                //  Closing the Protocol Special Audit 
                if (m_Protocol != null && !m_Protocol.IsDisposed && !m_Protocol.Disposing)
                {
                    m_Protocol.Close();
                    m_Protocol = null;

                    Utils.WriteToDebugView(DvrClientModule.Main,
                                           sMethod,
                                           "Protocol Data Form Closed",
                                           AuditSeverity.Error);
                }
            }
            catch (Exception e)
            {
                Utils.WriteToDebugView(DvrClientModule.Main,
                                       sMethod,
                                       "Failed To End Protocol Data. " + e.Message,
                                       AuditSeverity.Error);
            }
        }

        private void WriteRawData(string sMessage, string sDirection)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sDateTime = DateTime.Now.ToString("dd-MM-yyyy HH:mm:ss.fff");

            try
            {
                if (m_Settings.ShowProtocolRawData)
                {
                    if (m_Protocol != null)
                    {
                        m_Protocol.Write(sMessage, sDirection);
                    }

                    if (!m_bHdLimitReached)
                    {
                        m_ProtocolDataFile.WriteLine(sDateTime + 
                                                     " <" + sDirection + "> " + sMessage);
                        m_ProtocolDataFile.Flush(); 
                    }
                }
            }
            catch (Exception e)
            {
                Audit("Message[" + sMessage + "] Direction[" + sDirection + "]. " + e.Message, 
                      sMethod,
                      AuditSeverity.Warning);
            }
        }

        private void AlarmListenerFilter(int iDvr, int iCameraNumber, int iEventType)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sMessage = "Filter{";
            string sDvr;

            if (m_AlarmsListenerThread != null)
            {
                if ((iEventType == DvrClientConstants.NONE) &&
                    (iCameraNumber == DvrClientConstants.NONE) &&
                    (iDvr == DvrClientConstants.NONE))
                {
                    Audit("Filter Freed", sMethod, AuditSeverity.Information);
                }

                if (iDvr != DvrClientConstants.NONE)
                {
                    sDvr = GetDvrName(iDvr);
                    sMessage += "Dvr[" + iDvr + " - " + sDvr + "]";
                
                    if (iCameraNumber != DvrClientConstants.NONE)
                    { 
                        sMessage += " Camera[" + iCameraNumber + " - " + GetCameraNameByCameraNumber(sDvr, iCameraNumber) + "]";
                    }
                }

                if (iEventType != DvrClientConstants.NONE)
                {
                    if (iDvr != DvrClientConstants.NONE)
                    {
                        sMessage += " ";
                    }
                    sMessage += "Event Type[" + Utils.GetEnumDescription((NiceEvent)iEventType) + "]";
                }

                sMessage += "}";
                Audit(sMessage, sMethod, AuditSeverity.Urgent);

                m_AlarmsListenerMessagesHandlerThread.SetFilterParameters(iEventType, iCameraNumber, iDvr);
            }
        }

        #endregion

        #region Via Pulse Proxy

        private bool SendReplyMessage(bool bSuccess, string sMessage)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            byte[] bytesMessage;

            try
            {
                bytesMessage = m_DvrHiveProxyThread.ReplyMessageData(bSuccess, sMessage);

                return m_DvrHiveProxyThread.SendReply(bytesMessage);
            }
            catch (Exception e)
            {
                Audit(e.Message,sMethod, AuditSeverity.Error);

                return false;
            }
        }        

        private void OpenErrorMessage(int iDisplay, int iNewDisplay)
        {
            string sMessage;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            sMessage = "Failed starting ";
            if (DisplayManager_DisplayActivation(iDisplay) == ActivationType.VideoOnDemand)
            {
                sMessage = sMessage + "PLAYBACK From ";
            }

            sMessage = sMessage + "Camera[" + DisplayManager_DisplayCameraNumber(iDisplay);
            sMessage = sMessage + "]/Site[" + DisplayManager_DisplaySiteName(iDisplay);
            sMessage = sMessage + "] On Display[" + iNewDisplay.ToString() + "]";

            Audit(sMessage, sMethod, AuditSeverity.Warning);
        }

        public void SetStartedCameraByClick(bool bStartCameraByClick)
        {
            m_bStartCameraByClick = bStartCameraByClick;
        }

        public bool GetStartedCameraByClick()
        {
            return m_bStartCameraByClick;
        }

        public void SetMonitorSuccess(bool bMonitorSuccess)
        {
            m_bMonitorSuccess = bMonitorSuccess;
        }

        public void SetStopMonitorSuccess(bool bStopMonitorSuccess)
        {
            m_bStopMonitorSuccess = bStopMonitorSuccess;
        }

        public bool GetMonitorSuccess()
        {
            return m_bMonitorSuccess;
        }

        public bool GetStopMonitorSuccess()
        {
            return m_bStopMonitorSuccess;
        }

        public bool GetPtzSuccess()
        {
            return m_bPtzSuccess;
        }

        public bool GetRangeError(out string sRangeError)
        {
            sRangeError = m_sRangeError;

            return m_bRangeError;
        }

        public bool GetVodSuccess()
        {
            return m_bVod;
        }

        public bool GetShowKeepaliveOnAudit()
        {
            return m_Settings.ShowKeepaliveOnAudit;
        }

        public bool GetShowProtocolRawData()
        {
            return m_Settings.ShowProtocolRawData;
        }

        public bool GetShowProtocolData()
        {
            return m_Settings.ShowProtocolData;
        }

        public ActivationMode GetActivationMode()
        {
            return m_Settings.Mode;
        }

        public DisplayFormatState GetDisplayFormatState()
        {
            return DisplayManager_GetMode();
        }

        public int GetIncrementedActiveDisplay()
        {
            int iActiveDisplay = DisplayManager_GetActiveDisplayIndex();
            int iHighestDisplayNumber = DisplayManager_FindHighestDisplayNumber();

            iActiveDisplay++;

            if (iActiveDisplay > iHighestDisplayNumber)
            {
                iActiveDisplay = 0;
            }

            return iActiveDisplay;
        }

        public int GetDecrementedActiveDisplay()
        {
            int iActiveDisplay = DisplayManager_GetActiveDisplayIndex();
            int iHighestDisplayNumber = DisplayManager_FindHighestDisplayNumber();

            iActiveDisplay--;

            if (iActiveDisplay == DvrClientConstants.NONE)
            {
                iActiveDisplay = iHighestDisplayNumber;
            }

            return iActiveDisplay;
        }

        public int GetModifiedActiveDisplay(Direction dDirection)
        {
            #region Data Members
            
            Point pPoint;
            DisplayFormatState dfs = DisplayManager_GetMode();

            bool bRc;

            string sResult;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            int iActiveDisplay = DisplayManager_GetActiveDisplayIndex();
            int iEdge = (int)dfs; 

            #endregion

            bRc = Utils.OneDim2TwoDim(iEdge, iActiveDisplay, out pPoint, out sResult);
            if (!bRc)
            {
                AuditPerform(sResult, sMethod, AuditSeverity.Warning);

                return DvrClientConstants.NONE;
            }

            switch (dDirection)
            {
                case Direction.Up:
                    if (pPoint.Y > 0)
                    {
                        pPoint.Y--;
                    }
                    break;

                case Direction.Down:
                    if (pPoint.Y <= (iEdge - 1))
                    {
                        pPoint.Y++;
                    }
                    break;

                case Direction.Left:
                    if (pPoint.X > 0)
                    {
                        pPoint.X--;
                    }
                    break;

                case Direction.Right:
                    if (pPoint.X <= (iEdge - 1))
                    {
                        pPoint.X++;
                    }
                    break;

                default:
                    AuditPerform("Wrong Direction[" + Utils.GetEnumDescription(dDirection) + "]", sMethod, AuditSeverity.Warning);
                    return DvrClientConstants.NONE;
            }

            bRc = Utils.TwoDim2OneDim(iEdge, pPoint, out iActiveDisplay, out sResult);
            if (!bRc)
            {
                AuditPerform(sResult, sMethod, AuditSeverity.Warning);

                return DvrClientConstants.NONE;
            }

            return iActiveDisplay;
        }

        public int GetActiveDisplay(out string sDvr, out int iCameraNumber, out ActivationType atActivationType)
        {
            try
            {
                int iDisplayIndex = DisplayManager_GetActiveDisplayIndex();
                iCameraNumber = DvrClientConstants.NONE;
                atActivationType = ActivationType.NotActive;

                sDvr = DisplayManager_DisplaySiteName(iDisplayIndex);
                iCameraNumber = DisplayManager_DisplayCameraNumber(iDisplayIndex);
                atActivationType = DisplayManager_DisplayActivation(iDisplayIndex);

                return iDisplayIndex;
            }
            catch (Exception)
            {
                sDvr = "";
                iCameraNumber = DvrClientConstants.NONE;
                atActivationType = ActivationType.NotActive;

                return DvrClientConstants.NONE;
            }
        }

        public int GetActiveDisplay(out int iDvrId, out int iCameraNumber, out ActivationType atActivationType)
        {
            int iDisplayIndex = DisplayManager_GetActiveDisplayIndex();
            iCameraNumber = DvrClientConstants.NONE;
            atActivationType = ActivationType.NotActive;

            iDvrId = DisplayManager_DisplayDvrId(iDisplayIndex);
            iCameraNumber = DisplayManager_DisplayCameraNumber(iDisplayIndex);
            atActivationType = DisplayManager_DisplayActivation(iDisplayIndex);

            return iDisplayIndex;
        }

        public int GetActiveDisplay(int iPresetIndex, 
                                    out string sDvr, 
                                    out int iCameraNumber, 
                                    out bool bIsPtz, 
                                    out string sPresetName)
        {
            //Array aPreset;
            int iDisplayIndex = DisplayManager_GetActiveDisplayIndex();

            iCameraNumber = DvrClientConstants.NONE;
            bIsPtz = false;
            sPresetName = "";

            sDvr = DisplayManager_DisplaySiteName(iDisplayIndex);
            iCameraNumber = DisplayManager_DisplayCameraNumber(iDisplayIndex);
            bIsPtz = DisplayManager_DisplayIsPtz(iDisplayIndex);
             
            //PCompStatus pcStatus = GetAllPresets(iDisplayIndex, out aPreset);
            //if ((pcStatus == PCompStatus.PCompStatus_Ok) && (aPreset != null))
            //{
            //    PComp_PresetInfo[] pcPreset = (PComp_PresetInfo[])aPreset;

            //    if (iPresetIndex < pcPreset.Length)
            //    {
            //        sPresetName = pcPreset[iPresetIndex].PresetName;
            //    }
            //}

            return iDisplayIndex;
        }

        //public int GetInstanceNumber()
        //{
        //    return m_InstanceNumber;
        //}

        public string ParseMultiRead(string sCommand, int iDvr)
        {
            #region Data Members
            
            int iNumberOfElements;
            int i;
            int j;
            int iTypeIndex;
            int iElementIndex;

            string sReadType;

            ReadTypeProperties rtp; 

            #endregion

            try
            {
                rtp = InitializeReadTypeProperties();

                iNumberOfElements = Utils.GetNumberOfOccurences(sCommand, ",") + 1;

                m_ReadTypes = new ReadTypes();

                m_ReadTypes.TheReadTypes = new Elements[(int)READ_TYPE.LAST_READ_TYPE];
                m_ReadTypes.NumberOfTypes = (int)READ_TYPE.LAST_READ_TYPE;
                m_ReadTypes.NumberOfRequests = 0;
                m_ReadTypes.NumberOfReplies = 0;
                m_ReadTypes.LengthInBytes = 0;
                m_ReadTypes.Dvr = iDvr;

                for (i = 0; i < (int)READ_TYPE.LAST_READ_TYPE; i++)
                {
                    m_ReadTypes.TheReadTypes[i] = new Elements();

                    m_ReadTypes.TheReadTypes[i].Element = new ReadTypeProperties[iNumberOfElements];
                    m_ReadTypes.TheReadTypes[i].NumberOfElements = 0;
                }

                for (i = 0; i < (int)READ_TYPE.LAST_READ_TYPE; i++)
                {
                    for (j = 0; j < iNumberOfElements; j++)
                    {
                        m_ReadTypes.TheReadTypes[i].Element[j] = new ReadTypeProperties();

                        m_ReadTypes.TheReadTypes[i].Element[j].InUse = false;
                    }
                }

                for (i = 1; i <= iNumberOfElements; i++)
                {
                    //  read the item
                    sReadType = Utils.GetNthSubString(sCommand, ",", i);

                    //  get the element's value
                    rtp = GetReadTypeProperties(iDvr, sReadType);

                    iTypeIndex = (int)rtp.Type;
                    iElementIndex = m_ReadTypes.TheReadTypes[iTypeIndex].NumberOfElements;

                    switch (rtp.Type)
                    {
                        case READ_TYPE.VL:
                        case READ_TYPE.VMD:
                        case READ_TYPE.DRY_CONTACT:
                        case READ_TYPE.IntrusionDetection:
                        case READ_TYPE.AlarmIn:
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].Name = rtp.Name;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].Channel = rtp.Channel;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].recorderID = iDvr;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].FarIndex = i;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].HasValue = false;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].Type = rtp.Type;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].ReturnedValue = rtp.ReturnedValue;

                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].InUse = true;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].ErrorCode = rtp.ErrorCode;

                            m_ReadTypes.TheReadTypes[iTypeIndex].NumberOfElements =
                                  m_ReadTypes.TheReadTypes[iTypeIndex].NumberOfElements + 1;

                            m_ReadTypes.NumberOfRequests = m_ReadTypes.NumberOfRequests + 1;
                            break;


                        case READ_TYPE.MONITOR:
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].Name = rtp.Name;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].Channel = rtp.Channel;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].recorderID = iDvr;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].FarIndex = i;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].HasValue = false;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].Type = rtp.Type;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].ReturnedValue = rtp.ReturnedValue;

                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].InUse = true;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].ErrorCode = rtp.ErrorCode;

                            m_ReadTypes.TheReadTypes[iTypeIndex].NumberOfElements =
                                  m_ReadTypes.TheReadTypes[iTypeIndex].NumberOfElements + 1;

                            m_ReadTypes.NumberOfRequests = m_ReadTypes.NumberOfRequests + 1;
                            break;


                        case READ_TYPE.KeepAlive:
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].Name = rtp.Name;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].Channel = rtp.Channel;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].recorderID = iDvr;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].FarIndex = i;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].HasValue = false;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].Type = rtp.Type;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].ReturnedValue = rtp.ReturnedValue;

                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].InUse = true;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].ErrorCode = rtp.ErrorCode;

                            m_ReadTypes.TheReadTypes[iTypeIndex].NumberOfElements =
                                  m_ReadTypes.TheReadTypes[iTypeIndex].NumberOfElements + 1;

                            m_ReadTypes.NumberOfRequests = m_ReadTypes.NumberOfRequests + 1;
                            break;


                        case READ_TYPE.ActiveDvrClient:
                        case READ_TYPE.ActiveDisplay:
                        case READ_TYPE.Layout:
                        case READ_TYPE.LoggerTime:
                        case READ_TYPE.DiskIoFailure:
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].Name = rtp.Name;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].recorderID = iDvr;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].FarIndex = i;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].HasValue = true;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].Type = rtp.Type;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].ReturnedValue = rtp.ReturnedValue;

                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].InUse = true;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].ErrorCode = rtp.ErrorCode;

                            m_ReadTypes.TheReadTypes[iTypeIndex].NumberOfElements =
                                  m_ReadTypes.TheReadTypes[iTypeIndex].NumberOfElements + 1;

                            m_ReadTypes.NumberOfRequests = m_ReadTypes.NumberOfRequests + 1;
                            break;


                        default:
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].Name = rtp.Name;

                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].FarIndex = i;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].HasValue = false;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].Type = rtp.Type;

                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].InUse = true;
                            m_ReadTypes.TheReadTypes[iTypeIndex].Element[iElementIndex].ErrorCode = rtp.ErrorCode;

                            m_ReadTypes.TheReadTypes[iTypeIndex].NumberOfElements =
                                  m_ReadTypes.TheReadTypes[iTypeIndex].NumberOfElements + 1;

                            m_ReadTypes.NumberOfRequests = m_ReadTypes.NumberOfRequests + 1;
                            break;
                    }
                }

                return rtp.ReturnedValue;
            }
            catch (Exception e)
            {
                return "";
            }
        }

        public ReadTypeProperties GetReadTypeProperties(int iDvr, string sReadTypeString)
        {
            #region Data Members

            object oValue;

            int iCameraNumber;
            int iDisplay;
            int iLeftBracket, iRightBracket;
            int iActionParameter;
            int iDvrIndex;
            int iColorNumber;
            int iOsdMask;

            string sAction;
            string sEventMessage;
            string sDvr;
            string sResult = "";
            string sMethod = MethodBase.GetCurrentMethod().Name;

            ReadTypeProperties rtp;

            NukeCommandReplay ncr;

            #endregion

            //  get rid of the event message in case of read command
            iLeftBracket = sReadTypeString.IndexOf("[");
            iRightBracket = sReadTypeString.IndexOf("]");

            if ((iLeftBracket == -1) || (iRightBracket == -1))
            {
                sEventMessage = "";
            }
            else
            {
                sEventMessage = sReadTypeString.Substring(iLeftBracket + 1, iRightBracket - iLeftBracket - 1);
                sReadTypeString = sReadTypeString.Substring(0, iLeftBracket);
            }

            sReadTypeString = sReadTypeString.ToUpper();

            rtp = new ReadTypeProperties();   

            rtp.Channel = DvrClientConstants.NONE;
            rtp.ErrorCode = ItemErrorCode.Ok;
            rtp.FarIndex = DvrClientConstants.NONE;
            rtp.HasValue = false;
            rtp.InUse = false;
            rtp.Name = "";
            rtp.recorderID = DvrClientConstants.NONE;
            rtp.ReturnedValue = "0.0";
            rtp.Type = READ_TYPE.Unknown;

            Utils.PeelCommand(sReadTypeString, out sAction, out iActionParameter);
            switch (sAction)
            {
                case DvrClientConstants.SIGNAL_LOSS_STRING:
                    #region Signal Loss
		
                    MakeChannelReadTypeProperties(sReadTypeString, READ_TYPE.VL, ref rtp);
                    try
                    {
                        if (m_Alarms4Dvr == null)
                        {
                            rtp.ReturnedValue = "N/A";
                        }

                        iDvrIndex = GetRealDvrIndex(iDvr);
                        if (m_Alarms4Dvr[iDvrIndex].VL == null)
                        {
                            rtp.ReturnedValue = "N/A";
                        }
                        
                        rtp.ReturnedValue = ((m_Alarms4Dvr[iDvrIndex].VL[rtp.Channel - 1]) ? "1.0" : "0.0");
                    }
                    catch (Exception e)
                    {
                        AuditPerform("Read Type[" + sAction + "]. " + e.Message, sMethod, AuditSeverity.Error);

                        rtp.ReturnedValue = "N/A";
                    } 
	
                    #endregion
                    break;

                case DvrClientConstants.ALARM_IN_STRING:
                    #region Alarm In
		
                    MakeChannelReadTypeProperties(sReadTypeString, READ_TYPE.AlarmIn, ref rtp);
                    try
                    {
                        iDvrIndex = GetRealDvrIndex(iDvr);
                        rtp.ReturnedValue = ((m_Alarms4Dvr[iDvrIndex].AlarmIn[rtp.Channel -1]) ? "1.0" : "0.0");
                    }
                    catch (Exception e)
                    {
                        Audit("Read Type[" + sAction + "]. " + e.Message, DvrClientModule.Main, sMethod, AuditSeverity.Error);

                        rtp.ReturnedValue = "N/A";
                    } 
	
                    #endregion
                    break;

                case DvrClientConstants.VMD_STRING:
                    #region Vmd
		
                    MakeChannelReadTypeProperties(sReadTypeString, READ_TYPE.VMD, ref rtp);
                    try
                    {
                        if (m_Alarms4Dvr == null)
                        {
                            rtp.ReturnedValue = "N/A";
                        }

                        iDvrIndex = GetRealDvrIndex(iDvr);
                        if (m_Alarms4Dvr[iDvrIndex].VMD == null)
                        {
                            rtp.ReturnedValue = "N/A";
                        }

                        rtp.ReturnedValue = ((m_Alarms4Dvr[iDvrIndex].VMD[rtp.Channel - 1]) ? "1.0" : "0.0");
                    }
                    catch (Exception e)
                    {
                        AuditPerform("Read Type[" + sAction + "]. " + e.Message, sMethod, AuditSeverity.Error);

                        rtp.ReturnedValue = "N/A";
                    } 
	
                    #endregion
                    break;

                case DvrClientConstants.INPUT_STRING:
                    #region Input Event

                    MakeChannelReadTypeProperties(sReadTypeString, READ_TYPE.VMD, ref rtp);
                    try
                    {
                        iDvrIndex = GetRealDvrIndex(iDvr);
                        rtp.ReturnedValue = m_Alarms4Dvr[iDvrIndex].Information[rtp.Channel - 1];
                        //rtp.ReturnedValue = (DvtelGetVideoMotionDetectionState(iDvr,
                        //                                                       rtp.Channel, 
                        //                                                       out sResult).ToUpper() == "TRUE") ? "1.0" : "0.0";

                        //if (!string.IsNullOrEmpty(sResult))
                        //{
                        //    Audit("Read Type[" + sAction + "]. " + sResult, DvrClientModule.Main, sMethod, AuditSeverity.Warning);
                        //}
                    }
                    catch (Exception e)
                    {
                        Audit("Read Type[" + sAction + "]. " + e.Message, DvrClientModule.Main, sMethod, AuditSeverity.Error);

                        rtp.ReturnedValue = "N/A";
                    }

                    #endregion
                    break;

                case DvrClientConstants.INTRUSION_DETECTION_STRING:
                    #region Intrusion Detection

                    MakeChannelReadTypeProperties(sReadTypeString, READ_TYPE.IntrusionDetection, ref rtp);
                    try
                    {
                        rtp.ReturnedValue = "N/A"; 

                        if (!string.IsNullOrEmpty(sResult))
                        {
                            Audit("Read Type[" + sAction + "]. " + sResult, DvrClientModule.Main, sMethod, AuditSeverity.Warning);
                        }
                    }
                    catch (Exception e)
                    {
                        Audit("Read Type[" + sAction + "]. " + e.Message, DvrClientModule.Main, sMethod, AuditSeverity.Error);

                        rtp.ReturnedValue = "N/A";
                    } 
	
                    #endregion
                    break;                

                case DvrClientConstants.TRIPWIRE_DETECTION_STRING:
                    #region TripwireDetection

                    MakeChannelReadTypeProperties(sReadTypeString, READ_TYPE.TripwireDetection, ref rtp);
                    try
                    {
                        rtp.ReturnedValue = "N/A";
                    }
                    catch (Exception)
                    {
                        rtp.ReturnedValue = "N/A";
                    } 
	
                    #endregion                    
                    break;

                case DvrClientConstants.FENCE_DETECTION_STRING:
                    #region FenceDetection

                    MakeChannelReadTypeProperties(sReadTypeString, READ_TYPE.FenceDetection, ref rtp);
                    try
                    {
                        rtp.ReturnedValue = "N/A"; //(DvtelGetFenceDetectionState(rtp.Channel).ToUpper() == "TRUE") ? "1.0" : "0.0";
                    }
                    catch (Exception)
                    {
                        rtp.ReturnedValue = "N/A";
                    } 
	
                    #endregion
                    break;

                case DvrClientConstants.STOPPED_VEHICLE_DETECTION_STRING:
                    #region StoppedVehicleDetection

                    MakeChannelReadTypeProperties(sReadTypeString, READ_TYPE.StoppedVehicleDetection, ref rtp);
                    try
                    {
                        rtp.ReturnedValue = "N/A";
                    }
                    catch (Exception)
                    {
                        rtp.ReturnedValue = "N/A";
                    } 
	
                    #endregion
                    break;

                case DvrClientConstants.UNATTENDED_OBJECT_DETECTION_STRING:
                    #region UnattendedObjectDetection

                    MakeChannelReadTypeProperties(sReadTypeString, READ_TYPE.UnattendedObjectDetection, ref rtp);
                    try
                    {
                        rtp.ReturnedValue = "N/A";
                    }
                    catch (Exception)
                    {
                        rtp.ReturnedValue = "N/A";
                    } 
	
                    #endregion
                    break;

                case DvrClientConstants.REMOVED_OBJECT_DETECTION_STRING:
                    #region RemovedObjectDetection

                    MakeChannelReadTypeProperties(sReadTypeString, READ_TYPE.RemovedObjectDetection, ref rtp);
                    try
                    {
                        rtp.ReturnedValue = "N/A";
                    }
                    catch (Exception)
                    {
                        rtp.ReturnedValue = "N/A";
                    } 
	
                    #endregion
                    break;

                case DvrClientConstants.CAMERA_SHIFT_DETECTION_STRING:
                    #region CameraShiftDetection

                    MakeChannelReadTypeProperties(sReadTypeString, READ_TYPE.CameraShiftDetection, ref rtp);
                    try
                    {
                        rtp.ReturnedValue = "N/A";// (DvtelGetCameraShiftDetectionState(rtp.Channel).ToUpper() == "TRUE") ? "1.0" : "0.0";
                    }
                    catch (Exception)
                    {
                        rtp.ReturnedValue = "N/A";
                    } 
	
                    #endregion
                    break;

                case DvrClientConstants.LOITERING_DETECTION_STRING:
                    #region Loitering
		
                    MakeChannelReadTypeProperties(sReadTypeString, READ_TYPE.LoiteringDetection, ref rtp);
                    try
                    {
                        rtp.ReturnedValue = "N/A"; //(DvtelGetLoitteringState(rtp.Channel).ToUpper() == "TRUE") ? "1.0" : "0.0";
                    }
                    catch (Exception)
                    {
                        rtp.ReturnedValue = "N/A";
                    } 
	
                    #endregion
                    break; 

                case DvrClientConstants.LOGGER_TIME:
                    rtp.ReturnedValue = GetLoggerTime(iDvr);
                    rtp.Name = sReadTypeString;
                    rtp.Type = READ_TYPE.LoggerTime;
                    rtp.ErrorCode = ItemErrorCode.Ok;
                    break;

                case DvrClientConstants.DISK_IO_FAILURE_STRING:
                    rtp.ReturnedValue = GetDiskIoFailureState(iDvr).ToString();
                    rtp.Name = sReadTypeString;
                    rtp.Type = READ_TYPE.DiskIoFailure;
                    rtp.ErrorCode = ItemErrorCode.Ok;
                    break;

                case DvrClientConstants.LAYOUT_STRING:
                    rtp.ReturnedValue = ((int)(DisplayManager_GetMode())).ToString();
                    rtp.Name = sReadTypeString;
                    rtp.Type = READ_TYPE.Layout;
                    rtp.ErrorCode = ItemErrorCode.Ok;
                    break;

                case DvrClientConstants.MONITOR_STRING:
                    #region Monitor

                    iColorNumber = DvrClientConstants.NONE;
                    iDisplay = DvrClientConstants.NONE;
                    iCameraNumber = DvrClientConstants.NONE;

                    ncr = Utils.NukeCommand(sReadTypeString,
                                            DvrClientConstants.MONITOR_STRING,
                                            ref iCameraNumber,
                                            ref iDisplay,
                                            ref iColorNumber);

                    switch (ncr)
                    {
                        case NukeCommandReplay.GotCameraNumber:
                        case NukeCommandReplay.GotCameraAndColorNumber:
                            iDisplay = DisplayManager_FindIndex(iDvr, iCameraNumber, ActivationType.LiveVideo);

                            rtp.ReturnedValue = (iDisplay == DvrClientConstants.NONE) ? "0.0" : "1.0";
                            rtp.ErrorCode = ItemErrorCode.Ok;
                            break;


                        case NukeCommandReplay.GotCameraAndDisplayNumber:
                        case NukeCommandReplay.GotCameraAndDisplayAndColorNumber:
                            iDisplay = DisplayManager_FindIndexByDisplay(iDvr,
                                                                         iCameraNumber, 
                                                                         iDisplay, 
                                                                         ActivationType.LiveVideo);

                            rtp.ReturnedValue = (iDisplay == DvrClientConstants.NONE) ? "0.0" : "1.0";
                            rtp.ErrorCode = ItemErrorCode.Ok;
                            break;


                        default:
                            rtp.ErrorCode = ItemErrorCode.SyntaxError;
                            rtp.ReturnedValue = "Syntax Error - " + NukeCommandReplayString(ncr);
                            break;
                    }

                    rtp.Name = sReadTypeString;
                    rtp.Type = READ_TYPE.MONITOR; 

                    #endregion
                    break;

                case DvrClientConstants.KEEP_ALIVE_STRING:
                    rtp.Name = sReadTypeString;
                    rtp.Type = READ_TYPE.KeepAlive;
                    rtp.ErrorCode = ItemErrorCode.Ok;
                    break;

                case DvrClientConstants.VOD_STRING:
                case DvrClientConstants.EXPORT_STRING:
                    rtp.Name = sReadTypeString;
                    rtp.Type = READ_TYPE.Unknown;
                    rtp.ErrorCode = ItemErrorCode.NotReadable;
                    break;

                case DvrClientConstants.SET_ACTIVE_DISPLAY_STRING:
                    rtp.Name = sReadTypeString;
                    rtp.Type = READ_TYPE.ActiveDisplay;
                    rtp.ReturnedValue = (DisplayManager_GetActiveDisplayIndex() + 1).ToString();
                    rtp.ErrorCode = ItemErrorCode.Ok;
                    break;

                case DvrClientConstants.SET_AS_ACTIVE_DVR_CLIENT_STRING:
                    rtp.Name = sReadTypeString;
                    rtp.Type = READ_TYPE.ActiveDvrClient;
                    rtp.ReturnedValue = (m_HiveStateStatus == HiveStateStatus.Waiting) ? "0.0" : "1.0";
                    rtp.ErrorCode = ItemErrorCode.Ok;
                    break;

                case DvrClientConstants.OSD_STRING:
                    #region Osd

                    iColorNumber = DvrClientConstants.NONE;
                    iDisplay = DvrClientConstants.NONE;
                    iCameraNumber = DvrClientConstants.NONE;

                    ncr = Utils.NukeCommand(sReadTypeString,
                                            DvrClientConstants.OSD_STRING,
                                            ref iCameraNumber,
                                            ref iDisplay,
                                            ref iColorNumber);

                    if (iCameraNumber == DvrClientConstants.NONE)
                    {
                        rtp.Name = sReadTypeString;
                        rtp.Type = READ_TYPE.Osd;
                        rtp.ErrorCode = ItemErrorCode.RangeError;

                        return rtp;
                    }

                    iDisplay = DisplayManager_FindIndex(iDvr, iCameraNumber, ActivationType.LiveVideo);

                    if (iDisplay == DvrClientConstants.NONE)
                    {
                        rtp.Name = sReadTypeString;
                        rtp.Type = READ_TYPE.Osd;
                        rtp.ErrorCode = ItemErrorCode.RangeError;

                        return rtp;
                    }

                    if (!vp[iDisplay].GetProperties(VideoPlayerProperty.Osd, out oValue, out sResult))
                    {
                        rtp.Name = sReadTypeString;
                        rtp.Type = READ_TYPE.Osd;
                        rtp.ErrorCode = ItemErrorCode.SyntaxError;

                        return rtp;
                    }

                    iOsdMask = (int)oValue;

                    rtp.Name = sReadTypeString;
                    rtp.Type = READ_TYPE.Osd;
                    rtp.ReturnedValue = iOsdMask.ToString();
                    rtp.ErrorCode = ItemErrorCode.Ok;

                    #endregion
                    break;

                case DvrClientConstants.IN_STRING:
                case DvrClientConstants.OUT_STRING:
                case DvrClientConstants.LEFT_STRING:
                case DvrClientConstants.RIGHT_STRING:
                case DvrClientConstants.UP_STRING:
                case DvrClientConstants.DOWN_STRING:
                case DvrClientConstants.UP_LEFT_STRING:
                case DvrClientConstants.UP_RIGHT_STRING:
                case DvrClientConstants.DOWN_RIGHT_STRING:
                case DvrClientConstants.DOWN_LEFT_STRING:
                case DvrClientConstants.API_STRING:
                case DvrClientConstants.ALARM_OUT_STRING:
                case DvrClientConstants.TALK_STRING:
                case DvrClientConstants.PRESET_STRING:
                case DvrClientConstants.PRE_DEFINED_VIEW_STRING:
                case DvrClientConstants.CLOSE_ALL_STRING:
                case DvrClientConstants.SAVE_STRING:
                case DvrClientConstants.RESTORE_STRING:
                case DvrClientConstants.SET_LAYOUT_STRING:                
                case DvrClientConstants.SET_FULLSCREEN_STRING:
                case DvrClientConstants.SNAPSHOT_STRING:
                case DvrClientConstants.ALARM_STRING:
                case DvrClientConstants.CLOSE_ALARM_STRING:
                case DvrClientConstants.SET_TEXT_STRING:
                case DvrClientConstants.VICON_START_MACRO_STRING:
                case DvrClientConstants.VICON_STOP_MACRO_STRING:
                case DvrClientConstants.NVD_STRING:
                    MakeNotReadableReadTypeProperties(sReadTypeString, ref rtp);
                    break;

                default:
                    rtp.Name = sReadTypeString;
                    rtp.Type = READ_TYPE.Unknown;
                    rtp.ErrorCode = ItemErrorCode.SyntaxError;
                    break;
            }

            return rtp;
        }        

        private string NukeCommandReplayString(NukeCommandReplay ncr)
        {
            string sReplay;

            switch (ncr)
            {
                case NukeCommandReplay.CameraNumberNotNumeric:
                    sReplay = "Camera Number Not Numeric";
                    break;

                case NukeCommandReplay.ColorNumberNotNumeric:
                    sReplay = "Color Number Not Numeric";
                    break;

                case NukeCommandReplay.CommandMissing:
                    sReplay = "Command Missing";
                    break;

                case NukeCommandReplay.DisplayNumberNotNumeric:
                    sReplay = "Display Number Not Numeric";
                    break;

                default:
                    sReplay = "Unknown";
                    break;
            }

            return sReplay;
        }

        private void MakeChannelReadTypeProperties(string sReadTypeString,
                                                   READ_TYPE rt,
                                                   ref ReadTypeProperties rtp)
        {
            int iCommandLength;
            int iLength = sReadTypeString.Length;

            switch (rt)
            {
                case READ_TYPE.AudioSquelch:
                    iCommandLength = DvrClientConstants.AUDIO_SQUELCH_STRING.Length;
                    break;

                case READ_TYPE.CrowdControl:
                    iCommandLength = DvrClientConstants.CROWD_CONTROL_STRING.Length;
                    break;

                case READ_TYPE.GenericCA:
                    iCommandLength = DvrClientConstants.GENERIC_CA_STRING.Length;
                    break;

                case READ_TYPE.IntruderDetection:
                    iCommandLength = DvrClientConstants.INTRUDER_DETECTION_STRING.Length;
                    break;

                case READ_TYPE.OverCrowding:
                    iCommandLength = DvrClientConstants.OVER_CROWDED_STRING.Length;
                    break;

                case READ_TYPE.TailGating:
                    iCommandLength = DvrClientConstants.TAIL_GATING_STRING.Length;
                    break;

                case READ_TYPE.TailGatingAPI:
                    iCommandLength = DvrClientConstants.TAIL_GATING_API_STRING.Length;
                    break;

                case READ_TYPE.UnattendedBaggage:
                    iCommandLength = DvrClientConstants.UNATTENDED_BAGGAGE_STRING.Length;
                    break;

                case READ_TYPE.UnauthorizedCar:
                    iCommandLength = DvrClientConstants.UNOTHORIZED_CAR_STRING.Length;
                    break;

                case READ_TYPE.DRY_CONTACT:
                    iCommandLength = DvrClientConstants.DRY_CONTACT_STRING.Length;
                    break;

                case READ_TYPE.VL:
                    iCommandLength = DvrClientConstants.SIGNAL_LOSS_STRING.Length;
                    break;

                case READ_TYPE.VMD:
                    iCommandLength = DvrClientConstants.VMD_STRING.Length;
                    break;

                case READ_TYPE.IntrusionDetection:
                    iCommandLength = DvrClientConstants.INTRUSION_DETECTION_STRING.Length;
                    break;

                case READ_TYPE.Export:
                    iCommandLength = DvrClientConstants.EXPORT_STRING.Length;
                    break;

                case READ_TYPE.WrongDirection:
                    iCommandLength = DvrClientConstants.WRONG_DIRECTION_STRING.Length;
                    break;

                default:
                    return;
            }

            string sValue = sReadTypeString.Substring(iCommandLength,
                                                      iLength - iCommandLength);
            if (Utils.IsNumeric(sValue))
            {
                rtp.Name = sReadTypeString;
                rtp.Channel = int.Parse(sValue);
                rtp.Type = rt;
                rtp.ErrorCode = ItemErrorCode.Ok;

                if ((rtp.Channel > DvrClientConstants.MAX_NUMBER_OF_CHANNELS) || (rtp.Channel < 1))
                {
                    rtp.Type = READ_TYPE.Unknown;
                    rtp.ErrorCode = ItemErrorCode.RangeError;
                }
            }
        }

        private void MakeNotReadableReadTypeProperties(string sReadTypeString, 
                                                       ref ReadTypeProperties rtp)
        {
            rtp.Name = sReadTypeString;
            rtp.Type = READ_TYPE.Unknown;
            rtp.ErrorCode = ItemErrorCode.NotReadable;
        }

        private ReadTypeProperties InitializeReadTypeProperties()
        {
            ReadTypeProperties rtp;

            rtp = new ReadTypeProperties();

            rtp.Channel = DvrClientConstants.NONE;
            rtp.ErrorCode = ItemErrorCode.Ok;
            rtp.FarIndex = DvrClientConstants.NONE;
            rtp.HasValue = false;
            rtp.InUse = false;
            rtp.Name = "";
            rtp.recorderID = DvrClientConstants.NONE;
            rtp.ReturnedValue = "0.0";
            rtp.Type = READ_TYPE.Unknown;

            return rtp;
        }

        #endregion

        #region Live Video

        public bool StartMonitoring(CameraInformation ciCameraInformation, int iDisplay)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            LiveVideoParameters liveVideoParameters;

            #endregion

            try
            {
                if (ciCameraInformation == null)
                {
                    Audit("Camera Information Is Null", sMethod, AuditSeverity.Warning);

                    return false;
                }

                if (iDisplay < 0)
                {
                    Audit("Bad Display Number[" + (iDisplay + 1) + "]",
                          sMethod,
                          AuditSeverity.Warning);

                    return false;
                }

                liveVideoParameters = new LiveVideoParameters();
                liveVideoParameters.Camera = ciCameraInformation;

                if (vp[iDisplay].Live(liveVideoParameters, out sResult))
                {
                    DisplayManager_SetDvrAction(iDisplay, DvrAction.StartLiveVideo);
                    DoEvents();

                    if (!DisplayNumberToCameraInTree(ActionToDo.Add,
                                                     ciCameraInformation.DvrId,
                                                     ciCameraInformation.CameraNumber,
                                                     iDisplay,
                                                     out sResult))
                    {
                        Audit(sResult, sMethod, AuditSeverity.Warning);
                    }

                    return true;
                }
                else
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);

                    return false;
                }
            }
            catch (Exception e)
            {
                Audit("Camera Number[" + /*iCameraNumber +*/ "] Display[" + (iDisplay + 1) + "]. " + e.Message, 
                      sMethod, 
                      AuditSeverity.Error);

                return false;
            }
        }

        public void StartCamera(CameraInformation ciCameraInformation,
                                int iColorNumber,
                                string sEventMessage,
                                bool bSingleAction)
        {
            #region Data Members

            bool bRc;
            bool bOpenedWithIndex;

            int iDisplay = DvrClientConstants.NONE;
            int iVeteranDisplayIndex = DvrClientConstants.NONE;

            string sDisplayDescription;
            string sPreset;
            string sCameraName = "Unknown";
            string sError;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            HistoryItem hi = null;

            #endregion

            try
            {
                if (ciCameraInformation == null)
                {
                    Audit("Camera Information Is Null", sMethod, AuditSeverity.Warning);

                    return;
                }

                if (DisplayManager_GetSelectedDisplayModeOn())
                {
                    SelectedDisplayOff();
                }

                iDisplay = DvrClientConstants.NONE;

                #region is the camera open?

                if (DisplayManager_IsCameraOpen(ciCameraInformation,
                                                out iDisplay,
                                                out bOpenedWithIndex))
                {
                    Audit("Camera Number[" + ciCameraInformation.CameraNumber +                          
                          "] Is Alredy Open On Display[" + (iDisplay + 1)+
                          "]. New Start Time Set.",
                          sMethod,
                          AuditSeverity.Information);

                    DateTime dtStartDateTime = DateTime.Now;
                    int iCameraPostTimeInSeconds = GetCameraPostTime();//((DvrClient)(m_PulseListenerThreadData.Main)).GetCameraPostTime();
                    dtStartDateTime = dtStartDateTime.AddSeconds(iCameraPostTimeInSeconds);
                    DisplayManager_SetStartDateTime(iDisplay, dtStartDateTime);

                    SetVideoPlayerFocus(iDisplay);
                    vp_Enter((object)(vp[iDisplay]), null);

                    m_bMonitorSuccess = false;
                    m_bRangeError = true;

                    return;
                }

                #endregion
                
                #region is there a free display on current mode?

                if (DisplayManager_IsFreeDisplayInCurrentMode())
                #region yes

                {
                    Audit("Display Mode Is[" + Utils.GetEnumDescription(DisplayManager_GetMode()) +
                          "]. There Is A Free Display.",
                          sMethod,
                          AuditSeverity.Information);

                    iDisplay = DisplayManager_FindFreeDisplay();

                    Audit("Display[" + (iDisplay + 1) +
                          "] Allocated For Camera Number[" + ciCameraInformation.CameraNumber +
                          "]",
                          sMethod,
                          AuditSeverity.Information);
                }

                #endregion
                else
                #region no

                {
                    #region are we in the highest mode?

                    if (IsHighestMode())
                    #region yes. override the most veteran display

                    {
                        DisplayManager_SetActiveDisplayIndex(DisplayManager_GetVeteran());
                        iVeteranDisplayIndex = DisplayManager_GetActiveDisplayIndex();
                        btnClose_Click(null, null);
                        iDisplay = iVeteranDisplayIndex;

                        Audit("Display Mode Is[" + Utils.GetEnumDescription(DisplayManager_GetMode()) +
                              "], The Highest Mode. There Is No Free Display. Overriding Display[" +
                              iDisplay.ToString() +
                              "]", 
                              sMethod,
                              AuditSeverity.Information);
                    }

                    #endregion
                    else
                    #region no. let's elevate mode

                    {
                        Audit("Display Mode Is[" + Utils.GetEnumDescription(DisplayManager_GetMode()) +
                              "] Has No Free Display. Switching To Mode[" + Utils.GetEnumDescription(DisplayManager_GetMode() + 1) +
                              "]",
                              sMethod,
                              AuditSeverity.Information);

                        ElevateDisplayMode();
                        iDisplay = DisplayManager_FindFreeDisplay();

                        Audit("Display[" + iDisplay.ToString() +
                              "] Allocated For Camera Number[" + ciCameraInformation.CameraNumber +
                              "]", 
                              sMethod,
                              AuditSeverity.Information);
                    }

                    #endregion

                    #endregion
                }

                #endregion

                #endregion

                bRc = DoStartCamera(ciCameraInformation, iDisplay);
                if (bRc)
                #region start camera succeeded

                {
                    string sSingleAction = (bSingleAction) ? "Single Action" : "";

                    Audit("Starting Live Video On Camera Number [" + /*iCameraNumber +*/
                          "] On Display [" + (iDisplay + 1) + "]. " +
                          sSingleAction + ".", 
                          sMethod,
                          AuditSeverity.Information);

                    m_bMonitorSuccess = true;                    

                    DisplayManager_SetSingleDisplay(iDisplay,
                                                    ciCameraInformation,
                                                    iColorNumber,
                                                    iDisplay,
                                                    false,
                                                    false,
                                                    DateTime.Now,
                                                    ActivationType.LiveVideo,
                                                    sEventMessage);

                    if (!m_bInHistory)
                    {
                        AddHistoryItem(hi); 
                    }

                    lblActiveDisplays.Text = "Displays " + DisplayManager_IncrementActiveDisplaysCounter();
                    Audit("Opened LIVE VIDEO On Camera Number[" + ciCameraInformation.CameraNumber + 
                          "]. " + DisplayManager_ActiveDisplays() + " Active Displays", 
                          sMethod,
                          AuditSeverity.Information);

                    sDisplayDescription = "Camera Number: (" + ciCameraInformation.CameraNumber + ") " + sCameraName;

                    sPreset = DisplayManager_DisplayPreset(iDisplay);

                    if (!string.IsNullOrEmpty(sPreset))
                    {
                        lblCurrentPreset.Text = sPreset;
                    }
                    DisplayDescription(sDisplayDescription);

                    DisplayManager_SetVeteran();

                    if (bSingleAction)
                    {
                        SetActiveDisplay(iDisplay.ToString(), sMethod);
                        PictureVisible(iDisplay, false);
                        CustomizeDisplays(sMethod);
                        NoVideoPictureOnEmptyDisplays();
                    }

                    //CameraNodeDisplay(sSiteName, iCameraNumber, Action.Add, iDisplay + 1, sMethod);
                } 

                #endregion
                else
                #region start camera failed

                {
                    string sMessage = "DoStartCamera Failed On Display[" + (iDisplay + 1) +
                                      "] for Camera Number[" + ciCameraInformation.CameraNumber + "]";
                    Audit(sMessage, sMethod, AuditSeverity.Warning);

                    Utils.Error(sMessage);

                    m_bMonitorSuccess = false;
                    m_bRangeError = true;
                }

                #endregion
            }
            catch (Exception e)
            {
                m_bMonitorSuccess = false;
                m_bRangeError = true;
                Audit("Failed To Start Camera Number[" + ciCameraInformation.CameraNumber +
                      "]." + e.Message, 
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        public void StartCamera_X_on_Display_Y(CameraInformation ciCameraInformation,
                                               int iRealDisplay,
                                               int iColorNumber,
                                               string sEventMessage,            
                                               bool bSingleAction)
        {
            #region Data Members
                        
            bool bRc = false;
            bool bOpenedWithIndex = false;
            bool bIsCameraOpen = false;            

            int iExistingDisplay = DvrClientConstants.NONE;
            int iDisplay;

            string sDisplayDescription;
            string sPreset;
            string sCameraName = "Unknown";
            string sError;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            DisplayFormatState dfs;

            HistoryItem hi = null;

            #endregion

            try
            {
                if (ciCameraInformation == null)
                {
                    Audit("Camera Information Is Null", sMethod, AuditSeverity.Warning);

                    return;
                }

                if ((iRealDisplay < 1) || (iRealDisplay > DisplayManager_Displays()))
                {
                    Audit("Display Number[" + iRealDisplay + 
                          "] Not Between 1 And " + DisplayManager_Displays(), 
                          sMethod, 
                          AuditSeverity.Warning);

                    return;
                }

                Audit("Start Camera Number[" + ciCameraInformation.CameraNumber +
                      "]",
                      sMethod,
                      AuditSeverity.Information);

                iDisplay = iRealDisplay - 1;

                #region Is the requested camera already open in requested display?

                bIsCameraOpen = DisplayManager_IsCameraOpen(ciCameraInformation,
                                                            out iExistingDisplay,
                                                            out bOpenedWithIndex);
                if (iExistingDisplay == iDisplay)
                {
                    Audit("Camera Number[" + ciCameraInformation.CameraNumber +
                          "] Is Already Open On Display[" + iRealDisplay.ToString() +
                          "]",
                          sMethod,
                          AuditSeverity.Information);

                    SetVideoPlayerFocus(iExistingDisplay);
                    vp_Enter((object)(vp[iExistingDisplay]), null);

                    return;
                }

                #endregion

                #region Does the requested display fit in current layout?

                if (FitsInLayoutMode(iRealDisplay))
                #region yes

                {
                    Audit("Real Display[" + iRealDisplay.ToString() +
                          "] Fits Into Display Mode[" + Utils.GetEnumDescription(DisplayManager_GetMode()) +
                          "]",
                          sMethod, 
                          AuditSeverity.Information);

                    //  Is the requested display in use?
                    if (DisplayManager_DisplayIsFree(iDisplay))
                    {
                        Audit("Display[" + iRealDisplay.ToString() + "] Is Free", sMethod, AuditSeverity.Information);
                    }
                    else
                    {
                        //  The requested display in use. 
                        //  Close the camera in the requestd display    
                        Audit("Display[" + iRealDisplay.ToString() +
                              "] Is Not Free. Closing Camera In The Display.", 
                              sMethod, 
                              AuditSeverity.Information);

                        DoStopDisplay(iDisplay);
                    }
                } 

                #endregion
                else
                #region no

                {
                    //  get fitting layout for requested display
                    dfs = DisplayManager_BestFitLayoutMode(iRealDisplay);

                    if (dfs == DisplayFormatState.Unknown)
                    {
                        Audit("Display[" + iRealDisplay.ToString() +
                              "] Can Not Be Activated. Unknown Layout.",
                              sMethod, 
                              AuditSeverity.Warning);

                        return;
                    }

                    if ((int)dfs > (int)Math.Sqrt(m_DisplayInfo.Displays))
                    {
                        Audit("Display[" + iRealDisplay.ToString() +
                              "] Can Not Be Activated. Requested Layout Mode [" + dfs.ToString() +
                              "] Too High.",
                              sMethod, 
                              AuditSeverity.Warning);

                        return;
                    }

                    Audit("Display[" + iRealDisplay.ToString() +
                          "] Does Not Fit Into Display Mode[" + Utils.GetEnumDescription(DisplayManager_GetMode()) +
                          "]. Mode Will Change To Mode[" + dfs.ToString() + "]",
                          sMethod,
                          AuditSeverity.Information);

                    ChangeDisplayMode(dfs);
                } 

                #endregion

                #endregion

                #region is the camera already open?

                if (bIsCameraOpen)
                {
                    Audit("Closing Camera Number[" + ciCameraInformation.CameraNumber +
                          "] On Display[" + iRealDisplay.ToString() + "]",
                          sMethod,
                          AuditSeverity.Information);

                    DoStopDisplay(iExistingDisplay);
                } 

                #endregion

                bRc = DoStartCamera(ciCameraInformation, iDisplay);
                if (bRc)
                #region start camera succeeded

                {
                    Audit("Starting Live Video On Camera Number[" + ciCameraInformation.CameraNumber +
                          "] on Display [" + iRealDisplay.ToString() + "]",
                          sMethod,
                          AuditSeverity.Information);

                    m_bMonitorSuccess = true;

                    DisplayManager_SetSingleDisplay(iDisplay,
                                                    ciCameraInformation,                                                    
                                                    iColorNumber,                                                    
                                                    iDisplay,
                                                    false,
                                                    true,
                                                    DateTime.Now,
                                                    ActivationType.LiveVideo,
                                                    sEventMessage);

                    if (!m_bInHistory)
                    {
                        AddHistoryItem(hi); 
                    }

                    lblActiveDisplays.Text = "Displays " + DisplayManager_IncrementActiveDisplaysCounter();
                    Audit("Opened LIVE VIDEO On Camera Number[" + ciCameraInformation.CameraNumber +
                          "]. " + DisplayManager_ActiveDisplays() + " Active Displays", 
                          sMethod,
                          AuditSeverity.Information);

                    sDisplayDescription = "  Camera: () ";

                    sPreset = DisplayManager_DisplayPreset(iDisplay);

                    if (!string.IsNullOrEmpty(sPreset))
                    {
                        lblCurrentPreset.Text = sPreset;
                    }
                    DisplayDescription(sDisplayDescription);

                    DisplayManager_SetVeteran();

                    if (bSingleAction)
                    {
                        SetActiveDisplay(iDisplay.ToString(), sMethod);
                        CustomizeDisplays(sMethod);

                        if (!DisplayManager_GetSelectedDisplayModeOn())
                        {
                            NoVideoPictureOnEmptyDisplays();
                        }
                    }

                    //CameraNodeDisplay(sSiteName, iCameraNumber, Action.Add, iDisplay + 1, sMethod);
                } 

                #endregion
                else
                #region start camera failed

                {
                    if (iDisplay != DvrClientConstants.NONE)
                    {
                        Audit("DoStartCamera Failed On Display[" + iDisplay.ToString() +
                              "] For Camera Number[" + ciCameraInformation.CameraNumber + "]",
                              sMethod,
                              AuditSeverity.Warning);

                        m_bMonitorSuccess = false;
                        m_bRangeError = true;
                    }
                } 

                #endregion
            }

            catch (Exception e)
            {
                m_bMonitorSuccess = false;
                m_bRangeError = true;
                Audit("Failed To Start Camera Number[" + ciCameraInformation.CameraNumber +
                      "] On Display [" + iRealDisplay.ToString() + "]." + e.Message, 
                      sMethod,
                      AuditSeverity.Warning);
            }
        }

        public bool StartPtzCameraWithPreset(int iDvrId,
                                             int iCameraNumber,
                                             int iColorNumber,
                                             string sPresetName,
                                             string sEventMessage,
                                             bool bSingleAction)
        {
            #region Data Members
            
            int iDisplayIndex;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sWith; 
            string sResult;

            bool bPresetExists;

            CameraInformation ciCameraInformation;

            #endregion

            try
            {
                sWith = "With";

                if (IsPtzCamera(iDvrId, iCameraNumber) == false)
                {
                    Audit("Camera[" + iCameraNumber +
                          "] On DVR[" + iDvrId +
                          "] Is Not A PTZ Camera",
                          sMethod,
                          AuditSeverity.Warning);
                    
                    //  Just Open Without Prest
                    sWith = "Without";
                    bPresetExists = false;
                }
                else
                {
                    bPresetExists = !PresetNameFree(sPresetName, iDvrId, iCameraNumber, out sResult);

                    if (!bPresetExists)
                    {
                        sWith = "Without";
                        Audit("Preset[" + sPresetName +
                              "] Does Not Exist For Camera[" + iCameraNumber +
                              "] On Dvr[" + iDvrId +
                              "] And 'OnMissingPresetOpenCamera' Is Off",
                              sMethod,
                              AuditSeverity.Warning);
                    }

                    if ((!m_Settings.OnMissingPresetOpenCamera) && (!bPresetExists))
                    {
                        return false;
                    }
                }

                Audit("Statring Camera[" + iCameraNumber +
                      "] On DVR[" + iDvrId +
                      "] " + sWith + " Preset[" + sPresetName + "]",
                      sMethod,
                      AuditSeverity.Information);

                ciCameraInformation = GetCameraInformation(iDvrId, iCameraNumber);
                if (ciCameraInformation == null)
                {
                    Audit("Camera[" + iCameraNumber +
                          "] On DVR[" + iDvrId +
                          "] Does Not Exist",
                          sMethod,
                          AuditSeverity.Warning);

                    return false;
                }

                StartCamera(ciCameraInformation, 
                            iColorNumber, 
                            sEventMessage, 
                            bSingleAction);
                iDisplayIndex = DisplayManager_FindIndex(iDvrId,
                                                         iCameraNumber,
                                                         ActivationType.LiveVideo);
                Audit("Camera[" + iCameraNumber +
                      "] On DVR[" + iDvrId +
                      "] Opened On Display[" + (iDisplayIndex + 1) + "]",
                      sMethod,
                      AuditSeverity.Information);

                if (bPresetExists)
                {
                    Audit("Activating Preset[" + sPresetName + "]",
                                  sMethod,
                                  AuditSeverity.Information);

                    ActivateDvrPreset(iDisplayIndex, sPresetName, sEventMessage); 
                }

                return true;
            }
            catch (Exception)
            {
                Audit("Unknown Failure", sMethod, AuditSeverity.Warning);

                return false;
            }
        }

        public bool StartPtzCameraOnDisplayWithPreset(int iDvrId,
                                                      int iCameraNumber,
                                                      int iDisplay,
                                                      int iColorNumber,
                                                      string sPresetName,
                                                      string sEventMessage,
                                                      bool bSingleAction)
        {
            #region Data Members

            int iDisplayIndex;
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sWith;
            string sResult;

            bool bPresetExists;

            CameraInformation ciCameraInformation;

            #endregion

            try
            {
                sWith = "With";

                if (IsPtzCamera(iDvrId, iCameraNumber) == false)
                {
                    Audit("Camera[" + iCameraNumber +
                          "] On DVR[" + iDvrId +
                          "] Is Not A PTZ Camera",
                          sMethod,
                          AuditSeverity.Warning);

                    //  Just Open Without Prest
                    sWith = "Without";
                    bPresetExists = false;
                }
                else
                {
                    bPresetExists = !PresetNameFree(sPresetName, iDvrId, iCameraNumber, out sResult);

                    if (!bPresetExists)
                    {
                        sWith = "Without";
                        Audit("Preset[" + sPresetName +
                              "] Does Not Exist For Camera[" + iCameraNumber +
                              "] On Dvr[" + iDvrId +
                              "] And 'OnMissingPresetOpenCamera' Is Off",
                              sMethod,
                              AuditSeverity.Warning);
                    }

                    if ((!m_Settings.OnMissingPresetOpenCamera) && (!bPresetExists))
                    {
                        return false;
                    }
                }

                Audit("Statring Camera[" + iCameraNumber +
                      "] On DVR[" + iDvrId +    
                      "] On Display[" + iDisplay + 
                      "] " + sWith + " Preset[" + sPresetName + "]",
                      sMethod,
                      AuditSeverity.Information);

                ciCameraInformation = GetCameraInformation(iDvrId, iCameraNumber);
                if (ciCameraInformation == null)
                {
                    Audit("Camera[" + iCameraNumber +
                          "] On DVR[" + iDvrId +
                          "] Does Not Exist",
                          sMethod,
                          AuditSeverity.Warning);

                    return false;
                }

                StartCamera_X_on_Display_Y(ciCameraInformation,
                                           iDisplay,
                                           iColorNumber,
                                           sEventMessage,
                                           bSingleAction);
                iDisplayIndex = DisplayManager_FindIndex(iDvrId,
                                                         iCameraNumber,
                                                         ActivationType.LiveVideo);
                Audit("Camera[" + iCameraNumber +
                      "] On DVR[" + iDvrId +    
                      "] Opened On Display[" + (iDisplayIndex + 1) + "]",
                      sMethod,
                      AuditSeverity.Information);

                if (bPresetExists)
                {
                    Audit("Activating Preset[" + sPresetName + "]",
                      sMethod,
                      AuditSeverity.Information);

                    ActivateDvrPreset(iDisplayIndex, sPresetName, sEventMessage);
                }

                return true;
            }
            catch (Exception)
            {
                Audit("Unknown Failure", sMethod, AuditSeverity.Warning);

                return false;
            }
        }

        public bool DoStartCamera(CameraInformation ciCameraInformation, int iDisplay)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (ciCameraInformation == null)
            {
                Audit("Camera Information Is Null", sMethod, AuditSeverity.Warning);

                return false;
            }

            bool bRc = StartMonitoring(ciCameraInformation, iDisplay);

            if (!bRc)
            {
                Audit("Failed Starting LIVE VIDEO On Camera Number[" + /*iCameraNumber +*/ "].", 
                      sMethod,
                      AuditSeverity.Warning);

                return false;
            }

            if (m_Settings.OnTop)
            {
                if (!m_bStartCameraByClick)
                {
                    Audit("On Top Activated", sMethod, AuditSeverity.Information);

                    ActivateOnTop(true);

                    tmrOnTop.Interval = m_Settings.OnTopTime * DvrClientConstants.SECONDS;
                    tmrOnTop.Enabled = true;

                    m_bStartCameraByClick = false;
                }
            }            

            return bRc;
        }

        #endregion

        #region Osd

        private bool Osd(int iDvrId, int iCameraNumber, int iValue)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;
            string sOnScreenDisplayParametersListString;
            int iDisplayIndex;

            List<OnScreenDisplayParameters> losdParameter;

            #endregion

            try
            {
                iDisplayIndex = DisplayManager_FindDisplayByCamera(iDvrId, iCameraNumber);
                if (iDisplayIndex == DvrClientConstants.NONE)
                {
                    Audit("Camera[" + iCameraNumber + "] On Dvr[" + iDvrId + "] Not Found.", sMethod, AuditSeverity.Warning);

                    return false;
                }

                losdParameter = PrepareOnScreenDisplayParametersList(iValue, out sResult);
                if (losdParameter == null)
                {
                    Audit("Can't Prepare List of Parameters For Camera[" + iCameraNumber + "] On Dvr[" + iDvrId + "]. " + sResult, 
                          sMethod, 
                          AuditSeverity.Warning);

                    return false;
                }

                sOnScreenDisplayParametersListString = OnScreenDisplayParametersListString(losdParameter);

                if (!vp[iDisplayIndex].Osd(losdParameter, out sResult))
                {
                    Audit("Failed OSD For Camera[" + iCameraNumber + 
                          "] On Dvr[" + iDvrId + 
                          "] Options[" + sOnScreenDisplayParametersListString + 
                          "]. " + sResult, 
                          sMethod, 
                          AuditSeverity.Warning);

                    return false;
                }

                Audit("OSD For Camera[" + iCameraNumber +
                      "] On Dvr[" + iDvrId +
                      "] Options[" + sOnScreenDisplayParametersListString +
                      "]",
                      sMethod,
                      AuditSeverity.Information);

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private List<OnScreenDisplayParameters> PrepareOnScreenDisplayParametersList(int iOnScreenDisplayParametersValues, out string sResult)
        {
            #region Data Members

            int iMask = 0x00000001;
            int iResult;

            OnScreenDisplayParameters currentOnScreenDisplayParameters;

            List<OnScreenDisplayParameters> losdParameter;

            #endregion

            sResult = "";

            try
            {
                losdParameter = new List<OnScreenDisplayParameters>();

                for (int i = 0; i < (sizeof(int) * 8); i++)
                {
                    iResult = iMask & iOnScreenDisplayParametersValues;
                    if (iResult != 0)
                    {
                        currentOnScreenDisplayParameters = new OnScreenDisplayParameters((OnScreenDisplayOption)iMask, true);

                        losdParameter.Add(currentOnScreenDisplayParameters);
                    }

                    iMask <<= 1;
                }

                return losdParameter;
            }
            catch (Exception e)
            {

                sResult = e.Message;

                return null;
            }
        }

        private string OnScreenDisplayParametersListString(List<OnScreenDisplayParameters> losdParameter)
        {
            string sResult = "";

            try
            {
                if (losdParameter != null)
                {
                    sResult = "[";

                    for (int i = 0; i < losdParameter.Count; i++)
                    {
                        sResult += "(" + losdParameter[i].Option.ToString() + "=true)"; 
                    }

                    sResult += "]";
                }

                return sResult;
            }
            catch (Exception)
            {
                return "";
            }
        }

        #endregion

        #region Close Functions

        public bool DoStopCamera(int iDisplay)
        {
            #region Data Members

            object oIsPtz;

            bool bIsPtz;

            string sResult;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            HistoryItem hi = null;

            CameraInformation ciCameraInformation;

            #endregion

            try
            {
                m_bStopMonitorSuccess = false;

                if (DisplayManager_DisplayIsFree(iDisplay))
                {
                    AuditPerform("No Active Camera On Display [" + iDisplay.ToString() + "]", sMethod, AuditSeverity.Warning);

                    return false;
                }

                #region prepare history

                if (!m_bInHistory)
                {
                    hi = new HistoryItem(HistoryItemType.CloseAll,
                                         Utils.GetEnumDescription(HistoryItemType.CloseAll),
                                         DisplayManager_GetMode());

                    for (int i = 0; i < DisplayManager_Displays(); i++)
                    {
                        if (!DisplayManager_DisplayIsFree(i))
                        {
                            hi.AddCamera(DisplayManager_DisplayVendorName(i),
                                         DisplayManager_DisplaySiteName(i),
                                         DisplayManager_DisplayCameraNumber(i),
                                         DisplayManager_DisplayNumber(i) + 1,
                                         DisplayManager_DisplayActivation(i),
                                         DisplayManager_DisplayPlaybackStart(i),
                                         DisplayManager_DisplayPlaybackDuration(i),
                                         DisplayManager_DisplayPreset(i));
                        }
                    }
                }

                #endregion

                switch (DisplayManager_DisplayActivation(iDisplay))
                {
                    case ActivationType.LiveVideo:
                        DisplayManager_SetDvrAction(iDisplay, DvrAction.StopLiveVideo);
                        AuditPerform("Stopping LIVE VIDEO From Camera[" +
                                      DisplayManager_DisplayCameraNumber(iDisplay) +
                                      "] On Display[" +
                                      (iDisplay + 1) +
                                      "]", 
                                      sMethod,
                                      AuditSeverity.Information);
                        break;


                    case ActivationType.VideoOnDemand:
                        DisplayManager_SetDvrAction(iDisplay, DvrAction.StopPlayback);
                        AuditPerform("Stopping PLAYBACK From On Camera[" +
                                     DisplayManager_DisplayCameraNumber(iDisplay) +
                                     "] On Display[" +
                                     (iDisplay + 1) +
                                     "]", 
                                     sMethod,
                                     AuditSeverity.Information);

                        if (m_VmdEventArrow != null)
                        {
                            for (int i = 0; i < m_VmdEventArrow.Length; i++)
                            {
                                gbSmallPlayback.Controls.Remove(m_VmdEventArrow[i]);
                            }   
                        }                      
                        break;


                    default:
                        AuditPerform("Trying To Stop Camera[" +
                                     DisplayManager_DisplayCameraNumber(iDisplay) +
                                     "] On Display[" +
                                     (iDisplay + 1) +
                                     "] With No Activation",
                                     sMethod, 
                                     AuditSeverity.Warning);
                        return false;
                }


                ciCameraInformation = DisplayManager_GetCamera(iDisplay);

                if (vp[iDisplay].Close(out sResult))
                {


                    if (!DisplayNumberToCameraInTree(ActionToDo.Remove, 
                                                     ciCameraInformation.DvrId, 
                                                     ciCameraInformation.CameraNumber, 
                                                     DvrClientConstants.NONE, 
                                                     out sResult))
                    {
                        AuditPerform(sResult, sMethod, AuditSeverity.Warning);
                    }

                    AuditPerform("Closed Camera[" + ciCameraInformation.CameraNumber +
                                 "] On Dvr ID[" + ciCameraInformation.DvrId + "]",
                                 sMethod,
                                 AuditSeverity.Information);
                }
                else
                {
                    AuditPerform("Failed Closing Camera[" + ciCameraInformation.CameraNumber + 
                                 "] On Dvr ID[" + ciCameraInformation.DvrId + "]", 
                                 sMethod, 
                                 AuditSeverity.Warning);
                }

                m_bStopMonitorSuccess = true;

                lblActiveDisplays.Text = "Displays " + DisplayManager_DecrementActiveDisplaysCounter();
                AuditPerform("Cleared Display(" + (iDisplay + 1) + "). " +
                             DisplayManager_ActiveDisplays() + " Active Displays.", 
                             sMethod,
                             AuditSeverity.Information);

                if (DisplayManager_DisplayActivation(iDisplay) == ActivationType.VideoOnDemand)
                {
                    gbSmallPlayback.Visible = false;
                }

                //   reset display entry on displays array
                DisplayManager_ResetSingleDisplay(iDisplay);
                DisplayManager_SetVeteran();

                //   GUI stuff
                HideSurroundingFrame(iDisplay, sMethod);
                CloseButtonVisible(false);
                btnDigitalZoom.Visible = false;

                vp[iDisplay].GetProperties(VideoPlayerProperty.IsPtz, out oIsPtz, out sResult);
                bIsPtz = (bool)oIsPtz;

                if (bIsPtz)
                {
                    GroupBoxVisibility(gbPresets, false);
                    GroupBoxVisibility(gbCurrentPreset, false);
                }
                DisplayDescription("");
                EventMessage("");
                PtzGUI(false);
                DisplayManager_SetActiveDisplayIndex(DvrClientConstants.NONE);
                timerUpdateTrackBar.Enabled = false;

                #region Selected Display Mode On

                if (DisplayManager_GetSelectedDisplayModeOn())
                {
                    SelectedDisplayOff();
                }

                #endregion

                return true;
            }

            catch (Exception e)
            {
                AuditPerform("Failed Stopping Camera[" +
                             DisplayManager_DisplayCameraNumber(iDisplay) +
                             "] On Display[" +
                             iDisplay.ToString() +
                             "]." +
                             e.Message, 
                             sMethod,
                             AuditSeverity.Error);

                return false;
            }
        }

        public bool DoStopDisplay(int iDisplay)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            HistoryItem hi = null; 

            #endregion 

            try
            {
                m_bStopMonitorSuccess = false;

                if (iDisplay == DvrClientConstants.NONE)
                {
                    Audit("Trying To Stop A Non Existing Camera", sMethod, AuditSeverity.Information);

                    return false;
                }

                if (DisplayManager_DisplayIsFree(iDisplay))
                {
                    Audit("No Active Camera On Display [" + iDisplay.ToString() + "]", 
                          sMethod,
                          AuditSeverity.Information);

                    return false;
                }

                #region prepare history

                if (!m_bInHistory)
                {
                    hi = new HistoryItem(HistoryItemType.CloseAll,
                                         Utils.GetEnumDescription(HistoryItemType.CloseAll),
                                         DisplayManager_GetMode());

                    for (int i = 0; i < DisplayManager_Displays(); i++)
                    {
                        if (!DisplayManager_DisplayIsFree(i))
                        {
                            hi.AddCamera(DisplayManager_DisplayVendorName(i),
                                         DisplayManager_DisplaySiteName(i),
                                         DisplayManager_DisplayCameraNumber(i),
                                         DisplayManager_DisplayNumber(i) + 1,
                                         DisplayManager_DisplayActivation(i),
                                         DisplayManager_DisplayPlaybackStart(i),
                                         DisplayManager_DisplayPlaybackDuration(i),
                                         DisplayManager_DisplayPreset(i));
                        }
                    }
                }

                #endregion

                Audit("Stopping Live Video On Site[" +
                      DisplayManager_DisplaySiteName(iDisplay) +
                      "]/Camera[" +
                      DisplayManager_DisplayCameraNumber(iDisplay) +
                      "] On Display[" + iDisplay.ToString() + "]",
                      sMethod, 
                      AuditSeverity.Information);

                DisplayManager_SetDvrAction(iDisplay, DvrAction.StopLiveVideo);

                vp[iDisplay].Close(out sResult);

                //if (ReturnedStatus == PCompStatus.PCompStatus_Ok)
                //{
                //    ((ILocalLOSManagement)(m_PlayerManager)).Recalculate();
                //    m_bStopMonitorSuccess = true;

                //    if (DisplayManager_DisplayActivation(iDisplay) == ActivationType.LiveVideo)
                //    {
                //        CameraNodeDisplay(DisplayManager_DisplaySiteName(iDisplay),
                //                          DisplayManager_DisplayCameraNumber(iDisplay),
                //                          Action.Remove,
                //                          DvrClientConstants.NONE, 
                //                          sMethod);
                //    }

                if (DisplayManager_DisplayIsPtz(iDisplay))
                {
                    gbPresets.Visible = false;
                    gbCurrentPreset.Visible = false;
                }
                DisplayManager_ResetSingleDisplay(iDisplay);
                DisplayManager_SetVeteran();
                lblActiveDisplays.Text = "Displays " + DisplayManager_DecrementActiveDisplaysCounter();
                Audit(DisplayManager_ActiveDisplays() + " Active Displays.", sMethod, AuditSeverity.Information);

                //    //   GUI stuff
                HideSurroundingFrame(iDisplay, sMethod);
                CloseButtonVisible(false);
                btnDigitalZoom.Visible = false;
                DisplayDescription("");
                EventMessage("");
                PtzGUI(false);                    

                //    if (!m_bInHistory)
                //    {
                //        AddHistoryItem(hi);
                //    }

                //    return true;
                //}
                //else
                //{
                //    Audit("Failed to stop monitoring Display[" +
                //          iDisplay.ToString() +
                //          "]. Error - " +
                //          ReturnedStatus.ToString(), 
                //          sMethod,
                //          AuditSeverity.Warning);

                //    //m_Problematic2StopDisplayIndex = iDisplay;

                //    //tmrProblematic2Stop.Interval = DvrClientConstants.SECONDS;
                //    //tmrProblematic2Stop.Enabled = true;
                //}

                return true;
            }
            catch (Exception e)
            {
                Audit("Failed stopping live video on Site[" +
                      DisplayManager_DisplaySiteName(iDisplay) +
                      "]/Camera[" +
                      DisplayManager_DisplayCameraNumber(iDisplay) +
                      "] on Display[" + iDisplay.ToString() + "]." + e.Message,
                      sMethod,
                      AuditSeverity.Error);

                return false;
            }
        }

        public bool DoStopDisplayAndOptimize(int iDisplay, bool bOptimize)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                m_bStopMonitorSuccess = false;

                if (DisplayManager_DisplayIsFree(iDisplay))
                {
                    Audit("No Active Camera On Display [" + iDisplay.ToString() + "]", sMethod, AuditSeverity.Warning);

                    return false;
                }

                Audit("Stopping Live Video On Site[" +
                      DisplayManager_DisplaySiteName(iDisplay) +
                      "]/Camera[" +
                      DisplayManager_DisplayCameraNumber(iDisplay) +
                      "] On Display[" + iDisplay.ToString() + "]", 
                      sMethod,
                      AuditSeverity.Information);

                DisplayManager_SetDvrAction(iDisplay, DvrAction.StopLiveVideo);
                //PCompStatus ReturnedStatus = m_PlayerStreaming[iDisplay].ClearStreamSource();

                //if (ReturnedStatus == PCompStatus.PCompStatus_Ok)
                //{
                //    m_bStopMonitorSuccess = true;

                //    DisplayManager_ResetSingleDisplay(iDisplay);
                //    lblActiveDisplays.Text = "Displays " + DisplayManager_DecrementActiveDisplaysCounter();
                //    Audit(DisplayManager_ActiveDisplays() + " Active Displays.", sMethod, AuditSeverity.Information);

                //    if (bOptimize)
                //    {
                //    }

                //    //   GUI stuff
                //    HideSurroundingFrame(iDisplay, sMethod);
                //    CloseButtonVisible(false);
                //    btnDigitalZoom.Visible = false;
                //    DisplayDescription("");
                //    EventMessage("");
                //    PtzGUI(false);

                //    return true;
                //}
                //else
                //{
                //    Audit("Failed To Stop Monitoring Display[" +
                //          iDisplay.ToString() +
                //          "]. Error - " +
                //          ReturnedStatus.ToString(),
                //          sMethod,
                //          AuditSeverity.Warning);
                //}

                return false;
            }
            catch (Exception e)
            {
                Audit("Failed Stopping Live Video On Site[" +
                      DisplayManager_DisplaySiteName(iDisplay) +
                      "]/Camera[" +
                      DisplayManager_DisplayCameraNumber(iDisplay) +
                      "] On Display[" + iDisplay.ToString() + "]." + e.Message, 
                      sMethod,
                      AuditSeverity.Error);

                return false;
            }
        }

        private void CloseAllCameras()
        {
            #region Data Members
            
            int i;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            DateTime dtNow = DateTime.Now;

            HistoryItem hi = null; 

            #endregion

            try
            {
                #region prepare history

                if (!m_bInHistory)
                {
                    hi = new HistoryItem(HistoryItemType.CloseAll,
                                         Utils.GetEnumDescription(HistoryItemType.CloseAll),
                                         DisplayManager_GetMode());

                    for (i = 0; i < DisplayManager_Displays(); i++)
                    {
                        if (!DisplayManager_DisplayIsFree(i))
                        {
                            hi.AddCamera(DisplayManager_DisplayVendorName(i),
                                         DisplayManager_DisplaySiteName(i),
                                         DisplayManager_DisplayCameraNumber(i),
                                         DisplayManager_DisplayNumber(i) + 1,
                                         DisplayManager_DisplayActivation(i),
                                         DisplayManager_DisplayPlaybackStart(i),
                                         DisplayManager_DisplayPlaybackDuration(i),
                                         DisplayManager_DisplayPreset(i));
                        }
                    }
                }

                #endregion

                for (i = (m_DisplayInfo.Displays - 1); i >= 0; i--)
                {
                    if ((!DisplayManager_DisplayIsFree(i)) &&
                        (dtNow > DisplayManager_DisplayStartDateTime(i)))
                    {
                        DoStopCamera(i);
                    }
                }

                if (!m_bInHistory)
                {
                    AddHistoryItem(hi);
                }

                if ((int)(DisplayManager_GetMode()) < 7)
                {
                    SetSpecialLayoutsMode(false);
                }
                else
                {
                    if (m_bFixedLayout)
                    {
                        SetSpecialLayoutsMode(true);
                    }
                    else
                    {
                        SetSpecialLayoutsMode(false);
                    }
                }

                CustomizeDisplays(sMethod);
                NoVideoPictureOnEmptyDisplays();
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void CloseAllCameras(string sSiteName)
        {
            #region Data members
            
            int i;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            DateTime dtNow = DateTime.Now;
            HistoryItem hi = null;

            CameraInformation ciCameraInformation;

            #endregion

            try
            {
                Audit("Close All Cameras For DVR[" + sSiteName + "]", sMethod, AuditSeverity.Information);

                #region prepare history

                if (!m_bInHistory)
                {
                    hi = new HistoryItem(HistoryItemType.CloseAll,
                                         Utils.GetEnumDescription(HistoryItemType.CloseAll),
                                         DisplayManager_GetMode());

                    for (i = 0; i < DisplayManager_Displays(); i++)
                    {
                        if (!DisplayManager_DisplayIsFree(i))
                        {
                            hi.AddCamera(DisplayManager_DisplayVendorName(i),
                                         DisplayManager_DisplaySiteName(i),
                                         DisplayManager_DisplayCameraNumber(i),
                                         DisplayManager_DisplayNumber(i) + 1,
                                         DisplayManager_DisplayActivation(i),
                                         DisplayManager_DisplayPlaybackStart(i),
                                         DisplayManager_DisplayPlaybackDuration(i),
                                         DisplayManager_DisplayPreset(i));
                        }
                    }
                }

                #endregion

                for (i = (m_DisplayInfo.Displays - 1); i >= 0; i--)
                {
                    if ((!DisplayManager_DisplayIsFree(i)) &&
                        (dtNow > DisplayManager_DisplayStartDateTime(i)))
                    {
                        ciCameraInformation = DisplayManager_GetCamera(i);
                        if (ciCameraInformation != null)
                        {
                            if (ciCameraInformation.SiteName == sSiteName)
                            {
                                DoStopCamera(i);
                            }
                        }
                    }
                }

                if (!m_bInHistory)
                {
                    AddHistoryItem(hi);
                }

                CustomizeDisplays(sMethod);
                NoVideoPictureOnEmptyDisplays();
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void CloseAllCamerasInitiatedByAlarm(string sAlarmNumber)
        {
            #region Data Members
            
            int i;
            int iAlarmNumber;

            HistoryItem hi = null;

            string sMethod = MethodBase.GetCurrentMethod().Name; 

            #endregion

            try
            {
                if (sAlarmNumber.IndexOf(".") != DvrClientConstants.NONE)
                {
                    sAlarmNumber = sAlarmNumber.Substring(0, sAlarmNumber.IndexOf("."));
                }

                try
                {
                    iAlarmNumber = int.Parse(sAlarmNumber);
                }
                catch (Exception)
                {
                    Audit("Alarm Number[" + sAlarmNumber + "] Is Not Numeric",
                          sMethod,
                          AuditSeverity.Warning);

                    return;
                }

                Audit("Close All Cameras Initiated By Alarm Number[" + iAlarmNumber + "]", 
                      sMethod, 
                      AuditSeverity.Information);

                #region prepare history

                if (!m_bInHistory)
                {
                    hi = new HistoryItem(HistoryItemType.CloseAll,
                                         Utils.GetEnumDescription(HistoryItemType.CloseAll),
                                         DisplayManager_GetMode());

                    for (i = 0; i < DisplayManager_Displays(); i++)
                    {
                        if (!DisplayManager_DisplayIsFree(i))
                        {
                            hi.AddCamera(DisplayManager_DisplayVendorName(i),
                                         DisplayManager_DisplaySiteName(i),
                                         DisplayManager_DisplayCameraNumber(i),
                                         DisplayManager_DisplayNumber(i) + 1,
                                         DisplayManager_DisplayActivation(i),
                                         DisplayManager_DisplayPlaybackStart(i),
                                         DisplayManager_DisplayPlaybackDuration(i),
                                         DisplayManager_DisplayPreset(i));
                        }
                    }
                }

                #endregion

                for (i = (m_DisplayInfo.Displays - 1); i >= 0; i--)
                {
                    if (!DisplayManager_DisplayIsFree(i))
                    {
                        if (DisplayManager_DisplayInitiatingAlarm(i) == iAlarmNumber)
                        {
                            DoStopCamera(i);
                        }
                    }
                }

                if (!m_bInHistory)
                {
                    AddHistoryItem(hi);
                }

                CustomizeDisplays(sMethod);
                NoVideoPictureOnEmptyDisplays();
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void CloseAllCameras(List<int> lLeaveOpenDisplay)
        {
            #region Data Members
            
            int i;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sLeaveOpenList = "";
            HistoryItem hi = null;
            DateTime dtNow = DateTime.Now; 

            #endregion

            try
            {
                for (int j = 0; j < lLeaveOpenDisplay.Count; j++)
                {
                    sLeaveOpenList += (lLeaveOpenDisplay[j] + 1) + ",";
                }
                if (sLeaveOpenList != "")
                {
                    sLeaveOpenList = sLeaveOpenList.Substring(0, sLeaveOpenList.Length - 1);
                }

                Audit("Close All Cameras Except Displays[" + sLeaveOpenList + "]", sMethod, AuditSeverity.Important);

                #region prepare history

                if (!m_bInHistory)
                {
                    hi = new HistoryItem(HistoryItemType.CloseAll,
                                         Utils.GetEnumDescription(HistoryItemType.CloseAll),
                                         DisplayManager_GetMode());

                    for (i = 0; i < DisplayManager_Displays(); i++)
                    {
                        if (!DisplayManager_DisplayIsFree(i))
                        {
                            hi.AddCamera(DisplayManager_DisplayVendorName(i),
                                         DisplayManager_DisplaySiteName(i),
                                         DisplayManager_DisplayCameraNumber(i),
                                         DisplayManager_DisplayNumber(i) + 1,
                                         DisplayManager_DisplayActivation(i),
                                         DisplayManager_DisplayPlaybackStart(i),
                                         DisplayManager_DisplayPlaybackDuration(i),
                                         DisplayManager_DisplayPreset(i));
                        }
                    }
                }

                #endregion

                for (i = (m_DisplayInfo.Displays - 1); i >= 0; i--)
                {
                    if ((!DisplayManager_DisplayIsFree(i)) &&
                        (dtNow > DisplayManager_DisplayStartDateTime(i)))
                    {
                        int iListLength = lLeaveOpenDisplay.Count;
                        bool bCloseDisplay = true;
                        for (int j = 0; j < iListLength; j++)
                        {
                            if (lLeaveOpenDisplay[j] == i)
                            {
                                lLeaveOpenDisplay.RemoveAt(j);
                                j = iListLength;
                                bCloseDisplay = false;
                            }
                        }

                        if (bCloseDisplay)
                        {
                            DoStopCamera(i);
                        }
                    }
                }

                if (!m_bInHistory)
                {
                    AddHistoryItem(hi);
                }

                if (!m_bNoAdaption)
                {
                    SetSpecialLayoutsMode(false);
                    CustomizeDisplays(sMethod);
                    NoVideoPictureOnEmptyDisplays();

                    m_bNoAdaption = false;
                }
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void CloseAllCamerasExceptManuals()
        {
            #region Data Members
            
            int i;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            DateTime dtNow = DateTime.Now;
            HistoryItem hi = null; 

            #endregion

            try
            {
                Audit("Close All Cameras Except Manuals", sMethod, AuditSeverity.Information);

                #region prepare history

                if (!m_bInHistory)
                {
                    hi = new HistoryItem(HistoryItemType.CloseAll,
                                         Utils.GetEnumDescription(HistoryItemType.CloseAll),
                                         DisplayManager_GetMode());

                    for (i = 0; i < DisplayManager_Displays(); i++)
                    {
                        if (!DisplayManager_DisplayIsFree(i))
                        {
                            hi.AddCamera(DisplayManager_DisplayVendorName(i),
                                         DisplayManager_DisplaySiteName(i),
                                         DisplayManager_DisplayCameraNumber(i),
                                         DisplayManager_DisplayNumber(i) + 1,
                                         DisplayManager_DisplayActivation(i),
                                         DisplayManager_DisplayPlaybackStart(i),
                                         DisplayManager_DisplayPlaybackDuration(i),
                                         DisplayManager_DisplayPreset(i));
                        }
                    }
                }

                #endregion

                for (i = (m_DisplayInfo.Displays - 1); i >= 0; i--)
                {
                    if ((!DisplayManager_DisplayIsFree(i)) &&
                        (dtNow > DisplayManager_DisplayStartDateTime(i)) &&
                        (DisplayManager_DisplayOpenType(i) != CameraOpenType.Manual))
                    {
                        DoStopCamera(i);
                    }
                }

                if (!m_bInHistory)
                {
                    AddHistoryItem(hi);
                }

                SetSpecialLayoutsMode(false);
                CustomizeDisplays(sMethod);
                NoVideoPictureOnEmptyDisplays();
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void CloseAllCamerasExceptManuals(List<int> lLeaveOpenDisplay)
        {
            #region Data Members

            int i;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sLeaveOpenList = "";
            HistoryItem hi = null;
            DateTime dtNow = DateTime.Now; 

            #endregion

            try
            {
                for (int j = 0; j < lLeaveOpenDisplay.Count; j++)
                {
                    sLeaveOpenList += (lLeaveOpenDisplay[j] + 1) + ",";
                }
                if (sLeaveOpenList != "")
                {
                    sLeaveOpenList = sLeaveOpenList.Substring(0, sLeaveOpenList.Length - 1);
                }

                Audit("Close All Cameras That Are Not Manualy Open Except Displays[" + sLeaveOpenList + "]",
                      sMethod,
                      AuditSeverity.Important);

                #region prepare history

                if (!m_bInHistory)
                {
                    hi = new HistoryItem(HistoryItemType.CloseAll,
                                         Utils.GetEnumDescription(HistoryItemType.CloseAll),
                                         DisplayManager_GetMode());

                    for (i = 0; i < DisplayManager_Displays(); i++)
                    {
                        if (!DisplayManager_DisplayIsFree(i))
                        {
                            hi.AddCamera(DisplayManager_DisplayVendorName(i),
                                         DisplayManager_DisplaySiteName(i),
                                         DisplayManager_DisplayCameraNumber(i),
                                         DisplayManager_DisplayNumber(i) + 1,
                                         DisplayManager_DisplayActivation(i),
                                         DisplayManager_DisplayPlaybackStart(i),
                                         DisplayManager_DisplayPlaybackDuration(i),
                                         DisplayManager_DisplayPreset(i));
                        }
                    }
                }

                #endregion

                for (i = (m_DisplayInfo.Displays - 1); i >= 0; i--)
                {
                    if ((!DisplayManager_DisplayIsFree(i)) &&
                        (dtNow > DisplayManager_DisplayStartDateTime(i)) &&
                        (DisplayManager_DisplayOpenType(i) != CameraOpenType.Manual))
                    {
                        int iListLength = lLeaveOpenDisplay.Count;
                        bool bCloseDisplay = true;
                        for (int j = 0; j < iListLength; j++)
                        {
                            if (lLeaveOpenDisplay[j] == i)
                            {
                                lLeaveOpenDisplay.RemoveAt(j);
                                j = iListLength;
                                bCloseDisplay = false;
                            }
                        }

                        if (bCloseDisplay)
                        {
                            DoStopCamera(i);
                        }
                    }
                }

                if (!m_bInHistory)
                {
                    AddHistoryItem(hi);
                }

                SetSpecialLayoutsMode(false);
                CustomizeDisplays(sMethod);
                NoVideoPictureOnEmptyDisplays();
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        #endregion        

        #region Playback

        public bool StartPlaybacking(CameraInformation ciCameraInformation,
                                     DateTime timeFrom,
                                     DateTime timeTo,                                     
                                     int iDisplay)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sError;            
            string sMessage = "";
            string sCameraName;
            string sResult;

            #endregion

            try
            {
                if (ciCameraInformation == null)
                {
                    Audit("Camera Information Is Null", sMethod, AuditSeverity.Warning);

                    return false;
                }

                if (iDisplay < 0)
                {
                    Audit("Bad Display Number[" + iDisplay + "]",
                      sMethod,
                      AuditSeverity.Warning);

                    return false;
                }

                sMessage = "Camera[" + ciCameraInformation.CameraNumber + " - " + ciCameraInformation.Name + "]";
                sMessage += " Display[" + (iDisplay + 1) + "]";
                sMessage += " From[" + timeFrom.ToString() + "] To[" + timeTo.ToString() + "]";

                DisplayManager_SetDvrAction(iDisplay, DvrAction.StartPlayback);

                PlaybackParameters playbackParameters = new PlaybackParameters();
                playbackParameters.Camera = ciCameraInformation;
                playbackParameters.StartTime = timeFrom;
                playbackParameters.EndTime = timeTo;

                if (!vp[iDisplay].Playback(playbackParameters, out sResult))
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);

                    return false;
                }        

                return true;
            }
            catch (Exception e)
            {
                Audit(sMessage + ". " + e.Message, sMethod, AuditSeverity.Warning);

                return false;
            }
        }

        private bool DoStartPlayback(CameraInformation ciCameraInformation,
                                     DateTime dNewStartDateTime,
                                     int iDisplay,
                                     int lDuration,
                                     int lPre,
                                     int lPost)
        {
            #region Data Members

            bool bRc;

            DateTime timeFrom;
            DateTime timeTo;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sMessage = "";
            string sError;
            string sCameraName; 

            #endregion

            try
            {
                if (ciCameraInformation == null)
                {
                    Audit("Camera Information Is Null", sMethod, AuditSeverity.Warning);

                    return false;
                }

                timeFrom = dNewStartDateTime;
                timeTo = dNewStartDateTime;

                timeFrom = Utils.DateAdd((lPre * (-1)), timeFrom);
                timeTo = Utils.DateAdd((lDuration + lPost), timeTo);

                if (timeTo > DateTime.Now)
                {
                    Audit("To Time[" + timeTo.ToString() + "] Exceeds Present Time. " +
                          "Playback To Time Changed To Present Time[" + DateTime.Now.ToString() + "]",
                          sMethod,
                          AuditSeverity.Warning);
                    timeTo = DateTime.Now;
                }

                sMessage = "Camera[" + ciCameraInformation.CameraNumber + " - " + ciCameraInformation.Name + "]";
                sMessage += " Display[" + (iDisplay + 1) + "]";
                sMessage += " From[" + timeFrom.ToString() + "] To[" + timeTo.ToString() + "]";

                bRc = StartPlaybacking(ciCameraInformation,
                                       timeFrom,
                                       timeTo,                                       
                                       iDisplay);
                if (bRc)
                {
                    DisplayManager_IncrementActiveDisplaysCounter();
                    Audit("Opened PLAYBACK On Camera[" + ciCameraInformation.CameraNumber +
                          "]. " + DisplayManager_ActiveDisplays() + " Active Displays",
                          sMethod,
                          AuditSeverity.Information);

                    DisplayManager_SetDisplayPlaybackStart(iDisplay, dNewStartDateTime);
                    DisplayManager_SetDisplayPlaybackDuration(iDisplay, lDuration);

                    lblActiveDisplays.Text = "Displays " + DisplayManager_ActiveDisplays().ToString();
                }

                return bRc;
            }
            catch (Exception e)
            {
                Audit(sMessage + ". " + e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public void StartPlayback(CameraInformation ciCameraInformation,
                                  int iColorNumber,
                                  DateTime dStartDateTime,
                                  int lDuration,
                                  int lPre,
                                  int lPost,
                                  string sEventMessage,
                                  bool bSingleAction,
                                  DateTime dTriggerCreationTime,
                                  string sTriggerSource)
        {
            #region Data Members 

            bool bRc;
            bool bNeedToElevateMode;

            int iDisplayIndex = DvrClientConstants.NONE;

            string sCameraName;
            string sError;
            string sMessage;            
            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                if (ciCameraInformation == null)
                {
                    Audit("Camera Information Is Null", sMethod, AuditSeverity.Warning);

                    return;
                }

                if (DisplayManager_GetSelectedDisplayModeOn())
                {
                    SelectedDisplayOff();
                }                

                //if (!IsCameraRecording(sSiteName, iCameraNumber))
                //{
                //    sMessage = "Camera[" + sCameraName +
                //               "] Number[" + iCameraNumber +
                //               "] On DVR[" + sSiteName + "] Is Not Recording";
                //    Audit(sMessage, sMethod, AuditSeverity.Warning);

                //    Utils.Error(sMessage);

                //    return;
                //}

                iDisplayIndex = DvrClientConstants.NONE;
                bNeedToElevateMode = false;

                //  is there a free display on current mode? 
                if (DisplayManager_IsFreeDisplayInCurrentMode())
                {
                    Audit("Display Mode is[" + Utils.GetEnumDescription(DisplayManager_GetMode()) +
                          "]. There Is A Free Display.",
                          sMethod, 
                          AuditSeverity.Information);

                    iDisplayIndex = DisplayManager_FindFreeDisplay();

                    Audit("Display[" + (iDisplayIndex + 1) +
                          "] Allocated For Camera[" + ciCameraInformation.CameraNumber +
                          "]",
                          sMethod, AuditSeverity.Information);
                }
                else
                {
                    //  are we in the highest mode?
                    if (IsHighestMode())
                    {
                        DisplayManager_SetActiveDisplayIndex(DisplayManager_GetVeteran());
                        btnClose_Click(null, null);
                        iDisplayIndex = DisplayManager_GetActiveDisplayIndex();

                        Audit("Display Mode Is[" + Utils.GetEnumDescription(DisplayManager_GetMode()) +
                              "], The Highest Mode. There Is No Free Display. Overriding Display[" +
                              (iDisplayIndex + 1) + "]",
                              sMethod,
                              AuditSeverity.Information);

                        bNeedToElevateMode = false;
                    }
                    else
                    {
                        Audit("Display Mode Is[" + Utils.GetEnumDescription(DisplayManager_GetMode()) +
                              "] Has No Free Display. Switching To Mode[" +
                              Utils.GetEnumDescription(DisplayManager_GetMode() + 1) + "]",
                              sMethod,
                              AuditSeverity.Information);


                        //ElevateDisplayMode();
                        iDisplayIndex = DisplayManager_FindFreeDisplay();

                        Audit("Display[" + (iDisplayIndex + 1) +
                              "] Allocated For Camera[" + ciCameraInformation.Name +
                              "] Number [" + ciCameraInformation.CameraNumber + "]",
                              sMethod,
                              AuditSeverity.Information);

                        bNeedToElevateMode = true;
                    }
                }

                bRc = DoStartPlayback(ciCameraInformation,                                      
                                      dStartDateTime,
                                      iDisplayIndex,
                                      lDuration,
                                      lPre,
                                      lPost);
                if (bRc)
                {
                    if (bNeedToElevateMode)
                    {
                        ElevateDisplayMode();
                    }

                    m_bVod = true;
                    DisplayManager_SetSingleDisplay(iDisplayIndex,
                                                    ciCameraInformation,                                                    
                                                    iColorNumber,
                                                    iDisplayIndex,
                                                    false,
                                                    false,
                                                    DateTime.Now,
                                                    ActivationType.VideoOnDemand,
                                                    sEventMessage);

                    if (dTriggerCreationTime != Utils.InitialDefaultTime())
                    {
                        DisplayManager_SetDisplayTriggerCreationTime(iDisplayIndex, dTriggerCreationTime);
                        DisplayManager_SetDisplayTriggerSource(iDisplayIndex, sTriggerSource);
                    }

                    DisplayManager_SetVeteran();                    

                    if (bSingleAction)
                    {
                        PictureVisible(iDisplayIndex, false);
                        CustomizeDisplays(sMethod);
                        NoVideoPictureOnEmptyDisplays();
                    }

                    //CameraNodeDisplay(sSiteName, iCameraNumber, Action.Add, iDisplayIndex + 1);
                }
                else
                {
                    m_bVod = false;
                    m_bRangeError = true;

                    Audit("StartPlayback Failed For Camera[" + ciCameraInformation.Name +
                          "] Number[" + ciCameraInformation.CameraNumber +
                          "] On Display[" + (iDisplayIndex + 1) + "]",
                          sMethod,
                          AuditSeverity.Warning);
                }
            }

            catch (Exception e)
            {
                string sErrorMessage;
                m_bVod = false;
                m_bRangeError = true;

                sErrorMessage = "Failed To Start PLAYBACK For Camera Number[" + ciCameraInformation.CameraNumber +
                                "]." + e.Message;
                Audit(sErrorMessage, sMethod, AuditSeverity.Error);
                Utils.Error(sErrorMessage);
            }
        }

        public void StartPlayback_on_Display_Y(CameraInformation ciCameraInformation,
                                               int iColorNumber,
                                               DateTime dStartDateTime,
                                               int iRealDisplay,
                                               int lDuration,
                                               int lPre,
                                               int lPost,
                                               string sEventMessage,
                                               bool bSingleAction,
                                               DateTime dTriggerCreationTime,
                                               string sTriggerSource)
        {
            #region Data Members
            
            bool bRc;

            string sCameraName;
            string sMessage;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sError;

            int iDisplay;

            #endregion

            try
            {
                if (ciCameraInformation == null)
                {
                    Audit("Camera Information Is Null", sMethod, AuditSeverity.Warning);

                    return;
                }

                if (DisplayManager_GetSelectedDisplayModeOn())
                {
                    SelectedDisplayOff();
                }                

                //if (!IsCameraRecording(sSiteName, iCameraNumber))
                //{
                //    sMessage = "Camera[" + sCameraName +
                //               "] Number[" + iCameraNumber +
                //               "] On DVR[" + sSiteName + "] Is Not Recording";
                //    Audit(sMessage, sMethod, AuditSeverity.Important);

                //    return;                    
                //}

                iDisplay = iRealDisplay - 1;

                //  if live video or playback exist on the display they will be overriden
                if (!DisplayManager_DisplayIsFree(iDisplay))
                {
                    lblActiveDisplays.Text = "Displays " + DisplayManager_DecrementActiveDisplaysCounter();
                    Audit(DisplayManager_ActiveDisplays() + " Active Displays.", sMethod, AuditSeverity.Information);
                }

                bRc = DoStartPlayback(ciCameraInformation,
                                      dStartDateTime,
                                      iDisplay,
                                      lDuration,
                                      lPre,
                                      lPost);
                if (bRc)
                {
                    m_bVod = true;
                    DisplayManager_SetSingleDisplay(iDisplay,
                                                    ciCameraInformation,
                                                    iColorNumber,
                                                    iDisplay,
                                                    false,
                                                    true,
                                                    DateTime.Now,
                                                    ActivationType.VideoOnDemand,
                                                    sEventMessage);

                    if (dTriggerCreationTime != Utils.InitialDefaultTime())
                    {
                        DisplayManager_SetDisplayTriggerCreationTime(iDisplay, dTriggerCreationTime);
                        DisplayManager_SetDisplayTriggerSource(iDisplay, sTriggerSource);
                    }

                    DisplayManager_SetVeteran();

                    if (bSingleAction)
                    {
                        CustomizeDisplays(sMethod);
                        NoVideoPictureOnEmptyDisplays(); 
                    }

                    //CameraNodeDisplay(sSiteName, iCameraNumber, Action.Add, iDisplay + 1);
                }
                else
                {
                    Audit("StartPlayback On Display Failed For Camera[" + ciCameraInformation.Name +
                          "] Number[" + ciCameraInformation.CameraNumber +
                          "] On Display[" + iRealDisplay + "]",
                          sMethod,
                          AuditSeverity.Warning);

                    m_bVod = false;
                    m_bRangeError = true;

                    DisplayManager_ResetSingleDisplay(iDisplay);
                    NoVideoPictureOnEmptyDisplays();
                }
            }

            catch (Exception e)
            {
                string sErrorMessage;
                m_bVod = false;
                m_bRangeError = true;

                sErrorMessage = "Failed To Start PLAYBACK For Camera Number[" + ciCameraInformation.CameraNumber +
                                 "] On Display [" + iRealDisplay +
                                 "]." + e.Message;
                Audit(sErrorMessage, sMethod, AuditSeverity.Error);
                Utils.Error(sErrorMessage);
            }
        }

        private void MultiSelectPlayback(DateTime dtStartDateTime, int iDuration)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_MultiSelectedCamera == null)
                {
                    Audit("Multi Selected Cameras List Is Null", sMethod, AuditSeverity.Warning);

                    return;
                }

                if (m_MultiSelectedCamera.Count == 0)
                {
                    Audit("Multi Selected Cameras List Is Empty", sMethod, AuditSeverity.Warning);

                    return;
                }

                for (int i = 0; i < m_MultiSelectedCamera.Count; i++)
                {
                    //StartPlayback(m_MultiSelectedCamera[i].SiteName,
                    //              m_MultiSelectedCamera[i].CameraNumber,
                    //              DvrClientConstants.NONE,
                    //              dtStartDateTime,
                    //              iDuration,
                    //              0,
                    //              0,
                    //              "",
                    //              true,
                    //              Utils.InitialDefaultTime(),
                    //              "");

                    DoEvents();
                }
            }
            catch (Exception e)
            {
                Audit("Start Date/Time[" + dtStartDateTime + "] Duration[" + iDuration + "]" + e.Message, 
                      sMethod, 
                      AuditSeverity.Error);
            }
        }

        private void PressedOkOnPlaybackForm_Handler(object sender, EventArgs e)
        {
            PlaybackParameters2 pbp = (PlaybackParameters2)e;

            if (pbp.DisplayNumber == DvrClientConstants.NONE)
            {
                StartPlayback(pbp.Camera,
                              pbp.Color,
                              pbp.StartTime,
                              pbp.Duration,
                              pbp.Pre,
                              pbp.Post,
                              pbp.EventMessage,
                              true,
                              Utils.InitialDefaultTime(),
                              "");                
            }
            else
            {
                StartPlayback_on_Display_Y(pbp.Camera,
                                           pbp.Color,
                                           pbp.StartTime,
                                           pbp.DisplayNumber,
                                           pbp.Duration,
                                           pbp.Pre,
                                           pbp.Post,
                                           pbp.EventMessage,
                                           true,
                                           Utils.InitialDefaultTime(),
                                           "");
            }
        }

        private void vp_PlaybackProgress(object sender, EventArgs e)
        {
            #region Data Members

            DateTime dtCurrentTime;

            int iIndex;
            int iProgressPercentage;
            int iActiveDisplayIndex;

            Common.ExportEventData eed;

            #endregion

            eed = (Common.ExportEventData)e;

            iIndex = eed.DisplayIndex;
            iProgressPercentage = eed.ProgressPercentage;
            dtCurrentTime = eed.CurrentTime;

            iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();

            if (iActiveDisplayIndex != iIndex)
            {
                return;
            }

            if ((iProgressPercentage >= 0) && (iProgressPercentage <= 100))
            {
                trackSmallBarPlayPosition.Value = iProgressPercentage;
            }
        }

        #region Playback GUI

        private void DefaultPlaybackProgressGui()
        {
            btnSmallPlay.Tag = PlaybackAction.Play;
            btnSmallFastForward.Tag = PlaybackAction.FastForward;
            btnSmallBackward.Tag = PlaybackAction.PlayBackwards;
            btnSmallFastBackward.Tag = PlaybackAction.FastRewind;
        } 

        private void btnBackward_Click(object sender, EventArgs e)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            int iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();

            PlaybackActionParameters pbapPlaybackActionParameters;

            PlaybackAction pbPlaybackAction;

            #endregion

            try
            {
                pbPlaybackAction = (PlaybackAction)(btnSmallBackward.Tag);
                pbapPlaybackActionParameters = new PlaybackActionParameters(pbPlaybackAction);
                vp[iActiveDisplayIndex].PerformPlaybackAction(pbapPlaybackActionParameters, out sResult);

                DefaultPlaybackProgressGui();

                switch (pbPlaybackAction)
                {
                    case PlaybackAction.PlayBackwards:
                        btnSmallBackward.Tag = PlaybackAction.SlowRewind;
                        break;

                    case PlaybackAction.SlowRewind:
                        btnSmallBackward.Tag = PlaybackAction.VerySlowRewind;
                        break;

                    case PlaybackAction.VerySlowRewind:
                        btnSmallBackward.Tag = PlaybackAction.PlayBackwards;
                        break;

                    default:
                        break;
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void btnPlay_Click(object sender, EventArgs e)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            int iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();

            PlaybackActionParameters pbapPlaybackActionParameters;

            PlaybackAction pbPlaybackAction;

            #endregion

            try
            {
                pbPlaybackAction = (PlaybackAction)(btnSmallPlay.Tag);
                pbapPlaybackActionParameters = new PlaybackActionParameters(pbPlaybackAction);
                vp[iActiveDisplayIndex].PerformPlaybackAction(pbapPlaybackActionParameters, out sResult);

                DefaultPlaybackProgressGui();

                switch (pbPlaybackAction)
                {
                    case PlaybackAction.Play:
                        btnSmallPlay.Tag = PlaybackAction.SlowForward;
                        break;

                    case PlaybackAction.SlowForward:
                        btnSmallPlay.Tag = PlaybackAction.VerySlowForward;
                        break;

                    case PlaybackAction.VerySlowForward:
                        btnSmallPlay.Tag = PlaybackAction.Play;
                        break;

                    default:
                        break;
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void btnFastBackward_Click(object sender, EventArgs e)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            int iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();

            PlaybackActionParameters pbapPlaybackActionParameters;

            PlaybackAction pbPlaybackAction;

            #endregion

            try
            {
                pbPlaybackAction = (PlaybackAction)(btnSmallFastBackward.Tag);
                pbapPlaybackActionParameters = new PlaybackActionParameters(pbPlaybackAction);
                vp[iActiveDisplayIndex].PerformPlaybackAction(pbapPlaybackActionParameters, out sResult);

                DefaultPlaybackProgressGui();

                switch (pbPlaybackAction)
                {
                    case PlaybackAction.FastRewind:
                        btnSmallFastBackward.Tag = PlaybackAction.VeryFastRewind;
                        break;

                    case PlaybackAction.VeryFastRewind:
                        btnSmallFastBackward.Tag = PlaybackAction.FastestRewind;
                        break;

                    case PlaybackAction.FastestRewind:
                        btnSmallFastBackward.Tag = PlaybackAction.FastRewind;
                        break;

                    default:
                        break;
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void btnFastForward_Click(object sender, EventArgs e)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            int iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();

            PlaybackActionParameters pbapPlaybackActionParameters;

            PlaybackAction pbPlaybackAction;

            #endregion

            try
            {
                pbPlaybackAction = (PlaybackAction)(btnSmallFastForward.Tag);
                pbapPlaybackActionParameters = new PlaybackActionParameters(pbPlaybackAction);
                vp[iActiveDisplayIndex].PerformPlaybackAction(pbapPlaybackActionParameters, out sResult);

                DefaultPlaybackProgressGui();

                switch (pbPlaybackAction)
                {
                    case PlaybackAction.FastForward:
                        btnSmallFastForward.Tag = PlaybackAction.VeryFastForward;
                        break;

                    case PlaybackAction.VeryFastForward:
                        btnSmallFastForward.Tag = PlaybackAction.FastestForward;
                        break;

                    case PlaybackAction.FastestForward:
                        btnSmallFastForward.Tag = PlaybackAction.FastForward;
                        break;

                    default:
                        break;
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void btnStopPlayback_Click(object sender, EventArgs e)
        {
            // Pause current playback
            // StopVideo();
        }

        private void btnPrevFrame_Click(object sender, EventArgs e)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            int iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();

            PlaybackActionParameters pbapPlaybackActionParameters;

            #endregion

            try
            {
                pbapPlaybackActionParameters = new PlaybackActionParameters(PlaybackAction.StepBackward);
                vp[iActiveDisplayIndex].PerformPlaybackAction(pbapPlaybackActionParameters, out sResult);
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void btnNextFrame_Click(object sender, EventArgs e)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            int iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();

            PlaybackActionParameters pbapPlaybackActionParameters;

            #endregion

            try
            {
                pbapPlaybackActionParameters = new PlaybackActionParameters(PlaybackAction.StepForward);
                vp[iActiveDisplayIndex].PerformPlaybackAction(pbapPlaybackActionParameters, out sResult);
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void btnPause_Click(object sender, EventArgs e)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            int iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();

            PlaybackActionParameters pbapPlaybackActionParameters;

            #endregion

            try
            {
                pbapPlaybackActionParameters = new PlaybackActionParameters(PlaybackAction.Pause);
                vp[iActiveDisplayIndex].PerformPlaybackAction(pbapPlaybackActionParameters, out sResult);
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void trackBarPlayPosition_Scroll(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            //try
            //{
            //    // Pause track bar updating
            //    timerUpdateTrackBar.Stop();

            //    // Calculate the new playback position
            //    long nStart = m_PlayerStreaming[DisplayManager_GetActiveDisplayIndex()].ActualStartTime.ToBinary();
            //    long nDelta = trackBarPlayPosition.Value * 10000000L;

            //    // Update the player's new playback position
            //    UpdatePlaybackPosition(DateTime.FromBinary(nStart + nDelta));

            //    // Resume track bar updating
            //    timerUpdateTrackBar.Start();
            //}
            //catch (Exception ex)
            //{
            //    Audit("Track Bar Play Position Error: " + ex.Message, sMethod, AuditSeverity.Error);
            //}
        }

        private void trackSmallBarPlayPosition_Scroll(object sender, EventArgs e)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            int iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();

            #endregion

            try
            {
                int iNewPosition = trackSmallBarPlayPosition.Value;

                vp[iActiveDisplayIndex].PlaybackJumpTo(iNewPosition, out sResult);
            }
            catch (Exception ex)
            {
                Audit("Track Bar Play Position Error: " + ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void pbEvent_DoubleClick(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                //int iEventPosition = (int)(pbEvent.Tag);
                //int iPositionOnSlider = (trackBarPlayPosition.Maximum * iEventPosition) / 100;
                float fEvent = (float)(pbEvent.Tag);
                int iPositionOnSlider = (int)(fEvent * (float)trackBarPlayPosition.Maximum);

                trackSmallBarPlayPosition.Value = iPositionOnSlider;
                trackSmallBarPlayPosition_Scroll(null, null);
                btnPause_Click(null, null);
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void VmdEvent_DoubleClick(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                PictureBox VmdEvent = (PictureBox)sender;
                float fEvent = (float)(VmdEvent.Tag);
                float fPositionOnSlider = fEvent * (float)trackBarPlayPosition.Maximum;
                int iPositionOnSlider = (int)(fPositionOnSlider);
                float fFraction = fPositionOnSlider - (float)iPositionOnSlider;
                if (fFraction >= 0.5)
                {
                    iPositionOnSlider++;
                }

                trackSmallBarPlayPosition.Value = iPositionOnSlider;
                trackSmallBarPlayPosition_Scroll(null, null);
                btnPause_Click(null, null);
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        #endregion

        #endregion

        #region Export Stuff

        public void Export(ExportThreadData etd)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sMessage;
            string sMultiSelectFilename; 

            #endregion

            if (m_bMultiSelect)
            {
                sMessage = "Multi Select Export ";
            }
            else
            {
                sMessage = "DVR[" + etd.Camera.DvrId + "] ";
                sMessage += "Camera[" + etd.Camera.CameraNumber + " - " + etd.Camera.Name + "] ";                 
            }
            sMessage += "From[" + etd.Start + "] ";
            sMessage += "To[" + etd.End + "] ";
            sMessage += "Format[" + etd.VideoFormat + "] ";
            sMessage += "File Name[" + etd.FileName + "] ";
            
            TimeSpan ts = (etd.End).Subtract(etd.Start);
            int iMinutes = (ts.Hours * 60) + ts.Minutes;

            if (iMinutes <= 29)
            {
                if (m_bMultiSelect)
                {
                    if (m_MultiSelectedCamera == null)
                    {
                        Audit("Multi Selected Cameras List Is Null", sMethod, AuditSeverity.Warning);

                        return;
                    }

                    if (m_MultiSelectedCamera.Count == 0)
                    {
                        Audit("Multi Selected Cameras List Is Empty", sMethod, AuditSeverity.Warning);

                        return;
                    }

                    sMultiSelectFilename = etd.FileName;
                    for (int i = 0; i < m_MultiSelectedCamera.Count; i++)
                    {
                        etd.FileName = sMultiSelectFilename.Substring(0, sMultiSelectFilename.Length - 4) + " - " + (i + 1) +
                                       sMultiSelectFilename.Substring(sMultiSelectFilename.Length - 4, 4);
                        etd.DvrName = m_MultiSelectedCamera[i].SiteName;
                        etd.CameraNumber = m_MultiSelectedCamera[i].CameraNumber;

                        AuditPerform(sMessage, sMethod);
                        m_ExportThread.AddExportRequest(etd);

                        DoEvents();
                    }
                }
                else
                {
                    AuditPerform(sMessage, sMethod);
                    m_ExportThread.AddExportRequest(etd);
                }
            }
            else
            {
                sMessage += "Failed. Can't Export An Interval Longer Than 30 Minutes";

                AuditPerform(sMessage, sMethod);
                if (m_Settings.Language == Language.English)
                {
                    MessageBox.Show("Can't Export An Interval Longer Than 30 Minutes",
                                    "Export Failure",
                                    MessageBoxButtons.OK,
                                    MessageBoxIcon.Error);
                }
                else
                {
                    MessageBox.Show("         - 30 ",
                                    "  ",
                                    MessageBoxButtons.OK,
                                    MessageBoxIcon.Error);
                }
            }
        }

        public void Export(string sServerName,
                           int iCameraNumber,
                           DateTime dStartDate,
                           DateTime dEndDate,
                           string sVideoFormat,
                           string sFileName)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sMessage;
            string sResult;

            CameraInformation ciCameraInformation;

            ExportThreadData etd = new ExportThreadData();

            int iDvrId; 

            #endregion

            AuditPerform("Starting Export Thread From Message ...", sMethod);

            iDvrId = (int.TryParse(sServerName, out iDvrId)) ? iDvrId : DvrClientConstants.NONE;

            ciCameraInformation = GetCameraInformation(iDvrId, iCameraNumber, out sResult);
            if (ciCameraInformation == null)
            {
                AuditPerform(sResult, sMethod, AuditSeverity.Warning);

                return;
            }

            etd.Camera = ciCameraInformation;
            etd.AmsIP = m_Settings.NiceAmsIp;
            etd.CameraNumber = iCameraNumber;
            etd.Start = dStartDate;
            etd.End = dEndDate;
            etd.VideoFormat = (sVideoFormat == "") ? m_Settings.VideoFormat : sVideoFormat;
            etd.FileName = ExportFileName(sFileName, etd.VideoFormat);
            etd.DvrIP = GetLoggerIP(sServerName);
            etd.DvrName = sServerName;
            etd.CameraName = GetCameraNameByCameraNumber(sServerName, iCameraNumber);
            etd.InitialDirectory = (string.IsNullOrEmpty(m_Settings.ExportFolder)) ? Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) : m_Settings.ExportFolder;
            etd.Main = this;

            sMessage = "DVR[" + sServerName + "] ";
            sMessage += "Camera[" + iCameraNumber + " - " + etd.CameraName + "] ";
            sMessage += "From[" + dStartDate.ToString() + "] ";
            sMessage += "To[" + dEndDate.ToString() + "] ";
            sMessage += "Format[" + sVideoFormat + "] ";
            sMessage += "File Name[" + sFileName + "] ";

            TimeSpan ts = (etd.End).Subtract(etd.Start);
            int iMinutes = (ts.Hours * 60) + ts.Minutes;

            if (iMinutes <= 29)
            {
                AuditPerform(sMessage, sMethod);
                m_ExportThread.AddExportRequest(etd);
            }
            else
            {
                sMessage += "Failed. Can't Export An Interval Longer Than 30 Minutes";

                AuditPerform(sMessage, sMethod);
                if (m_Settings.Language == Language.English)
                {
                    MessageBox.Show("Can't Export An Interval Longer Than 30 Minutes",
                                    "Export Failure",
                                    MessageBoxButtons.OK,
                                    MessageBoxIcon.Error);
                }
                else
                {
                    MessageBox.Show("         - 30 ",
                                    "  ",
                                    MessageBoxButtons.OK,
                                    MessageBoxIcon.Error);
                }
            }
        }

        private string ExportFileName(string sFileName, string sVideoFormat)
        {
            #region Data Members
            
            int iFileExistsCounter;

            string sFileNameWithPathAndSuffix;
            string sSharedFolder;
            string sFileSuffix; 

            #endregion

            sSharedFolder = (m_Settings.ExportFolder == "") ? Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) : m_Settings.ExportFolder;

            m_iExportCounter++;

            if (sFileName == "")
            {
                sFileName = "Event" + m_iExportCounter.ToString();
            }

            if (sVideoFormat == "NVF")
            {
                sFileSuffix = ".NVF";
            }
            else
            { 
                sFileSuffix = ".AVI";
            }

            sFileNameWithPathAndSuffix = sSharedFolder + "\\" + sFileName + sFileSuffix;

            iFileExistsCounter = 1;
            while (File.Exists(sFileNameWithPathAndSuffix))
            {
                sFileNameWithPathAndSuffix = sSharedFolder + "\\" +
                                             sFileName + "-" + iFileExistsCounter + sFileSuffix;
                iFileExistsCounter++;
            }

            return sFileNameWithPathAndSuffix;
        }

        public void ExportMessage(string sFileName, string sMessage)
        {
            //MessageBox.Show(sFileName + " - " + sMessage);
        }

        #endregion

        #region Snap Shot Stuff

        public void SnapShot(int iDvrId,
                             int iCameraNumber,
                             string sImportedFileName,
                             ActivationType activationType)
        {
            #region Data Mambers
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sPath;
            string sFileName;
            string sPrefix;
            string sCameraName;
            string sError;
            string sResult;

            int iIndex;
            int iCameraChannelId;
            int iFileExistsCounter; 

            CameraInformation ciCameraInformation;

            #endregion

            try
            {
                bool bNoImportedFilename;
                
                sPath = "";
                sFileName = "";                

                ciCameraInformation = GetCameraInformation(iDvrId, iCameraNumber, out sResult);
                if (ciCameraInformation == null)
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);

                    return;
                }

                #region Filename

                sPath = (m_Settings.ExportFolder == "") ? Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) : m_Settings.ExportFolder;                

                if (sImportedFileName.Trim() == "[]")
                {
                    bNoImportedFilename = true;
                }
                else 
                {
                    bNoImportedFilename = false;

                    sImportedFileName = sImportedFileName.Substring(1, sImportedFileName.Length - 2);
                }

                if (bNoImportedFilename)
                {
                    if (m_Settings.SnapshotFilenameType == SnapShotFileNameType.CameraDescriptionWithDate)
                    {
                        bool bGotCameraName = string.IsNullOrEmpty(ciCameraInformation.Name);
                        sFileName = ciCameraInformation.Name + " " + DateTime.Now.ToString();
                        sFileName = sFileName.Replace("/", "-");
                        sFileName = sFileName.Replace(":", "-");
                    }
                    else
                    {                        
                        sFileName = m_Settings.SnapShotDefaultFileName;
                        sPrefix = sFileName;

                        iFileExistsCounter = 0;
                        while (File.Exists(sPath + "\\" + sPrefix + "-" + iFileExistsCounter + ".JPG"))
                        {
                            iFileExistsCounter++;
                        }

                        sFileName = sPrefix + "-" + iFileExistsCounter;
                    }
                }
                else
                {
                    sFileName = sImportedFileName;                    
                    sPrefix = sFileName;

                    iFileExistsCounter = 0;
                    while (File.Exists(sPath + "\\" + sPrefix + "-" + iFileExistsCounter + ".JPG"))
                    {
                        iFileExistsCounter++;
                    }

                    sFileName = sPrefix + "-" + iFileExistsCounter;
                }

                saveSnapshotFileDialog.InitialDirectory = sPath;
                saveSnapshotFileDialog.FileName = sFileName;
                DialogResult result = saveSnapshotFileDialog.ShowDialog(this);
                if (result != DialogResult.OK)
                {
                    return;
                }

                sFileName = saveSnapshotFileDialog.FileName;
                sPath = Path.GetDirectoryName(saveSnapshotFileDialog.FileName);
                Audit("Snap Shot Filename: " + sFileName, sMethod, AuditSeverity.Information);

                #endregion

                SnapshotParameters snapshotParameters = new SnapshotParameters();
                snapshotParameters.FileName = sFileName;
                snapshotParameters.Path = sPath;
                snapshotParameters.Camera = ciCameraInformation;

                if (!vp[DisplayManager_GetActiveDisplayIndex()].Snapshot(snapshotParameters, out sResult))
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);
                }

                Audit("Requested Snap Shot From " + activationType.ToString(), sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit("Failed Performing Snap Shot From DVR[] Camera[]. " + e.Message, sMethod,
                      AuditSeverity.Warning);
            }
        }

        public void SnapShot(CameraInformation ciCameraInformation,
                             string sImportedFileName,
                             ActivationType activationType)
        {
            #region Data Mambers

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sPath;
            string sFileName;
            string sPrefix;
            string sCameraName;
            string sError;
            string sResult;

            int iIndex;
            int iCameraChannelId;
            int iFileExistsCounter;

            #endregion

            try
            {
                bool bNoImportedFilename;

                sPath = "";
                sFileName = "";

                if (ciCameraInformation == null)
                {
                    Audit("Camera Information Is Null", sMethod, AuditSeverity.Warning);

                    return;
                }

                #region Filename

                sPath = (m_Settings.ExportFolder == "") ? Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) : m_Settings.ExportFolder;

                if (sImportedFileName.Trim() == "[]")
                {
                    bNoImportedFilename = true;
                }
                else
                {
                    bNoImportedFilename = false;

                    sImportedFileName = sImportedFileName.Substring(1, sImportedFileName.Length - 2);
                }

                if (bNoImportedFilename)
                {
                    if (m_Settings.SnapshotFilenameType == SnapShotFileNameType.CameraDescriptionWithDate)
                    {
                        bool bGotCameraName = string.IsNullOrEmpty(ciCameraInformation.Name);
                        sFileName = ciCameraInformation.Name + " " + DateTime.Now.ToString();
                        sFileName = sFileName.Replace("/", "-");
                        sFileName = sFileName.Replace(":", "-");
                    }
                    else
                    {
                        sFileName = m_Settings.SnapShotDefaultFileName;
                        sPrefix = sFileName;

                        iFileExistsCounter = 0;
                        while (File.Exists(sPath + "\\" + sPrefix + "-" + iFileExistsCounter + ".JPG"))
                        {
                            iFileExistsCounter++;
                        }

                        sFileName = sPrefix + "-" + iFileExistsCounter;
                    }
                }
                else
                {
                    sFileName = sImportedFileName;
                    sPrefix = sFileName;

                    iFileExistsCounter = 0;
                    while (File.Exists(sPath + "\\" + sPrefix + "-" + iFileExistsCounter + ".JPG"))
                    {
                        iFileExistsCounter++;
                    }

                    sFileName = sPrefix + "-" + iFileExistsCounter;
                }

                saveSnapshotFileDialog.InitialDirectory = sPath;
                saveSnapshotFileDialog.FileName = sFileName;
                DialogResult result = saveSnapshotFileDialog.ShowDialog(this);
                if (result != DialogResult.OK)
                {
                    return;
                }

                sFileName = saveSnapshotFileDialog.FileName;
                sPath = Path.GetDirectoryName(saveSnapshotFileDialog.FileName);
                Audit("Snap Shot Filename: " + sFileName, sMethod, AuditSeverity.Information);

                #endregion

                SnapshotParameters snapshotParameters = new SnapshotParameters();
                snapshotParameters.FileName = sFileName;
                snapshotParameters.Path = sPath;
                snapshotParameters.Camera = ciCameraInformation;

                if (!vp[DisplayManager_GetActiveDisplayIndex()].Snapshot(snapshotParameters, out sResult))
                {
                    Audit(sResult, sMethod, AuditSeverity.Warning);
                }

                Audit("Requested Snap Shot From DVR[" + ciCameraInformation.DvrId + 
                      "] Camera[" + ciCameraInformation.CameraNumber + 
                      "]", 
                      sMethod, 
                      AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit("Failed Performing Snap Shot From DVR[" + ciCameraInformation.DvrId + 
                      "] Camera[" + ciCameraInformation.CameraNumber + 
                      "]. " + 
                      e.Message, 
                      sMethod,
                      AuditSeverity.Warning);
            }
        }

        #endregion

        #region VMD Events

        public List<VmdEventRecord> GetVmdEventsByCamraAndTimeInterval(string sDvr, 
                                                                       int iCameraNumber,
                                                                       DateTime dtFrom,
                                                                       DateTime dtTo)
    {
        #region Data Members
            
        List<VmdEventRecord> VmdEvent = new List<VmdEventRecord>();

        string sMethod = MethodBase.GetCurrentMethod().Name;
        string sIp;
        string sError;
        string sResult;

        StringBuilder sIP = new StringBuilder(255);
        StringBuilder sbResult = new StringBuilder(131072);

        int iFromDate;
        int iFromTime;
        int iToDate;
        int iToTime;

        DateTime dtTriggerCreation; 

        #endregion

        try
        {
            if (!m_bCoreApiDllPresent)
            {
                sError = "CoreApi.dll Not Present. Can't Perform Get VMD Events Action.";
                Audit(sError, sMethod, AuditSeverity.Warning);
                Utils.Error(sError);

                return null;
            }

            sIp = GetLoggerIP(sDvr);
            sIP.Append(sIp);

            iFromDate = dtFrom.Year * 10000;
            iFromDate += dtFrom.Month * 100;
            iFromDate += dtFrom.Day;

            iFromTime = dtFrom.Hour * 1000000;
            iFromTime += dtFrom.Minute * 10000;
            iFromTime += dtFrom.Second * 100;

            iToDate = dtTo.Year * 10000;
            iToDate += dtTo.Month * 100;
            iToDate += dtTo.Day;

            iToTime = dtTo.Hour * 1000000;
            iToTime += dtTo.Minute * 10000;
            iToTime += dtTo.Second * 100;
                                
            //bool bRc = GetChannelVmdEvents(sIP,
            //                               iCameraNumber,
            //                               iFromDate,
            //                               iFromTime,
            //                               iToDate,
            //                               iToTime,
            //                               sbResult,
            //                               m_Settings.CoreApiTimeoutSeconds);

            //if (!bRc)
            //{
            //    sResult = sbResult.ToString();

            //    Audit("Failed Getting Vmd Events By Camra And Time Interval. " + sResult,
            //          sMethod,
            //          AuditSeverity.Error);

            //    return null;
            //}

            sResult = sbResult.ToString();
            int iNumberOfRecords = Utils.GetNumberOfOccurences(sResult, "#");

            Audit("Got " + iNumberOfRecords + 
                    " Vmd Events For DVR[" + sDvr + 
                    "] Camera[" + iCameraNumber + "] From[" + dtFrom + "] To[" + dtTo + "]",                                                                             
                    sMethod,
                    AuditSeverity.Information);

            for (int i = 1; i <= iNumberOfRecords; i++)
            {
                string sRecord = Utils.GetNthSubString(sResult, "#", i);
                if (sRecord.Substring(sRecord.Length - 1, 1) == "#")
                {
                    sRecord = sRecord.Substring(0, sRecord.Length - 1);
                }

                int iSessionID = int.Parse(Utils.GetNthSubString(sRecord, "@", 1));

                string sFromDate = Utils.GetNthSubString(sRecord, "@", 2);
                string sFromTime = Utils.GetNthSubString(sRecord, "@", 3);

                dtFrom = Utils.CreateDateTime(sFromDate, sFromTime);

                string sToDate = Utils.GetNthSubString(sRecord, "@", 4);
                string sToTime = Utils.GetNthSubString(sRecord, "@", 5);

                dtTo = Utils.CreateDateTime(sToDate, sToTime);

                int iCreationTrigDiff = int.Parse(Utils.GetNthSubString(sRecord, "@", 6));
                dtTriggerCreation = DateTime.ParseExact(sFromDate + " " + sFromTime,
                                                        "dd/MM/yyyy HH:mm:ss",
                                                        System.Globalization.CultureInfo.InvariantCulture);
                dtTriggerCreation = dtTriggerCreation.AddMilliseconds(iCreationTrigDiff * 10);

                string sDuration = Utils.GetNthSubString(sRecord, "@", 7);
                int iDurationMinutes = int.Parse(Utils.GetNthSubString(sDuration, ":", 1));
                int iDurationSecondes = int.Parse(Utils.GetNthSubString(sDuration, ":", 2));

                #region Trigger Source

                int iTriggerSource = int.Parse(Utils.GetNthSubString(sRecord, "@", 8));
                string sTriggerSource = "";

                switch (iTriggerSource)
                {
                    case 0:
                        sTriggerSource = "TTL";
                        break;

                    case 1:
                        sTriggerSource = "SIGNAL LOSS";
                        break;

                    case 2:
                        sTriggerSource = "API";
                        break;

                    case 3:
                        sTriggerSource = "VMD";
                        break;

                    case 5:
                        sTriggerSource = "AUDIO_SQUELCH";
                        break;

                    case 6:
                        sTriggerSource = "UNATTENDED_BAGGAGE";
                        break;

                    case 7:
                        sTriggerSource = "UNAUTHORIZED CAR";
                        break;

                    case 8:
                        sTriggerSource = "CROWD CONTROL";
                        break;

                    case 9:
                        sTriggerSource = "TAILGATING";
                        break;

                    case 10:
                        sTriggerSource = "INTRUDER DETECTION";
                        break;

                    default:
                        sTriggerSource = "UNKNOWN";
                        break;
                }

                #endregion

                VmdEventRecord currentVmdEvent = new VmdEventRecord(iSessionID,
                                                                    dtFrom,
                                                                    dtTo,
                                                                    dtTriggerCreation,
                                                                    iDurationMinutes,
                                                                    iDurationSecondes,
                                                                    sTriggerSource);
                VmdEvent.Add(currentVmdEvent);

                DoEvents();
            }

            return VmdEvent;
        }
        catch (Exception e)
        {
            Audit("Failed Getting Vmd Events By Camra And Time Interval. " + e.Message, 
                    sMethod, 
                    AuditSeverity.Error);

            return null;
        }
    }
 
        #endregion

        #region Focus On Video Player

        void vp_Enter(object sender, EventArgs e)
        {
            #region Data Members
            
            //int iDisplayIndex;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            //Color color; 

            #endregion

            return;

            //try
            //{
            //    iDisplayIndex = ((AxNVPlayerCompX.AxCPlayerComponentX)sender).TabIndex;

            //    if ((iDisplayIndex < 0) || (iDisplayIndex >= DisplayManager_Displays()))
            //    {
            //        Audit("Problematic Display Index[" + (iDisplayIndex + 1) + "]", 
            //              sMethod, 
            //              AuditSeverity.Warning);

            //        return;
            //    }

            //    Audit("Entered Display[" + (iDisplayIndex + 1) + "]", sMethod, AuditSeverity.Information);

            //    ////overTransparent.Visible = false;
            //    ////ChangeTransparentLocationAndSize(0, 0, 0, 0, sMethod);

            //    if (DisplayManager_DisplayIsFree(iDisplayIndex))
            //    {
            //        Audit("Entered A Free Display[" + (iDisplayIndex + 1) + "]", 
            //              sMethod, 
            //              AuditSeverity.Warning);

            //        return;
            //    }


            //    switch (DisplayManager_DisplayActivation(iDisplayIndex))
            //    {
            //        case ActivationType.LiveVideo:
            //            color = Color.Blue;
            //            m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_SWITCH].Text =
            //                (m_Settings.Language == Language.Hebrew) ? " " : "Switch To Playback";
            //            break;

            //        case ActivationType.VideoOnDemand:
            //            color = Color.GreenYellow;
            //            m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_SWITCH].Text =
            //                (m_Settings.Language == Language.Hebrew) ? " " : "Switch To Live Video";
            //            //UpdateTrackBarLimits();
            //            //UpdateTrackBarValue();
            //            break;

            //        default:
            //            color = Color.Red;
            //            break;
            //    }

            //    m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_PRE_DEFINED_VIEWS].MenuItems[m_PreDefinedView.Count].Visible =
            //            (DisplayManager_ActiveDisplays() > 0) ? true : false;

            //    m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_EXPORT].Visible = true;
            //    m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_SNAPSHOT].Visible = true;
            //    m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_INSTANT_PLAYBACK].Visible = true;
            //    m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_ADD_FREE_TEXT].Visible = true;
            //    m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_VMD_TRIGGERS].Visible = true;
            //    m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_CAMERA_INFO].Visible = true;
            //    m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_CLOSE_ALL_CAMERAS].Visible = true;
            //    m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_MIN_MAX].Visible = true;
            //    m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Visible = true;
            //    m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Visible = true;
            //    m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_PRESETS].Visible = true;
            //    m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_PRESETS].Enabled = DisplayManager_DisplayIsPtz(iDisplayIndex);

            //    m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_PRESETS].MenuItems.Clear();
            //    if (m_PresetsMenuItem != null)
            //    {
            //        m_DvrTreeContextMenu.MenuItems[m_iNumberOfDvrs + DvrClientConstants.CONTEXT_MENU_PRESETS].MenuItems.AddRange(m_PresetsMenuItem);
            //    }

            //    HideSurroundingFrame(iDisplayIndex, sMethod);
            //    ShowSurroundingFrame(iDisplayIndex, color, sMethod);

            //    SetVideoPlayerFocus(iDisplayIndex);

            //    ////ChangeTransparentLocationAndSize(vp[iDisplayIndex].Top,
            //    ////                                 vp[iDisplayIndex].Left,
            //    ////                                 vp[iDisplayIndex].Width,
            //    ////                                 vp[iDisplayIndex].Height,
            //    ////                                 sMethod);
            //    ////overTransparent.Visible = true;

            //    //Audit("[Change Display Mode] Top:" +
            //    //      overTransparent.Top + " Left:" +
            //    //      overTransparent.Left + " Width:" +
            //    //      overTransparent.Width + " Height:" +
            //    //      overTransparent.Height,
            //    //      sMethod); 
            //}
            //catch (Exception ex)
            //{
            //    Audit(ex.Message, sMethod, AuditSeverity.Error);
            //}          
        }

        private void SetVideoPlayerFocus(int iDisplay)
        {
            #region Data Members

            int iCameraNumber;
            int iDvrId;
            //int iWholeIntervalSeconds;
            //int iInterval;
            //int iEventInterval;
            //int iEvent;

            string sDisplayDescription;
            string sPreset;
            //string sTriggerSource;
            string sServerName;
            string sCameraName;
            string sFromTime;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            List<string> lsPreset;

            //DateTime dtTriggerCreationTime;

            #endregion

            try
            {
                if ((iDisplay < 0) || (iDisplay >= m_Settings.MaxDisplaysNumber))
                {
                    Audit("Reached Function With Illegal Display Number[" + (iDisplay + 1) + "]", 
                          sMethod,
                          AuditSeverity.Warning);

                    return;
                }

                if (DisplayManager_DisplayIsFree(iDisplay))
                {
                    Audit("Focusing On An Empty Display. Display[" +
                          iDisplay.ToString() +
                          "] Is Free.",
                          sMethod,
                          AuditSeverity.Information);
                    DisplayDescription("");
                    EventMessage("");

                    return;
                }

                Audit("Focus On Display[" + (iDisplay + 1) + "]", sMethod, AuditSeverity.Information);

                if (!m_Settings.HidePtzButtons)
                {
                    CamerasTreeHeight(243);
                }

                if (!m_bFullScreenMode)
                {
                    CloseButtonVisible(true);
                    //btnDigitalZoom.Visible = true;
                    if (DisplayManager_DisplayDigitalZoomMode(iDisplay))
                    {
                        btnDigitalZoom.Image = Afcon.DvrClient.Control.Properties.Resources.Digital_Zoom_Normal;
                        btnDigitalZoom.Text = (m_Settings.Language == Language.Hebrew) ? " " : "Unzoom";
                        btnDigitalZoom.ToolTipText = (m_Settings.Language == Language.Hebrew) ? " " : "Unzoom";
                    }
                    else
                    {
                        btnDigitalZoom.Image = Afcon.DvrClient.Control.Properties.Resources.Digital_Zoom;
                        btnDigitalZoom.Text = (m_Settings.Language == Language.Hebrew) ? " " : "Digital Zoom";
                        btnDigitalZoom.ToolTipText = (m_Settings.Language == Language.Hebrew) ? " " : "Digital Zoom";
                    }
                    PtzGUI(DisplayManager_DisplayIsPtz(iDisplay));
                }

                DisplayManager_SetActiveDisplayIndex(iDisplay);

                #region Get Presets For This Display

                if (DisplayManager_DisplayIsPtz(iDisplay) && (DisplayManager_DisplayActivation(iDisplay) == ActivationType.LiveVideo))
                {
                    //Array presets = null;

                    if (!m_bFullScreenMode)
                    {
                        gbPresets.Visible = true;
                        //gbCurrentPreset.Visible = true;
                        lblCurrentPreset.Text = ""; 
                    }

                    if ((iDisplay == DvrClientConstants.NONE) || (iDisplay >= m_Settings.MaxDisplaysNumber))
                    {
                        Audit("Bad Index [" + (iDisplay + 1) + "] For PTZ Array", sMethod, AuditSeverity.Warning);

                        return;
                    }

                    //if (m_PlayerPTZ == null)
                    //{
                    //    Audit("PTZ Player Array Is Null", sMethod, AuditSeverity.Warning);

                    //    return;
                    //}
                    
                    //try
                    //{
                    //    //PCompStatus status = GetAllPresets(iDisplay, out presets);
                    //    //if (status != PCompStatus.PCompStatus_Ok)
                    //    //{
                    //    //    Audit("Failed Getting Presets For Display[" +
                    //    //          (iDisplay + 1) +
                    //    //          "] Camera[" +
                    //    //          DisplayManager_DisplayCameraName(iDisplay) +
                    //    //          "] On DVR[" +
                    //    //          DisplayManager_DisplaySiteName(iDisplay) + "]. " + status.ToString(),
                    //    //          sMethod, 
                    //    //          AuditSeverity.Warning);
                    //    //}
                    //}
                    //catch (Exception e)
                    //{
                    //    Audit("Failed Getting All Presets With Display Number[" + (iDisplay + 1) + "]. " + e.Message,
                    //          sMethod, 
                    //          AuditSeverity.Warning); ;
                    //}

                    //if (presets == null)
                    //{
                    //    Audit("No Presets For Display[" +
                    //          (iDisplay + 1) +
                    //          "] Camera[" +
                    //          DisplayManager_DisplayCameraName(iDisplay) +
                    //          "] On DVR[" +
                    //          DisplayManager_DisplaySiteName(iDisplay) + "]",
                    //          sMethod,
                    //          AuditSeverity.Information);
                    //}
                    //else
                    //{
                    //    Audit(presets.Length + " Presets For Display[" +
                    //          (iDisplay + 1) +
                    //          "] Camera[" +
                    //          DisplayManager_DisplayCameraName(iDisplay) +
                    //          "] On DVR[" +
                    //          DisplayManager_DisplaySiteName(iDisplay) + "]",
                    //          sMethod, 
                    //          AuditSeverity.Information);
                    //}

                    // Populate the presets list
                    cboDvrPresets.DisplayMember = "PresetName";
                    cboDvrPresets.ValueMember = "PresetId";
                    cboDvrPresets.Items.Clear();
                    PopulatePresetsList(out lsPreset);

                    if (lsPreset != null)
                    {
                        int l;
                        int iNumberOfThisCameraPresets = lsPreset.Count;

                        if (iNumberOfThisCameraPresets > 0)
                        {
                            m_PresetsMenuItem = new MenuItem[iNumberOfThisCameraPresets];

                            for (l = 0; l < iNumberOfThisCameraPresets; l++)
                            {
                                m_PresetsMenuItem[l] = new MenuItem();
                            }
                        }
                        else
                        {
                            m_PresetsMenuItem = null;
                        }

                        l = 0;
                        foreach (string sCurrentPreset in lsPreset)
                        {

                            if (iNumberOfThisCameraPresets > 0)
                            {
                                m_PresetsMenuItem[l].Index = l;
                                m_PresetsMenuItem[l].Text = sCurrentPreset;
                                m_PresetsMenuItem[l].Tag = sCurrentPreset;
                                m_PresetsMenuItem[l].Click += new EventHandler(presetsMenuItem_Click);

                                l++;
                            }
                        }
                    }
                    //    if (cboDvrPresets.Items.Count > 0)
                    //    {
                    //        cboDvrPresets.Text = ((Types.PresetItem)(cboDvrPresets.Items[0])).PresetName;
                    //    }
                    //}
                }
                else
                {
                    gbPresets.Visible = false;
                    gbCurrentPreset.Visible = false;
                }

                #endregion

                //sServerName = DisplayManager_DisplaySiteName(iDisplay);
                sCameraName = DisplayManager_DisplayCameraName(iDisplay);
                sFromTime = DisplayManager_DisplayPlaybackStart(iDisplay).ToString();
                iCameraNumber = DisplayManager_DisplayCameraNumber(iDisplay);
                iDvrId = DisplayManager_DisplayDvrId(iDisplay);
                sServerName = GetLoggerIP(iDvrId);
                if (iCameraNumber != DvrClientConstants.NONE)
                {
                    if (DisplayManager_DisplayActivation(iDisplay) == ActivationType.LiveVideo)
                    {
                        sDisplayDescription = "DVR: " + sServerName +
                                              "  Camera: (" + iCameraNumber + ") " + sCameraName;

                        sPreset = DisplayManager_DisplayPreset(iDisplay);

                        if (!string.IsNullOrEmpty(sPreset))
                        {
                            lblCurrentPreset.Text = sPreset;
                        }
                        DisplayDescription(sDisplayDescription);

                        if (!m_bFullScreenMode)
                        {
                            if (DisplayManager_DisplayIsPtz(iDisplay))
                            {
                                if (m_Settings.HidePtzButtons == false)
                                {
                                    gbPTZ.Visible = true;
                                    gbPlayback.Visible = true;
                                }
                                else
                                {
                                    gbPTZ.Visible = false;
                                    gbPlayback.Visible = false;
                                }
                            }
                            else
                            {
                                gbPTZ.Visible = false;
                                gbPlayback.Visible = false;
                                CamerasTreeHeight(m_DisplayInfo.D1_Hight);
                            }
                        }
                        gbPlayback.Visible = false;
                        gbSmallPlayback.Visible = false;
                    }
                    else
                    {
                        DisplayDescription("PLAYBACK on DVR: " +
                                           sServerName +
                                           "  Camera: (" +
                                           iCameraNumber.ToString() +
                                           ") " +
                                           sCameraName +
                                           " From " +
                                           sFromTime);

                        if (!m_bFullScreenMode)
                        {
                            if ((m_Settings.HidePtzButtons) && (m_Settings.HideTree))
                            {
                                gbPlayback.Visible = false;
                                gbSmallPlayback.Visible = true;
                                pbEvent.Visible = false;
                                //dtTriggerCreationTime = DisplayManager_DisplayTriggerCreationTime(iDisplay);

                                //if (dtTriggerCreationTime == InitialDefaultTime())
                                //{
                                //    pbEvent.Visible = false;
                                //}
                                //else
                                //{
                                //    tsEvent = dtTriggerCreationTime - DisplayManager_DisplayPlaybackStart(iDisplay);
                                //    iWholeIntervalSeconds = DisplayManager_DisplayPlaybackDuration(iDisplay);
                                //    iEvent = tsEvent.Hours * 3600 + tsEvent.Minutes * 60 + tsEvent.Seconds;

                                //    float fEvent = (float)iEvent / (float)iWholeIntervalSeconds;

                                //    float fEventInterval = fEvent * (float)(trackSmallBarPlayPosition.Width);
                                //    iEventInterval = (int)fEventInterval;

                                //    iInterval = iWholeIntervalSeconds / 100;
                                    
                                //    iEventInterval = (iEvent * 100) / iWholeIntervalSeconds + 1;
                                //    pbEvent.Visible = true;

                                //    pbEvent.Tag = (object)fEvent;

                                //    int iLeft = trackSmallBarPlayPosition.Left -
                                //                (pbEvent.Width / 2) +
                                //                iEventInterval;
                                //    pbEvent.Left = iLeft;

                                //    sTriggerSource = DisplayManager_DisplayTriggerSource(iDisplay);
                                //    ttTriggerEvent.SetToolTip(pbEvent, 
                                //                              sTriggerSource + ": " + dtTriggerCreationTime.ToString());
                                //}    
                            }
                            else
                            {                               
                                if (m_Settings.HidePtzButtons)
                                {
                                    gbPlayback.Visible = false;
                                    gbSmallPlayback.Visible = true;
                                    //dtTriggerCreationTime = DisplayManager_DisplayTriggerCreationTime(iDisplay);

                                    //if (dtTriggerCreationTime == InitialDefaultTime())
                                    //{
                                    //    pbEvent.Visible = false;
                                    //}
                                    //else
                                    //{
                                    //    tsEvent = dtTriggerCreationTime - DisplayManager_DisplayPlaybackStart(iDisplay);
                                    //    iWholeIntervalSeconds = DisplayManager_DisplayPlaybackDuration(iDisplay);
                                    //    iInterval = iWholeIntervalSeconds / 100;
                                    //    iEvent = tsEvent.Hours * 3600 + tsEvent.Minutes * 60 + tsEvent.Seconds;
                                    //    iEventInterval = (iEvent * 100) / iWholeIntervalSeconds + 1;
                                    //    pbEvent.Visible = true;
                                    //    pbEvent.Tag = (object)iEventInterval;
                                    //    pbEvent.Left = trackSmallBarPlayPosition.Left -
                                    //                   (pbEvent.Width / 2) +
                                    //                   ((trackSmallBarPlayPosition.Width * iEventInterval) / 100);
                                    //    sTriggerSource = DisplayManager_DisplayTriggerSource(iDisplay);
                                    //    ttTriggerEvent.SetToolTip(pbEvent, 
                                    //                              sTriggerSource + ": " + dtTriggerCreationTime.ToString()); 
                                    //} 
                                }
                                else
                                {
                                    CamerasTreeHeight(243);

                                    gbPlayback.Visible = true;
                                    gbSmallPlayback.Visible = false;
                                }
                            }
                        }
                        gbPTZ.Visible = false;
                        gbPlayback.Visible = false;
                    }

                    if (!m_bFullScreenMode)
                    {
                        lblEventMessage.ForeColor = Utils.GetColorByColorNumber(DisplayManager_DisplayColorNumber(iDisplay));
                        EventMessage(DisplayManager_DisplayEventString(iDisplay));
                    }
                }
                else
                {
                    DisplayDescription("Could Not Read From AMS Camera Number For " +
                                       "DVR: " +
                                       sServerName +
                                       " Camera: " +
                                       sCameraName);
                }
            }
            catch (Exception e)
            {
                Audit("Failed With Display Number[" + (iDisplay + 1) + "]. " + e.Message, 
                      sMethod, 
                      AuditSeverity.Error);
            }
        }        

        #endregion

        #region Surrounding Frame

        private void Line(DvrClientPoint pPoint1, DvrClientPoint pPoint2, Color cColor)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            Graphics grHiveIndication;
            System.Drawing.Pen linePen = new System.Drawing.Pen(cColor);
            linePen.Width = 2 * PEN_WIDTH;

            grHiveIndication = this.CreateGraphics();

            grHiveIndication.DrawLine(linePen, pPoint1.X, pPoint1.Y, pPoint2.X, pPoint2.Y);
            linePen.Dispose();

            //Audit("Line From(" + x1 + "," + y1 + ") To(" + x2 + "," + y2 + "). " + color.ToString(), sMethod);
        }

        private void Box(DvrClientPoint pPoint1, DvrClientPoint pPoint2, Color cColor)
        {
            Line(new DvrClientPoint(pPoint1.X, pPoint1.Y),
                 new DvrClientPoint(pPoint2.X, pPoint1.Y),
                 cColor);
            Line(new DvrClientPoint(pPoint1.X, pPoint1.Y),
                 new DvrClientPoint(pPoint1.X, pPoint2.Y),
                 cColor);
            Line(new DvrClientPoint(pPoint2.X, pPoint1.Y),
                 new DvrClientPoint(pPoint2.X, pPoint2.Y),
                 cColor);
            Line(new DvrClientPoint(pPoint1.X, pPoint2.Y),
                 new DvrClientPoint(pPoint2.X, pPoint2.Y),
                 cColor);
        }

        private void Line(int x1, int y1, int x2, int y2, Color color)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            System.Drawing.Pen linePen = new System.Drawing.Pen(color);
            linePen.Width = PEN_WIDTH;

            m_FameGraphics = this.CreateGraphics();

            m_FameGraphics.DrawLine(linePen, x1, y1, x2, y2);
            linePen.Dispose();

            //Audit("Line From(" + x1 + "," + y1 + ") To(" + x2 + "," + y2 + "). " + color.ToString(), sMethod);
        }

        private void ShowSurroundingFrame(int iDisplayIndex, Color cColor, string sCalledFrom)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            try
            {
                if (DisplayManager_DisplayIsFree(iDisplayIndex))
                {
                    return;
                }

                if (m_SurroundingFrame.Visible)
                {
                    AuditPerform("Called From[" + sCalledFrom +
                                 "] For Display[" + (iDisplayIndex + 1) + "]. Already Visible. Exiting ...",
                                 sMethod,
                                 AuditSeverity.Warning);

                    return;
                }

                //if (!m_SurroundingFrame.IsCleared)
                //{
                //    AuditPerform("Called From[" + sCalledFrom + 
                //                 "] For Display[" + (iDisplayIndex + 1) + "]. Was Not Resetted. Exiting ...", 
                //                 sMethod, 
                //                 AuditSeverity.Warning);

                //    return;
                //}

                m_SurroundingFrame.TopLeftPoint = new DvrClientPoint(vp[iDisplayIndex].Left - PEN_WIDTH,
                                                                     vp[iDisplayIndex].Top - PEN_WIDTH);

                m_SurroundingFrame.BottomRightPoint = new DvrClientPoint(vp[iDisplayIndex].Left + vp[iDisplayIndex].Width + PEN_WIDTH,
                                                                         vp[iDisplayIndex].Top + vp[iDisplayIndex].Height + PEN_WIDTH);

                m_SurroundingFrame.Color = cColor;
                if (!m_SurroundingFrame.SetDisplayIndex(iDisplayIndex, out sResult))
                {
                    AuditPerform("Failed Set Index Display[" + (iDisplayIndex + 1) +
                                                    "]. " + sResult,
                                                    sMethod,
                                                    AuditSeverity.Warning);
                }
                else 
                {
                    AuditPerform("Set Index Display To[" + (iDisplayIndex + 1) + "].",
                                 sMethod,
                                 AuditSeverity.Information);
                }                    

                Box(m_SurroundingFrame.TopLeftPoint,
                    m_SurroundingFrame.BottomRightPoint,
                    m_SurroundingFrame.Color);

                if (!m_SurroundingFrame.SetVisible(iDisplayIndex, true, out sResult))
                {
                    AuditPerform("Failed Set Surrounding Display[" + iDisplayIndex + 
                                 "] To Visible. " + sResult, 
                                 sMethod, 
                                 AuditSeverity.Warning);
                }
                else
                {
                    AuditPerform(sResult, sMethod, AuditSeverity.Information);
                }

                AuditPerform("Called From[" + sCalledFrom +
                             "] For Display[" + (iDisplayIndex + 1) +
                             "]. Show Frame " + m_SurroundingFrame.TopLeftPoint.Print() +
                             ", " + m_SurroundingFrame.BottomRightPoint.Print() +
                              " Color[" + m_SurroundingFrame.Color.ToString() + "]",
                             sMethod,
                             AuditSeverity.Information);

                //DoEvents();
            }
            catch (Exception e)
            {
                AuditPerform("Called From[" + sCalledFrom + 
                             "] For Diplay[" + (iDisplayIndex + 1) +
                             "]. " + e.Message, 
                             sMethod, 
                             AuditSeverity.Error);
            }
        }

        private void HideSurroundingFrame(string sCalledFrom)
        {
            HideSurroundingFrame(DvrClientConstants.NONE, sCalledFrom);
        }

        private void HideSurroundingFrame(int iDisplayIndex, string sCalledFrom)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            #endregion

            try
            {
                if (!m_SurroundingFrame.Visible)
                {
                    AuditPerform("Called From[" + sCalledFrom + "]. Not Visible. Exiting ...", sMethod, AuditSeverity.Warning);

                    return;
                }

                //if (DisplayManager_DisplayIsFree(iDisplayIndex))
                //{
                //    return;
                //}

                RePaintBackground();
                this.Invalidate();

                Box(m_SurroundingFrame.TopLeftPoint,
                    m_SurroundingFrame.BottomRightPoint,
                    m_SurroundingFrame.Color);

                m_SurroundingFrame.SetVisible(iDisplayIndex, false, out sResult);
                m_SurroundingFrame.Color = Color.White;
                m_SurroundingFrame.SetDisplayIndex(DvrClientConstants.NONE, out sResult);

                AuditPerform("Called From[" + sCalledFrom +
                             "]. Hide Display[" + (iDisplayIndex + 1) + "] Frame " + m_SurroundingFrame.TopLeftPoint.Print() +
                             ", " + m_SurroundingFrame.BottomRightPoint.Print() +
                             " Color[" + m_SurroundingFrame.Color.ToString() + "]",
                             sMethod,
                             AuditSeverity.Information);

                if (!m_SurroundingFrame.Reset(out sResult))
                {
                    AuditPerform("Failed ReSetting Surrounding Display[" + (iDisplayIndex + 1) +
                                 "]. " + sResult,
                                 sMethod,
                                 AuditSeverity.Warning);
                }
                else
                {
                    AuditPerform(sResult, sMethod, AuditSeverity.Information);
                }

                //DoEvents();
            }
            catch (Exception ex)
            {
                AuditPerform("Called From[" + sCalledFrom + "]. " + ex.Message, 
                             sMethod, 
                             AuditSeverity.Error);
            }
        }

        #endregion

        #region Transparent Form

        private void m_Transparent_DisableAll()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (m_Transparent == null)
            {
                return;
            }

            for (int i = 0; i < m_Transparent.Length; i++)
            {
                m_Transparent[i].Enabled = false;
            }

            Audit("All Transparent Displays Where Disabled", sMethod, AuditSeverity.Information);
        }

        private void m_Transparent_EnableAll()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_Transparent == null)
                {
                    return;
                }

                for (int i = 0; i < m_Transparent.Length; i++)
                {
                    m_Transparent[i].Enabled = true;
                }

                Audit("All Transparent Displays Where Enabled", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void ChangeTransparentLocationAndSize(int iDisplayIndex,
                                                      int iTop, 
                                                      int iLeft, 
                                                      int iWidth, 
                                                      int iHeight, 
                                                      string sCalledFrom)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                m_Transparent[iDisplayIndex].Top = iTop;
                m_Transparent[iDisplayIndex].Left = iLeft;
                m_Transparent[iDisplayIndex].Width = iWidth;
                m_Transparent[iDisplayIndex].Height = iHeight;

                Audit("Display[" + iDisplayIndex + 
                      "] Location(" + iLeft + "," + iTop +
                      ") Size(" + iWidth + "," + iHeight +
                      ") Called From:" + sCalledFrom,
                      sMethod, 
                      AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit("Failed Display[" + iDisplayIndex +
                      "] Location(" + iLeft + "," + iTop +
                      ") Size(" + iWidth + "," + iHeight +
                      ") Called From:" + sCalledFrom + ". " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        private void m_Transparent_DragEnter(object sender, DragEventArgs e)
        {
            //e.Effect = DragDropEffects.All;
            if (e.Data.GetDataPresent(typeof(VideoPlayerDragData)))
            {
                e.Effect = DragDropEffects.Copy;
            }
            else
            {
                e.Effect = DragDropEffects.None;
            }
        }

        private void m_Transparent_DragDrop(object sender, DragEventArgs e)
        {
            #region Data Members

            int iDroppedDisplayIndex;
            int iCurrentDisplayIndex;

            string sTag = "";
            string sMethod = MethodBase.GetCurrentMethod().Name;

            VideoPlayerDragData vpdd;

            #endregion

            try
            {
                iCurrentDisplayIndex = ((ctlTransparent)sender).TabIndex;

                if (e.Data.GetDataPresent(typeof(VideoPlayerDragData)))
                {
                    vpdd = (VideoPlayerDragData)(e.Data.GetData(typeof(VideoPlayerDragData)));

                    iDroppedDisplayIndex = vpdd.DisplayIndex;

                    if (iCurrentDisplayIndex == iDroppedDisplayIndex)
                    {
                        Audit("Dragging The Display Onto Itself",
                              sMethod,
                              AuditSeverity.Error);

                        return;
                    }

                    m_sDvrType = "";
                    m_sDvr = vpdd.SiteName;
                    m_sCameraNumber = vpdd.CameraNumber.ToString();
                    OnCameraSelected();

                    m_bStartCameraByClick = true;

                    Audit("Dropping Camera[" + vpdd.CameraNumber + " - " + vpdd.CameraName +
                          "] Of Dvr[" + vpdd.SiteName +
                          "] Vendor[" + vpdd.Vendor +
                          "] Dragged From[" + Utils.GetEnumDescription(vpdd.Source) +
                          "] To Display[" + (iCurrentDisplayIndex + 1) + "]",
                          sMethod,
                          AuditSeverity.Information);

                    switch (vpdd.Source)
                    {
                        case DragedItemSource.VideoPlayer:
                            SwapDisplays(iCurrentDisplayIndex, iDroppedDisplayIndex);
                            break;


                        case DragedItemSource.CamerasTree:
                            //StartCamera_X_on_Display_Y(vpdd.SiteName,
                            //                           vpdd.CameraNumber,
                            //                           iCurrentDisplayIndex + 1,
                            //                           DvrClientConstants.NONE,
                            //                           "",
                            //                           true);
                            break;


                        default:
                            break;
                    }
                }
            }
            catch (Exception ex)
            {
                Audit("Failed With Tag[" + sTag + "]. " + ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void m_Transparent_MouseDown(object sender, MouseEventArgs e)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            
            int iDisplayIndex;

            #endregion

            try
            {
                iDisplayIndex = ((ctlTransparent)sender).TabIndex;

                DisplayManager_SetActiveDisplayIndex(iDisplayIndex);
                SetVideoPlayerFocus(iDisplayIndex);

                if (DisplayManager_GetActiveDisplayIndex() == DvrClientConstants.NONE)
                {
                    Audit("No Display In Focus", sMethod, AuditSeverity.Warning);

                    return;
                }

                if (DisplayManager_DisplayDigitalZoomMode(iDisplayIndex))
                {
                    m_Rectangle = new Rectangle(e.X, e.Y, 0, 0);
                    m_Transparent[iDisplayIndex].Invalidate();

                    return;
                }

                switch (m_WorkMode)
                {
                    case WorkMode.Operation:
                        #region Operation Mode

                        switch (e.Button)
                        {
                            case MouseButtons.Left:
                                #region Left Mouse Button

                                Direction direction = GetDirection(e.X, e.Y);

                                if (DisplayManager_DisplayIsPtz(iDisplayIndex) && 
                                    (DisplayManager_DisplayActivation(iDisplayIndex) == ActivationType.LiveVideo))
                                {
                                    switch (direction)
                                    {
                                        case Direction.Up:
                                            btnUp_Click(null, null);
                                            break;

                                        case Direction.Down:
                                            btnDown_Click(null, null);
                                            break;

                                        case Direction.Left:
                                            btnLeft_Click(null, null);
                                            break;

                                        case Direction.Right:
                                            btnRight_Click(null, null);
                                            break;

                                        case Direction.UpLeft:
                                            btnUpLeft_Click(null, null);
                                            break;

                                        case Direction.UpRight:
                                            btnUpRight_Click(null, null);
                                            break;

                                        case Direction.DownLeft:
                                            btnDownLeft_Click(null, null);
                                            break;

                                        case Direction.DownRight:
                                            btnDownRight_Click(null, null);
                                            break;

                                        case Direction.ZoomIn:
                                            btnZoomIn_Click(null, null);
                                            break;

                                        case Direction.ZoomOut:
                                            btnZoomOut_Click(null, null);
                                            break;

                                        default:
                                            break;
                                    }
                                }

                                #endregion
                                break;

                            case MouseButtons.Right:
                                #region Right Mouse Button

                                m_TreeViewContextMenuDisplayIndex = DisplayManager_GetActiveDisplayIndex() + 1;
                                Audit("Active Display " + m_TreeViewContextMenuDisplayIndex + " Clicked",
                                      sMethod, 
                                      AuditSeverity.Information);

                                m_Transparent[iDisplayIndex].ContextMenu = m_DvrTreeContextMenu;

                                if (DisplayManager_DisplayIsFree(iDisplayIndex))
                                {
                                    return;
                                }

                                //  Live Video or Playback
                                ActivationType at = DisplayManager_DisplayActivation(DisplayManager_GetActiveDisplayIndex());
                                switch (at)
                                {
                                    case ActivationType.LiveVideo:
                                        m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_SWITCH].Text =
                                            (m_Settings.Language == Language.Hebrew) ? " " : "Switch To Playback";
                                        break;

                                    case ActivationType.VideoOnDemand:
                                        m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_SWITCH].Text =
                                            (m_Settings.Language == Language.Hebrew) ? " " : "Switch To Live Video";
                                        m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_INSTANT_PLAYBACK + 1].Visible = false;
                                        break;

                                    default:
                                        break;
                                }

                                if (DisplayManager_GetSelectedDisplayModeOn())
                                {
                                    m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_MIN_MAX].Text = (m_Settings.Language == Language.Hebrew) ? "" : "Restore";
                                }
                                else
                                {
                                    m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_MIN_MAX].Text = (m_Settings.Language == Language.Hebrew) ? "" : "Maximize";
                                }

                                switch (triFullScreen)
	                            {
		                            case Trinar.False:
                                        m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Full Screen";
                                        break;
            
                                    case Trinar.True:
                                        m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Normal Screen";
                                        break;
            
                                    default:
                                        break;
	                            }

                                if (DisplayManager_DisplayDigitalZoomMode(iDisplayIndex))
                                {
                                    m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Digital Zoom Off"; ;
                                }
                                else
                                {
                                    m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Digital Zoom On";
                                }

                                #endregion
                                break;

                            default:
                                break;
                        }

                        #endregion
                        break;

                    case WorkMode.Drag:
                        #region Drag Mode

                        switch (e.Button)
                        {
                            case MouseButtons.Left:
                                m_Transparent[iDisplayIndex].ContextMenu = new ContextMenu();

                                Audit("Grabbed Camera[" + DisplayManager_DisplayCameraNumber(DisplayManager_GetActiveDisplayIndex()) +
                                      " - " + DisplayManager_DisplayCameraName(DisplayManager_GetActiveDisplayIndex()) +
                                      "] Of Dvr[" + DisplayManager_DisplaySiteName(DisplayManager_GetActiveDisplayIndex()) +
                                      "] Vendor[" + DisplayManager_DisplayVendorName(DisplayManager_GetActiveDisplayIndex()) +
                                      "] Source[" + Utils.GetEnumDescription(DragedItemSource.VideoPlayer) +
                                      "] Activation Type[" + Utils.GetEnumDescription(DisplayManager_DisplayActivation(DisplayManager_GetActiveDisplayIndex())) +
                                      "] At Display[" + (DisplayManager_GetActiveDisplayIndex() + 1) + "]",
                                      sMethod,
                                      AuditSeverity.Information);

                                DoDragDrop(new VideoPlayerDragData(DragedItemSource.VideoPlayer,
                                                                   DisplayManager_DisplayVendorName(DisplayManager_GetActiveDisplayIndex()),
                                                                   DisplayManager_DisplaySiteName(DisplayManager_GetActiveDisplayIndex()),
                                                                   DisplayManager_DisplayDvrGroupId(DisplayManager_GetActiveDisplayIndex()),
                                                                   DisplayManager_DisplayDvrId(DisplayManager_GetActiveDisplayIndex()),
                                                                   DisplayManager_DisplayCameraNumber(DisplayManager_GetActiveDisplayIndex()),
                                                                   DisplayManager_DisplayCameraName(DisplayManager_GetActiveDisplayIndex()),
                                                                   DisplayManager_GetActiveDisplayIndex(),
                                                                   DisplayManager_DisplayActivation(DisplayManager_GetActiveDisplayIndex())),
                                           DragDropEffects.Copy);
                                break;

                            default:
                                MessageBox.Show("You Are In Drag Mode. " +
                                                "\n" +
                                                "For Context Menu Functionality Switch To Operation Mode.",
                                                "Drag Mode Mesage",
                                                MessageBoxButtons.OK,
                                                MessageBoxIcon.Exclamation);
                                break;
                        }

                        #endregion
                        break;

                    default:
                        break;
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void m_Transparent_MouseUp(object sender, MouseEventArgs e)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;

            MultiTimerItem myItem;

            int iDisplayIndex;
            int iActiveDisplayIndex; 

            #endregion

            try
            {
                iDisplayIndex = ((ctlTransparent)sender).TabIndex;

                //if (DisplayManager_DisplayDigitalZoomMode(iDisplayIndex))
                //{
                //    tagRECT rect = new tagRECT();
                //    rect.top = m_Rectangle.Top;
                //    rect.left = m_Rectangle.Left;
                //    //rect.bottom = m_Rectangle.Bottom;
                //    rect.right = m_Rectangle.Right;

                //    m_PlayerDisplay[iDisplayIndex].ZoomToRect(rect);
                //}

                if (e.Button == MouseButtons.Left)
                {
                    #region Left Mouse Button

                    iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();
                    if (iActiveDisplayIndex == DvrClientConstants.NONE)
                    {
                        Audit("No Active Display Set", sMethod, AuditSeverity.Important);

                        return;
                    }

                    if (DisplayManager_DisplayIsPtz(iActiveDisplayIndex) && 
                        (DisplayManager_DisplayActivation(iActiveDisplayIndex) == ActivationType.LiveVideo))
                    {
                        btnUp_MouseUp(null, null);                        
                    }
                    else
                    {
                        Audit("No PTZ", sMethod, AuditSeverity.Important);

                        return;
                    }

                    if (m_PtzPreset == null)
                    {
                        btnUp_MouseUp(null, null);
                        Audit("No Ptz Presets Defined", sMethod, AuditSeverity.Important);

                        return;
                    }

                    for (int i = 0; i < m_PtzPreset.Count; i++)
                    {
                        int iDvrId = DisplayManager_DisplayDvrId(iActiveDisplayIndex);
                        int iCameraNumber = DisplayManager_DisplayCameraNumber(iActiveDisplayIndex);

                        if ((int.Parse(m_PtzPreset[i].Dvr) == iDvrId) &&
                            (m_PtzPreset[i].CameraNumber == iCameraNumber))
                        {
                            bool bRc;

                            int iFromHour;
                            int iFromMinute;
                            int iToHour;
                            int iToMinute;

                            string sError;

                            bRc = Utils.HourMinuteStringToTimeInterval(m_PtzPreset[i].From,
                                                                        m_PtzPreset[i].To,
                                                                        out iFromHour,
                                                                        out iFromMinute,
                                                                        out iToHour,
                                                                        out iToMinute,
                                                                        out sError);

                            if (bRc)
                            {
                                TimeInterval ti = new TimeInterval(iFromHour,
                                                                   iFromMinute,
                                                                   iToHour,
                                                                   iToMinute);
                                if (ti.IsInInterval(DateTime.Now.Hour, DateTime.Now.Minute))
                                {
                                    Audit("Perset[" + m_PtzPreset[i].Preset +
                                          "] Will Be Activated In " + m_PtzPreset[i].Delay +
                                          " Seconds",
                                          sMethod,
                                          AuditSeverity.Information);

                                    myItem = new MultiTimerItem(m_PtzPreset[i].Dvr,
                                                                m_PtzPreset[i].CameraNumber,
                                                                m_PtzPreset[i].Preset,
                                                                m_PtzPreset[i].Delay);
                                    m_MultiTimer.Add(myItem);
                                }
                            }
                            else
                            {
                                Audit(sError, sMethod, AuditSeverity.Warning);
                            }
                        }
                    }

                    btnUp_MouseUp(null, null);

                    #endregion
                }
            }
            catch (Exception ex)
            {
                AuditPerform(ex.Message, sMethod, AuditSeverity.Error);
            }
        }        

        private void m_Transparent_MouseMove(object sender, MouseEventArgs e)
        {
            #region Data Members

            bool bIsPtz;

            int iActiveDisplayIndex;

            ActivationType atActivationType;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                int iDisplayIndex = ((ctlTransparent)sender).TabIndex;

                //DisplayManager_SetActiveDisplayIndex(iDisplayIndex);

                if (DisplayManager_DisplayDigitalZoomMode(iDisplayIndex))
                {
                    if (e.Button == MouseButtons.Left)
                    {
                        m_Rectangle = new Rectangle(m_Rectangle.Left, 
                                                    m_Rectangle.Top, 
                                                    e.X - m_Rectangle.Left, 
                                                    e.Y - m_Rectangle.Top);
                        m_Transparent[iDisplayIndex].Invalidate();

                        Application.DoEvents();
                    }

                    return;
                }

                bIsPtz = DisplayManager_DisplayIsPtz(iDisplayIndex);
                atActivationType = DisplayManager_DisplayActivation(iDisplayIndex);
                iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();

                if (atActivationType == ActivationType.VideoOnDemand)
                {
                    return;
                }

                if (m_WorkMode == WorkMode.Drag)
                {
                    return;
                }

                if (!bIsPtz)
                {
                    return;
                }

                if (iActiveDisplayIndex == DvrClientConstants.NONE)
                {
                    return;
                }

                Direction direction = GetDirection(e.X, e.Y);

                switch (direction)
                {
                    case Direction.Up:
                        this.Cursor = Cursors.PanNorth;
                        break;

                    case Direction.Down:
                        this.Cursor = Cursors.PanSouth;
                        break;

                    case Direction.Left:
                        this.Cursor = Cursors.PanWest;
                        break;

                    case Direction.Right:
                        this.Cursor = Cursors.PanEast;
                        break;

                    case Direction.UpLeft:
                        this.Cursor = Cursors.PanNW;
                        break;

                    case Direction.UpRight:
                        this.Cursor = Cursors.PanNE;
                        break;

                    case Direction.DownLeft:
                        this.Cursor = Cursors.PanSW;
                        break;

                    case Direction.DownRight:
                        this.Cursor = Cursors.PanSE;
                        break;

                    case Direction.ZoomIn:
                        this.Cursor = new Cursor(Afcon.DvrClient.Control.Properties.Resources.Zoom_In_Cursor.Handle);
                        break;

                    case Direction.ZoomOut:
                        this.Cursor = new Cursor(Afcon.DvrClient.Control.Properties.Resources.Zoom_Out_Cursor.Handle);
                        break;

                    default:
                        break;
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void m_Transparent_MouseDoubleClick(object sender, MouseEventArgs e)
        {
            //int iNumberOfDisplays;
            //int iDisplayIndex = ((ctlTransparent)sender).TabIndex;
            //int iSelectedDisplayIndex;
            //int iCameraNumber;

            //string sVendor;
            //string sDvr;
            //string sMethod = MethodBase.GetCurrentMethod().Name;

            //try
            //{
            //    switch (m_WorkMode)
            //    {
            //        case WorkMode.Operation:
            //            #region Operation Mode

            //            if (e.Button == MouseButtons.Left)
            //            {
            //                if (DisplayManager_GetMode() == DisplayFormatState.OneView)
            //                {
            //                    Audit("Selected Display Is In One-View Already.",
            //                          sMethod,
            //                          AuditSeverity.Warning);

            //                    return;
            //                }

            //                if (DisplayManager_GetActiveDisplayIndex() == DvrClientConstants.NONE)
            //                {
            //                    Audit("Trying To Select Display For Selected Display Mode Without Focus On A Display.",
            //                          sMethod,
            //                          AuditSeverity.Warning);

            //                    return;
            //                }
            //                else
            //                {
            //                    sVendor = DisplayManager_DisplayVendorName(DisplayManager_GetActiveDisplayIndex()).ToString();
            //                }

            //                if (DisplayManager_GetSelectedDisplayModeOn())
            //                {
            //                    iSelectedDisplayIndex = DisplayManager_GetSelectedDisplayIndex();

            //                    Audit("Restoring Selected Display Index[" + iSelectedDisplayIndex +
            //                          "] Width[" + DisplayManager_GetSelectedDisplaySize().Width +
            //                          "] Height[" + DisplayManager_GetSelectedDisplaySize().Height +
            //                          "] Location(" + DisplayManager_GetSelectedDisplayLocation().X +
            //                          "," + DisplayManager_GetSelectedDisplayLocation().Y + ")",
            //                          sMethod,
            //                          AuditSeverity.Information);

            //                    NiceVideoPlayerLocation(iSelectedDisplayIndex,
            //                                            DisplayManager_GetSelectedDisplayLocation().X,
            //                                            DisplayManager_GetSelectedDisplayLocation().Y);
            //                    NiceVideoPlayerSize(iSelectedDisplayIndex,
            //                                        DisplayManager_GetSelectedDisplaySize().Width,
            //                                        DisplayManager_GetSelectedDisplaySize().Height);

            //                    for (int i = 0; i < m_NotSelectedOpenDisplayIndex.Count; i++)
            //                    {
            //                        vp[m_NotSelectedOpenDisplayIndex[i]].Visible = true;
            //                    }
            //                    m_NotSelectedOpenDisplayIndex = new List<int>();

            //                    switch (m_DisplayInfo.State)
            //                    {
            //                        case DisplayState.FiveFourDown:
            //                        case DisplayState.FiveFourUp:
            //                            iNumberOfDisplays = 5;
            //                            break;

            //                        default:
            //                            iNumberOfDisplays = (int)(m_DisplayInfo.State);
            //                            break;
            //                    }

            //                    for (int i = 0; i < iNumberOfDisplays; i++)
            //                    {
            //                        if (vp[i].Visible)
            //                        {
            //                            m_Transparent[i].Size = vp[i].Size;

            //                            continue;
            //                        }

            //                        PictureVisible(i, true);
            //                    }

            //                    HideDisplayFrame();

            //                    DisplayManager_SetSelectedDisplayModeOn(false);

            //                    Audit("Selected Display[" + (DisplayManager_GetActiveDisplayIndex() + 1) +
            //                          "] Mode Off. Restore Former Displays.",
            //                          sMethod,
            //                          AuditSeverity.Information);
            //                }
            //                else
            //                {
            //                    if (DisplayManager_GetActiveDisplayIndex() == DvrClientConstants.NONE)
            //                    {
            //                        Audit("Trying To Select Display For Selected Display Mode Without Focus On A Display.",
            //                          sMethod,
            //                          AuditSeverity.Warning);

            //                        return;
            //                    }

            //                    if (m_Settings.EnableBackToOriginalViewByDblClk)
            //                    {
            //                        //  keep selected display's index, size and location
            //                        DisplayManager_SetSelectedDisplayLocation(NiceVideoPlayerLocation(iDisplayIndex));
            //                        DisplayManager_SetSelectedDisplaySize(NiceVideoPlayerSize(iDisplayIndex));
            //                        DisplayManager_SetSelectedDisplayIndex(iDisplayIndex);
            //                        Audit("Storing Selected Display Index[" + iDisplayIndex +
            //                              "] Width[" + DisplayManager_GetSelectedDisplaySize().Width +
            //                              "] Height[" + DisplayManager_GetSelectedDisplaySize().Height +
            //                              "] Location(" + DisplayManager_GetSelectedDisplayLocation().X +
            //                              "," + DisplayManager_GetSelectedDisplayLocation().Y + ")",
            //                              sMethod,
            //                              AuditSeverity.Information);

            //                        NiceVideoPlayerLocation(DisplayManager_GetActiveDisplayIndex(), START_X, START_Y);
            //                        NiceVideoPlayerSize(DisplayManager_GetActiveDisplayIndex(), D1_WIDTH, D1_HIGHT);

            //                        for (int i = 0; i < m_DisplayInfo.Displays; i++)
            //                        {
            //                            if (i == DisplayManager_GetActiveDisplayIndex())
            //                            {
            //                                continue;
            //                            }

            //                            if (vp[i].Visible)
            //                            {
            //                                m_NotSelectedOpenDisplayIndex.Add(i);
            //                                vp[i].Visible = false;

            //                                m_Transparent[i].Size = new Size(0, 0);
            //                            }

            //                            PictureVisible(i, false);
            //                        }

            //                        HideDisplayFrame();

            //                        DisplayManager_SetSelectedDisplayModeOn(true);

            //                        Audit("Selected Display[" + (DisplayManager_GetActiveDisplayIndex() + 1) +
            //                              "] Mode On. Current Displays Stored.",
            //                              sMethod,
            //                              AuditSeverity.Information);
            //                    }
            //                    else
            //                    {
            //                        sDvr = DisplayManager_DisplaySiteName(DisplayManager_GetActiveDisplayIndex());
            //                        iCameraNumber = DisplayManager_DisplayCameraNumber(DisplayManager_GetActiveDisplayIndex());
            //                        CloseAllCameras();
            //                        StartCamera(sDvr, iCameraNumber, DvrClientConstants.NONE, "", true);
            //                    }
            //                }
            //            }

            //            #endregion
            //            break;

            //        case WorkMode.Drag:
            //            break;

            //        default:
            //            break;
            //    }
            //}
            //catch (Exception ex)
            //{
            //    Audit(ex.Message, sMethod, AuditSeverity.Error);
            //}
        }

        private void m_Transparent_MouseEnter(object sender, EventArgs e)
        {
            #region Data Members
            
            bool bInstantPlaybackVisible;

            int iDisplayIndex;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            Color color;

            ActivationType atActivation;

            #endregion

            try
            {
                //m_Transparent_DisableAll();

                iDisplayIndex = ((ctlTransparent)sender).TabIndex;

                if ((iDisplayIndex < 0) || (iDisplayIndex >= DisplayManager_Displays()))
                {
                    AuditPerform("Problematic Display Index[" + (iDisplayIndex + 1) + "]",
                                 sMethod,
                                 AuditSeverity.Warning);

                    //m_Transparent_EnableAll();

                    return;
                }

                AuditPerform("Entered Display[" + (iDisplayIndex + 1) + "]", sMethod, AuditSeverity.Information);

                if (DisplayManager_DisplayIsFree(iDisplayIndex))
                {
                    AuditPerform("Entered A Free Display[" + (iDisplayIndex + 1) + "]",
                                 sMethod,
                                 AuditSeverity.Warning);

                    //m_Transparent_EnableAll();
                    ArrangeContextMenuForNoVideo();
                    CloseButtonVisible(false);

                    return;
                }

                CloseButtonVisible(true);
                atActivation = DisplayManager_DisplayActivation(iDisplayIndex);

                if (m_DvrTreeContextMenu == null)
                {
                    AuditPerform("Tree Context Menu Is Null",
                                 sMethod,
                                 AuditSeverity.Warning);

                    return;
                }

                switch (atActivation)
                {
                    case ActivationType.LiveVideo:
                        color = Color.Blue;
                        m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_SWITCH].Text =
                            (m_Settings.Language == Language.Hebrew) ? " " : "Switch To Playback";
                        bInstantPlaybackVisible = true;
                        break;

                    case ActivationType.VideoOnDemand:
                        color = Color.GreenYellow;
                        m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_SWITCH].Text =
                            (m_Settings.Language == Language.Hebrew) ? " " : "Switch To Live Video";
                        //UpdateTrackBarLimits();
                        //UpdateTrackBarValue();
                        bInstantPlaybackVisible = false;
                        break;

                    default:
                        color = Color.Red;
                        bInstantPlaybackVisible = false;
                        break;
                }

                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_PRE_DEFINED_VIEWS].MenuItems[m_PreDefinedView.Count].Visible =
                        (DisplayManager_ActiveDisplays() > 0) ? true : false;

                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_CLOSE].Visible = true;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_SWITCH].Visible = true;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_EXPORT].Visible = true;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_SNAPSHOT].Visible = true;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_INSTANT_PLAYBACK].Visible = bInstantPlaybackVisible;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_ADD_FREE_TEXT].Visible = false;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_VMD_TRIGGERS].Visible = false;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_CAMERA_INFO].Visible = true;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_CLOSE_ALL_CAMERAS].Visible = true;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_MIN_MAX].Visible = true;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Visible = false;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Visible = true;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_PRESETS].Visible = true;
                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_PRESETS].Enabled = DisplayManager_DisplayIsPtz(iDisplayIndex);

                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_PRESETS].MenuItems.Clear();
                if (m_PresetsMenuItem != null)
                {
                    m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_PRESETS].MenuItems.AddRange(m_PresetsMenuItem);
                }

                m_Transparent[iDisplayIndex].ContextMenu = m_DvrTreeContextMenu;

                switch (triFullScreen)
                {
                    case Trinar.False:
                        m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Full Screen";
                        break;

                    case Trinar.True:
                        m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Text = (m_Settings.Language == Language.Hebrew) ? " " : "Normal Screen";
                        break;

                    default:
                        break;
                }

                if (DisplayManager_DisplayDigitalZoomMode(iDisplayIndex))
                {
                    m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Digital Zoom Off"; ;
                }
                else
                {
                    m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Text = (m_Settings.Language == Language.Hebrew) ? "  " : "Digital Zoom On";
                }

                HideSurroundingFrame(iDisplayIndex, sMethod);                
                ShowSurroundingFrame(iDisplayIndex, color, sMethod);

                DisplayManager_SetSelectedDisplayIndex(iDisplayIndex); 
                
                //SetVideoPlayerFocus(iDisplayIndex);
                //m_Transparent_EnableAll();
            }
            catch (Exception ex)
            {
                m_Transparent_EnableAll();

                AuditPerform(ex.Message, sMethod, AuditSeverity.Error);
            }        
        }

        private void m_Transparent_MouseLeave(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                int iDisplayIndex;

                iDisplayIndex = ((ctlTransparent)sender).TabIndex;

                HideSurroundingFrame(iDisplayIndex, sMethod);

                this.Cursor = Cursors.Default;

                if (DisplayManager_DisplayIsPtz(iDisplayIndex))
                {
                    PtzStop();
                }

                AuditPerform("Leaving Display[" + (iDisplayIndex + 1) + "]", sMethod, AuditSeverity.Information);
            }
            catch (Exception ex)
            {
                AuditPerform(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void m_Transparent_Paint(object sender, PaintEventArgs e)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;

            int iDisplayIndex; 

            #endregion

            try
            {
                iDisplayIndex = ((ctlTransparent)sender).TabIndex;

                if (DisplayManager_DisplayDigitalZoomMode(iDisplayIndex))
                {
                    using (Pen pen = new Pen(Color.Blue, 0))
                    {
                        e.Graphics.DrawRectangle(pen, m_Rectangle);

                        Application.DoEvents();
                    }
                }
            }
            catch(Exception ex)
            {
                AuditPerform(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        #endregion

        #region Full Screen Stuff

        private bool FullScreen()
        {
            return FullScreen(false);
        }

        private bool FullScreen(bool bForceFullScreen)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;

            int iActiveDisplayIndex;
            int iFormWidth;
            int iFormHeight;

            #endregion

            try
            {
                Audit("Switching To Full Screen", sMethod, AuditSeverity.Important);

                if (DisplayManager_ActiveDisplays() == 0)
                {
                    Audit("Zero Active Displays", sMethod, AuditSeverity.Warning);

                    return false;
                }

                if (!bForceFullScreen)
                {
                    if (m_bFullScreenMode == true)
                    {
                        Audit("Already in Full Screen Mode", sMethod, AuditSeverity.Warning);

                        return false;
                    }
                }

                iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();
                if (iActiveDisplayIndex == DvrClientConstants.NONE)
                {
                    Audit("No Active Display", sMethod, AuditSeverity.Warning);

                    return false;
                }

                m_bFullScreenMode = true;                

                #region Hide Controls

                mnu.Visible = false;
                lblIP.Visible = false;
                lblActiveDisplays.Visible = false;
                lblActiveDisplay.Visible = false;
                lblCamera.Visible = false;
                tv.Visible = false;
                CloseButtonVisible(false);
                btnDigitalZoom.Visible = false;
                gbPlayback.Visible = false;
                gbSmallPlayback.Visible = false;
                gbPTZ.Visible = false;
                gbPresets.Visible = false;
                gbCurrentPreset.Visible = false;

                toolStripMain.Visible = false;
                stMain.Visible = false;

                #endregion

                m_DisplayInfo.StartX = 0 + GAP;
                m_DisplayInfo.StartY = 0 + GAP;
                m_iStartX = 0 + GAP;

                if (m_Settings.Mode == ActivationMode.Control)
                { 
                    iFormWidth = this.Width;
                    iFormHeight = this.Height;
                }
                else
                { 
                    iFormWidth = Screen.PrimaryScreen.Bounds.Width;
                    iFormHeight = Screen.PrimaryScreen.Bounds.Height;
                }

                //this.MaximumSize = new System.Drawing.Size(Screen.PrimaryScreen.Bounds.Width,
                //                                           Screen.PrimaryScreen.Bounds.Height);
                //this.Width = Screen.PrimaryScreen.Bounds.Width;
                //this.Height = Screen.PrimaryScreen.Bounds.Height;

                Audit("Screen Width: " + iFormWidth + " Screen Height: " + iFormHeight, 
                      sMethod, 
                      AuditSeverity.Information);

                #region Display State

                switch (m_DisplayInfo.State)
                {
                    case DisplayState.One:
                        m_DisplayInfo.D1_Hight = iFormHeight - 2 * GAP;
                        m_DisplayInfo.D1_Width = iFormWidth - 2 * GAP;

                        Switch2One();
                        break;

                    case DisplayState.Four:
                        m_DisplayInfo.D1_Hight = iFormHeight - 3 * GAP;
                        m_DisplayInfo.D1_Width = iFormWidth - 3 * GAP;

                        Switch2Quad();
                        break;

                    case DisplayState.Nine:
                        m_DisplayInfo.D1_Hight = iFormHeight - 4 * GAP;
                        m_DisplayInfo.D1_Width = iFormWidth - 4 * GAP;

                        Switch2Nine();
                        break;

                    case DisplayState.Sixteen:
                        m_DisplayInfo.D1_Hight = iFormHeight - 5 * GAP;
                        m_DisplayInfo.D1_Width = iFormWidth - 5 * GAP;

                        Switch2Sixteen();
                        break;

                    case DisplayState.TwentyFive:
                        m_DisplayInfo.D1_Hight = iFormHeight - 6 * GAP;
                        m_DisplayInfo.D1_Width = iFormWidth - 6 * GAP;

                        Switch2TwentyFive();
                        break;

                    case DisplayState.ThirtySix:
                        m_DisplayInfo.D1_Hight = iFormHeight - 7 * GAP;
                        m_DisplayInfo.D1_Width = iFormWidth - 7 * GAP;

                        Switch2ThirtySix();
                        break;

                    case DisplayState.SixOneBig:
                        m_DisplayInfo.D1_Hight = iFormHeight - 4 * GAP;
                        m_DisplayInfo.D1_Width = iFormWidth - 4 * GAP;

                        Switch2SixOneBig();
                        break;

                    case DisplayState.EightOneBig:
                        m_DisplayInfo.D1_Hight = iFormHeight - 5 * GAP;
                        m_DisplayInfo.D1_Width = iFormWidth - 5 * GAP;

                        Switch2EightOneBig();
                        break;

                    case DisplayState.ThirteenSurround:
                        m_DisplayInfo.D1_Hight = iFormHeight - 5 * GAP;
                        m_DisplayInfo.D1_Width = iFormWidth - 5 * GAP;

                        Switch2ThirteenSurround();
                        break;

                    case DisplayState.TenTwoQuads:
                        m_DisplayInfo.D1_Hight = iFormHeight - 5 * GAP;
                        m_DisplayInfo.D1_Width = iFormWidth - 5 * GAP;

                        Switch2TenTwoQuads();
                        break;

                    case DisplayState.FiveFourDown:
                        m_DisplayInfo.D1_Hight = iFormHeight - 5 * GAP;
                        m_DisplayInfo.D1_Width = iFormWidth - 5 * GAP;

                        Switch2FiveFourDown();
                        break;

                    case DisplayState.FiveFourUp:
                        m_DisplayInfo.D1_Hight = iFormHeight - 5 * GAP;
                        m_DisplayInfo.D1_Width = iFormWidth - 5 * GAP;

                        Switch2FiveFourUp();
                        break;

                    case DisplayState.TwoHorizontal:
                        m_DisplayInfo.D1_Hight = iFormHeight - 5 * GAP;
                        m_DisplayInfo.D1_Width = iFormWidth - 5 * GAP;

                        Switch2TwoHorizontal();
                        break;

                    case DisplayState.TwoVertical:
                        m_DisplayInfo.D1_Hight = iFormHeight - 5 * GAP;
                        m_DisplayInfo.D1_Width = iFormWidth - 5 * GAP;

                        Switch2TwoVertical();
                        break;

                    case DisplayState.None:
                    default:
                        break;
                } 

                #endregion
                
                //ChangeTransparentLocationAndSize(iActiveDisplayIndex,
                //                                 vp[iActiveDisplayIndex].Top,
                //                                 vp[iActiveDisplayIndex].Left,
                //                                 vp[iActiveDisplayIndex].Width,
                //                                 vp[iActiveDisplayIndex].Height,
                //                                 sMethod);                

                //NoVideoPictureOnEmptyDisplays();  
                
                return true;
            }
            catch (Exception e)
            {
                Audit("Full Screen Action Failed." + e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private void NormalScreen()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            int iActiveDisplayIndex;

            try
            {
                Audit("Switching To Normal Screen", sMethod, AuditSeverity.Important);

                if (!m_bFullScreenMode)
                {
                    return;
                }

                iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();
                if (iActiveDisplayIndex == DvrClientConstants.NONE)
                {
                    Audit("No Active Display", sMethod, AuditSeverity.Warning);

                    return;
                }

                m_DisplayInfo.StartX = m_DisplayInfo.InitialStartX;
                m_DisplayInfo.StartY = m_DisplayInfo.InitialStartY;
                m_DisplayInfo.D1_Hight = m_DisplayInfo.InitialD1_Hight;
                m_DisplayInfo.D1_Width = m_DisplayInfo.InitialD1_Width;

                m_iStartX = m_DisplayInfo.StartX;
                if (m_Settings.Language == Language.Hebrew)
                {
                    m_iStartX = 20;
                }
                else
                {
                    if (m_Settings.HidePtzButtons & m_Settings.HideTree)
                    {
                        m_iStartX = 20;
                    }
                    else
                    {
                        m_iStartX = 250;
                    }
                }

                m_bFullScreenMode = false;
                ArrangeDvrClientForm(sMethod);               

                #region Unhide Controls

                mnu.Visible = true;
                lblIP.Visible = true;
                if (m_Settings.ShowNumberOfActiveDisplays)
                {
                    lblActiveDisplays.Visible = true;
                    lblActiveDisplay.Visible = true; 
                }
                lblCamera.Visible = true;
                if (m_Settings.HideTree == false)
                {
                    tv.Visible = true;
                }

                toolStripMain.Visible = true;
                stMain.Visible = true;

                #endregion

                m_bChangingBackToNormalScreenMode = true;

                iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();
                ChangeTransparentLocationAndSize(iActiveDisplayIndex,
                                                 vp[iActiveDisplayIndex].Top,
                                                 vp[iActiveDisplayIndex].Left,
                                                 vp[iActiveDisplayIndex].Width,
                                                 vp[iActiveDisplayIndex].Height,
                                                 sMethod);

                this.Focus();
                this.Cursor = Cursors.Default;

                NoVideoPictureOnEmptyDisplays();
            }
            catch (Exception e)
            {
                Audit("Normal Screen Action Failed." + e.Message, sMethod, AuditSeverity.Error);
            }
        }

        #endregion

        #region 'No Video' Picture

        private void NoVideoPictureOnEmptyDisplays()
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;

            Image imgNoVideo; 

            #endregion

            Audit("Show 'No Video' Pictures", sMethod, AuditSeverity.Information);

            try
            {
                if (File.Exists(m_Settings.NoVideoPictureFilePath))
                {
                    imgNoVideo = Image.FromFile(m_Settings.NoVideoPictureFilePath);
                }
                else
                {
                    imgNoVideo = Afcon.DvrClient.Control.Properties.Resources.NoVideo1;
                }
            }
            catch (Exception e)
            {
                string s = e.Message;
                imgNoVideo = Afcon.DvrClient.Control.Properties.Resources.NoVideo1;
            }

            PictureOnEmptyDisplays(imgNoVideo);
        }

        private void LoadingPictureOnEmptyDisplays()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            Audit("Show 'Loading' Pictures", sMethod, AuditSeverity.Information);
            PictureOnEmptyDisplays(Afcon.DvrClient.Control.Properties.Resources.LoadingVideo);
        }

        private void PictureOnEmptyDisplays(Image imgImage)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;

            int i;
            int iMaxNumberOfDisplays;

            #endregion

            try
            {
                switch (m_DisplayInfo.State)
                {
                    case DisplayState.FiveFourUp:
                    case DisplayState.FiveFourDown:
                        iMaxNumberOfDisplays = 5;
                        break;

                    case DisplayState.TwoVertical:
                    case DisplayState.TwoHorizontal:
                        iMaxNumberOfDisplays = 2;
                        break;

                    default:
                        iMaxNumberOfDisplays = (int)m_DisplayInfo.State;
                        break;
                }

                for (i = 0; i < iMaxNumberOfDisplays; i++)
                {
                    if (DisplayManager_DisplayIsFree(i))
                    {
                        m_Picture[i].Name = string.Format("Picture{0}", i + 1);
                        m_Picture[i].Top = vp[i].Top;
                        m_Picture[i].Left = vp[i].Left;
                        m_Picture[i].Size = new System.Drawing.Size(vp[i].Width, vp[i].Height);
                        m_Picture[i].Image = imgImage;

                        vp[i].Visible = false;
                        //m_Transparent[i].Location = new Point(0, 0);
                        //m_Transparent[i].Size = new Size(0, 0); 

                        m_Transparent[i].Location = m_Picture[i].Location;
                        m_Transparent[i].Size = m_Picture[i].Size;


                        //m_Picture[i].Visible = true;
                        PictureVisible(i, true);

                        //Audit("Display[" +
                        //      (i + 1).ToString() +
                        //      "] Width[" +
                        //      m_Picture[i].Width.ToString() +
                        //      "] Height[" +
                        //      m_Picture[i].Height.ToString() +
                        //      "]", sMethod);
                    }
                    else
                    {
                        PictureVisible(i, false);

                        vp[i].Visible = true;
                        m_Transparent[i].Location = vp[i].Location;
                        m_Transparent[i].Size = vp[i].Size;

                        if (m_VideoLoss[i].Visible)
                        {
                            m_VideoLoss[i].Size = m_Transparent[i].Size;
                            m_VideoLoss[i].Location = m_Transparent[i].Location;
                        }
                    }

                    DoEvents();
                }
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void PictureVisible(int iIndex, bool bVisible)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                m_Picture[iIndex].Visible = bVisible;
            }
            catch (Exception e)
            {
                Audit("Failed Index[" + iIndex + "] Value[" + bVisible + "]. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);
            }
        }

        private void m_Picture_DragEnter(object sender, DragEventArgs e)
        {            
            //e.Effect = DragDropEffects.All;
            if (e.Data.GetDataPresent(typeof(VideoPlayerDragData)))
            {
                e.Effect = DragDropEffects.Copy;
            }
            else
            {
                e.Effect = DragDropEffects.None;
            }            
        }

        private void m_Picture_DragDrop(object sender, DragEventArgs e)
        {
            #region Data Members

            string sTag = "";
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sName = ((PictureBox)sender).Name;
            string sDisplay = sName.Substring(7, sName.Length - 7);

            int iDisplay = int.Parse(sDisplay);
            int iCameraNumberPosition = sTag.IndexOf("[CAMERANUMBER]") + 14;

            VideoPlayerDragData vpdd;

            #endregion

            try
            {
                if (e.Data.GetDataPresent(typeof(VideoPlayerDragData)))
                {
                    #region Dropped From Player

                    vpdd = (VideoPlayerDragData)(e.Data.GetData(typeof(VideoPlayerDragData)));

                    Audit("Dropping Camera[" + vpdd.Camera.CameraNumber + " - " + vpdd.Camera.Name +
                          "] Of Dvr[" + vpdd.SiteName +
                          "] Vendor[" + vpdd.Vendor +
                          "] Activation Type[" + Utils.GetEnumDescription(vpdd.ActivationType) +
                          "] Dragged From[" + Utils.GetEnumDescription(vpdd.Source) +
                          "] On Display[" + iDisplay + "]",
                          sMethod,
                          AuditSeverity.Information);

                    m_sDvrType = "";
                    m_sDvr = vpdd.SiteName;
                    m_sCameraNumber = vpdd.CameraNumber.ToString();
                    OnCameraSelected();

                    m_bStartCameraByClick = true;

                    switch (vpdd.ActivationType)
                    {
                        case ActivationType.LiveVideo:
                            StartCamera_X_on_Display_Y(vpdd.Camera,
                                                       iDisplay,
                                                       DvrClientConstants.NONE,
                                                       "",
                                                       true);
                            break;

                        case ActivationType.VideoOnDemand:
                            DateTime dtStartPlayback = DisplayManager_DisplayPlaybackStart(vpdd.DisplayIndex);
                            int iDuration = DisplayManager_DisplayPlaybackDuration(vpdd.DisplayIndex);

                            DoStopCamera(vpdd.DisplayIndex);
                            StartPlayback_on_Display_Y(vpdd.Camera,
                                                       DvrClientConstants.NONE,
                                                       dtStartPlayback,
                                                       iDisplay,
                                                       iDuration,
                                                       0,
                                                       0,
                                                       "",
                                                       true,
                                                       Utils.InitialDefaultTime(),
                                                       "");
                            break;

                        default:
                            break;
                    }

                    #endregion
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void m_Picture_MouseDown(object sender, MouseEventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            object oDisplayIndex;

            try
            {
                switch (m_WorkMode)
                {
                    case WorkMode.Operation:
                        #region Operation Mode

                        if (e.Button == MouseButtons.Right)
                        {
                            oDisplayIndex = ((PictureBox)(sender)).Tag;
                            m_TreeViewContextMenuDisplayIndex = (int)oDisplayIndex;
                            Audit("Empty Picture " + oDisplayIndex + " Clicked", sMethod, AuditSeverity.Information);

                            if (m_DvrTreeContextMenu == null)
                            {
                                Audit("Context Menu Is Null", sMethod, AuditSeverity.Warning);

                                return;
                            }

                            m_Picture[m_TreeViewContextMenuDisplayIndex - 1].ContextMenu = m_DvrTreeContextMenu;

                            for (int i = m_iNumberOfDvrs; i < m_iNumberOfDvrs + 3; i++)
                            {
                                m_DvrTreeContextMenu.MenuItems[i].Visible = false;
                            }

                            m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_EXPORT].Visible = false;
                            m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_SNAPSHOT].Visible = false;
                            m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_INSTANT_PLAYBACK].Visible = false;
                            m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_ADD_FREE_TEXT].Visible = false;
                            m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_VMD_TRIGGERS].Visible = false;
                            m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_CAMERA_INFO].Visible = false;
                            m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_MIN_MAX].Visible = false;
                            m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_DIGITAL_ZOOM_ON_OFF].Visible = false;
                            m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_FULL_NORMAL_SCREEN].Visible = false;
                            m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_PRESETS].Visible = false;

                            #region Close All Cameras Menu

                            if (DisplayManager_ActiveDisplays() > 0)
                            {
                                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_CLOSE_ALL_CAMERAS].Visible = true;
                            }
                            else
                            {
                                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_CLOSE_ALL_CAMERAS].Visible = false;
                            }

                            #endregion

                            #region Predefined Views Menu

                            int iPreDefinedViews = m_PreDefinedView.Count;
                            int iActiveDisplays = DisplayManager_ActiveDisplays();

                            if (iActiveDisplays > 0)
                            {
                                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_PRE_DEFINED_VIEWS].Visible = true;
                                m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_PRE_DEFINED_VIEWS].MenuItems[m_PreDefinedView.Count].Visible = true;
                            }
                            else
                            {
                                if (iPreDefinedViews > 0)
                                {
                                    m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_PRE_DEFINED_VIEWS].Visible = true;
                                    m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_PRE_DEFINED_VIEWS].MenuItems[m_PreDefinedView.Count].Visible = false;
                                }
                                else
                                {
                                    m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_PRE_DEFINED_VIEWS].Visible = false;
                                    m_DvrTreeContextMenu.MenuItems[DvrClientConstants.CONTEXT_MENU_PRE_DEFINED_VIEWS].MenuItems[m_PreDefinedView.Count].Visible = false;
                                }
                            }

                            #endregion
                        }
                        else
                        {
                            HideSurroundingFrame(sMethod);
                            CloseButtonVisible(false);
                            btnDigitalZoom.Visible = false;
                        }

                        #endregion
                        break;


                    case WorkMode.Drag:
                        oDisplayIndex = ((PictureBox)(sender)).Tag;
                        m_TreeViewContextMenuDisplayIndex = (int)oDisplayIndex;
                        m_Picture[m_TreeViewContextMenuDisplayIndex - 1].ContextMenu = new ContextMenu();
                        break;


                    default:
                        break;
                }

                
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error); ;
            }
        }

        private void m_Picture_MouseLeave(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            object oDisplayIndex;

            try
            {
                oDisplayIndex = ((PictureBox)(sender)).Tag;
                m_TreeViewContextMenuDisplayIndex = (int)oDisplayIndex;
                m_Picture[m_TreeViewContextMenuDisplayIndex - 1].ContextMenu = new ContextMenu();

                //Audit("Leaving 'No Video' [" + (m_TreeViewContextMenuDisplayIndex + 1) + "]", sMethod);
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error); ;
            }
        }

        #endregion

        #region Dimension Stuff Properties

        private int START_X
        {
            get
            {
                return m_iStartX;
            }

            set 
            {
                m_iStartX = value;
            }
        }

        private int START_Y
        {
            get
            {
                return m_DisplayInfo.StartY;
            }

            set
            {
                m_DisplayInfo.StartY = value;
            }
        }

        private int D1_WIDTH
        {
            get
            {
                return m_DisplayInfo.D1_Width;
            }

            set
            {
                m_DisplayInfo.D1_Width = value;
            }
        }

        private int D1_HIGHT
        {
            get
            {
                return m_DisplayInfo.D1_Hight;
            }

            set 
            {
                m_DisplayInfo.D1_Hight = value;
            }
        }

        private int D4_WIDTH
        {
            get
            {
                return D1_WIDTH / 2;
            }
        }

        private int D4_HIGHT
        {
            get
            {
                return D1_HIGHT / 2;
            }
        }

        private int D9_WIDTH
        {
            get
            {
                return D1_WIDTH / 3;
            }
        }

        private int D9_HIGHT
        {
            get
            {
                return D1_HIGHT / 3;
            }
        }

        private int D16_WIDTH
        {
            get
            {
                return D1_WIDTH / 4;
            }
        }

        private int D16_HIGHT
        {
            get
            {
                return D1_HIGHT / 4;
            }
        }

        private int D25_WIDTH
        {
            get
            {
                return D1_WIDTH / 5;
            }
        }

        private int D25_HIGHT
        {
            get
            {
                return D1_HIGHT / 5;
            }
        }

        private int D36_WIDTH
        {
            get
            {
                return D1_WIDTH / 6;
            }
        }

        private int D36_HIGHT
        {
            get
            {
                return D1_HIGHT / 6;
            }
        }

        private int GAP
        {
            get
            {
                return m_DisplayInfo.Gap;
            }

            set
            {
                m_DisplayInfo.Gap = value;
            }
        }

        private int PEN_WIDTH
        {
            get
            {
                return m_DisplayInfo.PenWidth;
            }

            set 
            {
                m_DisplayInfo.PenWidth = value;
            }
        }

        #endregion

        #region Display State Switch Functions

        private void Switch2None()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                HideSurroundingFrame(sMethod);

                #region Hide Unused Displays

                for (int i = 0; i < m_DisplayInfo.Displays; i++)
                {
                    vp[i].Visible = false;
                    VendorVideoPlayerSize(i, 0, 0);

                    PictureVisible(i, false);
                }

                #endregion

                m_DisplayInfo.State = DisplayState.One;
                DisplayManager_SetMode(DisplayFormatState.OneView);

                Audit("Switching To No View", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void Switch2One()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                HideSurroundingFrame(sMethod);

                #region Size & Location

                vp[0].Visible = true;
                VendorVideoPlayerLocation(0, START_X, START_Y);
                VendorVideoPlayerSize(0, D1_WIDTH, D1_HIGHT);

                #endregion

                #region Hide Unused Displays

                for (int i = 1; i < m_DisplayInfo.Displays; i++)
                {
                    vp[i].Visible = false;
                    VendorVideoPlayerSize(i, 0, 0);

                    PictureVisible(i, false);
                }

                #endregion

                m_DisplayInfo.State = DisplayState.One;
                DisplayManager_SetMode(DisplayFormatState.OneView);
                DisplayManager_SetActiveDisplayIndex(0);

                Audit("Switching To One View", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void Switch2Quad()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DisplayInfo.Displays < 4)
                {
                    Utils.Error("Only " + m_DisplayInfo.Displays + " Displays Defined. Can't Open Layout With 4 Displays.");

                    return;
                }

                HideSurroundingFrame(sMethod);

                #region Location

                VendorVideoPlayerLocation(0, START_X, START_Y);
                VendorVideoPlayerLocation(1, START_X + D4_WIDTH + GAP, START_Y);
                VendorVideoPlayerLocation(2, START_X, START_Y + D4_HIGHT + GAP);
                VendorVideoPlayerLocation(3, START_X + D4_WIDTH + GAP, START_Y + D4_HIGHT + GAP);

                #endregion

                #region Size

                for (int i = 0; i < 4; i++)
                {
                    vp[i].Visible = true;
                    VendorVideoPlayerSize(i, D4_WIDTH, D4_HIGHT);
                }

                #endregion

                #region Hide Unused Displays

                for (int i = 4; i < m_DisplayInfo.Displays; i++)
                {
                    vp[i].Visible = false;
                    VendorVideoPlayerSize(i, 0, 0);

                    PictureVisible(i, false);

                    Application.DoEvents();
                }

                #endregion

                m_DisplayInfo.State = DisplayState.Four;
                DisplayManager_SetMode(DisplayFormatState.QuadView);

                Audit("Switching To Four View", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void Switch2Nine()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DisplayInfo.Displays < 9)
                {
                    Utils.Error("Only " + m_DisplayInfo.Displays + " Displays Defined. Can't Open Layout With 9 Displays.");

                    return;
                }

                HideSurroundingFrame(sMethod);

                #region Size

                for (int i = 0; i < 9; i++)
                {
                    vp[i].Visible = true;
                    VendorVideoPlayerSize(i, D9_WIDTH, D9_HIGHT);

                    Application.DoEvents();
                }

                #endregion

                #region Location

                VendorVideoPlayerLocation(0, START_X, START_Y);
                VendorVideoPlayerLocation(1, START_X + D9_WIDTH + GAP, START_Y);
                VendorVideoPlayerLocation(2, START_X + 2 * (D9_WIDTH + GAP), START_Y);

                VendorVideoPlayerLocation(3, START_X, START_Y + D9_HIGHT + GAP);
                VendorVideoPlayerLocation(4, START_X + D9_WIDTH + GAP, START_Y + D9_HIGHT + GAP);
                VendorVideoPlayerLocation(5, START_X + 2 * (D9_WIDTH + GAP), START_Y + D9_HIGHT + GAP);

                VendorVideoPlayerLocation(6, START_X, START_Y + 2 * (D9_HIGHT + GAP));
                VendorVideoPlayerLocation(7, START_X + D9_WIDTH + GAP, START_Y + 2 * (D9_HIGHT + GAP));
                VendorVideoPlayerLocation(8, START_X + 2 * (D9_WIDTH + GAP), START_Y + 2 * (D9_HIGHT + GAP));

                #endregion

                #region Hide Unused Displays

                for (int i = 9; i < m_DisplayInfo.Displays; i++)
                {
                    vp[i].Visible = false;
                    VendorVideoPlayerSize(i, 0, 0);

                    PictureVisible(i, false);

                    Application.DoEvents();
                }

                #endregion

                m_DisplayInfo.State = DisplayState.Nine;
                DisplayManager_SetMode(DisplayFormatState.NineView);

                Audit("Switching To Nine View", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void Switch2Sixteen()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DisplayInfo.Displays < 16)
                {
                    Utils.Error("Only " + m_DisplayInfo.Displays + " Displays Defined. Can't Open Layout With 16 Displays.");

                    return;
                }

                HideSurroundingFrame(sMethod);

                #region Size

                for (int i = 0; i < 16; i++)
                {
                    vp[i].Visible = true;
                    VendorVideoPlayerSize(i, D16_WIDTH, D16_HIGHT);

                    Application.DoEvents();
                }

                #endregion

                #region Location

                VendorVideoPlayerLocation(0, START_X, START_Y);
                VendorVideoPlayerLocation(1, START_X + D16_WIDTH + GAP, START_Y);
                VendorVideoPlayerLocation(2, START_X + 2 * (D16_WIDTH + GAP), START_Y);
                VendorVideoPlayerLocation(3, START_X + 3 * (D16_WIDTH + GAP), START_Y);

                VendorVideoPlayerLocation(4, START_X, START_Y + D16_HIGHT + GAP);
                VendorVideoPlayerLocation(5, START_X + D16_WIDTH + GAP, START_Y + D16_HIGHT + GAP);
                VendorVideoPlayerLocation(6, START_X + 2 * (D16_WIDTH + GAP), START_Y + D16_HIGHT + GAP);
                VendorVideoPlayerLocation(7, START_X + 3 * (D16_WIDTH + GAP), START_Y + D16_HIGHT + GAP);

                VendorVideoPlayerLocation(8, START_X, START_Y + 2 * (D16_HIGHT + GAP));
                VendorVideoPlayerLocation(9, START_X + D16_WIDTH + GAP, START_Y + 2 * (D16_HIGHT + GAP));
                VendorVideoPlayerLocation(10, START_X + 2 * (D16_WIDTH + GAP), START_Y + 2 * (D16_HIGHT + GAP));
                VendorVideoPlayerLocation(11, START_X + 3 * (D16_WIDTH + GAP), START_Y + 2 * (D16_HIGHT + GAP));

                VendorVideoPlayerLocation(12, START_X, START_Y + 3 * (D16_HIGHT + GAP));
                VendorVideoPlayerLocation(13, START_X + D16_WIDTH + GAP, START_Y + 3 * (D16_HIGHT + GAP));
                VendorVideoPlayerLocation(14, START_X + 2 * (D16_WIDTH + GAP), START_Y + 3 * (D16_HIGHT + GAP));
                VendorVideoPlayerLocation(15, START_X + 3 * (D16_WIDTH + GAP), START_Y + 3 * (D16_HIGHT + GAP));

                #endregion

                #region Hide Unused Displays

                for (int i = 16; i < m_DisplayInfo.Displays; i++)
                {
                    vp[i].Visible = false;
                    VendorVideoPlayerSize(i, 0, 0);

                    PictureVisible(i, false);

                    Application.DoEvents();
                }

                #endregion

                m_DisplayInfo.State = DisplayState.Sixteen;
                DisplayManager_SetMode(DisplayFormatState.SixteenView);

                Audit("Switching To Sixteen View", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void Switch2TwentyFive()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                HideSurroundingFrame(sMethod);

                if (m_DisplayInfo.Displays < 25)
                {
                    Utils.Error("Only " + m_DisplayInfo.Displays + " Displays Defined. Can't Open Layout With 25 Displays.");

                    return;
                }

                #region Size

                for (int i = 0; i < 25; i++)
                {
                    vp[i].Visible = true;
                    VendorVideoPlayerSize(i, D25_WIDTH, D25_HIGHT);

                    Application.DoEvents();
                }

                #endregion

                #region Location

                VendorVideoPlayerLocation(0, START_X, START_Y);
                VendorVideoPlayerLocation(1, START_X + D25_WIDTH + GAP, START_Y);
                VendorVideoPlayerLocation(2, START_X + 2 * (D25_WIDTH + GAP), START_Y);
                VendorVideoPlayerLocation(3, START_X + 3 * (D25_WIDTH + GAP), START_Y);
                VendorVideoPlayerLocation(4, START_X + 4 * (D25_WIDTH + GAP), START_Y);

                VendorVideoPlayerLocation(5, START_X, START_Y + D25_HIGHT + GAP);
                VendorVideoPlayerLocation(6, START_X + D25_WIDTH + GAP, START_Y + D25_HIGHT + GAP);
                VendorVideoPlayerLocation(7, START_X + 2 * (D25_WIDTH + GAP), START_Y + D25_HIGHT + GAP);
                VendorVideoPlayerLocation(8, START_X + 3 * (D25_WIDTH + GAP), START_Y + D25_HIGHT + GAP);
                VendorVideoPlayerLocation(9, START_X + 4 * (D25_WIDTH + GAP), START_Y + D25_HIGHT + GAP);

                VendorVideoPlayerLocation(10, START_X, START_Y + 2 * (D25_HIGHT + GAP));
                VendorVideoPlayerLocation(11, START_X + D25_WIDTH + GAP, START_Y + 2 * (D25_HIGHT + GAP));
                VendorVideoPlayerLocation(12, START_X + 2 * (D25_WIDTH + GAP), START_Y + 2 * (D25_HIGHT + GAP));
                VendorVideoPlayerLocation(13, START_X + 3 * (D25_WIDTH + GAP), START_Y + 2 * (D25_HIGHT + GAP));
                VendorVideoPlayerLocation(14, START_X + 4 * (D25_WIDTH + GAP), START_Y + 2 * (D25_HIGHT + GAP));

                VendorVideoPlayerLocation(15, START_X, START_Y + 3 * (D25_HIGHT + GAP));
                VendorVideoPlayerLocation(16, START_X + D25_WIDTH + GAP, START_Y + 3 * (D25_HIGHT + GAP));
                VendorVideoPlayerLocation(17, START_X + 2 * (D25_WIDTH + GAP), START_Y + 3 * (D25_HIGHT + GAP));
                VendorVideoPlayerLocation(18, START_X + 3 * (D25_WIDTH + GAP), START_Y + 3 * (D25_HIGHT + GAP));
                VendorVideoPlayerLocation(19, START_X + 4 * (D25_WIDTH + GAP), START_Y + 3 * (D25_HIGHT + GAP));

                VendorVideoPlayerLocation(20, START_X, START_Y + 4 * (D25_HIGHT + GAP));
                VendorVideoPlayerLocation(21, START_X + D25_WIDTH + GAP, START_Y + 4 * (D25_HIGHT + GAP));
                VendorVideoPlayerLocation(22, START_X + 2 * (D25_WIDTH + GAP), START_Y + 4 * (D25_HIGHT + GAP));
                VendorVideoPlayerLocation(23, START_X + 3 * (D25_WIDTH + GAP), START_Y + 4 * (D25_HIGHT + GAP));
                VendorVideoPlayerLocation(24, START_X + 4 * (D25_WIDTH + GAP), START_Y + 4 * (D25_HIGHT + GAP));

                #endregion

                #region Hide Unused Displays

                for (int i = 25; i < m_DisplayInfo.Displays; i++)
                {
                    vp[i].Visible = false;
                    VendorVideoPlayerSize(i, 0, 0);

                    PictureVisible(i, false);

                    Application.DoEvents();
                }

                #endregion

                m_DisplayInfo.State = DisplayState.TwentyFive;
                DisplayManager_SetMode(DisplayFormatState.TwentyFiveView);

                Audit("Switching To Twenty Five View", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void Switch2ThirtySix()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DisplayInfo.Displays < 36)
                {
                    Utils.Error("Only " + m_DisplayInfo.Displays + " Displays Defined. Can't Open Layout With 36 Displays.");

                    return;
                }

                HideSurroundingFrame(sMethod);

                #region Size

                for (int i = 0; i < 36; i++)
                {
                    vp[i].Visible = true;
                    VendorVideoPlayerSize(i, D36_WIDTH, D36_HIGHT);

                    Application.DoEvents();
                }

                #endregion

                #region Location

                VendorVideoPlayerLocation(0, START_X, START_Y);
                VendorVideoPlayerLocation(1, START_X + D36_WIDTH + GAP, START_Y);
                VendorVideoPlayerLocation(2, START_X + 2 * (D36_WIDTH + GAP), START_Y);
                VendorVideoPlayerLocation(3, START_X + 3 * (D36_WIDTH + GAP), START_Y);
                VendorVideoPlayerLocation(4, START_X + 4 * (D36_WIDTH + GAP), START_Y);
                VendorVideoPlayerLocation(5, START_X + 5 * (D36_WIDTH + GAP), START_Y);

                VendorVideoPlayerLocation(6, START_X, START_Y + D36_HIGHT + GAP);
                VendorVideoPlayerLocation(7, START_X + D36_WIDTH + GAP, START_Y + D36_HIGHT + GAP);
                VendorVideoPlayerLocation(8, START_X + 2 * (D36_WIDTH + GAP), START_Y + D36_HIGHT + GAP);
                VendorVideoPlayerLocation(9, START_X + 3 * (D36_WIDTH + GAP), START_Y + D36_HIGHT + GAP);
                VendorVideoPlayerLocation(10, START_X + 4 * (D36_WIDTH + GAP), START_Y + D36_HIGHT + GAP);
                VendorVideoPlayerLocation(11, START_X + 5 * (D36_WIDTH + GAP), START_Y + D36_HIGHT + GAP);

                VendorVideoPlayerLocation(12, START_X, START_Y + 2 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(13, START_X + D36_WIDTH + GAP, START_Y + 2 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(14, START_X + 2 * (D36_WIDTH + GAP), START_Y + 2 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(15, START_X + 3 * (D36_WIDTH + GAP), START_Y + 2 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(16, START_X + 4 * (D36_WIDTH + GAP), START_Y + 2 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(17, START_X + 5 * (D36_WIDTH + GAP), START_Y + 2 * (D36_HIGHT + GAP));

                VendorVideoPlayerLocation(18, START_X, START_Y + 3 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(19, START_X + D36_WIDTH + GAP, START_Y + 3 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(20, START_X + 2 * (D36_WIDTH + GAP), START_Y + 3 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(21, START_X + 3 * (D36_WIDTH + GAP), START_Y + 3 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(22, START_X + 4 * (D36_WIDTH + GAP), START_Y + 3 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(23, START_X + 5 * (D36_WIDTH + GAP), START_Y + 3 * (D36_HIGHT + GAP));

                VendorVideoPlayerLocation(24, START_X, START_Y + 4 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(25, START_X + D36_WIDTH + GAP, START_Y + 4 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(26, START_X + 2 * (D36_WIDTH + GAP), START_Y + 4 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(27, START_X + 3 * (D36_WIDTH + GAP), START_Y + 4 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(28, START_X + 4 * (D36_WIDTH + GAP), START_Y + 4 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(29, START_X + 5 * (D36_WIDTH + GAP), START_Y + 4 * (D36_HIGHT + GAP));

                VendorVideoPlayerLocation(30, START_X, START_Y + 5 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(31, START_X + D36_WIDTH + GAP, START_Y + 5 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(32, START_X + 2 * (D36_WIDTH + GAP), START_Y + 5 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(33, START_X + 3 * (D36_WIDTH + GAP), START_Y + 5 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(34, START_X + 4 * (D36_WIDTH + GAP), START_Y + 5 * (D36_HIGHT + GAP));
                VendorVideoPlayerLocation(35, START_X + 5 * (D36_WIDTH + GAP), START_Y + 5 * (D36_HIGHT + GAP));

                #endregion

                #region Hide Unused Displays

                for (int i = 36; i < m_DisplayInfo.Displays; i++)
                {
                    vp[i].Visible = false;
                    VendorVideoPlayerSize(i, 0, 0);

                    Application.DoEvents();
                }

                #endregion

                m_DisplayInfo.State = DisplayState.ThirtySix;
                DisplayManager_SetMode(DisplayFormatState.ThirtySixView);

                Audit("Switching To Thirty Six View", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        #region Layouts

        private void Switch2SixOneBig()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DisplayInfo.Displays < 6)
                {
                    Utils.Error("Only " + m_DisplayInfo.Displays +
                                " Displays Defined. Can't Open Layout With 6 Displays.");

                    return;
                }

                HideSurroundingFrame(sMethod);

                #region Size

                vp[0].Visible = true;
                VendorVideoPlayerSize(0, (D9_WIDTH * 2), (D9_HIGHT * 2));

                for (int i = 1; i < 6; i++)
                {
                    vp[i].Visible = true;
                    VendorVideoPlayerSize(i, D9_WIDTH, D9_HIGHT);
                }

                #endregion

                #region Location

                VendorVideoPlayerLocation(0, START_X, START_Y);
                VendorVideoPlayerLocation(1, START_X + (D9_WIDTH * 2) + GAP, START_Y);
                VendorVideoPlayerLocation(2, START_X + (D9_WIDTH * 2) + GAP, START_Y + D9_HIGHT + GAP);

                VendorVideoPlayerLocation(3, START_X, START_Y + 2 * (D9_HIGHT + GAP));
                VendorVideoPlayerLocation(4, START_X + D9_WIDTH + GAP, START_Y + 2 * (D9_HIGHT + GAP));
                VendorVideoPlayerLocation(5, START_X + 2 * (D9_WIDTH + GAP), START_Y + 2 * (D9_HIGHT + GAP));

                #endregion

                #region Hide Unused Displays

                for (int i = 6; i < m_DisplayInfo.Displays; i++)
                {
                    vp[i].Visible = false;
                    VendorVideoPlayerSize(i, 0, 0);

                    PictureVisible(i, false);
                }

                #endregion

                m_DisplayInfo.State = DisplayState.SixOneBig;
                DisplayManager_SetMode(DisplayFormatState.SixOneBig);

                Audit("Switching To Six One-Big View", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void Switch2EightOneBig()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DisplayInfo.Displays < 8)
                {
                    Utils.Error("Only " + m_DisplayInfo.Displays +
                                " Displays Defined. Can't Open Layout With 8 Displays.");

                    return;
                }

                HideSurroundingFrame(sMethod);

                #region Size

                vp[0].Visible = true;
                VendorVideoPlayerSize(0, (D16_WIDTH * 3), (D16_HIGHT * 3));

                for (int i = 1; i < 8; i++)
                {
                    vp[i].Visible = true;
                    VendorVideoPlayerSize(i, D16_WIDTH, D16_HIGHT);
                }

                #endregion

                #region Loction

                VendorVideoPlayerLocation(0, START_X, START_Y);
                VendorVideoPlayerLocation(1, START_X + (D16_WIDTH * 3) + GAP, START_Y);
                VendorVideoPlayerLocation(2, START_X + (D16_WIDTH * 3) + GAP, START_Y + D16_HIGHT + GAP);
                VendorVideoPlayerLocation(3, START_X + (D16_WIDTH * 3) + GAP, START_Y + 2 * D16_HIGHT + GAP);

                VendorVideoPlayerLocation(4, START_X, START_Y + 3 * D16_HIGHT + GAP);
                VendorVideoPlayerLocation(5, START_X + D16_WIDTH + GAP, START_Y + 3 * D16_HIGHT + GAP);
                VendorVideoPlayerLocation(6, START_X + 2 * (D16_WIDTH + GAP), START_Y + 3 * D16_HIGHT + GAP);
                VendorVideoPlayerLocation(7, START_X + 3 * (D16_WIDTH + GAP), START_Y + 3 * D16_HIGHT + GAP);

                #endregion

                #region Hide Unused Displays

                for (int i = 8; i < m_DisplayInfo.Displays; i++)
                {
                    vp[i].Visible = false;
                    VendorVideoPlayerSize(i, 0, 0);

                    PictureVisible(i, false);
                }

                #endregion

                m_DisplayInfo.State = DisplayState.EightOneBig;
                DisplayManager_SetMode(DisplayFormatState.EightOneBig);

                Audit("Switching To Eight One-Big View", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void Switch2FiveFourUp()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DisplayInfo.Displays < 5)
                {
                    Utils.Error("Only " + m_DisplayInfo.Displays +
                                " Displays Defined. Can't Open Layout With 5 Displays.");

                    return;
                }

                HideSurroundingFrame(sMethod);

                #region Size

                for (int i = 0; i < 4; i++)
                {
                    vp[i].Visible = true;
                    VendorVideoPlayerSize(i, D16_WIDTH, D16_HIGHT);
                }

                vp[4].Visible = true;
                VendorVideoPlayerSize(4, (D16_WIDTH * 4), (D16_HIGHT * 3));

                #endregion

                #region Location

                VendorVideoPlayerLocation(0, START_X, START_Y);
                VendorVideoPlayerLocation(1, START_X + D16_WIDTH + GAP, START_Y);
                VendorVideoPlayerLocation(2, START_X + 2 * (D16_WIDTH + GAP), START_Y);
                VendorVideoPlayerLocation(3, START_X + 3 * (D16_WIDTH + GAP), START_Y);

                VendorVideoPlayerLocation(4, START_X, START_Y + D16_HIGHT + GAP);

                #endregion

                #region Hide Unused Displays

                for (int i = 5; i < m_DisplayInfo.Displays; i++)
                {
                    vp[i].Visible = false;
                    VendorVideoPlayerSize(i, 0, 0);

                    PictureVisible(i, false);
                }

                #endregion

                m_DisplayInfo.State = DisplayState.FiveFourUp;
                DisplayManager_SetMode(DisplayFormatState.FiveFourUp);

                Audit("Switching To Five Four-Up View", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void Switch2FiveFourDown()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DisplayInfo.Displays < 5)
                {
                    Utils.Error("Only " + m_DisplayInfo.Displays +
                                " Displays Defined. Can't Open Layout With 5 Displays.");

                    return;
                }

                HideSurroundingFrame(sMethod);

                #region Size

                vp[0].Visible = true;
                VendorVideoPlayerSize(0, (D16_WIDTH * 4), (D16_HIGHT * 3));

                for (int i = 1; i < 5; i++)
                {
                    vp[i].Visible = true;
                    VendorVideoPlayerSize(i, D16_WIDTH, D16_HIGHT);
                }

                #endregion

                #region Location

                VendorVideoPlayerLocation(0, START_X, START_Y);

                VendorVideoPlayerLocation(1, START_X, START_Y + 3 * (D16_HIGHT + GAP));
                VendorVideoPlayerLocation(2, START_X + D16_WIDTH + GAP, START_Y + 3 * (D16_HIGHT + GAP));
                VendorVideoPlayerLocation(3, START_X + 2 * (D16_WIDTH + GAP), START_Y + 3 * (D16_HIGHT + GAP));
                VendorVideoPlayerLocation(4, START_X + 3 * (D16_WIDTH + GAP), START_Y + 3 * (D16_HIGHT + GAP));

                #endregion

                #region Hide Unused Displays

                for (int i = 5; i < m_DisplayInfo.Displays; i++)
                {
                    vp[i].Visible = false;
                    VendorVideoPlayerSize(i, 0, 0);

                    PictureVisible(i, false);
                }

                #endregion

                m_DisplayInfo.State = DisplayState.FiveFourDown;
                DisplayManager_SetMode(DisplayFormatState.FiveFourDown);

                Audit("Switching To Five Four-Down View", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void Switch2ThirteenSurround()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DisplayInfo.Displays < 13)
                {
                    Utils.Error("Only " + m_DisplayInfo.Displays +
                                " Displays Defined. Can't Open Layout With 13 Displays.");

                    return;
                }

                HideSurroundingFrame(sMethod);

                #region Size

                vp[5].Visible = true;
                VendorVideoPlayerSize(5, (D16_WIDTH * 2), (D16_HIGHT * 2));

                for (int i = 0; i < 5; i++)
                {
                    vp[i].Visible = true;
                    VendorVideoPlayerSize(i, D16_WIDTH, D16_HIGHT);
                }

                for (int i = 6; i < 13; i++)
                {
                    vp[i].Visible = true;
                    VendorVideoPlayerSize(i, D16_WIDTH, D16_HIGHT);
                }

                #endregion

                #region Location

                VendorVideoPlayerLocation(0, START_X, START_Y);
                VendorVideoPlayerLocation(1, START_X + D16_WIDTH + GAP, START_Y);
                VendorVideoPlayerLocation(2, START_X + 2 * (D16_WIDTH + GAP), START_Y);
                VendorVideoPlayerLocation(3, START_X + 3 * (D16_WIDTH + GAP), START_Y);

                VendorVideoPlayerLocation(4, START_X, START_Y + D16_HIGHT + GAP);
                VendorVideoPlayerLocation(6, START_X + 3 * (D16_WIDTH + GAP), START_Y + D16_HIGHT + GAP);

                VendorVideoPlayerLocation(7, START_X, START_Y + 2 * (D16_HIGHT + GAP));
                VendorVideoPlayerLocation(8, START_X + 3 * (D16_WIDTH + GAP), START_Y + 2 * (D16_HIGHT + GAP));

                VendorVideoPlayerLocation(9, START_X, START_Y + 3 * (D16_HIGHT + GAP));
                VendorVideoPlayerLocation(10, START_X + D16_WIDTH + GAP, START_Y + 3 * (D16_HIGHT + GAP));
                VendorVideoPlayerLocation(11, START_X + 2 * (D16_WIDTH + GAP), START_Y + 3 * (D16_HIGHT + GAP));
                VendorVideoPlayerLocation(12, START_X + 3 * (D16_WIDTH + GAP), START_Y + 3 * (D16_HIGHT + GAP));

                VendorVideoPlayerLocation(5, START_X + D16_WIDTH + GAP, START_Y + D16_HIGHT + GAP);

                #endregion

                #region Hide Unused Displays

                for (int i = 13; i < m_DisplayInfo.Displays; i++)
                {
                    vp[i].Visible = false;
                    VendorVideoPlayerSize(i, 0, 0);

                    PictureVisible(i, false);
                }

                #endregion

                m_DisplayInfo.State = DisplayState.ThirteenSurround;
                DisplayManager_SetMode(DisplayFormatState.ThirteenSurround);

                Audit("Switching To Thirteen Surround View", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void Switch2TenTwoQuads()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DisplayInfo.Displays < 10)
                {
                    Utils.Error("Only " + m_DisplayInfo.Displays +
                                " Displays Defined. Can't Open Layout With 10 Displays.");

                    return;
                }

                HideSurroundingFrame(sMethod);

                #region Size

                for (int i = 0; i < 2; i++)
                {
                    vp[i].Visible = true;
                    VendorVideoPlayerSize(i, D4_WIDTH, D4_HIGHT);
                }

                for (int i = 2; i < 10; i++)
                {
                    vp[i].Visible = true;
                    VendorVideoPlayerSize(i, D16_WIDTH, D16_HIGHT);
                }

                #endregion

                #region Location

                VendorVideoPlayerLocation(0, START_X, START_Y);
                VendorVideoPlayerLocation(1, START_X + D4_WIDTH + GAP, START_Y);

                VendorVideoPlayerLocation(2, START_X, START_Y + D4_HIGHT + GAP);
                VendorVideoPlayerLocation(3, START_X + GAP + D16_WIDTH, START_Y + D4_HIGHT + GAP);

                VendorVideoPlayerLocation(4, START_X, START_Y + D4_HIGHT + GAP + D16_HIGHT + GAP);
                VendorVideoPlayerLocation(5, START_X + GAP + D16_WIDTH, START_Y + D4_HIGHT + GAP + D16_HIGHT + GAP);

                VendorVideoPlayerLocation(6, START_X + 2 * (GAP + D16_WIDTH), START_Y + D4_HIGHT + GAP);
                VendorVideoPlayerLocation(7, START_X + 3 * (GAP + D16_WIDTH), START_Y + D4_HIGHT + GAP);

                VendorVideoPlayerLocation(8, START_X + 2 * (GAP + D16_WIDTH), START_Y + D4_HIGHT + GAP + D16_HIGHT + GAP);
                VendorVideoPlayerLocation(9, START_X + 3 * (GAP + D16_WIDTH), START_Y + D4_HIGHT + GAP + D16_HIGHT + GAP);

                #endregion

                #region Hide Unused Displays

                for (int i = 10; i < m_DisplayInfo.Displays; i++)
                {
                    vp[i].Visible = false;
                    VendorVideoPlayerSize(i, 0, 0);

                    PictureVisible(i, false);
                }

                #endregion

                m_DisplayInfo.State = DisplayState.TenTwoQuads;
                DisplayManager_SetMode(DisplayFormatState.TenTwoQuads);

                Audit("Switching To Ten Two Quads View", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void Switch2TwoHorizontal()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DisplayInfo.Displays < 4)
                {
                    Utils.Error("Only " + m_DisplayInfo.Displays + " Displays Defined. Can't Open Layout With 2 Displays.");

                    return;
                }

                HideSurroundingFrame(sMethod);

                #region Location

                VendorVideoPlayerLocation(0, START_X, START_Y);
                VendorVideoPlayerLocation(1, START_X, START_Y + D4_HIGHT + GAP);

                #endregion

                #region Size

                for (int i = 0; i < 2; i++)
                {
                    vp[i].Visible = true;
                    VendorVideoPlayerSize(i, D1_WIDTH, D4_HIGHT);
                }

                #endregion

                #region Hide Unused Displays

                for (int i = 2; i < m_DisplayInfo.Displays; i++)
                {
                    vp[i].Visible = false;
                    VendorVideoPlayerSize(i, 0, 0);

                    PictureVisible(i, false);

                    Application.DoEvents();
                }

                #endregion

                m_DisplayInfo.State = DisplayState.TwoHorizontal;
                DisplayManager_SetMode(DisplayFormatState.TwoHorizontal);

                Audit("Switching To Two-Horizontal View", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void Switch2TwoVertical()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (m_DisplayInfo.Displays < 4)
                {
                    Utils.Error("Only " + m_DisplayInfo.Displays + " Displays Defined. Can't Open Layout With 2 Displays.");

                    return;
                }

                HideSurroundingFrame(sMethod);

                #region Location

                VendorVideoPlayerLocation(0, START_X, START_Y);
                VendorVideoPlayerLocation(1, START_X + D4_WIDTH + GAP, START_Y);

                #endregion

                #region Size

                for (int i = 0; i < 2; i++)
                {
                    vp[i].Visible = true;
                    VendorVideoPlayerSize(i, D4_WIDTH, D1_HIGHT);
                }

                #endregion

                #region Hide Unused Displays

                for (int i = 2; i < m_DisplayInfo.Displays; i++)
                {
                    vp[i].Visible = false;
                    VendorVideoPlayerSize(i, 0, 0);

                    PictureVisible(i, false);

                    Application.DoEvents();
                }

                #endregion

                m_DisplayInfo.State = DisplayState.TwoVertical;
                DisplayManager_SetMode(DisplayFormatState.TwoVertical);

                Audit("Switching To Two-Vertical View", sMethod, AuditSeverity.Information);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        #endregion

        #endregion

        #region Perform

        public void Perform(MainFormFunction mainFormFunction, 
                            string sLine, 
                            string sMethod,
                            DvrClientModule mModule)
        {
            #region Data Members
            
            //string sVendor;
            string sSiteName;
            string sEventMessage;
            string sPresetName;
            string sPreDefinedView;
            string sMessage;
            string sText;
            string sDirection;
            string sImportFileName;
            string sThisMethod = MethodBase.GetCurrentMethod().Name;
            string sActivationType;
            string sAlarmNumber;
            string sCalledFrom;
            string sMultiWriteCommand;
            string sListOfCameras;
            string sValue;
            string sDateTime = DateTime.Now.ToString("dd-MM-yyyy HH:mm:ss.fff");
            string sTriggerSource;
            string sResult;

            int iCameraNumber;
            int iDisplay;
            int iColorNumber;
            int iSpeed;
            int lDuration;
            int lPre;
            int lPost;
            int iColor;
            int iDvrGroupId;
            int iDvrId;
            int iNvdId;
            int iCardNumber;
            int iEntryNumber;
            int iValue;

            bool bActivate;
            bool bSingleAction;
            bool bValue;

            DateTime dStart;
            DateTime dTriggerCreation;
            Common.Direction zoomDirection;
            Common.Direction ptzDirection;

            MultiWriteCommand mwCommand;

            CameraInformation ciCameraInformation;

            #endregion

            if (this.InvokeRequired)
            {
                try
                {
                    this.BeginInvoke(new FourParamDelegate<MainFormFunction, string, string, DvrClientModule>((Perform)),
                                     mainFormFunction,
                                     sLine,
                                     sMethod,
                                     mModule);                    
                }
                catch (Exception e)
                {
                    string sError = e.Message;

                    Audit("Failed BeginInvoke(). " + sError, sThisMethod, AuditSeverity.Warning);
                }
            }
            else
            {
                try
                {
                    switch (mainFormFunction)
                    {
                        case MainFormFunction.Audit:
                            #region Audit

                            int iCurlyLeftBracket = sLine.IndexOf("{");
                            int iCurlyRightBracket = sLine.IndexOf("}");
                            bool bUseAuditSeverity = false;
                            AuditSeverity aSeverity = AuditSeverity.Unknown;
                            string sSeverity;

                            if ((iCurlyLeftBracket != DvrClientConstants.NONE) && 
                                (iCurlyRightBracket != DvrClientConstants.NONE) && 
                                (iCurlyRightBracket > iCurlyLeftBracket)) 
                            {
                                sSeverity = sLine.Substring(iCurlyLeftBracket + 1, iCurlyRightBracket - iCurlyLeftBracket - 1); 
                                sLine = sLine.Substring(iCurlyRightBracket + 1);

                                aSeverity = Utils.GetSeverity(sSeverity);
                                if (aSeverity != AuditSeverity.Unknown)
                                {
                                    bUseAuditSeverity = true;
                                }
                            }

                            if (m_Settings.Audit)
                            {
                                if (m_Log != null)
                                {
                                    if (bUseAuditSeverity)
                                    {
                                        m_Log.Audit(sLine, sMethod, mModule, aSeverity);
                                    }
                                    else
                                    {
                                        m_Log.Audit(sLine, sMethod, mModule);
                                    }
                                }
                            }

                            if (!m_bHdLimitReached)
                            {
                                if (m_Settings.AuditLog)
                                {
                                    try
                                    {
                                        sSeverity = "";

                                        switch (m_Settings.AuditLogFileType)
                                        {
                                            case AuditFileType.TextFile:
                                                if (bUseAuditSeverity)
                                                {
                                                    sSeverity = " <" + aSeverity.ToString() + "> ";
                                                }

                                                m_AuditFile.WriteLine(sDateTime +
                                                                      sSeverity +
                                                                      " <" + mModule + "> " +
                                                                      " <" + sMethod + "> " + sLine);
                                                break;

                                            case AuditFileType.Csv:
                                                if (bUseAuditSeverity)
                                                {
                                                    sSeverity = aSeverity.ToString() + ",";
                                                }

                                                m_AuditFile.WriteLine(DateTime.Now.ToString() + "," +
                                                                      sSeverity +
                                                                      mModule + "," +
                                                                      sMethod + "," +
                                                                      sLine);
                                                break;

                                            default:
                                                return;
                                        }

                                        m_AuditFile.Flush();
                                    }
                                    catch (Exception)
                                    {
                                    }
                                }

                                if (m_Settings.CreateErrorsFile)
                                {
                                    if ((aSeverity == AuditSeverity.Warning) || (aSeverity == AuditSeverity.Error))
                                    {
                                        m_ErrorsFile.WriteLine(DateTime.Now.ToString() +
                                                               " <" + aSeverity.ToString() + "> " +
                                                               " <" + Utils.GetEnumDescription(mModule) + "> " +
                                                               " <" + sMethod + "> " + sLine);
                                        m_ErrorsFile.Flush();
                                    }
                                } 
                            }

                            if (m_Settings.AuditToDebug)
                            {
                                Utils.WriteToDebugView(mModule, sMethod, sLine);
                            }

                            #endregion
                            break;


                        case MainFormFunction.WriteProtocol:
                            #region Write Protocol

                            sMessage = sLine;
                            sDirection = sMethod;

                            if (m_Protocol != null)
                            {
                                m_Protocol.Write(sMessage, sDirection);

                                m_ProtocolDataFile.WriteLine(DateTime.Now.ToString() + " <" + sDirection + "> " + sMessage);
                                m_ProtocolDataFile.Flush();
                            }

                            #endregion
                            break;


                        case MainFormFunction.Ptz:
                            #region PTZ

                            ptzDirection = (Common.Direction)int.Parse(Utils.GetNthSubString(sLine, ":", 1));
                            iSpeed = int.Parse(Utils.GetNthSubString(sLine, ":", 2));
                            sEventMessage = Utils.GetNthSubString(sLine, ":", 3);

                            if (iSpeed == 0)
                            {
                                PtzStop();
                            }
                            else
                            {
                                PtzAction(ptzDirection);
                            }

                            #endregion
                            break;


                        case MainFormFunction.Zoom:
                            #region Zoom

                            zoomDirection = (Common.Direction)int.Parse(Utils.GetNthSubString(sLine, ":", 1));
                            iSpeed = int.Parse(Utils.GetNthSubString(sLine, ":", 2));
                            sEventMessage = Utils.GetNthSubString(sLine, ":", 3);

                            ZoomAction(zoomDirection);

                            #endregion
                            break;


                        case MainFormFunction.Preset:
                            #region Preset

                            sPresetName = Utils.GetNthSubString(sLine, ":", 1);
                            iDisplay = int.Parse(Utils.GetNthSubString(sLine, ":", 2));
                            sCalledFrom = Utils.GetNthSubString(sLine, ":", 3);
                            sEventMessage = Utils.GetNthSubString(sLine, ":", 4);

                            if (sCalledFrom == "Alarms")
                            {
                                bSingleAction = false;
                            }
                            else
                            {
                                bSingleAction = true;
                            }

                            ActivateDvrPreset(iDisplay, sPresetName, sEventMessage);

                            #endregion
                            break;


                        case MainFormFunction.PreDefinedView:
                            #region Pre Defined View

                            sPreDefinedView = Utils.GetNthSubString(sLine, ":", 1);
                            sEventMessage = Utils.GetNthSubString(sLine, ":", 2);

                            CloseAllCameras();
                            StartPreDefinedView(sPreDefinedView);

                            #endregion
                            break;


                        case MainFormFunction.Exit:
                            mnuExit_Click(null, EventArgs.Empty);
                            break;


                        case MainFormFunction.StartCamera:
                            #region Start Camera

                            iDvrGroupId = int.Parse(Utils.GetNthSubString(sLine, ":", 6));;
                            iDvrId = int.Parse(Utils.GetNthSubString(sLine, ":", 1));
                            iCameraNumber = int.Parse(Utils.GetNthSubString(sLine, ":", 2));
                            iColorNumber = int.Parse(Utils.GetNthSubString(sLine, ":", 3));
                            sCalledFrom = Utils.GetNthSubString(sLine, ":", 4);
                            sEventMessage = Utils.GetNthSubString(sLine, ":", 5);

                            ciCameraInformation = GetCameraInformation(iDvrId, iCameraNumber, out sResult);
                            if (ciCameraInformation == null)
                            {
                                Audit(sResult, sMethod, AuditSeverity.Warning);

                                return;
                            }

                            if (sCalledFrom == "Alarms")
                            {
                                bSingleAction = false;
                            }
                            else
                            {
                                bSingleAction = true;
                            }

                            StartCamera(ciCameraInformation, iColorNumber, sEventMessage, bSingleAction);

                            #endregion
                            break;


                        case MainFormFunction.StartPtzCameraWithPreset:
                            #region Start PTZ Camera With Preset

                            iDvrId = int.Parse(Utils.GetNthSubString(sLine, ":", 1));
                            iCameraNumber = int.Parse(Utils.GetNthSubString(sLine, ":", 2));
                            iColorNumber = int.Parse(Utils.GetNthSubString(sLine, ":", 3));
                            sPresetName = Utils.GetNthSubString(sLine, ":", 4);
                            sCalledFrom = Utils.GetNthSubString(sLine, ":", 5);
                            sEventMessage = Utils.GetNthSubString(sLine, ":", 6);

                            if (sCalledFrom == "Alarms")
                            {
                                bSingleAction = false;
                            }
                            else
                            {
                                bSingleAction = true;
                            }

                            StartPtzCameraWithPreset(iDvrId,
                                                     iCameraNumber,
                                                     iColorNumber,
                                                     sPresetName,
                                                     sEventMessage,
                                                     bSingleAction);

                            #endregion
                            break;


                        case MainFormFunction.Wipe:
                            #region Wipe Camera

                            iDvrId = int.Parse(Utils.GetNthSubString(sLine, ":", 1));
                            iCameraNumber = int.Parse(Utils.GetNthSubString(sLine, ":", 2));
                            sValue = Utils.GetNthSubString(sLine, ":", 3);

                            Wipe(iDvrId,
                                 iCameraNumber,
                                 (sValue == "0.0") ? false : true);

                            #endregion
                            break;

                        case MainFormFunction.StartPtzCameraOnDisplayWithPreset:
                            #region Start PTZ Camera On Display With Preset

                            iDvrId = int.Parse(Utils.GetNthSubString(sLine, ":", 1));
                            iCameraNumber = int.Parse(Utils.GetNthSubString(sLine, ":", 2));
                            iDisplay = int.Parse(Utils.GetNthSubString(sLine, ":", 3));
                            iColorNumber = int.Parse(Utils.GetNthSubString(sLine, ":", 4));
                            sPresetName = Utils.GetNthSubString(sLine, ":", 5);
                            sCalledFrom = Utils.GetNthSubString(sLine, ":", 6);
                            sEventMessage = Utils.GetNthSubString(sLine, ":", 7);

                            if (sCalledFrom == "Alarms")
                            {
                                bSingleAction = false;
                            }
                            else
                            {
                                bSingleAction = true;
                            }

                            //  [TBC] find inner id
                            StartPtzCameraOnDisplayWithPreset(iDvrId,
                                                              iCameraNumber,
                                                              iDisplay,
                                                              iColorNumber,
                                                              sPresetName,
                                                              sEventMessage,
                                                              bSingleAction);

                            #endregion
                            break;


                        case MainFormFunction.StartCameraOnDisplay:
                            #region Start Camera On Display

                            iDvrGroupId = int.Parse(Utils.GetNthSubString(sLine, ":", 7));
                            iDvrId = int.Parse(Utils.GetNthSubString(sLine, ":", 1));
                            iCameraNumber = int.Parse(Utils.GetNthSubString(sLine, ":", 2));
                            iDisplay = int.Parse(Utils.GetNthSubString(sLine, ":", 3));
                            iColorNumber = int.Parse(Utils.GetNthSubString(sLine, ":", 4));
                            sCalledFrom = Utils.GetNthSubString(sLine, ":", 5);
                            sEventMessage = Utils.GetNthSubString(sLine, ":", 6);

                            ciCameraInformation = GetCameraInformation(iDvrId, iCameraNumber, out sResult);
                            if (ciCameraInformation == null)
                            {
                                Audit(sResult, sMethod, AuditSeverity.Warning);

                                return;
                            }

                            if (sCalledFrom == "Alarms")
                            {
                                bSingleAction = false;
                            }
                            else
                            {
                                bSingleAction = true;
                            }

                            StartCamera_X_on_Display_Y(ciCameraInformation,
                                                       iDisplay,
                                                       iColorNumber,
                                                       sEventMessage,            
                                                       bSingleAction);                            

                            #endregion
                            break;


                        case MainFormFunction.StopDisplay:
                            #region Stop Display

                            iDvrGroupId = int.Parse(Utils.GetNthSubString(sLine, ":", 4));
                            sSiteName = Utils.GetNthSubString(sLine, ":", 1);
                            iCameraNumber = int.Parse(Utils.GetNthSubString(sLine, ":", 2));
                            sActivationType = Utils.GetNthSubString(sLine, ":", 3);

                            //iDisplay = DisplayManager_FindDisplayByCameraNumber(sSiteName, iCameraNumber);
                            iDisplay = DisplayManager_FindDisplayByCamera(int.Parse(sSiteName), iCameraNumber);
                            if (iDisplay != DvrClientConstants.NONE)
                            {
                                if (DisplayManager_DisplayActivation(iDisplay).ToString() == sActivationType)
                                {
                                    DoStopDisplay(iDisplay);
                                    CustomizeDisplays(sMethod);
                                    NoVideoPictureOnEmptyDisplays();
                                }
                            }
                            else
                            {
                                Audit("Trying To Close Camera[" + iCameraNumber + 
                                      "] On Dvr[" + sSiteName + 
                                      "] Activation[" + sActivationType + 
                                      "]. Camera Is Probably Closed." ,
                                      sMethod, 
                                      AuditSeverity.Warning);
                            }

                            #endregion
                            break;


                        case MainFormFunction.Playback:
                            #region Playback

                            iDvrGroupId = int.Parse(Utils.GetNthSubString(sLine, ";", 10));
                            iDvrId = int.Parse(Utils.GetNthSubString(sLine, ";", 1));
                            iCameraNumber = int.Parse(Utils.GetNthSubString(sLine, ";", 2));
                            iColor = int.Parse(Utils.GetNthSubString(sLine, ";", 3));
                            dStart = DateTime.Parse(Utils.GetNthSubString(sLine, ";", 4));
                            lDuration = int.Parse(Utils.GetNthSubString(sLine, ";", 5));
                            lPre = int.Parse(Utils.GetNthSubString(sLine, ";", 6));
                            lPost = int.Parse(Utils.GetNthSubString(sLine, ";", 7));
                            sCalledFrom = Utils.GetNthSubString(sLine, ";", 8);
                            sEventMessage = Utils.GetNthSubString(sLine, ";", 9);

                            ciCameraInformation = GetCameraInformation(iDvrId, iCameraNumber, out sResult);
                            if (ciCameraInformation == null)
                            {
                                Audit(sResult, sMethod, AuditSeverity.Warning);

                                return;
                            }

                            if (sCalledFrom == DvrClientModule.VMDTriggers.ToString())
                            {
                                dTriggerCreation = DateTime.Parse(Utils.GetNthSubString(sLine, ";", 10));
                                sTriggerSource = Utils.GetNthSubString(sLine, ";", 11);
                            }
                            else
                            {
                                dTriggerCreation = Utils.InitialDefaultTime();
                                sTriggerSource = "";
                            }

                            if (sCalledFrom == "Alarms")
                            {
                                bSingleAction = false;
                            }
                            else
                            {
                                bSingleAction = true;
                            }

                            StartPlayback(ciCameraInformation,
                                          iColor,
                                          dStart,
                                          lDuration,
                                          lPre,
                                          lPost,
                                          sEventMessage,
                                          bSingleAction,
                                          dTriggerCreation,
                                          sTriggerSource);

                            #endregion
                            break;


                        case MainFormFunction.PlaybackOnDisplay:
                            #region Playback On Display

                            iDvrGroupId = int.Parse(Utils.GetNthSubString(sLine, ";", 11));
                            iDvrId = int.Parse(Utils.GetNthSubString(sLine, ";", 1));
                            iCameraNumber = int.Parse(Utils.GetNthSubString(sLine, ";", 2));
                            iColor = int.Parse(Utils.GetNthSubString(sLine, ";", 3));
                            dStart = DateTime.Parse(Utils.GetNthSubString(sLine, ";", 4));
                            iDisplay = int.Parse(Utils.GetNthSubString(sLine, ";", 5));
                            lDuration = int.Parse(Utils.GetNthSubString(sLine, ";", 6));
                            lPre = int.Parse(Utils.GetNthSubString(sLine, ";", 7));
                            lPost = int.Parse(Utils.GetNthSubString(sLine, ";", 8));
                            sCalledFrom = Utils.GetNthSubString(sLine, ";", 9);
                            sEventMessage = Utils.GetNthSubString(sLine, ";", 10);

                            ciCameraInformation = GetCameraInformation(iDvrId, iCameraNumber, out sResult);
                            if (ciCameraInformation == null)
                            {
                                Audit(sResult, sMethod, AuditSeverity.Warning);

                                return;
                            }

                            if (sCalledFrom == DvrClientModule.VMDTriggers.ToString())
                            {
                                dTriggerCreation = DateTime.Parse(Utils.GetNthSubString(sLine, ";", 11));
                                sTriggerSource = Utils.GetNthSubString(sLine, ";", 12);
                            }
                            else
                            {
                                dTriggerCreation = Utils.InitialDefaultTime();
                                sTriggerSource = "";
                            }

                            if (sCalledFrom == "Alarms")
                            {
                                bSingleAction = false;
                            }
                            else
                            {
                                bSingleAction = true;
                            }

                            StartPlayback_on_Display_Y(ciCameraInformation,
                                                       iColor,
                                                       dStart,
                                                       iDisplay,
                                                       lDuration,
                                                       lPre,
                                                       lPost,
                                                       sEventMessage,
                                                       bSingleAction, 
                                                       dTriggerCreation,
                                                       sTriggerSource);

                            #endregion
                            break;


                        case MainFormFunction.MultiSelectPlayback:
                            #region MultiSelectPlayback

                            //sVendor = bm.GetNthSubString(sLine, ";", 1);
                            sSiteName = Utils.GetNthSubString(sLine, ";", 1);
                            iCameraNumber = int.Parse(Utils.GetNthSubString(sLine, ";", 2));
                            iColor = int.Parse(Utils.GetNthSubString(sLine, ";", 3));
                            dStart = DateTime.Parse(Utils.GetNthSubString(sLine, ";", 4));
                            lDuration = int.Parse(Utils.GetNthSubString(sLine, ";", 5));
                            lPre = int.Parse(Utils.GetNthSubString(sLine, ";", 6));
                            lPost = int.Parse(Utils.GetNthSubString(sLine, ";", 7));
                            sCalledFrom = Utils.GetNthSubString(sLine, ";", 8);
                            sEventMessage = Utils.GetNthSubString(sLine, ";", 9);

                            bSingleAction = true;


                            MultiSelectPlayback(dStart, lDuration);

                            #endregion
                            break;


                        case MainFormFunction.CloseAllCameras:
                            CloseAllCameras();
                            break;


                        case MainFormFunction.RestoreDisplaysFromDataBase:
                            RestoreDisplaysFromDataBase();
                            break;


                        case MainFormFunction.SetProjectName:
                            SetProjectName(sLine);
                            break;


                        case MainFormFunction.SetLayout:
                            SetLayout(sLine);
                            break;


                        case MainFormFunction.SetActiveDisplay:
                            SetActiveDisplay(sLine, "{" + sMethod + "}:<" + Utils.GetEnumDescription(mainFormFunction) + ">");
                            break;


                        case MainFormFunction.SetAsActiveDvrClient:
                            SetAsActiveDvrClient(sLine);
                            break;


                        case MainFormFunction.SetFullScreen:
                            SetFullScreen(sLine);
                            break;


                        case MainFormFunction.Snapshot:
                            #region Snapshot

                            iDvrId = int.Parse(Utils.GetNthSubString(sLine, ":", 1));
                            iCameraNumber = int.Parse(Utils.GetNthSubString(sLine, ":", 2));
                            bActivate = bool.Parse(Utils.GetNthSubString(sLine, ":", 3));
                            sImportFileName = Utils.GetNthSubString(sLine, ":", 4);
                            SnapShot(iDvrId, iCameraNumber, sImportFileName, ActivationType.LiveVideo);

                            #endregion
                            break;


                        case MainFormFunction.Osd:
                            #region Osd

                            iDvrId = int.Parse(Utils.GetNthSubString(sLine, ":", 1));
                            iCameraNumber = int.Parse(Utils.GetNthSubString(sLine, ":", 2));
                            iValue = int.Parse(Utils.GetNthSubString(sLine, ":", 3));
                            
                            Osd(iDvrId, iCameraNumber, iValue);

                            #endregion
                            break;


                        case MainFormFunction.SetVideoPlayerText:
                            #region Set Video Player Text

                            sSiteName = Utils.GetNthSubString(sLine, ":", 1);
                            iCameraNumber = int.Parse(Utils.GetNthSubString(sLine, ":", 2));
                            sText = Utils.GetNthSubString(sLine, ":", 3);

                            iDisplay = DisplayManager_FindDisplayByCameraNumber(sSiteName, iCameraNumber);
                            NiceVideoDisplayFreeText(iDisplay, sText);

                            #endregion
                            break;


                        case MainFormFunction.ActivateAlarmListOfCommands:
                            #region Activate Alarm List Of Commands

                            sAlarmNumber = Utils.GetNthSubString(sLine, ";", 1);
                            sMessage = Utils.GetNthSubString(sLine, ";", 2);
                            if (sAlarmNumber == "Client")
                            {
                                ActivateAlarmListOfCommands(sMessage);
                                break;
                            }

                            if (sMessage == "NOW")
                            {
                                sMessage = "";
                            }

                            if (m_Settings.UseAlarmsQueue)
                            {
                                bool bRc = m_PulseAlarmQ.AddItem(new PulseAlarmQueueItem(sAlarmNumber, sMessage));
                                if (!bRc)
                                {
                                    Audit("Failed Adding Alarm[" + sAlarmNumber + "] Start Date Time[" + sMessage + "]",
                                          sMethod,
                                          AuditSeverity.Error);
                                }
                            }
                            else
                            {
                                ActivateAlarmListOfCommands(sAlarmNumber, sMessage);
                            }                                    

                            #endregion
                            break;


                        case MainFormFunction.ActivateListOfCommands:
                            #region Activate List Of Commands

                            sMultiWriteCommand = Utils.GetNthSubString(sLine, ";", 1);
                            sSiteName = Utils.GetNthSubString(sLine, ";", 2);
                            sListOfCameras = Utils.GetNthSubString(sLine, ";", 3);
                            sValue = Utils.GetNthSubString(sLine, ";", 4);

                            mwCommand = Utils.GetMultiWriteCommand(sMultiWriteCommand);
                            ActivateListOfCommands(mwCommand, sSiteName, sListOfCameras, sValue);

                            #endregion
                            break;


                        case MainFormFunction.CloseAlarmInitiatedDisplays:
                            CloseAllCamerasInitiatedByAlarm(sLine);
                            break;


                        case MainFormFunction.Nvd:
                            #region Network Video Decoder

                            iDvrId = int.Parse(Utils.GetNthSubString(sLine, ";", 1));
                            iCameraNumber = int.Parse(Utils.GetNthSubString(sLine, ";", 2));
                            iNvdId = int.Parse(Utils.GetNthSubString(sLine, ";", 3));
                            iCardNumber = int.Parse(Utils.GetNthSubString(sLine, ";", 4));
                            iEntryNumber = int.Parse(Utils.GetNthSubString(sLine, ";", 5));
                            sPresetName = Utils.GetNthSubString(sLine, ";", 6);
                            sValue = Utils.GetNthSubString(sLine, ";", 7);

                            bValue = Utils.ParseBooleanValue(sValue);
                            if (bValue)
                            {
                                //OpenCameraOnNvd(iDvrId, iCameraNumber, iNvdId, iCardNumber, iEntryNumber, sPresetName);
                            }
                            else
                            {
                                //CloseCameraOnNvd(iNvdId, iCardNumber, iEntryNumber);
                            }

                            #endregion
                            break;


                        case MainFormFunction.MinmizeMaximizeDisplay:
                            MinmizeMaximizeDisplay();
                            break;


                        default:
                            break;
                    }
                }
                catch (Exception e)
                {
                    Audit("Failed Perform() Main Form Function[" + mainFormFunction.ToString() + 
                          "] Parameters[" + sLine + 
                          "] Module[" + Utils.GetEnumDescription(mModule) + 
                          "] Method[" + sMethod + "]. " + e.Message,
                          sThisMethod, 
                          AuditSeverity.Error);
                }
            }
        }        

        #endregion

        #region Commands From Inside

        private void ActivateListOfCommands(MultiWriteCommand mwCommand, 
                                            string sSiteName, 
                                            string sListOfCameras, 
                                            string sValue)
        {
            #region Data Members

		    bool bValue;

            DateTime dStartDate;
            
            int lDuration;
            int lPre;
            int lPost;

            string sErrorMessage;
            string sResult;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            List<int> lCamera = Utils.GetNumbers(sListOfCameras, out sResult); 

	        #endregion

            switch (mwCommand)
            {
                case MultiWriteCommand.LiveVideo:
                    bValue = Utils.ParseBooleanValue(sValue);

                    foreach (int iCameraNumber in lCamera)
                    {
                        //StartCamera(sSiteName, iCameraNumber, DvrClientConstants.NONE, "", true);
                    }
                    break;

                case MultiWriteCommand.Vod:
                    if (Utils.NukeValueParameters(sValue, 
                                                  out dStartDate,  
                                                  out lDuration, 
                                                  out lPre, 
                                                  out lPost, 
                                                  out sErrorMessage) == false)
                    {
                        Audit("Failed Extracting Playback Parameters From [" + sValue + 
                              "]. " + sErrorMessage, 
                              sMethod,
                              AuditSeverity.Warning);

                        return;
                    }   

                    foreach (int iCameraNumber in lCamera)
                    {
                        //StartPlayback(sSiteName, 
                        //              iCameraNumber, 
                        //              DvrClientConstants.NONE,
                        //              dStartDate,
                        //              lDuration,
                        //              lPre,
                        //              lPost,
                        //              "", 
                        //              true,
                        //              Utils.InitialDefaultTime(),
                        //              "");
                    }
                    break;

                default:
                    break;
            }
        }

        public string PcimCommand2GendrvCommand(ActionType actionType, string sPcimCommand, out string sError)
        {
            #region Data Members
            
            string sGendrvCommand = "";
            string sPcimPort;
            string sInstanceNumber;
            string sDvrNumber;
            string sCommand;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sGroup;

            #endregion

            sError = "";

            try
            {
                sPcimPort = Utils.GetNthSubString(sPcimCommand, ":", 1);
                sInstanceNumber = Utils.GetNthSubString(sPcimCommand, ":", 2);
                sCommand = Utils.GetNthSubString(sPcimCommand, ":", 3);

                #region Pulse Port
                
                if (m_Settings.PcimPulsePort != DvrClientConstants.NONE)
                {
                    try
                    {
                        int iPcimPort = int.Parse(sPcimPort);

                        if (iPcimPort != m_Settings.PcimPulsePort)
                        {
                            sError = "Wrong PULSE Port[" + sPcimPort +
                                     "]. Port Has To Be [" + m_Settings.PcimPulsePort + "]";

                            return "";
                        }
                    }
                    catch (Exception)
                    {
                        sError = "PULSE Port[" + sPcimPort + "] Is Not Numeric";

                        return "";
                    }
                } 

                #endregion

                #region Pulse Plc
                
                if (m_Settings.PcimPulseStationID != DvrClientConstants.NONE)
                {
                    try
                    {
                        int iInstanceNumber = int.Parse(sInstanceNumber);

                        if (iInstanceNumber != m_Settings.PcimPulseStationID)
                        {
                            sError = "Wrong Dvr Client Instance Number[" + sInstanceNumber +
                                     "]. Instance Number Has To Be [" + m_Settings.PcimPulseStationID + "]";

                            return "";
                        }
                    }
                    catch (Exception)
                    {
                        sError = "Instance Number[" + sInstanceNumber + "] Is Not Numeric";

                        return "";
                    }
                } 

                #endregion

                sCommand = sCommand.ToUpper();
                if ((sCommand.IndexOf("_") == DvrClientConstants.NONE) && (sCommand.IndexOf("DVR") == DvrClientConstants.NONE))
                {
                    sCommand = "DVR1_" + sCommand;
                }

                sDvrNumber = Utils.GetNthSubString(sCommand, "_", 1);
                sDvrNumber = sDvrNumber.Substring(3);
                if (sDvrNumber == "")
                {
                    sDvrNumber = "0";
                }

                sGroup = Utils.GetNthSubString(sCommand, "_", 3);
                sCommand = Utils.GetNthSubString(sCommand, "_", 2);

                sGendrvCommand = ":" + sDvrNumber + ":" + sCommand;
                if (!string.IsNullOrEmpty(sGroup))
                {
                    sGendrvCommand += "_" + sGroup;
                }
                
                switch (actionType)
                {
                    case ActionType.Read:
                        sGendrvCommand = "R" + sGendrvCommand;
                        break;

                    case ActionType.Write:
                        sGendrvCommand = "W" + sGendrvCommand;
                        break;

                    default:
                        return "";
                }

                return sGendrvCommand.ToUpper();
            }
            catch (Exception e)
            {
                Audit("Failed PcimCommand2GendrvCommand Action Type[" + actionType.ToString() +
                      "] Command[" + sPcimCommand + "]. " + e.Message,
                      sMethod, 
                      AuditSeverity.Error);

                return "";
            }
        }

        public bool ParseSyntax(int iDvr, 
                                string sCommand, 
                                string sValue, 
                                ActionType actionType, 
                                string sCalledFrom)
        {
            if (m_PCimProxyThread == null)
            {
                return false;
            }

            return m_PCimProxyThread.ParseSyntax(iDvr, sCommand, sValue, actionType, sCalledFrom);
        }

        #endregion

        #region Alarm

        private void ActivateAlarmListOfCommands(PulseAlarmQueueItem paqi)
        {
            ActivateAlarmListOfCommands(paqi.AlarmNumber, paqi.StartDateTime);
        }

        public void ActivateAlarmListOfCommands(string sCommands)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sError;
            string sMessage;
            string sStage = "";
            string sAlarmBlockDescription;

            List<string> lCommandsFromPulseDatabase;
            List<PulseAlarmCommand> lPulseAlarmCommand = new List<PulseAlarmCommand>();
            List<int> lAlreadyOpen = new List<int>();

            CameraOpenType cotCameraOpenType;

            int iIndex;
            int iDisplayIndex;

            bool bHasDisplayByIndex = false;

            string sStartDateTime;
            string[] sCommandList;

            #endregion            

            try
            {
                if (!GetStartDateAndAlarmCommands(sCommands, out sStartDateTime, out sCommandList, out sError))
                {
                    AuditPerform(sError, sMethod, AuditSeverity.Warning);

                    return;
                }

                cotCameraOpenType = (sStartDateTime == "") ? CameraOpenType.Automatic : CameraOpenType.Manual;
                Audit("Alarm Command From " + ((cotCameraOpenType == CameraOpenType.Manual) ? "Event Manager" : "Alarm Publisher"),
                      sMethod,
                      AuditSeverity.Information);

                #region Stop Running Pre Defined Views Or Main Views

                m_bCutMainViewInTheMiddle = true;
                m_bCutPredefinedViewInTheMiddle = true;
                sStage = "Stop Running Pre Defined Views Or Main Views";

                #endregion

                #region Retreive The Pulse Commands 

                lCommandsFromPulseDatabase = new List<string>();

                foreach (string sCommand in sCommandList)
                {
                    lCommandsFromPulseDatabase.Add(sCommand);
                }

                if ((!string.IsNullOrEmpty(sError)) || (lCommandsFromPulseDatabase == null))
                {
                    Audit("Failed To Get List Of Commands. " + sError,
                          sMethod,
                          AuditSeverity.Warning);

                    return;
                }
                else
                {
                    if (lCommandsFromPulseDatabase.Count < 1)
                    {
                        sMessage = "No Commands";
                        Audit(sMessage, sMethod, AuditSeverity.Warning);
                        Utils.Error(sMessage);

                        return;
                    }
                    else
                    {
                        Audit("Retreived " + lCommandsFromPulseDatabase.Count +
                              " Commands",
                              sMethod,
                              AuditSeverity.Information);
                    }
                }

                #endregion

                #region Investigate The Cameras Needed To Be Opened And See If Some Of Them Are Already Open

                sStage = "Investigate The Cameras Needed To Be Opened And See If Some Of Them Are Already Open";

                for (iIndex = 0; iIndex < lCommandsFromPulseDatabase.Count; iIndex++)
                {
                    #region Data Members

                    DateTime dtNow;
                    DateTime dtStartDateTime;
                    DateTime dtPreDateTime;
                    DateTime dtPostDateTime;

                    bool bDvrIdNumeric;
                    bool bIsPresetCommand;
                    bool bNowTimeAfterPostTime;

                    int iDvrId;
                    int iNumberOfAts;
                    int iCommandDisplayIndex;

                    string sCommandDisplayIndex;
                    string sVendor;
                    string sDvr;
                    string sCameraNumber;
                    string sCommand;
                    string sValue;
                    string sOriginalPulseCommand;
                    string sPulseCommand;

                    PulseAlarmCommand pac;
                    ActivationType activationType;

                    #endregion

                    pac = new PulseAlarmCommand();
                    activationType = ActivationType.NotActive;

                    sPulseCommand = lCommandsFromPulseDatabase[iIndex];
                    sPulseCommand = sPulseCommand.ToUpper();
                    sOriginalPulseCommand = sPulseCommand;

                    iNumberOfAts = Utils.GetNumberOfOccurences(sPulseCommand, "@");
                    if (iNumberOfAts > 0)
                    {
                        if (iNumberOfAts > 1)
                        {
                            //  more than 1 '@'. problematic command
                            Audit("Command[" + sOriginalPulseCommand + "] Illegal", sMethod, AuditSeverity.Warning);

                            continue;
                        }
                        else
                        {
                            //  there is exactly 1 '@'

                            sCommandDisplayIndex = Utils.GetNthSubString(sPulseCommand, "@", 2);
                            sPulseCommand = Utils.GetNthSubString(sPulseCommand, "@", 1);

                            try
                            {
                                iCommandDisplayIndex = int.Parse(sCommandDisplayIndex);
                            }
                            catch (Exception)
                            {
                                iCommandDisplayIndex = DvrClientConstants.NONE;

                                Audit("Command[" + sOriginalPulseCommand + "] With Non Numeric Display Index",
                                      sMethod,
                                      AuditSeverity.Warning);

                                continue;
                            }

                            pac.DisplayIndex = iCommandDisplayIndex;
                            pac.HasDisplayIndex = true;
                        }
                    }
                    else
                    {
                        //  no '@'

                        pac.DisplayIndex = DvrClientConstants.NONE;
                        pac.HasDisplayIndex = false;
                    }

                    sVendor = Utils.GetNthSubString(sPulseCommand, ":", 1);

                    #region Calculate pre and post time

                    Audit("Pulse Command[" + sPulseCommand + "]", sMethod, AuditSeverity.Information);

                    if (cotCameraOpenType == CameraOpenType.Automatic)
                    {
                        dtStartDateTime = DateTime.Now;
                    }
                    else
                    {
                        try
                        {
                            dtStartDateTime = DateTime.ParseExact(sStartDateTime.Trim(),
                                                                  "dd/MM/yyyy HH:mm:ss",
                                                                  System.Globalization.CultureInfo.InvariantCulture);
                        }
                        catch (Exception e)
                        {
                            Audit(sStartDateTime + " Not A Valid Date. " + e.Message,
                                  sMethod,
                                  AuditSeverity.Warning);

                            continue;
                        }
                    }

                    dtPreDateTime = dtStartDateTime.AddSeconds(-1 * Convert.ToDouble(m_Settings.PlaybackPreEventTime));
                    dtPostDateTime = dtStartDateTime.AddSeconds(Convert.ToDouble(m_Settings.PlaybackPostEventTime));
                    dtNow = DateTime.Now;

                    bNowTimeAfterPostTime = (dtNow <= dtPostDateTime) ? false : true;

                    Audit("Start Date Time[" + dtStartDateTime.ToString() + "] " +
                          "Pre Date Time[" + dtPreDateTime.ToString() + "] " +
                          "Post Date Time[" + dtPostDateTime.ToString() + "] " +
                          "Now Date Time[" + dtNow.ToString() +
                          "] Now After Post Time[" + bNowTimeAfterPostTime + "]",
                          sMethod,
                          AuditSeverity.Information);

                    #endregion

                    #region Is Dvr ID Ok?

                    sDvr = Utils.GetNthSubString(sPulseCommand, ":", 2);
                    sDvr = sDvr.Substring(3);

                    iDvrId = DvrClientConstants.NONE;
                    try
                    {
                        iDvrId = int.Parse(sDvr);
                        bDvrIdNumeric = true;
                    }
                    catch (Exception)
                    {
                        bDvrIdNumeric = false;
                    }

                    #endregion

                    if ((bDvrIdNumeric) || (iDvrId != DvrClientConstants.NONE))
                    {
                        sCameraNumber = Utils.GetNthSubString(sPulseCommand, ":", 3);

                        //  is it a playback command?
                        if (sCameraNumber.IndexOf(",P") != DvrClientConstants.NONE)
                        {
                            #region Playback

                            sCameraNumber = sCameraNumber.Substring(0, sCameraNumber.Length - 2);
                            sCommand = "VOD" + sCameraNumber;

                            if (pac.HasDisplayIndex)
                            {
                                sCommand += "D" + pac.DisplayIndex;
                            }

                            if ((cotCameraOpenType == CameraOpenType.Manual) && bNowTimeAfterPostTime)
                            {
                                sValue = "SD" + dtPreDateTime.ToString("dd/MM/yyyy HH:mm:ss") +
                                         " ED" + dtPostDateTime.ToString("dd/MM/yyyy HH:mm:ss");
                            }
                            else
                            {
                                double dblGapFromNow = (double)m_Settings.PlaybackGapFromNow;
                                dtNow = dtNow.AddSeconds(-1 * dblGapFromNow);

                                if (dtNow < dtPreDateTime)
                                {
                                    dtPreDateTime = dtPreDateTime.AddSeconds(-1 * dblGapFromNow);
                                }

                                sValue = "SD" + dtPreDateTime.ToString("dd/MM/yyyy HH:mm:ss") +
                                         " ED" + dtNow.ToString("dd/MM/yyyy HH:mm:ss");
                            }

                            activationType = ActivationType.VideoOnDemand;
                            bIsPresetCommand = false;

                            #endregion
                        }
                        else
                        {
                            #region Live Video

                            if ((cotCameraOpenType == CameraOpenType.Manual) && bNowTimeAfterPostTime)
                            {
                                sCommand = "VOD" + sCameraNumber;
                                if (pac.HasDisplayIndex)
                                {
                                    sCommand += "D" + pac.DisplayIndex;
                                }

                                sValue = "SD" + dtPreDateTime.ToString("dd/MM/yyyy HH:mm:ss") +
                                         " ED" + dtPostDateTime.ToString("dd/MM/yyyy HH:mm:ss");

                                activationType = ActivationType.VideoOnDemand;

                                int iLeftBracketPosition = sCameraNumber.IndexOf("[");
                                if (iLeftBracketPosition != DvrClientConstants.NONE)
                                {
                                    sCameraNumber = sCameraNumber.Substring(0, iLeftBracketPosition);
                                }

                                bIsPresetCommand = false;
                            }
                            else
                            {
                                #region Is it a preset command?

                                if ((sCameraNumber.IndexOf("[") != DvrClientConstants.NONE) &&
                                    (sCameraNumber.IndexOf("]") != DvrClientConstants.NONE))
                                {
                                    int iLeftBracketPosition = sCameraNumber.IndexOf("[");
                                    int iRightBracketPosition = sCameraNumber.IndexOf("]");
                                    string sPresetName = sCameraNumber.Substring(iLeftBracketPosition + 1,
                                                                                 iRightBracketPosition - (iLeftBracketPosition + 1));
                                    sCameraNumber = sCameraNumber.Substring(0, iLeftBracketPosition);

                                    activationType = ActivationType.LiveVideo;
                                    sCommand = "PRESET" + sCameraNumber;
                                    if (pac.HasDisplayIndex)
                                    {
                                        sCommand += "D" + pac.DisplayIndex;
                                    }

                                    sValue = sPresetName;
                                    bIsPresetCommand = true;
                                }

                                #endregion
                                else
                                #region or a monitor command?

                                {
                                    activationType = ActivationType.LiveVideo;
                                    sCommand = "M" + sCameraNumber;
                                    if (pac.HasDisplayIndex)
                                    {
                                        sCommand += "D" + pac.DisplayIndex;
                                    }

                                    sValue = "1.0";
                                    bIsPresetCommand = false;
                                }

                                #endregion
                            }

                            #endregion
                        }

                        pac.DvrID = iDvrId;
                        //pac.DvrName = GetDvrName(iDvrId);
                        //if (string.IsNullOrEmpty(pac.DvrName))
                        //{
                        //    Audit("Command[" + sPulseCommand + "] Dvr Name Is Null Or Empty", 
                        //          sMethod, 
                        //          AuditSeverity.Warning);

                        //    continue;
                        //}

                        try
                        {
                            pac.CameraNumber = int.Parse(sCameraNumber);
                        }
                        catch (Exception)
                        {
                            Audit("Command[" + sPulseCommand + "] Camera Number Is Not Numeric",
                                  sMethod,
                                  AuditSeverity.Warning);

                            continue;
                        }
                        pac.CameraActivationType = activationType;
                        pac.Command = sCommand;
                        pac.Value = sValue;
                        pac.IsPresetCommand = bIsPresetCommand;

                        switch (activationType)
                        {
                            case ActivationType.LiveVideo:
                                iDisplayIndex = DisplayManager_FindIndex(pac.DvrID,
                                                                         pac.CameraNumber,
                                                                         ActivationType.LiveVideo);
                                if (iDisplayIndex == DvrClientConstants.NONE)
                                {
                                    pac.IsAlreadyOpen = false;
                                    pac.Display = DvrClientConstants.NONE;
                                }
                                else
                                {
                                    pac.IsAlreadyOpen = true;
                                    pac.Display = iDisplayIndex;
                                    lAlreadyOpen.Add(iDisplayIndex);
                                }
                                break;

                            default:
                                pac.IsAlreadyOpen = false;
                                break;
                        }

                        lPulseAlarmCommand.Add(pac);
                    }
                    else
                    {
                        Audit("DVR ID[" + sDvr + "] Not Numeric Or Unknown. Command[" + sPulseCommand +
                              "] Discarded.",
                              sMethod,
                              AuditSeverity.Warning);
                    }
                }

                #endregion

                #region Change Display Mode To Number Of Incomming Commands

                //if (cotCameraOpenType == CameraOpenType.Automatic)
                //{
                    int iMaxDisplayNumberIndex = 0;
                    int iNumberOfActiveDisplays;

                    sStage = "Change Display Mode To Number Of Incomming Commands";

                    for (int iCommand = 0; iCommand < lPulseAlarmCommand.Count; iCommand++)
                    {
                        if (lPulseAlarmCommand[iCommand].HasDisplayIndex)
                        {
                            if (lPulseAlarmCommand[iCommand].DisplayIndex > iMaxDisplayNumberIndex)
                            {
                                iMaxDisplayNumberIndex = lPulseAlarmCommand[iCommand].DisplayIndex;
                            }

                            bHasDisplayByIndex = true;
                        }
                    }

                    iNumberOfActiveDisplays = Math.Max(iMaxDisplayNumberIndex, lPulseAlarmCommand.Count);

                    if (!m_bFixedLayout)
                    {
                        ChangeDisplayMode(DisplayManager_FindOptimalNormalLayout(iNumberOfActiveDisplays));
                    }
                    LoadingPictureOnEmptyDisplays();
                    m_bNoAdaption = true;
                //}

                #endregion

                #region Close The Cameras On The Grid Needed To Be Closed

                sStage = "Close The Cameras On The Grid Needed To Be Closed";

                switch (cotCameraOpenType)
                {
                    case CameraOpenType.Automatic:
                        if (m_Settings.CloseManualCamerasOnEvent)
                        {
                            CloseAllCameras(lAlreadyOpen);
                        }
                        else
                        {
                            CloseAllCamerasExceptManuals(lAlreadyOpen);
                        }
                        break;


                    case CameraOpenType.Manual:
                        Audit("Manual Open Type. No Cameras Closed.", sMethod, AuditSeverity.Information);
                        break;


                    default:
                        Audit("Wrong Camera Open Type[" + cotCameraOpenType.ToString() + "]", sMethod, AuditSeverity.Warning);
                        break;
                }

                #endregion

                #region Perform The Pulse Commands Needed To Be Performed

                sStage = "Perform The Pulse Commands Needed To Be Performed";

                for (iIndex = 0; iIndex < lPulseAlarmCommand.Count; iIndex++)
                {
                    if (lPulseAlarmCommand[iIndex].IsAlreadyOpen == false)
                    {
                        ParseSyntax(lPulseAlarmCommand[iIndex].DvrID,
                                    lPulseAlarmCommand[iIndex].Command,
                                    lPulseAlarmCommand[iIndex].Value,
                                    ActionType.Write,
                                    "Alarms");

                        Audit("Command Number(" + (iIndex + 1) +
                              ") [" + lPulseAlarmCommand[iIndex].Command +
                              "] Value[" + lPulseAlarmCommand[iIndex].Value + "]",
                              sMethod,
                              AuditSeverity.Information);
                    }
                    else
                    {
                        if (lPulseAlarmCommand[iIndex].IsPresetCommand)
                        {
                            ParseSyntax(lPulseAlarmCommand[iIndex].DvrID,
                                        lPulseAlarmCommand[iIndex].Command,
                                        lPulseAlarmCommand[iIndex].Value,
                                        ActionType.Write,
                                        "Alarm");

                            Audit("Command Number(" + (iIndex + 1) +
                                  ") [" + lPulseAlarmCommand[iIndex].Command +
                                  "] Value[" + lPulseAlarmCommand[iIndex].Value + "]. Only Preset Activation.",
                                  sMethod,
                                  AuditSeverity.Information);
                        }
                        else
                        {
                            Audit("Command Number(" + (iIndex + 1) +
                                  ") [" + lPulseAlarmCommand[iIndex].Command +
                                  "] Value[" + lPulseAlarmCommand[iIndex].Value + "] Not Activated. Already Open.",
                                  sMethod,
                                  AuditSeverity.Warning);
                        }
                    }
                }

                #endregion

                #region Tag Alarm Cameras With alarmID, Open Type And Block Description

                sStage = "Tag Alarm Cameras With alarmID, Open Type And Block Description";

                for (iIndex = 0; iIndex < lPulseAlarmCommand.Count; iIndex++)
                {
                    if (lPulseAlarmCommand[iIndex].IsAlreadyOpen)
                    {
                        iDisplayIndex = lPulseAlarmCommand[iIndex].Display;
                    }
                    else
                    {
                        iDisplayIndex = DisplayManager_FindIndex(lPulseAlarmCommand[iIndex].DvrID,
                                                                 lPulseAlarmCommand[iIndex].CameraNumber,
                                                                 lPulseAlarmCommand[iIndex].CameraActivationType);
                    }

                    if (iDisplayIndex != DvrClientConstants.NONE)
                    {
                        //DisplayManager_SetInitiatingAlarm(iDisplayIndex, int.Parse(sAlarmNumber));
                        DisplayManager_SetCameraOpenType(iDisplayIndex, cotCameraOpenType);
                        //DisplayManager_SetEventString(iDisplayIndex, sAlarmBlockDescription);
                    }
                    else
                    {
                        Audit("Can't Find Camera[" + lPulseAlarmCommand[iIndex].CameraNumber +
                              "] On DVR[" + lPulseAlarmCommand[iIndex].DvrName +
                              "] Activation Type[" + lPulseAlarmCommand[iIndex].CameraActivationType.ToString() +
                              "]",
                              sMethod,
                              AuditSeverity.Warning);
                    }
                }

                #endregion

                if (!bHasDisplayByIndex)
                {
                    FallBackDisplays();
                }
                NoVideoPictureOnEmptyDisplays();

                #region Let The Pre Defined Views Or Main Views Run Free

                sStage = "Let The Pre Defined Views Or Main Views Run Free";

                m_bCutMainViewInTheMiddle = false;
                m_bCutPredefinedViewInTheMiddle = false;

                #endregion

                if (m_Settings.UseAlarmsQueue)
                {
                    if (m_Settings.GapBetweenAlarmsInMiliSeconds == 0)
                    {
                        PulseAlarmQ_AlarmArrived_Handler(null, null);
                    }
                    else
                    {
                        tmrActivateAlarm.Enabled = true;
                    }
                }
            }
            catch (Exception e)
            {
                Audit("Can't Activate Alarm List Of Commands. " +
                      sStage + ". " +
                      e.Message,
                      sMethod,
                      AuditSeverity.Warning);
            }
        }

        private bool GetStartDateAndAlarmCommands(string sValue, out string sStartDate, out string[] sCommandList, out string sError)
        {
            #region Data Members

            bool bRc;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sCommands;

            int iFirstAmpersandPosition;
            int iExclamationMark;

            #endregion

            sStartDate = "";
            sCommandList = null;
            sError = "";

            try
            {
                if (sValue.Substring(0, 1) != "!")
                {
                    sError = "Value Does Not Start With A '!'. Wrong Format [" + sValue + "]";

                    return false;
                }

                if (sValue == "!&")
                {
                    sError = "No Commands Fetched.";

                    return true;
                }

                iExclamationMark = sValue.IndexOf("!");
                iFirstAmpersandPosition = sValue.IndexOf("&");

                sStartDate = sValue.Substring(iExclamationMark + 1, iFirstAmpersandPosition - iExclamationMark - 1);
                sCommands = sValue.Substring(iFirstAmpersandPosition);
                bRc = Utils.GetAllSubStrings(sCommands, "&", out sCommandList, out sError);

                return true;
            }
            catch (Exception e)
            {
                sError = e.Message;
                Audit(sError, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public void ActivateAlarmListOfCommands(string sAlarmNumber, string sStartDateTime)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sError;
            string sMessage;
            string sStage = "";
            string sAlarmBlockDescription;

            List<string> lCommandsFromPulseDatabase;
            List<PulseAlarmCommand> lPulseAlarmCommand = new List<PulseAlarmCommand>();
            List<int> lAlreadyOpen = new List<int>();

            CameraOpenType cotCameraOpenType = (sStartDateTime == "") ? CameraOpenType.Automatic : CameraOpenType.Manual;

            int iIndex;
            int iDisplayIndex;

            bool bHasDisplayByIndex = false; 

            #endregion

            try
            {
                Audit("Alarm Command From " + ((cotCameraOpenType == CameraOpenType.Manual) ? "Event Manager" : "Alarm Publisher"), 
                      sMethod,
                      AuditSeverity.Information);

                #region Stop Running Pre Defined Views Or Main Views
                
                m_bCutMainViewInTheMiddle = true;
                m_bCutPredefinedViewInTheMiddle = true;
                sStage = "Stop Running Pre Defined Views Or Main Views";

                #endregion

                #region Retreive The Pulse Commands From The Pulse Database

                sStage = "Retreive The Pulse Commands From The Pulse Database";

                if (sAlarmNumber.IndexOf(".") != DvrClientConstants.NONE)
                {
                    sAlarmNumber = sAlarmNumber.Substring(0, sAlarmNumber.IndexOf("."));
                }

                lCommandsFromPulseDatabase = GetAlarmListOfCommands(sAlarmNumber, out sError);
                if ((!string.IsNullOrEmpty(sError)) || (lCommandsFromPulseDatabase == null))
                {
                    Audit("Failed To Activate Alarm List Of Commands For Alarm[" + sAlarmNumber + "]. " + sError,
                          sMethod,
                          AuditSeverity.Warning);

                    return;
                }
                else
                {
                    if (lCommandsFromPulseDatabase.Count < 1)
                    {
                        sMessage = "No Commands For Alarm[" + sAlarmNumber + "]";
                        Audit(sMessage, sMethod, AuditSeverity.Warning);
                        Utils.Error(sMessage);

                        return;
                    }
                    else
                    {
                        Audit("Retreived " + lCommandsFromPulseDatabase.Count + 
                              " Commands For Alarm[" + sAlarmNumber + "]", 
                              sMethod,
                              AuditSeverity.Information);
                    }
                } 

                #endregion

                #region Retreive The Alarm Block Description From The Pulse Database

                sStage = "Retreive The Alarm Block Description From The Pulse Database";

                sAlarmBlockDescription = GetAlarmBlockDescription(sAlarmNumber, out sError);
                if (string.IsNullOrEmpty(sError))
                {
                    Audit("Failed Retreiving Alarm Block Description For Alarm[" + sAlarmNumber + "]. " + sError,
                          sMethod,
                          AuditSeverity.Warning);
                }
                else
                {
                    Audit("The Alarm Block Description For Alarm[" + sAlarmNumber + 
                          "] Is [" + sAlarmBlockDescription + "]",
                          sMethod,
                          AuditSeverity.Information);
                }

                #endregion

                #region Investigate The Cameras Needed To Be Opened And See If Some Of Them Are Already Open

                sStage = "Investigate The Cameras Needed To Be Opened And See If Some Of Them Are Already Open";

                for (iIndex = 0; iIndex < lCommandsFromPulseDatabase.Count; iIndex++)
                {
                    #region Data Members
                    
                    DateTime dtNow;
                    DateTime dtStartDateTime;
                    DateTime dtPreDateTime;
                    DateTime dtPostDateTime;

                    bool bDvrIdNumeric;
                    bool bIsPresetCommand;
                    bool bNowTimeAfterPostTime;

                    int iDvrId;
                    int iNumberOfAts;
                    int iCommandDisplayIndex;

                    string sCommandDisplayIndex;
                    string sVendor;
                    string sDvr;
                    string sCameraNumber;
                    string sCommand;
                    string sValue;
                    string sOriginalPulseCommand;
                    string sPulseCommand;

                    PulseAlarmCommand pac;
                    ActivationType activationType; 

                    #endregion

                    pac = new PulseAlarmCommand();
                    activationType = ActivationType.NotActive;

                    sPulseCommand = lCommandsFromPulseDatabase[iIndex];
                    sOriginalPulseCommand = sPulseCommand;

                    iNumberOfAts = Utils.GetNumberOfOccurences(sPulseCommand, "@");
                    if (iNumberOfAts > 0)
                    {
                        if (iNumberOfAts > 1)
                        {
                            //  more than 1 '@'. problematic command
                            Audit("Command[" + sOriginalPulseCommand + "] Illegal", sMethod, AuditSeverity.Warning);

                            continue;
                        }
                        else 
                        {
                            //  there is exactly 1 '@'

                            sCommandDisplayIndex = Utils.GetNthSubString(sPulseCommand, "@", 2);
                            sPulseCommand = Utils.GetNthSubString(sPulseCommand, "@", 1);

                            try
                            {
                                iCommandDisplayIndex = int.Parse(sCommandDisplayIndex);
                            }
                            catch (Exception)
                            {
                                iCommandDisplayIndex = DvrClientConstants.NONE;

                                Audit("Command[" + sOriginalPulseCommand + "] With Non Numeric Display Index", 
                                      sMethod, 
                                      AuditSeverity.Warning);

                                continue;
                            }

                            pac.DisplayIndex = iCommandDisplayIndex;
                            pac.HasDisplayIndex = true;
                        }
                    }
                    else
                    {
                        //  no '@'

                        pac.DisplayIndex = DvrClientConstants.NONE;
                        pac.HasDisplayIndex = false;
                    }

                    sVendor = Utils.GetNthSubString(sPulseCommand, ":", 1);

                    #region Calculate pre and post time

                    Audit("Pulse Command[" + sPulseCommand + "]", sMethod, AuditSeverity.Information);

                    if (cotCameraOpenType == CameraOpenType.Automatic)
                    {
                        dtStartDateTime = DateTime.Now;
                    }
                    else
                    {
                        try
                        {
                            dtStartDateTime = DateTime.ParseExact(sStartDateTime.Trim(),
                                                                  "dd/MM/yyyy HH:mm:ss",
                                                                  System.Globalization.CultureInfo.InvariantCulture);
                        }
                        catch (Exception e)
                        {
                            Audit(sStartDateTime + " Not A Valid Date. " + e.Message, 
                                  sMethod, 
                                  AuditSeverity.Warning);

                            continue;
                        }
                    }

                    dtPreDateTime = dtStartDateTime.AddSeconds(-1 * Convert.ToDouble(m_Settings.PlaybackPreEventTime));
                    dtPostDateTime = dtStartDateTime.AddSeconds(Convert.ToDouble(m_Settings.PlaybackPostEventTime));
                    dtNow = DateTime.Now;

                    bNowTimeAfterPostTime = (dtNow <= dtPostDateTime) ? false : true;

                    Audit("Start Date Time[" + dtStartDateTime.ToString() + "] " +
                          "Pre Date Time[" + dtPreDateTime.ToString() + "] " +
                          "Post Date Time[" + dtPostDateTime.ToString() + "] " +
                          "Now Date Time[" + dtNow.ToString() +
                          "] Now After Post Time[" + bNowTimeAfterPostTime + "]",
                          sMethod, 
                          AuditSeverity.Information);                    

                    #endregion

                    #region Is Dvr ID Ok?

                    sDvr = Utils.GetNthSubString(sPulseCommand, ":", 2);
                    sDvr = sDvr.Substring(3);

                    iDvrId = DvrClientConstants.NONE;
                    try
                    {
                        iDvrId = int.Parse(sDvr);
                        bDvrIdNumeric = true;
                    }
                    catch (Exception)
                    {
                        bDvrIdNumeric = false;
                    } 

                    #endregion

                    if ((bDvrIdNumeric) || (iDvrId != DvrClientConstants.NONE))
                    {
                        sCameraNumber = Utils.GetNthSubString(sPulseCommand, ":", 3);

                        //  is it a playback command?
                        if (sCameraNumber.IndexOf(",p") != DvrClientConstants.NONE)
                        {
                            #region Playback
                             
                            sCameraNumber = sCameraNumber.Substring(0, sCameraNumber.Length - 2);
                            sCommand = "VOD" + sCameraNumber;

                            if (pac.HasDisplayIndex)
                            {
                                sCommand += "D" + pac.DisplayIndex;
                            }

                            if ((cotCameraOpenType == CameraOpenType.Manual) && bNowTimeAfterPostTime)
                            {
                                sValue = "SD" + dtPreDateTime.ToString("dd/MM/yyyy HH:mm:ss") +
                                         " ED" + dtPostDateTime.ToString("dd/MM/yyyy HH:mm:ss");
                            }
                            else
                            {
                                double dblGapFromNow = (double)m_Settings.PlaybackGapFromNow;
                                dtNow = dtNow.AddSeconds(-1 * dblGapFromNow);

                                if (dtNow < dtPreDateTime)
                                {
                                    dtPreDateTime = dtPreDateTime.AddSeconds(-1 * dblGapFromNow);
                                }

                                sValue = "SD" + dtPreDateTime.ToString("dd/MM/yyyy HH:mm:ss") +
                                         " ED" + dtNow.ToString("dd/MM/yyyy HH:mm:ss");
                            }                                                    
                                                       
                            activationType = ActivationType.VideoOnDemand;
                            bIsPresetCommand = false;
                            
                            #endregion
                        }                        
                        else
                        {
                            #region Live Video

                            if ((cotCameraOpenType == CameraOpenType.Manual) && bNowTimeAfterPostTime)
                            {                                
                                sCommand = "VOD" + sCameraNumber;
                                if (pac.HasDisplayIndex)
                                {
                                    sCommand += "D" + pac.DisplayIndex;
                                }

                                sValue = "SD" + dtPreDateTime.ToString("dd/MM/yyyy HH:mm:ss") +
                                         " ED" + dtPostDateTime.ToString("dd/MM/yyyy HH:mm:ss");

                                activationType = ActivationType.VideoOnDemand;

                                int iLeftBracketPosition = sCameraNumber.IndexOf("[");
                                if (iLeftBracketPosition != DvrClientConstants.NONE)
                                {
                                    sCameraNumber = sCameraNumber.Substring(0, iLeftBracketPosition);
                                }

                                bIsPresetCommand = false;
                            }
                            else
                            {
                                #region Is it a preset command?

                                if ((sCameraNumber.IndexOf("[") != DvrClientConstants.NONE) &&
                                    (sCameraNumber.IndexOf("]") != DvrClientConstants.NONE))
                                {
                                    int iLeftBracketPosition = sCameraNumber.IndexOf("[");
                                    int iRightBracketPosition = sCameraNumber.IndexOf("]");
                                    string sPresetName = sCameraNumber.Substring(iLeftBracketPosition + 1,
                                                                                 iRightBracketPosition - (iLeftBracketPosition + 1));
                                    sCameraNumber = sCameraNumber.Substring(0, iLeftBracketPosition);

                                    activationType = ActivationType.LiveVideo;
                                    sCommand = "PRESET" + sCameraNumber;
                                    if (pac.HasDisplayIndex)
                                    {
                                        sCommand += "D" + pac.DisplayIndex;
                                    }

                                    sValue = sPresetName;
                                    bIsPresetCommand = true;
                                }

                                #endregion
                                else
                                #region or a monitor command?

                                {
                                    activationType = ActivationType.LiveVideo;
                                    sCommand = "M" + sCameraNumber;
                                    if (pac.HasDisplayIndex)
                                    {
                                        sCommand += "D" + pac.DisplayIndex;
                                    }

                                    sValue = "1.0";
                                    bIsPresetCommand = false;
                                }

                                #endregion
                            }   

                            #endregion                          
                        }

                        pac.DvrID = iDvrId;
                        //pac.DvrName = GetDvrName(iDvrId);
                        //if (string.IsNullOrEmpty(pac.DvrName))
                        //{
                        //    Audit("Command[" + sPulseCommand + "] Dvr Name Is Null Or Empty", 
                        //          sMethod, 
                        //          AuditSeverity.Warning);

                        //    continue;
                        //}

                        try
                        {
                            pac.CameraNumber = int.Parse(sCameraNumber);
                        }
                        catch (Exception)
                        {
                            Audit("Command[" + sPulseCommand + "] Camera Number Is Not Numeric", 
                                  sMethod, 
                                  AuditSeverity.Warning);

                            continue;
                        }
                        pac.CameraActivationType = activationType;
                        pac.Command = sCommand;
                        pac.Value = sValue;
                        pac.IsPresetCommand = bIsPresetCommand;

                        switch (activationType)
                        {
                            case ActivationType.LiveVideo:
                                iDisplayIndex = DisplayManager_FindIndex(pac.DvrID, 
                                                                         pac.CameraNumber, 
                                                                         ActivationType.LiveVideo);
                                if (iDisplayIndex == DvrClientConstants.NONE)
                                {
                                    pac.IsAlreadyOpen = false;
                                    pac.Display = DvrClientConstants.NONE;
                                }
                                else
                                {
                                    pac.IsAlreadyOpen = true;
                                    pac.Display = iDisplayIndex;
                                    lAlreadyOpen.Add(iDisplayIndex);
                                }
                                break;

                            default:
                                pac.IsAlreadyOpen = false;
                                break;
                        }

                        lPulseAlarmCommand.Add(pac);
                    }
                    else
                    {
                        Audit("DVR ID[" + sDvr + "] Not Numeric Or Unknown. Command[" + sPulseCommand + 
                              "] Discarded.",
                              sMethod, 
                              AuditSeverity.Warning);
                    }
                } 

                #endregion

                #region Change Display Mode To Number Of Incomming Commands

                if (cotCameraOpenType == CameraOpenType.Automatic)
                {
                    int iMaxDisplayNumberIndex = 0;
                    int iNumberOfActiveDisplays;

                    sStage = "Change Display Mode To Number Of Incomming Commands";

                    for (int iCommand = 0; iCommand < lPulseAlarmCommand.Count; iCommand++)
                    {
                        if (lPulseAlarmCommand[iCommand].HasDisplayIndex)
                        {
                            if (lPulseAlarmCommand[iCommand].DisplayIndex > iMaxDisplayNumberIndex)
                            {
                                iMaxDisplayNumberIndex = lPulseAlarmCommand[iCommand].DisplayIndex;
                            }

                            bHasDisplayByIndex = true;
                        }
                    }

                    iNumberOfActiveDisplays = Math.Max(iMaxDisplayNumberIndex, lPulseAlarmCommand.Count);

                    if (!m_bFixedLayout)
                    {
                        ChangeDisplayMode(DisplayManager_FindOptimalNormalLayout(iNumberOfActiveDisplays));
                    }
                    LoadingPictureOnEmptyDisplays();
                    m_bNoAdaption = true;
                }

                #endregion

                #region Close The Cameras On The Grid Needed To Be Closed

                sStage = "Close The Cameras On The Grid Needed To Be Closed";

                switch (cotCameraOpenType)
                {
                    case CameraOpenType.Automatic:
                        if (m_Settings.CloseManualCamerasOnEvent)
                        {
                            CloseAllCameras(lAlreadyOpen);
                        }
                        else
                        {
                            CloseAllCamerasExceptManuals(lAlreadyOpen);
                        }
                        break;


                    case CameraOpenType.Manual:
                        Audit("Manual Open Type. No Cameras Closed.", sMethod, AuditSeverity.Information);
                        break;


                    default:
                        Audit("Wrong Camera Open Type[" + cotCameraOpenType.ToString() + "]", sMethod, AuditSeverity.Warning);
                        break;
                } 

                #endregion

                #region Perform The Pulse Commands Needed To Be Performed

                sStage = "Perform The Pulse Commands Needed To Be Performed";

                for (iIndex = 0; iIndex < lPulseAlarmCommand.Count; iIndex++)
                {
                    if (lPulseAlarmCommand[iIndex].IsAlreadyOpen == false)
                    {
                        ParseSyntax(lPulseAlarmCommand[iIndex].DvrID,
                                    lPulseAlarmCommand[iIndex].Command,
                                    lPulseAlarmCommand[iIndex].Value,
                                    ActionType.Write,
                                    "Alarms");

                        Audit("Alarm[" + sAlarmNumber +
                              "] Command Number(" + (iIndex + 1) +
                              ") [" + lPulseAlarmCommand[iIndex].Command +
                              "] Value[" + lPulseAlarmCommand[iIndex].Value + "]",
                              sMethod,
                              AuditSeverity.Information);
                    }
                    else
                    {
                        if (lPulseAlarmCommand[iIndex].IsPresetCommand)
                        {
                            ParseSyntax(lPulseAlarmCommand[iIndex].DvrID,
                                        lPulseAlarmCommand[iIndex].Command,
                                        lPulseAlarmCommand[iIndex].Value,
                                        ActionType.Write,
                                        "Alarm");

                            Audit("Alarm[" + sAlarmNumber +
                                  "] Command Number(" + (iIndex + 1) +
                                  ") [" + lPulseAlarmCommand[iIndex].Command +
                                  "] Value[" + lPulseAlarmCommand[iIndex].Value + "]. Only Preset Activation.",
                                  sMethod, 
                                  AuditSeverity.Information);
                        }
                        else
                        { 
                            Audit("Alarm[" + sAlarmNumber +
                                  "] Command Number(" + (iIndex + 1) +
                                  ") [" + lPulseAlarmCommand[iIndex].Command +
                                  "] Value[" + lPulseAlarmCommand[iIndex].Value + "] Not Activated. Already Open.",
                                  sMethod, 
                                  AuditSeverity.Warning);
                        }
                    }
                } 

                #endregion

                #region Tag Alarm Cameras With alarmID, Open Type And Block Description

                sStage = "Tag Alarm Cameras With alarmID, Open Type And Block Description";

                for (iIndex = 0; iIndex < lPulseAlarmCommand.Count; iIndex++)
                {
                    if (lPulseAlarmCommand[iIndex].IsAlreadyOpen)
                    {
                        iDisplayIndex = lPulseAlarmCommand[iIndex].Display;
                    }
                    else
                    {
                        iDisplayIndex = DisplayManager_FindIndex(lPulseAlarmCommand[iIndex].DvrName,
                                                                 lPulseAlarmCommand[iIndex].CameraNumber,
                                                                 lPulseAlarmCommand[iIndex].CameraActivationType);
                    }

                    if (iDisplayIndex != DvrClientConstants.NONE)
                    {
                        DisplayManager_SetInitiatingAlarm(iDisplayIndex, int.Parse(sAlarmNumber));
                        DisplayManager_SetCameraOpenType(iDisplayIndex, cotCameraOpenType);
                        DisplayManager_SetEventString(iDisplayIndex, sAlarmBlockDescription);
                    }
                    else
                    {
                        Audit("Can't Find Camera[" + lPulseAlarmCommand[iIndex].CameraNumber +
                              "] On DVR[" + lPulseAlarmCommand[iIndex].DvrName +
                              "] Activation Type[" + lPulseAlarmCommand[iIndex].CameraActivationType.ToString() +
                              "]",
                              sMethod, 
                              AuditSeverity.Warning);
                    }
                }     

                #endregion

                if (!bHasDisplayByIndex)
                {
                    FallBackDisplays();
                }
                NoVideoPictureOnEmptyDisplays();

                #region Let The Pre Defined Views Or Main Views Run Free

                sStage = "Let The Pre Defined Views Or Main Views Run Free";

                m_bCutMainViewInTheMiddle = false;
                m_bCutPredefinedViewInTheMiddle = false;

                #endregion

                if (m_Settings.UseAlarmsQueue)
                {
                    if (m_Settings.GapBetweenAlarmsInMiliSeconds == 0)
                    {
                        PulseAlarmQ_AlarmArrived_Handler(null, null);
                    }
                    else
                    {
                        tmrActivateAlarm.Enabled = true;
                    } 
                }
            }
            catch (Exception e)
            {
                Audit("Can't Activate Alarm List Of Commands For Alarm Number[" + sAlarmNumber + "]. " + 
                      sStage + ". " +
                      e.Message,
                      sMethod,
                      AuditSeverity.Warning);
            }
        }

        private int GetDisplayIndexByCommand(string sDvrIdAndCommand, out string sError)
        {
            #region Data Members
            
            string sSiteID;
            string sSiteName;
            string sCommand;
            string sCommandString;

            int iSiteId;
            int iCamera = DvrClientConstants.NONE;
            int iColor = DvrClientConstants.NONE;
            int iDisplay = DvrClientConstants.NONE;
            int iDisplayIndex;

            ActivationType activationType; 

            #endregion

            try 
	        {	        
	            sError = "";
                sSiteID = Utils.GetNthSubString(sDvrIdAndCommand, "@", 1);

                try
                {
                    iSiteId = int.Parse(sSiteID);
                    sSiteName = GetDvrName(iSiteId);
                }
                catch (Exception)
                {                
                    sError = "Site ID[" + sSiteID + "] Not Numeric";

                    return DvrClientConstants.NONE;
                }

                sCommand = Utils.GetNthSubString(sDvrIdAndCommand, "@", 2);

                switch (sCommand.Substring(0,1).ToUpper())
                {
                    case "M":
                        sCommandString = DvrClientConstants.MONITOR_STRING;
                        activationType = ActivationType.LiveVideo;
                        break;

                    case "V":
                        sCommandString = DvrClientConstants.VOD_STRING;
                        activationType = ActivationType.VideoOnDemand;
                        break;

                    case "P":
                        sCommandString = DvrClientConstants.PRESET_STRING;
                        activationType = ActivationType.LiveVideo;
                        break;

                    default:
                        sError = "Unidentified Command [" + sCommand + "]";
                        return DvrClientConstants.NONE;
                }

                NukeCommandReplay ncr = Utils.NukeCommand(sCommand,
                                                           sCommandString,
                                                           ref iCamera,
                                                           ref iDisplay,
                                                           ref iColor);

                if (iCamera != DvrClientConstants.NONE)
                {
                    iDisplayIndex = DisplayManager_FindIndex(sSiteName, iCamera, activationType); 

                    return iDisplayIndex;
                }

                sError = "Camera Number Not Nuked From Command[" + sCommand + "] Type[" + sCommandString + "]";

                return DvrClientConstants.NONE;
	        }
	        catch (Exception e)
	        {
                sError = "Failed To Get Display Index By Command From Dvr ID And Command[" + 
                         sDvrIdAndCommand+ "]." + e.Message;

                return DvrClientConstants.NONE;
	        }
        }

        private void EndEventsTree()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (m_PulseAlarmsTree != null && 
                !m_PulseAlarmsTree.IsDisposed && 
                !m_PulseAlarmsTree.Disposing)
            {
                m_PulseAlarmsTree.Close();
                m_PulseAlarmsTree = null;
                Utils.WriteToDebugView(DvrClientModule.Main,
                                       sMethod,
                                       "Pulse Alarms Tree Closed",
                                       AuditSeverity.Important);
            }
            else 
            {
                Utils.WriteToDebugView(DvrClientModule.Main,
                                       sMethod,
                                       "No Pulse Alarms Tree To Close",
                                       AuditSeverity.Warning);
            }
        }

        private void PulseAlarmQ_AlarmArrived_Handler(object sender, EventArgs e)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;

            object oItem;

            PulseAlarmQueueItem paqi; 

            #endregion

            try
            {
                m_PulseAlarmQ.AlarmArrived -= PulseAlarmQ_AlarmArrived_Handler;

                Audit("Get Item From Q", sMethod, AuditSeverity.Information);
                oItem = m_PulseAlarmQ.GetItem();

                if (oItem != null)
                {
                    paqi = (PulseAlarmQueueItem)oItem;
                    Audit("Fetched From Q Alarm[" + paqi.AlarmNumber + "]", sMethod, AuditSeverity.Information);

                    ActivateAlarmListOfCommands(paqi);
                }
                else
                {
                    Audit("Q Empty", sMethod, AuditSeverity.Information);                    
                }

                m_PulseAlarmQ.AlarmArrived += new EventHandler(PulseAlarmQ_AlarmArrived_Handler);
            }
            catch (Exception ex)
            {
                m_PulseAlarmQ.AlarmArrived += new EventHandler(PulseAlarmQ_AlarmArrived_Handler);

                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void PrintList()        
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            List<object> l = m_PulseAlarmQ.GetQueue();
            if (l != null)
            {
                for (int i = 0; i < l.Count; i++)
			    {
                    Audit(i + ") " + ((PulseAlarmQueueItem)(l[i])).AlarmNumber, sMethod, AuditSeverity.Information);
			    }                
            }
        }

        #endregion

        #region Timers

        private void tmrTreeRefresh_Tick(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            tmrTreeRefresh.Enabled = false;

            RefreshTree();
            PrepareDvrTreeContextMenu();

            if (m_sLoggers.Count == 0)
            {
                Audit("Restarting Connection To NICE AMS", sMethod, AuditSeverity.Warning);

                //DoDisconnectNice();
                DoEvents();
                //DoConnectNice();
                DoEvents();

                return;
            }

            tmrTreeRefresh.Interval = m_Settings.RefreshTreeTimeInterval * DvrClientConstants.SECONDS;    
            tmrTreeRefresh.Enabled = true;
        }

        private void tmrOnTop_Tick(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            tmrOnTop.Enabled = false;

            Audit("On Top Deactivated", sMethod, AuditSeverity.Information);

            ActivateOnTop(false);
        }

        private void tmrProblematic2StopIndex_Tick(object sender, EventArgs e)
        {
        //    DoStopCamera(m_Problematic2StopDisplayIndex);
        }

        private void tmrProblematic2StartIndex_Tick(object sender, EventArgs e)
        {
        //    StartCamera_X_on_Display_Y(m_Problematic2StartSiteName,
        //                               m_Problematic2StartCameraNumber,
        //                               m_Problematic2StartDisplayIndex,
        //                               m_Problematic2StartColorNumber,
        //                               m_Problematic2StartEventMessage,
        //                               true);
        }

        private void tmrScheduler_Tick(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (m_SchedulerTasks.SchedulerEntry == null)
            {
                return;
            }

            if (m_SchedulerTasks.SchedulerEntry.Count == 0)
            {
                return;
            }

            //Audit("Display[" + 
            //      m_SchedulerTasks.SchedulerEntry[0].DisplayIndex + 
            //      "] Stop Time[" + 
            //      m_SchedulerTasks.SchedulerEntry[0].Time.ToString() + 
            //      "] Now[" + DateTime.Now + "]", 
            //      sMethod);

            if (Utils.DateDiff(DateTime.Now, m_SchedulerTasks.SchedulerEntry[0].Time) == 0)
            {
                int iDisplayIndex;

                iDisplayIndex = m_SchedulerTasks.SchedulerEntry[0].DisplayIndex - 1;

                DisplayManager_SetDisplayPlaybackFinised(iDisplayIndex, true);
                m_SchedulerTasks.SchedulerEntry.RemoveRange(0, 1);
            }
        }

        private void tmrLoggersConectivity_Tick(object sender, EventArgs e)
        {
            if (m_LoggersKeepaliveThread == null)
            {
                return;
            }

            m_LoggerConectivity = m_LoggersKeepaliveThread.GetLoggersConnectivity();
        }

        private void timerUpdateTrackBar_Tick(object sender, EventArgs e)
        {
            int iActiveDisplayIndex = DisplayManager_GetActiveDisplayIndex();
            if (iActiveDisplayIndex == DvrClientConstants.NONE)
            {
                return;
            }

            // Update the trackbar's value to the current playback position
            //UpdateTrackBarValue();
        }

        private void tmrFullScreen_Tick(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            #region HD Limit Reached Time Interval

            if (m_iHdLimitReachedTimeInterval >= 120)
            {
                m_iHdLimitReachedTimeInterval = 0;
                if (Utils.GetHdFreeSpace(m_sDrive) < (double)m_Settings.HdMinimumFreeSpace)
                {
                    m_bHdLimitReached = true;
                }
                else
                {
                    m_bHdLimitReached = false;
                }
            }
            m_iHdLimitReachedTimeInterval++;

            #endregion

            #region Pulse Events Tree

            if ((m_PulseAlarmsTree != null) && (!m_PulseAlarmsTree.IsDisposed))
            {
                if (m_bHidePulseEventsTree)
                {
                    if (m_PulseAlarmsTree.Visible == true)
                    {
                        m_PulseAlarmsTree.Visible = false;
                    }
                }
                else
                {
                    if (m_PulseAlarmsTree.Visible == false)
                    {
                        m_PulseAlarmsTree.Visible = true;
                    }
                }
            } 

            #endregion

            #region Display Manager Viewer

            if ((m_DisplayManagerViewer == null) || (m_DisplayManagerViewer.IsDisposed))
            {
                if (m_bShowDisplayManagerViewer == true)
                {
                    mnuDisplayManagerView_Click(null, null);
                }
            } 

            #endregion

            #region Dvr Client Data Scope

            if ((m_DvrClientDataScope == null) || (m_DvrClientDataScope.IsDisposed))
            {
                if (m_bShowDvrClientDataScope == true)
                {
                    mnuDataScope_Click(null, null);
                }
            } 

            #endregion

            #region Dvrs And Cameras Information

            if ((m_frmDvrsAndCamerasInformation == null) || (m_frmDvrsAndCamerasInformation.IsDisposed))
            {
                if (m_bShowDvrsAndCamerasInformation == true)
                {
                    mnuDvrsAndCamerasInformation_Click(null, null);
                }
            }

            #endregion

            #region Settings

            if ((m_frmSettings == null) || (m_frmSettings.IsDisposed))
            {
                if (m_bShowSettings == true)
                {
                    mnuSettings_Click(null, null);
                }
            } 

            #endregion            

            #region Display Templates
            
            if ((m_DisplayTemplate == null) || (m_DisplayTemplate.IsDisposed))
            {
                if (m_bShowDisplayTemplates == true)
                {
                    if (m_WorkMode == WorkMode.Drag)
                    {
                        mnuDisplayTemplates_Click(null, null);
                    }
                    else 
                    {
                        m_bShowDisplayTemplates = false;
                        MessageBox.Show("To Work With Templates Switch To Drag Mode", 
                                        "Templates",
                                        MessageBoxButtons.OK,
                                        MessageBoxIcon.Exclamation);
                    }
                }
            }
                        
            #endregion 

            #region Unhide menu

            if (m_bUnhideMenu == true)
            {
                UnhideMenu();
            }

            #endregion

            #region Windows Handles

            //Process[] processes = Process.GetProcessesByName(m_sProcessName);

            //foreach (Process p in processes)
            //{
            //    lblHandles.Text = "Windows Handles " + p. HandleCount.ToString();
            //    DoEvents();
            //}

            #endregion

            #region Full Screen

            if (DisplayManager_ActiveDisplays() == 0)
            {
                m_bNoActiveDisplays = true;

                if (!m_bFixedLayout)
                {
                    if (DisplayManager_GetMode() != DisplayFormatState.OneView)
                    {
                        if (!m_bCutMainViewInTheMiddle && !m_bCutPredefinedViewInTheMiddle)
                        {
                            FallBackDisplays();
                        }
                    } 
                }

                return;
            }
            else 
            {
                m_bNoActiveDisplays = false;
            }

            switch (triFullScreen)
            {
                case Trinar.True:
                    //triFullScreen = Trinar.Idle;
                    if (m_bKeyPressed)
                    {
                        Audit("Activate Full Screen", sMethod, AuditSeverity.Information);

                        if (DisplayManager_GetActiveDisplayIndex() == DvrClientConstants.NONE)
                        {
                            Audit("Activate Full Screen Canceled. No Active Display",
                                  sMethod,
                                  AuditSeverity.Warning);

                            m_bKeyPressed = false;
                            m_bStopF11Activity = false;
                            triFullScreen = Trinar.False;

                            return;
                        }

                        if (!FullScreen())
                        {
                            Audit("Full Screen Activation Failed", sMethod, AuditSeverity.Warning);

                            return;
                        }

                        if (m_Settings.Mode == ActivationMode.StandAlone)
                        {
                            OnFullScreenChanged();
                        }

                        m_bKeyPressed = false;
                        m_bStopF11Activity = false;

                        Audit("Full Screen Activated", sMethod, AuditSeverity.Information);
                    }
                    break;

                case Trinar.False:                    
                    //triFullScreen = Trinar.Idle;
                    if (m_bKeyPressed)
                    {
                        Audit("Back To Normal Screen", sMethod, AuditSeverity.Information);

                        if (DisplayManager_GetActiveDisplayIndex() == DvrClientConstants.NONE)
                        {
                            Audit("Back To Normal Screen Canceled. No Active Display",
                                  sMethod,
                                  AuditSeverity.Warning);

                            m_bKeyPressed = false;
                            m_bStopF11Activity = false;
                            triFullScreen = Trinar.True;

                            return;
                        }

                        NormalScreen();

                        if (m_Settings.Mode == ActivationMode.StandAlone)
                        {
                            OnBackToNormalScreen();
                        }
                        stMain.Focus();

                        m_bKeyPressed = false;
                        m_bStopF11Activity = false;
                    }
                    break;

                default:
                    break;
            }

            #endregion
        }

        private void tmrInstanceCheckTimePassed_Tick(object sender, EventArgs e)
        {
            //m_bInstanceCheckTimePassed = true;
        }

        private void tmrErrorMessage_Tick(object sender, EventArgs e)
        {
            lblErrorMessage.Text = "";
            tmrErrorMessage.Enabled = false;
        }

        private void tmrMultiTimer_Tick(object sender, EventArgs e)
        {
            #region Data Members
            
            int i;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            List<MultiTimerItem> lPtzPreset; 

            #endregion

            try
            {
                lPtzPreset = m_MultiTimer.Tick();
                if (lPtzPreset.Count > 0)
                {
                    Audit("There Are " + lPtzPreset.Count + " Presets To Activate", sMethod, AuditSeverity.Information);
                    for (i = 0; i < lPtzPreset.Count; i++)
                    {
                        int iDvrId = int.Parse(lPtzPreset[i].DvrName);
                        int iDvrGroupId = GetServerGroupId(iDvrId);
                        int iCameraNumber = lPtzPreset[i].CameraNumber;

                        int iDisplayIndex = DisplayManager_FindIndex(iDvrId, iCameraNumber, ActivationType.LiveVideo);

                        if (iDisplayIndex > DvrClientConstants.NONE)
                        {
                            if (ActivatePreset(iDvrGroupId,
                                               iDvrId,
                                               iCameraNumber,
                                               iDisplayIndex,
                                               lPtzPreset[i].Preset))
                            {
                                AuditPerform("Activated Preset[" + lPtzPreset[i].Preset + "]. Openning On Display[" + iDisplayIndex +
                                             "] Camera[" + iCameraNumber +
                                             "] On DVR[" + iDvrId +
                                             "].",
                                             sMethod,
                                             AuditSeverity.Information);
                            }
                            else
                            {
                                AuditPerform("Faild To Activate Preset[" + lPtzPreset[i].Preset +
                                             "]. Can't Open On Display[" + iDisplayIndex +
                                             "] Camera[" + iCameraNumber +
                                             "] On DVR[" + iDvrId +
                                             "].",
                                             sMethod,
                                             AuditSeverity.Warning);
                            }
                        }
                    }
                }
                //else
                //{
                //    Audit("Multi Timer Empty", sMethod);
                //}
            }
            catch (Exception ex)
            {
                AuditPerform(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        private void tmrEventTreeRefresh_Tick(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sError;

            tmrEventTreeRefresh.Enabled = false;

            if (m_PulseAlarmsTree != null)
            {
                if (!GetAllPulseDatabaseAlarmCommands(out sError))
                {
                    Audit("Failed Getting Pulse Database Alarm Commands. " + sError, sMethod, AuditSeverity.Warning);
                }
                else
                {
                    Audit(m_PulseAlarm.Count + " Alarms Feched From Pulse Database", sMethod, AuditSeverity.Information);
                    try
                    {
                        m_PulseAlarmsTree.RefreshTree(m_PulseAlarm);
                    }
                    catch (Exception ex)
                    {
                        Audit(ex.Message, sMethod, AuditSeverity.Error);
                    }
                } 
            }

            tmrEventTreeRefresh.Interval = m_Settings.RefreshEventTreeTimeInterval * DvrClientConstants.SECONDS;
            tmrEventTreeRefresh.Enabled = true;
        }

        private void tmrHandles_Tick(object sender, EventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sHandleCount = "";
            string sMaxWorkingSet = "";
            string sMinWorkingSet = "";
            string sNonpagedSystemMemorySize64 = "";
            string sPagedSystemMemorySize64 = "";
            string sPagedMemorySize64 = "";
            string sPeakPagedMemorySize64 = "";
            string sPeakVirtualMemorySize64 = "";
            string sPeakWorkingSet64 = "";
            string sPrivateMemorySize64 = "";

            Process[] processes = Process.GetProcessesByName(m_sProcessName);

            foreach (Process p in processes)
            {
                sHandleCount = p.HandleCount.ToString();
                sMaxWorkingSet = p.MaxWorkingSet.ToString();
                sMinWorkingSet = p.MinWorkingSet.ToString();
                sNonpagedSystemMemorySize64 = p.NonpagedSystemMemorySize64.ToString();
                sPagedMemorySize64 = p.PagedMemorySize64.ToString();
                sPagedSystemMemorySize64 = p.PagedSystemMemorySize64.ToString();
                sPeakPagedMemorySize64 = p.PeakPagedMemorySize64.ToString();
                sPeakVirtualMemorySize64 = p.PeakVirtualMemorySize64.ToString();
                sPeakWorkingSet64 = p.PeakWorkingSet64.ToString();
                sPrivateMemorySize64 = p.PrivateMemorySize64.ToString();

                DoEvents();
            }

            Audit("HandleCount: " + sHandleCount, sMethod, AuditSeverity.Important);
            Audit("MaxWorkingSet: " + sMaxWorkingSet, sMethod, AuditSeverity.Important);
            Audit("MixWorkingSet: " + sMinWorkingSet, sMethod, AuditSeverity.Important);
            Audit("NonpagedSystemMemorySize64: " + sNonpagedSystemMemorySize64, sMethod, AuditSeverity.Important);
            Audit("PagedMemorySize64: " + sPagedMemorySize64, sMethod, AuditSeverity.Important);
            Audit("PagedSystemMemorySize64: " + sPagedSystemMemorySize64, sMethod, AuditSeverity.Important);
            Audit("PeakPagedMemorySize64: " + sPeakPagedMemorySize64, sMethod, AuditSeverity.Important);
            Audit("PeakVirtualMemorySize64: " + sPeakVirtualMemorySize64, sMethod, AuditSeverity.Important);
            Audit("PeakWorkingSet64: " + sPeakWorkingSet64, sMethod, AuditSeverity.Important);
            Audit("PrivateMemorySize64: " + sPrivateMemorySize64, sMethod, AuditSeverity.Important);
        }

        private void tmrMainScheduler_Tick(object sender, EventArgs e)
        {
            Object thisLock = new Object();

            tmrMainScheduler.Enabled = false;

            if (m_TimerQ != null)
            {
                for (int i = 0; i < m_TimerQ.Count; i++)
                {
                    m_TimerQ[i].TimeToActivation -= 100;

                    if (m_TimerQ[i].TimeToActivation == 0)
                    {
                        TimerQItem tqi = m_TimerQ[i];
                        lock (thisLock)
                        {
                            m_ActivationQ.Add(tqi);
                        }

                        lock (thisLock)
                        {
                            m_TimerQ.RemoveAt(i);
                        }

                        if (tqi.Cyclic)
                        {
                            lock (thisLock)
                            {
                                tqi.TimeToActivation = tqi.OriginalTimeToActivation;
                                m_TimerQ.Add(tqi);
                            }
                        }
                    }
                }
            }

            tmrMainScheduler.Enabled = true;
        }

        private void tmrActivation_Tick(object sender, EventArgs e)
        {
            Object thisLock = new Object();

            if (m_ActivationQ != null)
            {
                if (m_ActivationQ.Count > 0)
                {
                    tmrActivation.Enabled = false;

                    TimerQItem tqi = m_ActivationQ[0];
                    lock (thisLock)
                    {
                        m_ActivationQ.RemoveAt(0);
                    }

                    ActivateFunction(tqi.Command, tqi.Arguments);

                    tmrActivation.Enabled = true;
                }
            }
        }

        private void tmrActivateAlarm_Tick(object sender, EventArgs e)
        {
            tmrActivateAlarm.Enabled = false;

            PulseAlarmQ_AlarmArrived_Handler(null, null);
        }

        private void tmrIsNicePlayerManagerConnected_Tick(object sender, EventArgs e)
        {
            tmrIsNicePlayerManagerConnected.Enabled = false;

            //if (m_PlayerManager != null)
            //{
            //    if (!m_PlayerManager.Initialized)
            //    {
            //        DoConnectNice();
            //    }

            //    NicePlayerManagerConnected = m_PlayerManager.Initialized; 
            //}

            tmrIsNicePlayerManagerConnected.Enabled = true;
        }  

        private void KillAllTimers()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                tmrScheduler.Enabled = false;
                tmrTreeRefresh.Enabled = false;
                tmrOnTop.Enabled = false;
                tmrLoggersConectivity.Enabled = false;
                tmrFullScreen.Enabled = false;
                timerUpdateTrackBar.Enabled = false;
                tmrProblematic2Start.Enabled = false;
                tmrProblematic2Stop.Enabled = false;
                tmrInstanceCheckTimePassed.Enabled = false;
                tmrErrorMessage.Enabled = false;
                tmrMultiTimer.Enabled = false;
                tmrEventTreeRefresh.Enabled = false;
                tmrActivation.Enabled = false;
                tmrMainScheduler.Enabled = false;
                tmrActivateAlarm.Enabled = false;
                tmrIsNicePlayerManagerConnected.Enabled = false;

                Utils.WriteToDebugView(DvrClientModule.Main,
                                       sMethod,
                                       "All Main Form Timers Killed",
                                       AuditSeverity.Important);
            }
            catch (Exception e)
            {
                Utils.WriteToDebugView(DvrClientModule.Main, 
                                       sMethod,
                                       "Failed Killing All Main Form Timers. " + e.Message, 
                                       AuditSeverity.Warning);
            }
        }

        #endregion

        #region Database

        private void GetConnectionStringProperties(string sConnectionString, 
                                                   out string sProvider, 
                                                   out string sDataSource,
                                                   out string sFullFileName,
                                                   out DatabaseProvider databaseProvider)
        {
            #region Data Members

            bool bFlag;
            
            int iCounter;
            int iPosition;

            string sDatabaseProvider;
            string [] sConnectionStringProperty;

            #endregion

            sProvider = "";
            sDataSource = "";
            sFullFileName = "";
            sDatabaseProvider = "";
            databaseProvider = DatabaseProvider.Unknown;

            if (string.IsNullOrEmpty(sConnectionString))
            {
                return;
            }

            sConnectionStringProperty = Utils.GetAllSubStrings(sConnectionString, ";");
            
            bFlag = true;
            iCounter = 0;
            while (bFlag)
            {
                if (sConnectionStringProperty[iCounter] == null)
                {
                    bFlag = false;

                    break;
                }

                if ((sConnectionStringProperty[iCounter]).ToUpper().IndexOf("PROVIDER") == 0)
                {
                    sProvider = sConnectionStringProperty[iCounter];
                    
                    iPosition = sProvider.IndexOf("=");
                    if (iPosition != DvrClientConstants.NONE)
                    {
                        sDatabaseProvider = sProvider.Substring(iPosition + 1);
                    }

                    switch (sDatabaseProvider)
                    {
                        case "Microsoft.Jet.OLEDB.4.0":
                        case "Microsoft.ACE.OLEDB.12.0":
                            databaseProvider = DatabaseProvider.MsAccess;
                            break;

                        case "SQLOLEDB.1":
                            databaseProvider = DatabaseProvider.SqlServer;
                            break;

                        default:
                            break;
                    }
                }

                if ((sConnectionStringProperty[iCounter]).ToUpper().IndexOf("DATA SOURCE") == 0)
                {
                    sDataSource = sConnectionStringProperty[iCounter];
                }

                iCounter++;

                if (iCounter == sConnectionStringProperty.Length)
                {
                    bFlag = false;
                }
            }

            iPosition = sDataSource.IndexOf("=");
            if (iPosition != DvrClientConstants.NONE)
            {
                sFullFileName = sDataSource.Substring(iPosition + 1);
            }
        }

        private DbReturnCode OpenConnection()
        {
            #region Data Members
            
            bool bDatabaseExists = false;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sPath;
            string sProvider;
            string sDataSource;
            string sFullFileName;

            DatabaseProvider databaseProvider;
            
            Catalog cat; 

            #endregion

            try
            {
                if ((m_cn != null) && (m_cn.State == ConnectionState.Open))
                {
                    return DbReturnCode.FinishedOK;
                }

                m_cn = new OleDbConnection();

                if (!string.IsNullOrEmpty(m_Settings.ConnectionString))
                {
                    GetConnectionStringProperties(m_Settings.ConnectionString,
                                                  out sProvider,
                                                  out sDataSource,
                                                  out sFullFileName,
                                                  out databaseProvider);
                }
                else 
                {
                    sProvider = "Provider=Microsoft.Jet.OLEDB.4.0";                
                    sPath = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);
                    sFullFileName = sPath + "\\" + DvrClientConstants.APPLICATION_NAME + ".mdb";
                    sDataSource = "Data Source=" + sFullFileName;

                    databaseProvider = DatabaseProvider.MsAccess;
                }

                m_DatabaseProvider = databaseProvider;
                switch (databaseProvider)
                {
                    case DatabaseProvider.MsAccess:
                        #region MsAccess

                        if (string.IsNullOrEmpty(sProvider))
                        {
                            sProvider = "Provider=Microsoft.Jet.OLEDB.4.0";
                        }

                        if (string.IsNullOrEmpty(sDataSource) || string.IsNullOrEmpty(sFullFileName))
                        {
                            sPath = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);
                            sFullFileName = sPath + "\\" + DvrClientConstants.APPLICATION_NAME + ".mdb";
                            sDataSource = "Data Source=" + sFullFileName;
                        }

                        m_cn.ConnectionString = sProvider + ";" + sDataSource;

                        bDatabaseExists = File.Exists(sFullFileName);

                        if (!bDatabaseExists)
                        {
                            //  create DvrProxy.mdb                
                            cat = new Catalog();
                            cat.Create(m_cn.ConnectionString);

                            //  create tables
                            #region Version Table

                            Table nTableVersion = new Table();
                            nTableVersion.Name = "Version";
                            nTableVersion.Columns.Append("Version", DataTypeEnum.adVarWChar, 50);
                            cat.Tables.Append(nTableVersion);

                            #endregion

                            #region Patrols Table

                            Table nTablePatrols = new Table();
                            nTablePatrols.Name = "Patrols";
                            nTablePatrols.Columns.Append("Id", DataTypeEnum.adInteger, 8);
                            nTablePatrols.Columns.Append("PatrolName", DataTypeEnum.adVarWChar, 50);
                            nTablePatrols.Columns.Append("PatrolLayout", DataTypeEnum.adVarWChar, 50);
                            nTablePatrols.Columns.Append("IsCyclic", DataTypeEnum.adBoolean, 50);
                            cat.Tables.Append(nTablePatrols);

                            #endregion

                            #region Patrol Items Table

                            Table nTablePatrolItems = new Table();
                            nTablePatrolItems.Name = "PatrolItems";
                            nTablePatrolItems.Columns.Append("Id", DataTypeEnum.adInteger, 8);
                            nTablePatrolItems.Columns.Append("PatrolId", DataTypeEnum.adInteger, 8);
                            nTablePatrolItems.Columns.Append("Dvr", DataTypeEnum.adVarWChar, 50);
                            nTablePatrolItems.Columns.Append("CameraNumber", DataTypeEnum.adInteger, 8);
                            nTablePatrolItems.Columns.Append("DisplayNumber", DataTypeEnum.adInteger, 8);
                            nTablePatrolItems.Columns.Append("Preset", DataTypeEnum.adVarWChar, 50);
                            nTablePatrolItems.Columns.Append("Duration", DataTypeEnum.adInteger, 8);
                            nTablePatrolItems.Columns.Append("Speed", DataTypeEnum.adInteger, 8);
                            cat.Tables.Append(nTablePatrolItems);

                            #endregion

                            #region SoundFiles Table

                            Table nTableSoundFiles = new Table();
                            nTableSoundFiles.Name = "SoundFiles";
                            nTableSoundFiles.Columns.Append("VmdAlertFile", DataTypeEnum.adVarWChar, 50);
                            nTableSoundFiles.Columns.Append("CaAlertFile", DataTypeEnum.adVarWChar, 50);
                            nTableSoundFiles.Columns.Append("VideoLossAlertFile", DataTypeEnum.adVarWChar, 50);
                            nTableSoundFiles.Columns.Append("TllDryContactAlertFile", DataTypeEnum.adVarWChar, 50);
                            nTableSoundFiles.Columns.Append("ApplicationFailureAlertFile", DataTypeEnum.adVarWChar, 50);
                            cat.Tables.Append(nTableSoundFiles); 

                            #endregion

                            #region Dvrs Table

                            Table nTableDvrs = new Table();
                            nTableDvrs.Name = "Dvrs";
                            nTableDvrs.Columns.Append("Id", DataTypeEnum.adInteger, 8);
                            nTableDvrs.Columns.Append("DvrId", DataTypeEnum.adInteger, 8); 
                            nTableDvrs.Columns.Append("Name", DataTypeEnum.adVarWChar, 50);
                            nTableDvrs.Columns.Append("IpAddress", DataTypeEnum.adVarWChar, 50);
                            nTableDvrs.Columns.Append("Vendor", DataTypeEnum.adVarWChar, 50);
                            nTableDvrs.Columns.Append("TriggerIdDelta", DataTypeEnum.adInteger, 8); 
                            cat.Tables.Append(nTableDvrs);

                            #endregion

                            #region DvrsOnTreeNodes Table

                            Table nTableDvrsOnTreeNodes = new Table();
                            nTableDvrsOnTreeNodes.Name = "DvrsOnTreeNodes";
                            nTableDvrsOnTreeNodes.Columns.Append("IpAddress", DataTypeEnum.adVarWChar, 50);
                            nTableDvrsOnTreeNodes.Columns.Append("TreeNodeName", DataTypeEnum.adVarWChar, 50);
                            cat.Tables.Append(nTableDvrsOnTreeNodes);

                            #endregion

                            #region Pre Defined Views Cameras Table

                            Table nTablePreDefinedViewsCameras = new Table();
                            nTablePreDefinedViewsCameras.Name = "PreDefinedViewsCameras";
                            nTablePreDefinedViewsCameras.Columns.Append("Id", DataTypeEnum.adInteger, 8);
                            nTablePreDefinedViewsCameras.Columns.Append("PreDefinedViewId", DataTypeEnum.adInteger, 8);
                            nTablePreDefinedViewsCameras.Columns.Append("DvrName", DataTypeEnum.adVarWChar, 50);
                            nTablePreDefinedViewsCameras.Columns.Append("CameraNumber", DataTypeEnum.adInteger, 8);
                            nTablePreDefinedViewsCameras.Columns.Append("DisplayNumber", DataTypeEnum.adInteger, 8);
                            nTablePreDefinedViewsCameras.Columns.Append("PresetToActivate", DataTypeEnum.adVarWChar, 50);
                            cat.Tables.Append(nTablePreDefinedViewsCameras);

                            #endregion

                            #region Pre Defined Views Table

                            Table nTablePreDefinedViews = new Table();
                            nTablePreDefinedViews.Name = "PreDefinedViews";
                            nTablePreDefinedViews.Columns.Append("Id", DataTypeEnum.adInteger, 8);
                            nTablePreDefinedViews.Columns.Append("Name", DataTypeEnum.adVarWChar, 50);
                            nTablePreDefinedViews.Columns.Append("Layout", DataTypeEnum.adVarWChar, 50);
                            nTablePreDefinedViews.Columns.Append("IsPreDefinedView", DataTypeEnum.adBoolean, 50);
                            nTablePreDefinedViews.Columns.Append("StartTime", DataTypeEnum.adVarWChar, 50);
                            nTablePreDefinedViews.Columns.Append("EndTime", DataTypeEnum.adVarWChar, 50);
                            cat.Tables.Append(nTablePreDefinedViews);

                            #endregion

                            #region TreeNodes Table

                            Table nTableTreeNodes = new Table();
                            nTableTreeNodes.Name = "TreeNodes";
                            nTableTreeNodes.Columns.Append("Name", DataTypeEnum.adVarWChar, 50);
                            cat.Tables.Append(nTableTreeNodes);

                            #endregion

                            #region Log Table

                            Table nTableLog = new Table();
                            nTableLog.Name = "Log";
                            nTableLog.Columns.Append("LogDate", DataTypeEnum.adDate, 50);
                            nTableLog.Columns.Append("Source", DataTypeEnum.adVarWChar, 50);
                            nTableLog.Columns.Append("Function", DataTypeEnum.adVarWChar, 50);
                            nTableLog.Columns.Append("Description", DataTypeEnum.adVarWChar, 255);
                            cat.Tables.Append(nTableLog);

                            #endregion

                            #region SaveDisplays Table

                            Table nTableDisplay = new Table();
                            nTableDisplay.Name = "SaveDisplays";
                            nTableDisplay.Columns.Append("SiteName", DataTypeEnum.adVarWChar, 50);
                            nTableDisplay.Columns.Append("CameraNumber", DataTypeEnum.adVarWChar, 50);
                            nTableDisplay.Columns.Append("DisplayNumber", DataTypeEnum.adVarWChar, 50);
                            nTableDisplay.Columns.Append("ActionType", DataTypeEnum.adVarWChar, 50);
                            nTableDisplay.Columns.Append("StartDateTime", DataTypeEnum.adVarWChar, 50);
                            nTableDisplay.Columns.Append("EndDateTime", DataTypeEnum.adVarWChar, 50);
                            cat.Tables.Append(nTableDisplay);

                            #endregion

                            #region PtzPreset Table

                            Table nTablePtzPreset = new Table();
                            nTablePtzPreset.Name = "PtzPreset";
                            nTablePtzPreset.Columns.Append("Id", DataTypeEnum.adInteger, 8);
                            nTablePtzPreset.Columns.Append("SiteName", DataTypeEnum.adVarWChar, 50);
                            nTablePtzPreset.Columns.Append("CameraNumber", DataTypeEnum.adVarWChar, 50);
                            nTablePtzPreset.Columns.Append("Preset", DataTypeEnum.adVarWChar, 50);
                            nTablePtzPreset.Columns.Append("StartTime", DataTypeEnum.adVarWChar, 50);
                            nTablePtzPreset.Columns.Append("EndTime", DataTypeEnum.adVarWChar, 50);
                            nTablePtzPreset.Columns.Append("Delay", DataTypeEnum.adVarWChar, 50);
                            cat.Tables.Append(nTablePtzPreset);

                            #endregion

                            #region Presets Table

                            Table nTablePresets = new Table();
                            nTablePresets.Name = "Presets";
                            nTablePresets.Columns.Append("DvrId", DataTypeEnum.adInteger, 8);
                            nTablePresets.Columns.Append("CameraNumber", DataTypeEnum.adInteger, 8);
                            nTablePresets.Columns.Append("PresetNumber", DataTypeEnum.adInteger, 8);
                            nTablePresets.Columns.Append("PresetName", DataTypeEnum.adVarWChar, 50);
                            cat.Tables.Append(nTablePresets);

                            #endregion

                            #region DataScopeItems Table

                            Table nTableDataScopeItems = new Table();
                            nTableDataScopeItems.Name = "DataScopeItems";
                            nTableDataScopeItems.Columns.Append("Item", DataTypeEnum.adVarWChar, 50);
                            cat.Tables.Append(nTableDataScopeItems);

                            #endregion

                            Audit("'DvrProxy.MDB' Missing. New 'DvrProxy.MDB' Created", sMethod, AuditSeverity.Information);

                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(nTableVersion);
                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(nTablePatrols);
                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(nTablePatrolItems);
                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(nTableSoundFiles);
                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(nTableDvrs);
                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(nTableDvrsOnTreeNodes);
                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(nTablePreDefinedViewsCameras);
                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(nTablePreDefinedViews);
                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(nTableTreeNodes);
                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(nTableLog);
                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(nTableDisplay);
                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(nTablePtzPreset);
                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(nTableDataScopeItems);
                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(nTablePresets);
                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(cat.Tables);
                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(cat.ActiveConnection);
                            System.Runtime.InteropServices.Marshal.FinalReleaseComObject(cat);
                        } 

                        #endregion
                        break;

                    case DatabaseProvider.SqlServer:
                        #region SQL Server

                        string strSQL = "IF NOT EXISTS (" +
                                        "SELECT * " +
                                        "FROM master..sysdatabases " +
                                        "WHERE Name = 'DvrClient')" + Environment.NewLine +
                                        "CREATE DATABASE DvrClient";

                        OleDbConnection sqlConnection = null;
                        sqlConnection = new OleDbConnection();

                        sqlConnection.ConnectionString = m_Settings.ConnectionString;
                        sqlConnection.Open();

                        OleDbCommand sqlCommand = new OleDbCommand(strSQL, sqlConnection);
                        sqlCommand.ExecuteNonQuery();

                        #region Version Table

                        strSQL = "USE DvrClient" + Environment.NewLine +
                                 "IF NOT EXISTS (" +
                                 "SELECT * " +
                                 "FROM DvrClient.dbo.sysobjects " +
                                 "WHERE Name = 'Version' " +
                                 "AND TYPE = 'u')" + Environment.NewLine +
                                 "CREATE TABLE Version (" +                               
                                 "Version NVarChar(50) NOT NULL)";
                        try
                        {
                            sqlCommand = new OleDbCommand(strSQL, sqlConnection);
                            sqlCommand.ExecuteNonQuery();
                        }
                        catch (Exception)
                        {
                        }

                        #endregion

                        #region Patrols Table

                        strSQL = "USE DvrClient" + Environment.NewLine +
                                 "IF NOT EXISTS (" +
                                 "SELECT * " +
                                 "FROM DvrClient.dbo.sysobjects " +
                                 "WHERE Name = 'Patrols' " +
                                 "AND TYPE = 'u')" + Environment.NewLine +
                                 "CREATE TABLE Patrols (" +
                                 "Id INTEGER NOT NULL," +
                                 "PatrolName NVarChar(50) NOT NULL," +
                                 "PatrolLayout NVarChar(50) NOT NULL," +
                                 "IsCyclic Bit NOT NULL)";
                        try
                        {
                            sqlCommand = new OleDbCommand(strSQL, sqlConnection);
                            sqlCommand.ExecuteNonQuery();
                        }
                        catch (Exception)
                        {
                        }

                        #endregion

                        #region Patrol Items Table

                        strSQL = "USE DvrClient" + Environment.NewLine +
                                 "IF NOT EXISTS (" +
                                 "SELECT * " +
                                 "FROM DvrClient.dbo.sysobjects " +
                                 "WHERE Name = 'PatrolItems' " +
                                 "AND TYPE = 'u')" + Environment.NewLine +
                                 "CREATE TABLE PatrolItems (" +
                                 "Id INTEGER NOT NULL," + 
                                 "PatrolId INTEGER NOT NULL," +
                                 "Dvr NVarChar(50) NOT NULL," +
                                 "CameraNumber INTEGER NOT NULL," +
                                 "DisplayNumber INTEGER NOT NULL," +
                                 "Preset NVarChar(50) NOT NULL," +
                                 "Duration INTEGER NOT NULL," +
                                 "Speed INTEGER NOT NULL)";
                        try
                        {
                            sqlCommand = new OleDbCommand(strSQL, sqlConnection);
                            sqlCommand.ExecuteNonQuery();
                        }
                        catch (Exception)
                        {
                        }

                        #endregion

                        #region SoundFiles Table

                        strSQL = "USE DvrClient" + Environment.NewLine +
                                 "IF NOT EXISTS (" +
                                 "SELECT * " +
                                 "FROM DvrClient.dbo.sysobjects " +
                                 "WHERE Name = 'SoundFiles' " +
                                 "AND TYPE = 'u')" + Environment.NewLine +
                                 "CREATE TABLE SoundFiles (" +
                                 "VmdAlertFile NVarChar(50) NOT NULL," +
                                 "CaAlertFile NVarChar(50) NOT NULL," +
                                 "VideoLossAlertFile NVarChar(50) NOT NULL," +
                                 "TllDryContactAlertFile NVarChar(50) NOT NULL," +
                                 "ApplicationFailureAlertFile NVarChar(50) NOT NULL)";
                        try
                        {
                            sqlCommand = new OleDbCommand(strSQL, sqlConnection);
                            sqlCommand.ExecuteNonQuery();
                        }
                        catch (Exception)
                        {
                        }

                        #endregion

                        #region Dvrs Table

                        strSQL = "USE DvrClient" + Environment.NewLine +
                                 "IF NOT EXISTS (" +
                                 "SELECT * " +
                                 "FROM DvrClient.dbo.sysobjects " +
                                 "WHERE Name = 'Dvrs' " +
                                 "AND TYPE = 'u')" + Environment.NewLine +
                                 "CREATE TABLE Dvrs (" +
                                 "Id INTEGER NOT NULL," +
                                 "DvrId INTEGER NOT NULL," +
                                 "Name NVarChar(50) NOT NULL," +
                                 "IpAddress NVarChar(50) NOT NULL," +
                                 "Vendor NVarChar(50) NOT NULL," +
                                 "TriggerIdDelta INTEGER NOT NULL)";
                        try
                        {
                            sqlCommand = new OleDbCommand(strSQL, sqlConnection);
                            sqlCommand.ExecuteNonQuery();
                        }
                        catch (Exception)
                        {
                        }

                        #endregion

                        #region DvrsOnTreeNodes Table
                        
                        strSQL = "USE DvrClient" + Environment.NewLine +
                                 "IF NOT EXISTS (" +
                                 "SELECT * " +
                                 "FROM DvrClient.dbo.sysobjects " +
                                 "WHERE Name = 'DvrsOnTreeNodes' " +
                                 "AND TYPE = 'u')" + Environment.NewLine +
                                 "CREATE TABLE DvrsOnTreeNodes (" +
                                 "IpAddress NVarChar(50) NOT NULL," +
                                 "TreeNodeName NVarChar(50) NOT NULL)";
                        try
                        {
                            sqlCommand = new OleDbCommand(strSQL, sqlConnection);
                            sqlCommand.ExecuteNonQuery();
                        }
                        catch (Exception)
                        {
                        }

                        #endregion

                        #region Pre Defined Views Cameras Table

                        strSQL = "USE DvrClient" + Environment.NewLine +
                                 "IF NOT EXISTS (" +
                                 "SELECT * " +
                                 "FROM DvrClient.dbo.sysobjects " +
                                 "WHERE Name = 'PreDefinedViewsCameras' " +
                                 "AND TYPE = 'u')" + Environment.NewLine +
                                 "CREATE TABLE PreDefinedViewsCameras (" +
                                 "Id INTEGER NOT NULL," +
                                 "PreDefinedViewId INTEGER NOT NULL," +
                                 "DvrName NVarChar(50) NOT NULL," +
                                 "CameraNumber INTEGER NOT NULL," +
                                 "DisplayNumber INTEGER NOT NULL," +
                                 "PresetToActivate NVarChar(50) NOT NULL)";

                        try
                        {
                            sqlCommand = new OleDbCommand(strSQL, sqlConnection);
                            sqlCommand.ExecuteNonQuery();
                        }
                        catch (Exception)
                        {
                        }

                        #endregion

                        #region Pre Defined Views Table

                        strSQL = "USE DvrClient" + Environment.NewLine +
                                 "IF NOT EXISTS (" +
                                 "SELECT * " +
                                 "FROM DvrClient.dbo.sysobjects " +
                                 "WHERE Name = 'PreDefinedViews' " +
                                 "AND TYPE = 'u')" + Environment.NewLine +
                                 "CREATE TABLE PreDefinedViews (" +
                                 "Id INTEGER NOT NULL," +
                                 "Name NVarChar(50) NOT NULL," +
                                 "Layout NVarChar(50) NOT NULL," +
                                 "IsPreDefinedView Bit NOT NULL," +
                                 "StartTime NVarChar(50) NOT NULL," +
                                 "EndTime NVarChar(50) NOT NULL)";

                        try
                        {
                            sqlCommand = new OleDbCommand(strSQL, sqlConnection);
                            sqlCommand.ExecuteNonQuery();
                        }
                        catch (Exception)
                        {
                        }

                        #endregion

                        #region Tree Nodes Table

                        strSQL = "USE DvrClient" + Environment.NewLine +
                                "IF NOT EXISTS (" +
                                "SELECT * " +
                                "FROM DvrClient.dbo.sysobjects " +
                                "WHERE Name = 'TreeNodes' " +
                                "AND TYPE = 'u')" + Environment.NewLine +
                                "CREATE TABLE TreeNodes (" +
                                "Name NVarChar(50) NOT NULL)";

                        try
                        {
                            sqlCommand = new OleDbCommand(strSQL, sqlConnection);
                            sqlCommand.ExecuteNonQuery();
                        }
                        catch (Exception)
                        {
                        }

                        #endregion

                        #region Log Table

                        strSQL = "USE DvrClient" + Environment.NewLine +
                                 "IF NOT EXISTS (" +
                                 "SELECT * " +
                                 "FROM DvrClient.dbo.sysobjects " +
                                 "WHERE Name = 'Log' " +
                                 "AND TYPE = 'u')" + Environment.NewLine +
                                 "CREATE TABLE Log (" +
                                 "LogDate DATETIME NOT NULL," +
                                 "Source NVarChar(50) NOT NULL," +
                                 "Function NVarChar(50) NOT NULL," +
                                 "Description NVarChar(255) NOT NULL)";

                        try
                        {
                            sqlCommand = new OleDbCommand(strSQL, sqlConnection);
                            sqlCommand.ExecuteNonQuery();
                        }
                        catch (Exception)
                        {
                        }

                        #endregion

                        #region SaveDisplays Table

                        strSQL = "USE DvrClient" + Environment.NewLine +
                                 "IF NOT EXISTS (" +
                                 "SELECT * " +
                                 "FROM DvrClient.dbo.sysobjects " +
                                 "WHERE Name = 'SaveDisplays' " +
                                 "AND TYPE = 'u')" + Environment.NewLine +
                                 "CREATE TABLE SaveDisplays (" +
                                 "SiteName NVarChar(50) NOT NULL," +
                                 "CameraNumber NVarChar(50) NOT NULL," +
                                 "DisplayNumber NVarChar(50) NOT NULL," +
                                 "ActionType NVarChar(50) NOT NULL," +
                                 "StartDateTime NVarChar(50) NOT NULL," +
                                 "EndDateTime NVarChar(50) NOT NULL)";

                        try
                        {
                            sqlCommand = new OleDbCommand(strSQL, sqlConnection);
                            sqlCommand.ExecuteNonQuery();
                        }
                        catch (Exception)
                        {
                        }

                        #endregion

                        #region PtzPreset Table

                        strSQL = "USE DvrClient" + Environment.NewLine +
                                 "IF NOT EXISTS (" +
                                 "SELECT * " +
                                 "FROM DvrClient.dbo.sysobjects " +
                                 "WHERE Name = 'PtzPreset' " +
                                 "AND TYPE = 'u')" + Environment.NewLine +
                                 "CREATE TABLE PtzPreset (" +
                                 "Id INTEGER NOT NULL," +
                                 "SiteName NVarChar(50) NOT NULL," +
                                 "CameraNumber NVarChar(50) NOT NULL," +
                                 "Preset NVarChar(50) NOT NULL," +
                                 "StartTime NVarChar(50) NOT NULL," +
                                 "EndTime NVarChar(50) NOT NULL," +
                                 "Delay NVarChar(50) NOT NULL)";

                        try
                        {
                            sqlCommand = new OleDbCommand(strSQL, sqlConnection);
                            sqlCommand.ExecuteNonQuery();
                        }
                        catch (Exception)
                        {
                        }

                        #endregion

                        #region Preset Table

                        strSQL = "USE DvrClient" + Environment.NewLine +
                                 "IF NOT EXISTS (" +
                                 "SELECT * " +
                                 "FROM DvrClient.dbo.sysobjects " +
                                 "WHERE Name = 'Preset' " +
                                 "AND TYPE = 'u')" + Environment.NewLine +
                                 "CREATE TABLE Preset (" +
                                 "DvrId INTEGER NOT NULL," +
                                 "CameraNumber INTEGER NOT NULL," +
                                 "PresetNumber INTEGER NOT NULL," +
                                 "PresetName NVarChar(50) NOT NULL)";

                        try
                        {
                            sqlCommand = new OleDbCommand(strSQL, sqlConnection);
                            sqlCommand.ExecuteNonQuery();
                        }
                        catch (Exception)
                        {
                        }

                        #endregion

                        #region DataScopeItems Table

                        strSQL = "USE DvrClient" + Environment.NewLine +
                                 "IF NOT EXISTS (" +
                                 "SELECT * " +
                                 "FROM DvrClient.dbo.sysobjects " +
                                 "WHERE Name = 'DataScopeItems' " +
                                 "AND TYPE = 'u')" + Environment.NewLine +
                                 "CREATE TABLE DataScopeItems (" +
                                 "Item NVarChar(50) NOT NULL)";

                        try
                        {
                            sqlCommand = new OleDbCommand(strSQL, sqlConnection);
                            sqlCommand.ExecuteNonQuery();
                        }
                        catch (Exception)
                        {
                        }

                        #endregion

                        sqlConnection.Close();

                        m_cn.ConnectionString = m_Settings.ConnectionString + ";Initial Catalog=DvrClient"; 

                        #endregion
                        break;

                    default:
                        return DbReturnCode.OpenConnectionFailed;
                }
                
                if (m_cn.State == ConnectionState.Closed)
                {
                    try
                    {
                        m_cn.Open();

                        AuditPerform(sFullFileName + " Opened", sMethod, AuditSeverity.Information);

                        return DbReturnCode.FinishedOK;
                    }
                    catch (OleDbException e)
                    {
                        string s = e.ToString();

                        return DbReturnCode.OpenConnectionFailed;
                    }
                }
                else
                {
                    AuditPerform(sFullFileName + " Open", sMethod, AuditSeverity.Information);

                    return DbReturnCode.ConnectionStateOpen;
                }
            }
            catch (Exception e)
            {
                string sError = e.Message;
                AuditPerform(sError, sMethod, AuditSeverity.Error);

                return DbReturnCode.OpenConnectionFailed;
            }
        }        

        private DbReturnCode CloseConnection()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (m_cn != null)
            {
                m_cn.Close();
                Utils.WriteToDebugView(DvrClientModule.Main,
                                       sMethod,
                                       "Connection To Database Closed",
                                       AuditSeverity.Important);
            }
            else
            {
                Utils.WriteToDebugView(DvrClientModule.Main,
                                       sMethod,
                                       "No Connection To Database To Close",
                                       AuditSeverity.Warning);
            }

            return DbReturnCode.FinishedOK;
        }

        private bool TableExists(string sTableName)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                foreach (DatabaseTable dbTable in m_DvrClientDatabase)
                {
                    if (dbTable.Name == sTableName)
                    {
                        Audit("Table '" + sTableName + "' Exists",
                              sMethod,
                              AuditSeverity.Important);

                        return true;
                    }
                }

                Audit("Table '" + sTableName + "' Does Not Exists",
                              sMethod,
                              AuditSeverity.Important);

                return false; ;
            }
            catch(Exception e)
            {
                Audit("Table '" + sTableName + "' Does Not Found. " + e.Message,
                              sMethod,
                              AuditSeverity.Important);

                return false;
            }          
        }

        private bool ColumnExists(string sTableName, 
                                  string sColumnName, 
                                  Type tType, 
                                  out bool bTypeMatches,
                                  out Type tUnmatchingType)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            bTypeMatches = false;
            tUnmatchingType = null;

            try
            {
                if (m_DvrClientDatabase == null)
                {
                    return false;
                }

                for (int i = 0; i < m_DvrClientDatabase.Count; i++)
                {
                    if (m_DvrClientDatabase[i].Name == sTableName)
                    {
                        if (m_DvrClientDatabase[i].Column == null)
                        {
                            return false;
                        }

                        for (int j = 0; j < m_DvrClientDatabase[i].Column.Count; j++)
                        {
                            if (m_DvrClientDatabase[i].Column[j].Name == sColumnName)
                            {
                                if (tType == m_DvrClientDatabase[i].Column[j].Type)
                                {
                                    bTypeMatches = true;
                                }
                                else
                                {
                                    tUnmatchingType = m_DvrClientDatabase[i].Column[j].Type;
                                }

                                return true;
                            }
                        }

                        return false;
                    }
                }

                return false;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private bool CreateTable(DvrClientDatabaseTable dcdt)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string strSQL;

            OleDbCommand sqlCommand; 

            #endregion

            try
            {
                switch (dcdt)
                {
                    case DvrClientDatabaseTable.SoundFiles:
                        strSQL = "CREATE TABLE SoundFiles (" +
                                 "VmdAlertFile NVarChar(50) NOT NULL," +
                                 "CaAlertFile NVarChar(50) NOT NULL," +
                                 "VideoLossAlertFile NVarChar(50) NOT NULL," +
                                 "TllDryContactAlertFile NVarChar(50) NOT NULL," +
                                 "ApplicationFailureAlertFile NVarChar(50) NOT NULL)";
                        break;

                    case DvrClientDatabaseTable.Dvrs:
                        strSQL = "CREATE TABLE Dvrs (" +
                                 "Id INTEGER NOT NULL," +
                                 "DvrId INTEGER NOT NULL," +
                                 "Name NVarChar(50) NOT NULL," +
                                 "IpAddress NVarChar(50) NOT NULL," +
                                 "Vendor NVarChar(50) NOT NULL," + 
                                 "TriggerIdDelta INTEGER NOT NULL)";
                        break;

                    case DvrClientDatabaseTable.DvrsOnTreeNodes:
                        strSQL = "CREATE TABLE DvrsOnTreeNodes (" +
                                 "IpAddress NVarChar(50) NOT NULL," +
                                 "TreeNodeName NVarChar(50) NOT NULL)";
                        break;

                    case DvrClientDatabaseTable.PreDefinedViewsCameras:
                        strSQL = "CREATE TABLE PreDefinedViewsCameras (" +
                                 "PreDefinedViewName NVarChar(50) NOT NULL," +
                                 "DvrName NVarChar(50) NOT NULL," +
                                 "CameraNumber INTEGER NOT NULL," +
                                 "DisplayNumber INTEGER NOT NULL," +
                                 "PresetToActivate NVarChar(50) NOT NULL)";
                        break;

                    case DvrClientDatabaseTable.PreDefinedViews:
                        strSQL = "CREATE TABLE PreDefinedViews (" +
                                 "Name NVarChar(50) NOT NULL," +
                                 "Layout NVarChar(50) NOT NULL," +
                                 "IsPreDefinedView Bit NOT NULL," +
                                 "StartTime NVarChar(50) NOT NULL," +
                                 "EndTime NVarChar(50) NOT NULL)";
                        break;

                    case DvrClientDatabaseTable.TreeNodes:
                        strSQL = "CREATE TABLE TreeNodes (" +
                                 "Name NVarChar(50) NOT NULL)";
                        break;

                    case DvrClientDatabaseTable.Log:
                        strSQL = "CREATE TABLE Log (" +
                                 "LogDate DATETIME NOT NULL," +
                                 "Source NVarChar(50) NOT NULL," +
                                 "Method NVarChar(50) NOT NULL," +
                                 "Description NVarChar(255) NOT NULL)";
                        break;

                    case DvrClientDatabaseTable.SaveDisplays:
                        strSQL = "CREATE TABLE SaveDisplays (" +
                                 "SiteName NVarChar(50) NOT NULL," +
                                 "CameraNumber NVarChar(50) NOT NULL," +
                                 "DisplayNumber NVarChar(50) NOT NULL," +
                                 "ActionType NVarChar(50) NOT NULL," +
                                 "StartDateTime NVarChar(50) NOT NULL," +
                                 "EndDateTime NVarChar(50) NOT NULL)";
                        break;

                    case DvrClientDatabaseTable.PtzPreset:
                        strSQL = "CREATE TABLE PtzPreset (" +
                                 "Id NVarChar(50) NOT NULL," +
                                 "SiteName NVarChar(50) NOT NULL," +
                                 "CameraNumber NVarChar(50) NOT NULL," +
                                 "Preset NVarChar(50) NOT NULL," +
                                 "StartTime NVarChar(50) NOT NULL," +
                                 "EndTime NVarChar(50) NOT NULL," +
                                 "Delay NVarChar(50) NOT NULL)";
                        break;

                    case DvrClientDatabaseTable.Presets:
                        strSQL = "CREATE TABLE Presets (" +
                                 "DvrId NVarChar(50) NOT NULL," +
                                 "CameraNumber NVarChar(50) NOT NULL," +
                                 "PresetNumber NVarChar(50) NOT NULL," +
                                 "PresetName NVarChar(50) NOT NULL)";
                        break;

                    case DvrClientDatabaseTable.DataScopeItems:
                        strSQL = "CREATE TABLE DataScopeItems (" +
                                 "Item NVarChar(50) NOT NULL)";
                        break;

                    case DvrClientDatabaseTable.Patrols:
                        strSQL = "CREATE TABLE Patrols (" +
                                 "Id INTEGER NOT NULL," +
                                 "PatrolName NVarChar(50) NOT NULL," +
                                 "Cyclic Bit NOT NULL)";
                        break;

                    case DvrClientDatabaseTable.PatrolItems:
                        strSQL = "CREATE TABLE PatrolItems (" +
                                 "Id INTEGER NOT NULL," +
                                 "PatrolId INTEGER NOT NULL," +
                                 "Dvr NVarChar(50) NOT NULL," +
                                 "CameraNumber INTEGER NOT NULL," +
                                 "Preset NVarChar(50) NOT NULL," +
                                 "Delay INTEGER NOT NULL," +
                                 "Speed INTEGER NOT NULL)";
                        break;

                    case DvrClientDatabaseTable.Version:
                        strSQL = "CREATE TABLE Version (" +
                                 "Version NVarChar(50) NOT NULL)";
                        break;

                    default:
                        return false;;
                }

                sqlCommand = new OleDbCommand(strSQL, m_cn);
                sqlCommand.ExecuteNonQuery();

                Audit("Table '" + dcdt.ToString() + "' Created", sMethod, AuditSeverity.Information);

                return true;
            }
            catch (Exception e)
            {
                Audit("Failed Creating Table '" + dcdt.ToString() + "'. " + e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private bool BuildDvrClientDatabaseTemplate()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                m_TemplateDvrClientDatabase = new List<DatabaseTable>();

                #region Dvrs Table

                m_TemplateDvrClientDatabase.Add(new DatabaseTable(DvrClientDatabaseTable.Dvrs.ToString()));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.Dvrs) - 1].AddColumn("Id", typeof(System.Int32));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.Dvrs) - 1].AddColumn("DvrId", typeof(System.Int32));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.Dvrs) - 1].AddColumn("Name", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.Dvrs) - 1].AddColumn("IpAddress", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.Dvrs) - 1].AddColumn("Vendor", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.Dvrs) - 1].AddColumn("TriggerIdDelta", typeof(System.Int32));

                #endregion

                #region Dvrs On Tree Nodes Table

                m_TemplateDvrClientDatabase.Add(new DatabaseTable(DvrClientDatabaseTable.DvrsOnTreeNodes.ToString()));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.DvrsOnTreeNodes) - 1].AddColumn("IpAddress", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.DvrsOnTreeNodes) - 1].AddColumn("TreeNodeName", typeof(System.String));

                #endregion

                #region Pre Defined Views Cameras Table

                m_TemplateDvrClientDatabase.Add(new DatabaseTable(DvrClientDatabaseTable.PreDefinedViewsCameras.ToString()));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PreDefinedViewsCameras) - 1].AddColumn("Id", typeof(System.Int32));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PreDefinedViewsCameras) - 1].AddColumn("PreDefinedViewId", typeof(System.Int32));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PreDefinedViewsCameras) - 1].AddColumn("DvrName", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PreDefinedViewsCameras) - 1].AddColumn("CameraNumber", typeof(System.Int32));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PreDefinedViewsCameras) - 1].AddColumn("DisplayNumber", typeof(System.Int32));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PreDefinedViewsCameras) - 1].AddColumn("PresetToActivate", typeof(System.String));

                #endregion

                #region Pre Defined Views Table

                m_TemplateDvrClientDatabase.Add(new DatabaseTable(DvrClientDatabaseTable.PreDefinedViews.ToString()));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PreDefinedViews) - 1].AddColumn("Id", typeof(System.Int32));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PreDefinedViews) - 1].AddColumn("Name", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PreDefinedViews) - 1].AddColumn("Layout", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PreDefinedViews) - 1].AddColumn("IsPreDefinedView", typeof(System.Boolean));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PreDefinedViews) - 1].AddColumn("StartTime", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PreDefinedViews) - 1].AddColumn("EndTime", typeof(System.String));

                #endregion

                #region Tree Nodes Table

                m_TemplateDvrClientDatabase.Add(new DatabaseTable(DvrClientDatabaseTable.TreeNodes.ToString()));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.TreeNodes) - 1].AddColumn("Name", typeof(System.String));

                #endregion

                #region Log Table

                m_TemplateDvrClientDatabase.Add(new DatabaseTable(DvrClientDatabaseTable.Log.ToString()));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.Log) - 1].AddColumn("LogDate", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.Log) - 1].AddColumn("Source", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.Log) - 1].AddColumn("Function", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.Log) - 1].AddColumn("Description", typeof(System.String));

                #endregion
  
                #region Save Displays Table

                m_TemplateDvrClientDatabase.Add(new DatabaseTable(DvrClientDatabaseTable.SaveDisplays.ToString()));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.SaveDisplays) - 1].AddColumn("SiteName", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.SaveDisplays) - 1].AddColumn("CameraNumber", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.SaveDisplays) - 1].AddColumn("DisplayNumber", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.SaveDisplays) - 1].AddColumn("ActionType", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.SaveDisplays) - 1].AddColumn("StartDateTime", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.SaveDisplays) - 1].AddColumn("EndDateTime", typeof(System.String));

                #endregion
 
                #region Ptz Preset Table

                m_TemplateDvrClientDatabase.Add(new DatabaseTable(DvrClientDatabaseTable.PtzPreset.ToString()));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PtzPreset) - 1].AddColumn("Id", typeof(System.Int32));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PtzPreset) - 1].AddColumn("SiteName", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PtzPreset) - 1].AddColumn("CameraNumber", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PtzPreset) - 1].AddColumn("Preset", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PtzPreset) - 1].AddColumn("StartTime", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PtzPreset) - 1].AddColumn("EndTime", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PtzPreset) - 1].AddColumn("Delay", typeof(System.String));

                #endregion

                #region Sound Files Table

                m_TemplateDvrClientDatabase.Add(new DatabaseTable(DvrClientDatabaseTable.SoundFiles.ToString()));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.SoundFiles) - 1].AddColumn("VmdAlertFile", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.SoundFiles) - 1].AddColumn("CaAlertFile", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.SoundFiles) - 1].AddColumn("VideoLossAlertFile", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.SoundFiles) - 1].AddColumn("TllDryContactAlertFile", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.SoundFiles) - 1].AddColumn("ApplicationFailureAlertFile", typeof(System.String));

                #endregion

                #region Data Scope Items Table

                m_TemplateDvrClientDatabase.Add(new DatabaseTable(DvrClientDatabaseTable.DataScopeItems.ToString()));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.DataScopeItems) - 1].AddColumn("Item", typeof(System.String));

                #endregion

                #region Patrols Table

                m_TemplateDvrClientDatabase.Add(new DatabaseTable(DvrClientDatabaseTable.Patrols.ToString()));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.Patrols) - 1].AddColumn("Id", typeof(System.Int32));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.Patrols) - 1].AddColumn("PatrolName", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.Patrols) - 1].AddColumn("Cyclic", typeof(System.Boolean));

                #endregion

                #region Patrol Items Table

                m_TemplateDvrClientDatabase.Add(new DatabaseTable(DvrClientDatabaseTable.PatrolItems.ToString()));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PatrolItems) - 1].AddColumn("Id", typeof(System.Int32));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PatrolItems) - 1].AddColumn("PatrolId", typeof(System.Int32));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PatrolItems) - 1].AddColumn("Dvr", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PatrolItems) - 1].AddColumn("CameraNumber", typeof(System.Int32));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PatrolItems) - 1].AddColumn("Preset", typeof(System.String));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PatrolItems) - 1].AddColumn("Delay", typeof(System.Int32));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.PatrolItems) - 1].AddColumn("Speed", typeof(System.Int32));

                #endregion

                #region Version Table

                m_TemplateDvrClientDatabase.Add(new DatabaseTable(DvrClientDatabaseTable.Version.ToString()));
                m_TemplateDvrClientDatabase[(int)(DvrClientDatabaseTable.Version) - 1].AddColumn("Version", typeof(System.String));

                #endregion

                Audit("Created Dvr Client Database Template", sMethod, AuditSeverity.Information);

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private bool CheckDvrClientTablesExistence()
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;

            OleDbCommand cmd;
            OleDbDataReader dr;

            int iRecords; 

            #endregion

            try
            {
                foreach (DvrClientDatabaseTable dcdt in Enum.GetValues(typeof(DvrClientDatabaseTable)))
                {
                    if (!TableExists(dcdt.ToString()))
                    {
                        Audit("Table '" + dcdt.ToString() + "' Does Not Exist", sMethod, AuditSeverity.Important);

                        if (!CreateTable(dcdt))
                        {
                            Audit("Could Not Create Table '" + dcdt.ToString() + "'", sMethod, AuditSeverity.Important);
                        }
                    }
                    else
                    {
                        #region Read Records

                        cmd = new OleDbCommand("SELECT COUNT(*) FROM " + dcdt.ToString() + " ", m_cn);
                        try
                        {
                            iRecords = int.Parse(cmd.ExecuteScalar().ToString());

                            Audit(iRecords + " Records In Table '" + dcdt.ToString() + "'",
                                  sMethod,
                                  AuditSeverity.Important);

                            if (iRecords > 0)
                            {
                                cmd = new OleDbCommand("SELECT * FROM " + dcdt.ToString() + " ", m_cn);
                                try
                                {
                                    dr = cmd.ExecuteReader();

                                    Audit(iRecords + " Records Read From Table '" + dcdt.ToString() + "'",
                                          sMethod,
                                          AuditSeverity.Important);
                                }
                                catch (OleDbException e)
                                {
                                    Audit("Could Not Get '" + dcdt.ToString() + "' Records. " + e.Message,
                                          sMethod,
                                          AuditSeverity.Error);

                                    return false;
                                }
                            }
                        }
                        catch (OleDbException e)
                        {
                            Audit("Could Not Get Number Of '" + dcdt.ToString() + "' Records. " + e.Message,
                                  sMethod,
                                  AuditSeverity.Error);

                            return false;
                        }

                        #endregion

                        List<DatabaseColumn> lTableColumn = m_TemplateDvrClientDatabase[(int)dcdt - 1].Column;

                        foreach (DatabaseColumn dbTableColumn in lTableColumn)
                        {
                            Type tUnmatchingType;

                            bool bTypeMatches;
                            bool bRc = ColumnExists(dcdt.ToString(), 
                                                    dbTableColumn.Name, 
                                                    dbTableColumn.Type,
                                                    out bTypeMatches,
                                                    out tUnmatchingType);

                            //  The Column Does Not Exist
                            if (!bRc)
                            {
                                Audit("Column '" + dbTableColumn.Name +
                                      "' Of Type '" + dbTableColumn.Type.Name + 
                                      "' In Table '" + dcdt.ToString() + "' Does Not Exist", 
                                      sMethod, 
                                      AuditSeverity.Important);

                                #region Add Column
                                
                                CloseConnection();
                                if (AlterTable_AddColumn(dcdt.ToString(),
                                                         dbTableColumn.Name,
                                                         dbTableColumn.Type))
                                {
                                    Audit("Added Column '" + dbTableColumn.Name +
                                          "' Type '" + dbTableColumn.Type.Name +
                                          "' To Table '" + dcdt.ToString() + "'",
                                          sMethod,
                                          AuditSeverity.Information);
                                }
                                else
                                {
                                    Audit("Failed Adding Column '" + dbTableColumn.Name +
                                          "' Type '" + dbTableColumn.Type.Name +
                                          "' To Table '" + dcdt.ToString() + "'",
                                          sMethod,
                                          AuditSeverity.Error);

                                    return false;
                                } 

                                #endregion
                            }
                            //  The Column Does Exists
                            else
                            {
                                //  The Column's Type Has To Be Modified
                                if (!bTypeMatches)
                                {
                                    Audit("Type For Column '" + dbTableColumn.Name +                                  
                                          "' In Table '" + dcdt.ToString() + "' Does Not Match. " +
                                          "Type Is '" + tUnmatchingType.Name + "' Has To Be '" + dbTableColumn.Type.Name + "'",
                                          sMethod,
                                          AuditSeverity.Important);

                                    #region Update Column Type
                                    
                                    CloseConnection();
                                    if (!AlterTable_UpdateColumnType(dcdt.ToString(),
                                                                     dbTableColumn.Name,
                                                                     dbTableColumn.Type,
                                                                     tUnmatchingType))
                                    {
                                        Audit("Failed Updating Column '" + dbTableColumn.Name +
                                              "' In Table '" + dcdt.ToString() +
                                              "' From Type '" + tUnmatchingType.Name +
                                              "' To Type '" + dbTableColumn.Type.Name + "'",
                                              sMethod,
                                              AuditSeverity.Error);

                                        return false;
                                    }
                                    else
                                    {
                                        Audit("Added Column '" + dbTableColumn.Name +
                                              "' Type '" + dbTableColumn.Type.Name +
                                              "' To Table '" + dcdt.ToString() + "'",
                                              sMethod,
                                              AuditSeverity.Information);
                                    } 

                                    #endregion                                    
                                }
                                else
                                {
                                    Audit("Column '" + dbTableColumn.Name +
                                      "' Of Type '" + dbTableColumn.Name +
                                      "' In Table '" + dcdt.ToString() + "' Exists",
                                      sMethod,
                                      AuditSeverity.Important);
                                }
                            }
                        }
                    }
                }

                DeleteVersionTableContents();
                InsertVersion();

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }

        }

        #region Retreive

        public bool GetDvrsOnTreeNodes(out string sResult)
        {
            #region Data Members
            
            OleDbCommand cmd;
            OleDbDataReader dr;

            int iRecords;

            DbReturnCode rc; 

            #endregion

            sResult = "";

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                sResult = "Could Not Open Connection";

                return false;
            }

            cmd = new OleDbCommand("SELECT COUNT(*) FROM DvrsOnTreeNodes", m_cn);
            try
            {
                iRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();
                sResult = "Could Not Get Number Of 'DvrsOnTreeNodes' Records. " + sError;

                return false;
            }

            if (iRecords == 0)
            {
                sResult = "Got 0 Records";

                return false;
            }
            else
            {
                m_DvrsOnTreeNodes = new DvrsOnTreeNodes[iRecords];
            }

            cmd = new OleDbCommand("SELECT * FROM DvrsOnTreeNodes", m_cn);
            try
            {
                dr = cmd.ExecuteReader();
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();
                sResult = "Could Not Get 'DvrsOnTreeNodes' Records. " + sError;

                return false;
            }

            int i = 0;
            while (dr.Read())
            {
                m_DvrsOnTreeNodes[i].IP = dr["IpAddress"].ToString();
                m_DvrsOnTreeNodes[i].TreeNodeName = dr["TreeNodeName"].ToString();

                i++;
            }

            dr.Close();
            //CloseConnection();

            sResult = "Got " + iRecords + " Records";

            return true;
        }

        private bool GetPreDefinedViews(out string sResult, ViewType viewType)
        {
            #region Data Members
            
            int i;
            int j;
            int iRecords;
            int iNumberOfPredefinedViews;

            string sViewTypeQuery;

            OleDbCommand cmd;
            OleDbDataReader dr;
            OleDbDataReader drPresetCameras;

            DbReturnCode rc; 

            #endregion

            sResult = "";

            switch (viewType)
            {
                case ViewType.PredefinedView:
                    sViewTypeQuery = "IsPreDefinedView<>0";
                    break;

                case ViewType.MainView:
                    sViewTypeQuery = "IsPreDefinedView=0";
                    break;

                default:
                    sResult = "Wrong View Type. " + viewType.ToString();
                    return false;
            }

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                sResult = "Could Not Open Connection";

                return true;
            }

            cmd = new OleDbCommand("SELECT COUNT(*) FROM PreDefinedViews WHERE " + sViewTypeQuery, m_cn);
            try
            {
                iRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();
                sResult = "Could Not Get Number Of 'PreDefinedViews' Records. " + sError;

                return false;
            }

            if (iRecords == 0)
            {
                sResult = "Got 0 Records.";

                return false;
            }
            else
            {
                iNumberOfPredefinedViews = iRecords;

                if (viewType == ViewType.PredefinedView)
                {
                    m_PreDefinedView = new List<PreDefinedView>();
                }
                else 
                {
                    m_MainView = new List<PreDefinedView>();
                }
            }

            cmd = new OleDbCommand("SELECT * FROM PreDefinedViews WHERE " + sViewTypeQuery, m_cn);
            try
            {
                dr = cmd.ExecuteReader();
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();
                sResult = "Could Not Get 'PreDefinedViews' Records. " + sError;

                return false;
            }

            i = 0;
            while (dr.Read())
            {
                int iId = (int)(dr["Id"]);
                string sPreDefinedViewName = dr["Name"].ToString();
                string sLayout = dr["Layout"].ToString();
                bool bIsPredefinedView = (bool)(dr["IsPredefinedView"]);
                string sStartTime = dr["StartTime"].ToString();
                string sEndTime = dr["EndTime"].ToString();
                string sSql;

                if (viewType == ViewType.PredefinedView)
                {
                    m_PreDefinedView.Add(new PreDefinedView(iId,
                                                            sPreDefinedViewName,
                                                            sLayout,
                                                            bIsPredefinedView,
                                                            sStartTime,
                                                            sEndTime));
                }
                else
                {
                    m_MainView.Add(new PreDefinedView(iId,
                                                      sPreDefinedViewName,
                                                      sLayout,
                                                      bIsPredefinedView,
                                                      sStartTime,
                                                      sEndTime));
                }

                //  now let's see how many cameras there are for this preset
                sSql = "SELECT COUNT(*) FROM PreDefinedViewsCameras WHERE PreDefinedViewId=" + iId + " ";
                cmd = new OleDbCommand(sSql, m_cn);
                try
                {
                    iRecords = int.Parse(cmd.ExecuteScalar().ToString());
                }
                catch (OleDbException e)
                {
                    string sError = e.ToString();
                    sResult = "Could Not Get Number Of 'PreDefinedViewsCameras' Records. " + sError;

                    return false;
                }

                if (iRecords != 0)
                {
                    sSql = "SELECT * FROM PreDefinedViewsCameras WHERE PreDefinedViewId=" + iId + " ";
                    cmd = new OleDbCommand(sSql, m_cn);
                    try
                    {
                        drPresetCameras = cmd.ExecuteReader();
                    }
                    catch (OleDbException e)
                    {
                        string sError = e.ToString();
                        sResult = "Could Not Get 'PreDefinedViewsCameras' Records. " + sError;

                        return false;
                    }

                    j = 0;
                    while (drPresetCameras.Read())
                    {
                        string sSiteName;
                        string sPresetToActivate;

                        int iCameraId;
                        int iCameraNumber;
                        int iDisplay;

                        iCameraId = (int)(drPresetCameras["Id"]);
                        sSiteName = drPresetCameras["DvrName"].ToString();
                        iCameraNumber = (int)(drPresetCameras["CameraNumber"]);
                        iDisplay = (int)(drPresetCameras["DisplayNumber"]);
                        sPresetToActivate = drPresetCameras["PresetToActivate"].ToString();

                        if (viewType == ViewType.PredefinedView)
                        {
                            m_PreDefinedView[i].Camera.Add(new PreDefinedViewCamera(iCameraId, 
                                                                                    sSiteName,
                                                                                    iCameraNumber,
                                                                                    iDisplay,
                                                                                    sPresetToActivate));
                        }
                        else
                        {
                            m_MainView[i].Camera.Add(new PreDefinedViewCamera(iCameraId, 
                                                                              sSiteName,
                                                                              iCameraNumber,
                                                                              iDisplay,
                                                                              sPresetToActivate));
                        }

                        j++;
                    }
                }

                i++;
            }

            dr.Close();
            //CloseConnection();

            sResult = "Got " + iNumberOfPredefinedViews + " Records";

            return true;
        }

        public string [] GetPreDefinedViews()
        {
            #region Data Members

            int i;
            int iRecords;
            int iNumberOfPredefinedViews;

            string sResult;
            string[] slPreDefinedView;

            OleDbCommand cmd;
            OleDbDataReader dr;

            DbReturnCode rc;

            #endregion

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                sResult = "Could Not Open Connection";

                return null;
            }

            cmd = new OleDbCommand("SELECT COUNT(*) FROM PreDefinedViews WHERE IsPreDefinedView<>0", m_cn);
            try
            {
                iRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();
                sResult = "Could Not Get Number Of 'PreDefinedViews' Records. " + sError;

                return null;
            }

            if (iRecords == 0)
            {
                sResult = "Got 0 Records.";

                return null;
            }
            else
            {
                iNumberOfPredefinedViews = iRecords;
            }

            cmd = new OleDbCommand("SELECT * FROM PreDefinedViews WHERE IsPreDefinedView<>0", m_cn);
            try
            {
                dr = cmd.ExecuteReader();
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();
                sResult = "Could Not Get 'PreDefinedViews' Records. " + sError;

                return null;
            }

            i = 0;
            slPreDefinedView = new string[iNumberOfPredefinedViews];

            while (dr.Read())
            {
                string sPreDefinedViewName = dr["Name"].ToString();               

                slPreDefinedView[i] = sPreDefinedViewName;
 
                i++;
            }

            dr.Close();
            //CloseConnection();

            sResult = "Got " + iNumberOfPredefinedViews + " Records";

            return slPreDefinedView;
        }

        private int GetViewIndex(string sViewName, ViewType viewType, out string sResult)
        {
            #region Data Members

            int iViewIndex;

            string sViewTypeQuery;

            OleDbCommand cmd;
            OleDbDataReader dr;

            DbReturnCode rc;

            #endregion

            sResult = "";
            iViewIndex = DvrClientConstants.NONE;

            switch (viewType)
            {
                case ViewType.PredefinedView:
                    sViewTypeQuery = "IsPreDefinedView<>0";
                    break;

                case ViewType.MainView:
                    sViewTypeQuery = "IsPreDefinedView=0";
                    break;

                default:
                    sResult = "Wrong View Type. " + viewType.ToString();
                    return DvrClientConstants.NONE;
            }

            sViewTypeQuery += " AND Name='" + sViewName + "' ";

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                sResult = "Could Not Open Connection";

                return DvrClientConstants.NONE;
            }

            cmd = new OleDbCommand("SELECT * FROM PreDefinedViews WHERE " + sViewTypeQuery, m_cn);
            try
            {
                dr = cmd.ExecuteReader();
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();
                sResult = "Could Not Get 'PreDefinedViews' Records. " + sError;

                return DvrClientConstants.NONE;
            }

            while (dr.Read())
            {
                iViewIndex = (int)(dr["Id"]);
            }

            dr.Close();
            //CloseConnection();

            return iViewIndex;
        }

        private bool GetVersion(out string sVersion, out string sResult)
        {
            #region Data Members
		
            OleDbCommand cmd;
            OleDbDataReader dr;
          
            int iRecords;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            DbReturnCode rc;

	        #endregion

            try
            {
                sResult = "";
                sVersion = "";

                rc = OpenConnection();
                if (!(rc == DbReturnCode.FinishedOK))
                {
                    sResult = "Could Not Open Connection";

                    return false;
                }

                cmd = new OleDbCommand("SELECT COUNT(*) FROM Version", m_cn);
                try
                {
                    iRecords = int.Parse(cmd.ExecuteScalar().ToString());
                }
                catch (OleDbException e)
                {
                    string sError = e.ToString();
                    sResult = "Could Not Get Number Of 'Version' Records. " + sError;

                    return false;
                }

                if (iRecords == 0)
                {
                    sResult = "Got 0 Records";

                    return false;
                }

                cmd = new OleDbCommand("SELECT * FROM Version", m_cn);
                try
                {
                    dr = cmd.ExecuteReader();
                }
                catch (OleDbException e)
                {
                    string sError = e.ToString();
                    sResult = "Could Not Get 'Version' Records. " + sError;

                    return false;
                }

                while (dr.Read())
                {
                    sVersion = dr["Version"].ToString();
                }

                dr.Close();
                //CloseConnection();

                sResult = "Got " + iRecords + " Records";

                return true;
            }
            catch (Exception e)
            {
                sVersion = "";
                sResult = e.Message;
                Audit(sResult, sMethod, AuditSeverity.Error);                                

                return false;
            }
        }

        private bool GetPtzPreset(out string sResult)
        {
            #region Data Members

            int i;
            OleDbCommand cmd;
            OleDbDataReader dr;

            int iRecords;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            DbReturnCode rc;

            #endregion

            try
            {
                sResult = "";

                rc = OpenConnection();
                if (!(rc == DbReturnCode.FinishedOK))
                {
                    sResult = "Could Not Open Connection";

                    return false;
                }

                cmd = new OleDbCommand("SELECT COUNT(*) FROM PtzPreset", m_cn);
                try
                {
                    iRecords = int.Parse(cmd.ExecuteScalar().ToString());
                }
                catch (OleDbException e)
                {
                    string sError = e.ToString();
                    sResult = "Could Not Get Number Of 'PtzPreset' Records. " + sError;

                    return false;
                }

                m_PtzPreset = new List<PtzPreset>();
                if (iRecords == 0)
                {
                    sResult = "Got 0 Records";

                    return false;
                }

                cmd = new OleDbCommand("SELECT * FROM PtzPreset", m_cn);
                try
                {
                    dr = cmd.ExecuteReader();
                }
                catch (OleDbException e)
                {
                    string sError = e.ToString();
                    sResult = "Could Not Get 'PtzPreset' Records. " + sError;

                    return false;
                }

                i = 0;
                while (dr.Read())
                {
                    string sDvr;
                    int iId;
                    int iCameraNumber;
                    string sPreset;
                    string sFrom;
                    string sTo;
                    int iDelay;

                    iId = (int)(dr["Id"]);
                    sDvr = dr["SiteName"].ToString();
                    iCameraNumber = int.Parse(dr["CameraNumber"].ToString());
                    sPreset = dr["Preset"].ToString();
                    sFrom = dr["StartTime"].ToString();
                    sTo = dr["EndTime"].ToString();
                    iDelay = int.Parse(dr["Delay"].ToString());

                    m_PtzPreset.Add(new PtzPreset(iId, sDvr, iCameraNumber, sPreset, sFrom, sTo, iDelay));

                    i++;
                }

                dr.Close();
                //CloseConnection();

                sResult = "Got " + iRecords + " Records";

                return true;
            }
            catch (Exception e)
            {
                string sError = e.Message;

                Audit(sError, sMethod, AuditSeverity.Error);
                sResult = sError;

                return false;
            }
        }

        public List<PtzPreset> GetPtzPreset(string sDvrName, int iCameraNumber)
        {
            #region Data Members
            
            OleDbCommand cmd;
            OleDbDataReader dr;

            int iRecords;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            DbReturnCode rc;
            List<PtzPreset> lPtzPreset = new List<PtzPreset>(); 

            #endregion

            try
            {
                rc = OpenConnection();
                if (!(rc == DbReturnCode.FinishedOK))
                {
                    return null;
                }

                cmd = new OleDbCommand("SELECT COUNT(*) FROM PtzPreset", m_cn);
                try
                {
                    iRecords = int.Parse(cmd.ExecuteScalar().ToString());
                }
                catch (OleDbException e)
                {
                    string s = e.ToString();

                    return null;
                }

                if (iRecords == 0)
                {
                    return null;
                }
                else
                {
                    m_PtzPreset = new List<PtzPreset>();
                }

                cmd = new OleDbCommand("SELECT * FROM PtzPreset", m_cn);
                try
                {
                    dr = cmd.ExecuteReader();
                }
                catch (OleDbException e)
                {
                    string s = e.ToString();
                    return null;
                }

                while (dr.Read())
                {
                    string sRecDvrName;
                    int iId;
                    int iRecCameraNumber;
                    string sPreset;
                    string sFrom;
                    string sTo;
                    int iDelay;

                    iId = (int)(dr["Id"]);
                    sRecDvrName = dr["SiteName"].ToString();
                    iRecCameraNumber = int.Parse(dr["CameraNumber"].ToString());
                    sPreset = dr["Preset"].ToString();
                    sFrom = dr["StartTime"].ToString();
                    sTo = dr["EndTime"].ToString();
                    iDelay = int.Parse(dr["Delay"].ToString());

                    if ((sRecDvrName == sDvrName) && (iCameraNumber == iRecCameraNumber))
                    {
                        lPtzPreset.Add(new PtzPreset(iId,
                                                     sRecDvrName,
                                                     iCameraNumber,
                                                     sPreset,
                                                     sFrom,
                                                     sTo,
                                                     iDelay));
                    }
                }

                dr.Close();
                //CloseConnection();

                return lPtzPreset;
            }
            catch (Exception e)
            {
                string sError = e.Message;
                Audit(sError, sMethod, AuditSeverity.Error);

                return null;
            }
        }

        public List<DvrRecord> GetDvrRecords(out string sResult)
        {
            #region Data Members
            
            OleDbCommand cmd;
            OleDbDataReader dr;

            int iRecords;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            DbReturnCode rc;
            List<DvrRecord> lDvrRecord = new List<DvrRecord>(); 

            #endregion

            try
            {
                rc = OpenConnection();
                if (!(rc == DbReturnCode.FinishedOK))
                {
                    sResult = "Could Not Open Connection";

                    return null;
                }

                cmd = new OleDbCommand("SELECT COUNT(*) FROM Dvrs", m_cn);
                try
                {
                    iRecords = int.Parse(cmd.ExecuteScalar().ToString());
                }
                catch (OleDbException e)
                {
                    sResult = "Could Not Get Number Of 'Dvrs' Records. " + e.Message;

                    return null;
                }

                if (iRecords == 0)
                {
                    sResult = "Got 0 Records";

                    return null;
                }
                else
                {
                    lDvrRecord = new List<DvrRecord>();
                }

                cmd = new OleDbCommand("SELECT * FROM Dvrs", m_cn);
                try
                {
                    dr = cmd.ExecuteReader();
                }
                catch (OleDbException e)
                {
                    sResult = "Could Not Get 'Dvrs' Records. " + e.Message;

                    return null;
                }

                while (dr.Read())
                {
                    int iId;
                    int iDvrId;
                    int iTriggerIdDelta;
                    
                    string sName;
                    string sIpAddress;
                    string sVendor;
                    
                    Vendor vVendor;                    

                    iId = (int)(dr["Id"]);
                    iDvrId = (int)(dr["DvrId"]);
                    sName = dr["Name"].ToString();
                    sIpAddress = dr["IpAddress"].ToString();
                    sVendor = dr["Vendor"].ToString();
                    iTriggerIdDelta = (int)(dr["TriggerIdDelta"]);

                    vVendor = Utils.String2Vendor(sVendor);

                    lDvrRecord.Add(new DvrRecord(iId, 
                                                 iDvrId,
                                                 sName,
                                                 sIpAddress,
                                                 vVendor, 
                                                 iTriggerIdDelta));                    
                }

                dr.Close();
                //CloseConnection();
                sResult = "Got " + iRecords + " Records";

                return lDvrRecord;
            }
            catch (Exception e)
            {
                string sError = e.Message;

                Audit(sError, sMethod, AuditSeverity.Error);
                sResult = sError;

                return null;
            }
        }

        public bool GetSoundFiles(out string sResult)
        {
            #region Data Members
            
            OleDbCommand cmd;
            OleDbDataReader dr;

            int iRecords;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            DbReturnCode rc; 

            #endregion

            try
            {
                rc = OpenConnection();
                if (!(rc == DbReturnCode.FinishedOK))
                {
                    sResult = "Could Not Open Connection";

                    return false;
                }

                cmd = new OleDbCommand("SELECT COUNT(*) FROM SoundFiles ", m_cn);
                try
                {
                    iRecords = int.Parse(cmd.ExecuteScalar().ToString());

                    if (iRecords > 1)
                    {
                        sResult = "More Than 1 Record Of 'SoundFiles' Records";

                        return false;
                    }
                }
                catch (OleDbException e)
                {
                    sResult = "Could Not Get Number Of 'SoundFiles' Records" + e.Message;

                    return false;
                }

                if (iRecords == 0)
                {
                    sResult = "Got 0 Records";

                    return false;
                }

                cmd = new OleDbCommand("SELECT * FROM SoundFiles", m_cn);
                try
                {
                    dr = cmd.ExecuteReader();
                }
                catch (OleDbException e)
                {
                    sResult = "Could Not Get 'SoundFiles' Records" + e.Message;

                    return false;
                }

                if (dr != null)
                {
                    dr.Read();

                    m_SoundFiles.VmdAlertFile = dr["VmdAlertFile"].ToString();
                    m_SoundFiles.CaAlertFile = dr["CaAlertFile"].ToString();
                    m_SoundFiles.VideoLossAlertFile = dr["VideoLossAlertFile"].ToString();
                    m_SoundFiles.TllDryContactAlertFile = dr["TllDryContactAlertFile"].ToString();
                    m_SoundFiles.ApplicationFailureAlertFile = dr["ApplicationFailureAlertFile"].ToString();
                }

                dr.Close();
                //CloseConnection();
                sResult = "Got A Record";

                return true;
            }
            catch (Exception e)
            {
                string sError = e.Message;

                Audit(sError, sMethod, AuditSeverity.Error);
                sResult = sError;

                return false;
            }
        }

        public DvrRecord GetDvrRecord(int iDvrId, out string sResult)
        {
            #region Data Members
            
            OleDbCommand cmd;
            OleDbDataReader dr;

            int iRecords;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            DbReturnCode rc;
            DvrRecord lDvrRecord = null; 

            #endregion

            try
            {
                rc = OpenConnection();
                if (!(rc == DbReturnCode.FinishedOK))
                {
                    sResult = "Could Not Open Connection";

                    return null;
                }

                cmd = new OleDbCommand("SELECT COUNT(*) FROM Dvrs WHERE DvrID=" + iDvrId + " ", m_cn);
                try
                {
                    iRecords = int.Parse(cmd.ExecuteScalar().ToString());

                    if (iRecords > 1)
                    {
                        sResult = "More Than 1 Record Of 'Dvrs' Records With DvrID=" + iDvrId + ". ";

                        return null;
                    }
                }
                catch (OleDbException e)
                {
                    sResult = "Could Not Get Number Of 'Dvrs' Records With DvrID=" + iDvrId + ". " + e.Message;

                    return null;
                }

                if (iRecords == 0)
                {
                    sResult = "Got 0 Records";

                    return null;
                }                

                cmd = new OleDbCommand("SELECT * FROM Dvrs WHERE DvrID=" + iDvrId + " ", m_cn);
                try
                {
                    dr = cmd.ExecuteReader();
                }
                catch (OleDbException e)
                {
                    sResult = "Could Not Get 'Dvrs' Records With DvrID=" + iDvrId + ". " + e.Message;

                    return null;
                }

                if (dr != null)
                {
                    int iId;
                    int iTriggerIdDelta;

                    string sName;
                    string sIpAddress;
                    string sVendor;
                    
                    Vendor vVendor;

                    iId = (int)(dr["Id"]);
                    iDvrId = (int)(dr["DvrId"]);
                    sName = dr["Name"].ToString();
                    sIpAddress = dr["IpAddress"].ToString();
                    sVendor = dr["Vendor"].ToString();
                    vVendor = Utils.String2Vendor(sVendor);
                    iTriggerIdDelta = (int)(dr["TriggerIdDelta"]);

                    lDvrRecord = new DvrRecord(iId,
                                               iDvrId,
                                               sName,
                                               sIpAddress,
                                               vVendor,
                                               iTriggerIdDelta);
                }

                dr.Close();
                //CloseConnection();
                sResult = "Got A Record A With DvrID=" + iDvrId + " ";

                return lDvrRecord;
            }
            catch (Exception e)
            {
                string sError = e.Message;

                Audit(sError, sMethod, AuditSeverity.Error);
                sResult = sError;

                return null;
            }
        }

        public bool DvrRecordExists(int iDvrId, out string sResult)
        {
            #region Data Members

            OleDbCommand cmd;

            int iRecords;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            DbReturnCode rc; 

            #endregion

            try
            {
                rc = OpenConnection();
                if (!(rc == DbReturnCode.FinishedOK))
                {
                    sResult = "Could Not Open Connection";

                    return false;
                }

                cmd = new OleDbCommand("SELECT COUNT(*) FROM Dvrs WHERE DvrID=" + iDvrId + " ", m_cn);
                try
                {
                    iRecords = int.Parse(cmd.ExecuteScalar().ToString());

                    if (iRecords > 1)
                    {
                        sResult = "More Than 1 Record Of 'Dvrs' Records With DvrID=" + iDvrId + ". ";

                        return false;
                    }
                    
                    if (iRecords == 0)
                    {
                        sResult = "Got 0 Records";

                        return false;
                    } 
                }
                catch (OleDbException e)
                {
                    sResult = "Could Not Get Number Of 'Dvrs' Records With DvrID=" + iDvrId + ". " + e.Message;

                    return true;
                }                                              

                //CloseConnection();
                sResult = "Got A Record With DvrID=" + iDvrId + " ";

                return true;
            }
            catch (Exception e)
            {
                string sError = e.Message;

                Audit(sError, sMethod, AuditSeverity.Error);
                sResult = sError;

                return false;
            }
        }

        public bool ViewRecordExists(string sViewName, ViewType viewType, out string sResult)
        {
            #region Data Members
            
            OleDbCommand cmd;
            
            int iRecords;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sViewTypeQuery;
            string sSql;

            DbReturnCode rc; 

            #endregion

            try
            {
                rc = OpenConnection();
                if (!(rc == DbReturnCode.FinishedOK))
                {
                    sResult = "Could Not Open Connection";

                    return false;
                }

                switch (viewType)
                {
                    case ViewType.PredefinedView:
                        sViewTypeQuery = "IsPreDefinedView<>0";
                        break;

                    case ViewType.MainView:
                        sViewTypeQuery = "IsPreDefinedView=0";
                        break;

                    default:
                        sResult = "Wrong View Type. " + viewType.ToString();
                        return false;
                }

                sSql = "SELECT COUNT(*) FROM PreDefinedViews WHERE " + sViewTypeQuery;
                sSql += " AND Name='" + sViewName + "'";

                cmd = new OleDbCommand(sSql, m_cn);
                try
                {
                    iRecords = int.Parse(cmd.ExecuteScalar().ToString());

                    if (iRecords > 1)
                    {
                        sResult = "More Than 1 " + Utils.GetEnumDescription(viewType) + " Record Of 'PreDefinedViews' Records With Name=" + sViewName + ". ";

                        return false;
                    }

                    if (iRecords == 0)
                    {
                        sResult = "Got 0 " + Utils.GetEnumDescription(viewType) + " Records";

                        return false;
                    }
                }
                catch (OleDbException e)
                {
                    sResult = "Could Not Get Number Of " + Utils.GetEnumDescription(viewType) + " 'PreDefinedViews' Records With Name=" + sViewName + ". " + e.Message;

                    return true;
                }

                //CloseConnection();
                sResult = "Got A " + Utils.GetEnumDescription(viewType) + " Record With Name=" + sViewName;

                return true;
            }
            catch (Exception e)
            {
                string sError = e.Message;

                Audit(sError, sMethod, AuditSeverity.Error);
                sResult = sError;

                return false;
            }
        }

        public bool DvrRecordExistsByRecordId(int iRecordId, out string sResult)
        {
            OleDbCommand cmd;

            //	the objects
            int iRecords;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            DbReturnCode rc;

            try
            {
                rc = OpenConnection();
                if (!(rc == DbReturnCode.FinishedOK))
                {
                    sResult = "Could Not Open Connection";

                    return false;
                }

                cmd = new OleDbCommand("SELECT COUNT(*) FROM Dvrs WHERE ID=" + iRecordId + " ", m_cn);
                try
                {
                    iRecords = int.Parse(cmd.ExecuteScalar().ToString());

                    if (iRecords > 1)
                    {
                        sResult = "More Than 1 Record Of 'Dvrs' Records With ID=" + iRecordId + ". ";

                        return false;
                    }

                    if (iRecords == 0)
                    {
                        sResult = "Got 0 Records";

                        return false;
                    }
                }
                catch (OleDbException e)
                {
                    sResult = "Could Not Get Number Of 'Dvrs' Records With ID=" + iRecordId + ". " + e.Message;

                    return true;
                }

                //CloseConnection();
                sResult = "Got A Record With ID=" + iRecordId + " ";

                return true;
            }
            catch (Exception e)
            {
                string sError = e.Message;

                Audit(sError, sMethod, AuditSeverity.Error);
                sResult = sError;

                return false;
            }
        }

        private bool GetSavedDisplays(out string sResult)
        {
            #region Data Members
            
            int i;
            int iRecords;

            OleDbCommand cmd;
            OleDbDataReader dr;
            
            DbReturnCode rc; 

            #endregion

            try
            {
                sResult = "";

                rc = OpenConnection();
                if (!(rc == DbReturnCode.FinishedOK))
                {
                    sResult = "Could Not Open Connection";

                    return false;
                }

                cmd = new OleDbCommand("SELECT COUNT(*) FROM SaveDisplays", m_cn);
                try
                {
                    iRecords = int.Parse(cmd.ExecuteScalar().ToString());
                }
                catch (OleDbException e)
                {
                    string sError = e.ToString();
                    sResult = "Could Not Get Number Of 'SaveDisplays' Records. " + sError;

                    return false;
                }

                if (iRecords == 0)
                {
                    sResult = "Got 0 Records";

                    return false;
                }
                else
                {
                    m_SavedDisplays = new List<SavedDisplay>();
                }

                cmd = new OleDbCommand("SELECT * FROM SaveDisplays", m_cn);
                try
                {
                    dr = cmd.ExecuteReader();
                }
                catch (OleDbException e)
                {
                    string sError = e.ToString();
                    sResult = "Could Not Get 'SaveDisplays' Records. " + sError;

                    return false;
                }

                i = 0;
                while (dr.Read())
                {
                    try
                    {
                        m_SavedDisplays.Add(new SavedDisplay(dr["SiteName"].ToString(),
                                                             dr["CameraNumber"].ToString(),
                                                             dr["DisplayNumber"].ToString(),
                                                             dr["ActionType"].ToString(),
                                                             dr["StartDateTime"].ToString(),
                                                             dr["EndDateTime"].ToString()));
                    }
                    catch (Exception e)
                    {
                        string sError = e.ToString();
                        sResult = "Could Not Read Values From 'SaveDisplays' Table. " + sError;

                        return false;
                    }

                    i++;
                }

                dr.Close();
                //CloseConnection();

                sResult = "Got " + iRecords + " Records";

                return true;
            }
            catch (Exception e)
            {
                string sError = e.Message;                
                sResult = sError;

                return false;
            }
        }

        private bool GetTreeNodesNames(out string sResult)
        {
            #region Data Members
            
            int i;
            int iRecords;

            OleDbCommand cmd;
            OleDbDataReader dr;

            DbReturnCode rc; 

            #endregion

            sResult = "";

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                sResult = "Could Not Open Connection";

                return false;
            }

            cmd = new OleDbCommand("SELECT COUNT(*) FROM TreeNodes", m_cn);
            try
            {
                iRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();
                sResult = "Could Not Number Of Get 'TreeNodes' Records. " + sError;

                return false;
            }

            if (iRecords == 0)
            {
                sResult = "Got 0 Records.";

                return false;
            }
            else
            {
                m_TreeNodeName = new string[iRecords];
            }

            cmd = new OleDbCommand("SELECT * FROM TreeNodes", m_cn);
            try
            {
                dr = cmd.ExecuteReader();
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();
                sResult = "Could Not Get 'TreeNodes' Records. ";

                return false;
            }

            i = 0;
            while (dr.Read())
            {
                m_TreeNodeName[i] = dr["Name"].ToString();

                i++;
            }

            dr.Close();
            //CloseConnection();

            sResult = "Got " + iRecords + " 'TreeNodes' Records";

            return true;
        }

        private string GetTreeNodeNameByIpAddress(string sIpAddress)
        {
            int i;
            int iSize;

            if (m_DvrsOnTreeNodes == null)
            {
                return "";
            }

            iSize = m_DvrsOnTreeNodes.Length;

            for (i = 0; i < iSize; i++)
            {
                if (m_DvrsOnTreeNodes[i].IP == sIpAddress)
                {
                    return m_DvrsOnTreeNodes[i].TreeNodeName;
                }
            }

            return "";
        }

        #region Indexes Creators

        private int GetPatrolsIndex()
        {
            OleDbCommand cmd;

            //	the objects
            int iMaximumIndex;
            int iNumberOfRecords;
            DbReturnCode rc;

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                return DvrClientConstants.NONE;
            }

            cmd = new OleDbCommand("SELECT COUNT(*) FROM Patrols", m_cn);
            try
            {
                iNumberOfRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string s = e.ToString();

                return DvrClientConstants.NONE;
            }

            if (iNumberOfRecords == 0)
            {
                return 1;
            }

            cmd = new OleDbCommand("SELECT MAX(Id) FROM Patrols", m_cn);
            try
            {
                iMaximumIndex = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string s = e.ToString();

                return DvrClientConstants.NONE;
            }

            //CloseConnection();

            return (iMaximumIndex + 1);
        }

        private int GetPatrolItemIndex()
        {
            OleDbCommand cmd;

            //	the objects
            int iMaximumIndex;
            int iNumberOfRecords;
            DbReturnCode rc;

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                return DvrClientConstants.NONE;
            }

            cmd = new OleDbCommand("SELECT COUNT(*) FROM PatrolItems", m_cn);
            try
            {
                iNumberOfRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string s = e.ToString();

                return DvrClientConstants.NONE;
            }

            if (iNumberOfRecords == 0)
            {
                return 1;
            }

            cmd = new OleDbCommand("SELECT MAX(Id) FROM PatrolItems", m_cn);
            try
            {
                iMaximumIndex = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string s = e.ToString();

                return DvrClientConstants.NONE;
            }

            //CloseConnection();

            return (iMaximumIndex + 1);
        }

        private int GetPreDefinedViewIndex()
        {
            OleDbCommand cmd;

            //	the objects
            int iMaximumIndex;
            int iNumberOfRecords;
            DbReturnCode rc;

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                return DvrClientConstants.NONE;
            }

            cmd = new OleDbCommand("SELECT COUNT(*) FROM PreDefinedViews", m_cn);
            try
            {
                iNumberOfRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string s = e.ToString();

                return DvrClientConstants.NONE;
            }

            if (iNumberOfRecords == 0)
            {
                return 1;
            }

            cmd = new OleDbCommand("SELECT MAX(Id) FROM PreDefinedViews", m_cn);
            try
            {
                iMaximumIndex = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string s = e.ToString();

                return DvrClientConstants.NONE;
            }

            //CloseConnection();

            return (iMaximumIndex + 1);
        }

        private int GetPreDefinedViewsCamerasIndex()
        {
            OleDbCommand cmd;

            //	the objects
            int iMaximumIndex;
            int iNumberOfRecords;
            DbReturnCode rc;

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                return DvrClientConstants.NONE;
            }

            cmd = new OleDbCommand("SELECT COUNT(*) FROM PreDefinedViewsCameras", m_cn);
            try
            {
                iNumberOfRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string s = e.ToString();

                return DvrClientConstants.NONE;
            }

            if (iNumberOfRecords == 0)
            {
                return 1;
            }

            cmd = new OleDbCommand("SELECT MAX(Id) FROM PreDefinedViewsCameras", m_cn);
            try
            {
                iMaximumIndex = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string s = e.ToString();

                return DvrClientConstants.NONE;
            }

            //CloseConnection();

            return (iMaximumIndex + 1);
        }

        private int GetPtzPresetIndex()
        {
            OleDbCommand cmd;

            //	the objects
            int iMaximumIndex;
            int iNumberOfRecords;
            DbReturnCode rc;

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                return DvrClientConstants.NONE;
            }

            cmd = new OleDbCommand("SELECT COUNT(*) FROM PtzPreset", m_cn);
            try
            {
                iNumberOfRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string s = e.ToString();

                return DvrClientConstants.NONE;
            }

            if (iNumberOfRecords == 0)
            {
                return 1;
            }

            cmd = new OleDbCommand("SELECT MAX(Id) FROM PtzPreset", m_cn);
            try
            {
                iMaximumIndex = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string s = e.ToString();

                return DvrClientConstants.NONE;
            }

            //CloseConnection();

            return (iMaximumIndex + 1);
        }

        private int GetDvrIndex()
        {
            OleDbCommand cmd;

            //	the objects
            int iMaximumIndex;
            int iNumberOfRecords;
            DbReturnCode rc;

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                return DvrClientConstants.NONE;
            }

            cmd = new OleDbCommand("SELECT COUNT(*) FROM Dvrs", m_cn);
            try
            {
                iNumberOfRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string s = e.ToString();

                return DvrClientConstants.NONE;
            }

            if (iNumberOfRecords == 0)
            {
                return 1;
            }

            cmd = new OleDbCommand("SELECT MAX(Id) FROM Dvrs", m_cn);
            try
            {
                iMaximumIndex = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string s = e.ToString();

                return DvrClientConstants.NONE;
            }

            //CloseConnection();

            return (iMaximumIndex + 1);
        }

        private int GetVendorDvrIndex()
        {
            int iMaximumIndex;

            if (m_VendorDvrRecord == null)
            {
                return DvrClientConstants.NONE;
            }

            if (m_VendorDvrRecord.Count == 0)
            {
                return 1;
            }

            iMaximumIndex = 0;
            for (int i = 0; i < m_VendorDvrRecord.Count; i++)
			{
                if (m_VendorDvrRecord[i].Index > iMaximumIndex)
                {
                    iMaximumIndex = m_VendorDvrRecord[i].Index; 
                }
			}
            
            return (iMaximumIndex + 1);
        }

        private int GetVendorPresetNumber(int iDvrId, int iCameraNumber)
        {
            #region Data Members
            
            OleDbCommand cmd;

            int iMaximumIndex;
            int iNumberOfRecords;

            DbReturnCode rc; 

            #endregion

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                return DvrClientConstants.NONE;
            }

            cmd = new OleDbCommand("SELECT COUNT(*) FROM Presets WHERE DvrId=" + iDvrId + 
                                   " AND CameraNumber=" + iCameraNumber +  " ", 
                                   m_cn);
            try
            {
                iNumberOfRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string s = e.ToString();

                return DvrClientConstants.NONE;
            }

            if (iNumberOfRecords == 0)
            {
                return 1;
            }

            cmd = new OleDbCommand("SELECT MAX(PresetNumber) FROM Presets WHERE DvrId=" + iDvrId +
                                   " AND CameraNumber=" + iCameraNumber + " ", 
                                   m_cn);
            try
            {
                iMaximumIndex = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string s = e.ToString();

                return DvrClientConstants.NONE;
            }

            return (iMaximumIndex + 1);
        } 

        #endregion

        public List<string> GetDataScopeItems(out string sResult)
        {
            OleDbCommand cmd;
            OleDbDataReader dr;

            //	the objects
            int iRecords;
            DbReturnCode rc;

            List<string> lItem = new List<string>();

            sResult = "";

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                sResult = "Could Not Open Connection";

                return null;
            }

            cmd = new OleDbCommand("SELECT COUNT(*) FROM DataScopeItems", m_cn);
            try
            {
                iRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();
                sResult = "Could Not Number Of Get 'DataScopeItems' Records. " + sError;

                return null;
            }

            if (iRecords == 0)
            {
                sResult = "Got 0 Records.";

                return null;
            }            

            cmd = new OleDbCommand("SELECT * FROM DataScopeItems", m_cn);
            try
            {
                dr = cmd.ExecuteReader();
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();
                sResult = "Could Not Get 'DataScopeItems' Records. ";

                return null;
            }

            while (dr.Read())
            {
                lItem.Add(dr["Item"].ToString());
            }

            dr.Close();
            //CloseConnection();

            return lItem;
        }

        private bool GetPatrols(out string sResult)
        {
            #region Data Members

            int i;
            int j;
            int iRecords;
            int iNumberOfPatrols;

            string sViewTypeQuery;

            OleDbCommand cmd;
            OleDbDataReader dr;
            OleDbDataReader drPatrolItems;

            DbReturnCode rc;

            #endregion

            sResult = "";

            try
            {
                rc = OpenConnection();
                if (!(rc == DbReturnCode.FinishedOK))
                {
                    sResult = "Could Not Open Connection";

                    return true;
                }

                cmd = new OleDbCommand("SELECT COUNT(*) FROM Patrols ", m_cn);
                try
                {
                    iRecords = int.Parse(cmd.ExecuteScalar().ToString());
                }
                catch (OleDbException e)
                {
                    string sError = e.ToString();
                    sResult = "Could Not Get Number Of 'Patrols' Records. " + sError;

                    return false;
                }

                if (iRecords == 0)
                {
                    sResult = "Got 0 Records.";

                    return false;
                }
                else
                {
                    iNumberOfPatrols = iRecords;
                }

                cmd = new OleDbCommand("SELECT * FROM Patrols ", m_cn);
                try
                {
                    dr = cmd.ExecuteReader();
                }
                catch (OleDbException e)
                {
                    string sError = e.ToString();
                    sResult = "Could Not Get 'Patrols' Records. " + sError;

                    return false;
                }

                i = 0;
                m_Patrol = new List<Patrol>();

                while (dr.Read())
                {
                    int iId = (int)(dr["Id"]);
                    string sPatrolName = dr["PatrolName"].ToString();
                    string sPatrolLayout = dr["PatrolLayout"].ToString();
                    bool bIsCyclic = (bool)(dr["IsCyclic"]);

                    string sSql;

                    m_Patrol.Add(new Patrol(iId,
                                            sPatrolName,
                                            sPatrolLayout,
                                            bIsCyclic));


                    //  now let's see how many cameras there are for this preset
                    sSql = "SELECT COUNT(*) FROM PatrolItems WHERE PatrolId=" + iId + " ";
                    cmd = new OleDbCommand(sSql, m_cn);
                    try
                    {
                        iRecords = int.Parse(cmd.ExecuteScalar().ToString());
                    }
                    catch (OleDbException e)
                    {
                        string sError = e.ToString();
                        sResult = "Could Not Get Number Of 'PatrolItems' Records. " + sError;

                        return false;
                    }

                    if (iRecords != 0)
                    {
                        sSql = "SELECT * FROM PatrolItems WHERE PatrolId=" + iId + " ";
                        cmd = new OleDbCommand(sSql, m_cn);
                        try
                        {
                            drPatrolItems = cmd.ExecuteReader();
                        }
                        catch (OleDbException e)
                        {
                            string sError = e.ToString();
                            sResult = "Could Not Get 'PatrolItems' Records. " + sError;

                            return false;
                        }

                        j = 0;
                        while (drPatrolItems.Read())
                        {
                            string sDvr;
                            string sPresetToActivate;

                            int iCameraId;
                            int iPatrolId;
                            int iCameraNumber;
                            int iDisplayNumber;
                            int iDuration;
                            int iSpeed;

                            iCameraId = (int)(drPatrolItems["Id"]);
                            iPatrolId = (int)(drPatrolItems["PatrolId"]);
                            sDvr = drPatrolItems["Dvr"].ToString();
                            iCameraNumber = (int)(drPatrolItems["CameraNumber"]);
                            iDisplayNumber = (int)(drPatrolItems["DisplayNumber"]);
                            sPresetToActivate = drPatrolItems["Preset"].ToString();
                            iDuration = (int)(drPatrolItems["Duration"]);
                            iSpeed = (int)(drPatrolItems["Speed"]);

                            m_Patrol[i].PatrolItem.Add(new PatrolItem(iCameraId,
                                                                      iPatrolId,
                                                                      sDvr,
                                                                      iCameraNumber,
                                                                      iDisplayNumber,
                                                                      sPresetToActivate,
                                                                      iDuration,
                                                                      iSpeed));

                            j++;
                        }
                    }

                    i++;
                }

                dr.Close();
                //CloseConnection();

                sResult = "Got " + iNumberOfPatrols + " Records";

                return true;
            }
            catch (Exception e)
            {
                sResult = e.Message;

                return false;
            }
        }

        public bool GetCameraPresets(int iDvrId, 
                                      int iCameraNumber, 
                                      out List<string> lsPreset, 
                                      out string sResult)
        {
            #region Data Members

            int i;
            int iRecords;

            OleDbCommand cmd;
            OleDbDataReader dr;

            DbReturnCode rc;

            #endregion

            sResult = "";
            lsPreset = null;

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                sResult = "Could Not Open Connection";

                return false;
            }

            cmd = new OleDbCommand("SELECT COUNT(*) FROM Presets WHERE DvrId=" + iDvrId + 
                                   " AND CameraNumber=" + iCameraNumber + " ", 
                                   m_cn);
            try
            {
                iRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();
                sResult = "Could Not Number Of Get 'Presets' Records. " + sError;

                return false;
            }

            if (iRecords == 0)
            {
                sResult = "Got 0 Records.";

                return false;
            }
            else
            {
                lsPreset = new List<string>();
            }

            cmd = new OleDbCommand("SELECT * FROM Presets WHERE DvrId=" + iDvrId +
                                   " AND CameraNumber=" + iCameraNumber + " ", 
                                   m_cn);
            try
            {
                dr = cmd.ExecuteReader();
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();
                sResult = "Could Not Get 'Presets' Records. ";

                return false;
            }

            i = 0;
            
            while (dr.Read())
            {
                lsPreset.Add(dr["PresetName"].ToString());

                i++;
            }

            dr.Close();
            //CloseConnection();

            sResult = "Got " + iRecords + " 'Presets' Records";

            return true; 
        }

        private bool GetCameraPresetNumber(int iDvrId,
                                           int iCameraNumber,
                                           string sPresetName,
                                           out int iPresetNumber,
                                           out string sResult)
        {
            #region Data Members

            int i;
            int iRecords;

            OleDbCommand cmd;
            OleDbDataReader dr;

            DbReturnCode rc;

            #endregion

            sResult = "";
            iPresetNumber = DvrClientConstants.NONE;

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                sResult = "Could Not Open Connection";

                return false;
            }

            cmd = new OleDbCommand("SELECT COUNT(*) FROM Presets WHERE DvrId=" + iDvrId +
                                   " AND CameraNumber=" + iCameraNumber + 
                                   " AND PresetName='" + sPresetName + "' ",
                                   m_cn);
            try
            {
                iRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();
                sResult = "Could Not Number Of Get 'Presets' Records. " + sError;

                return false;
            }

            if (iRecords == 0)
            {
                sResult = "Got 0 Records.";

                return false;
            }
            else
            {
                if (iRecords > 1)
                {
                    sResult = "Got More Than 1 Record.";

                    return false;
                }
            }

            cmd = new OleDbCommand("SELECT * FROM Presets WHERE DvrId=" + iDvrId +
                                   " AND CameraNumber=" + iCameraNumber +
                                   " AND PresetName='" + sPresetName + "' ",
                                   m_cn);
            try
            {
                dr = cmd.ExecuteReader();
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();
                sResult = "Could Not Get 'Presets' Records. ";

                return false;
            }

            i = 0;
            while (dr.Read())
            {
                iPresetNumber = (int)(dr["PresetNumber"]);

                i++;
            }

            dr.Close();
            //CloseConnection();

            sResult = "Got " + iRecords + " 'Presets' Records";

            return true;
        }

        #endregion        

        #region Insert

        private DbReturnCode InsertVersion()
        {
            string sql;

            sql = "Insert Into Version(Version) ";
            sql = sql + "Values(" + "'" + Application.ProductVersion + "')";

            return ExecuteNonQuery(sql);
        }

        private DbReturnCode InsertPatrol(string sPatrolName,
                                          string sPatrolLayout,
                                          bool bIsCyclic)
        {
            string sql;
            string sIsCyclic;

            int iId = GetPatrolsIndex();

            sIsCyclic = ((bIsCyclic) ? 1 : 0).ToString();

            sql = "Insert Into Patrols(Id,PatrolName,PatrolLayout,IsCyclic) ";
            sql = sql + "Values(" + iId.ToString() +
                             ",'" + sPatrolName + "','" +
                                    sPatrolLayout + "'," +
                                    sIsCyclic + ")";

            return ExecuteNonQuery(sql);
        }

        private DbReturnCode InsertPatrolItem(int iPatrolId,
                                              string sDvr,
                                              int iCameraNumber,
                                              int iDisplayNumber,
                                              string sPreset,
                                              int iDuration,
                                              int iSpeed)
        {
            int iPatrolItemId = GetPatrolItemIndex();

            string sql;

            sql = "Insert Into PatrolItems(Id,PatrolId,Dvr,CameraNumber,DisplayNumber,Preset,Duration,Speed) ";
            sql = sql + "Values(" + iPatrolItemId + "," + iPatrolId + ",";
            sql = sql + "'" + sDvr + "'" + ",";
            sql = sql + iCameraNumber + ",";
            sql = sql + iDisplayNumber + ",";
            sql = sql + "'" + sPreset + "'," + iDuration + ","+ iSpeed + ")";

            return ExecuteNonQuery(sql);
        }


        private DbReturnCode InsertSoundFiles(string sVmdAlertFile,
                                              string sCaAlertFile,
                                              string sVideoLossAlertFile,
                                              string sTllDryContactAlertFile,
                                              string sApplicationFailureAlertFile)
        {
            string sql;

            sql = "Insert Into SoundFiles(VmdAlertFile,CaAlertFile,VideoLossAlertFile,TllDryContactAlertFile,ApplicationFailureAlertFile) ";
            sql = sql + "Values(" + "'" + sVmdAlertFile + "','" +
                                          sCaAlertFile + "','" +
                                          sVideoLossAlertFile + "','" +
                                          sTllDryContactAlertFile + "','" +
                                          sApplicationFailureAlertFile + "')";

            return ExecuteNonQuery(sql);
        }

        private DbReturnCode InsertPreDefinedView(string sPreDefinedView, 
                                                  string sLayout)
        {
            string sql;
            int iIsPredefinedView;
            int iId = GetPreDefinedViewIndex();

            iIsPredefinedView = 1;

            sql = "Insert Into PreDefinedViews(Id,Name,Layout,IsPreDefinedView,StartTime,EndTime) ";
            sql = sql + "Values(" + iId.ToString() + 
                             ",'" + sPreDefinedView + "','" + 
                                    sLayout + "'," +
                                    iIsPredefinedView.ToString() + ",'" +
                                    "00:00" + "','" +
                                    "00:00" + "')";

            return ExecuteNonQuery(sql);
        }

        private DbReturnCode InsertMainView(string sMainView, 
                                            string sLayout, 
                                            string sStartTime, 
                                            string sEndTime)
        {
            string sql;

            int iIsPredefinedView;
            int iId = GetPreDefinedViewIndex();

            iIsPredefinedView = 0;

            sql = "Insert Into PreDefinedViews(Id,Name,Layout,IsPreDefinedView,StartTime,EndTime) ";
            sql = sql + "Values(" + iId.ToString() + 
                             ",'" + sMainView + "','" + 
                                    sLayout + "'," + 
                                    iIsPredefinedView.ToString() + ",'" + 
                                    sStartTime + "','" + 
                                    sEndTime + "')";

            return ExecuteNonQuery(sql);
        }

        private DbReturnCode InsertPreDefinedViewCamera(int iPreDefinedViewId,
                                                        string sSiteName,
                                                        int iCameraNumber,
                                                        int iDisplay,
                                                        string sPresetToActivate)
        {
            int iId = GetPreDefinedViewsCamerasIndex();

            string sql;

            sql = "Insert Into PreDefinedViewsCameras(Id,PreDefinedViewId,DvrName,CameraNumber,DisplayNumber,PresetToActivate) ";
            sql = sql + "Values(" +  iId + "," + iPreDefinedViewId + ",";
            sql = sql + "'" + sSiteName + "'" + ",";
            sql = sql + iCameraNumber + ",";
            sql = sql + iDisplay + ",";
            sql = sql + "'" + sPresetToActivate + "')";

            return ExecuteNonQuery(sql);
        }

        private DbReturnCode InsertLogRecord(DvrClientModule mModule,
                                             string sMethod,
                                             string sDescription)
        {
            string sql;

            sDescription = sDescription.Replace("'", "''");

            sql = "Insert Into Log(LogDate,Source,Method,Description) ";
            sql = sql + "Values('" + DateTime.Now.ToString() + "',";
            sql = sql + "'" + Utils.GetEnumDescription(mModule) + "'" + ",";
            sql = sql + "'" + sMethod + "'" + ",";
            sql = sql + "'" + sDescription + "')";

            return ExecuteNonQuery(sql);
        }

        private DbReturnCode InsertDisplayRecord(string sDvr,
                                                 string sCameraNumber,
                                                 string sDisplay,
                                                 string sAction,
                                                 DateTime StartDateTime,
                                                 DateTime EndDateTime)
        {
            string sql;

            sql = "Insert Into SaveDisplays(SiteName,CameraNumber,DisplayNumber,ActionType,StartDateTime,EndDateTime) ";
            sql = sql + "Values('" +
                        sDvr + "','" +
                        sCameraNumber + "','" +
                        sDisplay + "','" +
                        sAction + "','" +
                        StartDateTime.ToString() + "','" +
                        EndDateTime.ToString() + "')";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode InsertPtzPresetRecord(string sDvrName,
                                                  string sCameraNumber,
                                                  string sPreset,
                                                  string sStartTime,
                                                  string sEndTime,
                                                  int iDelay)
        {
            string sql;
            int iId = GetPtzPresetIndex();

            sql = "Insert Into PtzPreset(Id,SiteName,CameraNumber,Preset,StartTime,EndTime,Delay) ";
            sql = sql + "Values(" +
                        iId.ToString() + ",'" +
                        sDvrName + "','" +
                        sCameraNumber + "','" +
                        sPreset + "','" +
                        sStartTime + "','" +
                        sEndTime + "','" +
                        iDelay.ToString() + "')";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode InsertDvrRecord(int iDvrId,
                                            string sName,
                                            string sIpAddress,
                                            string sVendor,
                                            int iTriggerIdDelta)
        {
            string sql;
            int iId = GetDvrIndex();

            sql = "Insert Into Dvrs(Id,DvrId,Name,IpAddress,Vendor,TriggerIdDelta) ";
            sql = sql + "Values(" +
                        iId.ToString() + "," +
                        iDvrId.ToString() + ",'" +
                        sName + "','" +
                        sIpAddress + "','" +
                        sVendor + "'," + 
                        iTriggerIdDelta.ToString() + ")";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode InsertPresetRecord(int iDvrId,
                                               int iCameraNumber,
                                               int iPresetNumber,
                                               string sPresetName)
        {
            string sql;
            int iId = GetDvrIndex();

            sql = "Insert Into Presets(DvrId,CameraNumber,PresetNumber,PresetName) ";
            sql = sql + "Values(" +
                        iDvrId.ToString() + "," +
                        iCameraNumber.ToString() + "," +
                        iPresetNumber.ToString() + ",'" +
                        sPresetName +  "')";

            return ExecuteNonQuery(sql);
        }

        private DbReturnCode InsertDataScopeItemRecord(string sItem)
        {
            string sql;

            sql = "Insert Into DataScopeItems(Item) ";
            sql = sql + "Values('" + sItem + "')";

            return ExecuteNonQuery(sql);
        }

        #endregion

        #region Update

        public DbReturnCode UpdatePatrolRecord(int iId,
                                               string sPatrolName,
                                               string sPatrolLayout,
                                               bool bIsCyclic)
        {
            string sSql;
            string sIsCyclic;

            sIsCyclic = ((bIsCyclic) ? 1 : 0).ToString();

            sSql = "UPDATE Patrols ";
            sSql += "SET PatrolName='" + sPatrolName;
            sSql += "',PatrolLayout='" + sPatrolLayout;
            sSql += "',IsCyclic=" + sIsCyclic + " ";
            sSql += " WHERE Id=" + iId + " ";

            return ExecuteNonQuery(sSql);
        }

        public DbReturnCode UpdatePatrolItemRecord(int iPatrolItemId,
                                                   int iPatrolId,
                                                   string sDvr,
                                                   int iCameraNumber,
                                                   int iDisplayNumber,
                                                   string sPreset,
                                                   int iDuration,
                                                   int iSpeed)
        {
            string sSql;

            sSql = "UPDATE PatrolItems ";
            sSql += "SET PatrolId=" + iPatrolId;
            sSql += ",Dvr='" + sDvr + "'";
            sSql += ",CameraNumber=" + iCameraNumber;
            sSql += ",DisplayNumber=" + iDisplayNumber;
            sSql += ",Preset='" + sPreset + "'";
            sSql += ",Duration=" + iDuration;
            sSql += ",Speed=" + iSpeed;
            sSql += " WHERE Id=" + iPatrolItemId + " ";

            return ExecuteNonQuery(sSql);
        }

        public DbReturnCode UpdatePtzPresetRecord(int iId,
                                                  string sDvrName,
                                                  string sCameraNumber,
                                                  string sPreset,
                                                  string sStartTime,
                                                  string sEndTime,
                                                  int iDelay)
        {
            string sSql;

            sSql = "UPDATE PtzPreset ";
            sSql += "SET SiteName='" + sDvrName;
            sSql += "',CameraNumber='" + sCameraNumber;
            sSql += "',Preset='" + sPreset;
            sSql += "',StartTime='" + sStartTime;
            sSql += "',EndTime='" + sEndTime;
            sSql += "',Delay='" + iDelay.ToString() + "' ";
            sSql += "WHERE Id=" + iId + " ";

            return ExecuteNonQuery(sSql);
        }

        public DbReturnCode ChangePreDefinedViewRecordToMainViewRecord(string sPreDefinedView, 
                                                                       string sStartTime,
                                                                       string sEndTime)
        {
            string sSql;

            sSql = "UPDATE PreDefinedViews ";
            sSql += "SET StartTime='" + sStartTime + "',EndTime='" + sEndTime + "',IsPreDefinedView=1";
            sSql += "WHERE Name='" + sPreDefinedView + "' ";

            return ExecuteNonQuery(sSql);
        }

        public DbReturnCode UpdatePreDefinedViewRecord(string sOldPreDefinedView,
                                                       string sNewPreDefinedView,
                                                       string sLayout, 
                                                       bool bIsPreDefinedView,
                                                       string sStartTime,
                                                       string sEndTime)
        {
            string sSql;
            string sIsPreDefinedView;

            if (bIsPreDefinedView)
            {
                sIsPreDefinedView = "1";
            }
            else
            {
                sIsPreDefinedView = "0";
            }

            sSql = "UPDATE PreDefinedViews ";
            sSql += "SET StartTime='" + sStartTime + 
                    "',EndTime='" + sEndTime +
                    "',Layout='" + sLayout +
                    "',Name='" + sNewPreDefinedView +
                    "',IsPreDefinedView=" + sIsPreDefinedView;
            sSql += " WHERE Name='" + sOldPreDefinedView + "' ";

            return ExecuteNonQuery(sSql);
        }

        public DbReturnCode UpdateMainViewRecord(int iMainVIewViewId,
                                                 string sPreDefinedView,
                                                 string sLayout,                                                 
                                                 string sStartTime,
                                                 string sEndTime)
        {
            string sSql;

            sSql = "UPDATE PreDefinedViews ";
            sSql += "SET StartTime='" + sStartTime +
                    "',EndTime='" + sEndTime +
                    "',Layout='" + sLayout +
                    "',Name='" + sPreDefinedView + "' ";
            sSql += " WHERE Id=" + iMainVIewViewId + " ";

            return ExecuteNonQuery(sSql);
        }

        public DbReturnCode UpdatePreDefinedViewRecord(int iPreDefinedViewIndex,
                                                       string sPreDefinedViewName,
                                                       string sLayout)
        {
            string sSql;

            sSql = "UPDATE PreDefinedViews ";
            sSql += "SET Layout='" + sLayout +
                    "',Name='" + sPreDefinedViewName + "' ";
            sSql += "WHERE Id=" + iPreDefinedViewIndex + " ";

            return ExecuteNonQuery(sSql);
        }

        private DbReturnCode UpdatePreDefinedViewCameraRecord(int iPreDefinedViewCameraId,
                                                              string sSiteName,
                                                              int iCameraNumber,
                                                              int iDisplay,
                                                              string sPresetToActivate)
        {
            string sSql;

            sSql = "UPDATE PreDefinedViewsCameras ";
            sSql += "SET DvrName='" + sSiteName +
                    "',CameraNumber=" + iCameraNumber.ToString() +
                    ",DisplayNumber=" + iDisplay.ToString() +
                    ",PresetToActivate='" + sPresetToActivate + "'";
            sSql += " WHERE Id=" + iPreDefinedViewCameraId + " ";

            return ExecuteNonQuery(sSql);
        }

        public DbReturnCode UpdateDvrRecord(int iDvrId,
                                            string sDvrName,
                                            string sDvrIpAddress,
                                            string sVendor,
                                            int iTriggerIdDelta,
                                            int iRecordId)
        {
            string sSql;

            sSql = "UPDATE Dvrs ";
            sSql += "SET Name='" + sDvrName +
                    "',IpAddress='" + sDvrIpAddress + 
                    "',Vendor='" + sVendor +
                    "',TriggerIdDelta=" + iTriggerIdDelta +  
                    ",DvrId=" + iDvrId + " ";
            sSql += "WHERE Id=" + iRecordId + " ";

            return ExecuteNonQuery(sSql);
        }

        public DbReturnCode UpdatePresetRecord(int iDvrId,
                                               int iCameraNumber,
                                               int iPresetNumber,
                                               string sNewPresetName)
        {
            string sSql;

            sSql = "UPDATE Presets ";
            sSql += "SET PresetName='" + sNewPresetName + "' ";
            sSql += "WHERE DvrId=" + iDvrId + 
                    " AND CameraNumber=" + iCameraNumber + 
                    " AND PresetNumber=" + iPresetNumber + " ";

            return ExecuteNonQuery(sSql);
        }

        #endregion
                
        #region Delete

        private DbReturnCode DeleteVersionTableContents()
        {
            string sql = "DELETE FROM Version";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeletePatrolRecord(int iPatrolId)
        {
            string sql = "DELETE FROM Patrols WHERE Id=" + iPatrolId + " ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeleteAllPatrols()
        {
            string sql = "DELETE FROM Patrols ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeletePatrolItem(int iPatrolId, int iPatrolItemId)
        {
            string sql = "DELETE FROM PatrolItems WHERE PatrolId=" + iPatrolId + " AND Id=" + iPatrolItemId + " ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeletePatrolItemByPatrolId(int iPatrolId)
        {
            string sql = "DELETE FROM PatrolItems WHERE PatrolId=" + iPatrolId + " ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeleteAllPatrolItems()
        {
            string sql = "DELETE FROM PatrolItems ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode PtzPresetRecordDelete(string sDvrName, string sCameraNumber)
        {
            string sSql = "DELETE FROM PtzPreset ";
            sSql += "WHERE SiteName='" + sDvrName + "' AND CameraNumber='" + sCameraNumber + "' ";

            return ExecuteNonQuery(sSql);
        }

        private DbReturnCode DeletePreDefinedViewsTableContents()
        {
            string sql = "DELETE FROM PreDefinedViews WHERE IsPredefinedView<>0";

            return ExecuteNonQuery(sql);
        }

        private DbReturnCode DeletePreDefinedView(int iPreDefinedViewId)
        {
            string sql = "DELETE FROM PreDefinedViews WHERE IsPredefinedView<>0 AND Id=" + iPreDefinedViewId + " ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeletePreset(string sPreDefinedView)
        {
            string sql = "DELETE FROM PreDefinedViews WHERE Name='" + sPreDefinedView + "' AND IsPredefinedView<>0";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeleteMainView(string sMainView)
        {
            string sql = "DELETE FROM PreDefinedViews WHERE Name='" + sMainView + "' AND IsPredefinedView=0";

            return ExecuteNonQuery(sql);
        }

        private DbReturnCode DeletePreDefinedViewsCamerasTableContents()
        {
            //string sql = "DELETE FROM PreDefinedViewsCameras ";
            string sql = "DELETE FROM PreDefinedViewsCameras WHERE PreDefinedViewId=(SELECT Id FROM PreDefinedViews WHERE IsPredefinedView<>0)";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeletePreDefinedViewsCameras(int iPreDefinedViewId)
        {
            string sql = "DELETE FROM PreDefinedViewsCameras WHERE PreDefinedViewId=" + iPreDefinedViewId + " ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeletePreDefinedViewsCamera(int iPreDefinedViewCameraId)
        {
            string sql = "DELETE FROM PreDefinedViewsCameras WHERE Id=" + iPreDefinedViewCameraId + " ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeletePreDefinedViewsCameras(int iPreDefinedViewId, 
                                                         string sSiteName, 
                                                         int iCameraNumber)
        {
            string sql;

            sql  = "DELETE FROM PreDefinedViewsCameras ";
            sql += "WHERE PreDefinedViewId=" + iPreDefinedViewId + " ";
            sql += "AND DvrName='" + sSiteName + "' ";
            sql += "AND CameraNumber=" + iCameraNumber + " ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeleteDisplays()
        {
            string sql = "DELETE FROM SaveDisplays ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeleteAllPtzPreset()
        {
            string sql = "DELETE FROM PtzPreset ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeleteDataScopeItems()
        {
            string sql = "DELETE FROM DataScopeItems ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeletePtzPreset(int iId)
        {
            string sql = "DELETE FROM PtzPreset WHERE Id=" + iId + " ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeleteAllDvrs()
        {
            string sql = "DELETE FROM Dvrs ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeleteSoundFiles()
        {
            string sql = "DELETE FROM SoundFiles ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeleteDvrById(int iId)
        {
            string sql = "DELETE FROM Dvrs WHERE Id=" + iId + " ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeleteDvrByDvrId(int iDvrId)
        {
            string sql = "DELETE FROM Dvrs WHERE DvrId=" + iDvrId + " ";

            return ExecuteNonQuery(sql);
        }

        public DbReturnCode DeletePreset(int iDvrId,
                                         int iCameraNumber,
                                         int iPresetNumber)
        {
            string sql;

            sql = "DELETE FROM Presets ";
            sql += "WHERE DvrId=" + iDvrId + " ";
            sql += "AND CameraNumber=" + iCameraNumber + " ";
            sql += "AND PresetNumber=" + iPresetNumber + " ";

            return ExecuteNonQuery(sql);
        }

        #endregion

        #region Alter Table

        private bool AlterTable_AddColumn(string sTableName, string sColumnName, Type tType)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string strSQL;
            string sType;

            OleDbCommand sqlCommand;

            DbReturnCode dbRc;

            #endregion

            try
            {
                dbRc = OpenConnection();

                if (tType == typeof(bool))
                {
                    sType = "Bit NOT NULL";
                }
                else
                {
                    if (tType == typeof(int))
                    {
                        sType = "INTEGER NOT NULL";
                    }
                    else
                    {
                        if (tType == typeof(string))
                        {
                            sType = "NVarChar(50) NOT NULL";
                        }
                        else
                        {
                            return false;
                        }
                    }
                }

                strSQL = "ALTER TABLE " + sTableName + " ADD " + sColumnName + " " + sType;

                sqlCommand = new OleDbCommand(strSQL, m_cn);
                sqlCommand.ExecuteNonQuery();

                Audit("Added Column '" + sColumnName + 
                      "' To Table '" + sTableName + "' With Type '" + tType.Name + "'", 
                      sMethod, 
                      AuditSeverity.Information);

                return true;
            }
            catch (Exception e)
            {
                Audit("Failed Adding Column '" + sColumnName +
                      "' To Table '" + sTableName + "'. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);

                return false;
            }
        }

        private bool AlterTable_DropColumn(string sTableName, string sColumnName)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string strSQL;

            OleDbCommand sqlCommand;

            DbReturnCode dbRc;

            #endregion

            try
            {
                dbRc = OpenConnection();

                strSQL = "ALTER TABLE " + sTableName + " DROP COLUMN " + sColumnName + " ";

                sqlCommand = new OleDbCommand(strSQL, m_cn);
                sqlCommand.ExecuteNonQuery();

                Audit("Dropped Column '" + sColumnName +
                      "' From Table '" + sTableName + "'",
                      sMethod,
                      AuditSeverity.Information);

                return true;
            }
            catch (Exception e)
            {
                Audit("Failed Dropping Column '" + sColumnName +
                      "' From Table '" + sTableName + "'. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);

                return false;
            }
        }

        private bool AlterTable_UpdateColumnType(string sTableName, string sColumnName, Type tNewType, Type tOldType)
        {
            #region Data Members

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string strSQL;
            string sType;

            OleDbCommand sqlCommand;

            DbReturnCode dbRc;

            #endregion

            try
            {
                dbRc = OpenConnection();

                if (tNewType == typeof(bool))
                {
                    sType = "Bit NOT NULL";
                }
                else
                {
                    if (tNewType == typeof(int))
                    {
                        sType = "INTEGER NOT NULL";
                    }
                    else
                    {
                        if (tNewType == typeof(string))
                        {
                            sType = "NVarChar(50) NOT NULL";
                        }
                        else
                        {
                            return false;
                        }
                    }
                }

                strSQL = "ALTER TABLE " + sTableName + " ALTER COLUMN " + sColumnName + " " + sType;

                sqlCommand = new OleDbCommand(strSQL, m_cn);
                sqlCommand.ExecuteNonQuery();

                Audit("Modified Column '" + sColumnName +
                      "' From Table '" + sTableName + 
                      "' From Type '" + tNewType.Name + 
                      "' To Type '" + tOldType.Name + "'",
                      sMethod,
                      AuditSeverity.Information);

                return true;
            }
            catch (Exception e)
            {
                Audit("Failed Modifying Column '" + sColumnName +
                      "' From Table '" + sTableName +
                      "' From Type '" + tNewType.Name +
                      "' To Type '" + tOldType.Name + "'. " + e.Message,
                      sMethod,
                      AuditSeverity.Error);

                return false;
            }
        }

        #endregion

        private bool GetDatabaseStructure()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            DataTable schemaDataTable;

            try
            {
                m_DvrClientDatabase = new List<DatabaseTable>();

                schemaDataTable = m_cn.GetOleDbSchemaTable(OleDbSchemaGuid.Tables, 
                                                           new Object[] { null, null, null, "TABLE" });

                for (int i = 0; i < schemaDataTable.Rows.Count; i++)
                {
                    string sTableName = schemaDataTable.Rows[i].ItemArray[2].ToString();
                    m_DvrClientDatabase.Add(new DatabaseTable(sTableName));

                    DataTable dtField = m_cn.GetOleDbSchemaTable(OleDbSchemaGuid.Columns, 
                                                                 new object[] { null, null, sTableName });

                    foreach (DataRow dr in dtField.Rows)
                    {
                        string sColumnName = dr["COLUMN_NAME"].ToString();

                        OleDbCommand cmd = new OleDbCommand("SELECT [" + sColumnName + "] FROM [" + sTableName + "]", m_cn);
                        OleDbDataReader rdr = cmd.ExecuteReader();
                        DataTable schemaTable = rdr.GetSchemaTable();

                        string sCoulumnType = schemaTable.Rows[0][schemaTable.Columns["DataType"]].ToString();
                        Type tType = (Type)schemaTable.Rows[0][schemaTable.Columns["DataType"]];                        
                        m_DvrClientDatabase[m_DvrClientDatabase.Count - 1].AddColumn(sColumnName, tType);
                    }
                }

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private DbReturnCode ExecuteNonQuery(string sSql)
        {
            #region Data Members
            
            OleDbCommand cmd;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            DbReturnCode rc = DbReturnCode.ExecuteNonQueryFailed; 

            #endregion

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                return DbReturnCode.OpenConnectionFailed;
            }

            if (m_cn.State != ConnectionState.Open)
            {
                return DbReturnCode.OpenConnectionFailed;
            }

            cmd = new OleDbCommand(sSql, m_cn);
            try
            {
                cmd.ExecuteNonQuery();

                rc = DbReturnCode.FinishedOK;
                Audit("SQL[" + sSql + "]", 
                      sMethod, 
                      AuditSeverity.Important);    
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();

                Utils.WriteToEventLog("DVR Client",
                                      "Main - " + sMethod,
                                      "Failed Executing Non Query." + sError,
                                      0,
                                      EventLogEntryType.Error);
                Audit("Failed Executing Non Query. SQL[" + sSql + "]. "+ sError, 
                      sMethod, 
                      AuditSeverity.Error);

                rc = DbReturnCode.ExecuteNonQueryFailed;
            }

            //CloseConnection();

            return rc;
        }        

        public bool PtzPresetRecordExists(string sDvrName,string sCameraNumber,out string sPreset)
        {
            #region Data Members
            
            string sSql;

            OleDbCommand cmd;
            OleDbDataReader dr;

            int iRecords;
            DbReturnCode rc; 

            #endregion

            sPreset = "";
            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                return false;
            }

            sSql = "SELECT COUNT(*) FROM PtzPreset ";
            sSql += "WHERE SiteName='" + sDvrName + "' AND CameraNumber='" + sCameraNumber + "' ";

            cmd = new OleDbCommand(sSql, m_cn);
            try
            {
                iRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string s = e.ToString();

                return false;
            }

            if (iRecords == 0)
            {
                return false;
            }
            else
            {
                sSql = "SELECT Preset FROM PtzPreset ";
                sSql += "WHERE SiteName='" + sDvrName + "' AND CameraNumber='" + sCameraNumber + "' ";

                cmd = new OleDbCommand(sSql, m_cn);
                try
                {
                    dr = cmd.ExecuteReader();
                }
                catch (OleDbException e)
                {
                    string s = e.ToString();

                    return false;
                }

                while (dr.Read())
                {
                    sPreset = dr.GetString(0);
                }

                return true;
            }
        }

        public bool PresetNameExists(int iDvrId, int iCameraNumber, string sPresetName, out int iPresetNumber)
        {
            #region Data Members

            string sSql;

            OleDbCommand cmd;
            OleDbDataReader dr;

            int iRecords;

            DbReturnCode rc;

            #endregion

            iPresetNumber = DvrClientConstants.NONE;

            rc = OpenConnection();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                return false;
            }

            sSql = "SELECT COUNT(*) FROM Presets ";
            sSql += "WHERE DvrId=" + iDvrId + " AND CameraNumber=" + iCameraNumber + " AND PresetName='" + sPresetName + "'";

            cmd = new OleDbCommand(sSql, m_cn);
            try
            {
                iRecords = int.Parse(cmd.ExecuteScalar().ToString());
            }
            catch (OleDbException e)
            {
                string s = e.ToString();

                return false;
            }

            if (iRecords == 0)
            {
                return false;
            }
            else
            {
                sSql = "SELECT * FROM Presets ";
                sSql += "WHERE DvrId=" + iDvrId + " AND CameraNumber=" + iCameraNumber + " AND PresetName='" + sPresetName + "'";

                cmd = new OleDbCommand(sSql, m_cn);
                try
                {
                    dr = cmd.ExecuteReader();
                }
                catch (OleDbException e)
                {
                    string s = e.ToString();

                    return false;
                }

                while (dr.Read())
                {
                    iPresetNumber = (int)(dr["PresetNumber"]);
                }

                return true;
            }
        }

        public bool WritePreDefinedViews2Database(out string sError)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;

            int i;
            int j; 

            #endregion
            
            if (DeletePreDefinedViewsCamerasTableContents() != DbReturnCode.FinishedOK)
            {
                sError = "Failed Deleting 'PreDefinedViewCameras' Table Contents. Can Not Write Predefined Views To Database.";

                return false;
            }

            if (DeletePreDefinedViewsTableContents() != DbReturnCode.FinishedOK)
            {
                sError = "Failed Deleting 'PreDefinedViews' Table Contents. Can Not Write Predefined Views To Database.";

                return false;
            }            

            sError = "";

            if (m_PreDefinedView != null)
            {
                for (i = 0; i < m_PreDefinedView.Count; i++)
                {
                    if (InsertPreDefinedView(m_PreDefinedView[i].Name, 
                                             m_PreDefinedView[i].Layout) != DbReturnCode.FinishedOK)
                    {
                        sError += "Failed Inserting '" + m_PreDefinedView[i].Name + "' Into 'PreDefinedViews' Table. Can Not Write Predefined Views To Database.";
                    }

                    int iPreDefinedViewId = GetViewIndex(m_PreDefinedView[i].Name, ViewType.PredefinedView, out sError);
                    if (iPreDefinedViewId == DvrClientConstants.NONE)
                    {
                        return false;
                    }

                    for (j = 0; j < m_PreDefinedView[i].Camera.Count; j++)
                    {
                        if (InsertPreDefinedViewCamera(iPreDefinedViewId,
                                                       m_PreDefinedView[i].Camera[j].SiteName,
                                                       m_PreDefinedView[i].Camera[j].CameraNumber,
                                                       m_PreDefinedView[i].Camera[j].Display,
                                                       m_PreDefinedView[i].Camera[j].PresetToActivate) != DbReturnCode.FinishedOK)
                        {
                            sError += "Failed Inserting Pre Defined View '" + m_PreDefinedView[i].Name + "' " +
                                      "DVR[" + m_PreDefinedView[i].Camera[j].SiteName + "] " +
                                      "Camera[" + m_PreDefinedView[i].Camera[j].CameraNumber.ToString() + "] " +
                                      "Display[" + m_PreDefinedView[i].Camera[j].Display.ToString() + "] " +
                                      "Into 'PreDefinedViewsCameras' Table.";
                        }

                        DoEvents();
                    }

                    DoEvents();
                }
            }

            GetAllPreDefinedViews();

            return true;
        }

        public void SaveDisplaysToDataBase()
        {
            #region Data Members
            
            int i;

            DbReturnCode dbRc;

            DateTime StartDateTime;
            DateTime EndDateTime; 

            #endregion
            
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                if (DeleteDisplays() != DbReturnCode.FinishedOK)
                {
                    Audit("Failed Deleting 'SaveDisplays' Records", sMethod, AuditSeverity.Warning);

                    return;
                }

                for (i = (m_DisplayInfo.Displays - 1); i >= 0; i--)
                {
                    if (!DisplayManager_DisplayIsFree(i))
                    {
                        switch (DisplayManager_DisplayActivation(i))
                        {
                            case ActivationType.LiveVideo:
                                StartDateTime = DateTime.Now;
                                EndDateTime = DateTime.Now;
                                break;

                            case ActivationType.VideoOnDemand:
                                StartDateTime = DisplayManager_DisplayPlaybackStart(i);
                                EndDateTime = Utils.DateAdd(DisplayManager_DisplayPlaybackDuration(i),
                                                            DisplayManager_DisplayPlaybackStart(i));
                                break;

                            default:
                                continue;
                        }

                        dbRc = InsertDisplayRecord(DisplayManager_DisplaySiteName(i),
                                                   DisplayManager_DisplayCameraNumber(i).ToString(),
                                                   (i + 1).ToString(),
                                                   DisplayManager_DisplayActivation(i).ToString(),
                                                   StartDateTime,
                                                   EndDateTime);

                        if (dbRc != DbReturnCode.FinishedOK)
                        {
                            string sError = dbRc.ToString();
                        }
                    }

                    DoEvents();
                }
            }
            catch (Exception e)
            {
                string sError = e.Message;

                Audit(sError, sMethod, AuditSeverity.Error);
            }
        }

        public void RestoreDisplaysFromDataBase()
        {
            #region Data Members
            
            int i;
            int lDuration;
            int iDisplayNumber;
            int iCameraNumber;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;
            string sNumber = ""; 

            #endregion

            try
            {
                if (!GetSavedDisplays(out sResult))
                {
                    Audit("Could Not Get Saved Displays. " + sResult, sMethod, AuditSeverity.Warning);

                    return;
                }
                else
                {
                    Audit("Got Saved Displays From Database. " + sResult, sMethod, AuditSeverity.Information);
                }

                if (m_SavedDisplays == null)
                {
                    Audit("Saved Displays Structure Is Null. " + sResult, sMethod, AuditSeverity.Warning);

                    return;
                }
                else 
                {
                    Audit(m_SavedDisplays.Count + " Displays Retreived From Database.", sMethod, AuditSeverity.Information);
                }

                for (i = 0; i < m_SavedDisplays.Count; i++)
                {
                    try
                    {
                        sNumber = m_SavedDisplays[i].CameraNumber;
                        iCameraNumber = int.Parse(sNumber);

                        sNumber = m_SavedDisplays[i].DisplayNumber;
                        iDisplayNumber = int.Parse(sNumber);
                    }
                    catch (Exception e)
                    {
                        Audit("Failed Parsing '" + sNumber + "'. " + e.Message, sMethod, AuditSeverity.Warning);

                        continue;
                    }

                    switch (m_SavedDisplays[i].ActivationType)
                    {
                        case "LiveVideo":
                            //StartCamera_X_on_Display_Y(m_SavedDisplays[i].SiteName,
                            //                           iCameraNumber,
                            //                           iDisplayNumber,
                            //                           DvrClientConstants.NONE,
                            //                           "",
                            //                           false);
                            break;

                        case "VideoOnDemand":
                            lDuration = Utils.DateDiff(m_SavedDisplays[i].StartDateTime,
                                                       m_SavedDisplays[i].EndDateTime);
                            //StartPlayback_on_Display_Y(m_SavedDisplays[i].SiteName,
                            //                           iCameraNumber,
                            //                           DvrClientConstants.NONE,
                            //                           m_SavedDisplays[i].StartDateTime,
                            //                           iDisplayNumber,
                            //                           lDuration,
                            //                           0,
                            //                           0,
                            //                           "",
                            //                           false,
                            //                           Utils.InitialDefaultTime(),
                            //                           "");
                            break;

                        default:
                            continue;
                    }
                }

                CustomizeDisplays(sMethod);
                NoVideoPictureOnEmptyDisplays();
            }
            catch (Exception e)
            {
                Audit("Failed Restoring Saved Displays. " + e.Message, sMethod, AuditSeverity.Error); ;
            }
        }

        public bool SaveDataScopeItemsToDatabase(List<string> lDataScopeItem)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            DbReturnCode dbRc;

            try
            {
                if (lDataScopeItem == null)
                {
                    Audit("Can't Save Data Scope Items. List Is NULL", sMethod, AuditSeverity.Warning);

                    return false;
                }

                if (lDataScopeItem.Count == 0)
                {
                    Audit("No Data Scope Items To Save.", sMethod, AuditSeverity.Warning);

                    return false;
                }

                dbRc = DeleteDataScopeItems();
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    Audit("Could Not Delete Data Scope Items Table Content", sMethod, AuditSeverity.Warning);

                    return false;
                }

                for (int i = 0; i < lDataScopeItem.Count; i++)
                {
                    dbRc = InsertDataScopeItemRecord(lDataScopeItem[i]);
                    if (dbRc == DbReturnCode.FinishedOK)
                    {
                        Audit("Saved Data Scope Item[" + lDataScopeItem[i] + "].",
                              sMethod,
                              AuditSeverity.Information);
                    }
                    else
                    {
                        Audit("Failed Saving Data Scope Item[" + lDataScopeItem[i] + "]. " + dbRc.ToString(),
                              sMethod,
                              AuditSeverity.Warning);
                    }
                }

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }
        
        #endregion

        #region Pulse Database

        private DbReturnCode OpenConnectionToPulseDatabase()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sProvider;
            string sDataSource;
            string sFullFileName;

            DatabaseProvider databaseProvider;

            try
            {
                if ((m_PulseDatabaseConnection != null) && (m_PulseDatabaseConnection.State == ConnectionState.Open))
                {
                    return DbReturnCode.FinishedOK;
                }                

                m_PulseDatabaseConnection = new OleDbConnection();

                if (!string.IsNullOrEmpty(m_Settings.PulseDatabaseConnectionString))
                {
                    GetConnectionStringProperties(m_Settings.PulseDatabaseConnectionString,
                                                  out sProvider,
                                                  out sDataSource,
                                                  out sFullFileName,
                                                  out databaseProvider);
                }
                else
                {
                    return DbReturnCode.OpenConnectionFailed;
                }

                m_PulseDatabaseConnection.ConnectionString = m_Settings.PulseDatabaseConnectionString;


                if (m_PulseDatabaseConnection.State == ConnectionState.Closed)
                {
                    try
                    {
                        m_PulseDatabaseConnection.Open();

                        AuditPerform(sFullFileName + " Opened", sMethod);

                        return DbReturnCode.FinishedOK;
                    }
                    catch (OleDbException e)
                    {
                        string s = e.ToString();

                        return DbReturnCode.OpenConnectionFailed;
                    }
                }
                else
                {
                    AuditPerform(sFullFileName + " Open", sMethod);

                    return DbReturnCode.ConnectionStateOpen;
                }
            }
            catch (Exception e)
            {
                string sError = e.Message;
                AuditPerform(sError, sMethod);

                return DbReturnCode.OpenConnectionFailed;
            }
        }

        private DbReturnCode CloseConnectionToPulseDatabase()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (m_PulseDatabaseConnection != null)
            {
                m_PulseDatabaseConnection.Close();
                Utils.WriteToDebugView(DvrClientModule.Main,
                                       sMethod,
                                       "Connection To Pulse Database Closed",
                                       AuditSeverity.Important);
            }
            else
            {
                Utils.WriteToDebugView(DvrClientModule.Main,
                                       sMethod,
                                       "No Connection To Pulse Database To Close",
                                       AuditSeverity.Warning);
            }

            return DbReturnCode.FinishedOK;
        }

        private DbReturnCode ExecutePulseDatabaseNonQuery(string sSql)
        {
            OleDbCommand cmd;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            DbReturnCode rc = DbReturnCode.ExecuteNonQueryFailed;

            rc = OpenConnectionToPulseDatabase();
            if (!(rc == DbReturnCode.FinishedOK))
            {
                return DbReturnCode.OpenConnectionFailed;
            }

            if (m_PulseDatabaseConnection.State != ConnectionState.Open)
            {
                return DbReturnCode.OpenConnectionFailed;
            }

            cmd = new OleDbCommand(sSql, m_PulseDatabaseConnection);
            try
            {
                cmd.ExecuteNonQuery();

                rc = DbReturnCode.FinishedOK;
                Audit("SQL[" + sSql + "]", sMethod, AuditSeverity.Information);
            }
            catch (OleDbException e)
            {
                string sError = e.ToString();

                Utils.WriteToEventLog("DVR Client",
                                      "Main - " + sMethod,
                                      "Failed Executing Non Query." + sError,
                                      0,
                                      EventLogEntryType.Error);
                Audit("Failed Executing Non Query. SQL[" + sSql + "]. " + sError, sMethod, AuditSeverity.Warning);

                rc = DbReturnCode.ExecuteNonQueryFailed;
            }

            //CloseConnectionToPulseDatabase();

            return rc;
        }

        private List<string> GetAlarmListOfCommands(string sAlarmNumber, out string sError)
        {
            #region Data Members
            
            int iAlarmNumber;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            OleDbCommand cmd;
            OleDbDataReader dr;
            DbReturnCode dbRc;

            List<string> lCommands = new List<string>(); 

            #endregion

            sError = "";

            try
            {
                if (sAlarmNumber.IndexOf(".") != DvrClientConstants.NONE)
                {
                    sAlarmNumber = sAlarmNumber.Substring(0, sAlarmNumber.IndexOf("."));
                }

                try
                {
                    iAlarmNumber = int.Parse(sAlarmNumber);
                }
                catch (Exception)
                {
                    sError = "Alarm Number[" + sAlarmNumber +
                             "] Not Numeric. Can't Activate Alarm List Of Commands.";
                    Audit(sError, sMethod, AuditSeverity.Error);

                    return null;
                }

                dbRc = OpenConnectionToPulseDatabase();
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    sError = "Can't Open Connection To Pulse Database. Connection String[" +
                             m_Settings.PulseDatabaseConnectionString + "]";
                    Audit(sError, sMethod, AuditSeverity.Error);
                    Utils.Error(sError);

                    return null;
                }

                cmd = new OleDbCommand("SELECT * FROM EM_ALARM_CAMERAS WHERE ALARM_ID=" + sAlarmNumber + " ",
                                       m_PulseDatabaseConnection);
                try
                {
                    dr = cmd.ExecuteReader();
                }
                catch (OleDbException e)
                {
                    sError = e.Message;
                    Audit(sError, sMethod, AuditSeverity.Error);

                    return null;
                }

                while (dr.Read())
                {
                    int iAlarmId = dr.GetInt32(1);
                    string sCommands = dr.GetString(2);

                    lCommands.Add(sCommands);
                }

                dr.Close();
                //CloseConnectionToPulseDatabase();

                return lCommands;
            }
            catch (Exception e)
            {
                sError = "Can't Get Alarm List Of Commands For Alarm[" + sAlarmNumber + "]. " + e.Message;
                Audit(sError, sMethod, AuditSeverity.Error);

                return null;
            }
        }

        private string GetAlarmBlockDescription(string sAlarmNumber, out string sError)
        {
            #region Data Members
            
            int iAlarmNumber;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sReply = "";
            string sSql;

            OleDbCommand cmd;
            OleDbDataReader dr;
            DbReturnCode dbRc; 

            #endregion

            sError = "";

            try
            {
                try
                {
                    iAlarmNumber = int.Parse(sAlarmNumber);
                }
                catch (Exception)
                {
                    sError = "Alarm Number[" + sAlarmNumber +
                             "] Not Numeric. Can't Activate Alarm List Of Commands.";
                    Audit(sError, sMethod, AuditSeverity.Error);

                    return "";
                }

                dbRc = OpenConnectionToPulseDatabase();
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    sError = "Can't Open Connection To Pulse Database. Connection String[" +
                             m_Settings.PulseDatabaseConnectionString + "]";
                    Audit(sError, sMethod, AuditSeverity.Error);

                    return "";
                }

                sSql = "SELECT dblist.description FROM dblist INNER JOIN Alarmconditions";
                sSql += " ON Alarmconditions.block_index=dblist.block_index";
                sSql += " WHERE Alarmconditions.alarm_id=" + sAlarmNumber + " ";
                cmd = new OleDbCommand(sSql, m_PulseDatabaseConnection);
                try
                {
                    dr = cmd.ExecuteReader();
                }
                catch (OleDbException e)
                {
                    sError = e.Message;
                    Audit(sError, sMethod, AuditSeverity.Error);

                    return "";
                }

                while (dr.Read())
                {
                    sReply = dr.GetString(0);
                }

                dr.Close();

                return sReply;
            }
            catch (Exception e)
            {
                sError = "Can't Get Alarm Block Description For Alarm[" + sAlarmNumber + "]. " + e.Message;
                Audit(sError, sMethod, AuditSeverity.Error);

                return null;
            }
        }

        private DateTime GetAlarmBlockStartTime(string sAlarmNumber, out string sError)
        {
            #region Data Members
            
            int iAlarmNumber;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sSql;

            DateTime dtReply = new DateTime(1900, 1, 1, 0, 0, 0);

            OleDbCommand cmd;
            OleDbDataReader dr;

            DbReturnCode dbRc; 

            #endregion

            sError = "";

            try
            {
                try
                {
                    iAlarmNumber = int.Parse(sAlarmNumber);
                }
                catch (Exception)
                {
                    sError = "Alarm Number[" + sAlarmNumber +
                             "] Not Numeric. Can't Activate Alarm List Of Commands.";
                    Audit(sError, sMethod, AuditSeverity.Error);

                    return dtReply;
                }

                dbRc = OpenConnectionToPulseDatabase();
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    sError = "Can't Open Connection To Pulse Database. Connection String[" +
                             m_Settings.PulseDatabaseConnectionString + "]";
                    Audit(sError, sMethod, AuditSeverity.Error);

                    return dtReply;
                }

                sSql = "SELECT START_TIME FROM AlarmCur ";
                sSql += " WHERE ALARM_ID=" + sAlarmNumber + " ";
                cmd = new OleDbCommand(sSql, m_PulseDatabaseConnection);
                try
                {
                    dr = cmd.ExecuteReader();
                }
                catch (OleDbException e)
                {
                    sError = e.Message;
                    Audit(sError, sMethod, AuditSeverity.Error);

                    return dtReply;
                }

                while (dr.Read())
                {
                    dtReply = dr.GetDateTime(0);
                }

                dr.Close();
                //CloseConnectionToPulseDatabase();

                return dtReply;
            }
            catch (Exception e)
            {
                sError = "Can't Get Alarm Block Start Time For Alarm[" + sAlarmNumber + "]. " + e.Message;
                Audit(sError, sMethod, AuditSeverity.Error);

                return dtReply;
            }
        }

        private bool EventManagerAlarmTableExists(out string sError)
        {
            #region Data Members
            
            int iRecords;

            string sMethod = MethodBase.GetCurrentMethod().Name;

            OleDbCommand cmd;
            DbReturnCode dbRc; 

            #endregion

            sError = "";

            try
            {                
                dbRc = OpenConnectionToPulseDatabase();
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    sError = "Can't Open Connection To Pulse Database. Connection String[" +
                             m_Settings.PulseDatabaseConnectionString + "]";
                    Audit(sError, sMethod, AuditSeverity.Error);

                    return false;
                }

                cmd = new OleDbCommand("SELECT COUNT(*) FROM EM_ALARM_CAMERAS ",
                                       m_PulseDatabaseConnection);               
                try
                {
                    iRecords = int.Parse(cmd.ExecuteScalar().ToString());
                }
                catch (OleDbException e)
                {
                    sError = e.Message + " Error Code(" + e.ErrorCode.ToString("X8") + "). ";
                    sError = "Could Not Get Number Of 'EM_ALARM_CAMERAS' Records. " + sError;

                    return false;
                }

                //CloseConnectionToPulseDatabase();

                sError = iRecords + " In 'EM_ALARM_CAMERAS'";
                return true;
            }
            catch (Exception e)
            {
                sError = "Can't Get Number Of Alarm Block Records. " + e.Message;
                Audit(sError, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        public bool GetAllPulseDatabaseAlarmCommands(out string sError)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sSql;
            string sCommand;

            int iEventIndex;
            int iAlarmId;
            int iRecords;
            int iPulseDatabaseCommands;

            decimal decEventIndex;

            OleDbCommand cmdEventLog;
            OleDbCommand cmdAlarmCamera;
            OleDbDataReader drEventLog;
            OleDbDataReader drAlarmCamera;
            DbReturnCode dbRc;

            DateTime dtStartTime; 

            #endregion

            sError = "";

            try
            {
                dbRc = OpenConnectionToPulseDatabase();
                if (dbRc != DbReturnCode.FinishedOK)
                {
                    sError = "Can't Open Connection To Pulse Database. Connection String[" +
                             m_Settings.PulseDatabaseConnectionString + "]";
                    Audit(sError, sMethod, AuditSeverity.Error);
                    Utils.Error(sError);

                    return false;
                }

                m_PulseAlarm = new List<PulseAlarm>();

                sSql = Create_EM_EVENTLOG_Sql(true);
                cmdEventLog = new OleDbCommand(sSql, m_PulseDatabaseConnection);
                try
                {
                    iRecords = int.Parse(cmdEventLog.ExecuteScalar().ToString());
                }
                catch (OleDbException e)
                {
                    sError = "Could Not Get Number Of 'EM_EVENTLOG' Records. " + e.Message;

                    return false;
                }

                if (iRecords < 1)
                {
                    return true;
                }

                Audit(iRecords + " Matching Events", sMethod, AuditSeverity.Information);

                sSql = Create_EM_EVENTLOG_Sql(false);
                cmdEventLog = new OleDbCommand(sSql, m_PulseDatabaseConnection);
                try
                {
                    drEventLog = cmdEventLog.ExecuteReader();
                }
                catch (OleDbException e)
                {
                    sError = e.Message;
                    Audit(sError, sMethod, AuditSeverity.Error);

                    return false;
                }

                while (drEventLog.Read() && ((iRecords--) > 0))
                {
                    decEventIndex = drEventLog.GetDecimal(0);
                    iEventIndex = (int)decEventIndex;
                    iAlarmId = drEventLog.GetInt32(1);
                    dtStartTime = drEventLog.GetDateTime(2);

                    sSql = "SELECT COUNT(*) FROM EM_ALARM_CAMERAS WHERE ALARM_ID=" + iAlarmId + " ";
                    cmdAlarmCamera = new OleDbCommand(sSql, m_PulseDatabaseConnection);
                    try
                    {
                        iPulseDatabaseCommands = int.Parse(cmdAlarmCamera.ExecuteScalar().ToString());
                    }
                    catch (OleDbException e)
                    {
                        sError = "Could Not Get Number Of 'EM_ALARM_CAMERAS' Where ALARM_ID=" + iAlarmId + " " + e.ToString();

                        return false;
                    }

                    //Audit(iPulseDatabaseCommands + " Commands For Event Index[" + iEventIndex + "]", sMethod, AuditSeverity.Information);

                    if (iPulseDatabaseCommands > 0)
                    {                        
                        sSql = "SELECT * FROM EM_ALARM_CAMERAS WHERE ALARM_ID=" + iAlarmId + " ";
                        cmdAlarmCamera = new OleDbCommand(sSql, m_PulseDatabaseConnection);
                        try
                        {
                            drAlarmCamera = cmdAlarmCamera.ExecuteReader();
                        }
                        catch (OleDbException e)
                        {
                            sError = e.Message;
                            Audit(sError, sMethod, AuditSeverity.Error);

                            return false;
                        }

                        while (drAlarmCamera.Read() && ((iPulseDatabaseCommands--) > 0))
                        {
                            sCommand = drAlarmCamera.GetString(2);

                            if (!AddPulseDatabaseAlarmCommand(iEventIndex, 
                                                              dtStartTime, 
                                                              iAlarmId, 
                                                              sCommand, 
                                                              out sError))
                            {
                                Audit("Error Adding Pulse Database Command '" + sCommand + 
                                      "' Alarm ID[" + iAlarmId + 
                                      "] Event Index[" + iEventIndex + "]. " + sError, 
                                      sMethod,
                                      AuditSeverity.Error);
                            }

                            DoEvents();
                        }
                    }

                    DoEvents();
                }

                drEventLog.Close();
                //CloseConnectionToPulseDatabase();

                return true;
            }
            catch (Exception e)
            {
                sError = "Can't Get Alarm List Of Pulse Database Alarm Commands. " + e.Message;
                Audit(sError, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        private bool AddPulseDatabaseAlarmCommand(int iEventIndex, 
                                                  DateTime dtStartTime, 
                                                  int iAlarmId, 
                                                  string sCommand,
                                                  out string sError)
        {
            #region Data Members
            
            PulseAlarm currentPulseAlarm;
            PulseDatabaseAlarmCommand currentPulseDatabaseAlarmCommand;

            string sBlockDescription;
            string sVendor;
            string sDvrId;
            string sDvr;
            string sCameraNumber;
            string sDisplayNumber;
            string sCameraName;
            string sPreset;

            int iDvrId;
            int iCameraNumber = DvrClientConstants.NONE;
            int iChannelId;
            int iDisplayNumber = DvrClientConstants.NONE;

            PulseCommandAction pacPulseCommandAction; 

            #endregion

            if (m_PulseAlarm == null)
            {
                sError = "Pulse Alarm List Is Null";

                return false;
            }

            if (!Utils.NukePulseDatabaseAlarmCommand(sCommand,
                                                     out sVendor,
                                                     out sDvrId,
                                                     out sCameraNumber,
                                                     out pacPulseCommandAction,
                                                     out sPreset))
            {
                sError = "Failed Nuking The Pulse Alarm Command.";

                return false;
            }

            try
            {
                iDvrId = int.Parse(sDvrId);
            }
            catch (Exception)
            {
                sError = "Dvr Id '" + sDvrId + "' Is Not Numeric ";

                return false;
            }

            sDvr = GetDvrName(iDvrId);
            if (string.IsNullOrEmpty(sDvr))
            {
                sError = "Dvr Name Is Null Or Empty ";

                return false;
            }

            try
            {
                int iNumberOfAts = Utils.GetNumberOfOccurences(sCameraNumber, "@");

                if (iNumberOfAts == 0)
                {
                    iCameraNumber = int.Parse(sCameraNumber);
                    iDisplayNumber = DvrClientConstants.NONE;
                }

                if (iNumberOfAts == 1)
                {
                    sDisplayNumber = Utils.GetNthSubString(sCameraNumber, "@", 2);
                    sCameraNumber = Utils.GetNthSubString(sCameraNumber, "@", 1);                    

                    iCameraNumber = int.Parse(sCameraNumber);
                    iDisplayNumber = int.Parse(sDisplayNumber);
                }

                if (iNumberOfAts > 1)
                {
                    sError = "Camera Number '" + sCameraNumber + "' Is Problematic ";

                    return false;
                }
                
            }
            catch (Exception)
            {
                sError = "Camera Number '" + sCameraNumber + "' Is Not Numeric ";

                return false;
            }

            iChannelId = GetChannelID(iDvrId, iCameraNumber);
            if (iChannelId == DvrClientConstants.NONE)
            {
                sError = "Could Not Find Channel Number For Dvr[" + sDvr + "] Camera[" + iCameraNumber + "]";

                return false;
            }

            sCameraName = GetCameraNameByCameraNumber(sDvr, iCameraNumber);
            if (string.IsNullOrEmpty(sCameraName))
            {
                sError = "Camera Name Is Null Or Empty ";

                return false;
            }

            currentPulseDatabaseAlarmCommand = new PulseDatabaseAlarmCommand(pacPulseCommandAction,
                                                                             sVendor,
                                                                             sDvr,
                                                                             iDvrId,
                                                                             sCommand,
                                                                             iCameraNumber,
                                                                             iChannelId,
                                                                             iDisplayNumber,
                                                                             sCameraName,
                                                                             sPreset);

            for (int i = 0; i < m_PulseAlarm.Count; i++)
            {
                if (m_PulseAlarm[i].EventIndex == iEventIndex)
                {
                    m_PulseAlarm[i].AddPulseAlarmCommand(currentPulseDatabaseAlarmCommand);

                    sError = "";

                    return true;
                }

                DoEvents();
            }

            sBlockDescription = GetAlarmBlockDescription(iAlarmId.ToString(), out sError);
            
            currentPulseAlarm = new PulseAlarm(iEventIndex, iAlarmId, sBlockDescription, dtStartTime);
            currentPulseAlarm.AddPulseAlarmCommand(currentPulseDatabaseAlarmCommand);
            m_PulseAlarm.Add(currentPulseAlarm);

            return true;
        }

        private string Create_EM_EVENTLOG_Sql(bool bCount)
        {
            #region Data Members

            bool bUseOldestEventRecordDate = m_Settings.UseOldestEventRecordDate;

            string sWhat = (bCount) ? "COUNT(*)" : "EM_EVENT_INDEX,ALARM_ID,START_TIME";
            string sSql;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            DateTime dtStartTime = new DateTime(); 

            #endregion


            if (m_Settings.OldestEventRecordDate == DateTime.MinValue)
            {
                bUseOldestEventRecordDate = false;

                Audit("Oldest Event Record Date Is Not Set. Option Is Discarded In The SQL Query", 
                      sMethod, 
                      AuditSeverity.Important);
            }
            else
            {
                dtStartTime = m_Settings.OldestEventRecordDate.ToUniversalTime();
            }

            sSql = "SELECT ";
            if ((m_Settings.UseNumberOfEventRecords) && !bCount)
            {
                Audit("Get Top [" + m_Settings.NumberOfEventRecords + "] Records", sMethod, AuditSeverity.Information);
                sSql += "TOP " + m_Settings.NumberOfEventRecords + " ";
            }
            sSql += sWhat + " FROM EM_EVENTLOG ";
            sSql += "WHERE EVENT_STATE=3 ";

            if (bUseOldestEventRecordDate)
            {
                Audit("Get Records Newer Than [" + dtStartTime + "]" ,
                      sMethod, 
                      AuditSeverity.Information);
                sSql += "AND START_TIME>'" + dtStartTime.ToString("yyyy-MM-dd HH:mm:ss") + "' ";
            }

            if (!bCount && !bUseOldestEventRecordDate && !m_Settings.UseNumberOfEventRecords)
            {
                sSql = sSql.Replace("SELECT", "SELECT TOP 100");
            }

            if (!bCount)
            {
                sSql += "ORDER BY START_TIME DESC";
            }

            Audit("[" + sSql + "]", sMethod, AuditSeverity.Information);

            return sSql;
        }

        #endregion        

        #region On Event Methods

        public void OnBubbleClick()
        {
            if (BubbleClick != null)
            {
                BubbleClick(this, null);
            }
        }

        public void OnFullScreenChanged()
        {
            if (FullScreenChanged != null)
            {
                FullScreenChanged(this, null);
            }
        }

        public void OnBackToNormalScreen()
        {
            if (BackToNormalScreen != null)
            {
                BackToNormalScreen(this, null);
            }
        }

        public void OnCameraSelected()
        {
            if (CameraSelected != null)
            {
                CameraSelectedEventArgs msea = new CameraSelectedEventArgs();
                msea.DvrType = m_sDvrType;
                msea.Dvr = m_sDvr;
                msea.Channel = m_sCameraNumber;

                CameraSelected(this, msea);
            }
        }

        public void OnKillApplication()
        {
            if (KillApplication != null)
            {
                KillApplication(this, null);
            }
        }

        public void OnRestartApplication()
        {
            if (RestartApplication != null)
            {
                RestartApplication(this, null);
            }
        }

        public void OnSaveSettings(EventArgs e)
        {
            if (SaveSettings != null)
            {
                SaveSettings(this, e);
            }
        }

        public void OnOnTopEvent(EventArgs e)
        {
            if (OnTopEvent != null)
            {
                OnTopEvent(this, e);
            }
        }

        public void DoSaveSettings(SavedSettings savedSettings)
        {
            OnSaveSettings(savedSettings);
        } 

        #endregion

        #region GUI Messages Functions

        private void DisplayDescription(string sMessage)
        {
            lblCamera.Text = sMessage;
        }

        private void EventMessage(string sMessage)
        {
            int iWidth = 20;

            lblEventMessage.Text = sMessage;

            switch (m_Settings.Language)
            {
                case Language.English:
                    lblErrorMessage.Left = tv.Width + iWidth;
                    break;

                case Language.Hebrew:
                    lblErrorMessage.Left = Width - tv.Width - iWidth - iWidth - lblErrorMessage.Width;
                    break;

                default:
                    break;
            }
        }

        private void NiceVideoDisplayFreeText(int iDisplayIndex, string sText)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            
            //PCompStatus pcStatus;

            float x = (float)NiceVideoDisplayFreeTextX / 100;
            float y = (float)NiceVideoDisplayFreeTextY / 100;
            

            int iFreeTexthandle = DisplayManager_DisplayFreeTextHandle(iDisplayIndex);

            if (iFreeTexthandle != -1)
            {
                //pcStatus = m_OSD[iDisplayIndex].DeleteOSDFreeText(iFreeTexthandle);
                //if (pcStatus != PCompStatus.PCompStatus_Ok)
                //{
                //    Audit("Failed Deleting Free Text. Error: " + Utils.StatusString(pcStatus.ToString()),
                //          sMethod,
                //          AuditSeverity.Warning);

                //    return;
                //}
            }

            //pcStatus = m_OSD[iDisplayIndex].AddOSDFreeText(sText, x, y, out iFreeTexthandle);
            //if (pcStatus != PCompStatus.PCompStatus_Ok)
            //{
            //    Audit("Failed Adding Free Text. Error: " + Utils.StatusString(pcStatus.ToString()), 
            //          sMethod, 
            //          AuditSeverity.Warning);

            //    return;
            //}

            Audit("Added Free Text[" + sText + 
                  "] To Camera[" + DisplayManager_DisplayCameraNumber(iDisplayIndex) +
                  " - " + DisplayManager_DisplayCameraName(iDisplayIndex) +
                  "] On Dvr[" + DisplayManager_DisplaySiteName(iDisplayIndex) + "]", 
                  sMethod, 
                  AuditSeverity.Information);

            DisplayManager_SetDisplayFreeTextHandle(iDisplayIndex, iFreeTexthandle);            
        }

        #endregion

        #region Conectivity

        public bool DvrExists(int iDvrId)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                //int i;
                //int iLoggersListLength;                

                //if (m_Source.Logger == null)
                //{
                //    AuditPerform("Loggers List Is Empty", sMethod);

                //    return false;
                //}

                //iLoggersListLength = m_Source.Logger.Length;

                //for (i = 0; i < iLoggersListLength; i++)
                //{
                //    if (m_Source.Logger[i].ID == iDvr)
                //    {
                //        return true;
                //    }
                //}

                //return false;

                int i;
                int iDvrsListLength;

                if (m_DvrRecord == null)
                {
                    AuditPerform("Dvrs List Is Empty. No Dvr Records Present.", 
                                 sMethod, 
                                 AuditSeverity.Warning);

                    return false;
                }

                iDvrsListLength = m_DvrRecord.Count;

                for (i = 0; i < iDvrsListLength; i++)
                {
                    if (m_DvrRecord[i].DvrId == iDvrId)
                    {
                        return true;
                    }
                }

                return false;
            }
            catch (Exception e)
            {
                AuditPerform("Can't Answer Whether DVR[" + 
                             iDvrId.ToString() + 
                             "] Exists." + e.Message, 
                             sMethod);

                return false;
            }
        }

        #region NukeLoggersConectivity(string sLine)
        //private void NukeLoggersConectivity(string sLine)
        //{
        //    int i;
        //    int j;
        //    int iLoggers;
        //    int iFoundIndex;

        //    int iID;
        //    bool bConectivity;
        //    bool bFoundIndex;

        //    string sID;
        //    string sConectivity;

        //    int iIdPosition;
        //    int iColonPosition;

        //    string sNext;
        //    string sMethod = MethodBase.GetCurrentMethod().Name;

        //    iLoggers = Utils.GetNumberOfOccurences(sLine, ":");

        //    sNext = sLine;

        //    for (i = 0; i < iLoggers; i++)
        //    {
        //        iIdPosition = sNext.IndexOf("[ID]");
        //        iColonPosition = sNext.IndexOf(":");

        //        sID = sNext.Substring(iIdPosition + 4, iColonPosition - (iIdPosition + 4));
        //        iID = int.Parse(sID);

        //        sConectivity = sNext.Substring(iColonPosition + 1, 1);
        //        if (sConectivity == "T")
        //        {
        //            bConectivity = true;
        //        }
        //        else
        //        {
        //            bConectivity = false;
        //        }

        //        sNext = sNext.Substring(iColonPosition + 2);

        //        bFoundIndex = false;
        //        iFoundIndex = DvrClientConstants.NONE;
        //        for (j = 0; j < m_LoggerConectivity.Count; j++)
        //        {
        //            if (m_LoggerConectivity[j].ID == iID)
        //            {
        //                bFoundIndex = true;
        //                iFoundIndex = j;
        //                j = m_LoggerConectivity.Count;
        //            }
        //        }

        //        if (bFoundIndex == true)
        //        {
        //            if (m_LoggerConectivity[iFoundIndex].Connected != bConectivity)
        //            {
        //                Audit("Changing Logger ID[" + 
        //                      iID.ToString() + 
        //                      "] Connectivity State From " + 
        //                      m_LoggerConectivity[iFoundIndex].Connected.ToString() + 
        //                      " To " + 
        //                      bConectivity.ToString(),
        //                      sMethod);
        //            }

        //            m_LoggerConectivity[iFoundIndex].SetConnectivity(bConectivity);
        //        }
        //        else
        //        {
        //            Types.LoggerConectivity newLoggerConectivity = new Types.LoggerConectivity(iID, bConectivity);
        //            m_LoggerConectivity.Add(newLoggerConectivity);
        //        }
        //    }
        //} 
        #endregion

        public bool IsDvrConnected(int iDvrId)
        {
            int i;
            Vendor vVendor;

            if (m_Settings.PromiscuousModeOn)
            {
                return true;
            }

            vVendor = GetVendorByDvrId(iDvrId);
            switch (vVendor)
            {
                case Vendor.Nice:
                    if (m_LoggerConectivity == null)
                    {
                        return false;
                    }

                    for (i = 0; i < m_LoggerConectivity.Count; i++)
                    {
                        if (m_LoggerConectivity[i].ID == iDvrId)
                        {
                            return m_LoggerConectivity[i].Connected;
                        }
                    }

                    return false;


                default:
                    return false;
            }
        }               

        #endregion

        #region Serial Stuff

        private void m_SerialPort_DataReceived(object sender, SerialDataReceivedEventArgs e)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sMessage;

            Direction ptzDirection;

            Problem problem; 

            #endregion

            try
            {
                sMessage = m_SerialPort.ReadExisting();

                m_sSerialPortBuffer += sMessage;
                string sLastCharacter = m_sSerialPortBuffer.Substring(m_sSerialPortBuffer.Length - 1);
                if (sLastCharacter == "a")
                {
                    ptzDirection = Utils.GetPtzAction(m_sSerialPortBuffer, out problem);
                    AuditPerform("Direction[" + ptzDirection.ToString() + "] Pelco Protocol[" + m_sSerialPortBuffer + "]",
                                 sMethod,
                                 AuditSeverity.Information);
                    m_sSerialPortBuffer = "";

                    if ((ptzDirection == Direction.Nothing) && (problem == Problem.KbdShiftPressed))
                    {
                        MessageBox.Show("Shift Button Is Pressed Down. Release It To Work With The Joystick",
                                        "Pelco KBD Warning",
                                        MessageBoxButtons.OK,
                                        MessageBoxIcon.Exclamation);

                        return;
                    }

                    if (DisplayManager_GetActiveDisplayIndex() != DvrClientConstants.NONE)
                    {
                        AuditPerform("Joystick PTZ Action [" + ptzDirection.ToString() +
                                     "] On Display[" + (DisplayManager_GetActiveDisplayIndex() + 1) + "]",
                                     sMethod,
                                     AuditSeverity.Information);

                        if (DisplayManager_DisplayIsPtz(DisplayManager_GetActiveDisplayIndex()))
                        {
                            switch (ptzDirection)
                            {
                                case Direction.Up:
                                    Perform(MainFormFunction.Ptz,
                                            ((int)(Common.Direction.Up)).ToString() + ":" + m_Settings.TiltSpeed + ":[]",
                                            sMethod,
                                            DvrClientModule.Main);
                                    break;

                                case Direction.Down:
                                    Perform(MainFormFunction.Ptz,
                                            ((int)(Common.Direction.Down)).ToString() + ":" + m_Settings.TiltSpeed + ":[]",
                                            sMethod,
                                            DvrClientModule.Main);
                                    break;

                                case Direction.Left:
                                    Perform(MainFormFunction.Ptz,
                                            ((int)(Common.Direction.Left)).ToString() + ":" + m_Settings.PanSpeed + ":[]",
                                            sMethod,
                                            DvrClientModule.Main);
                                    break;

                                case Direction.Right:
                                    Perform(MainFormFunction.Ptz,
                                            ((int)(Common.Direction.Right)).ToString() + ":" + m_Settings.PanSpeed + ":[]",
                                            sMethod,
                                            DvrClientModule.Main);
                                    break;

                                case Direction.DownLeft:
                                    //Perform(MainFormFunction.Ptz,
                                    //        ((int)(PComp_PTZMoveDirection.PTZMove_LeftDown)).ToString() + ":" + Math.Max(m_Settings.PanSpeed, m_Settings.TiltSpeed) + ":[]",
                                    //        sMethod,
                                    //        DvrClientModule.Main);
                                    break;

                                case Direction.DownRight:
                                    //Perform(MainFormFunction.Ptz,
                                    //        ((int)(PComp_PTZMoveDirection.PTZMove_RightDown)).ToString() + ":" + Math.Max(m_Settings.PanSpeed, m_Settings.TiltSpeed) + ":[]",
                                    //        sMethod,
                                    //        DvrClientModule.Main);
                                    break;

                                case Direction.UpLeft:
                                    //Perform(MainFormFunction.Ptz,
                                    //        ((int)(PComp_PTZMoveDirection.PTZMove_LeftUp)).ToString() + ":" + Math.Max(m_Settings.PanSpeed, m_Settings.TiltSpeed) + ":[]",
                                    //        sMethod,
                                    //        DvrClientModule.Main);
                                    break;

                                case Direction.UpRight:
                                    //Perform(MainFormFunction.Ptz,
                                    //        ((int)(PComp_PTZMoveDirection.PTZMove_RightUp)).ToString() + ":" + Math.Max(m_Settings.PanSpeed, m_Settings.TiltSpeed) + ":[]",
                                    //        sMethod,
                                    //        DvrClientModule.Main);
                                    break;

                                case Direction.ZoomIn:
                                    Perform(MainFormFunction.Zoom,
                                            ((int)(Common.Direction.ZoomIn)).ToString() + ":" + m_Settings.ZoomInSpeed + ":[]",
                                            sMethod,
                                            DvrClientModule.Main);
                                    break;

                                case Direction.ZoomOut:
                                    Perform(MainFormFunction.Zoom,
                                            ((int)(Common.Direction.ZoomOut)).ToString() + ":" + m_Settings.ZoomOutSpeed + ":[]",
                                            sMethod,
                                            DvrClientModule.Main);
                                    break;

                                default:
                                    Perform(MainFormFunction.Ptz,
                                            ((int)(Common.Direction.Right)).ToString() + ":0:[]",
                                            sMethod,
                                            DvrClientModule.Main);
                                    break;
                            }
                        }
                        else
                        {
                            AuditPerform("Display [" + (DisplayManager_GetActiveDisplayIndex() + 1) + "] Is Not PTZ",
                                         sMethod,
                                         AuditSeverity.Warning);
                        }
                    }
                    else
                    {
                        AuditPerform("No Active Display Set", sMethod, AuditSeverity.Warning);
                    }
                }
            }
            catch (Exception ex)
            {
                Audit(ex.Message, sMethod, AuditSeverity.Error);
            }
        }

        public void m_SerialPort_ErrorReceived(object sender, SerialErrorReceivedEventArgs e)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            //AuditPerform(e.EventType.ToString(), sMethod, AuditSeverity.Warning);
        }

        #endregion

        #region History

        private bool AddHistoryItem(HistoryItem hi)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            if (hi == null)
            {
                Audit("History Item Is Null",
                      sMethod,
                      AuditSeverity.Warning);

                return false;
            }

            if (m_History == null)
            {
                Audit("History Object Is Null",
                      sMethod,
                      AuditSeverity.Warning); 

                return false;
            }

            bool bRc = m_History.AddItem(hi);
            Audit("Added To History After[" + Utils.GetEnumDescription(hi.Type) + "  " + hi.Value + "]. " +
                  "Pointer Is On " + m_History.Pointer, 
                  sMethod, 
                  AuditSeverity.Information);

            btnUndo.Enabled = true;

            return true;
        }

        private bool HistoryUndo()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            HistoryItem hi;            

            m_bInHistory = true;

            hi = m_History.GetItem();
            ActivateHistoryItem(hi);

            m_bInHistory = false;

            bool bRc = m_History.Undo();

            Audit("History Undo. Pointer Is On " + m_History.Pointer, sMethod, AuditSeverity.Information);

            if (m_History.Pointer == 0)
            {
                btnUndo.Enabled = false;
            }
            else
            {
                btnUndo.Enabled = true;
            }

            if (m_History.Pointer == (m_History.NumberOfItems - 1))
            {
                btnRedo.Enabled = false;
            }
            else
            {
                btnRedo.Enabled = true;
            }

            return bRc;
        }

        private bool HistoryRedo()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            HistoryItem hi;                                    
            
            bool bRc = m_History.Redo();

            m_bInHistory = true;

            hi = m_History.GetItem();
            ActivateHistoryItem(hi);

            m_bInHistory = false;

            Audit("History Redo. Pointer Is On " + m_History.Pointer, sMethod, AuditSeverity.Information);

            if (m_History.Pointer == 0)
            {
                btnUndo.Enabled = false;
            }
            else
            {
                btnUndo.Enabled = true;
            }

            if (m_History.Pointer == (m_History.NumberOfItems - 1))
            {
                btnRedo.Enabled = false;
            }
            else
            {
                btnRedo.Enabled = true;
            }

            return bRc;
        }

        private void HistoryItemHandler(HistoryItem hi)
        {
            //string sSiteName;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            //int iCameraNumber;
            //int iDisplayNumber;

            switch (hi.Type)
            {
                case HistoryItemType.Unknown:
                    break;

                case HistoryItemType.LiveVideo:                    
                    break;

                case HistoryItemType.Playback:
                    break;

                case HistoryItemType.Close:
                    break;

                case HistoryItemType.LayoutChange:
                    break;

                case HistoryItemType.CloseAll:
                    break;

                case HistoryItemType.PreDefinedView:
                    break;

                case HistoryItemType.MainView:
                    break;

                case HistoryItemType.Alarm:
                    break;

                case HistoryItemType.Template:
                    break;

                default:
                    break;
            }
        }

        private void ActivateHistoryItem(HistoryItem hi)
        {
            int iNumberOfCameras;
            int i;
            List<int> lOpenCamera = new List<int>();

            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                m_bNoAdaption = true;

                if (hi == null)
                {
                    Audit("History Item Is Null", sMethod, AuditSeverity.Error);

                    return;
                }

                Audit("Starting History Item[" + hi.Value + "]", sMethod, AuditSeverity.Information);

                iNumberOfCameras = hi.NumberOfCameras;

                for (int iCamera = 0; iCamera < iNumberOfCameras; iCamera++)
                {
                    string sSiteName = hi.Camera(iCamera).Dvr;
                    int iCameraNumber = hi.Camera(iCamera).CameraNumber;
                    bool bOpenedWithIndex;
                    int iDisplayIndex;
                    //bool bOpen = DisplayManager_IsCameraOpen(sSiteName,
                    //                                         iCameraNumber,
                    //                                         out iDisplayIndex,
                    //                                         out bOpenedWithIndex);
                    //if (bOpen)
                    //{
                    //    lOpenCamera.Add(iDisplayIndex);
                    //}
                }

                if (iNumberOfCameras > 0)
                {
                    //  First close all current displays
                    CloseAllCameras(lOpenCamera);

                    #region Activate Layout

                    if ((hi.Layout.ToString() != "") || (hi.Layout != DisplayManager_GetMode()))
                    {
                        switch (hi.Layout.ToString())
                        {
                            case "1 View":
                            case "OneView":
                                Switch2One();
                                break;

                            case "4 View":
                            case "QuadView":
                                Switch2Quad();
                                break;

                            case "9 View":
                            case "NineView":
                                Switch2Nine();
                                break;

                            case "16 View":
                            case "SixteenView":
                                Switch2Sixteen();
                                break;

                            case "25 View":
                            case "TwentyFiveView":
                                Switch2TwentyFive();
                                break;

                            case "36 View":
                            case "ThirtySixView":
                                Switch2ThirtySix();
                                break;

                            case "Six - One Big":
                            case "SixOneBig":
                                Switch2SixOneBig();
                                break;

                            case "Eight - One Big":
                            case "EightOneBig":
                                Switch2EightOneBig();
                                break;

                            case "Five - Four Up":
                            case "FiveFourUp":
                                Switch2FiveFourUp();
                                break;

                            case "Five - Four Down":
                            case "FiveFourDown":
                                Switch2FiveFourDown();
                                break;

                            case "Thirteen Surround":
                            case "ThirteenSurround":
                                Switch2ThirteenSurround();
                                break;

                            case "Ten - Two Quads":
                            case "TenTwoQuads":
                                Switch2TenTwoQuads();
                                break;

                            default:
                                break;
                        }
                    }

                    #endregion
                }
                else
                {
                    Audit("No Cameras To Open", sMethod, AuditSeverity.Information);

                    return;
                }
               
                LoadingPictureOnEmptyDisplays();
                                
                for (i = 0; i < iNumberOfCameras; i++)
                {
                    m_bStartCameraByClick = true;
                    bool bOpenedWithIndex = false;
                    bool bOpenCamera = false;
                    int iDisplayIndex;

                    //if (DisplayManager_IsCameraOpen(hi.Camera(i).Dvr,
                    //                                hi.Camera(i).CameraNumber,
                    //                                out iDisplayIndex,
                    //                                out bOpenedWithIndex))
                    //{
                    //    if (hi.Camera(i).Display != (iDisplayIndex + 1))
                    //    {
                    //        bOpenCamera = true;
                    //    }
                    //    else
                    //    {
                    //        bOpenCamera = false;
                    //    }
                    //}
                    //else
                    //{
                    //    bOpenCamera = true;
                    //}

                    if (bOpenCamera)
                    {
                        //StartCamera_X_on_Display_Y(hi.Camera(i).Dvr,
                        //                           hi.Camera(i).CameraNumber,
                        //                           hi.Camera(i).Display,
                        //                           DvrClientConstants.NONE,
                        //                           "",
                        //                           false);
                    }

                    if (IsPtzCamera(hi.Camera(i).Dvr, hi.Camera(i).CameraNumber))
                    {
                        int iPtzCameraPresetID = GetPtzCameraPresetID(hi.Camera(i).Dvr,
                                                                      hi.Camera(i).CameraNumber,
                                                                      hi.Camera(i).PresetToActivate);
                        if (iPtzCameraPresetID > DvrClientConstants.NONE)
                        {
                            int iDisplay = hi.Camera(i).Display;
                            //PCompStatus status = ActivatePreset(iDisplay - 1, iPtzCameraPresetID, hi.Camera(i).PresetToActivate);
                            //if (status != PCompStatus.PCompStatus_Ok)
                            //{
                            //    Audit("Faild To Activate History Item[" + hi.Value +
                            //          "]. Can't Open On Display[" + iDisplay +
                            //          "] Camera[" + hi.Camera(i).CameraNumber +
                            //          "] On DVR[" + hi.Camera(i).Dvr +
                            //          "] With Preset[" + hi.Camera(i).PresetToActivate +
                            //          "]. " + Utils.StatusString(status.ToString()),
                            //          sMethod, 
                            //          AuditSeverity.Warning);
                            //}
                            //else
                            //{
                            //    Audit("History Item[" + hi.Value +
                            //          "] Activated. Openning On Display[" + iDisplay +
                            //          "] Camera[" + hi.Camera(i).CameraNumber +
                            //          "] On DVR[" + hi.Camera(i).Dvr +
                            //          "]. Preset[" + hi.Camera(i).PresetToActivate + "] Activated.",
                            //          sMethod, 
                            //          AuditSeverity.Information);
                            //}
                        }
                    }
                    else
                    {
                        if (bOpenCamera)
                        {
                            Audit("History Item[" + hi.Value +
                                  "] Activated. Openning On Display[" + hi.Camera(i).Display +
                                  "] Camera[" + hi.Camera(i).CameraNumber +
                                  "] On DVR[" + hi.Camera(i).Dvr +
                                  "]",
                                  sMethod, 
                                  AuditSeverity.Information);
                        }
                        else
                        {
                            Audit("History Item[" + hi.Value +
                                  "] Activated. On Display[" + hi.Camera(i).Display +
                                  "] Camera[" + hi.Camera(i).CameraNumber +
                                  "] On DVR[" + hi.Camera(i).Dvr +
                                  "] Is Already Open.",
                                  sMethod, 
                                  AuditSeverity.Information);
                        }
                    }
                }

                CustomizeDisplays(sMethod);
                NoVideoPictureOnEmptyDisplays();                
            }
            catch (Exception e)
            {
                Audit("Problem Loading History Item[" + hi.Value + "]." + e.Message, sMethod, AuditSeverity.Error);

                m_bCutPredefinedViewInTheMiddle = false;
            }
        }

        #endregion

        #region Dvr Records

        public bool AddDvrRecord(int iDvrId,
                                 string sName,
                                 string sIpAddress,
                                 Vendor vVendor,
                                 int iTriggerIdDelta,
                                 out string sResult)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            sResult = "";

            bool bRc = DvrRecordExists(iDvrId, out sResult);
            if (bRc)
            {
                Audit("Can't Insert Dvr Record ID[" + iDvrId +
                      "] Name[" + sName +
                      "] IP[" + sIpAddress +
                      "] Vendor[" + vVendor.ToString() + "]. " + sResult, 
                      sMethod, 
                      AuditSeverity.Warning);

                return false;
            }
            
            DbReturnCode dbRc = InsertDvrRecord(iDvrId, 
                                                sName, 
                                                sIpAddress, 
                                                vVendor.ToString(),
                                                iTriggerIdDelta);
            if (dbRc != DbReturnCode.FinishedOK)
            {
                Audit("Faild Inserting Dvr Record ID[" + iDvrId + 
                      "] Name[" + sName + 
                      "] IP[" + sIpAddress +
                      "] Vendor[" + vVendor.ToString() + 
                      "] Trigger Id Delta[" + iTriggerIdDelta + 
                      "]. " + Utils.GetEnumDescription(dbRc), 
                      sMethod, 
                      AuditSeverity.Warning);

                return false;
            }

            Audit("Inserted Dvr Record ID[" + iDvrId +
                  "] Name[" + sName +
                  "] IP[" + sIpAddress +
                  "] Vendor[" + vVendor.ToString() + 
                  "] Trigger Id Delta[" + iTriggerIdDelta + "] Successfully. ",
                  sMethod,
                  AuditSeverity.Important);

            return true;
        }

        public bool UpdateDvrRecord(int iDvrId,
                                    string sName,
                                    string sIpAddress,
                                    Vendor vVendor,
                                    int iRecordId,
                                    int iTriggerIdDelta,
                                    out string sResult)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            sResult = "";

            bool bRc = DvrRecordExistsByRecordId(iRecordId, out sResult);
            if (!bRc)
            {
                Audit("Can't Update Dvr Record ID[" + iDvrId +
                      "] Name[" + sName +
                      "] IP[" + sIpAddress +
                      "] Vendor[" + vVendor.ToString() + 
                      "] Trigger ID Delta[" + iTriggerIdDelta + "]. " + sResult,
                      sMethod,
                      AuditSeverity.Warning);

                return false;
            }

            DbReturnCode dbRc = UpdateDvrRecord(iDvrId, 
                                                sName, 
                                                sIpAddress, 
                                                vVendor.ToString(),
                                                iTriggerIdDelta,
                                                iRecordId);
            if (dbRc != DbReturnCode.FinishedOK)
            {
                Audit("Faild Updating Dvr Record ID[" + iDvrId +
                      "] Name[" + sName +
                      "] IP[" + sIpAddress +
                      "] Vendor[" + vVendor.ToString() + 
                      "] Trigger ID Delta[" + iTriggerIdDelta + 
                      "]. " + Utils.GetEnumDescription(dbRc),
                      sMethod,
                      AuditSeverity.Warning);

                sResult = Utils.GetEnumDescription(dbRc);

                return false;
            }

            Audit("Updated Dvr Record ID[" + iDvrId +
                  "] Name[" + sName +
                  "] IP[" + sIpAddress +
                  "] Vendor[" + vVendor.ToString() + 
                  "] Trigger ID Delta[" + iTriggerIdDelta + "] Successfully. ",
                  sMethod,
                  AuditSeverity.Important);

            return true;
        }

        public List<WaveStoreDvrRecord> GetDvrRecords()
        {
            string sResult = "";
            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                return m_WaveStoreDvrRecord;
            }
            catch (Exception e)
            {
                Audit(sResult + ". " + e.Message, sMethod, AuditSeverity.Warning);

                return null;
            }
        }

        public bool DeleteDvrRecord(int iDvrId)
        {
            if (DeleteDvrByDvrId(iDvrId) == DbReturnCode.FinishedOK)
            {
                return true;
            }

            return false;
        }

        private Vendor GetVendorByDvrId(int iDvrId)
        {
            if (m_DvrRecord == null)
            {
                return Vendor.Unknown;
            }

            for (int i = 0; i < m_DvrRecord.Count; i++)
            {
                if (m_DvrRecord[i].DvrId == iDvrId)
                {
                    return m_DvrRecord[i].Vendor;
                }
            }

            return Vendor.Unknown;
        } 

        #endregion

        #region Sounds

        private bool LoadSoundFilesPaths(out string sResult)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            sResult = "";
            string sFileName;


            m_SoundFiles = new SoundFiles();

            if (GetSoundFiles(out sResult))
            {
                sFileName = (string.IsNullOrEmpty(m_SoundFiles.VmdAlertFile)) ? "None" : m_SoundFiles.VmdAlertFile;
                Audit("VMD Alert File - " + sFileName, sMethod, AuditSeverity.Information);

                sFileName = (string.IsNullOrEmpty(m_SoundFiles.CaAlertFile)) ? "None" : m_SoundFiles.CaAlertFile;
                Audit("CA Alert File - " + sFileName, sMethod, AuditSeverity.Information);

                sFileName = (string.IsNullOrEmpty(m_SoundFiles.VideoLossAlertFile)) ? "None" : m_SoundFiles.VideoLossAlertFile;
                Audit("Viseo Loss Alert File - " + sFileName, sMethod, AuditSeverity.Information);

                sFileName = (string.IsNullOrEmpty(m_SoundFiles.TllDryContactAlertFile)) ? "None" : m_SoundFiles.TllDryContactAlertFile;
                Audit("TTL / Dry Contact Alert File - " + sFileName, sMethod, AuditSeverity.Information);

                sFileName = (string.IsNullOrEmpty(m_SoundFiles.ApplicationFailureAlertFile)) ? "None" : m_SoundFiles.ApplicationFailureAlertFile;
                Audit("Application Failure Alert File - " + sFileName, sMethod, AuditSeverity.Information);

                return true;
            }

            Audit(sResult, sMethod, AuditSeverity.Warning);

            return false;
        }

        private bool SaveSoundFilesPaths(out string sResult)
        {
            DbReturnCode dbRc;

            sResult = "";
            dbRc = InsertSoundFiles(m_SoundFiles.VmdAlertFile,
                                    m_SoundFiles.CaAlertFile,
                                    m_SoundFiles.VideoLossAlertFile,
                                    m_SoundFiles.TllDryContactAlertFile,
                                    m_SoundFiles.ApplicationFailureAlertFile);
            if (dbRc == DbReturnCode.FinishedOK)
            {
                return true;
            }

            sResult = Utils.GetEnumDescription(dbRc);

            return false;
        }

        public SoundFiles GetSoundFilesPaths()
        {
            return m_SoundFiles;
        }

        public bool SetSoundFilePath(SoundEvent seSoundFile, 
                                     string sSoundFilePath, 
                                     out string sResult)
        {
            DbReturnCode dbRc;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            sResult = "";

            if (string.IsNullOrEmpty(sSoundFilePath))
            {
                sResult = "Sound File Path Is Null Or Empty";

                return false;
            }

            if (!File.Exists(sSoundFilePath))
            {
                sResult = "File '" + sSoundFilePath + "' Does Not Exist";

                return false;
            }

            switch (seSoundFile)
            {
                case SoundEvent.VmdAlert:
                    m_SoundFiles.VmdAlertFile = sSoundFilePath;
                    break;

                case SoundEvent.CaAlert:
                    m_SoundFiles.CaAlertFile = sSoundFilePath;
                    break;

                case SoundEvent.VideoLossAlert:
                    m_SoundFiles.VideoLossAlertFile = sSoundFilePath;
                    break;

                case SoundEvent.TtlDryContactAlert:
                    m_SoundFiles.TllDryContactAlertFile = sSoundFilePath;
                    break;

                case SoundEvent.ApplicationFailure:
                    m_SoundFiles.ApplicationFailureAlertFile = sSoundFilePath;
                    break;

                default:
                    sResult = "Unknown File Event '" + seSoundFile.ToString() + "'";
                    return false;
            }

            dbRc = DeleteSoundFiles();
            if (dbRc == DbReturnCode.FinishedOK)
            {
                Audit("'SoundFiles' Table Deleted.",
                      sMethod,
                      AuditSeverity.Information);
            }
            else
            {
                Audit("Failed Deleting 'SoundFiles' Table. " + Utils.GetEnumDescription(dbRc),
                      sMethod,
                      AuditSeverity.Warning);

                return false;
            }

            dbRc = InsertSoundFiles(m_SoundFiles.VmdAlertFile,
                                    m_SoundFiles.CaAlertFile,
                                    m_SoundFiles.VideoLossAlertFile,
                                    m_SoundFiles.TllDryContactAlertFile,
                                    m_SoundFiles.ApplicationFailureAlertFile);
            if (dbRc == DbReturnCode.FinishedOK)
            {
                Audit("Files Inserted Into 'SoundFiles' Table.",
                      sMethod,
                      AuditSeverity.Information);
            }
            else
            {
                Audit("Failed Inserting Records Into 'SoundFiles' Table. " + Utils.GetEnumDescription(dbRc),
                      sMethod,
                      AuditSeverity.Warning);

                return false;
            }

            return true;
        }

        private void m_SoundThreadObject_SoundEventCompleted(object sender, EventArgs e)
        {
            int iActiveRequestIndex;

            iActiveRequestIndex = (int)sender;

            m_frmSettings.SoundStopButtons(false);
            m_frmSettings.SoundPlayButtonsBySettings();
        }

        public int AddSoundRequest(SoundType stSoundType, string sData)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            int iSoundRequestIndex;

            try
            {
                iSoundRequestIndex = m_SoundThreadObject.AddSoundRequest(stSoundType, sData);

                return iSoundRequestIndex;
            }
            catch (Exception e) 
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return DvrClientConstants.NONE;
            }
        }

        public bool StopSoundRequest(int iSoundRequestIndex)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            bool bRc; 

            #endregion

            try
            {
                bRc = m_SoundThreadObject.StopSoundRequest(iSoundRequestIndex, out sResult);

                return bRc;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        #endregion

        #region Talk

        public bool Talk(int iDvrId, int iCameraNumber, bool bStart)
        {
            #region Data Members

            int iDisplayIndex;
            int iDvrIndex;
            int iCameraIndex;
            uint iVoiceChannel;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sResult;

            #endregion

            try
            {
                iDisplayIndex = DisplayManager_FindIndex(iDvrId, iCameraNumber, ActivationType.LiveVideo);
                iDvrIndex = GetDvrIndex(iDvrId);
                if (iDvrIndex == DvrClientConstants.NONE)
                {
                    Audit("Can't Find Index For Dvr ID[" + iDvrId + "]", sMethod, AuditSeverity.Warning);

                    return false;
                }

                if (bStart)
                {
                    iCameraIndex = GetCameraIndex(iDvrId, iCameraNumber);
                    if (iCameraIndex == DvrClientConstants.NONE)
                    {
                        Audit("Can't Find Index For Camera[" + iCameraNumber + "] On Dvr ID[" + iDvrId + "]", sMethod, AuditSeverity.Warning);

                        return false;
                    }

                    iVoiceChannel = (uint)(m_DvrInformation[iDvrIndex].StartDTalkChan +
                                    m_DvrInformation[iDvrIndex].Camera[iCameraIndex].CameraNumber - 
                                    1);

                    //if (!vp[iDisplayIndex].StartVoiceTalk(iDvrId, iVoiceChannel, out sResult))
                    //{
                    //    Audit(sResult, sMethod, AuditSeverity.Warning);
                    //}
                }
                else
                {
                    //if (!vp[iDisplayIndex].StopVoiceTalk(out sResult))
                    //{
                    //    Audit(sResult, sMethod, AuditSeverity.Warning);
                    //} 
                }

                return true;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return false;
            }
        }

        #endregion

        #region Main Scheduler

        private void ActivateFunction(TimerQCommand tqc, string sArguments)
        {
            #region Data Members
            
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string[] sValues;
            string sSiteName;

            int iCameraName;
            int iDisplay;
            int lDuration;

            DateTime dtStartTime; 

            #endregion

            try
            {
                sValues = sArguments.Split(',');

                switch (tqc)
                {
                    case TimerQCommand.StartCamera:
                        #region StartCamera

                        sSiteName = sValues[0];
                        iCameraName = int.Parse(sValues[1]);

                        switch (sValues.Length)
                        {
                            case 2:
                                //StartCamera(sSiteName, iCameraName, DvrClientConstants.NONE, "", true);
                                break;

                            case 3:
                                iDisplay = int.Parse(sValues[2]);
                                //StartCamera_X_on_Display_Y(sSiteName, iCameraName, iDisplay, DvrClientConstants.NONE, "", true);
                                break;

                            default:
                                break;
                        }

                        #endregion
                        break;


                    case TimerQCommand.StartPlayback:
                        #region StartPlayback

                        sSiteName = sValues[0];
                        iCameraName = int.Parse(sValues[1]);
                        dtStartTime = DateTime.ParseExact(sValues[2].Trim(),
                                                          "HH:mm",
                                                          System.Globalization.CultureInfo.InvariantCulture);
                        lDuration = int.Parse(sValues[3]);

                        switch (sValues.Length)
                        {
                            case 4:

                                //StartPlayback(sSiteName,
                                //              iCameraName,
                                //              DvrClientConstants.NONE,
                                //              dtStartTime,
                                //              lDuration,
                                //              0,
                                //              0,
                                //              "",
                                //              true,
                                //              Utils.InitialDefaultTime(),
                                //              "");
                                break;

                            case 5:
                                iDisplay = int.Parse(sValues[4]);
                                //StartPlayback_on_Display_Y(sSiteName,
                                //                           iCameraName,
                                //                           DvrClientConstants.NONE,
                                //                           dtStartTime,
                                //                           iDisplay,
                                //                           lDuration,
                                //                           0,
                                //                           0,
                                //                           "",
                                //                           true,
                                //                           Utils.InitialDefaultTime(),
                                //                           "");
                                break;

                            default:
                                break;
                        }

                        #endregion
                        break;


                    case TimerQCommand.ActivatePreset:
                        #region ActivatePreset

                        switch (sValues.Length)
                        {
                            case 1:
                                break;

                            case 2:
                                break;

                            default:
                                break;
                        }

                        #endregion
                        break;


                    case TimerQCommand.StartPreDefinedView:
                        #region StartPreDefinedView

                        StartPreDefinedView(sValues[0]);

                        #endregion
                        break;


                    case TimerQCommand.StopCamera:
                        #region StopCamera

                        switch (sValues.Length)
                        {
                            case 0:
                                break;

                            case 1:
                                iDisplay = int.Parse(sValues[4]);
                                DoStopCamera(iDisplay);
                                break;

                            default:
                                CloseAllCameras();
                                break;
                        }

                        #endregion
                        break;


                    default:
                        Audit("No Such Function '" + tqc.ToString() + "'", sMethod, AuditSeverity.Error);
                        break;
                }
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        public void OnFunctionFinished(TimerQCommand tqc, string sResult)
        {
            FunctionFinishedArgs ffa = new FunctionFinishedArgs(tqc, sResult);

            if (FunctionFinished != null)
            {
                FunctionFinished(this, ffa);
            }
        }

        private void ReceivedFunctionFinished(object sender, EventArgs e)
        {
            #region Data Members

            FunctionFinishedArgs ffa = (FunctionFinishedArgs)e;
            TimerQCommand tqc = ffa.Command;

            //bool bResult;

            //int iResult;

            string sFunctionResult = ffa.Result;
            //string sResult;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            switch (tqc)
            {
                //case TimerQCommand.Function1:
                //    try
                //    {
                //        bResult = bool.Parse(sFunctionResult);
                //    }
                //    catch (Exception)
                //    {
                //        bResult = false;
                //    }

                //    Audit("[" + tqc.ToString() + "] Result:" + bResult, sMethod, AuditSeverity.Important);
                //    break;

                //case TimerQCommand.Function2:
                //    try
                //    {
                //        iResult = int.Parse(sFunctionResult);
                //    }
                //    catch (Exception)
                //    {
                //        iResult = -1;
                //    }

                //    Audit("[" + tqc.ToString() + "] Result:" + iResult, sMethod, AuditSeverity.Important);
                //    break;

                //case TimerQCommand.Function3:
                //    sResult = sFunctionResult;

                //    Audit("[" + tqc.ToString() + "] Result:" + sResult, sMethod, AuditSeverity.Important);
                //    break;

                default:
                    break;
            }
        }

        #endregion

        #region Properties Stuff

        private void PropertiesDefaultValues()
        {
            #region Audit

            AuditOn = false;
            CreateErrorsFile = false;
            AuditLog = false;
            AuditLogFileType = AuditFileType.TextFile;
            AuditToDebug = false;
            AuditLinesLimit = 1000;
            HdMinimumFreeSpace = 1000;
            AlarmsAudit = false;
            RefreshTreeAudit = false;
            ShowKeepAliveOnAudit = false;
            ShowRefreshTreeOnAudit = false;
            ShowAuditErrorOnMessageBox = false;
            ShowMethodOnAudit = false;
            AllowWriteToEventLog = true;
            ShowPtzPresetAgentForm = false;

            #endregion

            #region Communication

            ListenerPort = 5678;
            DvrHiveListenerPort = 6789;
            KeepAliveInterval = 5;
            AuthenticatedMode = false;
            PromiscuousModeOn = false;
            SerialPortSettings = "COM1,9600,One,8,None,None";
            UseSerialPort = false;
            HiveState = HiveState.Off;

            #endregion

            #region Playback

            PlaybackLastMinutes = 3;
            PlaybackGapFromNow = 2;

            #endregion

            #region Pulse

            PlaybackPreEventTime = 30;
            PlaybackPostEventTime = 30;
            CloseManualCamerasOnEvent = true;
            RefreshEventTreeTimeInterval = 600;
            ShowEventsTreeOnStartup = false;
            NumberOfEventRecords = 50;
            UseNumberOfEventRecords = true;
            UseOldestEventRecordDate = true;
            EnablePulseEvents = true;
            ServerSleepInMilliseconds = 100;
            UseAlarmsQueue = false;
            AlarmsQLimitSize = 5;
            GapBetweenAlarmsInMiliSeconds = 0;
            PulseDatabaseConnectionString = "";

            #endregion

            #region Show

            ShowTools = false;
            HideMenu = false;
            HideStatusBar = false;
            HideTree = false;
            ShowHostIPAddress = false;
            ShowExit = false;
            HidePTZButtons = true;
            ShowLayoutsMenu = false;
            ShowNumberOfActiveDisplays = false;
            OnMissingPresetOpenCamera = false;

            #endregion

            #region Startup

            ProjectName = "Afcon";
            AnchorApplicationForm = false;
            MainFormLeft = 0;
            MainFormTop = 0;
            EnableOnTop = false;
            OnTopTime = 0;
            MaxDisplaysNumber = 16;
            Language = Language.English;
            ControlWidth = 0;
            ControlHeight = 0;
            PreDefinedView = "";
            VideoFormat = "NVF";
            ImportProjectName = false;
            PtzPanSpeed = 3;
            PtzTiltSpeed = 3;
            PtzZoomInSpeed = 3;
            PtzZoomOutSpeed = 3;
            RefreshTreeTimeInterval = 600;
            StartInFullScreenMode = false;
            CameraPostTime = 3;
            EnableFallback = true;
            EnableBackToOriginalViewByDblClk = true;
            ShowOpenExportDirectoryDialog = true;
            FixedLayout = DisplayFormatState.Unknown;
            ConnectionString = "Provider=Microsoft.Jet.OLEDB.4.0" +
                               ";" +
                               "Data Source=" +
                               Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location) +
                               "\\" +
                               DvrClientConstants.APPLICATION_NAME +
                               ".mdb";
            #endregion

            #region Snapshot Export & Sound

            SnapshotDefaultFilename = "Picture";
            VideoFormat = "NVF";
            ExportFolder = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);
            SoundFilesFolderPath = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);

            #endregion

            #region Nice Settings

            NiceAmsIP = "127.0.0.1";
            NiceUser = "niceuser";
            NicePassword = "password";
            ShowNiceContentAnalysisSuspiciousObjects = false;
            ShowNiceContentAnalysisType = false;
            ShowNiceTime = true;
            ShowNiceDate = true;
            ShowNiceCameraName = true;
            ShowNiceOperationStatus = true;
            NicePerformanceUnits = 2048;
            NiceFontColor = Color.White;
            NiceFont = new Font("David", 8);
            NiceVideoDisplayFreeTextX = 50;
            NiceVideoDisplayFreeTextY = 50;
            PtzPresetPath = PtzPresetActivation.Direct;
            CoreApiTimeoutSeconds = 1;

            #endregion

            #region Vicon Settings

            ViconUser = "viconuser";
            ViconPassword = "password";
            ViconNucleusIP = "127.0.0.1";
            EnableViconMacros = false;

            #endregion

            #region Sounds

            SoundsOn = false;

            #endregion
        }

        private void ExportProperties()
        {
            #region Data Members
            
            string sFileName;
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sPath = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);

            StreamWriter swPropertiesValuesList; 

            #endregion

            try
            {
                sFileName = "Properties Values List " +
                    Utils.Strech(DateTime.Now.Day.ToString()) + "-" +
                    Utils.Strech(DateTime.Now.Month.ToString()) + "-" +
                    DateTime.Now.Year.ToString() + " " +
                    Utils.Strech(DateTime.Now.Hour.ToString()) + "-" +
                    Utils.Strech(DateTime.Now.Minute.ToString()) + "-" +
                    Utils.Strech(DateTime.Now.Second.ToString()) + "." +
                    AuditFileType.Csv;

                swPropertiesValuesList = new StreamWriter(sPath + "\\" + sFileName, true, Encoding.UTF8);

                swPropertiesValuesList.WriteLine("Property,Value");
                swPropertiesValuesList.Flush();

                #region Audit

                swPropertiesValuesList.WriteLine("AuditOn," + AuditOn);
                swPropertiesValuesList.WriteLine("CreateErrorsFile," + CreateErrorsFile);
                swPropertiesValuesList.WriteLine("AuditLog," + AuditLog);
                swPropertiesValuesList.WriteLine("AuditLogFileType," + AuditLogFileType);
                swPropertiesValuesList.WriteLine("AuditToDebug," + AuditToDebug);
                swPropertiesValuesList.WriteLine("AuditLinesLimit," + AuditLinesLimit);
                swPropertiesValuesList.WriteLine("HdMinimumFreeSpace," + HdMinimumFreeSpace);
                swPropertiesValuesList.WriteLine("AlarmsAudit," + AlarmsAudit);
                swPropertiesValuesList.WriteLine("RefreshTreeAudit," + RefreshTreeAudit);
                swPropertiesValuesList.WriteLine("ShowKeepAliveOnAudit," + ShowKeepAliveOnAudit);
                swPropertiesValuesList.WriteLine("ShowRefreshTreeOnAudit," + ShowRefreshTreeOnAudit);
                swPropertiesValuesList.WriteLine("ShowAuditErrorOnMessageBox," + ShowAuditErrorOnMessageBox);
                swPropertiesValuesList.WriteLine("ShowMethodOnAudit," + ShowMethodOnAudit);
                swPropertiesValuesList.WriteLine("AllowWriteToEventLog," + AllowWriteToEventLog);
                swPropertiesValuesList.WriteLine("ShowPtzPresetAgentForm," + ShowPtzPresetAgentForm);
                swPropertiesValuesList.Flush();

                #endregion

                #region Communication

                swPropertiesValuesList.WriteLine("ListenerPort," + ListenerPort);
                swPropertiesValuesList.WriteLine("DvrHiveListenerPort," + DvrHiveListenerPort);
                swPropertiesValuesList.WriteLine("KeepAliveInterval," + KeepAliveInterval);
                swPropertiesValuesList.WriteLine("AuthenticatedMode," + AuthenticatedMode);
                swPropertiesValuesList.WriteLine("PromiscuousModeOn," + PromiscuousModeOn);
                swPropertiesValuesList.WriteLine("SerialPortSettings," + SerialPortSettings);
                swPropertiesValuesList.WriteLine("UseSerialPort," + UseSerialPort);
                swPropertiesValuesList.WriteLine("HiveState," + HiveState);
                swPropertiesValuesList.Flush();

                #endregion

                #region Playback

                swPropertiesValuesList.WriteLine("PlaybackLastMinutes," + PlaybackLastMinutes);
                swPropertiesValuesList.WriteLine("PlaybackGapFromNow," + PlaybackGapFromNow);
                swPropertiesValuesList.Flush();

                #endregion

                #region Pulse

                swPropertiesValuesList.WriteLine("PlaybackPreEventTime," + PlaybackPreEventTime);
                swPropertiesValuesList.WriteLine("PlaybackPostEventTime," + PlaybackPostEventTime);
                swPropertiesValuesList.WriteLine("CloseManualCamerasOnEvent," + CloseManualCamerasOnEvent);
                swPropertiesValuesList.WriteLine("RefreshEventTreeTimeInterval," + RefreshEventTreeTimeInterval);
                swPropertiesValuesList.WriteLine("ShowEventsTreeOnStartup," + ShowEventsTreeOnStartup);
                swPropertiesValuesList.WriteLine("NumberOfEventRecords," + NumberOfEventRecords);
                swPropertiesValuesList.WriteLine("UseNumberOfEventRecords," + UseNumberOfEventRecords);
                swPropertiesValuesList.WriteLine("UseOldestEventRecordDate," + UseOldestEventRecordDate);
                swPropertiesValuesList.WriteLine("EnablePulseEvents," + EnablePulseEvents);
                swPropertiesValuesList.WriteLine("ServerSleepInMilliseconds," + ServerSleepInMilliseconds);
                swPropertiesValuesList.WriteLine("UseAlarmsQueue," + UseAlarmsQueue);
                swPropertiesValuesList.WriteLine("AlarmsQLimitSize," + AlarmsQLimitSize);
                swPropertiesValuesList.WriteLine("GapBetweenAlarmsInMiliSeconds," + GapBetweenAlarmsInMiliSeconds);
                swPropertiesValuesList.WriteLine("PulseDatabaseConnectionString," + PulseDatabaseConnectionString);
                swPropertiesValuesList.Flush();

                #endregion

                #region Show

                swPropertiesValuesList.WriteLine("ShowTools," + ShowTools);
                swPropertiesValuesList.WriteLine("HideMenu," + HideMenu);
                swPropertiesValuesList.WriteLine("HideStatusBar," + HideStatusBar);
                swPropertiesValuesList.WriteLine("HideTree," + HideTree);
                swPropertiesValuesList.WriteLine("ShowHostIPAddress," + ShowHostIPAddress);
                swPropertiesValuesList.WriteLine("ShowExit," + ShowExit);
                swPropertiesValuesList.WriteLine("HidePTZButtons," + HidePTZButtons);
                swPropertiesValuesList.WriteLine("ShowLayoutsMenu," + ShowLayoutsMenu);
                swPropertiesValuesList.WriteLine("ShowNumberOfActiveDisplays," + ShowNumberOfActiveDisplays);
                swPropertiesValuesList.WriteLine("OnMissingPresetOpenCamera," + OnMissingPresetOpenCamera);
                swPropertiesValuesList.Flush();

                #endregion

                #region Startup

                swPropertiesValuesList.WriteLine("ProjectName," + ProjectName);
                swPropertiesValuesList.WriteLine("AnchorApplicationForm," + AnchorApplicationForm);
                swPropertiesValuesList.WriteLine("MainFormLeft," + MainFormLeft);
                swPropertiesValuesList.WriteLine("MainFormTop," + MainFormTop);
                swPropertiesValuesList.WriteLine("EnableOnTop," + EnableOnTop);
                swPropertiesValuesList.WriteLine("OnTopTime," + OnTopTime);
                swPropertiesValuesList.WriteLine("MaxDisplaysNumber," + MaxDisplaysNumber);
                swPropertiesValuesList.WriteLine("Language," + Language);
                swPropertiesValuesList.WriteLine("ControlWidth," + ControlWidth);
                swPropertiesValuesList.WriteLine("ControlHeight," + ControlHeight);
                swPropertiesValuesList.WriteLine("PreDefinedView," + PreDefinedView);
                swPropertiesValuesList.WriteLine("VideoFormat," + VideoFormat);
                swPropertiesValuesList.WriteLine("ImportProjectName," + ImportProjectName);
                swPropertiesValuesList.WriteLine("PtzPanSpeed," + PtzPanSpeed);
                swPropertiesValuesList.WriteLine("PtzTiltSpeed," + PtzTiltSpeed);
                swPropertiesValuesList.WriteLine("PtzZoomInSpeed," + PtzZoomInSpeed);
                swPropertiesValuesList.WriteLine("PtzZoomOutSpeed," + PtzZoomOutSpeed);
                swPropertiesValuesList.WriteLine("RefreshTreeTimeInterval," + RefreshTreeTimeInterval);
                swPropertiesValuesList.WriteLine("StartInFullScreenMode," + StartInFullScreenMode);
                swPropertiesValuesList.WriteLine("CameraPostTime," + CameraPostTime);
                swPropertiesValuesList.WriteLine("EnableFallback," + EnableFallback);
                swPropertiesValuesList.WriteLine("EnableBackToOriginalViewByDblClk," + EnableBackToOriginalViewByDblClk);
                swPropertiesValuesList.WriteLine("ShowOpenExportDirectoryDialog," + ShowOpenExportDirectoryDialog);
                swPropertiesValuesList.WriteLine("FixedLayout," + FixedLayout);
                swPropertiesValuesList.WriteLine("ConnectionString," + ConnectionString);
                swPropertiesValuesList.Flush();

                #endregion

                #region Snapshot Export & Sound

                swPropertiesValuesList.WriteLine("SnapshotDefaultFilename," + SnapshotDefaultFilename);
                swPropertiesValuesList.WriteLine("VideoFormat," + VideoFormat);
                swPropertiesValuesList.WriteLine("ExportFolder," + ExportFolder);
                swPropertiesValuesList.WriteLine("SoundFilesFolderPath," + SoundFilesFolderPath);
                swPropertiesValuesList.Flush();

                #endregion

                #region Nice Settings

                swPropertiesValuesList.WriteLine("NiceAmsIP," + NiceAmsIP);
                swPropertiesValuesList.WriteLine("NiceUser," + NiceUser);
                swPropertiesValuesList.WriteLine("NicePassword," + NicePassword);
                swPropertiesValuesList.WriteLine("ShowNiceContentAnalysisSuspiciousObjects," + ShowNiceContentAnalysisSuspiciousObjects);
                swPropertiesValuesList.WriteLine("ShowNiceContentAnalysisType," + ShowNiceContentAnalysisType);
                swPropertiesValuesList.WriteLine("ShowNiceTime," + ShowNiceTime);
                swPropertiesValuesList.WriteLine("ShowNiceDate," + ShowNiceDate);
                swPropertiesValuesList.WriteLine("ShowNiceCameraName," + ShowNiceCameraName);
                swPropertiesValuesList.WriteLine("ShowNiceOperationStatus," + ShowNiceOperationStatus);
                swPropertiesValuesList.WriteLine("NicePerformanceUnits," + NicePerformanceUnits);
                swPropertiesValuesList.WriteLine("NiceFontColor," + NiceFontColor);
                swPropertiesValuesList.WriteLine("NiceFont," + NiceFont);
                swPropertiesValuesList.WriteLine("NiceVideoDisplayFreeTextX," + NiceVideoDisplayFreeTextX);
                swPropertiesValuesList.WriteLine("NiceVideoDisplayFreeTextY," + NiceVideoDisplayFreeTextY);
                swPropertiesValuesList.WriteLine("PtzPresetPath," + PtzPresetPath);
                swPropertiesValuesList.WriteLine("CoreApiTimeoutSeconds," + CoreApiTimeoutSeconds);
                swPropertiesValuesList.Flush();

                #endregion

                #region Vicon Settings

                swPropertiesValuesList.WriteLine("ViconUser," + ViconUser);
                swPropertiesValuesList.WriteLine("ViconPassword," + ViconPassword);
                swPropertiesValuesList.WriteLine("ViconNucleusIP," + ViconNucleusIP);
                swPropertiesValuesList.WriteLine("EnableViconMacros," + EnableViconMacros);
                swPropertiesValuesList.Flush();

                #endregion

                #region Sounds

                swPropertiesValuesList.WriteLine("SoundsOn," + SoundsOn);
                swPropertiesValuesList.Flush();

                #endregion

                Utils.PopupMessage("Properties File '" + sFileName + "' Created.", 2, Color.Aqua);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }                               
        }

        private void ComparePropertiesFiles()
        {
            #region Data Members

            int iNotSameValue = 0;

            string sMethod = MethodBase.GetCurrentMethod().Name;
            string sPropertiesFileName1;
            string sPropertiesFileName2;
            string sPropertiesCompareFileName;

            OpenFileDialog ofd = new OpenFileDialog();

            List<ApplicationProperty> appProperty1;
            List<ApplicationProperty> appProperty2;

            string sPath = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);

            StreamWriter swPropertiesValuesCompare; 

            #endregion

            try
            {
                #region Load First Properties File Data

                ofd.Title = "Select First Properties File";
                ofd.InitialDirectory = m_sPath;
                ofd.Filter = "CSV Files (.csv)|*.csv|Excel Files (.xls*)|*.xls*|All Files (*.*)|*.*";
                ofd.FilterIndex = 1;

                DialogResult drResult = ofd.ShowDialog();
                if (drResult == DialogResult.OK)
                {
                    sPropertiesFileName1 = ofd.FileName;
                    StreamReader fileStream = new StreamReader(File.OpenRead(ofd.FileName));
                    appProperty1 = new List<ApplicationProperty>();

                    while (!fileStream.EndOfStream)
                    {
                        var line = fileStream.ReadLine();
                        var values = line.Split(',');

                        appProperty1.Add(new ApplicationProperty(values[0], values[1]));
                    }
                }
                else
                {
                    return;
                }

                #endregion

                #region Load Second Properties File Data

                ofd.Title = "Select Second Properties File";
                drResult = ofd.ShowDialog();
                if (drResult == DialogResult.OK)
                {
                    sPropertiesFileName2 = ofd.FileName;
                    StreamReader fileStream = new StreamReader(File.OpenRead(ofd.FileName));
                    appProperty2 = new List<ApplicationProperty>();

                    while (!fileStream.EndOfStream)
                    {
                        var line = fileStream.ReadLine();
                        var values = line.Split(',');

                        appProperty2.Add(new ApplicationProperty(values[0], values[1]));
                    }
                }
                else
                {
                    return;
                }

                #endregion

                sPropertiesCompareFileName = "Compare Properties Files " +
                                             Utils.Strech(DateTime.Now.Day.ToString()) + "-" +
                                             Utils.Strech(DateTime.Now.Month.ToString()) + "-" +
                                             DateTime.Now.Year.ToString() + " " +
                                             Utils.Strech(DateTime.Now.Hour.ToString()) + "-" +
                                             Utils.Strech(DateTime.Now.Minute.ToString()) + "-" +
                                             Utils.Strech(DateTime.Now.Second.ToString()) + "." +
                                             AuditFileType.Csv;

                swPropertiesValuesCompare = new StreamWriter(sPath + "\\" + sPropertiesCompareFileName, true, Encoding.UTF8);

                swPropertiesValuesCompare.WriteLine("Property," + sPropertiesFileName1 + 
                                                    "," + sPropertiesFileName2);
                swPropertiesValuesCompare.Flush();

                if (appProperty1.Count >= appProperty2.Count)
                {
                    for (int iProperty1 = 0; iProperty1 < appProperty1.Count; iProperty1++)
                    {
                        for (int iProperty2 = 0; iProperty2 < appProperty2.Count; iProperty2++)
                        {
                            if (appProperty1[iProperty1].Name.ToUpper() == appProperty2[iProperty2].Name.ToUpper())
                            {
                                if (appProperty1[iProperty1].Value.ToUpper() != appProperty2[iProperty2].Value.ToUpper())
                                {
                                    iNotSameValue++;

                                    swPropertiesValuesCompare.WriteLine(appProperty1[iProperty1].Name + "," + 
                                                                        appProperty1[iProperty1].Value + "," + 
                                                                        appProperty2[iProperty2].Value);
                                    swPropertiesValuesCompare.Flush();
                                }

                                break;
                            }

                            DoEvents();
                        }

                        DoEvents();
                    }                    
                }
                else
                {
                    for (int iProperty2 = 0; iProperty2 < appProperty2.Count; iProperty2++)
                    {
                        for (int iProperty1 = 0; iProperty1 < appProperty1.Count; iProperty1++)
                        {
                            if (appProperty2[iProperty2].Name.ToUpper() == appProperty1[iProperty1].Name.ToUpper())
                            {
                                if (appProperty2[iProperty2].Value.ToUpper() != appProperty1[iProperty1].Value.ToUpper())
                                {
                                    iNotSameValue++;

                                    swPropertiesValuesCompare.WriteLine(appProperty1[iProperty1].Name + "," +
                                                                        appProperty1[iProperty1].Value + "," +
                                                                        appProperty2[iProperty2].Value);
                                    swPropertiesValuesCompare.Flush();
                                }

                                break;
                            }

                            DoEvents();
                        }

                        DoEvents();
                    }
                }

                Utils.PopupMessage(iNotSameValue + " Differences Found", 2, Color.Aqua);
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);
            }
        }

        #endregion

        public bool ApplyDisplayTemplate(string sLayout, List<UniqueCamera> lCamera)
        {
            CloseAllCameras();

            for (int i = 0; i < lCamera.Count; i++)
            {
                //StartCamera_X_on_Display_Y(lCamera[i].Dvr, 
                //                           lCamera[i].CameraNumber,
                //                           lCamera[i].Display,
                //                           DvrClientConstants.NONE,
                //                           "",
                //                           false);
            }

            SetLayout(sLayout);

            return true;
        }

        public bool HasMajorError(out string sMajorError)
        {
            if (m_bMajorError)
                sMajorError = m_sMajorError;
            else
            {
                sMajorError = "";
            }

            return m_bMajorError;
        }

        private bool RealDisplayNumberExists(int iRealDisplayNumber)
        {
            int i;

            for (i = 0; i < m_SchedulerTasks.SchedulerEntry.Count; i++)
            {
                if (m_SchedulerTasks.SchedulerEntry[i].DisplayIndex == iRealDisplayNumber)
                {
                    return true;
                }
            }

            return false;
        }        

        public void SetFormLeftTop(int iLeft, int iTop)
        {
            if (m_frmSettings != null)
            {
                m_frmSettings.SetFormLeftTop(iLeft, iTop);
            }
        }

        private Direction GetDirection(double x, double y)
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;

            int iDisplayIndex;

            try
            {
                if (DisplayManager_GetActiveDisplayIndex() == DvrClientConstants.NONE)
                {
                    Audit("Active Display Index Not Set", sMethod, AuditSeverity.Error);

                    return Direction.Nothing;
                }

                iDisplayIndex = DisplayManager_GetActiveDisplayIndex();

                if (x < (m_Transparent[iDisplayIndex].Width / 3))
                {
                    if (y < (m_Transparent[iDisplayIndex].Height / 3))
                    {
                        return Direction.UpLeft;
                    }

                    if (y < ((2 * m_Transparent[iDisplayIndex].Height) / 3))
                    {
                        return Direction.Left;
                    }

                    return Direction.DownLeft;
                }

                if (x < ((2 * m_Transparent[iDisplayIndex].Width) / 3))
                {
                    if (y < (m_Transparent[iDisplayIndex].Height / 3))
                    {
                        return Direction.Up;
                    }

                    if (y < ((2 * m_Transparent[iDisplayIndex].Height) / 3))
                    {
                        //  handle Zoom
                        if (y < (m_Transparent[iDisplayIndex].Height / 2))
                        {
                            return Direction.ZoomIn;
                        }

                        return Direction.ZoomOut;
                    }

                    return Direction.Down;
                }

                if (y < (m_Transparent[iDisplayIndex].Height / 3))
                {
                    return Direction.UpRight;
                }

                if (y < ((2 * m_Transparent[iDisplayIndex].Height) / 3))
                {
                    return Direction.Right;
                }

                return Direction.DownRight;
            }
            catch (Exception e)
            {
                Audit(e.Message, sMethod, AuditSeverity.Error);

                return Direction.Nothing;
            }
        }

        private void CleanLogFiles()
        {
            string sMethod = MethodBase.GetCurrentMethod().Name;
            string filesFolder = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);
            string[] filesList = Directory.GetFiles(filesFolder, DvrClientConstants.APPLICATION_NAME + "*.txt");

            foreach (string img in filesList)
            {
                FileInfo fileInfo = new FileInfo(img);
                if (fileInfo.LastWriteTime < DateTime.Now.AddMinutes(-3))
                {
                    try
                    {
                        fileInfo.Delete();
                    }
                    catch (Exception e)
                    {
                        Audit("Failed To Delete." + e.Message, sMethod, AuditSeverity.Error);
                    }
                }
            }
        }

        public void RenameProjectName(string sProjectName)
        {

            string sMethod = MethodBase.GetCurrentMethod().Name;

            try
            {
                tv.Nodes[0].Text = sProjectName;
            }
            catch (Exception e)
            {
                Audit("Renaming Project Failed. Error: " + e.Message, sMethod, AuditSeverity.Error);
            }
        }               

        private void ActivateOnTop(bool bActivate)
        {
            OnTopStatus ots = new OnTopStatus();
            ots.Activate = bActivate;

            OnOnTopEvent(ots);
        }

        public bool CheckOverlap(string sNewStart, string sNewEnd, int iMainViewId, out string sResult)
        {
            #region Data Members
            
            DateTime dtNow = DateTime.Now;
            DateTime dtNewStart;
            DateTime dtNewEnd;
            DateTime dtStart;
            DateTime dtEnd;

            TimeInterval tiNew;
            TimeInterval timv;
            TimeInterval tiOverlapping;
            TimeInterval tiMinMax;

            string sStart;
            string sEnd;
            string sError;
            string sMethod = MethodBase.GetCurrentMethod().Name;

            #endregion

            try
            {
                if (m_MainView == null)
                {
                    sResult = "Main Views List Is null";

                    return false;
                }

                try
                {
                    dtNewStart = DateTime.ParseExact(sNewStart.Trim(),
                                                     "HH:mm",
                                                     System.Globalization.CultureInfo.InvariantCulture);
                }
                catch (Exception e)
                {
                    sError = e.Message;
                    sResult = "Bad New Start Time '" + sNewStart + "'. " + e.Message;

                    return false;
                }

                try
                {
                    dtNewEnd = DateTime.ParseExact(sNewEnd.Trim(),
                                                   "HH:mm",
                                                   System.Globalization.CultureInfo.InvariantCulture);
                }
                catch (Exception e)
                {
                    sError = e.Message;
                    sResult = "Bad New End Time '" + sNewEnd + "'. " + e.Message;

                    return false;
                }

                tiNew = new TimeInterval(dtNewStart.Hour,
                                         dtNewStart.Minute,
                                         dtNewEnd.Hour,
                                         dtNewEnd.Minute);

                sResult = "Main Views List Has 0 Items";
                for (int i = 0; i < m_MainView.Count; i++)
                {
                    if (iMainViewId == m_MainView[i].Id)
                    {
                        continue;
                    }

                    sStart = m_MainView[i].StartTime;
                    sEnd = m_MainView[i].EndTime;

                    dtStart = DateTime.ParseExact(sStart.Trim(),
                                                  "HH:mm",
                                                  System.Globalization.CultureInfo.InvariantCulture);
                    dtEnd = DateTime.ParseExact(sEnd.Trim(),
                                                "HH:mm",
                                                System.Globalization.CultureInfo.InvariantCulture);

                    timv = new TimeInterval(dtStart.Hour, dtStart.Minute, dtEnd.Hour, dtEnd.Minute);

                    OverlapState olState = Utils.OverlapCheck(tiNew,
                                                              timv,
                                                              out tiOverlapping,
                                                              out tiMinMax);

                    sResult = Utils.GetEnumDescription(olState);

                    switch (olState)
                    {
                        case OverlapState.Unknown:
                        case OverlapState.CompleteOverlap:
                        case OverlapState.A_Containing_B:
                        case OverlapState.B_Containing_A:
                        case OverlapState.PartialOverlap_A_B:
                        case OverlapState.PartialOverlap_B_A:                            
                            return true;

                        default:
                            break;
                    }

                }

                return false;
            }
            catch (Exception e)
            {
                sResult = e.Message;

                return false;
            }
        }        

        private void DoEvents()
        {
            Application.DoEvents();
        }
    }

    public interface IGuiHandler
    {
        void Perform(MainFormFunction mainFormFunction, 
                     string sLine, 
                     string sMethod,
                     DvrClientModule mModule);
    }
}